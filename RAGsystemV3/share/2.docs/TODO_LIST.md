# V3版本系统TODO列表

## 前端功能增强

### Markdown渲染支持
- [ ] **为前端Chat页面添加Markdown渲染支持** (pending)
  - 整体功能规划，让LLM返回的答案支持Markdown格式显示

- [ ] **安装marked库用于Markdown解析** (pending)
  - 在frontend目录下运行 `npm install marked`
  - 添加Markdown解析依赖

- [ ] **修改Chat.vue组件，添加Markdown渲染方法** (pending)
  - 导入marked库
  - 添加renderMarkdown方法
  - 处理Markdown到HTML的转换

- [ ] **更新答案显示区域，使用Markdown渲染替代v-html** (pending)
  - 修改助手消息的显示方式
  - 从 `v-html="message.content"` 改为 `v-html="renderMarkdown(message.content)"`

- [ ] **添加Markdown内容的CSS样式** (pending)
  - 为标题、列表、代码块、引用等添加样式
  - 确保Markdown内容美观显示

- [ ] **测试Markdown渲染功能** (pending)
  - 测试各种Markdown语法（标题、列表、代码、表格等）
  - 确保渲染效果正确

## 后端功能优化

### 重排序Top_k限制
- [ ] **为重排序服务添加top_k参数，限制重排序后传递给LLM的结果数量** (pending)
  - 整体功能规划，解决当前重排序后没有数量限制的问题

- [ ] **在v3_config.json中添加top_k配置参数** (pending)
  - 在`rag_system.models.reranking`配置中添加`top_k`参数
  - 设置合理的默认值（如10-15个结果）

- [ ] **修改reranking_enhanced.py，在重排序后应用top_k限制** (pending)
  - 在`_apply_sorting_strategies`方法中添加top_k限制
  - 确保重排序后只返回前k个最相关的结果

- [ ] **更新unified_services.py中的rerank方法，支持top_k参数** (pending)
  - 修改`rerank`方法，支持从配置中读取top_k参数
  - 将top_k参数传递给重排序服务

- [ ] **测试top_k功能，确保重排序后正确限制结果数量** (pending)
  - 测试不同top_k值的效果
  - 验证重排序后确实只返回指定数量的结果

### 文本召回问题修复
- [ ] **修复第三层文本扩展搜索始终返回0个结果的问题** (pending)
  - 诊断同义词词典过于简单的问题
  - 修复扩展查询生成逻辑

- [ ] **扩展同义词词典，添加更多常见词汇以支持查询扩展** (pending)
  - 添加更多业务相关词汇
  - 支持更广泛的查询扩展

- [ ] **改进查询扩展方法，使用更智能的扩展策略（如LLM生成）** (pending)
  - 使用LLM生成相关查询
  - 实现更智能的查询扩展

- [ ] **修复上下文优化显示0/4000的问题，确保内容正确提取** (pending)
  - 诊断内容提取失败的原因
  - 修复字段名不匹配问题

- [ ] **调试内容提取方法，检查检索结果的数据结构和字段名** (pending)
  - 添加调试日志查看数据结构
  - 确认正确的字段名

- [ ] **在关键方法中添加调试日志，便于问题诊断** (pending)
  - 在扩展查询生成中添加日志
  - 在内容提取中添加日志

### 前端显示问题修复
- [ ] **修复答案区域显示chunk_id的问题** (pending)
  - 诊断chunk_id（如text_chunk_40）在答案区域显示的根本原因
  - 检查前后端字段映射关系，找到正确的解决方案
  - 确保只显示chunk类型，不显示chunk_id

### 图片召回问题修复
- [ ] **修复图片召回返回0个结果的问题** (pending)
  - 诊断图片向量chunk_type过滤条件不匹配的问题
  - 修改search_images方法，支持多种图片类型（image、visual、description）
  - 确保图片召回能正确返回结果

- [ ] **修复配置未加载警告问题** (pending)
  - 诊断配置管理器加载失败的原因
  - 确保配置正确加载，消除警告信息

### 双重embedding存储方案
- [ ] **实现双重embedding存储，解决第一层语义搜索问题** (pending)
  - 修改图片向量存储逻辑，同时将description_embedding存储到FAISS索引
  - 每个图片存储两个独立向量：visual_embedding和description_embedding
  - 使用vector_type字段区分向量类型，支持按类型精确搜索

- [ ] **实现真正的四层图片召回策略** (pending)
  - 第一层：基于description_embedding的语义相似度搜索
  - 第二层：基于visual_embedding的视觉相似度搜索
  - 第三层：关键词搜索
  - 第四层：扩展搜索

- [ ] **添加向量类型过滤搜索功能** (pending)
  - 在vector_db_integration.py中添加search_by_vector_type方法
  - 支持按vector_type进行精确搜索
  - 优化搜索性能，保持现有API兼容性

## 功能说明

### Markdown渲染支持
- **目标**: 让LLM返回的答案支持Markdown格式，提供更好的阅读体验
- **技术方案**: 使用marked库在前端进行Markdown解析和渲染
- **预期效果**: 支持标题、列表、代码块、表格等Markdown语法

### 重排序Top_k限制
- **目标**: 精确控制传递给LLM的结果数量，提高系统效率
- **技术方案**: 在重排序服务中添加top_k参数，限制返回结果数量
- **预期效果**: 减少LLM处理时间，优化系统性能，提供更灵活的配置选项

### 文本召回问题修复
- **目标**: 修复第三层召回和上下文优化的问题，提高召回效果
- **技术方案**: 扩展同义词词典，修复内容提取逻辑，添加调试日志
- **预期效果**: 第三层召回能返回有效结果，上下文优化正确显示字符数

### 前端显示问题修复
- **目标**: 修复答案区域显示chunk_id的问题，提升用户体验
- **技术方案**: 深入诊断前后端字段映射关系，找到chunk_id显示的根本原因
- **预期效果**: 答案区域只显示chunk类型，不显示chunk_id信息

### 图片召回问题修复
- **目标**: 修复图片召回返回0个结果的问题，确保图片搜索功能正常
- **技术方案**: 修改search_images方法，支持多种图片类型过滤条件
- **预期效果**: 图片召回能正确返回相关结果，提升图片搜索效果

### 配置加载问题修复
- **目标**: 修复配置未加载警告，确保系统配置正确加载
- **技术方案**: 诊断配置管理器加载失败原因，修复配置加载逻辑
- **预期效果**: 消除配置警告，确保系统稳定运行

## 优先级说明
1. **高优先级**: 文本召回问题修复（影响核心功能）
2. **高优先级**: 图片召回问题修复（影响核心功能）
3. **高优先级**: 重排序Top_k限制（影响系统性能）
4. **中优先级**: 配置加载问题修复（影响系统稳定性）
5. **中优先级**: 前端显示问题修复（影响用户体验）
6. **中优先级**: Markdown渲染支持（提升用户体验）

## 更新记录
- 2024-01-XX: 初始创建TODO列表
- 2024-01-XX: 添加Markdown渲染支持任务
- 2024-01-XX: 添加重排序Top_k限制任务
- 2024-01-XX: 添加文本召回问题修复任务
- 2024-01-XX: 添加前端显示问题修复任务
- 2024-01-XX: 添加图片召回问题修复任务
- 2024-01-XX: 添加配置加载问题修复任务