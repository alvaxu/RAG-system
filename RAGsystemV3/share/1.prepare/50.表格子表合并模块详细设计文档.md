# è¡¨æ ¼å­è¡¨åˆå¹¶æ¨¡å—è¯¦ç»†è®¾è®¡æ–‡æ¡£

## 1. æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡
åœ¨RAGç³»ç»ŸV3ä¸­ï¼Œå½“è¡¨æ ¼å†…å®¹è¿‡å¤§æ—¶ä¼šè¢«æ‹†åˆ†æˆå¤šä¸ªå­è¡¨è¿›è¡Œå‘é‡åŒ–å­˜å‚¨ã€‚åœ¨æŸ¥è¯¢å¬å›æ—¶ï¼Œéœ€è¦èƒ½å¤Ÿå°†ç›¸å…³çš„å­è¡¨é‡æ–°åˆå¹¶æˆå®Œæ•´çš„ä¸»è¡¨ï¼Œç¡®ä¿ç”¨æˆ·èƒ½å¤Ÿçœ‹åˆ°å®Œæ•´çš„è¡¨æ ¼å†…å®¹ã€‚

### 1.2 æ ¸å¿ƒé—®é¢˜
- **å­è¡¨ç‹¬ç«‹å¬å›**ï¼šæ¯ä¸ªå­è¡¨éƒ½æ˜¯ç‹¬ç«‹çš„å‘é‡ï¼Œå¬å›æ—¶å¯èƒ½åªè¿”å›éƒ¨åˆ†å­è¡¨
- **ç¼ºå°‘å¤§è¡¨é‡ç»„é€»è¾‘**ï¼šæ²¡æœ‰æ ¹æ® `parent_table_id` å’Œ `subtable_index` æ¥é‡ç»„å®Œæ•´å¤§è¡¨
- **ç”¨æˆ·ä½“éªŒä¸å®Œæ•´**ï¼šç”¨æˆ·å¯èƒ½åªçœ‹åˆ°è¡¨æ ¼çš„ä¸€éƒ¨åˆ†
- **åŸè¡¨æ˜¾ç¤ºé—®é¢˜**ï¼šåŸè¡¨HTMLå¯èƒ½ä¸å®Œæ•´ï¼Œè¡¨å¤´ç¼ºå¤±æˆ–ç»“æ„ä¸å®Œæ•´
- **å­è¡¨HTMLç”Ÿæˆé—®é¢˜**ï¼šå½“å­è¡¨æ²¡æœ‰æ•°æ®è¡Œæ—¶ï¼Œè¿è¡¨å¤´éƒ½ä¸ç”Ÿæˆ

### 1.3 è§£å†³æ–¹æ¡ˆ
1. **å­è¡¨åˆå¹¶**ï¼šåœ¨LLMå¤„ç†å®Œæˆåã€å‰ç«¯å±•ç¤ºå‰ï¼Œæ ¹æ®å­è¡¨IDæ‰¾åˆ°æ‰€æœ‰ç›¸å…³å­è¡¨å¹¶æ‹¼æˆä¸»è¡¨
2. **HTMLä¿®å¤**ï¼šéªŒè¯å’Œä¿®å¤è¡¨æ ¼HTMLç»“æ„ï¼Œç¡®ä¿è¡¨å¤´å®Œæ•´
3. **æ˜¾ç¤ºä¼˜åŒ–**ï¼šç¡®ä¿å‰ç«¯æ˜¾ç¤ºçš„æ˜¯å®Œæ•´çš„è¡¨æ ¼å†…å®¹
4. **æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–**ï¼šé€šè¿‡æŸ¥è¯¢æ•°æ®åº“è·å–æ‰€æœ‰ç›¸å…³å­è¡¨ï¼Œç¡®ä¿åˆå¹¶çš„å®Œæ•´æ€§

## 2. æŠ€æœ¯æ¶æ„

### 2.1 æ•°æ®æµåˆ†æ

```
å¬å›ç»“æœ â†’ é‡æ’åº â†’ LLMå¤„ç† â†’ å­è¡¨åˆå¹¶ â†’ å‰ç«¯å±•ç¤º
    â†“         â†“        â†“         â†“         â†“
  å­è¡¨ç‹¬ç«‹   å­è¡¨ç‹¬ç«‹  çº¯æ–‡æœ¬    å®Œæ•´HTML   å®Œæ•´è¡¨æ ¼
```

**å…³é”®ç‚¹ï¼š**
- **LLMå¤„ç†é˜¶æ®µ**ï¼šä½¿ç”¨å­è¡¨çš„ `table_content`ï¼ˆçº¯æ–‡æœ¬ï¼‰ï¼Œå†…å®¹ç²¾å‡†
- **å‰ç«¯å±•ç¤ºé˜¶æ®µ**ï¼šåˆå¹¶å­è¡¨çš„ `table_html`ï¼Œæ˜¾ç¤ºå®Œæ•´è¡¨æ ¼

### 2.2 æ¨¡å—ä½ç½®
- **å®ç°ä½ç½®**ï¼š`rag_system/core/vector_db_integration.py`
- **è°ƒç”¨æ—¶æœº**ï¼šåœ¨ `simple_smart_processor.py` çš„ `process_single_type_query` æ–¹æ³•ä¸­ï¼ŒLLMå¤„ç†å®Œæˆå
- **æ•°æ®æµå‘**ï¼š`å¬å›ç»“æœ` â†’ `é‡æ’åº` â†’ `LLMè¾“å…¥` â†’ `LLMè¾“å‡º` â†’ `å­è¡¨åˆå¹¶` â†’ `å‰ç«¯å±•ç¤º`
- **å…¥å£æ–¹æ³•**ï¼š`format_search_results_with_merge()` - å¯¹å¤–æ¥å£
- **æ ¸å¿ƒæ–¹æ³•**ï¼š`_merge_subtables_for_display()` - å­è¡¨åˆå¹¶é€»è¾‘

## 3. è¯¦ç»†å®ç°

### 3.1 æ ¸å¿ƒå‡½æ•°è®¾è®¡

#### 3.1.1 å¯¹å¤–æ¥å£æ–¹æ³•

```python
def format_search_results_with_merge(self, results: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    """
    åˆå¹¶å­è¡¨ï¼ˆç»“æœå·²ç»æ˜¯æ ¼å¼åŒ–åçš„ï¼‰
    
    :param results: å·²æ ¼å¼åŒ–çš„æœç´¢ç»“æœåˆ—è¡¨
    :return: åˆå¹¶åçš„ç»“æœåˆ—è¡¨
    """
    try:
        # ç›´æ¥åˆå¹¶å­è¡¨ï¼ˆç»“æœå·²ç»æ˜¯æ ¼å¼åŒ–çš„ï¼‰
        if self.config.get('rag_system.table_merge.enabled', True):
            merged_results = self._merge_subtables_for_display(results)
            logger.info(f"å­è¡¨åˆå¹¶å®Œæˆï¼ŒåŸå§‹ç»“æœ: {len(results)}ï¼Œåˆå¹¶åç»“æœ: {len(merged_results)}")
            return merged_results
        else:
            return results
            
    except Exception as e:
        logger.error(f"å­è¡¨åˆå¹¶å¤±è´¥: {e}")
        return results
```

#### 3.1.2 æ ¸å¿ƒåˆå¹¶æ–¹æ³•

```python
def _merge_subtables_for_display(self, results: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    """
    ä¸ºå‰ç«¯å±•ç¤ºåˆå¹¶å­è¡¨HTML - ä¿®æ”¹ç‰ˆï¼šæŸ¥è¯¢æ•°æ®åº“è·å–æ‰€æœ‰ç›¸å…³å­è¡¨
    
    :param results: é‡æ’åºåçš„ç»“æœåˆ—è¡¨
    :return: åˆå¹¶åçš„ç»“æœåˆ—è¡¨
    """
    try:
        logger.info(f"ğŸ” å¼€å§‹å­è¡¨åˆå¹¶ï¼Œè¾“å…¥ç»“æœæ•°é‡: {len(results)}")
        
        # 1. è¯†åˆ«å­è¡¨ç»„å¹¶æŸ¥è¯¢æ•°æ®åº“è·å–æ‰€æœ‰ç›¸å…³å­è¡¨
        subtable_groups = self._identify_subtable_groups(results)
        
        # 2. åˆå¹¶æ¯ä¸ªå­è¡¨ç»„
        merged_results = []
        processed_subtables = set()
        non_subtable_count = 0
        
        for i, result in enumerate(results):
            chunk_id = result.get('chunk_id', '')
            chunk_type = result.get('chunk_type', 'unknown')
            metadata = result.get('metadata', {})
            is_subtable = metadata.get('is_subtable', False)
            
            # å¦‚æœè¿™ä¸ªç»“æœå·²ç»è¢«åˆå¹¶è¿‡ï¼Œè·³è¿‡
            if chunk_id in processed_subtables:
                continue
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯å­è¡¨ï¼šå¦‚æœå­˜åœ¨parent_table_idå­—æ®µï¼Œå°±è®¤ä¸ºæ˜¯å­è¡¨
            parent_id = metadata.get('parent_table_id', '')
            if parent_id:
                if parent_id in subtable_groups:
                    # åˆå¹¶è¿™ä¸ªå­è¡¨ç»„ï¼ˆåŒ…å«ä»æ•°æ®åº“æŸ¥è¯¢åˆ°çš„æ‰€æœ‰å­è¡¨ï¼‰
                    logger.info(f"ğŸ”„ å¼€å§‹åˆå¹¶å­è¡¨ç»„ {parent_id}ï¼ŒåŒ…å« {len(subtable_groups[parent_id])} ä¸ªå­è¡¨")
                    merged_result = self._merge_subtable_group(subtable_groups[parent_id])
                    if merged_result:
                        logger.info(f"âœ… å­è¡¨ç»„åˆå¹¶æˆåŠŸï¼ŒåŒ…å« {len(subtable_groups[parent_id])} ä¸ªå­è¡¨")
                        merged_results.append(merged_result)
                        # æ ‡è®°æ‰€æœ‰å­è¡¨ä¸ºå·²å¤„ç†
                        for subtable in subtable_groups[parent_id]:
                            processed_subtables.add(subtable.get('chunk_id', ''))
                    else:
                        logger.warning(f"âŒ å­è¡¨ç»„åˆå¹¶å¤±è´¥")
                else:
                    logger.warning(f"âš ï¸ å­è¡¨ä½†æ‰¾ä¸åˆ°å¯¹åº”çš„ç»„")
            else:
                # éå­è¡¨ç›´æ¥æ·»åŠ 
                non_subtable_count += 1
                merged_results.append(result)

        logger.info(f"âœ… å­è¡¨åˆå¹¶å®Œæˆï¼ŒåŸå§‹ç»“æœ: {len(results)}ï¼Œåˆå¹¶åç»“æœ: {len(merged_results)}")
        return merged_results

    except Exception as e:
        logger.error(f"âŒ å­è¡¨åˆå¹¶å¤±è´¥: {e}")
        return results  # å¤±è´¥æ—¶è¿”å›åŸå§‹ç»“æœ
```

### 3.2 å­è¡¨è¯†åˆ«å’Œåˆ†ç»„

```python
def _identify_subtable_groups(self, results: List[Dict[str, Any]]) -> Dict[str, List[Dict[str, Any]]]:
    """
    è¯†åˆ«å­è¡¨ç»„ï¼ŒæŒ‰parent_table_idåˆ†ç»„ï¼Œå¹¶æŸ¥è¯¢æ•°æ®åº“è·å–æ‰€æœ‰ç›¸å…³å­è¡¨
    
    :param results: é‡æ’åºç»“æœåˆ—è¡¨
    :return: å­è¡¨ç»„å­—å…¸ {parent_table_id: [æ‰€æœ‰å­è¡¨åˆ—è¡¨]}
    """
    subtable_groups = {}
    
    # 1. ä»æ£€ç´¢ç»“æœä¸­è¯†åˆ«å­è¡¨ç»„
    parent_ids_found = set()
    for i, result in enumerate(results):
        metadata = result.get('metadata', {})
        chunk_id = result.get('chunk_id', '')
        chunk_type = result.get('chunk_type', 'unknown')
        
        # æ£€æŸ¥æ˜¯å¦æ˜¯å­è¡¨ï¼šå¦‚æœå­˜åœ¨parent_table_idå­—æ®µï¼Œå°±è®¤ä¸ºæ˜¯å­è¡¨
        parent_id = metadata.get('parent_table_id', '')
        if parent_id:
            parent_ids_found.add(parent_id)
    
    # 2. å¯¹æ¯ä¸ªå‘ç°çš„çˆ¶è¡¨IDï¼ŒæŸ¥è¯¢æ•°æ®åº“è·å–æ‰€æœ‰å­è¡¨
    for parent_id in parent_ids_found:
        all_subtables = self._get_all_subtables_by_parent_id(parent_id)
        if all_subtables:
            subtable_groups[parent_id] = all_subtables
    
    return subtable_groups
```

#### 3.2.1 æ•°æ®åº“æŸ¥è¯¢å­è¡¨

```python
def _get_all_subtables_by_parent_id(self, parent_table_id: str) -> List[Dict[str, Any]]:
    """
    æ ¹æ®çˆ¶è¡¨IDæŸ¥è¯¢æ•°æ®åº“è·å–æ‰€æœ‰å­è¡¨
    
    :param parent_table_id: çˆ¶è¡¨ID
    :return: æ‰€æœ‰å­è¡¨åˆ—è¡¨ï¼ŒæŒ‰subtable_indexæ’åº
    """
    try:
        # ç›´æ¥éå†docstoreè·å–æ‰€æœ‰ç›¸å…³å­è¡¨
        subtables = []
        docstore = self.vector_store_manager.vector_store.docstore
        
        for doc_id, doc in docstore._dict.items():
            metadata = doc.metadata if hasattr(doc, 'metadata') and doc.metadata else {}
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯ç›®æ ‡çˆ¶è¡¨çš„å­è¡¨
            if (metadata.get('chunk_type') == 'table' and 
                metadata.get('parent_table_id') == parent_table_id):
                
                # è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
                formatted_result = self._format_search_result(doc)
                subtables.append(formatted_result)
        
        # æŒ‰subtable_indexæ’åº
        subtables.sort(key=lambda x: x.get('metadata', {}).get('subtable_index', 0))
        
        return subtables
        
    except Exception as e:
        logger.error(f"âŒ æŸ¥è¯¢å­è¡¨å¤±è´¥: {e}")
        return []
```

### 3.3 å­è¡¨åˆå¹¶é€»è¾‘

```python
def _merge_subtable_group(self, subtables: List[Dict[str, Any]]) -> Optional[Dict[str, Any]]:
    """
    åˆå¹¶ä¸€ä¸ªå­è¡¨ç»„
    
    :param subtables: å­è¡¨åˆ—è¡¨
    :return: åˆå¹¶åçš„ç»“æœï¼Œå¤±è´¥æ—¶è¿”å›None
    """
    try:
        if not subtables:
            return None
        
        # æŒ‰ subtable_index æ’åº
        subtables.sort(key=lambda x: x.get('metadata', {}).get('subtable_index', 0))
        
        # æå–æ‰€æœ‰å­è¡¨çš„HTMLå†…å®¹
        subtable_htmls = []
        for i, subtable in enumerate(subtables):
            # ä¼˜å…ˆä½¿ç”¨table_htmlå­—æ®µï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨metadataä¸­çš„table_body
            html_content = subtable.get('table_html', '') or subtable.get('metadata', {}).get('table_body', '')
            if html_content:
                subtable_htmls.append(html_content)
        
        if not subtable_htmls:
            logger.error("âŒ æ²¡æœ‰æœ‰æ•ˆçš„HTMLå†…å®¹ï¼Œåˆå¹¶å¤±è´¥")
            return None
        
        # åˆå¹¶HTMLï¼ˆç®€å•æ‹¼æ¥ï¼Œå› ä¸ºå­è¡¨ä¹‹é—´æ— é‡å¤ï¼‰
        merged_html = self._merge_table_htmls(subtable_htmls)
        
        # ä½¿ç”¨ç¬¬ä¸€ä¸ªå­è¡¨çš„metadataï¼Œä½†æ›´æ–°HTMLå†…å®¹
        merged_result = dict(subtables[0])  # å¤åˆ¶ç¬¬ä¸€ä¸ªå­è¡¨çš„æ‰€æœ‰å­—æ®µ
        
        # æ›´æ–°å…³é”®å­—æ®µ
        merged_result['metadata']['table_body'] = merged_html
        merged_result['metadata']['table_html'] = merged_html
        merged_result['metadata']['is_subtable'] = False  # æ ‡è®°ä¸ºåˆå¹¶åçš„ä¸»è¡¨
        
        # åŒæ—¶æ›´æ–°é¡¶çº§å­—æ®µï¼ˆå‰ç«¯ç›´æ¥è®¿é—®ï¼‰
        merged_result['table_html'] = merged_html
        
        # æ›´æ–°è¡¨æ ¼ç»Ÿè®¡ä¿¡æ¯
        merged_result['metadata']['table_rows'] = self._count_table_rows(merged_html)
        merged_result['metadata']['table_summary'] = self._generate_merged_table_summary(merged_html)
        
        return merged_result
        
    except Exception as e:
        logger.error(f"åˆå¹¶å­è¡¨ç»„å¤±è´¥: {e}")
        return None
```

### 3.4 HTMLåˆå¹¶å®ç°

```python
def _merge_table_htmls(self, html_list: List[str]) -> str:
    """
    åˆå¹¶å¤šä¸ªè¡¨æ ¼HTML
    
    :param html_list: HTMLåˆ—è¡¨
    :return: åˆå¹¶åçš„HTML
    """
    try:
        if not html_list:
            return ""
        
        # ç›´æ¥åˆå¹¶æ‰€æœ‰è¡¨æ ¼çš„å†…å®¹
        all_rows = []
        for i, html in enumerate(html_list):
            # æå–æ‰€æœ‰<tr>æ ‡ç­¾å†…å®¹
            tr_matches = re.findall(r'<tr[^>]*>(.*?)</tr>', html, re.DOTALL)
            
            for j, tr_content in enumerate(tr_matches):
                all_rows.append(f"<tr>{tr_content}</tr>")
        
        # åˆå¹¶HTMLï¼ˆä¿ç•™å®Œæ•´çš„è¡¨æ ¼ç»“æ„ï¼‰
        merged_html = f"<table><tbody>{''.join(all_rows)}</tbody></table>"
        
        return merged_html
        
    except Exception as e:
        logger.error(f"HTMLåˆå¹¶å¤±è´¥: {e}")
        return html_list[0] if html_list else ""
```

### 3.5 HTMLä¿®å¤å’ŒéªŒè¯

```python
def _validate_and_fix_table_html(self, table_html: str, metadata: Dict[str, Any]) -> str:
    """
    éªŒè¯å’Œä¿®å¤è¡¨æ ¼HTML
    
    :param table_html: è¡¨æ ¼HTML
    :param metadata: å…ƒæ•°æ®
    :return: ä¿®å¤åçš„HTML
    """
    try:
        # æ£€æŸ¥HTMLæ˜¯å¦ä¸ºç©º
        if not table_html or table_html.strip() == "":
            # ä»table_contentç”ŸæˆHTML
            table_content = metadata.get('table_content', '')
            if table_content:
                return self._generate_table_html_from_content(table_content, metadata)
            else:
                return self._generate_empty_table_html(metadata)
        
        # ä¿æŒåŸå§‹HTMLç»“æ„ï¼Œä¸æ·»åŠ <thead>æ ‡ç­¾
        # åŸå§‹æ•°æ®ä½¿ç”¨<table><tr><td>...</td></tr></table>ç»“æ„
        # æ•°æ®åº“ä¸­çš„è¡¨æ ¼å·²ç»æœ‰<tbody>æ ‡ç­¾ï¼Œè¡¨å¤´æ˜¯ç¬¬ä¸€è¡Œçš„<td>å†…å®¹
        
        return table_html
        
    except Exception as e:
        logger.warning(f"è¡¨æ ¼HTMLéªŒè¯å¤±è´¥: {e}")
        return table_html

def _generate_table_html_from_content(self, table_content: str, metadata: Dict[str, Any]) -> str:
    """
    ä»table_contentç”ŸæˆHTMLè¡¨æ ¼
    
    :param table_content: è¡¨æ ¼çº¯æ–‡æœ¬å†…å®¹
    :param metadata: å…ƒæ•°æ®
    :return: ç”Ÿæˆçš„HTMLè¡¨æ ¼
    """
    try:
        headers = metadata.get('table_headers', [])
        if not headers:
            # å¦‚æœæ²¡æœ‰è¡¨å¤´ä¿¡æ¯ï¼Œç”Ÿæˆç®€å•è¡¨æ ¼
            return f"<table><tbody><tr><td>{table_content}</td></tr></tbody></table>"
        
        # ç”Ÿæˆå®Œæ•´è¡¨æ ¼
        header_html = self._generate_header_html(headers)
        data_html = f"<tbody><tr><td>{table_content}</td></tr></tbody>"
        
        return f"<table>{header_html}{data_html}</table>"
        
    except Exception as e:
        logging.warning(f"ä»å†…å®¹ç”Ÿæˆè¡¨æ ¼HTMLå¤±è´¥: {e}")
        return f"<table><tbody><tr><td>{table_content}</td></tr></tbody></table>"

def _generate_empty_table_html(self, metadata: Dict[str, Any]) -> str:
    """
    ç”Ÿæˆç©ºè¡¨æ ¼HTMLï¼ˆåªæœ‰è¡¨å¤´ï¼‰
    
    :param metadata: å…ƒæ•°æ®
    :return: ç©ºè¡¨æ ¼HTML
    """
    try:
        headers = metadata.get('table_headers', [])
        if headers:
            header_html = self._generate_header_html(headers)
            return f"<table>{header_html}<tbody></tbody></table>"
        else:
            return "<table><tbody></tbody></table>"
            
    except Exception as e:
        logging.warning(f"ç”Ÿæˆç©ºè¡¨æ ¼HTMLå¤±è´¥: {e}")
        return "<table><tbody></tbody></table>"

def _generate_header_html(self, headers: List[str]) -> str:
    """
    ç”Ÿæˆè¡¨å¤´HTML
    
    :param headers: è¡¨å¤´åˆ—è¡¨
    :return: è¡¨å¤´HTMLå­—ç¬¦ä¸²
    """
    if not headers:
        return ""
    
    header_cells = []
    for header in headers:
        header_cells.append(f"<th>{header}</th>")
    
    return f"<thead><tr>{''.join(header_cells)}</tr></thead>"
```

### 3.6 å®é™…è°ƒç”¨æµç¨‹

#### 3.6.1 åœ¨SimpleSmartProcessorä¸­çš„è°ƒç”¨

```python
# åœ¨ simple_smart_processor.py çš„ process_single_type_query æ–¹æ³•ä¸­
async def process_single_type_query(self, query: str, content_type: str, 
                                  options: QueryOptions) -> QueryResult:
    # ... å‰é¢çš„å¤„ç†é€»è¾‘ ...
    
    # 4. å­è¡¨åˆå¹¶ï¼ˆåœ¨è¾“å‡ºç»™å‰ç«¯å‰ï¼‰
    if content_type == 'table' and self.config.get('rag_system.table_merge.enabled', True):
        try:
            logger.info(f"ğŸ”„ å¼€å§‹è¡¨æ ¼å­è¡¨åˆå¹¶ï¼Œè¾“å…¥ç»“æœæ•°é‡: {len(reranked_results)}")
            
            # è·å–å‘é‡æ•°æ®åº“é›†æˆå®ä¾‹
            vector_db = self.unified_services.vector_db_integration
            if vector_db:
                # è®°å½•åˆå¹¶å‰çš„è¡¨æ ¼ç»“æœ
                table_results_before = [r for r in reranked_results if r.get('chunk_type') == 'table']
                logger.info(f"ğŸ”„ å¼€å§‹è¡¨æ ¼å­è¡¨åˆå¹¶ï¼Œè¾“å…¥ç»“æœæ•°é‡: {len(table_results_before)}")
                
                merged_results = vector_db.format_search_results_with_merge(reranked_results)
                
                # è®°å½•åˆå¹¶åçš„è¡¨æ ¼ç»“æœ
                table_results_after = [r for r in merged_results if r.get('chunk_type') == 'table']
                logger.info(f"âœ… è¡¨æ ¼å­è¡¨åˆå¹¶å®Œæˆï¼ŒåŸå§‹ç»“æœ: {len(reranked_results)}ï¼Œåˆå¹¶åç»“æœ: {len(merged_results)}")
                reranked_results = merged_results
            else:
                logger.warning("âš ï¸ æ— æ³•è·å–å‘é‡æ•°æ®åº“é›†æˆå®ä¾‹")
        except Exception as e:
            logger.warning(f"âŒ è¡¨æ ¼å­è¡¨åˆå¹¶å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹ç»“æœ: {e}")
    else:
        logger.info(f"â„¹ï¸ è·³è¿‡å­è¡¨åˆå¹¶ï¼Œcontent_type={content_type}, enabled={self.config.get('rag_system.table_merge.enabled', True)}")
    
    # ... åç»­å¤„ç†é€»è¾‘ ...
```

#### 3.6.2 è°ƒç”¨æ—¶æœºå’Œæ¡ä»¶

- **è°ƒç”¨æ—¶æœº**ï¼šLLMå¤„ç†å®Œæˆåï¼Œå‰ç«¯å±•ç¤ºå‰
- **è°ƒç”¨æ¡ä»¶**ï¼š
  - `content_type == 'table'`ï¼ˆè¡¨æ ¼ç±»å‹æŸ¥è¯¢ï¼‰
  - `rag_system.table_merge.enabled == True`ï¼ˆé…ç½®å¯ç”¨ï¼‰
- **è°ƒç”¨ä½ç½®**ï¼š`simple_smart_processor.py` çš„ `process_single_type_query` æ–¹æ³•
- **è°ƒç”¨æ–¹æ³•**ï¼š`vector_db.format_search_results_with_merge(reranked_results)`


## 4. å…³é”®ç‰¹æ€§

### 4.1 å­è¡¨æ— é‡å¤ç‰¹æ€§
- **åˆ†å—ç­–ç•¥**ï¼šæŒ‰è¡Œæ•°è¿ç»­åˆ†å—ï¼Œä¸æ˜¯æŒ‰å­—ç¬¦æ•°åˆ†å—
- **æ— é‡å æœºåˆ¶**ï¼šæ²¡æœ‰chunk_overlapï¼Œæ¯ä¸ªæ•°æ®è¡Œåªå±äºä¸€ä¸ªå­è¡¨
- **è¿ç»­è¦†ç›–**ï¼šå­è¡¨1åŒ…å«è¡Œ1-Nï¼Œå­è¡¨2åŒ…å«è¡ŒN+1-Mï¼Œå®Œå…¨è¿ç»­

### 4.2 åˆå¹¶ç­–ç•¥
- **ç®€å•æ‹¼æ¥**ï¼šå­è¡¨ä¹‹é—´æ— é‡å¤ï¼Œç›´æ¥æ‹¼æ¥å³å¯
- **è¡¨å¤´ä¿æŒ**ï¼šä½¿ç”¨ç¬¬ä¸€ä¸ªå­è¡¨çš„è¡¨å¤´
- **æ•°æ®è¡Œåˆå¹¶**ï¼šæŒ‰é¡ºåºæ‹¼æ¥æ‰€æœ‰å­è¡¨çš„æ•°æ®è¡Œ
- **HTMLç»“æ„å®Œæ•´**ï¼šä¿æŒå®Œæ•´çš„HTMLè¡¨æ ¼ç»“æ„

### 4.3 HTMLä¿®å¤ç­–ç•¥
- **ç©ºHTMLå¤„ç†**ï¼šå½“HTMLä¸ºç©ºæ—¶ï¼Œä»`table_content`ç”Ÿæˆå®Œæ•´HTML
- **ç»“æ„ä¿æŒ**ï¼šä¿æŒåŸå§‹HTMLç»“æ„ï¼Œä¸æ·»åŠ `<thead>`æ ‡ç­¾
- **é™çº§å¤„ç†**ï¼šä¿®å¤å¤±è´¥æ—¶æä¾›åŸºæœ¬çš„è¡¨æ ¼ç»“æ„

### 4.4 å…ƒæ•°æ®ä¿æŒ
- **å®Œæ•´å¤åˆ¶**ï¼šä½¿ç”¨`dict(subtables[0])`å¤åˆ¶ç¬¬ä¸€ä¸ªå­è¡¨çš„æ‰€æœ‰å­—æ®µ
- **å­—æ®µæ›´æ–°**ï¼šåªæ›´æ–°`table_body`ã€`table_html`å’Œ`is_subtable`å­—æ®µ
- **å…¶ä»–å­—æ®µä¿æŒ**ï¼š`table_content`ã€`relevance_score`ç­‰å­—æ®µä¿æŒä¸å˜

## 5. é…ç½®ç®¡ç†

### 5.1 é…ç½®å‚æ•°

```json
{
  "rag_system": {
    "table_merge": {
      "enabled": true,
      "max_subtables_per_group": 10,
      "merge_timeout": 5.0,
      "fallback_to_original": true,
      "log_merge_details": false
    }
  }
}
```

**å®é™…é…ç½®æ–‡ä»¶ä½ç½®**ï¼š`db_system/config/v3_config.json`

### 5.2 å‚æ•°è¯´æ˜

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `enabled` | boolean | true | æ˜¯å¦å¯ç”¨è¡¨æ ¼å­è¡¨åˆå¹¶åŠŸèƒ½ |
| `max_subtables_per_group` | integer | 10 | æ¯ä¸ªå­è¡¨ç»„çš„æœ€å¤§å­è¡¨æ•°é‡ |
| `merge_timeout` | number | 5.0 | åˆå¹¶æ“ä½œè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ |
| `fallback_to_original` | boolean | true | åˆå¹¶å¤±è´¥æ—¶æ˜¯å¦è¿”å›åŸå§‹ç»“æœ |
| `log_merge_details` | boolean | false | æ˜¯å¦è®°å½•åˆå¹¶è¯¦ç»†ä¿¡æ¯ |

## 6. é”™è¯¯å¤„ç†

### 6.1 å¼‚å¸¸æƒ…å†µå¤„ç†

å½“å‰ä»£ç ä¸­çš„é”™è¯¯å¤„ç†ç­–ç•¥ï¼š

1. **åˆå¹¶å¤±è´¥æ—¶è¿”å›åŸå§‹ç»“æœ**ï¼šåœ¨ `_merge_subtables_for_display` æ–¹æ³•ä¸­ï¼Œå¦‚æœåˆå¹¶å¤±è´¥ä¼šè¿”å›åŸå§‹ç»“æœ
2. **é…ç½®é©±åŠ¨çš„é™çº§å¤„ç†**ï¼šé€šè¿‡ `rag_system.table_merge.fallback_to_original` é…ç½®æ§åˆ¶æ˜¯å¦é™çº§
3. **æ—¥å¿—è®°å½•**ï¼šæ‰€æœ‰é”™è¯¯éƒ½ä¼šè®°å½•åˆ°æ—¥å¿—ä¸­ï¼Œä¾¿äºè°ƒè¯•

### 6.2 å¸¸è§é”™è¯¯ç±»å‹

1. **HTMLè§£æé”™è¯¯**ï¼šæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å¤±è´¥
2. **å­è¡¨æ’åºé”™è¯¯**ï¼šsubtable_indexå­—æ®µç¼ºå¤±æˆ–æ ¼å¼é”™è¯¯
3. **å†…å­˜ä¸è¶³**ï¼šåˆå¹¶å¤§é‡å­è¡¨æ—¶å†…å­˜æº¢å‡º
4. **è¶…æ—¶é”™è¯¯**ï¼šåˆå¹¶æ“ä½œè¶…è¿‡é…ç½®çš„è¶…æ—¶æ—¶é—´

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 åˆå¹¶ä¼˜åŒ–ç­–ç•¥

å½“å‰ä»£ç ä¸­çš„æ€§èƒ½ä¼˜åŒ–æªæ–½ï¼š

1. **æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–**ï¼šé€šè¿‡ `_get_all_subtables_by_parent_id` æ–¹æ³•ç›´æ¥æŸ¥è¯¢æ•°æ®åº“è·å–æ‰€æœ‰ç›¸å…³å­è¡¨
2. **ç®€å•æ‹¼æ¥ç­–ç•¥**ï¼šå­è¡¨ä¹‹é—´æ— é‡å¤ï¼Œç›´æ¥æ‹¼æ¥HTMLå†…å®¹ï¼Œæ— éœ€å¤æ‚çš„å»é‡é€»è¾‘
3. **é…ç½®é™åˆ¶**ï¼šé€šè¿‡ `max_subtables_per_group` é…ç½®é™åˆ¶æ¯ä¸ªå­è¡¨ç»„çš„æœ€å¤§å­è¡¨æ•°é‡
4. **é”™è¯¯é™çº§**ï¼šåˆå¹¶å¤±è´¥æ—¶å¿«é€Ÿè¿”å›åŸå§‹ç»“æœï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…

### 7.2 å†…å­˜ç®¡ç†

- **åŠæ—¶é‡Šæ”¾**ï¼šåˆå¹¶å®ŒæˆååŠæ—¶é‡Šæ”¾ä¸­é—´å˜é‡
- **åˆ†æ‰¹å¤„ç†**ï¼šå¤§é‡å­è¡¨æ—¶åˆ†æ‰¹åˆå¹¶
- **å†…å­˜ç›‘æ§**ï¼šç›‘æ§åˆå¹¶è¿‡ç¨‹ä¸­çš„å†…å­˜ä½¿ç”¨æƒ…å†µ

## 8. æµ‹è¯•æ–¹æ¡ˆ

### 8.1 å•å…ƒæµ‹è¯•

```python
def test_merge_subtables_for_display():
    """æµ‹è¯•å­è¡¨åˆå¹¶åŠŸèƒ½"""
    # å‡†å¤‡æµ‹è¯•æ•°æ®
    subtable1 = {
        'chunk_id': 'table_1_0',
        'metadata': {
            'is_subtable': True,
            'parent_table_id': 'table_1',
            'subtable_index': 0,
            'table_body': '<table><thead><tr><th>åˆ—1</th><th>åˆ—2</th></tr></thead><tbody><tr><td>æ•°æ®1</td><td>æ•°æ®2</td></tr></tbody></table>'
        }
    }
    
    subtable2 = {
        'chunk_id': 'table_1_1',
        'metadata': {
            'is_subtable': True,
            'parent_table_id': 'table_1',
            'subtable_index': 1,
            'table_body': '<table><thead><tr><th>åˆ—1</th><th>åˆ—2</th></tr></thead><tbody><tr><td>æ•°æ®3</td><td>æ•°æ®4</td></tr></tbody></table>'
        }
    }
    
    independent_table = {
        'chunk_id': 'table_2',
        'metadata': {
            'is_subtable': False,
            'table_body': '<table><thead><tr><th>åˆ—A</th><th>åˆ—B</th></tr></thead><tbody><tr><td>æ•°æ®A</td><td>æ•°æ®B</td></tr></tbody></table>'
        }
    }
    
    # æ‰§è¡Œåˆå¹¶
    result = merge_subtables_for_display([subtable1, subtable2, independent_table])
    
    # éªŒè¯ç»“æœ
    assert len(result) == 2  # 1ä¸ªåˆå¹¶è¡¨ + 1ä¸ªç‹¬ç«‹è¡¨
    assert any(not r['metadata'].get('is_subtable', False) for r in result)
    assert any('æ•°æ®1' in r['metadata']['table_body'] for r in result)
    assert any('æ•°æ®3' in r['metadata']['table_body'] for r in result)
```

### 8.2 é›†æˆæµ‹è¯•

```python
def test_subtable_merge_integration():
    """æµ‹è¯•å­è¡¨åˆå¹¶çš„é›†æˆåŠŸèƒ½"""
    # å‡†å¤‡æµ‹è¯•æ•°æ®
    subtable1 = {
        'chunk_id': 'table_1_0',
        'metadata': {
            'is_subtable': True,
            'parent_table_id': 'table_1',
            'subtable_index': 0,
            'table_body': '<table><tbody><tr><td>æ•°æ®1</td><td>æ•°æ®2</td></tr></tbody></table>'
        }
    }
    
    subtable2 = {
        'chunk_id': 'table_1_1',
        'metadata': {
            'is_subtable': True,
            'parent_table_id': 'table_1',
            'subtable_index': 1,
            'table_body': '<table><tbody><tr><td>æ•°æ®3</td><td>æ•°æ®4</td></tr></tbody></table>'
        }
    }
    
    # æ‰§è¡Œåˆå¹¶
    vector_db = VectorDBIntegration()
    merged_results = vector_db.format_search_results_with_merge([subtable1, subtable2])
    
    # éªŒè¯ç»“æœ
    assert len(merged_results) == 1  # åˆå¹¶ååªæœ‰1ä¸ªç»“æœ
    assert not merged_results[0]['metadata'].get('is_subtable', False)  # ä¸å†æ˜¯å­è¡¨
    assert 'æ•°æ®1' in merged_results[0]['table_html']  # åŒ…å«ç¬¬ä¸€ä¸ªå­è¡¨çš„æ•°æ®
    assert 'æ•°æ®3' in merged_results[0]['table_html']  # åŒ…å«ç¬¬äºŒä¸ªå­è¡¨çš„æ•°æ®
```

## 9. éƒ¨ç½²è¯´æ˜

### 9.1 éƒ¨ç½²æ­¥éª¤

1. **ä»£ç æ›´æ–°**ï¼šæ›´æ–° `vector_db_integration.py` æ–‡ä»¶
2. **é…ç½®æ›´æ–°**ï¼šåœ¨ `v3_config.json` ä¸­æ·»åŠ è¡¨æ ¼åˆå¹¶é…ç½®
3. **é‡å¯æœåŠ¡**ï¼šé‡å¯RAGç³»ç»ŸæœåŠ¡
4. **åŠŸèƒ½éªŒè¯**ï¼šæµ‹è¯•è¡¨æ ¼æŸ¥è¯¢å’Œåˆå¹¶åŠŸèƒ½

### 9.2 å›æ»šæ–¹æ¡ˆ

å¦‚æœåˆå¹¶åŠŸèƒ½å‡ºç°é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡é…ç½®å¿«é€Ÿå…³é—­ï¼š

```json
{
  "rag_system": {
    "table_merge": {
      "enabled": false
    }
  }
}
```

## 10. ç›‘æ§å’Œæ—¥å¿—

### 10.1 æ—¥å¿—è®°å½•

å½“å‰ä»£ç ä¸­çš„å®é™…æ—¥å¿—è¾“å‡ºï¼š

```python
# åˆå¹¶å¼€å§‹
logger.info(f"ğŸ” å¼€å§‹å­è¡¨åˆå¹¶ï¼Œè¾“å…¥ç»“æœæ•°é‡: {len(results)}")

# åˆå¹¶è¿›åº¦
logger.info(f"ğŸ”„ å¼€å§‹åˆå¹¶å­è¡¨ç»„ {parent_id}ï¼ŒåŒ…å« {len(subtables)} ä¸ªå­è¡¨")
logger.info(f"âœ… å­è¡¨ç»„åˆå¹¶æˆåŠŸï¼ŒåŒ…å« {len(subtables)} ä¸ªå­è¡¨")

# åˆå¹¶å®Œæˆ
logger.info(f"âœ… å­è¡¨åˆå¹¶å®Œæˆï¼ŒåŸå§‹ç»“æœ: {len(results)}ï¼Œåˆå¹¶åç»“æœ: {len(merged_results)}")

# é”™è¯¯è®°å½•
logger.error(f"âŒ å­è¡¨åˆå¹¶å¤±è´¥: {error}")
logger.warning(f"âŒ å­è¡¨ç»„åˆå¹¶å¤±è´¥")
logger.warning(f"âš ï¸ å­è¡¨ä½†æ‰¾ä¸åˆ°å¯¹åº”çš„ç»„")
```

### 10.2 æ€§èƒ½ç›‘æ§

- **åˆå¹¶æ—¶é—´**ï¼šè®°å½•æ¯ä¸ªå­è¡¨ç»„çš„åˆå¹¶æ—¶é—´
- **å†…å­˜ä½¿ç”¨**ï¼šç›‘æ§åˆå¹¶è¿‡ç¨‹ä¸­çš„å†…å­˜ä½¿ç”¨æƒ…å†µ
- **æˆåŠŸç‡**ï¼šç»Ÿè®¡åˆå¹¶æ“ä½œçš„æˆåŠŸç‡

## 11. æ€»ç»“

æœ¬è®¾è®¡æ–‡æ¡£è¯¦ç»†æè¿°äº†è¡¨æ ¼å­è¡¨åˆå¹¶æ¨¡å—çš„å®ç°æ–¹æ¡ˆï¼Œé€šè¿‡åˆ†æç¡®è®¤å­è¡¨ä¹‹é—´æ— é‡å¤å†…å®¹ï¼Œé‡‡ç”¨ç®€å•å¯é çš„æ‹¼æ¥ç­–ç•¥ï¼Œå¹¶å¢åŠ äº†HTMLä¿®å¤åŠŸèƒ½ï¼Œç¡®ä¿ç”¨æˆ·èƒ½å¤Ÿçœ‹åˆ°å®Œæ•´çš„è¡¨æ ¼å†…å®¹ã€‚

### 11.1 å®ç°ç‰¹ç‚¹

1. **æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–**ï¼šé€šè¿‡æŸ¥è¯¢æ•°æ®åº“è·å–æ‰€æœ‰ç›¸å…³å­è¡¨ï¼Œç¡®ä¿åˆå¹¶çš„å®Œæ•´æ€§
2. **ç®€å•å¯é **ï¼šå­è¡¨ä¹‹é—´æ— é‡å¤ï¼Œç›´æ¥æ‹¼æ¥å³å¯
3. **æ€§èƒ½è‰¯å¥½**ï¼šä¸éœ€è¦å¤æ‚çš„å»é‡é€»è¾‘
4. **æ ¼å¼ç»Ÿä¸€**ï¼šæ¯ä¸ªå­è¡¨éƒ½æœ‰å®Œæ•´çš„è¡¨å¤´ï¼Œåˆå¹¶åæ ¼å¼ä¸€è‡´
5. **ä¿¡æ¯å®Œæ•´**ï¼šä¿æŒæ‰€æœ‰metadataå­—æ®µ
6. **HTMLä¿®å¤**ï¼šè‡ªåŠ¨ä¿®å¤ä¸å®Œæ•´çš„è¡¨æ ¼HTMLï¼Œä¿æŒåŸå§‹ç»“æ„
7. **é™çº§å¤„ç†**ï¼šä¿®å¤å¤±è´¥æ—¶æä¾›åŸºæœ¬çš„è¡¨æ ¼ç»“æ„
8. **æ˜“äºç»´æŠ¤**ï¼šä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤

### 11.2 æ ¸å¿ƒä¼˜åŠ¿

- **å®Œæ•´æ€§ä¿è¯**ï¼šé€šè¿‡æ•°æ®åº“æŸ¥è¯¢ç¡®ä¿è·å–æ‰€æœ‰ç›¸å…³å­è¡¨
- **æ—¥å¿—ä¼˜åŒ–**ï¼šåªä¿ç•™å…³é”®çš„åˆå¹¶åŠ¨ä½œæ—¥å¿—ï¼Œå‡å°‘å†—ä½™è¾“å‡º
- **é…ç½®çµæ´»**ï¼šæ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶å¯ç”¨/ç¦ç”¨åŠŸèƒ½
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§

### 11.3 è§£å†³çš„é—®é¢˜

- **å­è¡¨åˆå¹¶é—®é¢˜**ï¼šå°†ç›¸å…³å­è¡¨åˆå¹¶æˆå®Œæ•´çš„ä¸»è¡¨
- **åŸè¡¨æ˜¾ç¤ºé—®é¢˜**ï¼šä¿æŒåŸå§‹è¡¨æ ¼HTMLç»“æ„
- **ç”¨æˆ·ä½“éªŒé—®é¢˜**ï¼šç¡®ä¿å‰ç«¯å§‹ç»ˆæ˜¾ç¤ºå®Œæ•´çš„è¡¨æ ¼å†…å®¹
- **æ•°æ®å®Œæ•´æ€§é—®é¢˜**ï¼šé€šè¿‡æ•°æ®åº“æŸ¥è¯¢ç¡®ä¿ä¸é—æ¼ä»»ä½•å­è¡¨

### 11.4 æŠ€æœ¯äº®ç‚¹

1. **æ™ºèƒ½è¯†åˆ«**ï¼šé€šè¿‡ `parent_table_id` å­—æ®µæ™ºèƒ½è¯†åˆ«å­è¡¨
2. **æ•°æ®åº“é›†æˆ**ï¼šç›´æ¥æŸ¥è¯¢docstoreè·å–å®Œæ•´å­è¡¨åˆ—è¡¨
3. **HTMLå¤„ç†**ï¼šæ”¯æŒå¤šç§HTMLæ ¼å¼çš„åˆå¹¶ï¼Œä¿æŒåŸå§‹ç»“æ„
4. **é…ç½®é©±åŠ¨**ï¼šé€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶åŠŸèƒ½å¯ç”¨çŠ¶æ€
5. **æ—¥å¿—ç®¡ç†**ï¼šä¼˜åŒ–çš„æ—¥å¿—è¾“å‡ºï¼Œåªæ˜¾ç¤ºå…³é”®ä¿¡æ¯

è¯¥æ–¹æ¡ˆæ—¢è§£å†³äº†å­è¡¨åˆå¹¶çš„éœ€æ±‚ï¼Œä¹Ÿä¿®å¤äº†åŸè¡¨æ˜¾ç¤ºçš„é—®é¢˜ï¼Œå…¨é¢æå‡äº†è¡¨æ ¼å±•ç¤ºçš„ç”¨æˆ·ä½“éªŒã€‚
