# V3版本向量数据库构建系统需求文档（完善版）

## 项目概述

### 项目目标
将现有RAG系统重构为两个独立部分：
1. **第一部分**：向量数据库构建系统（当前重点）
2. **第二部分**：RAG查询系统（后续开发）

### 核心原则
- 保持原有优秀设计和实现
- 统一接口，简化架构
- 模块化设计，易于维护和扩展
- 配置集中化，易于管理

## 系统架构设计

### 目录结构
```
v3/
├── __init__.py
├── main.py                          # 主程序入口（统一处理入口）
├── config/
│   ├── __init__.py
│   ├── config_manager.py            # 配置管理器主类
│   ├── config_validator.py          # 配置验证器
│   ├── config_loader.py             # 配置加载器
│   ├── environment_manager.py       # 环境变量管理器（Windows兼容）
│   ├── path_manager.py              # 路径管理器
│   ├── failure_handler.py           # 失败处理管理器
│   ├── v3_config.json              # V3配置文件
│   └── v3_config_schema.json       # 配置模式文件
├── core/
│   ├── __init__.py
│   ├── v3_main_processor.py         # 主控制器
│   ├── content_processor.py          # 内容处理器
│   ├── vectorization_manager.py      # 向量化管理
│   └── metadata_manager.py           # 元数据管理
├── processors/
│   ├── __init__.py
│   ├── text_processor.py             # 文本处理器
│   ├── image_processor.py            # 图像处理器
│   └── table_processor.py            # 表格处理器
├── vectorization/
│   ├── __init__.py
│   ├── text_vectorizer.py            # 文本向量化
│   ├── image_vectorizer.py           # 图像向量化（双重embedding）
│   └── table_vectorizer.py           # 表格向量化
├── metadata/
│   ├── __init__.py
│   ├── metadata_schema.py            # 元数据模式
│   ├── metadata_manager.py           # 元数据管理器
│   └── metadata_validator.py         # 元数据验证器
└── utils/
    ├── __init__.py
    ├── document_type_detector.py     # 文档类型检测
    ├── vector_db_validator.py        # 向量数据库验证
    ├── file_utils.py                 # 文件工具
    ├── logging_utils.py              # 日志工具
    └── validation_utils.py           # 验证工具
```

## 🔧 核心功能需求

### 1. 统一文档处理模式

#### 1.1 处理模式整合
- **统一入口**：将新建模式和增加模式整合为一个统一的处理流程
- **智能判断**：自动检测目标向量数据库是否存在，决定是新建还是追加
- **增量支持**：支持向现有数据库追加新文档，保持数据一致性

**参考原有实现**：
- `V501_simplified_document_processor.py` - 新建模式
- `V501_incremental_processor.py` - 增加模式
- 整合两者的优秀设计，统一处理流程

#### 1.2 图像增强和向量化
- **统一开关**：只设置一个 `enable_image_enhancement` 开关
- **自动执行**：开关打开时，在新建或增加过程中自动执行图像增强和向量化
- **基础信息保留**：开关关闭时，只保留基本的图像信息组合
- **超时机制**：图片增强和向量化设置超时机制，如果失败则跳过处理
- **独立补做程序**：需要独立的程序判断图片增强和向量化是否完成，如果没有完成需要补做

**参考原有实现**：
- `V502_image_enhancer_new.py` - 图像增强和向量化管理
- 整合到主处理流程中，支持批量处理和状态管理

### 2. 模块化处理器设计

#### 2.1 文本处理器
- **功能**：文本分块、清理、向量化
- **特点**：处理最简单，性能最优
- **输出**：标准化的文本chunk和向量
- **参考**：整合 `document_processing/document_chunker.py` 和 `enhanced_chunker.py`

#### 2.2 图像处理器
- **功能**：
  - 图像embedding生成
  - 增强描述文本生成
  - 增强描述文本向量化
- **要求**：
  - 支持文本和图像相似度查询
  - 能通过文本查询找到相关图像
  - 支持图像位置定位和展示
  - **重要**：文本和图像相似度查询后，返回image chunk，无需返回Image_text的chunk
- **参考**：整合 `document_processing/image_processor.py` 和 `image_enhancer.py`

#### 2.3 表格处理器
- **功能**：
  - HTML表格内容提取（从json后缀的文档中）
  - 表格内容文本向量化
  - 大表格智能分块处理
- **要求**：
  - 保持表格结构完整性
  - 支持表格内容语义化
  - 参考现有实现方式优化
- **参考**：整合 `document_processing/table_processor.py`

### 3. 元数据规范化设计

#### 3.1 统一元数据模式
**参考现有模式做调优**：
- 可运行 `tools_important/vector_db_diagnostic_tool.py` 获得当前架构
- 基于现有metadata结构进行标准化和优化

#### 3.2 类型特定元数据
- **文本类型**：chunk_index, content_preview, page_content
- **图像类型**：image_path, image_caption, enhanced_description, image_id, image_type
- **表格类型**：table_id, table_headers, html_content, row_count, column_count, processed_table_content

### 4. 配置管理系统

#### 4.1 配置结构
**参考现有目录结构和配置优化**：
```json
{
  "paths": {
    "input_pdf_dir": "./document/orig_pdf",
    "mineru_output_dir": "./document/md",
    "final_image_dir": "./central/images",
    "vector_db_dir": "./central/vector_db",
    "temp_dir": "./temp",
    "logs_dir": "./logs"
  },
  "document_processing": {
    "chunk_size": 1000,
    "chunk_overlap": 200
  },
  "vectorization": {
    "text_embedding_model": "text-embedding-v1",
    "image_embedding_model": "multimodal-embedding-one-peace-v1"
  },
  "image_processing": {
    "enable_enhancement": true,
    "enhancement_model": "qwen-vl-plus",
    "enhancement_model_api": "dashscope"
  },
  "mineru": {
    "api_endpoint": "https://api.mineru.com",
    "batch_size": 10,
    "timeout": 300,
    "retry_count": 3,
    "poll_interval": 10
  },
  "api_rate_limiting": {
    "enhancement_batch_size": 5,
    "enhancement_delay_seconds": 2,
    "vectorization_batch_size": 10,
    "vectorization_delay_seconds": 1,
    "max_retries": 3,
    "retry_delay_seconds": 5,
    "enable_rate_limiting": true
  },
  "batch_processing": {
    "enhancement_workers": 2,
    "vectorization_workers": 3,
    "queue_size": 100,
    "timeout_seconds": 300,
    "progress_report_interval": 10
  },
  "failure_handling": {
    "skip_failed_images": true,
    "max_retries": 3,
    "retry_delay_seconds": 5,
    "continue_on_failure": true,
    "generate_failure_report": true,
    "failure_report_path": "./logs/failure_report.json",
    "mark_for_later_processing": true,
    "failure_report_format": "detailed"
  },
  "storage": {
    "backup_enabled": true,
    "backup_interval": 24
  }
}
```

#### 4.2 配置管理原则
- **集中化**：所有配置集中在JSON文件中
- **环境变量**：API密钥从Windows环境变量读取
- **参数验证**：开发模块中不设置默认值，缺少参数直接提示
- **用户友好**：用户只需修改JSON文件，无需修改代码
- **需要清晰的目录结构**：参考原来的目录结构设计

## 🔄 处理流程设计

### 1. 统一处理流程
**参考现有流程优化**：
- 文档处理采用minerU对PDF的处理方式
- 参考 `document_processing/pdf_processor.py` 和 `minerU_batch_local_files.py`
- 参考 `document_processing/markdown_processor.py`

```
输入文档 → 文档类型检测 → 分发到对应处理器 → 内容处理 → 向量化 → 元数据生成 → 存储到向量数据库
```

### 2. 智能模式选择
```
检查目标向量数据库 → 存在？ → 是：追加模式 / 否：新建模式
```

### 3. 图像增强流程
```
图像输入 → 基础信息提取 → 增强开关检查 → 开启：执行增强 → 生成增强描述 → 向量化
```

## 📊 技术实现要求

### 1. 向量数据库
- **后端**：优先支持FAISS，预留其他后端接口
- **存储**：统一的metadata.pkl和index.faiss文件
- **索引**：支持文本、图像、表格的混合索引

### 2. 性能要求
- **处理速度**：支持批量文档处理
- **内存优化**：大文档处理时的内存管理
- **并发支持**：支持多进程/多线程处理

### 3. 兼容性要求
- **向后兼容**：支持现有数据格式的导入
- **接口标准**：为RAG系统提供标准接口

## 🚀 开发计划

### 第一阶段：基础架构（1-2周）
1. 创建V3目录结构
2. 实现配置管理系统
3. 创建基础处理器接口

### 第二阶段：核心功能（2-3周）
1. 实现文本处理器
2. 实现图像处理器
3. 实现表格处理器

### 第三阶段：整合测试（1-2周）
1. 整合所有处理器
2. 实现统一处理流程
3. 测试和优化

### 第四阶段：接口标准化（1周）
1. 定义RAG系统接口
2. 编写接口文档
3. 性能测试和优化

## ❓ 需要确认的问题

1. **图像增强模型**：是否继续使用qwen-vl-plus？
   - **答案**：是的，这个可以在参数里配置的。

2. **表格分块策略**：大表格的分块规则如何定义？
   - **答案**：参考原先方案优化，基于 `document_processing/table_processor.py`

3. **向量数据库后端**：除了FAISS，是否需要支持其他后端？
   - **答案**：暂时不要

4. **性能指标**：对处理速度和内存使用有什么具体要求？
   - **答案**：优化内存管理

5. **数据迁移**：现有数据如何迁移到新系统？
   - **答案**：无需迁徙，重新生成

## 🔍 关键设计要点

### 1. 保持原有优秀设计
- 整合 `V501_simplified_document_processor.py` 和 `V501_incremental_processor.py` 的优秀架构
- 保留 `V502_image_enhancer_new.py` 的图像增强管理逻辑
- 维持现有文档处理管道的稳定性

### 2. 模块化重构
- 将分散的代码整合到统一的模块结构中
- 保持各处理器的独立性，便于维护和扩展
- 统一接口设计，便于后续RAG系统调用

### 3. 配置管理优化
- 参考现有配置结构，进行优化和标准化
- 支持环境变量读取API密钥
- 提供清晰的参数验证和错误提示

### 4. 元数据标准化
- 基于现有metadata结构进行规范化
- 确保字段含义清晰，便于RAG系统使用
- 支持类型特定的元数据扩展

