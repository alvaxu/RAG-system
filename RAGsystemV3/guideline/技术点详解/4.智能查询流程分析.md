# 智能查询流程分析

## 1. 智能查询整体架构流程

### 1.1 系统架构层次

```
用户查询 → QueryProcessor → QueryRouter → SimpleSmartProcessor → UnifiedServices → 具体服务
    ↓           ↓              ↓              ↓                    ↓              ↓
  查询文本   查询处理器    查询路由器    智能查询处理器        统一服务接口    检索/重排序/LLM
```

### 1.2 核心组件关系

```
QueryProcessor (查询处理器)
├── SimpleQueryRouter (查询路由器)
│   ├── SimpleSmartProcessor (智能查询处理器)
│   │   ├── UnifiedServices (统一服务接口)
│   │   │   ├── RetrievalEngine (检索引擎)
│   │   │   ├── MultiModelReranker (重排序服务)
│   │   │   └── LLMCaller (LLM调用服务)
│   │   └── _detect_type() (类型检测)
│   └── SimpleHybridProcessor (混合查询处理器)
└── _build_query_options() (查询选项构建)
```

## 2. 智能查询详细流程分析

### 2.1 输入处理阶段

#### 2.1.1 查询接收
- **入口**：`QueryProcessor.process_query(query, query_type, options)`
- **查询类型**：支持 `auto`、`smart`、`text`、`image`、`table`、`hybrid`
- **选项构建**：通过 `_build_query_options()` 构建 `QueryOptions` 对象

#### 2.1.2 查询路由
- **路由器**：`SimpleQueryRouter.route_query()`
- **路由策略**：
  - `smart` → `SimpleSmartProcessor.process_smart_query()`
  - `hybrid` → `SimpleHybridProcessor.process_hybrid_query()`
  - `text/image/table` → `SimpleSmartProcessor.process_single_type_query()`
  - `auto` → 自动检测类型后路由

### 2.2 智能类型检测阶段

#### 2.2.1 检测算法
**位置**：`SimpleSmartProcessor._detect_type(query)`

```python
def _detect_type(self, query: str) -> tuple[str, float]:
    # 图片相关关键词检测
    image_keywords = ['图片', '图像', '照片', '图表', '截图', '界面', '显示', '展示', '图标', 'logo']
    image_matches = sum(1 for keyword in image_keywords if keyword in query)
    
    # 表格相关关键词检测
    table_keywords = ['表格', '数据', '统计', '数字', '金额', '数量', '比例', '百分比', '排名', '对比', 
                    '营收', '收入', '利润', '财务', '业绩', '报告', '年报', '半年报', '季度', '预测', 
                    '趋势', '变化', '增长', '下降', '上升', '下跌', '分析', '指标', '比率']
    table_matches = sum(1 for keyword in table_keywords if keyword in query)
    
    # 文本相关特征
    text_features = len(query) > 20  # 长文本倾向于文本查询
```

#### 2.2.2 置信度计算
- **图片类型**：`confidence = min(image_score + 0.2, 0.9)`
- **表格类型**：`confidence = min(table_score + 0.2, 0.9)`
- **文本类型**：`confidence = min(text_score + 0.1, 0.8)`
- **混合类型**：`confidence = min(max(image_score, table_score), 0.8)`

#### 2.2.3 类型判断逻辑
```python
if image_score > 0.3 and table_score > 0.3:
    return 'hybrid', min(max(image_score, table_score), 0.8)
elif image_score > 0.3:
    return 'image', confidence
elif table_score > 0.1:
    return 'table', confidence
elif text_score > 0.4:
    return 'text', confidence
else:
    return 'text', 0.5  # 默认文本类型
```

### 2.3 处理策略选择阶段

#### 2.3.1 高置信度处理（confidence >= 0.7）
- **策略**：使用单类型处理
- **调用**：`_process_single_type(query, detected_type, options)`
- **优势**：针对性强，处理效率高

#### 2.3.2 低置信度处理（confidence < 0.7）
- **策略**：回退到混合查询
- **调用**：`_process_hybrid_query(query, options)`
- **优势**：覆盖面广，确保不遗漏相关内容

### 2.4 单类型查询处理流程

#### 2.4.1 内容检索
**位置**：`SimpleSmartProcessor.process_single_type_query()`

```python
# 调用统一检索服务
retrieval_results = await self.unified_services.retrieve(query, content_types, {
    'max_results': options.max_results,
    'relevance_threshold': options.relevance_threshold
})
```

#### 2.4.2 检索策略
- **文本检索**：`RetrievalEngine.retrieve_texts()` → 3层策略搜索
- **图片检索**：`RetrievalEngine.retrieve_images()` → 4层策略搜索
- **表格检索**：`RetrievalEngine.retrieve_tables()` → 4层策略搜索

#### 2.4.3 重排序处理
```python
# 调用重排序服务
reranked_results = await self.unified_services.rerank(query, retrieval_results)
```

#### 2.4.4 LLM问答生成
```python
# 调用LLM服务
answer = await self.unified_services.generate_answer(query, reranked_results)
```

#### 2.4.5 子表合并（表格类型）
```python
if content_type == 'table' and self.config.get('rag_system.table_merge.enabled', True):
    merged_results = vector_db.format_search_results_with_merge(reranked_results)
    reranked_results = merged_results
```

### 2.5 混合查询处理流程

#### 2.5.1 并行检索
**位置**：`SimpleSmartProcessor._process_hybrid_query()`

```python
# 并行检索所有类型
retrieval_results = await self.unified_services.retrieve(query, None, {
    'max_results': options.max_results,
    'relevance_threshold': options.relevance_threshold
})
```

#### 2.5.2 结果融合
- **智能融合**：按内容类型分组，计算最优结果数量
- **去重处理**：基于内容相似性去重
- **权重排序**：基于融合权重和分数排序

#### 2.5.3 后续处理
- **重排序**：使用 `MultiModelReranker` 重新排序
- **LLM问答**：生成综合答案
- **子表合并**：处理表格子表合并

## 3. 统一服务接口详解

### 3.1 检索服务
**位置**：`UnifiedServices.retrieve()`

```python
async def retrieve(self, query: str, content_types: List[str] = None, 
                  options: Dict[str, Any] = None) -> List[Dict[str, Any]]:
    # 根据内容类型进行检索
    if 'text' in content_types:
        text_results = self.retrieval_service.retrieve_texts(query, max_results, relevance_threshold)
        all_results.extend(text_results)
    
    if 'image' in content_types:
        image_results = self.retrieval_service.retrieve_images(query, max_results, relevance_threshold)
        all_results.extend(image_results)
    
    if 'table' in content_types:
        table_results = self.retrieval_service.retrieve_tables(query, max_results, relevance_threshold)
        all_results.extend(table_results)
```

### 3.2 重排序服务
**位置**：`UnifiedServices.rerank()`

```python
async def rerank(self, query: str, results: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    # 调用多模型重排序器
    reranked_results = await self.reranking_service.rerank(query, results)
    return reranked_results
```

### 3.3 LLM问答服务
**位置**：`UnifiedServices.generate_answer()`

```python
async def generate_answer(self, query: str, results: List[Dict[str, Any]]) -> str:
    # 调用LLM服务生成答案
    answer = await self.llm_service.generate_answer(query, results)
    return answer
```

## 4. 关键技术特点

### 4.1 智能类型检测
- **关键词匹配**：基于预定义关键词库进行类型检测
- **置信度计算**：量化检测结果的可靠性
- **阈值策略**：高置信度单类型处理，低置信度混合处理

### 4.2 多策略检索
- **文本检索**：3层策略（向量搜索、关键词搜索、扩展搜索）
- **图片检索**：4层策略（语义搜索、视觉搜索、关键词搜索、扩展搜索）
- **表格检索**：4层策略（语义搜索、结构化搜索、关键词搜索、扩展搜索）

### 4.3 智能融合机制
- **类型分组**：按内容类型分组处理
- **权重平衡**：根据配置权重分配结果数量
- **去重算法**：基于内容相似性的智能去重

### 4.4 错误处理机制
- **异常捕获**：分层异常处理，确保系统稳定性
- **降级策略**：检测失败时回退到混合查询
- **日志记录**：详细的处理日志和错误信息

## 5. 性能优化策略

### 5.1 并行处理
- **检索并行**：不同类型内容并行检索
- **服务并行**：检索、重排序、LLM生成可并行执行
- **异步处理**：全流程异步处理，提高响应速度

### 5.2 缓存机制
- **结果缓存**：相似查询结果缓存
- **模型缓存**：重排序模型缓存
- **配置缓存**：配置信息缓存

### 5.3 资源管理
- **内存优化**：及时释放不需要的中间结果
- **连接池**：数据库和API连接池管理
- **限流控制**：API调用频率限制

## 6. 配置管理

### 6.1 查询选项配置
```python
QueryOptions(
    max_results=10,                    # 最大结果数量
    relevance_threshold=0.5,           # 相似度阈值
    context_length_limit=4000,         # 上下文长度限制
    enable_streaming=True              # 是否启用流式输出
)
```

### 6.2 类型检测配置
- **图片关键词**：可配置的图片相关关键词库
- **表格关键词**：可配置的表格相关关键词库
- **置信度阈值**：可调整的置信度判断阈值

### 6.3 服务配置
- **检索配置**：各类型检索的参数配置
- **重排序配置**：重排序模型的配置
- **LLM配置**：LLM服务的配置参数

## 7. 监控和统计

### 7.1 处理元数据
```python
result.processing_metadata = {
    'processing_time': processing_time,        # 处理时间
    'detection_confidence': confidence,        # 检测置信度
    'detected_type': detected_type,            # 检测类型
    'processing_strategy': 'smart_query',      # 处理策略
    'results_count': len(reranked_results),    # 结果数量
    'content_type': content_type               # 内容类型
}
```

### 7.2 服务状态监控
- **处理器状态**：各处理器的运行状态
- **服务可用性**：各服务的可用性检查
- **性能指标**：处理时间、成功率等指标

## 8. 总结

智能查询系统具有以下核心优势：

1. **智能类型检测**：基于关键词和置信度的智能类型检测
2. **自适应处理**：根据置信度自动选择单类型或混合处理策略
3. **多策略检索**：针对不同内容类型的多策略检索机制
4. **统一服务接口**：标准化的服务调用接口
5. **智能融合**：多类型结果的智能融合和去重
6. **完善错误处理**：分层异常处理和降级策略
7. **高性能设计**：并行处理和异步执行
8. **灵活配置**：可配置的检测规则和处理参数

这个智能查询机制能够根据用户查询的语义特征自动选择最合适的处理策略，在保证准确性的同时提供高效的查询体验。
