# RAG系统API接口文档

## 一、文档基础信息

| 模块名称 | M23-RAG系统API接口详细设计                                   | 所属项目 | V3版本RAG系统                     |
| -------- | ------------------------------------------------------------ | -------- | --------------------------------- |
| 文档版本 | V3.0                                                         | 文档状态 | ☑ 草稿 □ 评审中 □ 已确认 □ 已归档 |
| 编写人   | AI助手                                                       | 编写日期 | 2025年1月                         |
| 关联文档 | 《1.向量数据库机制详解.md》《2.RAG系统Prompt构建机制详解.md》《3.混合查询流程分析.md》《4.智能查询流程分析.md》《5.RAG系统重排序机制详解.md》《45.RAG系统前后端交互详细设计文档.md》 |          |                                   |

## 二、文档说明

本文档详细描述了V3版本RAG系统的API接口规范，包括智能问答、召回检索、重排序、LLM调用、溯源等核心功能的接口定义。RAG系统基于V3向量数据库构建，为用户提供智能的文档查询和问答服务。

## 三、API概述

### 1. 基础信息
- **系统名称**: V3版本RAG智能问答系统
- **API版本**: v3.0.0
- **数据格式**: JSON
- **认证方式**: 无需认证（开发环境）
- **字符编码**: UTF-8
- **基础URL**: `http://localhost:8000/api/v3/rag`

### 2. 设计原则
- **RESTful风格**: 遵循REST架构设计原则，基于FastAPI实现
- **数据验证**: 使用Pydantic模型进行请求/响应数据验证
- **统一响应格式**: 所有接口使用统一的响应结构
- **错误处理**: 完善的错误码和错误信息，基于axios拦截器
- **版本管理**: 支持API版本控制和向后兼容
- **类型安全**: TypeScript + Pydantic确保前后端类型安全

### 3. 系统架构
```
Vue 3.x前端 → Axios → FastAPI → 查询处理模块 → 召回引擎 → 重排序 → LLM调用 → 溯源 → 结果返回
                ↓
            Pydantic验证 → 统一响应格式 → 前端展示
```

## 四、通用规范

### 1. 请求格式
- **Content-Type**: `application/json`
- **字符编码**: UTF-8
- **请求方法**: GET, POST, PUT, DELETE

### 2. 响应格式

#### 成功响应
```json
{
    "success": true,
    "data": {...},
    "message": "操作成功",
    "timestamp": "2024-01-01T00:00:00Z",
    "request_id": "req_1234567890"
}
```

#### 错误响应
```json
{
    "success": false,
    "error": {
        "code": "ERROR_CODE",
        "message": "错误描述",
        "details": "详细错误信息",
        "suggestion": "解决建议"
    },
    "timestamp": "2024-01-01T00:00:00Z",
    "request_id": "req_1234567890"
}
```

### 3. 错误码规范

| 错误码             | HTTP状态码 | 说明           |
| ------------------ | ---------- | -------------- |
| INVALID_QUERY      | 400        | 查询参数错误   |
| QUERY_TOO_LONG     | 400        | 查询文本过长   |
| INVALID_QUERY_TYPE | 400        | 查询类型不支持 |
| UNAUTHORIZED       | 401        | 未授权访问     |
| FORBIDDEN          | 403        | 禁止访问       |
| QUERY_NOT_FOUND    | 404        | 查询任务未找到 |
| QUERY_TIMEOUT      | 408        | 查询超时       |
| INTERNAL_ERROR     | 500        | 服务器内部错误 |
| LLM_SERVICE_ERROR  | 503        | LLM服务不可用  |
| VECTOR_DB_ERROR    | 503        | 向量数据库错误 |

## 五、核心查询接口

### 1. 智能问答查询

#### 提交查询请求
- **接口**: `POST /api/v3/rag/query`
- **描述**: 提交智能问答查询，支持多种查询类型和展示模式
- **请求模型**（基于Pydantic）:
```python
class QueryRequest(BaseModel):
    query: str
    query_type: str = "auto"  # auto/smart/text/image/table/hybrid
    max_results: int = 10
    relevance_threshold: float = 0.5
    context_length_limit: int = 4000
    enable_streaming: bool = False
    options: Optional[Dict[str, Any]] = None
```

- **请求示例**:
```json
{
    "query": "中芯国际2025年一季度业绩如何？",
    "query_type": "smart",
    "display_mode": "auto",
    "options": {
        "max_results": 10,
        "enable_streaming": true,
        "reranking_enabled": true,
        "source_attribution": "reverse"
    }
}
```

**参数说明**:
- `query_text`: 查询文本，必填，最大长度5000字符
- `query_type`: 查询类型，支持 `text`、`image`、`table`、`smart`、`hybrid`
- `display_mode`: 展示模式，支持 `text_focused`、`image_focused`、`table_focused`、`hybrid_layout`、`auto`
- `options`: 查询选项
  - `max_results`: 最大返回结果数，默认10，最大50
  - `enable_streaming`: 是否启用流式响应，默认true
  - `reranking_enabled`: 是否启用重排序，默认true
  - `source_attribution`: 溯源模式，支持 `forward`、`reverse`，默认 `reverse`

**响应示例**:
```json
{
    "success": true,
    "data": {
        "query_id": "qry_1234567890",
        "status": "accepted",
        "query_info": {
            "query_text": "中芯国际2025年一季度业绩如何？",
            "query_type": "smart",
            "display_mode": "auto",
            "submitted_at": "2024-01-01T00:00:00Z"
        },
        "estimated_duration": "10-15秒",
        "streaming_url": "/api/v3/rag/stream/qry_1234567890"
    },
    "message": "查询已接受，开始处理",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

### 2. 流式查询响应

#### 获取流式查询结果
- **接口**: `GET /api/v3/rag/stream/{query_id}`
- **描述**: 通过Server-Sent Events获取查询的实时进度和结果
- **参数**: 
  - `query_id`: 查询任务ID
- **响应格式**: Server-Sent Events (SSE)
- **事件类型**:

**查询开始事件**:
```
event: query_start
data: {
    "query_id": "qry_1234567890",
    "status": "processing",
    "current_step": "召回检索",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

**召回完成事件**:
```
event: retrieval_complete
data: {
    "query_id": "qry_1234567890",
    "status": "retrieval_complete",
    "current_step": "重排序",
    "retrieval_results": {
        "text_chunks": 15,
        "image_chunks": 8,
        "table_chunks": 5,
        "total_chunks": 28
    },
    "timestamp": "2024-01-01T00:00:00Z"
}
```

**重排序完成事件**:
```
event: reranking_complete
data: {
    "query_id": "qry_1234567890",
    "status": "reranking_complete",
    "current_step": "LLM生成",
    "reranking_results": {
        "top_results": 10,
        "reranking_scores": [0.95, 0.92, 0.89, ...],
        "timestamp": "2024-01-01T00:00:00Z"
    }
}
```

**LLM生成事件**:
```
event: llm_generating
data: {
    "query_id": "qry_1234567890",
    "status": "llm_generating",
    "current_step": "LLM生成",
    "partial_answer": "根据查询结果，中芯国际2025年一季度业绩...",
    "progress": 65,
    "timestamp": "2024-01-01T00:00:00Z"
}
```

**查询完成事件**:
```
event: query_complete
data: {
    "query_id": "qry_1234567890",
    "status": "completed",
    "final_result": {
        "answer": "根据查询结果，中芯国际2025年一季度业绩表现如下：...",
        "sources": [...],
        "display_mode": "hybrid_layout",
        "processing_time": "12.5秒"
    },
    "timestamp": "2024-01-01T00:00:00Z"
}
```

### 3. 查询取消

#### 取消正在进行的查询
- **接口**: `POST /api/v3/rag/cancel/{query_id}`
- **描述**: 取消指定的查询任务，释放相关资源
- **参数**: 
  - `query_id`: 查询任务ID
- **响应示例**:
```json
{
    "success": true,
    "data": {
        "query_id": "qry_1234567890",
        "status": "cancelled",
        "cancellation_time": "2024-01-01T00:00:00Z",
        "resources_freed": true
    },
    "message": "查询已成功取消",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

## 六、查询结果接口

### 1. 获取查询结果

#### 获取完整查询结果
- **接口**: `GET /api/v3/rag/query/{query_id}/result`
- **描述**: 获取指定查询的完整结果，包括答案、溯源信息等
- **参数**: 
  - `query_id`: 查询任务ID
- **响应示例**:
```json
{
    "success": true,
    "data": {
        "query_id": "qry_1234567890",
        "status": "completed",
        "query_info": {
            "query_text": "中芯国际2025年一季度业绩如何？",
            "query_type": "smart",
            "display_mode": "hybrid_layout",
            "submitted_at": "2024-01-01T00:00:00Z",
            "completed_at": "2024-01-01T00:00:10Z"
        },
        "answer": {
            "content": "根据查询结果，中芯国际2025年一季度业绩表现如下：...",
            "confidence": 0.92,
            "generation_time": "8.5秒",
            "token_usage": {
                "input_tokens": 2500,
                "output_tokens": 800,
                "total_tokens": 3300
            }
        },
        "sources": [
            {
                "chunk_id": "text_1704067200_abc12345",
                "chunk_type": "text",
                "document_name": "【华泰证券】中芯国际（688981）：上调港股目标价到63港币，看好DeepSeek推动代工需求强劲增长",
                "page_number": 3,
                "content_preview": "中芯国际2025年一季度业绩...",
                "relevance_score": 0.95,
                "source_type": "pdf"
            },
            {
                "chunk_id": "table_1704067200_def67890",
                "chunk_type": "table",
                "document_name": "【国信证券】工业与汽车触底反弹，良率影响短期营收",
                "page_number": 8,
                "content_preview": "业绩数据表格...",
                "relevance_score": 0.89,
                "source_type": "pdf"
            }
        ],
        "display_config": {
            "selected_mode": "hybrid_layout",
            "reason": "查询包含文本和表格信息，自动选择混合布局",
            "layout_options": {
                "text_priority": 0.6,
                "table_priority": 0.3,
                "image_priority": 0.1
            }
        },
        "performance_metrics": {
            "total_processing_time": "12.5秒",
            "retrieval_time": "2.1秒",
            "reranking_time": "1.8秒",
            "llm_generation_time": "8.5秒",
            "source_attribution_time": "0.1秒"
        }
    },
    "message": "查询结果获取成功",
    "timestamp": "2024-01-01T00:00:10Z"
}
```

### 2. 获取查询状态

#### 查询查询处理状态
- **接口**: `GET /api/v3/rag/query/{query_id}/status`
- **描述**: 获取指定查询的当前处理状态和进度
- **参数**: 
  - `query_id`: 查询任务ID
- **响应示例**:
```json
{
    "success": true,
    "data": {
        "query_id": "qry_1234567890",
        "status": "processing",
        "current_step": "LLM生成",
        "progress": {
            "overall_progress": 75,
            "current_step_progress": 60,
            "steps_completed": 3,
            "total_steps": 4
        },
        "timing": {
            "start_time": "2024-01-01T00:00:00Z",
            "elapsed_time": "9.5秒",
            "estimated_remaining": "3.2秒"
        },
        "current_operation": {
            "operation": "llm_generation",
            "description": "正在使用Qwen LLM生成答案",
            "details": "已生成65%的答案内容"
        }
    },
    "message": "查询状态获取成功",
    "timestamp": "2024-01-01T00:00:09Z"
}
```

## 七、召回检索接口

### 1. 文本召回

#### 文本内容召回
- **接口**: `POST /api/v3/rag/retrieval/text`
- **描述**: 执行文本内容的召回检索
- **请求参数**:
```json
{
    "query_text": "中芯国际业绩",
    "max_results": 15,
    "similarity_threshold": 0.7,
    "options": {
        "enable_keyword_search": true,
        "enable_expansion_search": true,
        "filter_document": "中芯国际",
        "filter_page_range": [1, 10]
    }
}
```

**响应示例**:
```json
{
    "success": true,
    "data": {
        "retrieval_id": "ret_1234567890",
        "query_text": "中芯国际业绩",
        "retrieval_strategy": "three_layer",
        "results": [
            {
                "chunk_id": "text_1704067200_abc12345",
                "chunk_type": "text",
                "content": "中芯国际2025年一季度业绩表现...",
                "similarity_score": 0.95,
                "retrieval_layer": "vector_search",
                "metadata": {
                    "document_name": "华泰证券报告",
                    "page_number": 3,
                    "section": "业绩分析"
                }
            }
        ],
        "statistics": {
            "total_candidates": 45,
            "vector_search_results": 15,
            "keyword_search_results": 8,
            "expansion_search_results": 5,
            "final_results": 15,
            "processing_time": "1.2秒"
        }
    },
    "message": "文本召回完成",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

### 2. 图片召回

#### 图片内容召回
- **接口**: `POST /api/v3/rag/retrieval/image`
- **描述**: 执行图片内容的召回检索
- **请求参数**:
```json
{
    "query_text": "中芯国际业绩图表",
    "max_results": 20,
    "similarity_threshold": 0.3,
    "options": {
        "enable_visual_search": true,
        "enable_semantic_search": true,
        "enable_keyword_search": true,
        "filter_document": "中芯国际"
    }
}
```

**响应示例**:
```json
{
    "success": true,
    "data": {
        "retrieval_id": "ret_1234567890",
        "query_text": "中芯国际业绩图表",
        "retrieval_strategy": "four_layer",
        "results": [
            {
                "chunk_id": "image_1704067200_xyz78901",
                "chunk_type": "image",
                "enhanced_description": "中芯国际业绩增长趋势图表，显示2025年一季度营收和利润数据",
                "similarity_score": 0.88,
                "retrieval_layer": "semantic_search",
                "metadata": {
                    "document_name": "华泰证券报告",
                    "page_number": 5,
                    "image_caption": "业绩增长趋势",
                    "visual_features": "图表、数据、趋势线"
                }
            }
        ],
        "statistics": {
            "total_candidates": 32,
            "semantic_search_results": 12,
            "visual_search_results": 8,
            "keyword_search_results": 6,
            "expansion_search_results": 4,
            "final_results": 20,
            "processing_time": "1.8秒"
        }
    },
    "message": "图片召回完成",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

### 3. 表格召回

#### 表格内容召回
- **接口**: `POST /api/v3/rag/retrieval/table`
- **描述**: 执行表格内容的召回检索
- **请求参数**:
```json
{
    "query_text": "中芯国际财务数据",
    "max_results": 15,
    "similarity_threshold": 0.65,
    "options": {
        "enable_structure_search": true,
        "enable_semantic_search": true,
        "enable_keyword_search": true,
        "filter_document": "中芯国际"
    }
}
```

**响应示例**:
```json
{
    "success": true,
    "data": {
        "retrieval_id": "ret_1234567890",
        "query_text": "中芯国际财务数据",
        "retrieval_strategy": "four_layer",
        "results": [
            {
                "chunk_id": "table_1704067200_def67890",
                "chunk_type": "table",
                "table_structure": "财务数据表格",
                "table_content": "营收、利润、毛利率等财务指标",
                "similarity_score": 0.92,
                "retrieval_layer": "structure_search",
                "metadata": {
                    "document_name": "国信证券报告",
                    "page_number": 8,
                    "table_title": "财务数据汇总",
                    "row_count": 15,
                    "column_count": 8
                }
            }
        ],
        "statistics": {
            "total_candidates": 28,
            "structure_search_results": 10,
            "semantic_search_results": 8,
            "keyword_search_results": 6,
            "expansion_search_results": 4,
            "final_results": 15,
            "processing_time": "1.5秒"
        }
    },
    "message": "表格召回完成",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

## 八、重排序接口

### 1. 执行重排序

#### 对召回结果进行重排序
- **接口**: `POST /api/v3/rag/reranking/execute`
- **描述**: 使用reranking模型对召回结果进行智能重排序
- **请求参数**:
```json
{
    "query_text": "中芯国际业绩",
    "candidates": [
        {
            "chunk_id": "text_1704067200_abc12345",
            "chunk_type": "text",
            "content": "中芯国际2025年一季度业绩...",
            "similarity_score": 0.95
        }
    ],
    "options": {
        "reranking_model": "gte-rerank-v2",
        "batch_size": 32,
        "enable_quality_assessment": true
    }
}
```

**响应示例**:
```json
{
    "success": true,
    "data": {
        "reranking_id": "rer_1234567890",
        "query_text": "中芯国际业绩",
        "reranking_model": "gte-rerank-v2",
        "results": [
            {
                "chunk_id": "text_1704067200_abc12345",
                "chunk_type": "text",
                "original_score": 0.95,
                "reranking_score": 0.98,
                "rank_change": 0,
                "quality_metrics": {
                    "relevance": 0.98,
                    "completeness": 0.95,
                    "accuracy": 0.92
                }
            }
        ],
        "statistics": {
            "total_candidates": 15,
            "reranking_time": "1.8秒",
            "score_improvement": 0.15,
            "model_performance": "excellent"
        }
    },
    "message": "重排序完成",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

## 九、LLM调用接口

### 1. 生成答案

#### 使用LLM生成答案
- **接口**: `POST /api/v3/rag/llm/generate`
- **描述**: 使用大语言模型基于上下文生成答案
- **请求参数**:
```json
{
    "query_text": "中芯国际2025年一季度业绩如何？",
    "context": "基于以下上下文信息回答问题：\n\n上下文：中芯国际2025年一季度业绩表现...",
    "options": {
        "model_name": "qwen-turbo",
        "max_tokens": 2048,
        "temperature": 0.7,
        "system_prompt": "你是一个专业的AI助手...",
        "enable_streaming": true
    }
}
```

**响应示例**:
```json
{
    "success": true,
    "data": {
        "generation_id": "gen_1234567890",
        "query_text": "中芯国际2025年一季度业绩如何？",
        "generated_answer": "根据查询结果，中芯国际2025年一季度业绩表现如下：...",
        "model_info": {
            "model_name": "qwen-turbo",
            "model_version": "latest",
            "generation_time": "8.5秒"
        },
        "token_usage": {
            "input_tokens": 2500,
            "output_tokens": 800,
            "total_tokens": 3300
        },
        "quality_metrics": {
            "answer_relevance": 0.95,
            "answer_completeness": 0.92,
            "answer_accuracy": 0.89
        }
    },
    "message": "答案生成完成",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

## 十、溯源接口

### 1. 获取溯源信息

#### 获取答案的溯源信息
- **接口**: `POST /api/v3/rag/attribution/sources`
- **描述**: 基于LLM答案获取相关的溯源信息
- **请求参数**:
```json
{
    "query_text": "中芯国际2025年一季度业绩如何？",
    "llm_answer": "根据查询结果，中芯国际2025年一季度业绩表现如下：...",
    "attribution_mode": "reverse",
    "options": {
        "max_sources": 10,
        "relevance_threshold": 0.7,
        "enable_keyword_matching": true,
        "enable_semantic_matching": true
    }
}
```

**响应示例**:
```json
{
    "success": true,
    "data": {
        "attribution_id": "att_1234567890",
        "query_text": "中芯国际2025年一季度业绩如何？",
        "attribution_mode": "reverse",
        "sources": [
            {
                "chunk_id": "text_1704067200_abc12345",
                "chunk_type": "text",
                "document_name": "【华泰证券】中芯国际（688981）：上调港股目标价到63港币，看好DeepSeek推动代工需求强劲增长",
                "page_number": 3,
                "content_preview": "中芯国际2025年一季度业绩表现...",
                "relevance_score": 0.95,
                "attribution_reason": "包含具体的业绩数据和财务指标",
                "metadata": {
                    "source_type": "pdf",
                    "document_date": "2025-01-15",
                    "analyst": "华泰证券研究团队"
                }
            }
        ],
        "attribution_summary": {
            "total_sources": 8,
            "high_relevance_sources": 5,
            "medium_relevance_sources": 2,
            "low_relevance_sources": 1,
            "coverage_score": 0.92
        },
        "processing_time": "0.8秒"
    },
    "message": "溯源信息获取完成",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

## 十一、展示模式接口

### 1. 获取展示模式

#### 获取推荐的展示模式
- **接口**: `POST /api/v3/rag/display/recommend`
- **描述**: 基于查询内容和结果推荐最佳展示模式
- **请求参数**:
```json
{
    "query_text": "中芯国际业绩图表",
    "query_type": "hybrid",
    "retrieval_results": {
        "text_chunks": 8,
        "image_chunks": 12,
        "table_chunks": 5
    },
    "options": {
        "user_preference": "auto",
        "enable_ai_analysis": true
    }
}
```

**响应示例**:
```json
{
    "success": true,
    "data": {
        "recommendation_id": "rec_1234567890",
        "query_text": "中芯国际业绩图表",
        "recommended_mode": "hybrid_layout",
        "recommendation_reason": "查询包含多种内容类型，混合布局能提供最佳用户体验",
        "mode_analysis": {
            "text_focused_score": 0.65,
            "image_focused_score": 0.85,
            "table_focused_score": 0.72,
            "hybrid_layout_score": 0.92,
            "auto_detect_score": 0.88
        },
            "layout_config": {
            "text_priority": 0.3,
            "image_priority": 0.5,
            "table_priority": 0.2,
            "layout_type": "responsive_grid"
        }
    },
    "message": "展示模式推荐完成",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

## 十二、系统管理接口

### 1. 系统状态

#### 获取RAG系统状态
- **接口**: `GET /api/v3/rag/status`
- **描述**: 获取RAG系统的运行状态和组件状态
- **响应示例**:
```json
{
    "success": true,
    "data": {
        "system_status": "running",
        "version": "3.0.0",
        "components": {
            "query_processor": "ready",
            "retrieval_engine": "ready",
            "reranking_service": "ready",
            "llm_service": "ready",
            "attribution_service": "ready",
            "display_service": "ready"
        },
        "database_status": {
            "vector_store": "ready",
            "total_vectors": 1500,
            "total_documents": 25
        },
        "external_services": {
            "dashscope_api": "healthy",
            "reranking_model": "available",
            "llm_model": "available"
        },
        "performance_metrics": {
            "active_queries": 3,
            "avg_response_time": "8.5秒",
            "success_rate": 98.5
        }
    },
    "message": "系统状态查询成功",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

### 2. 性能监控

#### 获取性能指标
- **接口**: `GET /api/v3/rag/monitor/performance`
- **描述**: 获取RAG系统的性能监控数据
- **参数**: 
  - `time_range`: 时间范围（1h, 6h, 24h, 7d）
- **响应示例**:
```json
{
    "success": true,
    "data": {
        "time_range": "24h",
        "query_metrics": {
            "total_queries": 156,
            "successful_queries": 152,
            "failed_queries": 4,
            "avg_processing_time": "8.5秒",
            "avg_retrieval_time": "1.8秒",
            "avg_reranking_time": "1.2秒",
            "avg_llm_time": "5.5秒"
        },
        "retrieval_metrics": {
            "avg_recall_rate": 0.92,
            "avg_precision": 0.88,
            "avg_f1_score": 0.90
        },
        "llm_metrics": {
            "avg_answer_quality": 0.91,
            "avg_token_usage": 2800,
            "model_availability": 99.8
        },
        "system_metrics": {
            "cpu_usage": 45.2,
            "memory_usage": "3.2GB",
            "disk_usage": "45.8GB"
        }
    },
    "message": "性能指标获取成功",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

## 十三、使用示例

### 1. 完整查询流程示例

#### Python客户端示例
```python
import requests
import json
import sseclient

class RAGClient:
    def __init__(self, base_url="http://localhost:8000"):
        self.base_url = base_url
        self.session = requests.Session()
    
    def submit_query(self, query_text, query_type="smart", display_mode="auto"):
        """提交查询请求"""
        url = f"{self.base_url}/api/v3/rag/query"
        data = {
            "query_text": query_text,
            "query_type": query_type,
            "display_mode": display_mode,
            "options": {
                "max_results": 10,
                "enable_streaming": True,
                "reranking_enabled": True
            }
        }
        response = self.session.post(url, json=data)
        return response.json()
    
    def stream_results(self, query_id):
        """流式获取查询结果"""
        url = f"{self.base_url}/api/v3/rag/stream/{query_id}"
        response = self.session.get(url, stream=True)
        client = sseclient.SSEClient(response)
        
        for event in client.events():
            if event.event == "query_complete":
                return json.loads(event.data)
            print(f"事件: {event.event}, 数据: {event.data}")
    
    def get_final_result(self, query_id):
        """获取最终查询结果"""
        url = f"{self.base_url}/api/v3/rag/query/{query_id}/result"
        response = self.session.get(url)
        return response.json()

# 使用示例
client = RAGClient()

# 提交查询
result = client.submit_query("中芯国际2025年一季度业绩如何？")
query_id = result["data"]["query_id"]

# 流式获取结果
final_result = client.stream_results(query_id)
print(f"查询完成，答案: {final_result['final_result']['answer']['content']}")
```

#### JavaScript客户端示例
```javascript
class RAGClient {
    constructor(baseUrl = 'http://localhost:8000') {
        this.baseUrl = baseUrl;
    }
    
    async submitQuery(queryText, queryType = 'smart', displayMode = 'auto') {
        const response = await fetch(`${this.baseUrl}/api/v3/rag/query`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                query_text: queryText,
                query_type: queryType,
                display_mode: displayMode,
                options: {
                    max_results: 10,
                    enable_streaming: true,
                    reranking_enabled: true
                }
            })
        });
        return await response.json();
    }
    
    async streamResults(queryId, onEvent) {
        const response = await fetch(`${this.baseUrl}/api/v3/rag/stream/${queryId}`);
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    const data = JSON.parse(line.slice(6));
                    onEvent(data);
                    
                    if (data.status === 'completed') {
                        return data;
                    }
                }
            }
        }
    }
}

// 使用示例
const client = new RAGClient();

async function performQuery() {
    // 提交查询
    const result = await client.submitQuery('中芯国际2025年一季度业绩如何？');
    const queryId = result.data.query_id;
    
    // 流式获取结果
    const finalResult = await client.streamResults(queryId, (event) => {
        console.log(`事件: ${event.current_step}, 进度: ${event.progress?.overall_progress}%`);
    });
    
    console.log('查询完成:', finalResult.final_result.answer.content);
}

performQuery();
```

### 2. 错误处理示例

```python
def handle_query_error(error_response):
    """处理查询错误"""
    error_code = error_response.get('error', {}).get('code')
    error_message = error_response.get('error', {}).get('message')
    
    if error_code == 'QUERY_TOO_LONG':
        print(f"查询文本过长: {error_message}")
        print("建议: 缩短查询文本，控制在5000字符以内")
    elif error_code == 'LLM_SERVICE_ERROR':
        print(f"LLM服务错误: {error_message}")
        print("建议: 稍后重试，或检查网络连接")
    elif error_code == 'VECTOR_DB_ERROR':
        print(f"向量数据库错误: {error_message}")
        print("建议: 检查数据库状态，或联系管理员")
    else:
        print(f"未知错误: {error_message}")
        print("建议: 查看错误详情，或联系技术支持")
```

## 十四、部署和配置

### 1. 环境要求
- Python 3.8+
- FastAPI 0.100+
- 足够的磁盘空间用于向量存储
- 稳定的网络连接用于AI模型调用
- 支持SSE的现代浏览器

### 2. 配置说明
主要配置项在 `v3_config.json` 文件的 `rag_system` 节点中：

```json
{
    "rag_system": {
        "enabled": true,
        "version": "3.0.0",
        "models": {
            "llm": {
                "model_name": "qwen-turbo",
                "max_tokens": 2048,
                "temperature": 0.7
            },
            "reranking": {
                "model_name": "gte-rerank-v2",
                "batch_size": 32,
                "similarity_threshold": 0.7
            }
        },
        "query_processing": {
            "max_context_length": 4000,
            "max_results": 10,
            "relevance_threshold": 0.5
        }
    }
}
```

### 3. 启动命令
```bash
# 启动RAG系统
python v3/main.py --mode rag

# 启动Web API服务
uvicorn v3.api.main:app --host 0.0.0.0 --port 8000 --reload
```

## 十五、版本更新

### 1. 版本历史
- **v3.0.0**: 初始版本，支持基础RAG查询功能
- **v3.1.0**: 计划添加高级查询功能和性能优化
- **v3.2.0**: 计划添加多模态查询和高级展示模式

### 2. 向后兼容性
RAG系统API设计考虑了向后兼容性，新版本会保持核心接口的稳定性，同时通过版本号控制新功能的引入。

## 十六、联系和支持

### 1. 技术支持
- **文档**: 查看项目README和设计文档
- **问题反馈**: 通过GitHub Issues提交问题
- **功能建议**: 通过GitHub Discussions讨论新功能

### 2. 贡献指南
欢迎贡献代码和文档，请遵循项目的编码规范和贡献流程。

---

**文档版本**: v3.0.0  
**最后更新**: 2025年8月  
**维护者**: V3 RAG开发团队

这个RAG系统API接口文档充分体现了"接口清晰"和"功能完整"的设计理念，通过详细的接口定义、完整的参数说明、丰富的响应示例和实用的使用示例，为前端开发者和系统集成者提供了清晰的API使用指南，确保RAG系统能够被正确、高效地使用。