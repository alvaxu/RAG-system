# RAG系统Prompt构建机制详解

## 文档说明

本文档详细描述了RAG系统V3中三种类型内容（文本、图片、表格）在reranking后如何构建Prompt并给LLM提供内容的完整机制。

**版本**: V3.0.0  
**更新时间**: 2025年1月  
**基于代码**: `rag_system/core/` 模块实际实现  

---

## 一、整体架构概述

### 1.1 处理流程

```
用户查询 → 多类型召回 → Reranking → 上下文构建 → Prompt生成 → LLM调用
```

### 1.2 核心组件

- **VectorDBIntegration**: 负责内容提取和格式化
- **ContextManager**: 负责上下文优化和重组
- **PromptManager**: 负责Prompt模板管理
- **LLMCaller**: 负责LLM调用和响应处理

---

## 二、三种类型内容处理机制

### 2.1 文本内容处理

#### **内容提取策略**
**位置**: `rag_system/core/vector_db_integration.py` 第200-201行

```python
elif chunk_type == 'text' and 'text' in result.metadata:
    content = result.metadata['text']
```

**提取字段**:
- 主要字段: `metadata['text']` - 原始文本内容
- 备用字段: `page_content` - 页面内容

#### **内容特点**
- **格式**: 原始文本，保持段落结构
- **用途**: 直接用于LLM理解
- **优势**: 信息完整，语义清晰

#### **实际示例**
```
文本信息：
中芯国际是中国大陆规模最大、技术最先进的集成电路晶圆代工企业，也是中国内地技术最先进、配套最完善、规模最大、跨国经营的集成电路制造企业集团。
```

### 2.2 图片内容处理

#### **内容提取策略**
**位置**: `rag_system/core/vector_db_integration.py` 第198-199行

```python
if chunk_type == 'image' and 'enhanced_description' in result.metadata:
    content = result.metadata['enhanced_description']
```

**提取字段**:
- 主要字段: `metadata['enhanced_description']` - AI增强描述
- 备用字段: `metadata['description']` - 原始描述

#### **内容特点**
- **格式**: AI生成的文本描述
- **用途**: 将图片转换为文本描述给LLM
- **优势**: 包含图片的语义信息

#### **实际示例**
```
图片信息：
- 财务趋势图表显示收入稳步增长
- 资产负债表结构图
```

### 2.3 表格内容处理（增强版）

#### **内容提取策略**
**位置**: `rag_system/core/vector_db_integration.py` 第202-204行

```python
elif chunk_type == 'table':
    # 构建增强的表格信息
    content = self._build_enhanced_table_info(result.metadata)
```

#### **增强表格信息构建**
**位置**: `rag_system/core/vector_db_integration.py` 第779-834行

```python
def _build_enhanced_table_info(self, metadata: Dict[str, Any]) -> str:
    """构建增强的表格信息"""
    table_parts = []
    
    # 1. 表格标题和说明
    table_caption = metadata.get('table_caption', [])
    if table_caption:
        table_parts.append(f"**表格标题**: {', '.join(table_caption)}")
    
    # 2. 表格结构信息
    table_summary = metadata.get('table_summary', '')
    if table_summary:
        table_parts.append(f"**表格结构**: {table_summary}")
    
    # 3. 表格内容（优先使用HTML格式）
    table_body = metadata.get('table_body', '')
    table_content = metadata.get('table_content', '')
    
    if table_body:
        table_parts.append(f"**表格内容**:\n{table_body}")
    elif table_content:
        table_parts.append(f"**表格内容**:\n{table_content}")
    
    # 4. 表格脚注
    table_footnote = metadata.get('table_footnote', [])
    if table_footnote:
        table_parts.append(f"**数据来源**: {', '.join(table_footnote)}")
    
    # 5. 表格上下文
    table_context = metadata.get('table_context', '')
    if table_context:
        table_parts.append(f"**表格上下文**: {table_context}")
    
    # 6. 子表信息（如果有）
    is_subtable = metadata.get('is_subtable', False)
    if is_subtable:
        parent_table_id = metadata.get('parent_table_id', '')
        subtable_index = metadata.get('subtable_index', '')
        table_parts.append(f"**子表信息**: 这是第{subtable_index}个子表，父表ID: {parent_table_id}")
    
    return "\n\n".join(table_parts)
```

#### **内容特点**
- **格式**: Markdown格式的增强描述，包含HTML表格
- **用途**: 提供完整的表格信息给LLM
- **优势**: 信息丰富，结构化清晰

#### **实际示例**
```
表格数据：

**表格标题**: 表6：中芯国际产线一览

**表格结构**: 表格包含 2 行 8 列数据

**表格内容**:
<table><tbody><tr><td>9</td><td></td><td>中芯南方</td><td>FAB</td><td>上海</td><td>13.5</td><td>注册资本65亿美元</td><td>14nmFinFET</td></tr><tr><td>10</td><td></td><td>中芯东方</td><td></td><td></td><td>10</td><td>在建</td><td>65nm-24nm</td></tr></tbody></table>

**数据来源**: 资料来源：青岛西海岸新区国际招商，上海证券研究所

**子表信息**: 这是第1个子表，父表ID: test_table_118
```

---

## 三、上下文构建机制

### 3.1 上下文管理器
**位置**: `rag_system/core/context_manager.py` 第200-242行

#### **按类型分组处理**
```python
def _reorganize_context(self, selected_chunks: List[ContextChunk], query: str) -> str:
    # 按内容类型分组
    type_groups = defaultdict(list)
    for chunk in selected_chunks:
        type_groups[chunk.content_type].append(chunk)
    
    # 构建格式化的上下文
    context_parts = []
    
    # 添加文本内容
    if 'text' in type_groups:
        text_chunks = type_groups['text']
        text_content = "\n\n".join([chunk.content for chunk in text_chunks])
        context_parts.append(f"文本信息：\n{text_content}")
    
    # 添加表格内容
    if 'table' in type_groups:
        table_chunks = type_groups['table']
        table_content = "\n\n".join([chunk.content for chunk in table_chunks])
        context_parts.append(f"表格数据：\n\n{table_content}")
    
    # 添加图片内容
    if 'image' in type_groups:
        image_chunks = type_groups['image']
        image_descriptions = []
        for chunk in image_chunks:
            desc = chunk.metadata.get('description', chunk.content)
            image_descriptions.append(f"- {desc}")
        context_parts.append(f"图片信息：\n" + "\n".join(image_descriptions))
    
    # 组合所有内容
    final_context = "\n\n".join(context_parts)
    
    # 添加上下文来源信息
    sources = list(set(chunk.source for chunk in selected_chunks))
    if sources:
        final_context += f"\n\n信息来源：{', '.join(sources)}"
    
    return final_context
```

### 3.2 长度控制机制
**位置**: `rag_system/core/context_manager.py` 第244-272行

#### **配置参数**
- **最大上下文长度**: 4000字符（可配置）
- **最大块数量**: 10个（可配置）
- **相关性阈值**: 0.7（可配置）

#### **智能截断策略**
```python
def _ensure_length_limit(self, context: str, max_length: int) -> str:
    if len(context) <= max_length:
        return context
    
    # 智能截断
    truncated_context = self._smart_truncate(context, max_length)
    
    if truncated_context:
        self.context_stats['truncation_count'] += 1
        logger.info(f"上下文已截断，从 {len(context)} 到 {len(truncated_context)} 字符")
        return truncated_context
    else:
        # 如果智能截断失败，使用简单截断
        simple_truncated = context[:max_length-100] + "..."
        self.context_stats['truncation_count'] += 1
        logger.warning("智能截断失败，使用简单截断")
        return simple_truncated
```

---

## 四、Prompt构建机制

### 4.1 统一Prompt模板
**位置**: `rag_system/core/unified_services.py` 第225-257行

```python
def _build_unified_prompt(self, query: str, context: str) -> str:
    """构建统一Prompt"""
    try:
        # 获取系统提示词
        system_prompt = self.config.get_rag_config('models.llm.system_prompt', 
            '你是一个专业的AI助手，能够基于提供的上下文信息生成准确、相关、完整的答案。')
        
        # 构建完整的提示词
        prompt = f"""
{system_prompt}

基于以下上下文信息回答问题：

上下文：
{context}

问题：
{query}

请提供准确、详细的答案：
"""
        return prompt.strip()
        
    except Exception as e:
        logger.error(f"构建统一Prompt失败: {e}")
        # 返回简单的提示词
        return f"基于以下上下文信息回答问题：\n\n上下文：{context}\n\n问题：{query}"
```

### 4.2 实际发送给LLM的完整Prompt示例

```
你是一个专业的AI助手，能够基于提供的上下文信息生成准确、相关、完整的答案。

基于以下上下文信息回答问题：

上下文：
文本信息：
中芯国际是中国大陆规模最大、技术最先进的集成电路晶圆代工企业，也是中国内地技术最先进、配套最完善、规模最大、跨国经营的集成电路制造企业集团。

表格数据：

**表格标题**: 表6：中芯国际产线一览

**表格结构**: 表格包含 2 行 8 列数据

**表格内容**:
<table><tbody><tr><td>9</td><td></td><td>中芯南方</td><td>FAB</td><td>上海</td><td>13.5</td><td>注册资本65亿美元</td><td>14nmFinFET</td></tr><tr><td>10</td><td></td><td>中芯东方</td><td></td><td></td><td>10</td><td>在建</td><td>65nm-24nm</td></tr></tbody></table>

**数据来源**: 资料来源：青岛西海岸新区国际招商，上海证券研究所

图片信息：
- 财务趋势图表显示收入稳步增长
- 资产负债表结构图

信息来源：中芯国际研究报告.pdf, 财务分析报告.pdf

问题：
中芯国际的产线布局情况如何？

请提供准确、详细的答案：
```

---

## 五、技术特点与优势

### 5.1 多模态统一处理
- **文本**: 直接使用原始内容
- **图片**: 转换为AI增强描述
- **表格**: 构建增强的结构化信息

### 5.2 信息完整性
- **表格增强**: 包含标题、结构、内容、来源、上下文等完整信息
- **HTML格式**: 保留表格的结构化信息，便于LLM理解
- **层次清晰**: 使用Markdown格式，信息层次分明

### 5.3 智能优化
- **长度控制**: 智能截断，优先保留最相关内容
- **类型分离**: 不同类型内容分别处理，避免混淆
- **向后兼容**: 字段缺失时仍能正常工作

### 5.4 性能优化
- **缓存机制**: 重排序结果缓存
- **批量处理**: 支持批量上下文优化
- **错误处理**: 完善的异常处理和回退机制

---

## 六、配置参数

### 6.1 上下文管理配置
```json
{
  "rag_system": {
    "query_processing": {
      "max_context_length": 4000,
      "max_chunks": 10,
      "relevance_threshold": 0.7
    }
  }
}
```

### 6.2 LLM配置
```json
{
  "rag_system": {
    "models": {
      "llm": {
        "model_name": "qwen-turbo-latest",
        "max_tokens": 2048,
        "temperature": 0.7,
        "system_prompt": "你是一个专业的AI助手，能够基于提供的上下文信息生成准确、相关、完整的答案。"
      }
    }
  }
}
```

---

## 七、实际应用效果

### 7.1 信息丰富度提升
- **表格信息**: 从简单纯文本提升为包含标题、结构、来源等完整信息
- **图片信息**: 从无到有，提供AI增强描述
- **文本信息**: 保持原有完整性

### 7.2 LLM理解能力提升
- **结构化信息**: HTML表格提供清晰的列行关系
- **上下文信息**: 数据来源、表格说明等提供额外上下文
- **语义信息**: 图片描述提供视觉内容的语义理解

### 7.3 答案质量提升
- **准确性**: 更完整的信息支持更准确的答案
- **相关性**: 智能截断确保最相关内容优先
- **完整性**: 多模态信息支持更全面的回答

---

## 八、总结

RAG系统V3的Prompt构建机制通过以下关键设计实现了高效的多模态内容处理：

1. **分层处理**: 内容提取 → 上下文构建 → Prompt生成
2. **类型特化**: 针对文本、图片、表格的不同特点采用不同处理策略
3. **信息增强**: 特别是表格内容，从简单文本提升为结构化增强信息
4. **智能优化**: 长度控制、相关性排序、错误处理等机制
5. **统一接口**: 最终统一为文本格式给LLM，保持接口一致性

这种设计既保证了信息的完整性和准确性，又充分利用了LLM对不同格式内容的理解能力，为高质量的问答体验提供了坚实的技术基础。
