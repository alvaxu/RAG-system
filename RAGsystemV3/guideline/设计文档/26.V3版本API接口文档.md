# V3版本RAG系统API接口文档

## 文档说明

本文档详细描述了V3版本RAG系统的API接口规范，包括系统管理、文档处理、向量化、查询等核心功能的接口定义。V3版本专注于向量数据库构建，为后续的RAG查询系统提供数据基础。

## 1. API概述

### 1.1 基础信息
- **系统名称**: V3版本向量数据库构建系统
- **API版本**: v3.0.0
- **数据格式**: JSON
- **认证方式**: 无需认证（开发环境）
- **字符编码**: UTF-8

### 1.2 设计原则
- **RESTful风格**: 遵循REST架构设计原则
- **统一响应格式**: 所有接口使用统一的响应结构
- **错误处理**: 完善的错误码和错误信息
- **版本管理**: 支持API版本控制和向后兼容

### 1.3 系统架构
```
用户请求 → API网关 → 业务逻辑层 → 核心模块 → 数据存储层
                ↓
            响应处理 → 统一格式 → 用户
```

## 2. 通用规范

### 2.1 请求格式
- **Content-Type**: `application/json`
- **字符编码**: UTF-8
- **请求方法**: GET, POST, PUT, DELETE

### 2.2 响应格式

#### 成功响应
```json
{
    "success": true,
    "data": {...},
    "message": "操作成功",
    "timestamp": "2024-01-01T00:00:00Z",
    "request_id": "req_1234567890"
}
```

#### 错误响应
```json
{
    "success": false,
    "error": {
        "code": "ERROR_CODE",
        "message": "错误描述",
        "details": "详细错误信息"
    },
    "timestamp": "2024-01-01T00:00:00Z",
    "request_id": "req_1234567890"
}
```

### 2.3 错误码规范

| 错误码 | HTTP状态码 | 说明 |
|--------|------------|------|
| INVALID_PARAMETER | 400 | 参数错误 |
| UNAUTHORIZED | 401 | 未授权 |
| FORBIDDEN | 403 | 禁止访问 |
| NOT_FOUND | 404 | 资源未找到 |
| INTERNAL_ERROR | 500 | 服务器内部错误 |
| SERVICE_UNAVAILABLE | 503 | 服务不可用 |

## 3. 系统管理接口

### 3.1 系统状态查询

#### 获取系统状态
- **接口**: `GET /api/v3/status`
- **描述**: 获取系统整体运行状态和模块状态
- **参数**: 无
- **响应示例**:
```json
{
    "success": true,
    "data": {
        "system_status": "running",
        "version": "3.0.0",
        "initialization_time": "2024-01-01T00:00:00Z",
        "modules": {
            "config_manager": "ready",
            "document_type_detector": "ready",
            "content_processor": "ready",
            "vectorization_manager": "ready",
            "metadata_manager": "ready",
            "vector_store_manager": "ready"
        },
        "database_status": {
            "vector_store": "ready",
            "total_vectors": 1500,
            "total_documents": 25
        }
    },
    "message": "系统状态查询成功",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

### 3.2 健康检查

#### 系统健康检查
- **接口**: `GET /api/v3/health`
- **描述**: 检查系统健康状态
- **参数**: 无
- **响应示例**:
```json
{
    "success": true,
    "data": {
        "status": "healthy",
        "checks": {
            "database": "healthy",
            "ai_models": "healthy",
            "file_system": "healthy",
            "memory": "healthy"
        },
        "uptime": "2h 30m 15s"
    },
    "message": "系统健康检查通过",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

### 3.3 配置管理

#### 获取系统配置
- **接口**: `GET /api/v3/config`
- **描述**: 获取系统配置信息（敏感信息已脱敏）
- **参数**: 
  - `config_key` (可选): 特定配置项键名
- **响应示例**:
```json
{
    "success": true,
    "data": {
        "config": {
            "system": {
                "version": "3.0.0",
                "environment": "development",
                "log_level": "INFO"
            },
            "ai_models": {
                "text_embedding": "text-embedding-v1",
                "image_embedding": "multimodal-embedding-one-peace-v1",
                "image_enhancement": "qwen-vl-plus"
            },
            "processing": {
                "chunk_size": 1000,
                "overlap_size": 200,
                "batch_size": 50
            }
        }
    },
    "message": "配置信息获取成功",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

## 4. 文档处理接口

### 4.1 文档处理

#### 处理文档
- **接口**: `POST /api/v3/process`
- **描述**: 处理PDF文档或MinerU输出，构建向量数据库
- **请求参数**:
```json
{
    "input_type": "pdf",
    "input_path": "./documents/sample.pdf",
    "output_path": "./output",
    "processing_mode": "new",
    "options": {
        "enable_image_enhancement": true,
        "enable_table_extraction": true,
        "chunk_size": 1000,
        "overlap_size": 200
    }
}
```

**参数说明**:
- `input_type`: 输入类型，支持 `pdf` 或 `mineru_output`
- `input_path`: 输入文件路径
- `output_path`: 输出目录路径
- `processing_mode`: 处理模式，`new`（新建）或 `incremental`（增量）
- `options`: 可选配置项

**响应示例**:
```json
{
    "success": true,
    "data": {
        "process_id": "proc_1234567890",
        "status": "processing",
        "input_info": {
            "input_type": "pdf",
            "input_path": "./documents/sample.pdf",
            "file_size": "2.5MB",
            "pages": 15
        },
        "processing_info": {
            "mode": "new",
            "start_time": "2024-01-01T00:00:00Z",
            "estimated_duration": "5-10分钟"
        },
        "progress": {
            "current_step": "文档解析",
            "progress_percentage": 15,
            "steps_completed": 1,
            "total_steps": 7
        }
    },
    "message": "文档处理任务已启动",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

### 4.2 处理进度查询

#### 查询处理进度
- **接口**: `GET /api/v3/process/{process_id}/progress`
- **描述**: 查询指定处理任务的进度
- **参数**: 
  - `process_id`: 处理任务ID
- **响应示例**:
```json
{
    "success": true,
    "data": {
        "process_id": "proc_1234567890",
        "status": "processing",
        "progress": {
            "current_step": "向量化处理",
            "progress_percentage": 65,
            "steps_completed": 4,
            "total_steps": 7,
            "current_step_progress": 80
        },
        "timing": {
            "start_time": "2024-01-01T00:00:00Z",
            "elapsed_time": "3m 25s",
            "estimated_remaining": "2m 15s"
        },
        "statistics": {
            "documents_processed": 3,
            "images_processed": 12,
            "tables_processed": 5,
            "vectors_generated": 150
        }
    },
    "message": "进度查询成功",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

### 4.3 处理结果查询

#### 查询处理结果
- **接口**: `GET /api/v3/process/{process_id}/result`
- **描述**: 查询指定处理任务的最终结果
- **参数**: 
  - `process_id`: 处理任务ID
- **响应示例**:
```json
{
    "success": true,
    "data": {
        "process_id": "proc_1234567890",
        "status": "completed",
        "completion_time": "2024-01-01T00:10:00Z",
        "total_processing_time": "10m 15s",
        "result_summary": {
            "total_documents": 3,
            "total_pages": 15,
            "total_images": 12,
            "total_tables": 5,
            "total_text_chunks": 45,
            "total_vectors": 150
        },
        "quality_metrics": {
            "vector_quality_score": 0.92,
            "metadata_completeness": 0.95,
            "processing_success_rate": 0.98
        },
        "output_files": {
            "vector_store": "./output/vector_store.faiss",
            "metadata_db": "./output/metadata.json",
            "processing_log": "./output/processing.log"
        }
    },
    "message": "处理结果查询成功",
    "timestamp": "2024-01-01T00:10:00Z"
}
```

## 5. 向量化管理接口

### 5.1 内容向量化

#### 向量化内容
- **接口**: `POST /api/v3/vectorize`
- **描述**: 对指定内容进行向量化处理
- **请求参数**:
```json
{
    "content_type": "text",
    "content_items": [
        {
            "id": "text_001",
            "content": "这是要向量化的文本内容",
            "metadata": {
                "source": "document_1",
                "page": 1,
                "section": "introduction"
            }
        }
    ],
    "options": {
        "embedding_model": "text-embedding-v1",
        "batch_size": 10,
        "enable_quality_assessment": true
    }
}
```

**参数说明**:
- `content_type`: 内容类型，支持 `text`、`image`、`table`
- `content_items`: 内容项列表
- `options`: 向量化选项

**响应示例**:
```json
{
    "success": true,
    "data": {
        "vectorization_id": "vec_1234567890",
        "status": "completed",
        "results": [
            {
                "id": "text_001",
                "vector": [0.1, 0.2, 0.3, ...],
                "vector_dimension": 1536,
                "quality_score": 0.95,
                "processing_time": "150ms"
            }
        ],
        "statistics": {
            "total_items": 1,
            "successful_items": 1,
            "failed_items": 0,
            "average_quality_score": 0.95,
            "total_processing_time": "150ms"
        }
    },
    "message": "向量化处理完成",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

### 5.2 批量向量化

#### 批量向量化内容
- **接口**: `POST /api/v3/vectorize/batch`
- **描述**: 批量处理多个内容项的向量化
- **请求参数**:
```json
{
    "content_type": "mixed",
    "content_items": [
        {
            "type": "text",
            "id": "text_001",
            "content": "文本内容1"
        },
        {
            "type": "image",
            "id": "image_001",
            "content": "base64_encoded_image_data"
        }
    ],
    "options": {
        "parallel_processing": true,
        "max_workers": 4,
        "enable_quality_assessment": true
    }
}
```

**响应示例**:
```json
{
    "success": true,
    "data": {
        "batch_id": "batch_1234567890",
        "status": "completed",
        "results": {
            "text": [
                {
                    "id": "text_001",
                    "vector": [0.1, 0.2, 0.3, ...],
                    "quality_score": 0.95
                }
            ],
            "image": [
                {
                    "id": "image_001",
                    "visual_vector": [0.4, 0.5, 0.6, ...],
                    "semantic_vector": [0.7, 0.8, 0.9, ...],
                    "quality_score": 0.92
                }
            ]
        },
        "statistics": {
            "total_items": 2,
            "successful_items": 2,
            "failed_items": 0,
            "processing_time": "2.5s"
        }
    },
    "message": "批量向量化完成",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

## 6. 元数据管理接口

### 6.1 元数据生成

#### 生成内容元数据
- **接口**: `POST /api/v3/metadata/generate`
- **描述**: 为指定内容生成标准化元数据
- **请求参数**:
```json
{
    "content_type": "image",
    "content_data": {
        "image_path": "./images/sample.jpg",
        "image_caption": ["图片标题"],
        "image_footnote": ["图片说明"],
        "source_document": "document_1",
        "page_number": 5
    },
    "options": {
        "enhancement_enabled": true,
        "enhancement_model": "qwen-vl-plus",
        "metadata_schema": "IMAGE_METADATA_SCHEMA"
    }
}
```

**响应示例**:
```json
{
    "success": true,
    "data": {
        "metadata_id": "meta_1234567890",
        "content_type": "image",
        "metadata": {
            "chunk_id": "image_1704067200_abc12345",
            "chunk_type": "image",
            "source_type": "pdf",
            "document_name": "document_1",
            "page_number": 5,
            "created_timestamp": 1704067200,
            "enhanced_description": "这是一张包含图表的图片，展示了数据分析结果...",
            "img_caption": ["图片标题"],
            "img_footnote": ["图片说明"],
            "metadata_schema": "IMAGE_METADATA_SCHEMA",
            "metadata_version": "3.0.0"
        },
        "processing_info": {
            "enhancement_model": "qwen-vl-plus",
            "enhancement_time": "3.2s",
            "quality_score": 0.94
        }
    },
    "message": "元数据生成成功",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

### 6.2 元数据查询

#### 查询元数据
- **接口**: `GET /api/v3/metadata/query`
- **描述**: 根据条件查询元数据
- **参数**: 
  - `content_type`: 内容类型
  - `document_name`: 文档名称
  - `page_number`: 页码
  - `chunk_type`: 块类型
  - `limit`: 返回数量限制
  - `offset`: 偏移量
- **响应示例**:
```json
{
    "success": true,
    "data": {
        "total_count": 150,
        "metadata_list": [
            {
                "chunk_id": "text_1704067200_abc12345",
                "chunk_type": "text",
                "document_name": "document_1",
                "page_number": 1,
                "content_preview": "这是文本内容的预览...",
                "created_timestamp": 1704067200
            }
        ],
        "pagination": {
            "current_page": 1,
            "page_size": 10,
            "total_pages": 15
        }
    },
    "message": "元数据查询成功",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

## 7. 向量存储管理接口

### 7.1 向量存储状态

#### 查询向量存储状态
- **接口**: `GET /api/v3/vectorstore/status`
- **描述**: 查询向量数据库状态和统计信息
- **参数**: 无
- **响应示例**:
```json
{
    "success": true,
    "data": {
        "status": "ready",
        "database_info": {
            "type": "FAISS",
            "index_type": "IndexFlatIP",
            "vector_dimension": 1536,
            "total_vectors": 1500,
            "database_size": "45.2MB"
        },
        "content_distribution": {
            "text": 800,
            "image": 450,
            "table": 250
        },
        "performance_metrics": {
            "query_latency_avg": "15ms",
            "index_build_time": "2m 30s",
            "last_optimization": "2024-01-01T00:00:00Z"
        }
    },
    "message": "向量存储状态查询成功",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

### 7.2 向量存储操作

#### 添加向量到存储
- **接口**: `POST /api/v3/vectorstore/add`
- **描述**: 将向量和元数据添加到向量数据库
- **请求参数**:
```json
{
    "vectors": [
        {
            "id": "vec_001",
            "vector": [0.1, 0.2, 0.3, ...],
            "metadata": {
                "chunk_id": "text_001",
                "chunk_type": "text",
                "content_preview": "内容预览..."
            }
        }
    ],
    "options": {
        "batch_mode": true,
        "optimize_after_add": false
    }
}
```

**响应示例**:
```json
{
    "success": true,
    "data": {
        "operation_id": "op_1234567890",
        "status": "completed",
        "results": {
            "total_vectors": 1,
            "successful_adds": 1,
            "failed_adds": 0,
            "new_total_count": 1501
        },
        "performance": {
            "processing_time": "250ms",
            "storage_increase": "0.15MB"
        }
    },
    "message": "向量添加成功",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

## 8. 系统监控接口

### 8.1 性能监控

#### 获取系统性能指标
- **接口**: `GET /api/v3/monitor/performance`
- **描述**: 获取系统性能监控数据
- **参数**: 
  - `time_range`: 时间范围（1h, 6h, 24h, 7d）
- **响应示例**:
```json
{
    "success": true,
    "data": {
        "time_range": "24h",
        "metrics": {
            "cpu_usage": {
                "current": 45.2,
                "average": 38.7,
                "peak": 78.9
            },
            "memory_usage": {
                "current": "2.1GB",
                "available": "5.9GB",
                "peak": "3.2GB"
            },
            "processing_throughput": {
                "documents_per_hour": 12,
                "vectors_per_minute": 150,
                "average_processing_time": "45s"
            }
        },
        "alerts": [
            {
                "level": "warning",
                "message": "内存使用率超过80%",
                "timestamp": "2024-01-01T00:00:00Z"
            }
        ]
    },
    "message": "性能指标获取成功",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

### 8.2 错误监控

#### 获取系统错误信息
- **接口**: `GET /api/v3/monitor/errors`
- **描述**: 获取系统错误和异常信息
- **参数**: 
  - `severity`: 错误严重程度（info, warning, error, critical）
  - `time_range`: 时间范围
  - `limit`: 返回数量限制
- **响应示例**:
```json
{
    "success": true,
    "data": {
        "total_errors": 15,
        "error_summary": {
            "info": 8,
            "warning": 4,
            "error": 2,
            "critical": 1
        },
        "error_list": [
            {
                "timestamp": "2024-01-01T00:00:00Z",
                "severity": "warning",
                "module": "image_processor",
                "message": "图片增强处理超时",
                "details": "处理图片img_001时超时，已重试2次"
            }
        ]
    },
    "message": "错误信息获取成功",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

## 9. 工具和实用接口

### 9.1 文档类型检测

#### 检测文档类型
- **接口**: `POST /api/v3/utils/detect_type`
- **描述**: 检测输入文件的类型和格式
- **请求参数**:
```json
{
    "file_path": "./documents/sample.pdf",
    "options": {
        "detailed_analysis": true,
        "extract_metadata": true
    }
}
```

**响应示例**:
```json
{
    "success": true,
    "data": {
        "file_info": {
            "path": "./documents/sample.pdf",
            "size": "2.5MB",
            "extension": "pdf",
            "mime_type": "application/pdf"
        },
        "detection_result": {
            "input_type": "pdf",
            "confidence": 0.98,
            "supported": true,
            "estimated_pages": 15
        },
        "metadata": {
            "title": "示例文档",
            "author": "作者名",
            "creation_date": "2024-01-01",
            "page_count": 15
        }
    },
    "message": "文档类型检测成功",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

### 9.2 系统诊断

#### 系统诊断
- **接口**: `POST /api/v3/utils/diagnose`
- **描述**: 执行系统诊断，检查各模块状态
- **请求参数**:
```json
{
    "diagnosis_type": "full",
    "options": {
        "check_database": true,
        "check_ai_models": true,
        "check_file_system": true,
        "check_network": true
    }
}
```

**响应示例**:
```json
{
    "success": true,
    "data": {
        "diagnosis_id": "diag_1234567890",
        "status": "completed",
        "results": {
            "database": {
                "status": "healthy",
                "issues": [],
                "recommendations": []
            },
            "ai_models": {
                "status": "healthy",
                "issues": [],
                "recommendations": []
            },
            "file_system": {
                "status": "warning",
                "issues": ["磁盘空间不足"],
                "recommendations": ["清理临时文件", "增加磁盘空间"]
            },
            "network": {
                "status": "healthy",
                "issues": [],
                "recommendations": []
            }
        },
        "overall_status": "warning",
        "summary": "系统整体运行正常，但存在磁盘空间不足的问题"
    },
    "message": "系统诊断完成",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

## 10. 错误处理

### 10.1 错误响应格式
所有错误都使用统一的响应格式：

```json
{
    "success": false,
    "error": {
        "code": "ERROR_CODE",
        "message": "用户友好的错误描述",
        "details": "详细的错误信息（开发环境）",
        "suggestion": "解决建议"
    },
    "timestamp": "2024-01-01T00:00:00Z",
    "request_id": "req_1234567890"
}
```

### 10.2 常见错误码

| 错误码 | HTTP状态码 | 说明 | 解决建议 |
|--------|------------|------|----------|
| INVALID_INPUT_TYPE | 400 | 输入类型不支持 | 检查input_type参数值 |
| FILE_NOT_FOUND | 404 | 文件未找到 | 检查文件路径是否正确 |
| PROCESSING_FAILED | 500 | 处理失败 | 检查日志获取详细错误信息 |
| INSUFFICIENT_RESOURCES | 503 | 资源不足 | 检查系统资源使用情况 |
| MODEL_UNAVAILABLE | 503 | AI模型不可用 | 检查网络连接和API密钥 |

## 11. 使用示例

### 11.1 完整文档处理流程

```bash
# 1. 检查系统状态
curl -X GET "http://localhost:5000/api/v3/status"

# 2. 启动文档处理
curl -X POST "http://localhost:5000/api/v3/process" \
  -H "Content-Type: application/json" \
  -d '{
    "input_type": "pdf",
    "input_path": "./documents/sample.pdf",
    "processing_mode": "new"
  }'

# 3. 查询处理进度
curl -X GET "http://localhost:5000/api/v3/process/proc_1234567890/progress"

# 4. 获取处理结果
curl -X GET "http://localhost:5000/api/v3/process/proc_1234567890/result"
```

### 11.2 Python客户端示例

```python
import requests
import json

class V3RAGClient:
    def __init__(self, base_url="http://localhost:5000"):
        self.base_url = base_url
        self.session = requests.Session()
    
    def process_document(self, input_type, input_path, processing_mode="new"):
        """处理文档"""
        url = f"{self.base_url}/api/v3/process"
        data = {
            "input_type": input_type,
            "input_path": input_path,
            "processing_mode": processing_mode
        }
        response = self.session.post(url, json=data)
        return response.json()
    
    def get_progress(self, process_id):
        """查询处理进度"""
        url = f"{self.base_url}/api/v3/process/{process_id}/progress"
        response = self.session.get(url)
        return response.json()
    
    def get_result(self, process_id):
        """获取处理结果"""
        url = f"{self.base_url}/api/v3/process/{process_id}/result"
        response = self.session.get(url)
        return response.json()

# 使用示例
client = V3RAGClient()

# 处理文档
result = client.process_document("pdf", "./documents/sample.pdf")
process_id = result["data"]["process_id"]

# 查询进度
progress = client.get_progress(process_id)
print(f"处理进度: {progress['data']['progress']['progress_percentage']}%")

# 获取结果
final_result = client.get_result(process_id)
print(f"处理完成，生成了 {final_result['data']['result_summary']['total_vectors']} 个向量")
```

## 12. 部署和配置

### 12.1 环境要求
- Python 3.8+
- Flask 2.0+
- 足够的磁盘空间用于向量存储
- 稳定的网络连接用于AI模型调用

### 12.2 配置说明
主要配置项在 `v3_config.json` 文件中：

```json
{
    "system": {
        "version": "3.0.0",
        "environment": "development",
        "log_level": "INFO"
    },
    "ai_models": {
        "text_embedding": "text-embedding-v1",
        "image_embedding": "multimodal-embedding-one-peace-v1",
        "image_enhancement": "qwen-vl-plus"
    },
    "processing": {
        "chunk_size": 1000,
        "overlap_size": 200,
        "batch_size": 50
    }
}
```

### 12.3 启动命令
```bash
# 启动V3系统
python v3/main.py --input_type pdf --input_path ./documents/sample.pdf

# 启动Web API服务（如果实现）
python v3/web_app.py
```

## 13. 版本更新

### 13.1 版本历史
- **v3.0.0**: 初始版本，支持PDF文档处理和向量数据库构建
- **v3.1.0**: 计划添加增量更新和实时处理功能
- **v3.2.0**: 计划添加分布式处理和集群支持

### 13.2 向后兼容性
V3版本API设计考虑了向后兼容性，新版本会保持核心接口的稳定性，同时通过版本号控制新功能的引入。

## 14. 联系和支持

### 14.1 技术支持
- **文档**: 查看项目README和设计文档
- **问题反馈**: 通过GitHub Issues提交问题
- **功能建议**: 通过GitHub Discussions讨论新功能

### 14.2 贡献指南
欢迎贡献代码和文档，请遵循项目的编码规范和贡献流程。

---

**文档版本**: v3.0.0  
**最后更新**: 2024-01-01  
**维护者**: V3开发团队
