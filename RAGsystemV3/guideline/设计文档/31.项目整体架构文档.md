# RAG系统V3项目整体架构文档

## 一、文档基础信息

| 项目名称 | RAG系统V3 - 智能检索增强生成系统 | 文档版本 | V1.0 |
| -------- | -------------------------------- | -------- | ---- |
| 文档状态 | ☑ 草稿 □ 评审中 □ 已确认 □ 已归档 | 编写人   | AI助手 |
| 编写日期 | 2025年9月9日 | 关联文档 | 各模块详细设计文档 |

## 二、项目概述

### 2.1 项目定位
RAG系统V3是一个基于检索增强生成（Retrieval-Augmented Generation）的智能问答系统，由两个核心模块组成：

1. **RAG查询系统**（`rag_system/`）：提供智能问答、多模态检索、记忆管理等核心功能
2. **向量数据库构建系统**（`db_system/`）：负责从原始文档提取数据、生成向量数据库

### 2.2 核心价值
- **智能问答**：支持多模态内容查询，提供准确、可溯源的答案
- **记忆管理**：支持多轮对话，智能查询重写和上下文增强
- **文档处理**：从PDF到向量数据库的完整处理流程
- **高性能**：基于FAISS的高效向量检索，支持大规模数据
- **易部署**：模块化设计，支持独立部署和扩展

### 2.3 目标用户
- **最终用户**：需要智能问答和文档检索的用户
- **系统管理员**：负责系统部署、配置和维护
- **开发人员**：需要扩展和定制系统功能
- **数据工程师**：负责文档处理和向量数据库构建

## 三、整体架构设计

### 3.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        RAG系统V3整体架构                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │   前端界面层      │    │   API网关层      │    │  数据存储层    │ │
│  │                 │    │                 │    │              │ │
│  │ Vue.js 3        │◄──►│ FastAPI         │◄──►│ FAISS向量库   │ │
│  │ Element Plus    │    │ uvicorn         │    │ SQLite记忆库  │ │
│  │ 响应式设计        │    │ 路由管理          │    │ 文件存储      │ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
│           │                       │                       │     │
│           │                       │                       │     │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │ RAG查询系统      │    │ 向量数据库构建     │    │  外部服务      │ │
│  │                 │    │ 系统             │    │              │ │
│  │ 查询处理器        │    │ 文档解析器        │    │ DashScope    │ │
│  │ 记忆管理器        │    │ 内容处理器        │    │ minerU API   │ │
│  │ 统一服务          │    │ 向量化管理器      │    │ spaCy模型     │ │
│  │ 配置管理          │    │ 元数据管理器      │    │              │ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 模块关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                        模块关系图                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐              ┌─────────────────┐            │
│  │ RAG查询系统      │              │ 向量数据库构建     │            │
│  │                 │              │ 系统            │            │
│  │ ┌─────────────┐ │              │ ┌─────────────┐ │            │
│  │ │查询处理器     │ │              │ │主控制器       │ │            │
│  │ └─────────────┘ │              │ └─────────────┘ │            │
│  │ ┌─────────────┐ │              │ ┌─────────────┐ │            │
│  │ │记忆管理器     │ │              │ │内容处理器     │ │            │
│  │ └─────────────┘ │              │ └─────────────┘ │            │
│  │ ┌─────────────┐ │              │ ┌─────────────┐ │            │
│  │ │统一服务       │ │              │ │向量化管理器   | │            │
│  │ └─────────────┘ │              │ └─────────────┘ │            │
│  │ ┌─────────────┐ │              │ ┌─────────────┐ │            │
│  │ │配置管理      │ │              │ │元数据管理器    │ │            │
│  │ └─────────────┘ │              │ └─────────────┘ │            │
│  └─────────────────┘              └─────────────────┘            │
│           │                                 │                    │
│           │                                 │                    │
│           └─────────────┬───────────────────┘                    │
│                         │                                        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    共享数据存储层                              │ │
│  │                                                             │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │ │
│  │  │ FAISS向量库  │  │ SQLite记忆库 │  │ 文件存储系统           │  │ │
│  │  │             │  │             │  │                     │  │ │
│  │  │ 文本向量      │  │ 会话数据     │  │ PDF文档              │  │ │
│  │  │ 图像向量      │  │ 记忆数据     │  │ 解析结果              │  │ │
│  │  │ 表格向量      │  │ 元数据       │  │ 图片文件              │  │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 四、核心模块设计

### 4.1 RAG查询系统架构

#### 4.1.1 核心组件
- **查询处理器**：处理用户查询，支持多模态查询类型
- **记忆管理器**：管理多轮对话记忆，支持智能查询重写
- **统一服务**：提供统一的API接口和服务管理
- **配置管理**：集中化配置管理和环境变量处理

#### 4.1.2 关键特性
- **多模态查询**：支持文本、图片、表格、智能、混合查询
- **记忆管理**：基于SQLite的记忆数据库，支持上下文增强
- **智能重写**：基于spaCy的代词解析和查询增强
- **答案溯源**：提供完整的答案来源追踪

### 4.2 向量数据库构建系统架构

#### 4.2.1 核心组件
- **主控制器**：统一管理整个处理流程
- **内容处理器**：处理不同类型的内容（文本、图像、表格）
- **向量化管理器**：实现双重embedding策略
- **元数据管理器**：生成标准化的元数据
- **向量存储管理器**：基于FAISS的高效向量存储

#### 4.2.2 关键特性
- **文档解析**：支持PDF文档的智能解析（基于minerU API）
- **双重向量化**：视觉向量（One_Peace）+ 语义向量（text-embedding-v1）
- **增量更新**：支持向量数据库的增量更新
- **数据库诊断**：提供完整的数据库诊断和修复工具

### 4.3 前端界面架构

#### 4.3.1 技术栈
- **Vue.js 3**：前端框架
- **Vite**：构建工具
- **Element Plus**：UI组件库
- **SCSS**：样式预处理器

#### 4.3.2 核心功能
- **多模态查询界面**：支持文本、图片、表格查询
- **智能问答组件**：实时聊天交互
- **结果展示组件**：多种展示模式
- **响应式设计**：适配桌面和移动设备

## 五、数据流设计

### 5.1 完整数据流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                        完整数据流程图                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐  │
│  │ PDF文档      │───►│ minerU API  │───►│ 解析结果             │  │
│  │ 输入         │    │ 文档解析      │    │ (Markdown+JSON+图片)│  │
│  └─────────────┘    └─────────────┘    └─────────────────────┘  │
│           │                                 │                    │
│           │                                 ▼                    │
│           │                    ┌─────────────────────┐            │
│           │                    │ 内容处理器            │            │
│           │                    │ - 文本分块            │            │
│           │                    │ - 图像增强            │            │
│           │                    │ - 表格处理            │            │
│           │                    └─────────────────────┘            │
│           │                                 │                    │
│           │                                 ▼                    │
│           │                    ┌─────────────────────┐            │
│           │                    │ 向量化管理器        │            │
│           │                    │ - 文本向量化        │            │
│           │                    │ - 图像双重向量化    │            │
│           │                    │ - 表格向量化        │            │
│           │                    └─────────────────────┘            │
│           │                                 │                    │
│           │                                 ▼                    │
│           │                    ┌─────────────────────┐            │
│           │                    │ 元数据管理器        │            │
│           │                    │ - 生成标准化元数据  │            │
│           │                    │ - 关联信息管理      │            │
│           │                    └─────────────────────┘            │
│           │                                 │                    │
│           │                                 ▼                    │
│           │                    ┌─────────────────────┐            │
│           │                    │ 向量存储管理器      │            │
│           │                    │ - FAISS索引构建     │            │
│           │                    │ - 向量存储          │            │
│           │                    │ - 索引优化          │            │
│           │                    └─────────────────────┘            │
│           │                                 │                    │
│           │                                 ▼                    │
│           │                    ┌─────────────────────┐            │
│           │                    │ 向量数据库          │            │
│           │                    │ - FAISS索引文件     │            │
│           │                    │ - 元数据文件        │            │
│           │                    └─────────────────────┘            │
│           │                                 │                    │
│           │                                 │                    │
│           │                                 ▼                    │
│           │                    ┌─────────────────────┐            │
│           │                    │ RAG查询系统         │            │
│           │                    │ - 查询处理          │            │
│           │                    │ - 向量检索          │            │
│           │                    │ - 记忆管理          │            │
│           │                    │ - 答案生成          │            │
│           │                    └─────────────────────┘            │
│           │                                 │                    │
│           │                                 ▼                    │
│           │                    ┌─────────────────────┐            │
│           │                    │ 前端界面            │            │
│           │                    │ - 查询界面          │            │
│           │                    │ - 结果展示          │            │
│           │                    │ - 交互管理          │            │
│           │                    └─────────────────────┘            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 查询处理数据流

```
用户查询 → 查询处理器 → 记忆管理器 → 向量检索 → 重排序 → 答案生成 → 前端展示
    │          │          │      │         │         │         │
    │          │          │      │         │         │         │
    ▼          ▼          ▼      ▼         ▼         ▼         ▼
智能识别    查询重写    上下文增强   相似度计算  结果排序   LLM生成   用户界面
查询类型    代词解析    历史记忆     向量检索   质量评估   答案生成   结果展示
```

## 六、技术架构

### 6.1 技术栈选型

#### 6.1.1 后端技术
- **Python 3.8+**：主要开发语言
- **FastAPI**：Web框架，高性能异步API
- **uvicorn**：ASGI服务器
- **FAISS**：向量数据库，高效相似度搜索
- **SQLite**：轻量级关系数据库
- **spaCy**：中文NLP处理
- **DashScope**：AI模型服务

#### 6.1.2 前端技术
- **Vue.js 3**：渐进式前端框架
- **Vite**：快速构建工具
- **Element Plus**：Vue 3 UI组件库
- **SCSS**：CSS预处理器
- **Axios**：HTTP客户端

#### 6.1.3 AI模型
- **通义千问**：大语言模型（qwen-turbo）
- **text-embedding-v1**：文本向量化模型
- **multimodal-embedding-one-peace-v1**：图像向量化模型

### 6.2 数据库设计

#### 6.2.1 向量数据库（FAISS）
- **存储内容**：文本、图像、表格向量
- **索引类型**：HNSW、IVF等
- **向量维度**：1536维
- **存储格式**：index.faiss + index.pkl

#### 6.2.2 记忆数据库（SQLite）
- **sessions表**：会话管理
- **memories表**：记忆存储
- **memory_metadata表**：记忆元数据

#### 6.2.3 文件存储
- **PDF文档**：原始文档存储
- **解析结果**：Markdown、JSON、图片文件
- **配置文件**：JSON格式配置

## 七、部署架构

### 7.1 部署模式

#### 7.1.1 单机部署
```
┌─────────────────────────────────────────────────────────────────┐
│                        单机部署架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │ 前端服务        │    │ 后端服务        │    │ 数据存储     │ │
│  │                │    │                │    │              │ │
│  │ Vue.js 3       │    │ FastAPI        │    │ FAISS向量库  │ │
│  │ Port: 3000     │    │ Port: 8000     │    │ SQLite记忆库 │ │
│  │ nginx (可选)   │    │ uvicorn        │    │ 文件存储     │ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 7.1.2 分布式部署
```
┌─────────────────────────────────────────────────────────────────┐
│                        分布式部署架构                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │ 负载均衡器      │    │ 应用服务器集群  │    │ 数据存储集群 │ │
│  │                │    │                │    │              │ │
│  │ nginx/HAProxy  │    │ FastAPI × N    │    │ 分布式存储   │ │
│  │ 负载均衡        │    │ 水平扩展        │    │ 数据同步     │ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 环境要求

#### 7.2.1 硬件要求
- **CPU**：4核及以上
- **内存**：8GB及以上（推荐16GB）
- **存储**：100GB及以上（SSD优先）
- **网络**：稳定的网络连接

#### 7.2.2 软件要求
- **操作系统**：Windows 10/11, Linux, macOS
- **Python**：3.8或更高版本
- **Node.js**：16.0或更高版本
- **数据库**：SQLite（内置）

## 八、安全架构

### 8.1 安全措施

#### 8.1.1 API安全
- **API密钥管理**：环境变量存储
- **请求频率限制**：防止API滥用
- **输入验证**：严格的参数验证
- **错误处理**：避免敏感信息泄露

#### 8.1.2 数据安全
- **数据加密**：敏感数据加密存储
- **访问控制**：基于角色的访问控制
- **审计日志**：完整的操作日志记录
- **备份恢复**：定期数据备份

### 8.2 隐私保护

#### 8.2.1 数据隐私
- **数据脱敏**：敏感信息脱敏处理
- **数据最小化**：只收集必要数据
- **数据保留**：合理的数据保留策略
- **用户控制**：用户数据控制权

## 九、性能架构

### 9.1 性能指标

#### 9.1.1 响应时间
- **API响应时间**：< 0.3秒
- **查询响应时间**：< 2秒
- **记忆检索时间**：< 0.1秒
- **向量检索时间**：< 0.05秒

#### 9.1.2 吞吐量
- **并发查询数**：> 100
- **向量检索QPS**：> 1000
- **API请求QPS**：> 500

#### 9.1.3 可用性
- **系统可用性**：> 99%
- **服务可用性**：> 99.9%
- **数据可用性**：> 99.99%

### 9.2 性能优化

#### 9.2.1 缓存策略
- **向量缓存**：内存缓存常用向量
- **查询缓存**：缓存查询结果
- **配置缓存**：缓存配置信息

#### 9.2.2 数据库优化
- **索引优化**：FAISS索引参数调优
- **查询优化**：SQL查询优化
- **连接池**：数据库连接池管理

## 十、监控架构

### 10.1 监控体系

#### 10.1.1 系统监控
- **CPU使用率**：实时监控
- **内存使用率**：实时监控
- **磁盘使用率**：实时监控
- **网络流量**：实时监控

#### 10.1.2 应用监控
- **API响应时间**：实时监控
- **错误率**：实时监控
- **吞吐量**：实时监控
- **用户活跃度**：实时监控

#### 10.1.3 业务监控
- **查询成功率**：实时监控
- **答案质量**：定期评估
- **用户满意度**：定期调研

### 10.2 告警机制

#### 10.2.1 告警规则
- **系统资源告警**：CPU/内存/磁盘阈值
- **应用性能告警**：响应时间/错误率阈值
- **业务指标告警**：查询成功率阈值

#### 10.2.2 告警通知
- **邮件通知**：重要告警邮件通知
- **短信通知**：紧急告警短信通知
- **钉钉/企业微信**：团队通知

## 十一、扩展架构

### 11.1 水平扩展

#### 11.1.1 应用层扩展
- **无状态设计**：支持水平扩展
- **负载均衡**：请求分发
- **服务发现**：动态服务注册

#### 11.1.2 数据层扩展
- **读写分离**：数据库读写分离
- **分库分表**：数据分片
- **缓存集群**：分布式缓存

### 11.2 功能扩展

#### 11.2.1 新功能扩展
- **插件机制**：支持插件扩展
- **API版本管理**：向后兼容
- **配置热更新**：动态配置更新

#### 11.2.2 集成扩展
- **第三方集成**：支持第三方服务集成
- **API网关**：统一API管理
- **消息队列**：异步处理

## 十二、总结

### 12.1 架构优势
1. **模块化设计**：清晰的模块划分，便于维护和扩展
2. **高性能**：基于FAISS的高效向量检索
3. **易部署**：支持单机和分布式部署
4. **可扩展**：支持水平和垂直扩展
5. **安全性**：完善的安全措施和隐私保护

### 12.2 技术特色
1. **双重向量化**：视觉+语义向量策略
2. **智能记忆管理**：多轮对话上下文增强
3. **多模态支持**：文本、图像、表格统一处理
4. **现代化界面**：基于Vue.js 3的响应式设计

### 12.3 应用价值
1. **提升效率**：智能问答减少人工查找时间
2. **提高准确性**：基于向量检索的精准匹配
3. **增强体验**：多模态交互和记忆管理
4. **降低成本**：自动化处理减少人力成本

---

**文档版本历史**：
- V1.0 (2025-09-09): 初始版本，基于RAG系统V3.0.0架构设计
