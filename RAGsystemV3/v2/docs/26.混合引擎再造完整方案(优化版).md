å¥½çš„ï¼æˆ‘æ¥åŸºäºæˆ‘ä»¬åˆšæ‰è®¨è®ºçš„å†…å®¹ï¼Œç‰¹åˆ«æ˜¯"ä¸é™çº§"å’Œ"æ™ºèƒ½æŸ¥è¯¢"çš„é—®é¢˜ï¼Œå¯¹æ··åˆå¼•æ“å†é€ å®Œæ•´æ–¹æ¡ˆè¿›è¡Œä¼˜åŒ–ã€‚ä»¥ä¸‹æ˜¯ä¿®æ”¹åçš„å®Œæ•´æ–¹æ¡ˆï¼š

# 26. æ··åˆå¼•æ“å†é€ å®Œæ•´æ–¹æ¡ˆï¼ˆä¼˜åŒ–ç‰ˆï¼‰

## 1. é¡¹ç›®èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 é¡¹ç›®èƒŒæ™¯
- å·²å®Œæˆä¸‰ä¸ªå•å¼•æ“ï¼ˆTextã€Imageã€Tableï¼‰çš„å…¨é¢æ”¹é€ 
- éœ€è¦å®Œæˆæ··åˆå¼•æ“çš„å†é€ ï¼Œå®ç°æ™ºèƒ½è·¯ç”±å’Œè·¨æ¨¡æ€èåˆ
- ç›®æ ‡æ˜¯æä¾›ç»Ÿä¸€çš„æŸ¥è¯¢æ¥å£å’Œæ™ºèƒ½çš„ç»“æœèåˆ
- **æ–°å¢ç›®æ ‡**ï¼šå®ç°æ™ºèƒ½æŸ¥è¯¢ï¼Œè‡ªåŠ¨è¯†åˆ«æŸ¥è¯¢æ„å›¾

### 1.2 æ ¸å¿ƒç›®æ ‡
1. **æ™ºèƒ½è·¯ç”±**ï¼šæ ¹æ®æŸ¥è¯¢ç±»å‹è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜å¼•æ“
2. **è·¨æ¨¡æ€èåˆ**ï¼šèåˆä¸åŒç±»å‹å†…å®¹çš„ç»“æœ
3. **ç»Ÿä¸€ä½“éªŒ**ï¼šæ‰€æœ‰æŸ¥è¯¢ç±»å‹ä½¿ç”¨ç›¸åŒçš„Pipeline
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¹¶è¡Œæ‰§è¡Œï¼Œå‡å°‘å“åº”æ—¶é—´
5. **æ™ºèƒ½æŸ¥è¯¢**ï¼šè‡ªåŠ¨è¯†åˆ«æŸ¥è¯¢æ„å›¾ï¼Œæ— éœ€ç”¨æˆ·æ‰‹åŠ¨æŒ‡å®šç±»å‹

## 2. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```mermaid
flowchart TD
    A[ç”¨æˆ·æŸ¥è¯¢] --> B[æ™ºèƒ½æŸ¥è¯¢å¼•æ“]
    
    B --> C{æŸ¥è¯¢ç±»å‹åˆ¤æ–­}
    C -->|TEXT/IMAGE/TABLE| D[å•å¼•æ“æ¨¡å¼]
    C -->|HYBRID| E[æ··åˆå¼•æ“æ¨¡å¼]
    C -->|SMART| F[æ™ºèƒ½æ„å›¾åˆ†ææ¨¡å¼]
    
    D --> D1[ç›´æ¥è°ƒç”¨æŒ‡å®šå¼•æ“]
    D1 --> D2[å¼•æ“å®Œæ•´æµç¨‹]
    D2 --> D3[å¬å› + Reranking + ç»Ÿä¸€Pipeline]
    
    E --> E1[å¹¶è¡Œæ‰§è¡Œä¸‰å¼•æ“recall]
    E1 --> E2[èåˆrecallç»“æœ]
    E2 --> E3[æ··åˆreranking]
    E3 --> E4[ç»Ÿä¸€Pipelineå¤„ç†]
    
    F --> F1[æ„å›¾åˆ†æå™¨]
    F1 --> F2[ç½®ä¿¡åº¦åˆ¤æ–­]
    F2 -->|é«˜ç½®ä¿¡åº¦ > 0.8| F3[å•å¼•æ“è·¯ç”±]
    F2 -->|ä½ç½®ä¿¡åº¦ <= 0.8| F4[æ··åˆå¼•æ“è·¯ç”±]
    
    F3 --> D2
    F4 --> E1
    
    D3 --> G[æ„å»ºæœ€ç»ˆç»“æœ]
    E4 --> G
    
    G --> H[è¿”å›ç”¨æˆ·]
```

### 2.2 æ ¸å¿ƒç»„ä»¶
1. **æ™ºèƒ½æŸ¥è¯¢å¼•æ“**ï¼šè‡ªåŠ¨è¯†åˆ«æŸ¥è¯¢æ„å›¾å’Œè·¯ç”±
2. **HybridEngine**ï¼šæ™ºèƒ½è·¯ç”±å’Œåè°ƒå™¨
3. **å„å¼•æ“recallæ–¹æ³•**ï¼šä¸“é—¨çš„å¬å›æ¥å£ï¼ˆæ–°å¢ï¼‰
4. **HybridRerankingService**ï¼šæ··åˆé‡æ’åºæœåŠ¡
5. **ç»Ÿä¸€Pipeline**ï¼šæ‰€æœ‰å¼•æ“å…±äº«çš„LLM+æº¯æºå¤„ç†

## 3. æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 3.1 ä¸ºå„å¼•æ“æ·»åŠ recallæ–¹æ³•

#### 3.1.1 TextEngine recallæ–¹æ³•

```python
def recall(self, query: str, **kwargs) -> List[Any]:
    """
    åªæ‰§è¡Œå¬å›ï¼Œä¸æ‰§è¡Œrerankingå’Œpipeline
    
    :param query: æŸ¥è¯¢æ–‡æœ¬
    :param kwargs: å…¶ä»–å‚æ•°
    :return: å¬å›ç»“æœåˆ—è¡¨
    """
    try:
        # ç¡®ä¿æ–‡æ¡£å·²åŠ è½½
        self._ensure_docs_loaded()
        
        # ç›´æ¥è°ƒç”¨ç°æœ‰çš„å¬å›é€»è¾‘
        recall_results = self._search_texts(query, **kwargs)
        
        self.logger.info(f"TextEngine recallå®Œæˆï¼Œç»“æœæ•°é‡: {len(recall_results)}")
        return recall_results
        
    except Exception as e:
        self.logger.error(f"TextEngine recallæ‰§è¡Œå¤±è´¥: {str(e)}")
        return []
```

#### 3.1.2 ImageEngine recallæ–¹æ³•

```python
def recall(self, query: str, **kwargs) -> List[Any]:
    """
    åªæ‰§è¡Œå¬å›ï¼Œä¸æ‰§è¡Œrerankingå’Œpipeline
    """
    try:
        # ç¡®ä¿æ–‡æ¡£å·²åŠ è½½
        self._ensure_docs_loaded()
        
        # ç›´æ¥è°ƒç”¨ç°æœ‰çš„å¬å›é€»è¾‘
        recall_results = self._search_images(query, **kwargs)
        
        self.logger.info(f"ImageEngine recallå®Œæˆï¼Œç»“æœæ•°é‡: {len(recall_results)}")
        return recall_results
        
    except Exception as e:
        self.logger.error(f"ImageEngine recallæ‰§è¡Œå¤±è´¥: {str(e)}")
        return []
```

#### 3.1.3 TableEngine recallæ–¹æ³•

```python
def recall(self, query: str, **kwargs) -> List[Any]:
    """
    åªæ‰§è¡Œå¬å›ï¼Œä¸æ‰§è¡Œrerankingå’Œpipeline
    """
    try:
        # ç¡®ä¿æ–‡æ¡£å·²åŠ è½½
        self._ensure_docs_loaded()
        
        # ç›´æ¥è°ƒç”¨ç°æœ‰çš„å¬å›é€»è¾‘
        recall_results = self._search_tables(query, **kwargs)
        
        self.logger.info(f"TableEngine recallå®Œæˆï¼Œç»“æœæ•°é‡: {len(recall_results)}")
        return recall_results
        
    except Exception as e:
        self.logger.error(f"TableEngine recallæ‰§è¡Œå¤±è´¥: {str(e)}")
        return []
```

### 3.2 æ™ºèƒ½æŸ¥è¯¢å¼•æ“å®ç°

#### 3.2.1 æŸ¥è¯¢æ„å›¾åˆ†æå™¨

```python
class QueryIntentAnalyzer:
    """æŸ¥è¯¢æ„å›¾åˆ†æå™¨"""
    
    def analyze_intent(self, query: str) -> Dict[str, Any]:
        """åˆ†ææŸ¥è¯¢æ„å›¾"""
        query_lower = query.lower()
        
        # å›¾ç‰‡ç›¸å…³å…³é”®è¯
        image_keywords = ['å›¾', 'å›¾ç‰‡', 'ç…§ç‰‡', 'image', 'photo', 'chart', 'graph', 'å›¾è¡¨']
        if any(keyword in query_lower for keyword in image_keywords):
            return {
                'primary_intent': 'image',
                'confidence': 0.9,
                'reason': 'æ£€æµ‹åˆ°å›¾ç‰‡ç›¸å…³å…³é”®è¯'
            }
        
        # è¡¨æ ¼ç›¸å…³å…³é”®è¯
        table_keywords = ['è¡¨æ ¼', 'æ•°æ®', 'è´¢åŠ¡', 'table', 'data', 'è´¢åŠ¡æ•°æ®', 'è¥æ”¶', 'åˆ©æ¶¦', 'ç»Ÿè®¡']
        if any(keyword in query_lower for keyword in table_keywords):
            return {
                'primary_intent': 'table',
                'confidence': 0.85,
                'reason': 'æ£€æµ‹åˆ°è¡¨æ ¼/æ•°æ®ç›¸å…³å…³é”®è¯'
            }
        
        # æ–‡æœ¬ç›¸å…³å…³é”®è¯
        text_keywords = ['ä»‹ç»', 'è¯´æ˜', 'æè¿°', 'åˆ†æ', 'æ€»ç»“', 'æ¦‚è¿°', 'å†…å®¹', 'æ–‡æ¡£']
        if any(keyword in query_lower for keyword in text_keywords):
            return {
                'primary_intent': 'text',
                'confidence': 0.8,
                'reason': 'æ£€æµ‹åˆ°æ–‡æœ¬åˆ†æç›¸å…³å…³é”®è¯'
            }
        
        # é»˜è®¤ä½¿ç”¨æ··åˆæŸ¥è¯¢
        return {
            'primary_intent': 'hybrid',
            'confidence': 0.7,
            'reason': 'æœªæ£€æµ‹åˆ°æ˜ç¡®æ„å›¾ï¼Œä½¿ç”¨æ··åˆæŸ¥è¯¢'
        }
```

#### 3.2.2 æ™ºèƒ½æŸ¥è¯¢å¼•æ“

```python
class SmartQueryEngine:
    """æ™ºèƒ½æŸ¥è¯¢å¼•æ“"""
    
    def __init__(self, 
                 text_engine: TextEngine,
                 image_engine: ImageEngine,
                 table_engine: TableEngine,
                 hybrid_engine: HybridEngine,
                 intent_analyzer: QueryIntentAnalyzer):
        self.text_engine = text_engine
        self.image_engine = image_engine
        self.table_engine = table_engine
        self.hybrid_engine = hybrid_engine
        self.intent_analyzer = intent_analyzer
        self.logger = logging.getLogger(__name__)
    
    def process_smart_query(self, query: str, **kwargs) -> QueryResult:
        """å¤„ç†æ™ºèƒ½æŸ¥è¯¢"""
        try:
            # 1. åˆ†ææŸ¥è¯¢æ„å›¾
            intent_result = self.intent_analyzer.analyze_intent(query)
            detected_type = intent_result['primary_intent']
            confidence = intent_result['confidence']
            
            self.logger.info(f"æ™ºèƒ½æŸ¥è¯¢æ£€æµ‹åˆ°ç±»å‹: {detected_type}, ç½®ä¿¡åº¦: {confidence}")
            
            # 2. æ ¹æ®ç½®ä¿¡åº¦é€‰æ‹©ç­–ç•¥
            if confidence > 0.8:  # é«˜ç½®ä¿¡åº¦ï¼Œä½¿ç”¨å•å¼•æ“
                self.logger.info(f"é«˜ç½®ä¿¡åº¦æŸ¥è¯¢ï¼Œä½¿ç”¨{detected_type}å¼•æ“")
                if detected_type == 'text':
                    return self.text_engine.process_query(query, **kwargs)
                elif detected_type == 'image':
                    return self.image_engine.process_query(query, **kwargs)
                elif detected_type == 'table':
                    return self.table_engine.process_query(query, **kwargs)
                else:
                    return self.hybrid_engine.process_query(query, **kwargs)
            else:  # ä½ç½®ä¿¡åº¦ï¼Œä½¿ç”¨æ··åˆå¼•æ“
                self.logger.info("ç½®ä¿¡åº¦è¾ƒä½ï¼Œä½¿ç”¨æ··åˆæŸ¥è¯¢")
                return self.hybrid_engine.process_query(query, **kwargs)
                
        except Exception as e:
            self.logger.error(f"æ™ºèƒ½æŸ¥è¯¢å¤„ç†å¤±è´¥: {str(e)}")
            # é™çº§åˆ°æ··åˆæŸ¥è¯¢
            return self.hybrid_engine.process_query(query, **kwargs)
```

### 3.3 æ··åˆå¼•æ“æ ¸å¿ƒæµç¨‹

#### 3.3.1 å¹¶è¡Œå¬å›æ‰§è¡Œ

```python
def _execute_parallel_recall(self, query: str, **kwargs) -> Dict[str, List[Any]]:
    """å¹¶è¡Œæ‰§è¡Œä¸‰ä¸ªå¼•æ“çš„recall"""
    
    recall_results = {'image': [], 'text': [], 'table': []}
    
    with ThreadPoolExecutor(max_workers=3) as executor:
        futures = {}
        
        # å¹¶è¡Œæäº¤ä¸‰ä¸ªå¼•æ“çš„recallä»»åŠ¡
        if self.image_engine and hasattr(self.image_engine, 'recall'):
            futures['image'] = executor.submit(
                self.image_engine.recall, query, **kwargs
            )
        if self.text_engine and hasattr(self.text_engine, 'recall'):
            futures['text'] = executor.submit(
                self.text_engine.recall, query, **kwargs
            )
        if self.table_engine and hasattr(self.table_engine, 'recall'):
            futures['table'] = executor.submit(
                self.table_engine.recall, query, **kwargs
            )
        
        # æ”¶é›†ç»“æœ
        for engine_type, future in futures.items():
            try:
                result = future.result(timeout=30)
                recall_results[engine_type] = result
                self.logger.info(f"{engine_type} å¼•æ“recallå®Œæˆï¼Œç»“æœæ•°é‡: {len(result)}")
            except Exception as e:
                self.logger.error(f"{engine_type} å¼•æ“recallå¤±è´¥: {str(e)}")
                recall_results[engine_type] = []
    
    return recall_results
```

#### 3.3.2 ç»“æœèåˆä¸æ ‡å‡†åŒ–

```python
def _merge_recall_results(self, recall_results: Dict[str, List[Any]]) -> List[Any]:
    """èåˆä¸‰ä¸ªå¼•æ“çš„recallç»“æœ"""
    
    combined_results = []
    
    for engine_type, results in recall_results.items():
        if results:
            for result in results:
                # æ ‡å‡†åŒ–ç»“æœæ ¼å¼
                normalized_result = self._normalize_result(result, engine_type)
                combined_results.append(normalized_result)
    
    self.logger.info(f"èåˆå®Œæˆï¼Œæ€»ç»“æœæ•°é‡: {len(combined_results)}")
    return combined_results

def _normalize_result(self, result: Any, source_engine: str) -> Dict[str, Any]:
    """æ ‡å‡†åŒ–å•ä¸ªç»“æœæ ¼å¼"""
    
    if isinstance(result, dict):
        normalized = result.copy()
    else:
        normalized = {'raw_content': str(result)}
    
    # æ·»åŠ å¿…è¦å­—æ®µ
    normalized['source_engine'] = source_engine
    normalized['normalized_at'] = time.time()
    
    # ç¡®ä¿å…³é”®å­—æ®µå­˜åœ¨
    if 'content' not in normalized and 'page_content' not in normalized:
        normalized['content'] = str(normalized.get('raw_content', ''))
    
    if 'metadata' not in normalized:
        normalized['metadata'] = {}
    
    return normalized
```

### 3.4 æ··åˆRerankingç­–ç•¥

#### 3.4.1 å†…å®¹ç±»å‹æ£€æµ‹ä¸åˆ†ç»„

```python
def _group_candidates_by_type(self, candidates: List[Dict[str, Any]]) -> Dict[str, List[Dict[str, Any]]]:
    """æŒ‰å†…å®¹ç±»å‹åˆ†ç»„å€™é€‰ç»“æœ"""
    
    grouped = {'image': [], 'text': [], 'table': [], 'unknown': []}
    
    for candidate in candidates:
        content_type = self._detect_content_type(candidate)
        grouped[content_type].append(candidate)
    
    logger.info(f"å€™é€‰ç»“æœåˆ†ç»„å®Œæˆ: å›¾ç‰‡={len(grouped['image'])}, æ–‡æœ¬={len(grouped['text'])}, è¡¨æ ¼={len(grouped['table'])}")
    return grouped

def _detect_content_type(self, candidate: Dict[str, Any]) -> str:
    """æ£€æµ‹å€™é€‰ç»“æœçš„å†…å®¹ç±»å‹"""
    
    # æ–¹æ³•1ï¼šæ£€æŸ¥chunk_typeå­—æ®µ
    chunk_type = candidate.get('chunk_type', '').lower()
    if chunk_type:
        if 'image' in chunk_type or 'image_text' in chunk_type:
            return 'image'
        elif 'table' in chunk_type:
            return 'table'
        elif 'text' in chunk_type:
            return 'text'
    
    # æ–¹æ³•2ï¼šæ£€æŸ¥å­—æ®µç‰¹å¾
    if 'image_path' in candidate or 'enhanced_description' in candidate:
        return 'image'
    elif 'table_type' in candidate or 'table_data' in candidate:
        return 'table'
    
    # æ–¹æ³•3ï¼šæ£€æŸ¥å†…å®¹ç‰¹å¾
    content = candidate.get('content', '')
    if content:
        if any(keyword in content.lower() for keyword in ['<table', '|', 'row', 'column']):
            return 'table'
        elif any(keyword in content.lower() for keyword in ['image', 'photo', 'picture']):
            return 'image'
    
    return 'text'  # é»˜è®¤ä¸ºæ–‡æœ¬ç±»å‹
```

#### 3.4.2 åˆ†ç±»å‹Rerankingæ‰§è¡Œ

```python
def _rerank_by_type(self, query: str, content_type: str, candidates: List[Dict[str, Any]], **kwargs) -> List[Dict[str, Any]]:
    """å¯¹ç‰¹å®šç±»å‹çš„ç»“æœè¿›è¡Œreranking"""
    
    try:
        if content_type == 'image' and self.image_reranking_service:
            return self.image_reranking_service.rerank_candidates(query, candidates, **kwargs)
        elif content_type == 'table' and self.table_reranking_service:
            return self.table_reranking_service.rerank_candidates(query, candidates, **kwargs)
        elif content_type == 'text' and self.text_reranking_service:
            return self.text_reranking_service.rerank_candidates(query, candidates, **kwargs)
        else:
            logger.warning(f"å†…å®¹ç±»å‹ {content_type} æ²¡æœ‰å¯¹åº”çš„reranking serviceï¼Œè¿”å›åŸå§‹ç»“æœ")
            return candidates
            
    except Exception as e:
        logger.error(f"å†…å®¹ç±»å‹ {content_type} çš„rerankingæ‰§è¡Œå¤±è´¥: {str(e)}")
        return candidates
```

#### 3.4.3 æ··åˆæ’åºç­–ç•¥

```python
def _apply_hybrid_ranking_strategy(self, query: str, results: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    """åº”ç”¨æ··åˆæ’åºç­–ç•¥"""
    
    try:
        if not results:
            return results
        
        # 1. è®¡ç®—æ··åˆç›¸å…³æ€§åˆ†æ•°
        for result in results:
            result['hybrid_score'] = self._calculate_hybrid_score(query, result)
        
        # 2. æŒ‰æ··åˆåˆ†æ•°æ’åº
        results.sort(key=lambda x: x.get('hybrid_score', 0), reverse=True)
        
        # 3. åº”ç”¨å¤šæ ·æ€§ç­–ç•¥
        diverse_results = self._apply_diversity_strategy(results)
        
        logger.info(f"æ··åˆæ’åºç­–ç•¥åº”ç”¨å®Œæˆï¼Œæœ€ç»ˆç»“æœæ•°é‡: {len(diverse_results)}")
        return diverse_results
        
    except Exception as e:
        logger.error(f"æ··åˆæ’åºç­–ç•¥åº”ç”¨å¤±è´¥: {str(e)}")
        return results

def _calculate_hybrid_score(self, query: str, result: Dict[str, Any]) -> float:
    """è®¡ç®—æ··åˆç›¸å…³æ€§åˆ†æ•°"""
    
    try:
        # åŸºç¡€åˆ†æ•°
        base_score = result.get('relevance_score', 0.5)
        
        # æŸ¥è¯¢ç±»å‹åŒ¹é…åˆ†æ•°
        query_type_score = self._calculate_query_type_match(query, result)
        
        # å†…å®¹è´¨é‡åˆ†æ•°
        quality_score = self._calculate_content_quality(result)
        
        # ç±»å‹æƒé‡ï¼ˆå¯é…ç½®ï¼‰
        type_weights = {
            'text': 1.0,
            'table': 0.9, 
            'image': 0.8
        }
        content_type = result.get('content_type', 'text')
        type_weight = type_weights.get(content_type, 1.0)
        
        # è®¡ç®—æœ€ç»ˆåˆ†æ•°
        final_score = (base_score * 0.4 + 
                       query_type_score * 0.3 + 
                       quality_score * 0.3) * type_weight
        
        return round(final_score, 4)
        
    except Exception as e:
        logger.error(f"æ··åˆåˆ†æ•°è®¡ç®—å¤±è´¥: {str(e)}")
        return 0.5
```

### 3.5 ç»Ÿä¸€Pipelineé›†æˆ

#### 3.5.1 Pipelineè¾“å…¥å‡†å¤‡

```python
def _prepare_pipeline_input(self, reranked_results: List[Any]) -> List[Dict[str, Any]]:
    """å‡†å¤‡Pipelineè¾“å…¥æ ¼å¼"""
    
    pipeline_input = []
    
    for result in reranked_results:
        if isinstance(result, dict):
            # æå–å†…å®¹
            content = (result.get('content') or 
                      result.get('page_content') or 
                      result.get('raw_content') or 
                      str(result))
            
            # æå–å…ƒæ•°æ®
            metadata = result.get('metadata', {})
            if not metadata:
                # ä»ç»“æœä¸­æå–æœ‰ç”¨çš„å…ƒæ•°æ®
                metadata = {
                    'source_engine': result.get('source_engine', 'unknown'),
                    'content_type': result.get('content_type', 'text'),
                    'relevance_score': result.get('relevance_score', 0.0),
                    'hybrid_score': result.get('hybrid_score', 0.0)
                }
            
            # éªŒè¯å†…å®¹ä¸ä¸ºç©º
            if content and content.strip():
                pipeline_input.append({
                    'content': content.strip(),
                    'metadata': metadata
                })
    
    self.logger.info(f"Pipelineè¾“å…¥å‡†å¤‡å®Œæˆï¼Œæœ‰æ•ˆè¾“å…¥æ•°é‡: {len(pipeline_input)}")
    return pipeline_input
```

#### 3.5.2 Pipelineæ‰§è¡Œ

```python
def _execute_unified_pipeline(self, query: str, reranked_results: List[Any], **kwargs) -> Dict[str, Any]:
    """æ‰§è¡Œç»Ÿä¸€Pipelineï¼ˆLLM + æº¯æºï¼‰"""
    
    try:
        # æ£€æŸ¥å¿…è¦ç»„ä»¶
        if not self.llm_engine or not self.source_filter_engine:
            self.logger.warning("LLMå¼•æ“æˆ–æºè¿‡æ»¤å¼•æ“ä¸å¯ç”¨ï¼Œè·³è¿‡Pipelineæ‰§è¡Œ")
            return self._create_fallback_result(reranked_results)
        
        # å‡†å¤‡Pipelineè¾“å…¥
        pipeline_input = self._prepare_pipeline_input(reranked_results)
        
        # åˆ›å»ºPipelineå®ä¾‹
        pipeline_config = {
            'enable_llm_generation': True,
            'enable_source_filtering': True,
            'max_context_results': 10,
            'max_content_length': 1000
        }
        
        pipeline = UnifiedPipeline(pipeline_config, self.llm_engine, self.source_filter_engine)
        
        # æ‰§è¡ŒPipeline
        pipeline_result = pipeline.process(query, pipeline_input, **kwargs)
        
        self.logger.info(f"ç»Ÿä¸€Pipelineæ‰§è¡Œå®Œæˆï¼Œè¾“å‡ºç»“æœ: {len(pipeline_result.get('filtered_results', []))}")
        return pipeline_result
        
    except Exception as e:
        self.logger.error(f"ç»Ÿä¸€Pipelineæ‰§è¡Œå¤±è´¥: {str(e)}")
        return self._create_fallback_result(reranked_results)
```

## 4. å‰ç«¯å±•ç¤ºä¼˜åŒ–

### 4.1 æ™ºèƒ½æŸ¥è¯¢ç•Œé¢

```javascript
// æ™ºèƒ½æŸ¥è¯¢æ¨¡å¼åˆ‡æ¢
function enableSmartQueryMode() {
    // éšè—æŸ¥è¯¢ç±»å‹é€‰æ‹©
    document.querySelectorAll('.preset-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // æ˜¾ç¤ºæ™ºèƒ½æŸ¥è¯¢æç¤º
    const smartIndicator = document.createElement('div');
    smartIndicator.className = 'smart-query-indicator';
    smartIndicator.innerHTML = `
        <div class="smart-query-header">
            <h3>ğŸ¤– æ™ºèƒ½æŸ¥è¯¢æ¨¡å¼</h3>
            <p>ç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«æ‚¨çš„æŸ¥è¯¢ç±»å‹ï¼Œæ— éœ€æ‰‹åŠ¨é€‰æ‹©</p>
        </div>
    `;
    
    document.querySelector('.sidebar').appendChild(smartIndicator);
}

// æ£€æµ‹å¹¶å±•ç¤ºæ··åˆç»“æœ
function displayHybridResults(data) {
    let displayContent = '';
    
    // 1. æ˜¾ç¤ºLLMç”Ÿæˆçš„ç­”æ¡ˆ
    if (data.llm_answer) {
        displayContent += `<div class="llm-answer">${data.llm_answer}</div>`;
    }
    
    // 2. æ ¹æ®å†…å®¹ç±»å‹æ™ºèƒ½å±•ç¤º
    if (data.image_results && data.image_results.length > 0) {
        displayContent += generateImageGallery(data.image_results);
    }
    
    if (data.table_results && data.table_results.length > 0) {
        displayContent += generateTableDisplay(data.table_results);
    }
    
    if (data.text_results && data.text_results.length > 0) {
        displayContent += generateTextSummary(data.text_results);
    }
    
    return displayContent;
}
```

### 4.2 è¡¨æ ¼å±•ç¤ºå®ç°

```javascript
function generateTableDisplay(tableResults) {
    let tableHTML = `
        <hr class="section-divider">
        <h2 class="section-title">ğŸ“Š ç›¸å…³è¡¨æ ¼</h2>
        <div class="tables-section">
    `;
    
    tableResults.forEach((tableResult, index) => {
        tableHTML += `
            <div class="table-card">
                <div class="table-header">
                    <h4>è¡¨æ ¼ ${index + 1}: ${tableResult.table_type || 'æ•°æ®è¡¨æ ¼'}</h4>
                    <div class="table-meta">
                        <span class="doc-name">ğŸ“„ ${tableResult.document_name || 'æœªçŸ¥æ–‡æ¡£'}</span>
                        <span class="page-number">ğŸ“– ç¬¬${tableResult.page_number || 'N/A'}é¡µ</span>
                        <span class="relevance-score">â­ ${(tableResult.score || 0).toFixed(2)}</span>
                    </div>
                </div>
                <div class="table-content">
                    <div class="table-preview">
                        ${formatTableContent(tableResult.table_content)}
                    </div>
                    <div class="table-actions">
                        <button class="view-table-btn" onclick="viewFullTable('${tableResult.id}')">
                            æŸ¥çœ‹å®Œæ•´è¡¨æ ¼
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    tableHTML += `</div>`;
    return tableHTML;
}
```

## 5. å®æ–½è®¡åˆ’

### 5.1 é˜¶æ®µ1ï¼šåŸºç¡€æ”¹é€ ï¼ˆæœ¬å‘¨å®Œæˆï¼‰
- [ ] ä¸ºTextEngineæ·»åŠ recallæ–¹æ³•
- [ ] ä¸ºImageEngineæ·»åŠ recallæ–¹æ³•
- [ ] ä¸ºTableEngineæ·»åŠ recallæ–¹æ³•
- [ ] æµ‹è¯•å„å¼•æ“recallåŠŸèƒ½

### 5.2 é˜¶æ®µ2ï¼šæ··åˆå¼•æ“æ ¸å¿ƒï¼ˆä¸‹å‘¨å®Œæˆï¼‰
- [ ] å®ç°å¹¶è¡Œrecallæ‰§è¡Œ
- [ ] å®Œå–„ç»“æœèåˆé€»è¾‘
- [ ] ä¼˜åŒ–æ··åˆrerankingç­–ç•¥
- [ ] é›†æˆç»Ÿä¸€Pipeline

### 5.3 é˜¶æ®µ3ï¼šæ™ºèƒ½æŸ¥è¯¢å®ç°ï¼ˆä¸‹ä¸‹å‘¨å®Œæˆï¼‰
- [ ] å®ç°æŸ¥è¯¢æ„å›¾åˆ†æå™¨
- [ ] å®ç°æ™ºèƒ½æŸ¥è¯¢å¼•æ“
- [ ] é›†æˆåˆ°å‰ç«¯ç•Œé¢
- [ ] å…¨é¢æµ‹è¯•å’Œè°ƒä¼˜

### 5.4 é˜¶æ®µ4ï¼šå‰ç«¯ä¼˜åŒ–ï¼ˆä¸‹ä¸‹ä¸‹å‘¨å®Œæˆï¼‰
- [ ] å®ç°è¡¨æ ¼å±•ç¤ºåŠŸèƒ½
- [ ] ä¼˜åŒ–æ··åˆç»“æœå±•ç¤º
- [ ] å®Œå–„æ™ºèƒ½æŸ¥è¯¢ç•Œé¢
- [ ] å…¨é¢æµ‹è¯•å’Œè°ƒä¼˜

## 6. é¢„æœŸæ•ˆæœ

### 6.1 æ€§èƒ½æå‡
- æ··åˆæŸ¥è¯¢å“åº”æ—¶é—´å‡å°‘30-50%
- å¹¶è¡Œæ‰§è¡Œæå‡æ•´ä½“æ•ˆç‡
- æ™ºèƒ½è·¯ç”±å‡å°‘ä¸å¿…è¦çš„è®¡ç®—
- é¿å…é‡å¤æ‰§è¡Œrerankingå’ŒPipeline

### 6.2 åŠŸèƒ½å®Œå–„
- æ··åˆæŸ¥è¯¢åŠŸèƒ½å®Œæ•´æ€§è¾¾åˆ°100%
- è·¨æ¨¡æ€ç»“æœèåˆæ›´åŠ æ™ºèƒ½
- æ™ºèƒ½æŸ¥è¯¢è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·æ„å›¾
- ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡

### 6.3 ç³»ç»Ÿç¨³å®šæ€§
- ç»Ÿä¸€çš„Pipelineç¡®ä¿ç»“æœä¸€è‡´æ€§
- å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶
- å‘åå…¼å®¹ç°æœ‰åŠŸèƒ½
- æ”¯æŒæ¸è¿›å¼åŠŸèƒ½å‡çº§

## 7. å…³é”®æŠ€æœ¯è¦ç‚¹

### 7.1 ä¸é™çº§ç­–ç•¥
**æ ¸å¿ƒåŸåˆ™**ï¼šç›´æ¥ä¸ºä¸‰ä¸ªå¼•æ“æ·»åŠ recallæ–¹æ³•ï¼Œä¸ä½¿ç”¨é™çº§ç­–ç•¥

**åŸå› åˆ†æ**ï¼š
- å½“å‰æ··åˆå¼•æ“è°ƒç”¨process_queryä¼šå¯¼è‡´é‡å¤æ‰§è¡Œ
- é™çº§ç­–ç•¥é€»è¾‘å¤æ‚ï¼Œå®¹æ˜“å‡ºé”™
- ç›´æ¥æ”¹é€ æ›´ç®€å•ã€æ›´é«˜æ•ˆ

**å®ç°æ–¹å¼**ï¼š
```python
# ä¸ºæ¯ä¸ªå¼•æ“æ·»åŠ ä¸“é—¨çš„recallæ–¹æ³•
def recall(self, query: str, **kwargs) -> List[Any]:
    """åªæ‰§è¡Œå¬å›ï¼Œä¸æ‰§è¡Œrerankingå’Œpipeline"""
    return self._search_*s(query, **kwargs)  # è°ƒç”¨ç°æœ‰çš„å‘é‡æœç´¢é€»è¾‘
```

### 7.2 æ™ºèƒ½æŸ¥è¯¢å®ç°
**æ ¸å¿ƒæ€æƒ³**ï¼šè‡ªåŠ¨è¯†åˆ«æŸ¥è¯¢æ„å›¾ï¼Œæ™ºèƒ½é€‰æ‹©æŸ¥è¯¢ç­–ç•¥

**å®ç°ç­–ç•¥**ï¼š
- é«˜ç½®ä¿¡åº¦ï¼ˆ>0.8ï¼‰ï¼šç›´æ¥ä½¿ç”¨å•å¼•æ“ï¼Œé¿å…æ··åˆå¼•æ“å¼€é”€
- ä½ç½®ä¿¡åº¦ï¼ˆâ‰¤0.8ï¼‰ï¼šä½¿ç”¨æ··åˆå¼•æ“ï¼Œç¡®ä¿ç»“æœè´¨é‡

**æŠ€æœ¯ä¼˜åŠ¿**ï¼š
- æ¥å£æ ‡å‡†åŒ–ï¼šæ‰€æœ‰å¼•æ“éƒ½æœ‰ç»Ÿä¸€çš„æ¥å£
- åŠŸèƒ½å®Œæ•´ï¼šå•å¼•æ“å’Œæ··åˆå¼•æ“éƒ½èƒ½ç‹¬ç«‹å·¥ä½œ
- çµæ´»è·¯ç”±ï¼šå¯ä»¥æ ¹æ®ç½®ä¿¡åº¦é€‰æ‹©ä¸åŒç­–ç•¥

## 8. é£é™©è¯„ä¼°ä¸åº”å¯¹

### 8.1 ä¸»è¦é£é™©
1. **å…¼å®¹æ€§é—®é¢˜**ï¼šæ–°recallæ–¹æ³•å¯èƒ½å½±å“ç°æœ‰åŠŸèƒ½
2. **æ€§èƒ½é—®é¢˜**ï¼šå¹¶è¡Œæ‰§è¡Œå¯èƒ½å¢åŠ èµ„æºæ¶ˆè€—
3. **æ™ºèƒ½æŸ¥è¯¢å‡†ç¡®æ€§**ï¼šæ„å›¾è¯†åˆ«å¯èƒ½ä¸å¤Ÿå‡†ç¡®

### 8.2 åº”å¯¹ç­–ç•¥
1. **æ¸è¿›å¼æ”¹é€ **ï¼šé€æ­¥æ·»åŠ æ–°åŠŸèƒ½ï¼Œä¿æŒå‘åå…¼å®¹
2. **å……åˆ†æµ‹è¯•**ï¼šæ¯ä¸ªé˜¶æ®µéƒ½è¦è¿›è¡Œå……åˆ†æµ‹è¯•
3. **ç›‘æ§æœºåˆ¶**ï¼šå»ºç«‹æ€§èƒ½ç›‘æ§å’Œé”™è¯¯è¿½è¸ª
4. **ç”¨æˆ·åé¦ˆ**ï¼šæ”¶é›†ç”¨æˆ·åé¦ˆï¼ŒæŒç»­ä¼˜åŒ–æ™ºèƒ½æŸ¥è¯¢

## 9. æŠ€æœ¯æ¶æ„ä¼˜åŠ¿

### 9.1 æ¨¡å—åŒ–è®¾è®¡
- å„å¼•æ“èŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
- æ··åˆé€»è¾‘ä¸å•å¼•æ“é€»è¾‘åˆ†ç¦»
- æ”¯æŒçµæ´»çš„åŠŸèƒ½æ‰©å±•

### 9.2 æ€§èƒ½ä¼˜åŒ–
- å¹¶è¡Œæ‰§è¡Œæå‡å“åº”é€Ÿåº¦
- æ™ºèƒ½è·¯ç”±å‡å°‘æ— æ•ˆè®¡ç®—
- é¿å…é‡å¤æ‰§è¡Œï¼Œæå‡æ•´ä½“æ•ˆç‡

### 9.3 å¯æ‰©å±•æ€§
- æ”¯æŒæ–°å¼•æ“ç±»å‹çš„æ·»åŠ 
- æ”¯æŒæ–°çš„rerankingç­–ç•¥
- æ”¯æŒæ–°çš„Pipelineç»„ä»¶
- æ”¯æŒæ™ºèƒ½æŸ¥è¯¢çš„æŒç»­ä¼˜åŒ–

## 10. æ€»ç»“

æ··åˆå¼•æ“å†é€ æ˜¯RAGç³»ç»ŸV2.0çš„é‡è¦é‡Œç¨‹ç¢‘ï¼Œé€šè¿‡å®ç°æ™ºèƒ½è·¯ç”±ã€è·¨æ¨¡æ€èåˆã€ç»Ÿä¸€Pipelineå’Œæ™ºèƒ½æŸ¥è¯¢ï¼Œå¯ä»¥æ˜¾è‘—æå‡ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚

**å…³é”®æ”¹è¿›ç‚¹**ï¼š
1. **ä¸é™çº§ç­–ç•¥**ï¼šç›´æ¥ä¸ºä¸‰ä¸ªå¼•æ“æ·»åŠ recallæ–¹æ³•ï¼Œé€»è¾‘æ¸…æ™°ï¼Œæ€§èƒ½æ›´å¥½
2. **æ™ºèƒ½æŸ¥è¯¢**ï¼šè‡ªåŠ¨è¯†åˆ«æŸ¥è¯¢æ„å›¾ï¼Œæ ¹æ®ç½®ä¿¡åº¦é€‰æ‹©æœ€ä¼˜ç­–ç•¥
3. **ç»Ÿä¸€Pipeline**ï¼šæ‰€æœ‰å¼•æ“å…±äº«ç›¸åŒçš„å¤„ç†æµç¨‹ï¼Œç¡®ä¿ç»“æœä¸€è‡´æ€§
4. **å¹¶è¡Œæ‰§è¡Œ**ï¼šçœŸæ­£çš„å¹¶è¡Œrecallï¼Œé¿å…é‡å¤è®¡ç®—

è¿™ä¸ªæ–¹æ¡ˆæ—¢ä¿æŒäº†ç°æœ‰åŠŸèƒ½çš„ç¨³å®šæ€§ï¼Œåˆä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•å¥ å®šäº†åšå®çš„åŸºç¡€ï¼Œç‰¹åˆ«æ˜¯ä¸ºæ™ºèƒ½æŸ¥è¯¢çš„å®ç°æä¾›äº†è‰¯å¥½çš„æ¶æ„æ”¯æŒã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0  
**åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ27æ—¥  
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ27æ—¥  
**è´Ÿè´£äºº**: AIåŠ©æ‰‹  
**çŠ¶æ€**: å¾…å®æ–½  
**ä¼˜å…ˆçº§**: é«˜  
**ä¸»è¦å˜æ›´**: ä¼˜åŒ–äº†ä¸é™çº§ç­–ç•¥ï¼Œæ–°å¢æ™ºèƒ½æŸ¥è¯¢å®ç°æ–¹æ¡ˆ