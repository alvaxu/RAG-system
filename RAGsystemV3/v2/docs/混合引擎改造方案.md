å®Œå…¨æ­£ç¡®ï¼ç°åœ¨æˆ‘å®Œå…¨ç†è§£äº†è®¾è®¡ç†å¿µã€‚è®©æˆ‘é‡æ–°æ•´ç†ä¸€ä¸‹ï¼š

## ğŸ¯ **HybridEngine ç®€åŒ–æ”¹é€ æ–¹æ¡ˆï¼ˆæœ€ç»ˆç‰ˆï¼‰**

### **1. æ ¸å¿ƒè®¾è®¡ç†å¿µ**

- **æ‰€æœ‰å¼•æ“éƒ½ä½¿ç”¨æ–°Pipeline**ï¼šLLM + æº¯æºï¼Œæ²¡æœ‰æ—§pipeline
- **Reranking Service ç»Ÿä¸€æ€§**ï¼šæ··åˆreranking service å’Œå•å¼•æ“å„è‡ªçš„reranking service ç›®çš„å’Œè®¾è®¡ç†å¿µå®Œå…¨ä¸€æ ·
- **æµç¨‹ç»Ÿä¸€**ï¼šrecall â†’ reranking â†’ æ–°pipelineï¼ˆLLM + æº¯æºï¼‰

### **2. ä¿®æ­£åçš„è¯¦ç»†æµç¨‹å›¾**

```mermaid
flowchart TD
    A[æŸ¥è¯¢å¼€å§‹] --> B{æ£€æŸ¥æŸ¥è¯¢æ¨¡å¼}
    
    B -->|æŒ‡å®šç±»å‹| C[å•å¼•æ“æ¨¡å¼]
    B -->|æ™ºèƒ½å¼•æ“| D[æ™ºèƒ½åˆ¤æ–­æ¨¡å¼]
    B -->|æ··åˆå¼•æ“| E[æ··åˆå¼•æ“æ¨¡å¼]
    
    C --> C1[é€‰æ‹©æŒ‡å®šå¼•æ“]
    C1 --> C2[æ‰§è¡Œå¼•æ“recall]
    C2 --> C3[æ‰§è¡Œå¼•æ“reranking service]
    C3 --> C4[è°ƒç”¨æ–°Pipeline<br/>LLM + æº¯æº]
    
    D --> D1[åˆ†ææŸ¥è¯¢è¯­ä¹‰]
    D1 --> D2{èƒ½å¦ç¡®å®šç±»å‹?}
    D2 -->|èƒ½| F[é€‰æ‹©å•å¼•æ“]
    D2 -->|ä¸èƒ½| E
    
    F --> F1[æ‰§è¡Œå¼•æ“recall]
    F1 --> F2[æ‰§è¡Œå¼•æ“reranking service]
    F2 --> F3[è°ƒç”¨æ–°Pipeline<br/>LLM + æº¯æº]
    
    E --> E1[å¹¶è¡Œæ‰§è¡Œä¸‰å¼•æ“recall]
    E1 --> E2[èåˆrecallç»“æœ]
    E2 --> E3[è°ƒç”¨æ··åˆreranking service]
    E3 --> E4[è°ƒç”¨æ–°Pipeline<br/>LLM + æº¯æº]
    
    C4 --> G[æ„å»ºæœ€ç»ˆç»“æœ]
    F3 --> G
    E4 --> G
    
    G --> H[æŸ¥è¯¢ç»“æŸ]
```

### **3. ç®€åŒ–åçš„æ ¸å¿ƒåŠŸèƒ½**

#### **ä¿ç•™çš„æ ¸å¿ƒåŠŸèƒ½**
1. **æ™ºèƒ½è·¯ç”±**ï¼šæ ¹æ®æŸ¥è¯¢ç±»å‹é€‰æ‹©å•ä¸ªå¼•æ“æˆ–æ··åˆå¼•æ“
2. **æ™ºèƒ½åˆ¤æ–­**ï¼šé€šè¿‡è¯­ä¹‰åˆ†æé€‰æ‹©æœ€åˆé€‚çš„å•å¼•æ“
3. **ç»“æœèåˆ**ï¼šæ··åˆæ¨¡å¼ä¸‹èåˆä¸‰ä¸ªå¼•æ“çš„recallç»“æœ
4. **æ··åˆreranking**ï¼šä¸“é—¨çš„æ··åˆreranking service
5. **æ–°Pipelineé›†æˆ**ï¼šç»Ÿä¸€è°ƒç”¨æ–°pipelineï¼ˆLLM + æº¯æºï¼‰

#### **åˆ é™¤çš„å†—ä½™åŠŸèƒ½**
1. å¤æ‚çš„æ„å›¾åˆ†æå™¨
2. åºå¤§çš„ç»“æœèåˆå™¨
3. æ—§çš„ä¼˜åŒ–ç®¡é“
4. æ™ºèƒ½åå¤„ç†å¼•æ“
5. å¤æ‚çš„è´¨é‡è¯„ä¼°å’Œæ’åºç®—æ³•

### **4. ä»£ç ç»“æ„ç®€åŒ–**

```python
class HybridEngine:
    def process_query(self, query: str, **kwargs) -> QueryResult:
        # 1. è·¯ç”±åˆ¤æ–­
        # 2. è°ƒç”¨å¯¹åº”å¤„ç†æ–¹æ³•
        
    def _handle_single_engine_query(self, query: str, engine_type: str, **kwargs):
        # å•å¼•æ“ï¼šrecall â†’ reranking â†’ æ–°pipeline
        
    def _handle_smart_engine_query(self, query: str, **kwargs):
        # æ™ºèƒ½åˆ¤æ–­ï¼šè¯­ä¹‰åˆ†æ â†’ é€‰æ‹©å¼•æ“ â†’ å•å¼•æ“æµç¨‹
        
    def _handle_hybrid_engine_query(self, query: str, **kwargs):
        # æ··åˆå¼•æ“ï¼šä¸‰å¼•æ“recall â†’ èåˆ â†’ æ··åˆreranking â†’ æ–°pipeline
```

### **5. å…³é”®ä¼˜åŠ¿**

1. **ä»£ç é‡å¤§å¹…å‡å°‘**ï¼šä»2000+è¡Œå‡å°‘åˆ°300-500è¡Œ
2. **é€»è¾‘æ¸…æ™°**ï¼šä¸‰ç§æ¨¡å¼èŒè´£æ˜ç¡®ï¼Œæµç¨‹ç»Ÿä¸€
3. **ç»´æŠ¤ç®€å•**ï¼šæ²¡æœ‰å¤æ‚çš„èåˆé€»è¾‘ï¼Œæ˜“äºè°ƒè¯•
4. **æ€§èƒ½æå‡**ï¼šå‡å°‘ä¸å¿…è¦çš„å¤„ç†æ­¥éª¤
5. **æ‰©å±•æ€§å¥½**ï¼šæ–°å¢å¼•æ“ç±»å‹åªéœ€æ·»åŠ å¯¹åº”å¤„ç†æ–¹æ³•

è¿™æ ·çš„è®¾è®¡æ—¢ä¿æŒäº†åŠŸèƒ½çš„å®Œæ•´æ€§ï¼Œåˆå¤§å¤§ç®€åŒ–äº†ä»£ç ç»“æ„ï¼Œæ‚¨è§‰å¾—å¦‚ä½•ï¼Ÿ


å¥½çš„ï¼æˆ‘æ¥ä»”ç»†åˆ†æåŸæœ‰æ··åˆå¼•æ“ä¸­çš„å„ç§æ¥å£ï¼Œç¡®ä¿èƒ½å¯¹æ¥webå‰ç«¯è·¯ç”±è¿‡æ¥çš„è¯·æ±‚ï¼Œå¹¶ç¡®ä¿å„é¡¹é…ç½®çš„ä¼ é€’æ­£ç¡®æ€§ã€‚

## ï¿½ï¿½ **åŸæœ‰æ··åˆå¼•æ“æ¥å£åˆ†æ**

è®©æˆ‘å…ˆæŸ¥çœ‹å½“å‰çš„ `hybrid_engine.py` æ–‡ä»¶ï¼Œåˆ†æå…¶ä¸­çš„æ¥å£å’Œé…ç½®ä¼ é€’ï¼š

Read file: v2/core/hybrid_engine.py
è®©æˆ‘ç»§ç»­æŸ¥çœ‹æ›´å¤šçš„æ¥å£å®šä¹‰ï¼š

Read file: v2/core/hybrid_engine.py
è®©æˆ‘æŸ¥çœ‹webå‰ç«¯è·¯ç”±ç›¸å…³çš„æ¥å£ï¼š

Ran tool
Read file: v2/core/hybrid_engine.py
è®©æˆ‘æŸ¥çœ‹webå‰ç«¯è·¯ç”±çš„é…ç½®ï¼š

Read file: v2/api/v2_routes.py
è®©æˆ‘æŸ¥çœ‹webå‰ç«¯çš„æŸ¥è¯¢æ¥å£ï¼š

Ran tool
Read file: v2/api/v2_routes.py
è®©æˆ‘æŸ¥çœ‹webå‰ç«¯çš„é…ç½®ä¼ é€’ï¼š

Ran tool
ç°åœ¨è®©æˆ‘æŸ¥çœ‹webå‰ç«¯çš„HTMLï¼Œäº†è§£å‰ç«¯å¦‚ä½•å‘é€è¯·æ±‚ï¼š

Read file: v2/web/v2_index.html
è®©æˆ‘æŸ¥çœ‹å‰ç«¯æŸ¥è¯¢ç±»å‹é€‰æ‹©çš„JavaScriptä»£ç ï¼š

Ran tool
Ran tool
ç°åœ¨è®©æˆ‘æŸ¥çœ‹å‰ç«¯å‘é€è¯·æ±‚çš„å…·ä½“ä»£ç ï¼š

Read file: v2/web/v2_index.html
åŸºäºæˆ‘çš„åˆ†æï¼Œç°åœ¨æˆ‘æ¥æ€»ç»“åŸæœ‰æ··åˆå¼•æ“ä¸­çš„å„ç§æ¥å£çš„ç»Ÿä¸€æ€§ï¼Œå¹¶ç¡®ä¿èƒ½å¯¹æ¥webå‰ç«¯è·¯ç”±è¿‡æ¥çš„è¯·æ±‚ï¼š

## ï¿½ï¿½ **åŸæœ‰æ··åˆå¼•æ“æ¥å£åˆ†ææ€»ç»“**

### **1. Webå‰ç«¯æ¥å£åˆ†æ**

#### **å‰ç«¯å‘é€çš„è¯·æ±‚æ ¼å¼**
```javascript
// å‰ç«¯å‘é€åˆ° /api/v2/qa/ask çš„è¯·æ±‚ä½“
{
    question: "ç”¨æˆ·é—®é¢˜",
    session_id: "ä¼šè¯ID",
    query_type: "hybrid|text|image|table|smart"  // æŸ¥è¯¢ç±»å‹
}
```

#### **å‰ç«¯æ”¯æŒçš„æŸ¥è¯¢ç±»å‹**
1. **`hybrid`** - æ··åˆæŸ¥è¯¢ï¼ˆåŒæ—¶æ‰§è¡Œä¸‰ä¸ªå¼•æ“ï¼‰
2. **`text`** - æ–‡æœ¬æŸ¥è¯¢
3. **`image`** - å›¾ç‰‡æŸ¥è¯¢  
4. **`table`** - è¡¨æ ¼æŸ¥è¯¢
5. **`smart`** - æ™ºèƒ½æŸ¥è¯¢ï¼ˆè‡ªåŠ¨åˆ¤æ–­ç±»å‹ï¼‰

### **2. åç«¯è·¯ç”±æ¥å£åˆ†æ**

#### **v2_routes.py ä¸­çš„å¤„ç†é€»è¾‘**
```python
# æ ¹æ®æŸ¥è¯¢ç±»å‹è°ƒç”¨æ··åˆå¼•æ“
if query_type == 'hybrid':
    result = hybrid_engine.process_query(question, query_type='hybrid', max_results=max_results)
elif query_type == 'image':
    result = hybrid_engine.process_query(question, query_type=QueryType.IMAGE, max_results=max_results)
elif query_type == 'text':
    result = hybrid_engine.process_query(question, query_type=QueryType.TEXT, max_results=max_results)
elif query_type == 'table':
    result = hybrid_engine.process_query(question, query_type=QueryType.TABLE, max_results=max_results)
elif query_type == 'smart':
    # æ™ºèƒ½åˆ¤æ–­é€»è¾‘
```

### **3. æ··åˆå¼•æ“æ¥å£ç»Ÿä¸€æ€§åˆ†æ**

#### **å½“å‰æ¥å£è®¾è®¡**
```python
def process_query(self, query: str, **kwargs) -> QueryResult:
    # æ”¯æŒçš„å…³é”®å­—å‚æ•°ï¼š
    # - query_type: æŸ¥è¯¢ç±»å‹
    # - max_results: æœ€å¤§ç»“æœæ•°
    # - å…¶ä»–å¼•æ“ç‰¹å®šå‚æ•°
```

#### **æ¥å£ç»Ÿä¸€æ€§ç¡®è®¤**
âœ… **æŸ¥è¯¢ç±»å‹ä¼ é€’**ï¼šå‰ç«¯ `query_type` â†’ åç«¯ `QueryType.XXX` â†’ æ··åˆå¼•æ“ `query_type`  
âœ… **å‚æ•°ä¼ é€’**ï¼š`max_results` ç­‰å‚æ•°æ­£ç¡®ä¼ é€’  
âœ… **è¿”å›æ ¼å¼**ï¼šç»Ÿä¸€è¿”å› `QueryResult` å¯¹è±¡  
âœ… **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†å’Œé”™è¯¯è¿”å›æ ¼å¼  

### **4. é…ç½®ä¼ é€’æ­£ç¡®æ€§åˆ†æ**

#### **é…ç½®ä¼ é€’é“¾è·¯**
```
V2ConfigManager â†’ HybridEngine â†’ å­å¼•æ“ â†’ æ–°Pipeline
```

#### **å…³é”®é…ç½®é¡¹**
1. **å¼•æ“æƒé‡é…ç½®**ï¼š`image_weight`, `text_weight`, `table_weight`
2. **ä¼˜åŒ–ç®¡é“é…ç½®**ï¼š`optimization_pipeline.enabled`
3. **é‡æ’åºé…ç½®**ï¼š`reranking.similarity_threshold`
4. **æºè¿‡æ»¤é…ç½®**ï¼š`source_filter_engine.relevance_threshold`

### **5. ç®€åŒ–åçš„æ¥å£è®¾è®¡**

åŸºäºåˆ†æï¼Œæˆ‘å»ºè®®ä¿æŒä»¥ä¸‹æ¥å£ä¸å˜ï¼Œç¡®ä¿å…¼å®¹æ€§ï¼š

#### **ä¿æŒçš„æ ¸å¿ƒæ¥å£**
```python
class HybridEngine:
    def process_query(self, query: str, **kwargs) -> QueryResult:
        """
        ç»Ÿä¸€çš„æŸ¥è¯¢æ¥å£ï¼Œæ”¯æŒæ‰€æœ‰æŸ¥è¯¢ç±»å‹
        
        :param query: æŸ¥è¯¢æ–‡æœ¬
        :param kwargs: æ”¯æŒçš„å…³é”®å­—å‚æ•°ï¼š
            - query_type: æŸ¥è¯¢ç±»å‹ ('hybrid', 'text', 'image', 'table', 'smart')
            - max_results: æœ€å¤§ç»“æœæ•°
            - å…¶ä»–å¼•æ“ç‰¹å®šå‚æ•°
        :return: QueryResult å¯¹è±¡
        """
```

#### **ç®€åŒ–çš„å†…éƒ¨æ–¹æ³•**
```python
    def _handle_single_engine_query(self, query: str, query_type: str, **kwargs):
        """å•å¼•æ“æŸ¥è¯¢å¤„ç†"""
        
    def _handle_smart_engine_query(self, query: str, **kwargs):
        """æ™ºèƒ½æŸ¥è¯¢å¤„ç†"""
        
    def _handle_hybrid_engine_query(self, query: str, **kwargs):
        """æ··åˆæŸ¥è¯¢å¤„ç†"""
```

### **6. å…¼å®¹æ€§ä¿è¯**

#### **å‰ç«¯å…¼å®¹æ€§**
- âœ… ä¿æŒç°æœ‰çš„ `/api/v2/qa/ask` æ¥å£
- âœ… ä¿æŒç°æœ‰çš„è¯·æ±‚å‚æ•°æ ¼å¼
- âœ… ä¿æŒç°æœ‰çš„å“åº”æ ¼å¼

#### **é…ç½®å…¼å®¹æ€§**
- âœ… ä¿æŒç°æœ‰çš„é…ç½®åŠ è½½æ–¹å¼
- âœ… ä¿æŒç°æœ‰çš„å‚æ•°ä¼ é€’æ–¹å¼
- âœ… ä¿æŒç°æœ‰çš„é”™è¯¯å¤„ç†æ–¹å¼

### **7. æ”¹é€ å®Œæˆç¡®è®¤**

ä¸€æ—¦è¿™ä¸ªç®€åŒ–å®Œæˆï¼Œtextã€imageã€table å°±éƒ½æ”¹é€ å®Œæˆäº†ï¼Œå› ä¸ºï¼š

1. **TextEngine** âœ… å·²ä½¿ç”¨æ–°Pipeline
2. **ImageEngine** âœ… å·²æœ‰è‡ªå·±çš„å¬å›å’Œreranking
3. **TableEngine** âœ… å·²ä½¿ç”¨æ–°Pipeline
4. **HybridEngine** ğŸ”„ å³å°†ç®€åŒ–å®Œæˆï¼Œç»Ÿä¸€è°ƒç”¨æ–°Pipeline

æ‚¨è§‰å¾—è¿™ä¸ªåˆ†æå‡†ç¡®å—ï¼Ÿæˆ‘å¯ä»¥å¼€å§‹å®æ–½ç®€åŒ–æ”¹é€ äº†ã€‚