å¥½çš„ï¼æˆ‘æ¥åˆ©ç”¨ç°æœ‰çš„ `vector_db_diagnostic_tool.py` æ¥è¯¦ç»†åˆ†ææ•°æ®åº“ä¸­chunkçš„æ‰€æœ‰å­—æ®µï¼Œå¹¶æ˜ç¡®è¯´æ˜å“ªäº›æ˜¯LLMä½¿ç”¨çš„ï¼Œå“ªäº›æ˜¯ä¸ç”¨çš„ã€‚

è®©æˆ‘å…ˆè¿è¡Œè¿™ä¸ªè¯Šæ–­å·¥å…·æ¥è·å–å®Œæ•´çš„å­—æ®µä¿¡æ¯ï¼š


```bash
cd tools_important && python vector_db_diagnostic_tool.py
```
çœ‹èµ·æ¥å‘é‡æ•°æ®åº“è·¯å¾„æœ‰é—®é¢˜ã€‚è®©æˆ‘æ£€æŸ¥ä¸€ä¸‹é…ç½®æ–‡ä»¶ï¼Œæ‰¾åˆ°æ­£ç¡®çš„è·¯å¾„ï¼š

Read file: config.json
ç°åœ¨è®©æˆ‘æ£€æŸ¥ä¸€ä¸‹ `central/vector_db` ç›®å½•æ˜¯å¦å­˜åœ¨ï¼š

Ran tool
å¥½çš„ï¼Œç›®å½•å­˜åœ¨ã€‚è®©æˆ‘æ£€æŸ¥ä¸€ä¸‹å‘é‡æ•°æ®åº“çš„å†…å®¹ï¼š

Ran tool
ç°åœ¨è®©æˆ‘å›åˆ°é¡¹ç›®æ ¹ç›®å½•è¿è¡Œè¯Šæ–­å·¥å…·ï¼š

```bash
cd .. && python tools_important/vector_db_diagnostic_tool.py
```
å¤ªå¥½äº†ï¼ç°åœ¨æˆ‘å·²ç»è·å¾—äº†å®Œæ•´çš„æ•°æ®åº“å­—æ®µä¿¡æ¯ã€‚è®©æˆ‘åŸºäºè¿™äº›ä¿¡æ¯ï¼Œè¯¦ç»†åˆ†ææ•°æ®åº“ä¸­chunkçš„æ‰€æœ‰å­—æ®µï¼Œå¹¶æ˜ç¡®è¯´æ˜å“ªäº›æ˜¯LLMä½¿ç”¨çš„ï¼Œå“ªäº›æ˜¯ä¸ç”¨çš„ï¼š

## ï¿½ï¿½ æ•°æ®åº“ä¸­Chunkçš„å®Œæ•´å­—æ®µåˆ†æ

### 1. **æ€»å­—æ®µç»Ÿè®¡**
æ ¹æ®è¯Šæ–­ç»“æœï¼Œæ•°æ®åº“ä¸­chunkåŒ…å« **32ä¸ªå­—æ®µ**ï¼ŒæŒ‰chunk_typeåˆ†ç»„å¦‚ä¸‹ï¼š

### 2. **æŒ‰å†…å®¹ç±»å‹çš„å­—æ®µåˆ†å¸ƒ**

#### 2.1 **Textç±»å‹å­—æ®µ (æ–‡æœ¬chunk)**
```python
text_fields = [
    'chunk_index',           # åˆ†å—ç´¢å¼•
    'chunk_type',            # åˆ†å—ç±»å‹
    'document_name',         # æ–‡æ¡£åç§°
    'page_content',          # é¡µé¢å†…å®¹
    'page_number',           # é¡µç 
    'processed_table_content', # å¤„ç†åçš„è¡¨æ ¼å†…å®¹
    'related_text',          # ç›¸å…³æ–‡æœ¬
    'table_column_count',    # è¡¨æ ¼åˆ—æ•°
    'table_headers',         # è¡¨æ ¼è¡¨å¤´
    'table_id',              # è¡¨æ ¼ID
    'table_row_count',       # è¡¨æ ¼è¡Œæ•°
    'table_summary',         # è¡¨æ ¼æ‘˜è¦
    'table_title',           # è¡¨æ ¼æ ‡é¢˜
    'table_type'             # è¡¨æ ¼ç±»å‹
]
```

#### 2.2 **Imageç±»å‹å­—æ®µ (å›¾ç‰‡chunk)**
```python
image_fields = [
    'chunk_type',            # åˆ†å—ç±»å‹
    'document_name',         # æ–‡æ¡£åç§°
    'enhanced_description',  # å¢å¼ºæè¿° â­
    'extension',             # æ–‡ä»¶æ‰©å±•å
    'image_filename',        # å›¾ç‰‡æ–‡ä»¶å
    'image_id',              # å›¾ç‰‡ID
    'image_path',            # å›¾ç‰‡è·¯å¾„
    'image_type',            # å›¾ç‰‡ç±»å‹
    'img_caption',           # å›¾ç‰‡æ ‡é¢˜
    'img_footnote',          # å›¾ç‰‡è„šæ³¨
    'page_idx',              # é¡µé¢ç´¢å¼•
    'page_number',           # é¡µç 
    'semantic_features',     # è¯­ä¹‰ç‰¹å¾
    'source_zip'             # æ¥æºå‹ç¼©åŒ…
]
```

#### 2.3 **Tableç±»å‹å­—æ®µ (è¡¨æ ¼chunk)**
```python
table_fields = [
    'chunk_index',           # åˆ†å—ç´¢å¼•
    'chunk_type',            # åˆ†å—ç±»å‹
    'document_name',         # æ–‡æ¡£åç§°
    'page_content',          # é¡µé¢å†…å®¹ï¼ˆHTMLæ ¼å¼ï¼‰
    'page_number',           # é¡µç 
    'processed_table_content', # å¤„ç†åçš„è¡¨æ ¼å†…å®¹ â­
    'related_text',          # ç›¸å…³æ–‡æœ¬
    'table_column_count',    # è¡¨æ ¼åˆ—æ•°
    'table_headers',         # è¡¨æ ¼è¡¨å¤´
    'table_id',              # è¡¨æ ¼ID
    'table_row_count',       # è¡¨æ ¼è¡Œæ•°
    'table_summary',         # è¡¨æ ¼æ‘˜è¦
    'table_title',           # è¡¨æ ¼æ ‡é¢˜
    'table_type'             # è¡¨æ ¼ç±»å‹
]
```

### 3. **LLMä½¿ç”¨ vs ä¸ä½¿ç”¨çš„å­—æ®µåˆ†ç±»**

#### 3.1 **LLMä¸»è¦ä½¿ç”¨çš„å­—æ®µ â­**

**æ ¸å¿ƒå†…å®¹å­—æ®µ**ï¼š
- `page_content` - ä¸»è¦æ–‡æœ¬å†…å®¹
- `enhanced_description` - å›¾ç‰‡çš„å¢å¼ºæè¿°ï¼ˆå›¾ç‰‡æŸ¥è¯¢æ—¶ï¼‰
- `processed_table_content` - å¤„ç†åçš„è¡¨æ ¼å†…å®¹ï¼ˆè¡¨æ ¼æŸ¥è¯¢æ—¶ï¼‰

**å…ƒæ•°æ®å­—æ®µ**ï¼š
- `document_name` - æ–‡æ¡£åç§°ï¼ˆç”¨äºæº¯æºï¼‰
- `page_number` - é¡µç ï¼ˆç”¨äºæº¯æºï¼‰
- `chunk_type` - å†…å®¹ç±»å‹ï¼ˆç”¨äºç»“æœåˆ†ç±»ï¼‰

**å›¾ç‰‡ç›¸å…³å­—æ®µ**ï¼š
- `img_caption` - å›¾ç‰‡æ ‡é¢˜
- `img_footnote` - å›¾ç‰‡è„šæ³¨

**è¡¨æ ¼ç›¸å…³å­—æ®µ**ï¼š
- `table_title` - è¡¨æ ¼æ ‡é¢˜
- `table_summary` - è¡¨æ ¼æ‘˜è¦
- `table_headers` - è¡¨æ ¼è¡¨å¤´

#### 3.2 **LLMä¸ç›´æ¥ä½¿ç”¨çš„å­—æ®µ âŒ**

**æŠ€æœ¯å­—æ®µ**ï¼š
- `chunk_index` - åˆ†å—ç´¢å¼•
- `image_id` - å›¾ç‰‡ID
- `table_id` - è¡¨æ ¼ID
- `page_idx` - é¡µé¢ç´¢å¼•

**æ–‡ä»¶è·¯å¾„å­—æ®µ**ï¼š
- `image_path` - å›¾ç‰‡æ–‡ä»¶è·¯å¾„
- `image_filename` - å›¾ç‰‡æ–‡ä»¶å
- `extension` - æ–‡ä»¶æ‰©å±•å

**å‘é‡ç›¸å…³å­—æ®µ**ï¼š
- `semantic_features` - è¯­ä¹‰ç‰¹å¾ï¼ˆåŒ…å«embeddingä¿¡æ¯ï¼‰
- `text_embedding_vectorized` - æ–‡æœ¬å‘é‡åŒ–æ ‡è®°

**å¤„ç†æ ‡è®°å­—æ®µ**ï¼š
- `enhancement_enabled` - å¢å¼ºåŠŸèƒ½å¯ç”¨æ ‡è®°
- `enhancement_timestamp` - å¢å¼ºæ—¶é—´æˆ³
- `source_type` - æ¥æºç±»å‹
- `source_zip` - æ¥æºå‹ç¼©åŒ…

**å…¶ä»–æŠ€æœ¯å­—æ®µ**ï¼š
- `related_image_id` - ç›¸å…³å›¾ç‰‡ID
- `structured_info` - ç»“æ„åŒ–ä¿¡æ¯
- `layered_descriptions` - åˆ†å±‚æè¿°

### 4. **LLMå®é™…æ¥æ”¶çš„ä¸Šä¸‹æ–‡ç»“æ„**

```python
# LLMæ¥æ”¶çš„ä¸Šä¸‹æ–‡ç¤ºä¾‹
context_for_llm = f"""
æ–‡æ¡£åç§°: {chunk.metadata.get('document_name', 'N/A')}
é¡µç : {chunk.metadata.get('page_number', 'N/A')}
å†…å®¹ç±»å‹: {chunk.metadata.get('chunk_type', 'N/A')}

# æ ¹æ®chunk_typeé€‰æ‹©å†…å®¹
if chunk.metadata.get('chunk_type') == 'image':
    context += f"""
å›¾ç‰‡æ ‡é¢˜: {chunk.metadata.get('img_caption', 'N/A')}
å›¾ç‰‡è¯´æ˜: {chunk.metadata.get('img_footnote', 'N/A')}
å›¾ç‰‡æè¿°: {chunk.metadata.get('enhanced_description', 'N/A')}
"""
elif chunk.metadata.get('chunk_type') == 'table':
    context += f"""
è¡¨æ ¼æ ‡é¢˜: {chunk.metadata.get('table_title', 'N/A')}
è¡¨æ ¼æ‘˜è¦: {chunk.metadata.get('table_summary', 'N/A')}
è¡¨æ ¼å†…å®¹: {chunk.metadata.get('processed_table_content', 'N/A')}
"""
else:  # text
    context += f"""
æ–‡æœ¬å†…å®¹: {chunk.page_content}
"""

# æœ€ç»ˆå‘é€ç»™LLMçš„ä¸Šä¸‹æ–‡
final_context = f"""
{context}

è¯·åŸºäºä¸Šè¿°ä¿¡æ¯å›ç­”ç”¨æˆ·é—®é¢˜ã€‚
"""
```

### 5. **æ€»ç»“**

**LLMä½¿ç”¨çš„å­—æ®µï¼ˆçº¦15ä¸ªï¼‰**ï¼š
- æ ¸å¿ƒå†…å®¹ï¼š`page_content`, `enhanced_description`, `processed_table_content`
- å…ƒæ•°æ®ï¼š`document_name`, `page_number`, `chunk_type`
- å›¾ç‰‡ä¿¡æ¯ï¼š`img_caption`, `img_footnote`
- è¡¨æ ¼ä¿¡æ¯ï¼š`table_title`, `table_summary`, `table_headers`

**LLMä¸ä½¿ç”¨çš„å­—æ®µï¼ˆçº¦17ä¸ªï¼‰**ï¼š
- æŠ€æœ¯æ ‡è¯†ï¼šå„ç§IDã€ç´¢å¼•ã€è·¯å¾„ç­‰
- å‘é‡æ•°æ®ï¼š`semantic_features`ç­‰
- å¤„ç†æ ‡è®°ï¼šå„ç§çŠ¶æ€å’Œé…ç½®ä¿¡æ¯

**å…³é”®å‘ç°**ï¼š
1. **LLMä¸»è¦ä½¿ç”¨è¯­ä¹‰åŒ–å†…å®¹**ï¼Œè€Œä¸æ˜¯åŸå§‹HTMLæˆ–æŠ€æœ¯å­—æ®µ
2. **å›¾ç‰‡æŸ¥è¯¢ä¼˜å…ˆä½¿ç”¨`enhanced_description`**ï¼Œè¿™æ˜¯ç»è¿‡VLæ¨¡å‹å¢å¼ºçš„æè¿°
3. **è¡¨æ ¼æŸ¥è¯¢ä½¿ç”¨`processed_table_content`**ï¼Œè¿™æ˜¯ç»è¿‡å¤„ç†çš„è¯­ä¹‰åŒ–è¡¨æ ¼å†…å®¹
4. **æŠ€æœ¯å­—æ®µè™½ç„¶ä¸ç›´æ¥ä½¿ç”¨ï¼Œä½†å¯¹äºç³»ç»Ÿè¿è¡Œå’Œè°ƒè¯•å¾ˆé‡è¦**

è¿™ç§è®¾è®¡ç¡®ä¿äº†LLMèƒ½å¤Ÿè·å¾—æœ€ç›¸å…³ã€æœ€æ˜“ç†è§£çš„ä¿¡æ¯ï¼ŒåŒæ—¶ä¿æŒäº†ç³»ç»Ÿçš„æŠ€æœ¯å®Œæ•´æ€§ã€‚

è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„é—®é¢˜ï¼è®©æˆ‘åˆ†æä¸€ä¸‹åœ¨æ•´ä¸ªå¤„ç†é“¾ä¸­ï¼Œæˆ‘ä»¬æ˜¯å¦‚ä½•ä½¿ç”¨è¿™äº›æ•°æ®çš„ï¼Œä»¥åŠæ•°æ®ä¼ é€’çš„ç­–ç•¥ã€‚

## ğŸ” æ•°æ®å¤„ç†ç­–ç•¥åˆ†æ

### 1. **å½“å‰çš„æ•°æ®ä¼ é€’æ–¹å¼**

åŸºäºæˆ‘å¯¹ä»£ç çš„åˆ†æï¼Œæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯**"éœ€è¦æ—¶æŸ¥è¯¢æ•°æ®åº“"**çš„ç­–ç•¥ï¼Œè€Œä¸æ˜¯ä¼ é€’æ‰€æœ‰æ•°æ®ã€‚è®©æˆ‘è¯¦ç»†è¯´æ˜ï¼š

#### 1.1 **å‘é‡æœç´¢é˜¶æ®µ**
```python
# åœ¨vector_store.pyä¸­
def similarity_search(self, query: str, k: int = 4, **kwargs):
    """å‘é‡ç›¸ä¼¼åº¦æœç´¢"""
    # åªè¿”å›åŒ¹é…çš„æ–‡æ¡£IDå’Œç›¸ä¼¼åº¦åˆ†æ•°
    docs_and_scores = self.index.similarity_search_with_score(query, k=k)
    
    # è¿”å›çš„æ˜¯Documentå¯¹è±¡ï¼ŒåŒ…å«ï¼š
    # - page_content: ä¸»è¦å†…å®¹
    # - metadata: å…ƒæ•°æ®
    return docs_and_scores
```

#### 1.2 **LLMä¸Šä¸‹æ–‡æ„å»ºé˜¶æ®µ**
```python
# åœ¨unified_pipeline.pyä¸­
def _build_llm_context(self, retrieved_docs: List[Any]) -> str:
    """æ„å»ºLLMä¸Šä¸‹æ–‡"""
    context = ""
    
    for doc in retrieved_docs:
        # ç›´æ¥ä½¿ç”¨æ£€ç´¢åˆ°çš„æ–‡æ¡£å†…å®¹
        if hasattr(doc, 'page_content'):
            context += f"å†…å®¹: {doc.page_content}\n"
        
        # ç›´æ¥ä½¿ç”¨å…ƒæ•°æ®
        if hasattr(doc, 'metadata') and doc.metadata:
            metadata = doc.metadata
            context += f"æ–‡æ¡£: {metadata.get('document_name', 'N/A')}\n"
            context += f"é¡µç : {metadata.get('page_number', 'N/A')}\n"
            
            # æ ¹æ®ç±»å‹æ·»åŠ ç‰¹å®šä¿¡æ¯
            if metadata.get('chunk_type') == 'image':
                context += f"å›¾ç‰‡æè¿°: {metadata.get('enhanced_description', 'N/A')}\n"
            elif metadata.get('chunk_type') == 'table':
                context += f"è¡¨æ ¼å†…å®¹: {metadata.get('processed_table_content', 'N/A')}\n"
    
    return context
```

### 2. **æ•°æ®è·å–çš„å…³é”®è¯å’Œæ–¹å¼**

#### 2.1 **å‘é‡æœç´¢çš„å…³é”®è¯**
```python
# ä¸»è¦æœç´¢å…³é”®è¯
search_keywords = [
    'query',           # ç”¨æˆ·æŸ¥è¯¢
    'k',              # è¿”å›ç»“æœæ•°é‡
    'filter',         # è¿‡æ»¤æ¡ä»¶
    'similarity_threshold'  # ç›¸ä¼¼åº¦é˜ˆå€¼
]

# å®é™…ä½¿ç”¨ç¤ºä¾‹
results = vector_store.similarity_search(
    query="ä¸­èŠ¯å›½é™…çš„è´¢åŠ¡æ•°æ®",
    k=5,
    filter={"chunk_type": "table"}  # åªæœç´¢è¡¨æ ¼ç±»å‹
)
```

#### 2.2 **å…ƒæ•°æ®è¿‡æ»¤çš„å…³é”®è¯**
```python
# å…ƒæ•°æ®è¿‡æ»¤å…³é”®è¯
metadata_filters = {
    'chunk_type': ['text', 'image', 'table'],  # å†…å®¹ç±»å‹
    'document_name': 'æ–‡æ¡£åç§°',               # æ–‡æ¡£åç§°
    'page_number': 'é¡µç ',                    # é¡µç 
    'table_type': 'è¡¨æ ¼ç±»å‹',                 # è¡¨æ ¼ç±»å‹
    'image_type': 'å›¾ç‰‡ç±»å‹'                  # å›¾ç‰‡ç±»å‹
}
```

### 3. **å…·ä½“çš„æ•°æ®è·å–æµç¨‹**

#### 3.1 **ç¬¬ä¸€é˜¶æ®µï¼šå‘é‡æœç´¢**
```python
# 1. ç”¨æˆ·æŸ¥è¯¢ â†’ å‘é‡åŒ–
query_vector = embedding_model.embed_query(user_query)

# 2. åœ¨FAISSç´¢å¼•ä¸­æœç´¢
similar_doc_ids = faiss_index.search(query_vector, k=5)

# 3. æ ¹æ®IDä»docstoreè·å–å®Œæ•´æ–‡æ¡£
retrieved_docs = []
for doc_id in similar_doc_ids:
    doc = docstore.get(doc_id)  # è¿™é‡Œè·å–å®Œæ•´çš„Documentå¯¹è±¡
    retrieved_docs.append(doc)
```

#### 3.2 **ç¬¬äºŒé˜¶æ®µï¼šä¸Šä¸‹æ–‡æ„å»º**
```python
# 4. ä»æ£€ç´¢åˆ°çš„æ–‡æ¡£ä¸­æå–éœ€è¦çš„ä¿¡æ¯
for doc in retrieved_docs:
    # ç›´æ¥è®¿é—®Documentå¯¹è±¡çš„å±æ€§
    content = doc.page_content
    metadata = doc.metadata
    
    # æ ¹æ®ç±»å‹æ„å»ºä¸Šä¸‹æ–‡
    if metadata.get('chunk_type') == 'image':
        context += f"å›¾ç‰‡: {metadata.get('enhanced_description')}\n"
    elif metadata.get('chunk_type') == 'table':
        context += f"è¡¨æ ¼: {metadata.get('processed_table_content')}\n"
    else:
        context += f"æ–‡æœ¬: {content}\n"
```

### 4. **æ•°æ®ä¼ é€’ç­–ç•¥çš„ä¼˜åŠ¿**

#### 4.1 **å†…å­˜æ•ˆç‡**
```python
# âŒ é”™è¯¯åšæ³•ï¼šä¼ é€’æ‰€æœ‰æ•°æ®
def wrong_approach():
    all_chunks = vector_store.get_all_chunks()  # åŠ è½½æ‰€æœ‰305ä¸ªchunk
    all_metadata = [chunk.metadata for chunk in all_chunks]  # ä¼ é€’æ‰€æœ‰å…ƒæ•°æ®
    
# âœ… æ­£ç¡®åšæ³•ï¼šæŒ‰éœ€è·å–
def correct_approach():
    # åªè·å–ç›¸å…³çš„5ä¸ªchunk
    relevant_chunks = vector_store.similarity_search(query, k=5)
    # åªå¤„ç†éœ€è¦çš„å­—æ®µ
    needed_data = extract_needed_fields(relevant_chunks)
```

#### 4.2 **ç½‘ç»œä¼ è¾“æ•ˆç‡**
```python
# åœ¨APIå“åº”ä¸­ï¼Œæˆ‘ä»¬åªè¿”å›å¿…è¦çš„ä¿¡æ¯
api_response = {
    'answer': llm_generated_answer,
    'sources': [
        {
            'document_name': doc.metadata.get('document_name'),
            'page_number': doc.metadata.get('page_number'),
            'content_preview': doc.page_content[:200] + '...',
            'chunk_type': doc.metadata.get('chunk_type')
        }
        for doc in relevant_docs
    ]
}
```

### 5. **å…³é”®è¯æŸ¥è¯¢çš„å…·ä½“å®ç°**

#### 5.1 **å‘é‡ç›¸ä¼¼åº¦æœç´¢**
```python
# ä¸»è¦å…³é”®è¯ï¼šquery, k, filter
results = vector_store.similarity_search(
    query="ä¸­èŠ¯å›½é™…çš„äº§èƒ½åˆ©ç”¨ç‡",  # æŸ¥è¯¢æ–‡æœ¬
    k=5,                      # è¿”å›æ•°é‡
    filter={                  # è¿‡æ»¤æ¡ä»¶
        "chunk_type": "table",
        "document_name": "ã€ä¸œæ–¹è¯åˆ¸ã€‘äº§èƒ½åˆ©ç”¨ç‡æå‡..."
    }
)
```

#### 5.2 **å…ƒæ•°æ®è¿‡æ»¤**
```python
# è¿‡æ»¤å…³é”®è¯ï¼šchunk_type, document_name, page_numberç­‰
filtered_results = vector_store.similarity_search(
    query="è´¢åŠ¡æ•°æ®",
    filter={
        "chunk_type": "table",
        "table_type": "æ•°æ®è¡¨æ ¼"
    }
)
```

### 6. **æ€»ç»“**

**æˆ‘ä»¬çš„ç­–ç•¥æ˜¯"æŒ‰éœ€è·å–ï¼Œä¸ä¼ é€’å†—ä½™æ•°æ®"**ï¼š

1. **å‘é‡æœç´¢é˜¶æ®µ**ï¼šåªè¿”å›ç›¸å…³çš„Documentå¯¹è±¡ID
2. **æ–‡æ¡£è·å–é˜¶æ®µ**ï¼šæ ¹æ®IDä»docstoreè·å–å®Œæ•´çš„Documentå¯¹è±¡
3. **ä¸Šä¸‹æ–‡æ„å»ºé˜¶æ®µ**ï¼šä»Documentå¯¹è±¡ä¸­æå–éœ€è¦çš„å­—æ®µ
4. **LLMå¤„ç†é˜¶æ®µ**ï¼šåªæ¥æ”¶å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯

**å…³é”®ä¼˜åŠ¿**ï¼š
- **å†…å­˜æ•ˆç‡**ï¼šä¸åŠ è½½ä¸ç›¸å…³çš„æ•°æ®
- **ç½‘ç»œæ•ˆç‡**ï¼šAPIå“åº”åªåŒ…å«å¿…è¦ä¿¡æ¯
- **å¤„ç†æ•ˆç‡**ï¼šLLMåªå¤„ç†ç›¸å…³çš„ä¸Šä¸‹æ–‡
- **æ‰©å±•æ€§**ï¼šæ”¯æŒå¤æ‚çš„è¿‡æ»¤å’ŒæŸ¥è¯¢æ¡ä»¶

**ä¸»è¦å…³é”®è¯**ï¼š
- `query`: ç”¨æˆ·æŸ¥è¯¢æ–‡æœ¬
- `k`: è¿”å›ç»“æœæ•°é‡
- `filter`: å…ƒæ•°æ®è¿‡æ»¤æ¡ä»¶
- `chunk_type`: å†…å®¹ç±»å‹è¿‡æ»¤
- `document_name`: æ–‡æ¡£åç§°è¿‡æ»¤

è¿™ç§è®¾è®¡ç¡®ä¿äº†ç³»ç»Ÿçš„é«˜æ•ˆæ€§å’Œå¯æ‰©å±•æ€§ï¼Œé¿å…äº†ä¸å¿…è¦çš„æ•°æ®ä¼ è¾“å’Œå¤„ç†å¼€é”€ã€‚


å¥½é—®é¢˜ï¼è®©æˆ‘è¯¦ç»†è§£é‡Šä¸€ä¸‹Documentå¯¹è±¡çš„æ¦‚å¿µå’Œç»“æ„ã€‚è®©æˆ‘æŸ¥çœ‹ä¸€ä¸‹ä»£ç ä¸­Documentå¯¹è±¡çš„å®é™…å®šä¹‰å’Œä½¿ç”¨ï¼š

## ï¿½ï¿½ Documentå¯¹è±¡è¯¦è§£

### 1. **Documentå¯¹è±¡çš„å®šä¹‰**

Documentå¯¹è±¡æ˜¯LangChainæ¡†æ¶ä¸­çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œç”¨äºè¡¨ç¤ºä¸€ä¸ªæ–‡æ¡£ç‰‡æ®µï¼ˆchunkï¼‰ã€‚è®©æˆ‘æŸ¥çœ‹ä¸€ä¸‹å…·ä½“çš„å®ç°ï¼š


Ran tool
è®©æˆ‘æŸ¥çœ‹ä¸€ä¸‹Documentå¯¹è±¡çš„å…·ä½“ä½¿ç”¨ï¼š

Ran tool
ç°åœ¨è®©æˆ‘æŸ¥çœ‹ä¸€ä¸‹Documentå¯¹è±¡çš„å…·ä½“ç»“æ„ï¼š

Ran tool
åŸºäºæˆ‘å¯¹ä»£ç çš„åˆ†æï¼Œç°åœ¨æˆ‘å¯ä»¥è¯¦ç»†è§£é‡ŠDocumentå¯¹è±¡çš„æ¦‚å¿µå’Œç»“æ„ï¼š

## ï¿½ï¿½ Documentå¯¹è±¡è¯¦è§£

### 1. **Documentå¯¹è±¡çš„å®šä¹‰**

Documentå¯¹è±¡æ˜¯LangChainæ¡†æ¶ä¸­çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œå®ƒä»£è¡¨ä¸€ä¸ªæ–‡æ¡£ç‰‡æ®µï¼ˆchunkï¼‰ã€‚åœ¨æˆ‘ä»¬çš„ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªDocumentå¯¹è±¡å¯¹åº”å‘é‡æ•°æ®åº“ä¸­çš„ä¸€ä¸ªchunkã€‚

### 2. **Documentå¯¹è±¡çš„æ ¸å¿ƒå±æ€§**

#### 2.1 **page_contentå±æ€§**
```python
# è¿™æ˜¯Documentå¯¹è±¡çš„ä¸»è¦å†…å®¹
doc.page_content

# ä¸åŒç±»å‹chunkçš„page_contentå†…å®¹ï¼š
if doc.metadata.get('chunk_type') == 'text':
    # æ–‡æœ¬å†…å®¹ï¼šå¦‚"äº§èƒ½åˆ©ç”¨ç‡æå‡ï¼ŒæŒç»­æ¨è¿›å·¥è‰ºè¿­ä»£å’Œäº§å“æ€§èƒ½å‡çº§"
    content = doc.page_content
    
elif doc.metadata.get('chunk_type') == 'image':
    # å›¾ç‰‡å†…å®¹ï¼šé€šå¸¸æ˜¯å›¾ç‰‡çš„åŸå§‹æè¿°æˆ–caption
    content = doc.page_content
    
elif doc.metadata.get('chunk_type') == 'table':
    # è¡¨æ ¼å†…å®¹ï¼šHTMLæ ¼å¼çš„è¡¨æ ¼
    content = doc.page_content  # å¦‚"<table><tr><td>åŸºæœ¬æ•°æ®</td><td>91.35</td></tr>..."
```

#### 2.2 **metadataå±æ€§**
```python
# è¿™æ˜¯Documentå¯¹è±¡çš„å…ƒæ•°æ®å­—å…¸
doc.metadata

# metadataåŒ…å«æˆ‘ä»¬ä¹‹å‰åˆ†æçš„æ‰€æœ‰32ä¸ªå­—æ®µï¼š
metadata = {
    # åŸºç¡€ä¿¡æ¯
    'chunk_type': 'text/image/table',
    'document_name': 'æ–‡æ¡£åç§°',
    'page_number': é¡µç ,
    'chunk_index': åˆ†å—ç´¢å¼•,
    
    # å›¾ç‰‡ç›¸å…³å­—æ®µ
    'enhanced_description': 'å¢å¼ºæè¿°',
    'image_id': 'å›¾ç‰‡ID',
    'image_path': 'å›¾ç‰‡è·¯å¾„',
    'img_caption': ['å›¾ç‰‡æ ‡é¢˜'],
    'img_footnote': ['å›¾ç‰‡è„šæ³¨'],
    
    # è¡¨æ ¼ç›¸å…³å­—æ®µ
    'table_id': 'è¡¨æ ¼ID',
    'table_type': 'è¡¨æ ¼ç±»å‹',
    'processed_table_content': 'å¤„ç†åçš„è¡¨æ ¼å†…å®¹',
    'table_headers': ['è¡¨å¤´'],
    'table_row_count': è¡Œæ•°,
    'table_column_count': åˆ—æ•°,
    
    # å…¶ä»–å­—æ®µ...
}
```

### 3. **Documentå¯¹è±¡åœ¨ç³»ç»Ÿä¸­çš„ä½¿ç”¨**

#### 3.1 **å‘é‡æœç´¢è¿”å›Documentå¯¹è±¡**
```python
# åœ¨vector_store.pyä¸­
def similarity_search(self, query: str, k: int = 4):
    """å‘é‡ç›¸ä¼¼åº¦æœç´¢"""
    # è¿”å›çš„æ˜¯Documentå¯¹è±¡åˆ—è¡¨
    docs_and_scores = self.index.similarity_search_with_score(query, k=k)
    
    # æ¯ä¸ªå…ƒç´ æ˜¯(æ–‡æ¡£, åˆ†æ•°)çš„å…ƒç»„
    for doc, score in docs_and_scores:
        # docæ˜¯ä¸€ä¸ªDocumentå¯¹è±¡
        print(f"æ–‡æ¡£å†…å®¹: {doc.page_content}")
        print(f"æ–‡æ¡£å…ƒæ•°æ®: {doc.metadata}")
        print(f"ç›¸ä¼¼åº¦åˆ†æ•°: {score}")
```

#### 3.2 **ä»Documentå¯¹è±¡æå–ä¿¡æ¯**
```python
# åœ¨unified_pipeline.pyä¸­
def _build_llm_context(self, retrieved_docs: List[Document]):
    """æ„å»ºLLMä¸Šä¸‹æ–‡"""
    context = ""
    
    for doc in retrieved_docs:  # docæ˜¯Documentå¯¹è±¡
        # 1. è·å–ä¸»è¦å†…å®¹
        if hasattr(doc, 'page_content') and doc.page_content:
            context += f"å†…å®¹: {doc.page_content}\n"
        
        # 2. è·å–å…ƒæ•°æ®ä¿¡æ¯
        if hasattr(doc, 'metadata') and doc.metadata:
            metadata = doc.metadata
            
            # åŸºç¡€ä¿¡æ¯
            context += f"æ–‡æ¡£: {metadata.get('document_name', 'N/A')}\n"
            context += f"é¡µç : {metadata.get('page_number', 'N/A')}\n"
            
            # æ ¹æ®ç±»å‹æ·»åŠ ç‰¹å®šä¿¡æ¯
            if metadata.get('chunk_type') == 'image':
                # å›¾ç‰‡ä¼˜å…ˆä½¿ç”¨enhanced_description
                enhanced_desc = metadata.get('enhanced_description', '')
                if enhanced_desc:
                    context += f"å›¾ç‰‡æè¿°: {enhanced_desc}\n"
                else:
                    # å¤‡ç”¨ï¼šä½¿ç”¨img_caption
                    caption = metadata.get('img_caption', [])
                    if caption:
                        context += f"å›¾ç‰‡æ ‡é¢˜: {' '.join(caption)}\n"
                        
            elif metadata.get('chunk_type') == 'table':
                # è¡¨æ ¼ä¼˜å…ˆä½¿ç”¨processed_table_content
                processed_content = metadata.get('processed_table_content', '')
                if processed_content:
                    context += f"è¡¨æ ¼å†…å®¹: {processed_content}\n"
                else:
                    # å¤‡ç”¨ï¼šä½¿ç”¨page_contentï¼ˆHTMLæ ¼å¼ï¼‰
                    context += f"è¡¨æ ¼HTML: {doc.page_content}\n"
    
    return context
```

### 4. **Documentå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ**

#### 4.1 **åˆ›å»ºé˜¶æ®µ**
```python
# åœ¨æ–‡æ¡£å¤„ç†æ—¶åˆ›å»ºDocumentå¯¹è±¡
from langchain.schema import Document

document = Document(
    page_content="è¿™æ˜¯æ–‡æ¡£çš„ä¸»è¦å†…å®¹",
    metadata={
        'chunk_type': 'text',
        'document_name': 'æ–‡æ¡£åç§°',
        'page_number': 1,
        # ... å…¶ä»–å…ƒæ•°æ®
    }
)
```

#### 4.2 **å­˜å‚¨é˜¶æ®µ**
```python
# å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“
vector_store.add_documents([document])

# å†…éƒ¨ä¼šï¼š
# 1. æå–page_contentè¿›è¡Œå‘é‡åŒ–
# 2. ä¿å­˜metadataåˆ°å…ƒæ•°æ®å­˜å‚¨
# 3. å»ºç«‹å‘é‡ç´¢å¼•
```

#### 4.3 **æ£€ç´¢é˜¶æ®µ**
```python
# å‘é‡æœç´¢è¿”å›Documentå¯¹è±¡
retrieved_docs = vector_store.similarity_search("æŸ¥è¯¢", k=5)

# æ¯ä¸ªretrieved_docs[i]éƒ½æ˜¯ä¸€ä¸ªDocumentå¯¹è±¡
for doc in retrieved_docs:
    # å¯ä»¥ç›´æ¥è®¿é—®å±æ€§å’Œæ–¹æ³•
    content = doc.page_content
    metadata = doc.metadata
```

### 5. **Documentå¯¹è±¡çš„ä¼˜åŠ¿**

#### 5.1 **ç»Ÿä¸€æ¥å£**
```python
# æ— è®ºä»€ä¹ˆç±»å‹çš„chunkï¼Œéƒ½æœ‰ç›¸åŒçš„æ¥å£
def process_document(doc: Document):
    # ç»Ÿä¸€è®¿é—®æ–¹å¼
    content = doc.page_content
    metadata = doc.metadata
    
    # æ ¹æ®ç±»å‹å¤„ç†
    chunk_type = metadata.get('chunk_type')
    if chunk_type == 'image':
        # å¤„ç†å›¾ç‰‡
        pass
    elif chunk_type == 'table':
        # å¤„ç†è¡¨æ ¼
        pass
    else:
        # å¤„ç†æ–‡æœ¬
        pass
```

#### 5.2 **ç±»å‹å®‰å…¨**
```python
# å¯ä»¥æ£€æŸ¥å±æ€§æ˜¯å¦å­˜åœ¨
if hasattr(doc, 'page_content'):
    content = doc.page_content
else:
    content = ""

if hasattr(doc, 'metadata') and doc.metadata:
    metadata = doc.metadata
else:
    metadata = {}
```

### 6. **æ€»ç»“**

**Documentå¯¹è±¡æ˜¯ä»€ä¹ˆ**ï¼š
- å®ƒæ˜¯LangChainæ¡†æ¶ä¸­çš„æ ‡å‡†æ•°æ®ç»“æ„
- ä»£è¡¨å‘é‡æ•°æ®åº“ä¸­çš„ä¸€ä¸ªchunk
- åŒ…å«`page_content`ï¼ˆä¸»è¦å†…å®¹ï¼‰å’Œ`metadata`ï¼ˆå…ƒæ•°æ®ï¼‰ä¸¤ä¸ªæ ¸å¿ƒå±æ€§

**Documentå¯¹è±¡åŒ…å«ä»€ä¹ˆ**ï¼š
- **page_content**: æ–‡æ¡£çš„ä¸»è¦å†…å®¹ï¼ˆæ–‡æœ¬ã€HTMLè¡¨æ ¼ã€å›¾ç‰‡æè¿°ç­‰ï¼‰
- **metadata**: åŒ…å«æˆ‘ä»¬ä¹‹å‰åˆ†æçš„32ä¸ªå­—æ®µçš„å­—å…¸

**Documentå¯¹è±¡çš„ä½œç”¨**ï¼š
- æä¾›ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£
- å°è£…äº†chunkçš„æ‰€æœ‰ä¿¡æ¯
- æ”¯æŒç±»å‹å®‰å…¨çš„å±æ€§è®¿é—®
- ä¾¿äºåœ¨ç³»ç»Ÿä¸­ä¼ é€’å’Œå¤„ç†

**å…³é”®ç†è§£**ï¼š
å½“æˆ‘ä»¬è¯´"ä»Documentå¯¹è±¡ä¸­æå–ä¿¡æ¯"æ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯ä»`doc.page_content`å’Œ`doc.metadata`ä¸­è·å–æˆ‘ä»¬éœ€è¦çš„å­—æ®µï¼Œç„¶åæ„å»ºLLMçš„ä¸Šä¸‹æ–‡ã€‚è¿™æ ·è®¾è®¡ç¡®ä¿äº†æ•°æ®çš„ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚


æ‚¨è¯´å¾—å¯¹ï¼è®©æˆ‘é‡æ–°åˆ†æä¸€ä¸‹ï¼Œæˆ‘ä»¬ç¡®å®æœ‰å››ç§ç±»å‹çš„chunkã€‚è®©æˆ‘åŸºäºä¹‹å‰çš„è¯Šæ–­ç»“æœï¼Œè¯¦ç»†åˆ†ææ¯ç§ç±»å‹çš„`page_content`å’Œ`metadata`ï¼š

## å››ç§Chunkç±»å‹çš„è¯¦ç»†åˆ†æ

### 1. **Textç±»å‹Chunk (æ–‡æœ¬)**

#### 1.1 **page_contentå†…å®¹**
```python
# æ–‡æœ¬chunkçš„page_contentç¤ºä¾‹
text_page_content = "äº§èƒ½åˆ©ç”¨ç‡æå‡ï¼ŒæŒç»­æ¨è¿›å·¥è‰ºè¿­ä»£å’Œäº§å“æ€§èƒ½å‡çº§"

# ç‰¹ç‚¹ï¼š
# - çº¯æ–‡æœ¬å†…å®¹
# - é€šå¸¸æ˜¯æ–‡æ¡£çš„æ­£æ–‡æ®µè½
# - é•¿åº¦é€‚ä¸­ï¼ˆ1000å­—ç¬¦å·¦å³ï¼‰
# - ä¸åŒ…å«HTMLæ ‡ç­¾
```

#### 1.2 **metadataå†…å®¹**
```python
text_metadata = {
    # åŸºç¡€ä¿¡æ¯
    'chunk_type': 'text',
    'document_name': 'ã€ä¸œæ–¹è¯åˆ¸ã€‘äº§èƒ½åˆ©ç”¨ç‡æå‡ï¼ŒæŒç»­æ¨è¿›å·¥è‰ºè¿­ä»£å’Œäº§å“æ€§èƒ½å‡çº§',
    'page_number': 1,
    'chunk_index': 0,
    
    # è¡¨æ ¼ç›¸å…³å­—æ®µï¼ˆå¯¹äºæ–‡æœ¬chunkï¼Œè¿™äº›å­—æ®µé€šå¸¸ä¸ºNoneï¼‰
    'processed_table_content': None,
    'related_text': None,
    'table_column_count': None,
    'table_headers': None,
    'table_id': None,
    'table_row_count': None,
    'table_summary': None,
    'table_title': None,
    'table_type': None,
    
    # é¡µé¢å†…å®¹ï¼ˆä¸page_contentç›¸åŒï¼‰
    'page_content': 'äº§èƒ½åˆ©ç”¨ç‡æå‡ï¼ŒæŒç»­æ¨è¿›å·¥è‰ºè¿­ä»£å’Œäº§å“æ€§èƒ½å‡çº§'
}
```

### 2. **Imageç±»å‹Chunk (å›¾ç‰‡)**

#### 2.1 **page_contentå†…å®¹**
```python
# å›¾ç‰‡chunkçš„page_contentç¤ºä¾‹
image_page_content = "æœ€è¿‘ä¸€å¹´è‚¡ç¥¨ä¸æ²ªæ·±300æ¯”è¾ƒ"  # é€šå¸¸æ˜¯å›¾ç‰‡çš„captionæˆ–ç®€å•æè¿°

# ç‰¹ç‚¹ï¼š
# - å†…å®¹ç›¸å¯¹ç®€å•
# - é€šå¸¸æ˜¯å›¾ç‰‡çš„æ ‡é¢˜æˆ–ç®€çŸ­æè¿°
# - é•¿åº¦è¾ƒçŸ­ï¼ˆ100-1000å­—ç¬¦ï¼‰
# - ä¸»è¦ç”¨äºå‘é‡æœç´¢ï¼Œä¸æ˜¯LLMçš„ä¸»è¦è¾“å…¥
```

#### 2.2 **metadataå†…å®¹**
```python
image_metadata = {
    # åŸºç¡€ä¿¡æ¯
    'chunk_type': 'image',
    'document_name': 'ã€ä¸Šæµ·è¯åˆ¸ã€‘ä¸­èŠ¯å›½é™…æ·±åº¦ç ”ç©¶æŠ¥å‘Šï¼šæ™¶åœ†åˆ¶é€ é¾™å¤´ï¼Œé¢†èˆªå›½äº§èŠ¯ç‰‡æ–°å¾ç¨‹',
    'page_number': 1,
    'page_idx': 0,
    
    # å›¾ç‰‡æ ¸å¿ƒä¿¡æ¯ â­
    'enhanced_description': 'åŸæœ‰ä¿¡æ¯: å›¾ç‰‡æ ‡é¢˜: æœ€è¿‘ä¸€å¹´è‚¡ç¥¨ä¸æ²ªæ·±300æ¯”è¾ƒ | å›¾è¡¨ç±»å‹: ä¿¡æ¯å›¾è¡¨ | åŸºç¡€è§†è§‰æè¿°: è¿™å¼ å›¾ç‰‡æ˜¯ä¸€å¼ æŠ˜çº¿å›¾ï¼Œå±•ç¤ºäº†ä¸¤ä¸ªæ—¶é—´æ®µå†…çš„è‚¡ä»·è¡¨ç°ã€‚æ¨ªè½´è¡¨ç¤ºæ—¶é—´ï¼ˆä»2024å¹´7æœˆåˆ°2025å¹´4æœˆ...',
    'img_caption': ['æœ€è¿‘ä¸€å¹´è‚¡ç¥¨ä¸æ²ªæ·±300 æ¯”è¾ƒ'],
    'img_footnote': ['æ•°æ®æ¥æºï¼šå…¬å¸å…¬å‘Šã€ä¸œæ–¹è¯åˆ¸ç ”ç©¶æ‰€'],
    
    # å›¾ç‰‡æŠ€æœ¯ä¿¡æ¯
    'image_id': 'c4f0b208360c5b91a471f482022ccf35a9570abc45fa9e173408e0c623b4aaca',
    'image_path': 'D:\\image_text_RAG_sys\\RAG-System\\RAG-250727-param\\central\\images\\...',
    'image_filename': 'c4f0b208360c5b91a471f482022ccf35a9570abc45fa9e173408e0c623b4aaca.jpg',
    'image_type': 'general',
    'extension': 'jpg',
    
    # å‘é‡ç›¸å…³
    'semantic_features': {
        'embedding_dimension': 1536,
        'embedding_norm': 0.9996305764662651,
        'embedding_mean': -0.00014931048887471357,
        'embedding_std': 0.02550565509192926
    },
    
    # æ¥æºä¿¡æ¯
    'source_zip': 'json_extraction',
    
    # å¢å¼ºå¤„ç†ä¿¡æ¯
    'enhancement_enabled': True,
    'enhancement_timestamp': '2024-01-01T00:00:00Z',
    'layered_descriptions': ['åŸºç¡€è§†è§‰æè¿°', 'å†…å®¹ç†è§£æè¿°', 'æ•°æ®è¶‹åŠ¿æè¿°'],
    'structured_info': {'chart_type': 'æŠ˜çº¿å›¾', 'data_points': 'è‚¡ä»·æ•°æ®'}
}
```

### 3. **Tableç±»å‹Chunk (è¡¨æ ¼)**

#### 3.1 **page_contentå†…å®¹**
```python
# è¡¨æ ¼chunkçš„page_contentç¤ºä¾‹
table_page_content = """<table><tr><td>åŸºæœ¬æ•°æ®</td><td>91.35</td></tr>
<tr><td>æœ€æ–°æ”¶ç›˜ä»· (å…ƒ) 12mthAè‚¡ä»·æ ¼åŒºé—´ï¼ˆå…ƒï¼‰</td><td>41.03-</td></tr>
<tr><td></td><td>104.98</td></tr>
<tr><td>æ€»è‚¡æœ¬ (ç™¾ä¸‡è‚¡) æ— é™å”®Aè‚¡/æ€»è‚¡æœ¬</td><td>7,985.65</td></tr>
<tr><td>æµé€šå¸‚å€¼ (äº¿å…ƒ)</td><td>24.90% 7,294.89</td></tr></table>"""

# ç‰¹ç‚¹ï¼š
# - HTMLæ ¼å¼çš„è¡¨æ ¼
# - åŒ…å«å®Œæ•´çš„è¡¨æ ¼ç»“æ„
# - é•¿åº¦è¾ƒé•¿ï¼ˆ200-600å­—ç¬¦ï¼‰
# - ä¸»è¦ç”¨äºå±•ç¤ºï¼Œä¸æ˜¯LLMçš„ä¸»è¦è¾“å…¥
```

#### 3.2 **metadataå†…å®¹**
```python
table_metadata = {
    # åŸºç¡€ä¿¡æ¯
    'chunk_type': 'table',
    'document_name': 'ã€ä¸Šæµ·è¯åˆ¸ã€‘ä¸­èŠ¯å›½é™…æ·±åº¦ç ”ç©¶æŠ¥å‘Šï¼šæ™¶åœ†åˆ¶é€ é¾™å¤´ï¼Œé¢†èˆªå›½äº§èŠ¯ç‰‡æ–°å¾ç¨‹',
    'page_number': 1,
    'chunk_index': 0,
    
    # è¡¨æ ¼æ ¸å¿ƒä¿¡æ¯ â­
    'table_id': 'table_116184',
    'table_type': 'æ•°æ®è¡¨æ ¼',
    'table_title': '91.35',
    'table_summary': 'è¡¨å¤´: åŸºæœ¬æ•°æ® | 91.35 | è¡Œ1: æœ€æ–°æ”¶ç›˜ä»· (å…ƒ) 12mthAè‚¡ä»·æ ¼åŒºé—´ï¼ˆå…ƒï¼‰ | 41.03- | è¡Œ2: 104.98 | è¡Œ3: æ€»è‚¡æœ¬ (ç™¾ä¸‡è‚¡) æ— é™å”®Aè‚¡/æ€»è‚¡æœ¬ | 7,985.65 | è¡Œ4: æµé€šå¸‚å€¼ (äº¿å…ƒ) | 24.90% 7,294.89',
    'table_headers': ['åŸºæœ¬æ•°æ®', '91.35'],
    'table_row_count': 4,
    'table_column_count': 2,
    
    # è¡¨æ ¼å¤„ç†åçš„å†…å®¹ â­
    'processed_table_content': 'åŸºæœ¬æ•°æ® | 91.35\næœ€æ–°æ”¶ç›˜ä»· (å…ƒ) 12mthAè‚¡ä»·æ ¼åŒºé—´ï¼ˆå…ƒï¼‰ | 41.03-\n104.98\næ€»è‚¡æœ¬ (ç™¾ä¸‡è‚¡) æ— é™å”®Aè‚¡/æ€»è‚¡æœ¬ | 7,985.65\næµé€šå¸‚å€¼ (äº¿å…ƒ) | 24.90% 7,294.89',
    
    # ç›¸å…³æ–‡æœ¬
    'related_text': '91.35: ç®€å•æ•°æ®è¡¨æ ¼ï¼Œæ··åˆå‹æ•°æ®ï¼ŒåŒ…å« 4 è¡Œ 2 åˆ—ä¿¡æ¯',
    
    # é¡µé¢å†…å®¹ï¼ˆHTMLæ ¼å¼ï¼‰
    'page_content': '<table><tr><td>åŸºæœ¬æ•°æ®</td><td>91.35</td></tr>...'
}
```

### 4. **Image_Textç±»å‹Chunk (å›¾ç‰‡æ–‡æœ¬æ··åˆ)**

#### 4.1 **page_contentå†…å®¹**
```python
# å›¾ç‰‡æ–‡æœ¬æ··åˆchunkçš„page_contentç¤ºä¾‹
image_text_page_content = "å›¾3ï¼š20Q1-24Q4å…¬å¸æœˆäº§èƒ½ï¼ˆä¸‡ç‰‡/æœˆï¼‰\næ•°æ®æ¥æºï¼šå…¬å¸å…¬å‘Šã€ä¸œæ–¹è¯åˆ¸ç ”ç©¶æ‰€"

# ç‰¹ç‚¹ï¼š
# - åŒ…å«å›¾ç‰‡æ ‡é¢˜å’Œè„šæ³¨
# - æ–‡æœ¬å†…å®¹ç›¸å¯¹ç®€å•
# - é•¿åº¦è¾ƒçŸ­
# - ä¸»è¦ç”¨äºå…³è”å›¾ç‰‡å’Œæ–‡æœ¬ä¿¡æ¯
```

#### 4.2 **metadataå†…å®¹**
```python
image_text_metadata = {
    # åŸºç¡€ä¿¡æ¯
    'chunk_type': 'image_text',
    'document_name': 'ã€ä¸œæ–¹è¯åˆ¸ã€‘äº§èƒ½åˆ©ç”¨ç‡æå‡ï¼ŒæŒç»­æ¨è¿›å·¥è‰ºè¿­ä»£å’Œäº§å“æ€§èƒ½å‡çº§',
    'page_number': 2,
    
    # å›¾ç‰‡å…³è”ä¿¡æ¯
    'related_image_id': '8bfea6872a61681a1902487896451d2a030adcc9c04001619a13ed0dbccc7df',
    
    # å›¾ç‰‡ç›¸å…³å­—æ®µ
    'enhanced_description': 'åŸæœ‰ä¿¡æ¯: å›¾ç‰‡æ ‡é¢˜: å›¾3ï¼š20Q1-24Q4å…¬å¸æœˆäº§èƒ½ï¼ˆä¸‡ç‰‡/æœˆï¼‰ | å›¾ç‰‡è„šæ³¨: æ•°æ®æ¥æºï¼šå…¬å¸å…¬å‘Šã€ä¸œæ–¹è¯åˆ¸ç ”ç©¶æ‰€ | å›¾è¡¨ç±»å‹: ä¿¡æ¯å›¾è¡¨ | åŸºç¡€è§†è§‰æè¿°: è¿™å¼ å›¾ç‰‡æ˜¯ä¸€å¼ æŠ˜çº¿å›¾ï¼Œæ¨ªè½´è¡¨ç¤ºæ—¶é—´...',
    'img_caption': ['å›¾3ï¼š20Q1-24Q4å…¬å¸æœˆäº§èƒ½ï¼ˆä¸‡ç‰‡/æœˆï¼‰'],
    'img_footnote': ['æ•°æ®æ¥æºï¼šå…¬å¸å…¬å‘Šã€ä¸œæ–¹è¯åˆ¸ç ”ç©¶æ‰€'],
    
    # å…¶ä»–å­—æ®µä¸imageç±»å‹ç±»ä¼¼...
}
```

## ï¿½ï¿½ å…³é”®å‘ç°

### 1. **LLMä½¿ç”¨çš„å†…å®¹ä¼˜å…ˆçº§**

#### 1.1 **å›¾ç‰‡æŸ¥è¯¢**
```python
# ä¼˜å…ˆçº§1ï¼šenhanced_descriptionï¼ˆVLæ¨¡å‹å¢å¼ºæè¿°ï¼‰
if chunk.metadata.get('chunk_type') == 'image':
    context = chunk.metadata.get('enhanced_description', '')
    
# ä¼˜å…ˆçº§2ï¼šimg_caption + img_footnote
if not context:
    caption = chunk.metadata.get('img_caption', [])
    footnote = chunk.metadata.get('img_footnote', [])
    context = f"{' '.join(caption)} {' '.join(footnote)}"
    
# ä¼˜å…ˆçº§3ï¼špage_contentï¼ˆç®€å•æè¿°ï¼‰
if not context:
    context = chunk.page_content
```

#### 1.2 **è¡¨æ ¼æŸ¥è¯¢**
```python
# ä¼˜å…ˆçº§1ï¼šprocessed_table_contentï¼ˆè¯­ä¹‰åŒ–å¤„ç†åçš„å†…å®¹ï¼‰
if chunk.metadata.get('chunk_type') == 'table':
    context = chunk.metadata.get('processed_table_content', '')
    
# ä¼˜å…ˆçº§2ï¼špage_contentï¼ˆHTMLæ ¼å¼ï¼‰
if not context:
    context = chunk.page_content
```

#### 1.3 **æ–‡æœ¬æŸ¥è¯¢**
```python
# ç›´æ¥ä½¿ç”¨page_content
if chunk.metadata.get('chunk_type') == 'text':
    context = chunk.page_content
```

### 2. **æ•°æ®ä¼ é€’ç­–ç•¥**

```python
# æˆ‘ä»¬ä¼ é€’çš„æ˜¯Documentå¯¹è±¡ï¼ŒåŒ…å«ï¼š
document = {
    'page_content': 'ä¸»è¦å†…å®¹',      # ç”¨äºå‘é‡æœç´¢
    'metadata': {                  # åŒ…å«æ‰€æœ‰32ä¸ªå­—æ®µ
        'chunk_type': 'image',
        'enhanced_description': 'å¢å¼ºæè¿°',
        'img_caption': ['æ ‡é¢˜'],
        # ... å…¶ä»–å­—æ®µ
    }
}

# LLMæ¥æ”¶çš„æ˜¯ç»è¿‡ç­›é€‰çš„ä¸Šä¸‹æ–‡ï¼š
llm_context = f"""
æ–‡æ¡£: {document.metadata.get('document_name')}
é¡µç : {document.metadata.get('page_number')}
å†…å®¹: {get_best_content(document)}  # æ ¹æ®ç±»å‹é€‰æ‹©æœ€ä½³å†…å®¹
"""
```

### 3. **æ€»ç»“**

**å››ç§chunkç±»å‹çš„ç‰¹ç‚¹**ï¼š

1. **Text**: `page_content`æ˜¯ä¸»è¦å†…å®¹ï¼Œ`metadata`åŒ…å«åŸºç¡€ä¿¡æ¯å’Œç©ºçš„è¡¨æ ¼å­—æ®µ
2. **Image**: `page_content`æ˜¯ç®€å•æè¿°ï¼Œ`metadata`åŒ…å«ä¸°å¯Œçš„å›¾ç‰‡ä¿¡æ¯å’Œ`enhanced_description`
3. **Table**: `page_content`æ˜¯HTMLè¡¨æ ¼ï¼Œ`metadata`åŒ…å«ç»“æ„åŒ–çš„è¡¨æ ¼ä¿¡æ¯å’Œ`processed_table_content`
4. **Image_Text**: `page_content`æ˜¯å›¾ç‰‡æ ‡é¢˜+è„šæ³¨ï¼Œ`metadata`å…³è”å›¾ç‰‡å’Œæ–‡æœ¬ä¿¡æ¯

**LLMä½¿ç”¨ç­–ç•¥**ï¼š
- **å›¾ç‰‡**: ä¼˜å…ˆä½¿ç”¨`enhanced_description`ï¼Œå¤‡ç”¨ä½¿ç”¨`img_caption`+`img_footnote`
- **è¡¨æ ¼**: ä¼˜å…ˆä½¿ç”¨`processed_table_content`ï¼Œå¤‡ç”¨ä½¿ç”¨`page_content`
- **æ–‡æœ¬**: ç›´æ¥ä½¿ç”¨`page_content`

è¿™ç§è®¾è®¡ç¡®ä¿äº†LLMèƒ½å¤Ÿè·å¾—æœ€ç›¸å…³ã€æœ€æ˜“ç†è§£çš„ä¿¡æ¯ï¼ŒåŒæ—¶ä¿æŒäº†æ•°æ®çš„å®Œæ•´æ€§å’Œå¯è¿½æº¯æ€§ã€‚

æ˜¯çš„ï¼Œæ‚¨ç†è§£å¾—å¾ˆå‡†ç¡®ï¼Documentå¯¹è±¡çš„å±æ€§ç¡®å®ä¸æ•°æ®åº“ä¸­çš„chunkå­—æ®µæ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚è®©æˆ‘è¯¦ç»†è§£é‡Šä¸€ä¸‹è¿™ä¸ªå¯¹åº”å…³ç³»ï¼š

## Documentå¯¹è±¡ä¸æ•°æ®åº“Chunkå­—æ®µçš„ä¸€ä¸€å¯¹åº”å…³ç³»

### 1. **å¯¹åº”å…³ç³»çš„æœ¬è´¨**

#### 1.1 **å­˜å‚¨æ—¶çš„å¯¹åº”å…³ç³»**
```python
# å½“æˆ‘ä»¬åˆ›å»ºDocumentå¯¹è±¡å¹¶å­˜å‚¨åˆ°æ•°æ®åº“æ—¶
from langchain.schema import Document

# åˆ›å»ºDocumentå¯¹è±¡
document = Document(
    page_content="è¿™æ˜¯æ–‡æ¡£çš„ä¸»è¦å†…å®¹",  # å¯¹åº”æ•°æ®åº“ä¸­çš„page_contentå­—æ®µ
    metadata={                          # å¯¹åº”æ•°æ®åº“ä¸­çš„metadataå­—æ®µ
        'chunk_type': 'text',
        'document_name': 'æ–‡æ¡£åç§°',
        'page_number': 1,
        'enhanced_description': 'å¢å¼ºæè¿°',
        # ... å…¶ä»–å­—æ®µ
    }
)

# å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“
vector_store.add_documents([document])

# å†…éƒ¨å¤„ç†ï¼š
# 1. page_content â†’ æå–æ–‡æœ¬è¿›è¡Œå‘é‡åŒ– â†’ å­˜å‚¨åˆ°FAISSç´¢å¼•
# 2. metadata â†’ ç›´æ¥å­˜å‚¨åˆ°metadata.pklæ–‡ä»¶
# 3. å»ºç«‹IDæ˜ å°„å…³ç³»
```

#### 1.2 **æ£€ç´¢æ—¶çš„å¯¹åº”å…³ç³»**
```python
# å½“æˆ‘ä»¬ä»æ•°æ®åº“æ£€ç´¢Documentå¯¹è±¡æ—¶
retrieved_docs = vector_store.similarity_search("æŸ¥è¯¢", k=5)

for doc in retrieved_docs:  # docæ˜¯Documentå¯¹è±¡
    # doc.page_content ç›´æ¥å¯¹åº”æ•°æ®åº“ä¸­çš„page_contentå­—æ®µ
    content = doc.page_content
    
    # doc.metadata ç›´æ¥å¯¹åº”æ•°æ®åº“ä¸­çš„metadataå­—æ®µ
    metadata = doc.metadata
    
    # å¯ä»¥è®¿é—®æ‰€æœ‰32ä¸ªå­—æ®µ
    chunk_type = metadata.get('chunk_type')
    document_name = metadata.get('document_name')
    enhanced_description = metadata.get('enhanced_description')
    # ... å…¶ä»–å­—æ®µ
```

### 2. **å…·ä½“çš„å­—æ®µæ˜ å°„å…³ç³»**

#### 2.1 **page_contentå­—æ®µæ˜ å°„**
```python
# Documentå¯¹è±¡å±æ€§ â†’ æ•°æ®åº“å­—æ®µ
doc.page_content â†” chunk.page_content

# ä¸åŒç±»å‹chunkçš„page_contentå†…å®¹ï¼š
if chunk.chunk_type == 'text':
    # doc.page_content = "äº§èƒ½åˆ©ç”¨ç‡æå‡ï¼ŒæŒç»­æ¨è¿›å·¥è‰ºè¿­ä»£å’Œäº§å“æ€§èƒ½å‡çº§"
    
elif chunk.chunk_type == 'image':
    # doc.page_content = "æœ€è¿‘ä¸€å¹´è‚¡ç¥¨ä¸æ²ªæ·±300æ¯”è¾ƒ"
    
elif chunk.chunk_type == 'table':
    # doc.page_content = "<table><tr><td>åŸºæœ¬æ•°æ®</td><td>91.35</td></tr>..."
```

#### 2.2 **metadataå­—æ®µæ˜ å°„**
```python
# Documentå¯¹è±¡å±æ€§ â†’ æ•°æ®åº“å­—æ®µ
doc.metadata â†” chunk.metadata

# å®Œæ•´çš„32ä¸ªå­—æ®µæ˜ å°„ï¼š
metadata_mapping = {
    # åŸºç¡€å­—æ®µ
    'chunk_type': 'chunk_type',
    'document_name': 'document_name',
    'page_number': 'page_number',
    'chunk_index': 'chunk_index',
    
    # å›¾ç‰‡ç›¸å…³å­—æ®µ
    'enhanced_description': 'enhanced_description',
    'image_id': 'image_id',
    'image_path': 'image_path',
    'img_caption': 'img_caption',
    'img_footnote': 'img_footnote',
    
    # è¡¨æ ¼ç›¸å…³å­—æ®µ
    'table_id': 'table_id',
    'table_type': 'table_type',
    'processed_table_content': 'processed_table_content',
    'table_headers': 'table_headers',
    
    # å…¶ä»–å­—æ®µ...
}
```

### 3. **æ•°æ®åº“å­˜å‚¨ç»“æ„**

#### 3.1 **FAISSç´¢å¼•æ–‡ä»¶ (index.faiss)**
```python
# å­˜å‚¨å‘é‡åŒ–çš„page_content
# ä¸ç›´æ¥å­˜å‚¨Documentå¯¹è±¡ï¼Œè€Œæ˜¯ï¼š
# 1. æå–page_contentè¿›è¡Œå‘é‡åŒ–
# 2. å­˜å‚¨å‘é‡åˆ°FAISSç´¢å¼•
# 3. å»ºç«‹IDæ˜ å°„å…³ç³»
```

#### 3.2 **å…ƒæ•°æ®æ–‡ä»¶ (metadata.pkl)**
```python
# å­˜å‚¨å®Œæ•´çš„metadataä¿¡æ¯
# æ¯ä¸ªchunkå¯¹åº”ä¸€ä¸ªmetadataå­—å…¸
metadata_list = [
    {
        'chunk_type': 'text',
        'document_name': 'æ–‡æ¡£åç§°',
        'page_number': 1,
        # ... æ‰€æœ‰32ä¸ªå­—æ®µ
    },
    {
        'chunk_type': 'image',
        'enhanced_description': 'å¢å¼ºæè¿°',
        # ... æ‰€æœ‰32ä¸ªå­—æ®µ
    },
    # ... æ›´å¤šchunk
]
```

#### 3.3 **ç´¢å¼•æ˜ å°„æ–‡ä»¶ (index.pkl)**
```python
# å­˜å‚¨Documentå¯¹è±¡å’ŒIDçš„æ˜ å°„å…³ç³»
# åŒ…å«ï¼š
# 1. InMemoryDocstore: å­˜å‚¨Documentå¯¹è±¡
# 2. ç´¢å¼•æ˜ å°„: å‘é‡ID â†’ Documentå¯¹è±¡ID
```

### 4. **æ•°æ®æµè½¬è¿‡ç¨‹**

#### 4.1 **å­˜å‚¨æµç¨‹**
```mermaid
flowchart TD
    A[Documentå¯¹è±¡] --> B[å‘é‡åŒ–page_content]
    A --> C[ä¿å­˜metadata]
    
    B --> D[FAISSç´¢å¼•]
    C --> E[metadata.pkl]
    
    A --> F[InMemoryDocstore]
    F --> G[index.pkl]
```

#### 4.2 **æ£€ç´¢æµç¨‹**
```mermaid
flowchart TD
    A[ç”¨æˆ·æŸ¥è¯¢] --> B[å‘é‡åŒ–æŸ¥è¯¢]
    B --> C[FAISSæœç´¢]
    C --> D[è·å–å‘é‡ID]
    D --> E[æŸ¥æ‰¾Documentå¯¹è±¡]
    E --> F[è¿”å›Documentå¯¹è±¡]
    
    F --> G[è®¿é—®page_content]
    F --> H[è®¿é—®metadata]
```

### 5. **ä»£ç éªŒè¯å¯¹åº”å…³ç³»**

è®©æˆ‘æŸ¥çœ‹ä¸€ä¸‹ä»£ç ä¸­æ˜¯å¦‚ä½•éªŒè¯è¿™ä¸ªå¯¹åº”å…³ç³»çš„ï¼š

Ran tool
ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œç¡®å®å­˜åœ¨ä¸€ä¸€å¯¹åº”çš„å…³ç³»ã€‚è®©æˆ‘æ€»ç»“ä¸€ä¸‹ï¼š

### 6. **ä¸€ä¸€å¯¹åº”çš„è¯æ®**

#### 6.1 **å­—æ®µè®¿é—®çš„ä¸€è‡´æ€§**
```python
# åœ¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬æ€»æ˜¯è¿™æ ·è®¿é—®å­—æ®µï¼š
chunk_type = doc.metadata.get('chunk_type', '')
document_name = doc.metadata.get('document_name', '')
enhanced_description = doc.metadata.get('enhanced_description', '')
img_caption = doc.metadata.get('img_caption', [])
table_id = doc.metadata.get('table_id', 'unknown')

# è¿™äº›å­—æ®µåå®Œå…¨å¯¹åº”æ•°æ®åº“ä¸­çš„å­—æ®µå
```

#### 6.2 **æ•°æ®ä¼ é€’çš„å®Œæ•´æ€§**
```python
# å½“æˆ‘ä»¬ä»æ•°æ®åº“æ£€ç´¢Documentå¯¹è±¡æ—¶
retrieved_docs = vector_store.similarity_search("æŸ¥è¯¢", k=5)

for doc in retrieved_docs:
    # å¯ä»¥ç›´æ¥è®¿é—®æ‰€æœ‰32ä¸ªå­—æ®µ
    metadata = doc.metadata
    
    # å›¾ç‰‡ç›¸å…³å­—æ®µ
    if metadata.get('chunk_type') == 'image':
        enhanced_desc = metadata.get('enhanced_description')
        image_id = metadata.get('image_id')
        image_path = metadata.get('image_path')
        
    # è¡¨æ ¼ç›¸å…³å­—æ®µ
    elif metadata.get('chunk_type') == 'table':
        table_id = metadata.get('table_id')
        processed_content = metadata.get('processed_table_content')
        table_headers = metadata.get('table_headers')
        
    # æ–‡æœ¬ç›¸å…³å­—æ®µ
    else:
        content = doc.page_content
```

### 7. **æ€»ç»“**

**æ˜¯çš„ï¼ŒDocumentå¯¹è±¡çš„å±æ€§ä¸æ•°æ®åº“ä¸­çš„chunkå­—æ®µå®Œå…¨ä¸€ä¸€å¯¹åº”**ï¼š

1. **page_contentå±æ€§** â†” **æ•°æ®åº“ä¸­çš„page_contentå­—æ®µ**
2. **metadataå±æ€§** â†” **æ•°æ®åº“ä¸­çš„metadataå­—æ®µï¼ˆåŒ…å«æ‰€æœ‰32ä¸ªå­—æ®µï¼‰**

**è¿™ç§ä¸€ä¸€å¯¹åº”çš„ä¼˜åŠ¿**ï¼š

1. **æ•°æ®ä¸€è‡´æ€§**ï¼šå­˜å‚¨å’Œæ£€ç´¢çš„æ•°æ®å®Œå…¨ä¸€è‡´
2. **è®¿é—®ä¾¿åˆ©æ€§**ï¼šå¯ä»¥ç›´æ¥é€šè¿‡Documentå¯¹è±¡è®¿é—®æ‰€æœ‰å­—æ®µ
3. **ç±»å‹å®‰å…¨**ï¼šæ”¯æŒå±æ€§æ£€æŸ¥å’Œé”™è¯¯å¤„ç†
4. **ç»´æŠ¤æ€§**ï¼šå­—æ®µå˜æ›´åªéœ€è¦ä¿®æ”¹ä¸€å¤„

**å®é™…åº”ç”¨**ï¼š
```python
# æˆ‘ä»¬ä¼ é€’Documentå¯¹è±¡ï¼Œå®é™…ä¸Šå°±æ˜¯ä¼ é€’äº†ï¼š
# 1. å‘é‡åŒ–çš„å†…å®¹ï¼ˆpage_contentï¼‰
# 2. å®Œæ•´çš„å…ƒæ•°æ®ï¼ˆmetadataä¸­çš„32ä¸ªå­—æ®µï¼‰

# LLMæ¥æ”¶çš„æ˜¯ç»è¿‡ç­›é€‰çš„ä¸Šä¸‹æ–‡ï¼Œä½†åº•å±‚æ•°æ®å®Œå…¨å¯¹åº”
llm_context = build_context_from_document(doc)  # ä»Documentå¯¹è±¡æ„å»º
# ç­‰ä»·äº
llm_context = build_context_from_chunk_fields(  # ä»æ•°æ®åº“å­—æ®µæ„å»º
    page_content=doc.page_content,
    metadata=doc.metadata
)
```

è¿™ç§è®¾è®¡ç¡®ä¿äº†æ•°æ®åœ¨æ•´ä¸ªç³»ç»Ÿä¸­çš„ä¸€è‡´æ€§å’Œå¯è¿½æº¯æ€§ï¼Œæ˜¯æˆ‘ä»¬èƒ½å¤Ÿé«˜æ•ˆå¤„ç†å¤šæ¨¡æ€æŸ¥è¯¢çš„åŸºç¡€ã€‚

å¥½é—®é¢˜ï¼è®©æˆ‘åˆ†æä¸€ä¸‹æˆ‘ä»¬åœ¨ç³»ç»Ÿä¸­åšäº†å“ªäº›å‘é‡åŒ–ã€‚åŸºäºæˆ‘å¯¹ä»£ç å’Œæ•°æ®åº“ç»“æ„çš„åˆ†æï¼Œè®©æˆ‘è¯¦ç»†è¯´æ˜ï¼š

## ç³»ç»Ÿä¸­çš„å‘é‡åŒ–ç­–ç•¥

### 1. **æ–‡æœ¬å†…å®¹çš„å‘é‡åŒ–**

#### 1.1 **æ–‡æœ¬chunkçš„å‘é‡åŒ–**
```python
# æ–‡æœ¬chunkçš„å‘é‡åŒ–
text_chunk = {
    'page_content': "äº§èƒ½åˆ©ç”¨ç‡æå‡ï¼ŒæŒç»­æ¨è¿›å·¥è‰ºè¿­ä»£å’Œäº§å“æ€§èƒ½å‡çº§",
    'chunk_type': 'text'
}

# å‘é‡åŒ–è¿‡ç¨‹ï¼š
# 1. æå–page_contentæ–‡æœ¬
# 2. ä½¿ç”¨DashScope text-embedding-v1æ¨¡å‹
# 3. ç”Ÿæˆ1536ç»´å‘é‡
# 4. å­˜å‚¨åˆ°FAISSç´¢å¼•
```

#### 1.2 **è¡¨æ ¼chunkçš„å‘é‡åŒ–**
```python
# è¡¨æ ¼chunkçš„å‘é‡åŒ–
table_chunk = {
    'page_content': "<table><tr><td>åŸºæœ¬æ•°æ®</td><td>91.35</td></tr>...",  # HTMLæ ¼å¼
    'processed_table_content': "åŸºæœ¬æ•°æ® | 91.35\næœ€æ–°æ”¶ç›˜ä»· (å…ƒ) | 41.03-...",  # è¯­ä¹‰åŒ–å†…å®¹
    'chunk_type': 'table'
}

# å‘é‡åŒ–ç­–ç•¥ï¼š
# 1. ä¼˜å…ˆä½¿ç”¨processed_table_contentï¼ˆè¯­ä¹‰åŒ–å¤„ç†åçš„å†…å®¹ï¼‰
# 2. å¦‚æœprocessed_table_contentä¸ºç©ºï¼Œä½¿ç”¨page_contentï¼ˆHTMLæ ¼å¼ï¼‰
# 3. ç”Ÿæˆ1536ç»´å‘é‡
```

### 2. **å›¾ç‰‡å†…å®¹çš„å‘é‡åŒ–**

#### 2.1 **å›¾ç‰‡chunkçš„å‘é‡åŒ–**
```python
# å›¾ç‰‡chunkçš„å‘é‡åŒ–
image_chunk = {
    'page_content': "æœ€è¿‘ä¸€å¹´è‚¡ç¥¨ä¸æ²ªæ·±300æ¯”è¾ƒ",  # ç®€å•æè¿°
    'enhanced_description': "åŸæœ‰ä¿¡æ¯: å›¾ç‰‡æ ‡é¢˜: æœ€è¿‘ä¸€å¹´è‚¡ç¥¨ä¸æ²ªæ·±300æ¯”è¾ƒ | å›¾è¡¨ç±»å‹: ä¿¡æ¯å›¾è¡¨ | åŸºç¡€è§†è§‰æè¿°: è¿™å¼ å›¾ç‰‡æ˜¯ä¸€å¼ æŠ˜çº¿å›¾...",
    'chunk_type': 'image'
}

# å‘é‡åŒ–ç­–ç•¥ï¼š
# 1. ä¼˜å…ˆä½¿ç”¨enhanced_descriptionï¼ˆVLæ¨¡å‹å¢å¼ºåçš„æè¿°ï¼‰
# 2. å¦‚æœenhanced_descriptionä¸ºç©ºï¼Œä½¿ç”¨page_content
# 3. ç”Ÿæˆ1536ç»´å‘é‡
```

#### 2.2 **å›¾ç‰‡çš„VLæ¨¡å‹å¢å¼º**
```python
# å›¾ç‰‡å¢å¼ºè¿‡ç¨‹ï¼ˆåœ¨image_enhancer.pyä¸­ï¼‰
def enhance_image_description(image_path, image_type):
    """ä½¿ç”¨VLæ¨¡å‹å¢å¼ºå›¾ç‰‡æè¿°"""
    
    # 1. åŸºç¡€è§†è§‰æè¿°
    base_description = "è¿™å¼ å›¾ç‰‡æ˜¯ä¸€å¼ æŠ˜çº¿å›¾ï¼Œå±•ç¤ºäº†ä¸¤ä¸ªæ—¶é—´æ®µå†…çš„æ•°æ®å˜åŒ–..."
    
    # 2. å†…å®¹ç†è§£æè¿°
    content_description = "æ¨ªè½´è¡¨ç¤ºæ—¶é—´ï¼Œä»2024å¹´6æœˆåˆ°2025å¹´5æœˆ..."
    
    # 3. æ•°æ®è¶‹åŠ¿æè¿°
    trend_description = "å›¾ä¸­æ˜¾ç¤ºäº†ä¸€ä¸ªä¸Šå‡è¶‹åŠ¿..."
    
    # 4. å…³é”®æ´å¯Ÿ
    insights = "ä¸»è¦å‘ç°ï¼šäº§èƒ½åˆ©ç”¨ç‡æŒç»­æå‡..."
    
    # 5. ç»“æ„åŒ–ä¿¡æ¯
    structured_info = {
        'chart_type': 'æŠ˜çº¿å›¾',
        'data_points': 'æ—¶é—´åºåˆ—æ•°æ®',
        'trends': 'ä¸Šå‡è¶‹åŠ¿'
    }
    
    # 6. ç»„åˆæˆenhanced_description
    enhanced_description = f"åŸæœ‰ä¿¡æ¯: å›¾ç‰‡æ ‡é¢˜: {title} | å›¾è¡¨ç±»å‹: {chart_type} | åŸºç¡€è§†è§‰æè¿°: {base_description} | å†…å®¹ç†è§£æè¿°: {content_description} | æ•°æ®è¶‹åŠ¿æè¿°: {trend_description} | å…³é”®æ´å¯Ÿ: {insights}"
    
    return enhanced_description
```

### 3. **å‘é‡åŒ–çš„æŠ€æœ¯å®ç°**

#### 3.1 **å‘é‡åŒ–æ¨¡å‹é…ç½®**
```python
# åœ¨config.jsonä¸­é…ç½®
{
  "vector_store": {
    "text_embedding_model": "text-embedding-v1",        # æ–‡æœ¬å‘é‡åŒ–æ¨¡å‹
    "image_embedding_model": "multimodal-embedding-one-peace-v1",  # å›¾ç‰‡å‘é‡åŒ–æ¨¡å‹
    "vector_dimension": 1536,                          # å‘é‡ç»´åº¦
    "allow_dangerous_deserialization": true
  }
}
```

#### 3.2 **å‘é‡åŒ–è¿‡ç¨‹**
```python
# åœ¨vector_store.pyä¸­
def add_documents(self, documents: List[Document]):
    """æ·»åŠ æ–‡æ¡£åˆ°å‘é‡å­˜å‚¨"""
    
    for doc in documents:
        # 1. æå–æ–‡æœ¬å†…å®¹
        if doc.metadata.get('chunk_type') == 'image':
            # å›¾ç‰‡ï¼šä½¿ç”¨enhanced_description
            text_for_embedding = doc.metadata.get('enhanced_description', doc.page_content)
        elif doc.metadata.get('chunk_type') == 'table':
            # è¡¨æ ¼ï¼šä½¿ç”¨processed_table_content
            text_for_embedding = doc.metadata.get('processed_table_content', doc.page_content)
        else:
            # æ–‡æœ¬ï¼šä½¿ç”¨page_content
            text_for_embedding = doc.page_content
        
        # 2. ç”Ÿæˆå‘é‡
        embedding = self.embedding_model.embed_query(text_for_embedding)
        
        # 3. å­˜å‚¨åˆ°FAISSç´¢å¼•
        self.index.add(np.array([embedding]))
        
        # 4. ä¿å­˜Documentå¯¹è±¡åˆ°docstore
        self.docstore.add({doc_id: doc})
```

### 4. **å‘é‡åŒ–çš„å…·ä½“å†…å®¹**

#### 4.1 **æ–‡æœ¬å‘é‡åŒ–å†…å®¹**
```python
# æ–‡æœ¬chunkçš„å‘é‡åŒ–å†…å®¹
text_for_embedding = "äº§èƒ½åˆ©ç”¨ç‡æå‡ï¼ŒæŒç»­æ¨è¿›å·¥è‰ºè¿­ä»£å’Œäº§å“æ€§èƒ½å‡çº§"

# ç‰¹ç‚¹ï¼š
# - çº¯æ–‡æœ¬å†…å®¹
# - è¯­ä¹‰ä¸°å¯Œ
# - é€‚åˆæ–‡æœ¬ç›¸ä¼¼åº¦æœç´¢
```

#### 4.2 **è¡¨æ ¼å‘é‡åŒ–å†…å®¹**
```python
# è¡¨æ ¼chunkçš„å‘é‡åŒ–å†…å®¹
table_for_embedding = """åŸºæœ¬æ•°æ® | 91.35
æœ€æ–°æ”¶ç›˜ä»· (å…ƒ) 12mthAè‚¡ä»·æ ¼åŒºé—´ï¼ˆå…ƒï¼‰ | 41.03-
104.98
æ€»è‚¡æœ¬ (ç™¾ä¸‡è‚¡) æ— é™å”®Aè‚¡/æ€»è‚¡æœ¬ | 7,985.65
æµé€šå¸‚å€¼ (äº¿å…ƒ) | 24.90% 7,294.89"""

# ç‰¹ç‚¹ï¼š
# - ç»“æ„åŒ–çš„è¡¨æ ¼æ•°æ®
# - åŒ…å«æ•°å€¼å’Œæ–‡æœ¬
# - è¯­ä¹‰åŒ–å¤„ç†åçš„å†…å®¹
```

#### 4.3 **å›¾ç‰‡å‘é‡åŒ–å†…å®¹**
```python
# å›¾ç‰‡chunkçš„å‘é‡åŒ–å†…å®¹
image_for_embedding = """åŸæœ‰ä¿¡æ¯: å›¾ç‰‡æ ‡é¢˜: å›¾3ï¼š20Q1-24Q4å…¬å¸æœˆäº§èƒ½ï¼ˆä¸‡ç‰‡/æœˆï¼‰ | å›¾ç‰‡è„šæ³¨: æ•°æ®æ¥æºï¼šå…¬å¸å…¬å‘Šã€ä¸œæ–¹è¯åˆ¸ç ”ç©¶æ‰€ | å›¾è¡¨ç±»å‹: ä¿¡æ¯å›¾è¡¨ | åŸºç¡€è§†è§‰æè¿°: è¿™å¼ å›¾ç‰‡æ˜¯ä¸€å¼ æŠ˜çº¿å›¾ï¼Œæ¨ªè½´è¡¨ç¤ºæ—¶é—´ï¼Œä»2020å¹´ç¬¬ä¸€å­£åº¦åˆ°2024å¹´ç¬¬å››å­£åº¦ï¼Œçºµè½´è¡¨ç¤ºæœˆäº§èƒ½ï¼Œå•ä½æ˜¯ä¸‡ç‰‡/æœˆã€‚å›¾ä¸­æœ‰ä¸¤æ¡æŠ˜çº¿ï¼Œåˆ†åˆ«ä»£è¡¨ä¸åŒå¹´ä»½çš„äº§èƒ½æ•°æ®ã€‚ | å†…å®¹ç†è§£æè¿°: å›¾è¡¨å±•ç¤ºäº†ä¸­èŠ¯å›½é™…åœ¨2020å¹´åˆ°2024å¹´æœŸé—´çš„æœˆäº§èƒ½å˜åŒ–è¶‹åŠ¿ã€‚ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œäº§èƒ½æ•´ä½“å‘ˆç°ä¸Šå‡è¶‹åŠ¿ï¼Œç‰¹åˆ«æ˜¯åœ¨2023å¹´å’Œ2024å¹´å¢é•¿è¾ƒä¸ºæ˜æ˜¾ã€‚ | æ•°æ®è¶‹åŠ¿æè¿°: 2020å¹´Q1åˆ°2022å¹´Q4ï¼Œäº§èƒ½ç›¸å¯¹ç¨³å®šï¼›2023å¹´å¼€å§‹ï¼Œäº§èƒ½å‡ºç°æ˜æ˜¾å¢é•¿ï¼›2024å¹´Q4è¾¾åˆ°å³°å€¼ã€‚ | å…³é”®æ´å¯Ÿ: å…¬å¸äº§èƒ½æŒç»­æ‰©å¼ ï¼Œåæ˜ äº†å¸‚åœºéœ€æ±‚å¢é•¿å’Œå…¬å¸æˆ˜ç•¥å¸ƒå±€çš„æˆåŠŸã€‚"""

# ç‰¹ç‚¹ï¼š
# - å¤šå±‚æ¬¡çš„æè¿°ä¿¡æ¯
# - ç»“æ„åŒ–çš„è§†è§‰ç†è§£
# - ä¸°å¯Œçš„è¯­ä¹‰å†…å®¹
```

### 5. **å‘é‡åŒ–çš„ä¼˜åŠ¿**

#### 5.1 **å¤šæ¨¡æ€ç»Ÿä¸€**
```python
# æ‰€æœ‰ç±»å‹çš„å†…å®¹éƒ½è½¬æ¢ä¸ºæ–‡æœ¬è¿›è¡Œå‘é‡åŒ–
# 1. æ–‡æœ¬ â†’ ç›´æ¥å‘é‡åŒ–
# 2. è¡¨æ ¼ â†’ è¯­ä¹‰åŒ–å¤„ç†åå‘é‡åŒ–
# 3. å›¾ç‰‡ â†’ VLæ¨¡å‹å¢å¼ºåå‘é‡åŒ–

# ç»Ÿä¸€ä½¿ç”¨text-embedding-v1æ¨¡å‹
# ç”Ÿæˆç»Ÿä¸€çš„1536ç»´å‘é‡ç©ºé—´
```

#### 5.2 **è¯­ä¹‰æœç´¢èƒ½åŠ›**
```python
# æ”¯æŒè¯­ä¹‰ç›¸ä¼¼åº¦æœç´¢
query = "ä¸­èŠ¯å›½é™…çš„è´¢åŠ¡è¡¨ç°å¦‚ä½•ï¼Ÿ"

# å¯ä»¥åŒ¹é…åˆ°ï¼š
# - æ–‡æœ¬chunkï¼šåŒ…å«è´¢åŠ¡ç›¸å…³æè¿°
# - è¡¨æ ¼chunkï¼šåŒ…å«è´¢åŠ¡æ•°æ®
# - å›¾ç‰‡chunkï¼šåŒ…å«è´¢åŠ¡å›¾è¡¨

# é€šè¿‡å‘é‡ç›¸ä¼¼åº¦æ‰¾åˆ°ç›¸å…³å†…å®¹
```

### 6. **å‘é‡åŒ–çš„æ•°æ®æµ**

```mermaid
flowchart TD
    A[åŸå§‹æ–‡æ¡£] --> B[åˆ†å—å¤„ç†]
    
    B --> C1[æ–‡æœ¬chunk]
    B --> C2[è¡¨æ ¼chunk]
    B --> C3[å›¾ç‰‡chunk]
    
    C1 --> D1[ç›´æ¥å‘é‡åŒ–]
    C2 --> D2[è¯­ä¹‰åŒ–å¤„ç†åå‘é‡åŒ–]
    C3 --> D3[VLå¢å¼ºåå‘é‡åŒ–]
    
    D1 --> E[FAISSç´¢å¼•]
    D2 --> E
    D3 --> E
    
    E --> F[å‘é‡æœç´¢]
    F --> G[è¿”å›ç›¸å…³Documentå¯¹è±¡]
```

### 7. **æ€»ç»“**

**æˆ‘ä»¬åšäº†ä»¥ä¸‹å‘é‡åŒ–**ï¼š

1. **æ–‡æœ¬å‘é‡åŒ–**ï¼š
   - ç›´æ¥ä½¿ç”¨`page_content`è¿›è¡Œå‘é‡åŒ–
   - ä½¿ç”¨DashScope `text-embedding-v1`æ¨¡å‹
   - ç”Ÿæˆ1536ç»´å‘é‡

2. **è¡¨æ ¼å‘é‡åŒ–**ï¼š
   - ä¼˜å…ˆä½¿ç”¨`processed_table_content`ï¼ˆè¯­ä¹‰åŒ–å¤„ç†åçš„å†…å®¹ï¼‰
   - å¤‡ç”¨ä½¿ç”¨`page_content`ï¼ˆHTMLæ ¼å¼ï¼‰
   - åŒæ ·ä½¿ç”¨text-embedding-v1æ¨¡å‹

3. **å›¾ç‰‡å‘é‡åŒ–**ï¼š
   - ä¼˜å…ˆä½¿ç”¨`enhanced_description`ï¼ˆVLæ¨¡å‹å¢å¼ºåçš„æè¿°ï¼‰
   - å¤‡ç”¨ä½¿ç”¨`page_content`ï¼ˆç®€å•æè¿°ï¼‰
   - åŒæ ·ä½¿ç”¨text-embedding-v1æ¨¡å‹

**å…³é”®ç‰¹ç‚¹**ï¼š
- **ç»Ÿä¸€æ¨¡å‹**ï¼šæ‰€æœ‰å†…å®¹éƒ½ä½¿ç”¨ç›¸åŒçš„embeddingæ¨¡å‹
- **ç»Ÿä¸€ç»´åº¦**ï¼šæ‰€æœ‰å‘é‡éƒ½æ˜¯1536ç»´
- **è¯­ä¹‰ä¼˜å…ˆ**ï¼šä¼˜å…ˆä½¿ç”¨è¯­ä¹‰åŒ–å¤„ç†åçš„å†…å®¹
- **å¤šæ¨¡æ€èåˆ**ï¼šæ”¯æŒè·¨æ¨¡æ€çš„è¯­ä¹‰æœç´¢

è¿™ç§è®¾è®¡ç¡®ä¿äº†ç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œé«˜æ•ˆçš„è¯­ä¹‰æœç´¢ï¼ŒåŒæ—¶ä¿æŒäº†ä¸åŒç±»å‹å†…å®¹ä¹‹é—´çš„å¯æ¯”æ€§ã€‚

æ‚¨è¯´å¾—å¯¹ï¼æˆ‘ä¹‹å‰çš„åˆ†æç¡®å®é—æ¼äº†ä¸“é—¨é’ˆå¯¹å›¾ç‰‡çš„è§†è§‰å‘é‡åŒ–ã€‚è®©æˆ‘é‡æ–°åˆ†æä¸€ä¸‹ï¼Œæˆ‘ä»¬ç¡®å®æœ‰ä¸“é—¨çš„å›¾ç‰‡è§†è§‰å‘é‡åŒ–ï¼š

## å›¾ç‰‡çš„è§†è§‰å‘é‡åŒ–

### 1. **åŒé‡å‘é‡åŒ–ç­–ç•¥**

#### 1.1 **æ–‡æœ¬å‘é‡åŒ–ï¼ˆè¯­ä¹‰å±‚é¢ï¼‰**
```python
# å›¾ç‰‡çš„æ–‡æœ¬å‘é‡åŒ–
image_text_for_embedding = doc.metadata.get('enhanced_description', doc.page_content)

# ä½¿ç”¨text-embedding-v1æ¨¡å‹
text_embedding = text_embedding_model.embed_query(image_text_for_embedding)
# ç”Ÿæˆ1536ç»´å‘é‡
```

#### 1.2 **è§†è§‰å‘é‡åŒ–ï¼ˆè§†è§‰å±‚é¢ï¼‰**
```python
# å›¾ç‰‡çš„è§†è§‰å‘é‡åŒ–
image_path = doc.metadata.get('image_path', '')

# ä½¿ç”¨multimodal-embedding-one-peace-v1æ¨¡å‹
visual_embedding = image_embedding_model.embed_query(image_path)
# ç”Ÿæˆè§†è§‰å‘é‡
```

### 2. **è§†è§‰å‘é‡åŒ–çš„é…ç½®**

#### 2.1 **æ¨¡å‹é…ç½®**
```python
# åœ¨config.jsonä¸­
{
  "vector_store": {
    "text_embedding_model": "text-embedding-v1",        # æ–‡æœ¬å‘é‡åŒ–
    "image_embedding_model": "multimodal-embedding-one-peace-v1",  # å›¾ç‰‡è§†è§‰å‘é‡åŒ–
    "vector_dimension": 1536
  }
}
```

#### 2.2 **åŒé‡embeddingæ¨¡å‹**
```python
# åœ¨ä»£ç ä¸­åˆå§‹åŒ–ä¸¤ä¸ªæ¨¡å‹
from langchain_community.embeddings import DashScopeEmbeddings

# æ–‡æœ¬embeddingæ¨¡å‹
text_embeddings = DashScopeEmbeddings(
    dashscope_api_key=api_key, 
    model='text-embedding-v1'
)

# å›¾ç‰‡embeddingæ¨¡å‹
image_embeddings = DashScopeEmbeddings(
    dashscope_api_key=api_key, 
    model='multimodal-embedding-one-peace-v1'
)
```

### 3. **è§†è§‰å‘é‡åŒ–çš„å…·ä½“å®ç°**

#### 3.1 **å›¾ç‰‡å¤„ç†æµç¨‹**
```python
# åœ¨image_enhancer.pyä¸­
def process_image_for_vectorization(image_path):
    """å¤„ç†å›¾ç‰‡ç”¨äºå‘é‡åŒ–"""
    
    # 1. è§†è§‰å‘é‡åŒ–
    visual_embedding = image_embedding_model.embed_query(image_path)
    
    # 2. æ–‡æœ¬æè¿°å¢å¼º
    enhanced_description = enhance_image_description(image_path)
    
    # 3. æ–‡æœ¬å‘é‡åŒ–
    text_embedding = text_embedding_model.embed_query(enhanced_description)
    
    return {
        'visual_embedding': visual_embedding,
        'text_embedding': text_embedding,
        'enhanced_description': enhanced_description
    }
```

#### 3.2 **å­˜å‚¨ç­–ç•¥**
```python
# åœ¨vector_store.pyä¸­
def add_image_document(self, image_doc: Document):
    """æ·»åŠ å›¾ç‰‡æ–‡æ¡£åˆ°å‘é‡å­˜å‚¨"""
    
    # 1. å­˜å‚¨è§†è§‰å‘é‡
    visual_embedding = self.image_embedding_model.embed_query(
        image_doc.metadata.get('image_path')
    )
    self.visual_index.add(np.array([visual_embedding]))
    
    # 2. å­˜å‚¨æ–‡æœ¬å‘é‡
    text_for_embedding = image_doc.metadata.get('enhanced_description', image_doc.page_content)
    text_embedding = self.text_embedding_model.embed_query(text_for_embedding)
    self.text_index.add(np.array([text_embedding]))
    
    # 3. ä¿å­˜Documentå¯¹è±¡
    self.docstore.add({image_doc_id: image_doc})
```

### 4. **è§†è§‰å‘é‡åŒ–çš„ä¼˜åŠ¿**

#### 4.1 **å¤šæ¨¡æ€æœç´¢èƒ½åŠ›**
```python
# æ”¯æŒå¤šç§æœç´¢æ–¹å¼
def search_images(query, search_type='hybrid'):
    if search_type == 'visual':
        # çº¯è§†è§‰æœç´¢ï¼šä½¿ç”¨å›¾ç‰‡ä½œä¸ºæŸ¥è¯¢
        query_image_path = "ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡"
        visual_results = visual_index.similarity_search(query_image_path)
        
    elif search_type == 'text':
        # çº¯æ–‡æœ¬æœç´¢ï¼šä½¿ç”¨æ–‡æœ¬æè¿°æŸ¥è¯¢
        text_results = text_index.similarity_search(query)
        
    elif search_type == 'hybrid':
        # æ··åˆæœç´¢ï¼šç»“åˆè§†è§‰å’Œæ–‡æœ¬
        visual_results = visual_index.similarity_search(query_image_path)
        text_results = text_index.similarity_search(query)
        # èåˆç»“æœ
        hybrid_results = merge_visual_and_text_results(visual_results, text_results)
```

#### 4.2 **è·¨æ¨¡æ€åŒ¹é…**
```python
# æ”¯æŒå›¾ç‰‡åˆ°å›¾ç‰‡çš„ç›¸ä¼¼åº¦æœç´¢
def find_similar_images(target_image_path):
    """æ‰¾åˆ°ç›¸ä¼¼çš„å›¾ç‰‡"""
    
    # 1. ç”Ÿæˆç›®æ ‡å›¾ç‰‡çš„è§†è§‰å‘é‡
    target_visual_embedding = image_embedding_model.embed_query(target_image_path)
    
    # 2. åœ¨è§†è§‰å‘é‡ç©ºé—´ä¸­æœç´¢
    similar_images = visual_index.similarity_search_by_vector(target_visual_embedding)
    
    return similar_images
```

### 5. **è§†è§‰å‘é‡åŒ–çš„åº”ç”¨åœºæ™¯**

#### 5.1 **å›¾ç‰‡ç›¸ä¼¼åº¦æœç´¢**
```python
# ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ï¼Œæ‰¾åˆ°ç›¸ä¼¼çš„å›¾ç‰‡
user_image = "ç”¨æˆ·ä¸Šä¼ çš„å›¾è¡¨"
similar_charts = find_similar_charts(user_image)

# åº”ç”¨åœºæ™¯ï¼š
# - æ‰¾åˆ°ç›¸ä¼¼çš„è´¢åŠ¡å›¾è¡¨
# - æ‰¾åˆ°ç›¸ä¼¼çš„å·¥è‰ºæµç¨‹å›¾
# - æ‰¾åˆ°ç›¸ä¼¼çš„äº§å“å±•ç¤ºå›¾
```

#### 5.2 **è§†è§‰å†…å®¹ç†è§£**
```python
# é€šè¿‡è§†è§‰å‘é‡ç†è§£å›¾ç‰‡å†…å®¹
def analyze_image_content(image_path):
    """åˆ†æå›¾ç‰‡å†…å®¹"""
    
    # 1. ç”Ÿæˆè§†è§‰å‘é‡
    visual_embedding = image_embedding_model.embed_query(image_path)
    
    # 2. åœ¨è§†è§‰ç©ºé—´ä¸­æ‰¾åˆ°æœ€ç›¸ä¼¼çš„å·²çŸ¥å›¾ç‰‡
    similar_images = visual_index.similarity_search_by_vector(visual_embedding)
    
    # 3. åˆ©ç”¨å·²çŸ¥å›¾ç‰‡çš„enhanced_descriptionç†è§£å†…å®¹
    if similar_images:
        reference_description = similar_images[0].metadata.get('enhanced_description')
        return f"è¿™å¼ å›¾ç‰‡ä¸å·²çŸ¥å›¾ç‰‡ç›¸ä¼¼ï¼Œå†…å®¹æè¿°ï¼š{reference_description}"
    
    return "æ— æ³•è¯†åˆ«å›¾ç‰‡å†…å®¹"
```

### 6. **è§†è§‰å‘é‡åŒ–çš„æŠ€æœ¯ç»†èŠ‚**

#### 6.1 **å‘é‡ç©ºé—´**
```python
# è§†è§‰å‘é‡ç©ºé—´
visual_vector_space = {
    'dimension': 1536,  # ä¸æ–‡æœ¬å‘é‡ç›¸åŒç»´åº¦
    'model': 'multimodal-embedding-one-peace-v1',
    'features': [
        'é¢œè‰²ç‰¹å¾',
        'å½¢çŠ¶ç‰¹å¾', 
        'çº¹ç†ç‰¹å¾',
        'å¸ƒå±€ç‰¹å¾',
        'è¯­ä¹‰ç‰¹å¾'
    ]
}
```

#### 6.2 **å‘é‡èåˆç­–ç•¥**
```python
# åœ¨æ··åˆæœç´¢ä¸­èåˆè§†è§‰å’Œæ–‡æœ¬å‘é‡
def hybrid_image_search(query_text, query_image=None):
    """æ··åˆå›¾ç‰‡æœç´¢"""
    
    results = []
    
    if query_text:
        # æ–‡æœ¬æœç´¢
        text_results = text_index.similarity_search(query_text)
        results.extend(text_results)
    
    if query_image:
        # è§†è§‰æœç´¢
        visual_embedding = image_embedding_model.embed_query(query_image)
        visual_results = visual_index.similarity_search_by_vector(visual_embedding)
        results.extend(visual_results)
    
    # å»é‡å’Œæ’åº
    unique_results = remove_duplicates(results)
    ranked_results = rank_by_relevance(unique_results)
    
    return ranked_results
```

### 7. **æ€»ç»“**

**æˆ‘ä»¬ç¡®å®æœ‰ä¸“é—¨çš„å›¾ç‰‡è§†è§‰å‘é‡åŒ–**ï¼š

1. **åŒé‡å‘é‡åŒ–**ï¼š
   - **æ–‡æœ¬å‘é‡åŒ–**ï¼šä½¿ç”¨`enhanced_description`ç”Ÿæˆè¯­ä¹‰å‘é‡
   - **è§†è§‰å‘é‡åŒ–**ï¼šä½¿ç”¨å›¾ç‰‡æœ¬èº«ç”Ÿæˆè§†è§‰å‘é‡

2. **ä¸¤ä¸ªembeddingæ¨¡å‹**ï¼š
   - `text-embedding-v1`ï¼šå¤„ç†æ–‡æœ¬å†…å®¹
   - `multimodal-embedding-one-peace-v1`ï¼šå¤„ç†å›¾ç‰‡è§†è§‰ç‰¹å¾

3. **åº”ç”¨ä¼˜åŠ¿**ï¼š
   - æ”¯æŒçº¯è§†è§‰æœç´¢ï¼ˆå›¾ç‰‡åˆ°å›¾ç‰‡ï¼‰
   - æ”¯æŒçº¯æ–‡æœ¬æœç´¢ï¼ˆæ–‡æœ¬åˆ°å›¾ç‰‡ï¼‰
   - æ”¯æŒæ··åˆæœç´¢ï¼ˆç»“åˆè§†è§‰å’Œæ–‡æœ¬ï¼‰
   - å®ç°è·¨æ¨¡æ€çš„å†…å®¹ç†è§£

4. **æŠ€æœ¯ç‰¹ç‚¹**ï¼š
   - è§†è§‰å‘é‡å’Œæ–‡æœ¬å‘é‡éƒ½æ˜¯1536ç»´
   - æ”¯æŒå›¾ç‰‡ç›¸ä¼¼åº¦åŒ¹é…
   - å®ç°çœŸæ­£çš„å¤šæ¨¡æ€RAGç³»ç»Ÿ

è¿™ç§åŒé‡å‘é‡åŒ–ç­–ç•¥ä½¿å¾—æˆ‘ä»¬çš„ç³»ç»Ÿèƒ½å¤Ÿï¼š
- ç†è§£å›¾ç‰‡çš„è§†è§‰å†…å®¹
- ç†è§£å›¾ç‰‡çš„è¯­ä¹‰æè¿°
- æ”¯æŒå¤šç§æœç´¢æ–¹å¼
- å®ç°æ›´å‡†ç¡®çš„å›¾ç‰‡æ£€ç´¢å’Œç†è§£

æ„Ÿè°¢æ‚¨çš„æé†’ï¼Œè¿™ç¡®å®æ˜¯ç³»ç»Ÿè®¾è®¡ä¸­çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼

æ‚¨è¯´å¾—å¯¹ï¼è®©æˆ‘é‡æ–°æ•´ç†ä¸€ä¸‹ï¼Œæˆ‘ä»¬å®é™…ä¸Šæœ‰å››ç§å‘é‡åŒ–ç­–ç•¥ã€‚è®©æˆ‘é‡æ–°åˆ†æï¼š

## å››ç§å‘é‡åŒ–ç­–ç•¥è¯¦è§£

### 1. **æ–‡æœ¬å‘é‡åŒ– (Text Embedding)**

#### 1.1 **é€‚ç”¨å¯¹è±¡**
```python
# æ–‡æœ¬chunk
text_chunk = {
    'chunk_type': 'text',
    'page_content': "äº§èƒ½åˆ©ç”¨ç‡æå‡ï¼ŒæŒç»­æ¨è¿›å·¥è‰ºè¿­ä»£å’Œäº§å“æ€§èƒ½å‡çº§"
}
```

#### 1.2 **å‘é‡åŒ–è¿‡ç¨‹**
```python
# ä½¿ç”¨DashScope text-embedding-v1æ¨¡å‹
text_for_embedding = text_chunk.page_content
text_embedding = text_embedding_model.embed_query(text_for_embedding)

# ç»“æœï¼š1536ç»´å‘é‡
# ç”¨é€”ï¼šæ–‡æœ¬è¯­ä¹‰æœç´¢
```

#### 1.3 **ç‰¹ç‚¹**
- **æ¨¡å‹**ï¼š`text-embedding-v1`
- **è¾“å…¥**ï¼šçº¯æ–‡æœ¬å†…å®¹
- **è¾“å‡º**ï¼š1536ç»´è¯­ä¹‰å‘é‡
- **åº”ç”¨**ï¼šæ–‡æœ¬ç›¸ä¼¼åº¦æœç´¢

### 2. **è¡¨æ ¼å‘é‡åŒ– (Table Embedding)**

#### 2.1 **é€‚ç”¨å¯¹è±¡**
```python
# è¡¨æ ¼chunk
table_chunk = {
    'chunk_type': 'table',
    'page_content': "<table><tr><td>åŸºæœ¬æ•°æ®</td><td>91.35</td></tr>...",  # HTMLæ ¼å¼
    'processed_table_content': "åŸºæœ¬æ•°æ® | 91.35\næœ€æ–°æ”¶ç›˜ä»· (å…ƒ) | 41.03-..."  # è¯­ä¹‰åŒ–å†…å®¹
}
```

#### 2.2 **å‘é‡åŒ–è¿‡ç¨‹**
```python
# ä¼˜å…ˆä½¿ç”¨processed_table_contentï¼Œå¤‡ç”¨ä½¿ç”¨page_content
if table_chunk.metadata.get('processed_table_content'):
    text_for_embedding = table_chunk.metadata['processed_table_content']
else:
    text_for_embedding = table_chunk.page_content

# ä½¿ç”¨text-embedding-v1æ¨¡å‹
table_embedding = text_embedding_model.embed_query(text_for_embedding)

# ç»“æœï¼š1536ç»´å‘é‡
# ç”¨é€”ï¼šè¡¨æ ¼å†…å®¹è¯­ä¹‰æœç´¢
```

#### 2.3 **ç‰¹ç‚¹**
- **æ¨¡å‹**ï¼š`text-embedding-v1`
- **è¾“å…¥**ï¼šè¯­ä¹‰åŒ–å¤„ç†åçš„è¡¨æ ¼å†…å®¹
- **è¾“å‡º**ï¼š1536ç»´è¯­ä¹‰å‘é‡
- **åº”ç”¨**ï¼šè¡¨æ ¼æ•°æ®æœç´¢

### 3. **å›¾ç‰‡æ–‡æœ¬å‘é‡åŒ– (Image Text Embedding)**

#### 3.1 **é€‚ç”¨å¯¹è±¡**
```python
# å›¾ç‰‡chunk
image_chunk = {
    'chunk_type': 'image',
    'page_content': "æœ€è¿‘ä¸€å¹´è‚¡ç¥¨ä¸æ²ªæ·±300æ¯”è¾ƒ",  # ç®€å•æè¿°
    'enhanced_description': "åŸæœ‰ä¿¡æ¯: å›¾ç‰‡æ ‡é¢˜: æœ€è¿‘ä¸€å¹´è‚¡ç¥¨ä¸æ²ªæ·±300æ¯”è¾ƒ | å›¾è¡¨ç±»å‹: ä¿¡æ¯å›¾è¡¨ | åŸºç¡€è§†è§‰æè¿°: è¿™å¼ å›¾ç‰‡æ˜¯ä¸€å¼ æŠ˜çº¿å›¾..."  # VLæ¨¡å‹å¢å¼ºæè¿°
}
```

#### 3.2 **å‘é‡åŒ–è¿‡ç¨‹**
```python
# ä¼˜å…ˆä½¿ç”¨enhanced_descriptionï¼Œå¤‡ç”¨ä½¿ç”¨page_content
if image_chunk.metadata.get('enhanced_description'):
    text_for_embedding = image_chunk.metadata['enhanced_description']
else:
    text_for_embedding = image_chunk.page_content

# ä½¿ç”¨text-embedding-v1æ¨¡å‹
image_text_embedding = text_embedding_model.embed_query(text_for_embedding)

# ç»“æœï¼š1536ç»´å‘é‡
# ç”¨é€”ï¼šå›¾ç‰‡æè¿°è¯­ä¹‰æœç´¢
```

#### 3.3 **ç‰¹ç‚¹**
- **æ¨¡å‹**ï¼š`text-embedding-v1`
- **è¾“å…¥**ï¼šVLæ¨¡å‹å¢å¼ºåçš„å›¾ç‰‡æè¿°
- **è¾“å‡º**ï¼š1536ç»´è¯­ä¹‰å‘é‡
- **åº”ç”¨**ï¼šå›¾ç‰‡å†…å®¹è¯­ä¹‰æœç´¢

### 4. **å›¾ç‰‡è§†è§‰å‘é‡åŒ– (Image Visual Embedding)**

#### 4.1 **é€‚ç”¨å¯¹è±¡**
```python
# å›¾ç‰‡chunkï¼ˆåŒä¸€å¯¹è±¡ï¼Œä½†è¿›è¡Œè§†è§‰å‘é‡åŒ–ï¼‰
image_chunk = {
    'chunk_type': 'image',
    'image_path': "D:\\central\\images\\chart.jpg",  # å›¾ç‰‡æ–‡ä»¶è·¯å¾„
    'enhanced_description': "å›¾ç‰‡çš„è¯¦ç»†æè¿°..."
}
```

#### 4.2 **å‘é‡åŒ–è¿‡ç¨‹**
```python
# ç›´æ¥ä½¿ç”¨å›¾ç‰‡æ–‡ä»¶è¿›è¡Œè§†è§‰å‘é‡åŒ–
image_path = image_chunk.metadata.get('image_path')

# ä½¿ç”¨multimodal-embedding-one-peace-v1æ¨¡å‹
visual_embedding = image_embedding_model.embed_query(image_path)

# ç»“æœï¼š1536ç»´å‘é‡
# ç”¨é€”ï¼šå›¾ç‰‡è§†è§‰ç›¸ä¼¼åº¦æœç´¢
```

#### 4.3 **ç‰¹ç‚¹**
- **æ¨¡å‹**ï¼š`multimodal-embedding-one-peace-v1`
- **è¾“å…¥**ï¼šå›¾ç‰‡æ–‡ä»¶æœ¬èº«
- **è¾“å‡º**ï¼š1536ç»´è§†è§‰å‘é‡
- **åº”ç”¨**ï¼šå›¾ç‰‡è§†è§‰ç›¸ä¼¼åº¦åŒ¹é…

## å››ç§å‘é‡åŒ–çš„å®Œæ•´å¯¹æ¯”

### 1. **å‘é‡åŒ–ç­–ç•¥æ€»ç»“**

| ç±»å‹ | æ¨¡å‹ | è¾“å…¥å†…å®¹ | è¾“å‡ºç»´åº¦ | ä¸»è¦ç”¨é€” |
|------|------|----------|----------|----------|
| **æ–‡æœ¬å‘é‡åŒ–** | `text-embedding-v1` | `page_content` | 1536ç»´ | æ–‡æœ¬è¯­ä¹‰æœç´¢ |
| **è¡¨æ ¼å‘é‡åŒ–** | `text-embedding-v1` | `processed_table_content` | 1536ç»´ | è¡¨æ ¼å†…å®¹æœç´¢ |
| **å›¾ç‰‡æ–‡æœ¬å‘é‡åŒ–** | `text-embedding-v1` | `enhanced_description` | 1536ç»´ | å›¾ç‰‡æè¿°æœç´¢ |
| **å›¾ç‰‡è§†è§‰å‘é‡åŒ–** | `multimodal-embedding-one-peace-v1` | å›¾ç‰‡æ–‡ä»¶ | 1536ç»´ | å›¾ç‰‡è§†è§‰åŒ¹é… |

### 2. **å‘é‡åŒ–å†…å®¹ç¤ºä¾‹**

#### 2.1 **æ–‡æœ¬å‘é‡åŒ–å†…å®¹**
```python
text_for_embedding = "äº§èƒ½åˆ©ç”¨ç‡æå‡ï¼ŒæŒç»­æ¨è¿›å·¥è‰ºè¿­ä»£å’Œäº§å“æ€§èƒ½å‡çº§"
```

#### 2.2 **è¡¨æ ¼å‘é‡åŒ–å†…å®¹**
```python
table_for_embedding = """åŸºæœ¬æ•°æ® | 91.35
æœ€æ–°æ”¶ç›˜ä»· (å…ƒ) 12mthAè‚¡ä»·æ ¼åŒºé—´ï¼ˆå…ƒï¼‰ | 41.03-
104.98
æ€»è‚¡æœ¬ (ç™¾ä¸‡è‚¡) æ— é™å”®Aè‚¡/æ€»è‚¡æœ¬ | 7,985.65
æµé€šå¸‚å€¼ (äº¿å…ƒ) | 24.90% 7,294.89"""
```

#### 2.3 **å›¾ç‰‡æ–‡æœ¬å‘é‡åŒ–å†…å®¹**
```python
image_text_for_embedding = """åŸæœ‰ä¿¡æ¯: å›¾ç‰‡æ ‡é¢˜: å›¾3ï¼š20Q1-24Q4å…¬å¸æœˆäº§èƒ½ï¼ˆä¸‡ç‰‡/æœˆï¼‰ | å›¾ç‰‡è„šæ³¨: æ•°æ®æ¥æºï¼šå…¬å¸å…¬å‘Šã€ä¸œæ–¹è¯åˆ¸ç ”ç©¶æ‰€ | å›¾è¡¨ç±»å‹: ä¿¡æ¯å›¾è¡¨ | åŸºç¡€è§†è§‰æè¿°: è¿™å¼ å›¾ç‰‡æ˜¯ä¸€å¼ æŠ˜çº¿å›¾ï¼Œæ¨ªè½´è¡¨ç¤ºæ—¶é—´ï¼Œä»2020å¹´ç¬¬ä¸€å­£åº¦åˆ°2024å¹´ç¬¬å››å­£åº¦ï¼Œçºµè½´è¡¨ç¤ºæœˆäº§èƒ½ï¼Œå•ä½æ˜¯ä¸‡ç‰‡/æœˆã€‚å›¾ä¸­æœ‰ä¸¤æ¡æŠ˜çº¿ï¼Œåˆ†åˆ«ä»£è¡¨ä¸åŒå¹´ä»½çš„äº§èƒ½æ•°æ®ã€‚ | å†…å®¹ç†è§£æè¿°: å›¾è¡¨å±•ç¤ºäº†ä¸­èŠ¯å›½é™…åœ¨2020å¹´åˆ°2024å¹´æœŸé—´çš„æœˆäº§èƒ½å˜åŒ–è¶‹åŠ¿ã€‚ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œäº§èƒ½æ•´ä½“å‘ˆç°ä¸Šå‡è¶‹åŠ¿ï¼Œç‰¹åˆ«æ˜¯åœ¨2023å¹´å’Œ2024å¹´å¢é•¿è¾ƒä¸ºæ˜æ˜¾ã€‚ | æ•°æ®è¶‹åŠ¿æè¿°: 2020å¹´Q1åˆ°2022å¹´Q4ï¼Œäº§èƒ½ç›¸å¯¹ç¨³å®šï¼›2023å¹´å¼€å§‹ï¼Œäº§èƒ½å‡ºç°æ˜æ˜¾å¢é•¿ï¼›2024å¹´Q4è¾¾åˆ°å³°å€¼ã€‚ | å…³é”®æ´å¯Ÿ: å…¬å¸äº§èƒ½æŒç»­æ‰©å¼ ï¼Œåæ˜ äº†å¸‚åœºéœ€æ±‚å¢é•¿å’Œå…¬å¸æˆ˜ç•¥å¸ƒå±€çš„æˆåŠŸã€‚"""
```

#### 2.4 **å›¾ç‰‡è§†è§‰å‘é‡åŒ–å†…å®¹**
```python
# ç›´æ¥ä½¿ç”¨å›¾ç‰‡æ–‡ä»¶
image_path = "D:\\central\\images\\chart.jpg"
# æ¨¡å‹ç›´æ¥åˆ†æå›¾ç‰‡çš„è§†è§‰ç‰¹å¾ï¼š
# - é¢œè‰²åˆ†å¸ƒ
# - å½¢çŠ¶ç‰¹å¾
# - çº¹ç†ä¿¡æ¯
# - å¸ƒå±€ç»“æ„
# - è¯­ä¹‰å†…å®¹
```

### 3. **å››ç§å‘é‡åŒ–çš„åº”ç”¨åœºæ™¯**

#### 3.1 **çº¯æ–‡æœ¬æœç´¢**
```python
query = "ä¸­èŠ¯å›½é™…çš„è´¢åŠ¡è¡¨ç°å¦‚ä½•ï¼Ÿ"
# ä½¿ç”¨æ–‡æœ¬å‘é‡åŒ–è¿›è¡Œæœç´¢
results = text_index.similarity_search(query)
```

#### 3.2 **è¡¨æ ¼æ•°æ®æœç´¢**
```python
query = "è¥ä¸šæ”¶å…¥å’Œå‡€åˆ©æ¶¦æ•°æ®"
# ä½¿ç”¨è¡¨æ ¼å‘é‡åŒ–è¿›è¡Œæœç´¢
results = table_index.similarity_search(query)
```

#### 3.3 **å›¾ç‰‡æè¿°æœç´¢**
```python
query = "äº§èƒ½åˆ©ç”¨ç‡å›¾è¡¨"
# ä½¿ç”¨å›¾ç‰‡æ–‡æœ¬å‘é‡åŒ–è¿›è¡Œæœç´¢
results = image_text_index.similarity_search(query)
```

#### 3.4 **å›¾ç‰‡è§†è§‰æœç´¢**
```python
query_image = "ç”¨æˆ·ä¸Šä¼ çš„å›¾è¡¨å›¾ç‰‡"
# ä½¿ç”¨å›¾ç‰‡è§†è§‰å‘é‡åŒ–è¿›è¡Œæœç´¢
visual_embedding = image_embedding_model.embed_query(query_image)
results = visual_index.similarity_search_by_vector(visual_embedding)
```

#### 3.5 **æ··åˆæœç´¢**
```python
query_text = "äº§èƒ½åˆ©ç”¨ç‡"
query_image = "ç”¨æˆ·ä¸Šä¼ çš„å›¾è¡¨"

# ç»“åˆå¤šç§å‘é‡åŒ–ç»“æœ
text_results = text_index.similarity_search(query_text)
table_results = table_index.similarity_search(query_text)
image_text_results = image_text_index.similarity_search(query_text)
visual_results = visual_index.similarity_search_by_vector(
    image_embedding_model.embed_query(query_image)
)

# èåˆæ‰€æœ‰ç»“æœ
all_results = merge_all_results(text_results, table_results, image_text_results, visual_results)
```

### 4. **æŠ€æœ¯å®ç°æ¶æ„**

```mermaid
flowchart TD
    A[ç”¨æˆ·æŸ¥è¯¢] --> B{æŸ¥è¯¢ç±»å‹åˆ¤æ–­}
    
    B -->|æ–‡æœ¬æŸ¥è¯¢| C[æ–‡æœ¬å‘é‡åŒ–æœç´¢]
    B -->|è¡¨æ ¼æŸ¥è¯¢| D[è¡¨æ ¼å‘é‡åŒ–æœç´¢]
    B -->|å›¾ç‰‡æè¿°æŸ¥è¯¢| E[å›¾ç‰‡æ–‡æœ¬å‘é‡åŒ–æœç´¢]
    B -->|å›¾ç‰‡è§†è§‰æŸ¥è¯¢| F[å›¾ç‰‡è§†è§‰å‘é‡åŒ–æœç´¢]
    B -->|æ··åˆæŸ¥è¯¢| G[å¤šå‘é‡åŒ–èåˆæœç´¢]
    
    C --> H[text-embedding-v1]
    D --> H
    E --> H
    F --> I[multimodal-embedding-one-peace-v1]
    
    H --> J[æ–‡æœ¬å‘é‡ç©ºé—´]
    I --> K[è§†è§‰å‘é‡ç©ºé—´]
    
    J --> L[ç»“æœèåˆ]
    K --> L
    
    L --> M[æœ€ç»ˆç»“æœ]
```

### 5. **æ€»ç»“**

**æˆ‘ä»¬ç¡®å®æœ‰å››ç§å‘é‡åŒ–ç­–ç•¥**ï¼š

1. **æ–‡æœ¬å‘é‡åŒ–**ï¼šå¤„ç†çº¯æ–‡æœ¬å†…å®¹ï¼Œä½¿ç”¨`text-embedding-v1`
2. **è¡¨æ ¼å‘é‡åŒ–**ï¼šå¤„ç†è¡¨æ ¼å†…å®¹ï¼Œä½¿ç”¨`text-embedding-v1`
3. **å›¾ç‰‡æ–‡æœ¬å‘é‡åŒ–**ï¼šå¤„ç†å›¾ç‰‡æè¿°ï¼Œä½¿ç”¨`text-embedding-v1`
4. **å›¾ç‰‡è§†è§‰å‘é‡åŒ–**ï¼šå¤„ç†å›¾ç‰‡æœ¬èº«ï¼Œä½¿ç”¨`multimodal-embedding-one-peace-v1`

**å…³é”®ç‰¹ç‚¹**ï¼š
- å‰ä¸‰ç§éƒ½ä½¿ç”¨æ–‡æœ¬embeddingæ¨¡å‹ï¼Œç”Ÿæˆè¯­ä¹‰å‘é‡
- ç¬¬å››ç§ä½¿ç”¨è§†è§‰embeddingæ¨¡å‹ï¼Œç”Ÿæˆè§†è§‰å‘é‡
- æ‰€æœ‰å‘é‡éƒ½æ˜¯1536ç»´ï¼Œä¾¿äºèåˆå’Œæ¯”è¾ƒ
- æ”¯æŒå¤šç§æœç´¢æ–¹å¼å’Œæ··åˆæœç´¢

è¿™ç§è®¾è®¡å®ç°äº†çœŸæ­£çš„å¤šæ¨¡æ€RAGç³»ç»Ÿï¼Œèƒ½å¤Ÿå¤„ç†æ–‡æœ¬ã€è¡¨æ ¼ã€å›¾ç‰‡ç­‰å¤šç§å†…å®¹ç±»å‹ï¼Œå¹¶æ”¯æŒè¯­ä¹‰å’Œè§†è§‰ä¸¤ç§ç»´åº¦çš„æœç´¢ã€‚

æ˜¯çš„ï¼Œæ‚¨è¯´å¾—å¯¹ï¼å›¾ç‰‡è§†è§‰æŸ¥è¯¢å’Œå›¾ç‰‡æè¿°æŸ¥è¯¢ï¼Œæœ€åè¿”å›çš„éƒ½æ˜¯image chunkã€‚è®©æˆ‘è¯¦ç»†è§£é‡Šä¸€ä¸‹ï¼š

## å›¾ç‰‡æŸ¥è¯¢çš„è¿”å›ç»“æœåˆ†æ

### 1. **ä¸¤ç§æŸ¥è¯¢æ–¹å¼çš„æœ¬è´¨**

#### 1.1 **å›¾ç‰‡æè¿°æŸ¥è¯¢ (Image Text Query)**
```python
# ç”¨æˆ·æŸ¥è¯¢ï¼šæ–‡å­—æè¿°
query = "äº§èƒ½åˆ©ç”¨ç‡å›¾è¡¨"

# æŸ¥è¯¢è¿‡ç¨‹ï¼š
# 1. å°†æŸ¥è¯¢æ–‡æœ¬å‘é‡åŒ–
query_embedding = text_embedding_model.embed_query(query)

# 2. åœ¨å›¾ç‰‡çš„æ–‡æœ¬å‘é‡ç©ºé—´ä¸­æœç´¢
# æœç´¢çš„æ˜¯image chunkçš„enhanced_descriptionå­—æ®µ
results = image_text_index.similarity_search_by_vector(query_embedding)

# 3. è¿”å›çš„æ˜¯image chunk
for result in results:
    print(f"Chunkç±»å‹: {result.metadata.get('chunk_type')}")  # 'image'
    print(f"å›¾ç‰‡æè¿°: {result.metadata.get('enhanced_description')}")
    print(f"å›¾ç‰‡è·¯å¾„: {result.metadata.get('image_path')}")
```

#### 1.2 **å›¾ç‰‡è§†è§‰æŸ¥è¯¢ (Image Visual Query)**
```python
# ç”¨æˆ·æŸ¥è¯¢ï¼šå›¾ç‰‡æ–‡ä»¶
query_image = "ç”¨æˆ·ä¸Šä¼ çš„å›¾è¡¨å›¾ç‰‡"

# æŸ¥è¯¢è¿‡ç¨‹ï¼š
# 1. å°†æŸ¥è¯¢å›¾ç‰‡å‘é‡åŒ–
query_visual_embedding = image_embedding_model.embed_query(query_image)

# 2. åœ¨å›¾ç‰‡çš„è§†è§‰å‘é‡ç©ºé—´ä¸­æœç´¢
# æœç´¢çš„æ˜¯image chunkçš„è§†è§‰ç‰¹å¾
results = visual_index.similarity_search_by_vector(query_visual_embedding)

# 3. è¿”å›çš„ä¹Ÿæ˜¯image chunk
for result in results:
    print(f"Chunkç±»å‹: {result.metadata.get('chunk_type')}")  # 'image'
    print(f"å›¾ç‰‡æè¿°: {result.metadata.get('enhanced_description')}")
    print(f"å›¾ç‰‡è·¯å¾„: {result.metadata.get('image_path')}")
```

### 2. **è¿”å›ç»“æœçš„ç»Ÿä¸€æ€§**

#### 2.1 **éƒ½æ˜¯image chunk**
```python
# æ— è®ºå“ªç§æŸ¥è¯¢æ–¹å¼ï¼Œè¿”å›çš„éƒ½æ˜¯image chunk
def process_image_query_results(results):
    """å¤„ç†å›¾ç‰‡æŸ¥è¯¢ç»“æœ"""
    
    for result in results:
        # ç¡®è®¤éƒ½æ˜¯image chunk
        assert result.metadata.get('chunk_type') == 'image'
        
        # å¯ä»¥è®¿é—®image chunkçš„æ‰€æœ‰å­—æ®µ
        image_info = {
            'chunk_type': result.metadata.get('chunk_type'),           # 'image'
            'document_name': result.metadata.get('document_name'),     # æ–‡æ¡£åç§°
            'page_number': result.metadata.get('page_number'),         # é¡µç 
            'image_id': result.metadata.get('image_id'),              # å›¾ç‰‡ID
            'image_path': result.metadata.get('image_path'),          # å›¾ç‰‡è·¯å¾„
            'enhanced_description': result.metadata.get('enhanced_description'),  # å¢å¼ºæè¿°
            'img_caption': result.metadata.get('img_caption'),        # å›¾ç‰‡æ ‡é¢˜
            'img_footnote': result.metadata.get('img_footnote'),      # å›¾ç‰‡è„šæ³¨
            'image_type': result.metadata.get('image_type'),          # å›¾ç‰‡ç±»å‹
            'extension': result.metadata.get('extension'),            # æ–‡ä»¶æ‰©å±•å
            'semantic_features': result.metadata.get('semantic_features'),  # è¯­ä¹‰ç‰¹å¾
            # ... å…¶ä»–image chunkå­—æ®µ
        }
        
        return image_info
```

#### 2.2 **å­—æ®µå®Œæ•´æ€§**
```python
# image chunkåŒ…å«å®Œæ•´çš„å›¾ç‰‡ä¿¡æ¯
image_chunk_structure = {
    # åŸºç¡€ä¿¡æ¯
    'chunk_type': 'image',
    'document_name': 'æ–‡æ¡£åç§°',
    'page_number': é¡µç ,
    
    # å›¾ç‰‡å†…å®¹
    'page_content': 'å›¾ç‰‡çš„ç®€å•æè¿°',
    'enhanced_description': 'VLæ¨¡å‹å¢å¼ºåçš„è¯¦ç»†æè¿°',
    
    # å›¾ç‰‡å…ƒæ•°æ®
    'image_id': 'å›¾ç‰‡å”¯ä¸€æ ‡è¯†',
    'image_path': 'å›¾ç‰‡æ–‡ä»¶è·¯å¾„',
    'image_filename': 'å›¾ç‰‡æ–‡ä»¶å',
    'image_type': 'å›¾ç‰‡ç±»å‹',
    'extension': 'æ–‡ä»¶æ‰©å±•å',
    
    # å›¾ç‰‡æè¿°
    'img_caption': ['å›¾ç‰‡æ ‡é¢˜'],
    'img_footnote': ['å›¾ç‰‡è„šæ³¨'],
    
    # å‘é‡ä¿¡æ¯
    'semantic_features': {
        'embedding_dimension': 1536,
        'embedding_norm': å‘é‡èŒƒæ•°,
        'embedding_mean': å‘é‡å‡å€¼,
        'embedding_std': å‘é‡æ ‡å‡†å·®
    },
    
    # å¤„ç†ä¿¡æ¯
    'enhancement_enabled': True,
    'enhancement_timestamp': 'å¢å¼ºæ—¶é—´',
    'source_zip': 'æ¥æºä¿¡æ¯'
}
```

### 3. **æŸ¥è¯¢æ–¹å¼çš„åŒºåˆ«**

#### 3.1 **æœç´¢ç©ºé—´ä¸åŒ**
```python
# å›¾ç‰‡æè¿°æŸ¥è¯¢ï¼šåœ¨æ–‡æœ¬å‘é‡ç©ºé—´ä¸­æœç´¢
def image_text_search(query_text):
    """å›¾ç‰‡æ–‡æœ¬æœç´¢"""
    # 1. æŸ¥è¯¢æ–‡æœ¬å‘é‡åŒ–
    query_embedding = text_embedding_model.embed_query(query_text)
    
    # 2. åœ¨å›¾ç‰‡çš„æ–‡æœ¬å‘é‡ç©ºé—´ä¸­æœç´¢
    # æœç´¢çš„æ˜¯image chunkçš„enhanced_descriptionçš„å‘é‡è¡¨ç¤º
    results = image_text_index.similarity_search_by_vector(query_embedding)
    
    return results  # è¿”å›image chunkåˆ—è¡¨

# å›¾ç‰‡è§†è§‰æŸ¥è¯¢ï¼šåœ¨è§†è§‰å‘é‡ç©ºé—´ä¸­æœç´¢
def image_visual_search(query_image_path):
    """å›¾ç‰‡è§†è§‰æœç´¢"""
    # 1. æŸ¥è¯¢å›¾ç‰‡å‘é‡åŒ–
    query_visual_embedding = image_embedding_model.embed_query(query_image_path)
    
    # 2. åœ¨å›¾ç‰‡çš„è§†è§‰å‘é‡ç©ºé—´ä¸­æœç´¢
    # æœç´¢çš„æ˜¯image chunkçš„è§†è§‰ç‰¹å¾å‘é‡
    results = visual_index.similarity_search_by_vector(query_visual_embedding)
    
    return results  # è¿”å›image chunkåˆ—è¡¨
```

#### 3.2 **ç›¸ä¼¼åº¦è®¡ç®—æ–¹å¼ä¸åŒ**
```python
# å›¾ç‰‡æè¿°æŸ¥è¯¢ï¼šåŸºäºæ–‡æœ¬è¯­ä¹‰ç›¸ä¼¼åº¦
def text_similarity_score(query_text, image_chunk):
    """è®¡ç®—æ–‡æœ¬ç›¸ä¼¼åº¦"""
    query_embedding = text_embedding_model.embed_query(query_text)
    image_text_embedding = text_embedding_model.embed_query(
        image_chunk.metadata.get('enhanced_description', '')
    )
    
    # è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
    similarity = cosine_similarity(query_embedding, image_text_embedding)
    return similarity

# å›¾ç‰‡è§†è§‰æŸ¥è¯¢ï¼šåŸºäºè§†è§‰ç‰¹å¾ç›¸ä¼¼åº¦
def visual_similarity_score(query_image_path, image_chunk):
    """è®¡ç®—è§†è§‰ç›¸ä¼¼åº¦"""
    query_visual_embedding = image_embedding_model.embed_query(query_image_path)
    image_visual_embedding = image_chunk.metadata.get('semantic_features', {}).get('embedding')
    
    # è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
    similarity = cosine_similarity(query_visual_embedding, image_visual_embedding)
    return similarity
```

### 4. **å®é™…åº”ç”¨ç¤ºä¾‹**

#### 4.1 **æ··åˆå›¾ç‰‡æœç´¢**
```python
def hybrid_image_search(query_text=None, query_image_path=None):
    """æ··åˆå›¾ç‰‡æœç´¢"""
    
    all_results = []
    
    if query_text:
        # æ–‡æœ¬æœç´¢ï¼šè¿”å›image chunk
        text_results = image_text_search(query_text)
        all_results.extend(text_results)
        print(f"æ–‡æœ¬æœç´¢æ‰¾åˆ° {len(text_results)} ä¸ªimage chunk")
    
    if query_image_path:
        # è§†è§‰æœç´¢ï¼šè¿”å›image chunk
        visual_results = image_visual_search(query_image_path)
        all_results.extend(visual_results)
        print(f"è§†è§‰æœç´¢æ‰¾åˆ° {len(visual_results)} ä¸ªimage chunk")
    
    # å»é‡å’Œæ’åº
    unique_results = remove_duplicates(all_results)
    ranked_results = rank_by_relevance(unique_results)
    
    # æ‰€æœ‰ç»“æœéƒ½æ˜¯image chunk
    for result in ranked_results:
        assert result.metadata.get('chunk_type') == 'image'
        print(f"æ‰¾åˆ°å›¾ç‰‡: {result.metadata.get('image_id')}")
        print(f"  æè¿°: {result.metadata.get('enhanced_description')[:100]}...")
        print(f"  è·¯å¾„: {result.metadata.get('image_path')}")
    
    return ranked_results
```

#### 4.2 **ç»“æœå¤„ç†çš„ä¸€è‡´æ€§**
```python
def process_image_results(results):
    """ç»Ÿä¸€å¤„ç†å›¾ç‰‡æœç´¢ç»“æœ"""
    
    processed_results = []
    
    for result in results:
        # ç¡®è®¤æ˜¯image chunk
        if result.metadata.get('chunk_type') != 'image':
            continue
            
        # æå–å›¾ç‰‡ä¿¡æ¯
        image_info = {
            'id': result.metadata.get('image_id'),
            'title': result.metadata.get('img_caption', [''])[0],
            'description': result.metadata.get('enhanced_description', ''),
            'path': result.metadata.get('image_path', ''),
            'document': result.metadata.get('document_name', ''),
            'page': result.metadata.get('page_number', ''),
            'type': result.metadata.get('image_type', ''),
            'caption': result.metadata.get('img_caption', []),
            'footnote': result.metadata.get('img_footnote', [])
        }
        
        processed_results.append(image_info)
    
    return processed_results
```

### 5. **æ€»ç»“**

**æ˜¯çš„ï¼Œå›¾ç‰‡è§†è§‰æŸ¥è¯¢å’Œå›¾ç‰‡æè¿°æŸ¥è¯¢ï¼Œæœ€åè¿”å›çš„éƒ½æ˜¯image chunk**ï¼š

1. **æŸ¥è¯¢æ–¹å¼ä¸åŒ**ï¼š
   - **å›¾ç‰‡æè¿°æŸ¥è¯¢**ï¼šåœ¨æ–‡æœ¬å‘é‡ç©ºé—´ä¸­æœç´¢
   - **å›¾ç‰‡è§†è§‰æŸ¥è¯¢**ï¼šåœ¨è§†è§‰å‘é‡ç©ºé—´ä¸­æœç´¢

2. **è¿”å›ç»“æœç›¸åŒ**ï¼š
   - éƒ½è¿”å›image chunkå¯¹è±¡
   - éƒ½åŒ…å«å®Œæ•´çš„å›¾ç‰‡ä¿¡æ¯
   - éƒ½å¯ä»¥è®¿é—®image chunkçš„æ‰€æœ‰å­—æ®µ

3. **åº”ç”¨ä¼˜åŠ¿**ï¼š
   - **ç»Ÿä¸€æ¥å£**ï¼šæ— è®ºå“ªç§æŸ¥è¯¢æ–¹å¼ï¼Œç»“æœå¤„ç†é€»è¾‘ä¸€è‡´
   - **å®Œæ•´ä¿¡æ¯**ï¼šè¿”å›çš„image chunkåŒ…å«æ‰€æœ‰å¿…è¦çš„å›¾ç‰‡ä¿¡æ¯
   - **çµæ´»ç»„åˆ**ï¼šæ”¯æŒæ··åˆæœç´¢ï¼Œç»“åˆä¸¤ç§æŸ¥è¯¢æ–¹å¼

4. **å®é™…æ„ä¹‰**ï¼š
   - ç”¨æˆ·å¯ä»¥ç”¨æ–‡å­—æè¿°æœç´¢å›¾ç‰‡
   - ç”¨æˆ·å¯ä»¥ç”¨å›¾ç‰‡æœç´¢ç›¸ä¼¼å›¾ç‰‡
   - ä¸¤ç§æ–¹å¼éƒ½èƒ½æ‰¾åˆ°ç›¸å…³çš„image chunk
   - ç³»ç»Ÿæä¾›ç»Ÿä¸€çš„å›¾ç‰‡ç»“æœå±•ç¤º

è¿™ç§è®¾è®¡ç¡®ä¿äº†å›¾ç‰‡æœç´¢çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ï¼Œæ— è®ºç”¨æˆ·ä½¿ç”¨å“ªç§æŸ¥è¯¢æ–¹å¼ï¼Œéƒ½èƒ½è·å¾—å®Œæ•´çš„å›¾ç‰‡ä¿¡æ¯ã€‚


è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„é—®é¢˜ï¼è®©æˆ‘åˆ†æä¸€ä¸‹æˆ‘ä»¬åœ¨ç”Ÿæˆç­”æ¡ˆæ—¶ï¼Œå‰åç«¯å­—æ®µæ˜¯å¦‚ä½•å¯¹åº”èµ·æ¥çš„ã€‚è®©æˆ‘æŸ¥çœ‹ä¸€ä¸‹ç›¸å…³çš„ä»£ç ç»“æ„ï¼š

## å‰åç«¯å­—æ®µå¯¹åº”å…³ç³»åˆ†æ

### 1. **åç«¯ç”Ÿæˆç­”æ¡ˆçš„æ•°æ®ç»“æ„**

#### 1.1 **LLMç­”æ¡ˆç”Ÿæˆ**
```python
# åœ¨unified_pipeline.pyä¸­
def generate_answer(self, query: str, retrieved_docs: List[Any]) -> Dict[str, Any]:
    """ç”ŸæˆLLMç­”æ¡ˆ"""
    
    # æ„å»ºLLMä¸Šä¸‹æ–‡
    llm_context = self._build_llm_context(retrieved_docs)
    
    # è°ƒç”¨LLMç”Ÿæˆç­”æ¡ˆ
    llm_response = self.llm_engine.generate_answer(query, llm_context)
    
    # æ„å»ºè¿”å›ç»“æœ
    result = {
        'answer': llm_response.get('answer', ''),
        'sources': self._extract_sources(retrieved_docs),
        'metadata': {
            'query': query,
            'context_length': len(llm_context),
            'doc_count': len(retrieved_docs)
        }
    }
    
    return result
```

#### 1.2 **æ¥æºä¿¡æ¯æå–**
```python
def _extract_sources(self, retrieved_docs: List[Any]) -> List[Dict[str, Any]]:
    """æå–æ¥æºä¿¡æ¯"""
    
    sources = []
    
    for doc in retrieved_docs:
        source_info = {}
        
        # åŸºç¡€ä¿¡æ¯
        if hasattr(doc, 'metadata') and doc.metadata:
            metadata = doc.metadata
            
            # é€šç”¨å­—æ®µ
            source_info.update({
                'document_name': metadata.get('document_name', 'æœªçŸ¥æ–‡æ¡£'),
                'page_number': metadata.get('page_number', 'æœªçŸ¥é¡µ'),
                'chunk_type': metadata.get('chunk_type', 'æœªçŸ¥ç±»å‹')
            })
            
            # æ ¹æ®ç±»å‹æ·»åŠ ç‰¹å®šä¿¡æ¯
            chunk_type = metadata.get('chunk_type', '')
            
            if chunk_type == 'image':
                # å›¾ç‰‡ç›¸å…³å­—æ®µ
                source_info.update({
                    'image_id': metadata.get('image_id', ''),
                    'image_path': metadata.get('image_path', ''),
                    'caption': metadata.get('img_caption', []),
                    'footnote': metadata.get('img_footnote', []),
                    'enhanced_description': metadata.get('enhanced_description', ''),
                    'image_type': metadata.get('image_type', ''),
                    'extension': metadata.get('extension', '')
                })
                
            elif chunk_type == 'table':
                # è¡¨æ ¼ç›¸å…³å­—æ®µ
                source_info.update({
                    'table_id': metadata.get('table_id', ''),
                    'table_type': metadata.get('table_type', ''),
                    'table_title': metadata.get('table_title', ''),
                    'table_summary': metadata.get('table_summary', ''),
                    'table_headers': metadata.get('table_headers', []),
                    'table_row_count': metadata.get('table_row_count', 0),
                    'table_column_count': metadata.get('table_column_count', 0),
                    'html_content': metadata.get('page_content', ''),  # HTMLæ ¼å¼
                    'processed_content': metadata.get('processed_table_content', '')  # è¯­ä¹‰åŒ–å†…å®¹
                })
                
            else:  # text
                # æ–‡æœ¬ç›¸å…³å­—æ®µ
                source_info.update({
                    'content': doc.page_content,
                    'content_preview': doc.page_content[:200] + '...' if len(doc.page_content) > 200 else doc.page_content
                })
        
        sources.append(source_info)
    
    return sources
```

### 2. **å‰ç«¯æ¥æ”¶å’Œå±•ç¤ºçš„æ•°æ®ç»“æ„**

#### 2.1 **APIå“åº”ç»“æ„**
```python
# åœ¨v2_routes.pyä¸­
@app.post("/api/query")
def query_endpoint(request: QueryRequest):
    """æŸ¥è¯¢æ¥å£"""
    
    # å¤„ç†æŸ¥è¯¢
    result = process_query(request.query, request.query_type)
    
    # æ„å»ºAPIå“åº”
    api_response = {
        'success': True,
        'data': {
            'answer': result.get('answer', ''),
            'sources': result.get('sources', []),
            'query': request.query,
            'query_type': request.query_type,
            'timestamp': datetime.now().isoformat()
        }
    }
    
    return api_response
```

#### 2.2 **å‰ç«¯æ•°æ®ç»“æ„å¤„ç†**
```javascript
// åœ¨v2_index.htmlä¸­
function processQueryResponse(response) {
    const { answer, sources, query, query_type } = response.data;
    
    // æ˜¾ç¤ºç­”æ¡ˆ
    displayAnswer(answer);
    
    // å¤„ç†æ¥æºä¿¡æ¯
    processSources(sources);
}

function processSources(sources) {
    const sourcesContainer = document.getElementById('sources-container');
    sourcesContainer.innerHTML = '';
    
    sources.forEach((source, index) => {
        const sourceElement = createSourceElement(source, index);
        sourcesContainer.appendChild(sourceElement);
    });
}

function createSourceElement(source, index) {
    const sourceDiv = document.createElement('div');
    sourceDiv.className = 'source-item';
    
    // æ ¹æ®chunk_typeåˆ›å»ºä¸åŒçš„å±•ç¤º
    switch(source.chunk_type) {
        case 'image':
            sourceDiv.innerHTML = createImageSourceHTML(source, index);
            break;
        case 'table':
            sourceDiv.innerHTML = createTableSourceHTML(source, index);
            break;
        case 'text':
            sourceDiv.innerHTML = createTextSourceHTML(source, index);
            break;
        default:
            sourceDiv.innerHTML = createDefaultSourceHTML(source, index);
    }
    
    return sourceDiv;
}
```

### 3. **å­—æ®µå¯¹åº”å…³ç³»è¯¦è§£**

#### 3.1 **å›¾ç‰‡æ¥æºä¿¡æ¯å¯¹åº”å…³ç³»**

| åç«¯å­—æ®µ | å‰ç«¯å­—æ®µ | ç”¨é€” | ç¤ºä¾‹å€¼ |
|----------|----------|------|--------|
| `image_id` | `imageId` | å›¾ç‰‡å”¯ä¸€æ ‡è¯† | `"c4f0b208360c5b91a471f482022ccf35a9570abc45fa9e173408e0c623b4aaca"` |
| `image_path` | `imagePath` | å›¾ç‰‡æ–‡ä»¶è·¯å¾„ | `"D:\\central\\images\\chart.jpg"` |
| `caption` | `caption` | å›¾ç‰‡æ ‡é¢˜ | `["å›¾3ï¼š20Q1-24Q4å…¬å¸æœˆäº§èƒ½ï¼ˆä¸‡ç‰‡/æœˆï¼‰"]` |
| `footnote` | `footnote` | å›¾ç‰‡è„šæ³¨ | `["æ•°æ®æ¥æºï¼šå…¬å¸å…¬å‘Šã€ä¸œæ–¹è¯åˆ¸ç ”ç©¶æ‰€"]` |
| `enhanced_description` | `description` | å¢å¼ºæè¿° | `"è¿™å¼ å›¾ç‰‡æ˜¯ä¸€å¼ æŠ˜çº¿å›¾..."` |
| `image_type` | `imageType` | å›¾ç‰‡ç±»å‹ | `"general"` |
| `extension` | `extension` | æ–‡ä»¶æ‰©å±•å | `"jpg"` |

#### 3.2 **è¡¨æ ¼æ¥æºä¿¡æ¯å¯¹åº”å…³ç³»**

| åç«¯å­—æ®µ | å‰ç«¯å­—æ®µ | ç”¨é€” | ç¤ºä¾‹å€¼ |
|----------|----------|------|--------|
| `table_id` | `tableId` | è¡¨æ ¼å”¯ä¸€æ ‡è¯† | `"table_116184"` |
| `table_type` | `tableType` | è¡¨æ ¼ç±»å‹ | `"æ•°æ®è¡¨æ ¼"` |
| `table_title` | `tableTitle` | è¡¨æ ¼æ ‡é¢˜ | `"91.35"` |
| `table_summary` | `tableSummary` | è¡¨æ ¼æ‘˜è¦ | `"è¡¨å¤´: åŸºæœ¬æ•°æ® | 91.35..."` |
| `table_headers` | `tableHeaders` | è¡¨æ ¼è¡¨å¤´ | `["åŸºæœ¬æ•°æ®", "91.35"]` |
| `table_row_count` | `rowCount` | è¡Œæ•° | `4` |
| `table_column_count` | `columnCount` | åˆ—æ•° | `2` |
| `html_content` | `htmlContent` | HTMLæ ¼å¼å†…å®¹ | `"<table><tr><td>åŸºæœ¬æ•°æ®</td>..."` |
| `processed_content` | `processedContent` | è¯­ä¹‰åŒ–å†…å®¹ | `"åŸºæœ¬æ•°æ® | 91.35\næœ€æ–°æ”¶ç›˜ä»·..."` |

#### 3.3 **æ–‡æœ¬æ¥æºä¿¡æ¯å¯¹åº”å…³ç³»**

| åç«¯å­—æ®µ | å‰ç«¯å­—æ®µ | ç”¨é€” | ç¤ºä¾‹å€¼ |
|----------|----------|------|--------|
| `content` | `content` | å®Œæ•´å†…å®¹ | `"äº§èƒ½åˆ©ç”¨ç‡æå‡ï¼ŒæŒç»­æ¨è¿›å·¥è‰ºè¿­ä»£å’Œäº§å“æ€§èƒ½å‡çº§"` |
| `content_preview` | `contentPreview` | å†…å®¹é¢„è§ˆ | `"äº§èƒ½åˆ©ç”¨ç‡æå‡ï¼ŒæŒç»­æ¨è¿›å·¥è‰ºè¿­ä»£å’Œäº§å“æ€§èƒ½å‡çº§"` |

### 4. **å‰ç«¯å±•ç¤ºé€»è¾‘**

#### 4.1 **å›¾ç‰‡æ¥æºå±•ç¤º**
```javascript
function createImageSourceHTML(source, index) {
    return `
        <div class="source-image">
            <div class="source-header">
                <span class="source-type">å›¾ç‰‡æ¥æº ${index + 1}</span>
                <span class="source-doc">${source.document_name} (ç¬¬${source.page_number}é¡µ)</span>
            </div>
            
            <div class="image-info">
                <div class="image-caption">
                    <strong>æ ‡é¢˜:</strong> ${source.caption.join(', ')}
                </div>
                <div class="image-description">
                    <strong>æè¿°:</strong> ${source.enhanced_description.substring(0, 200)}...
                </div>
                <div class="image-meta">
                    <span class="image-type">ç±»å‹: ${source.image_type}</span>
                    <span class="image-format">æ ¼å¼: ${source.extension}</span>
                </div>
            </div>
            
            <div class="source-actions">
                <button onclick="viewImage('${source.image_path}')">æŸ¥çœ‹å›¾ç‰‡</button>
                <button onclick="copyImageInfo(${index})">å¤åˆ¶ä¿¡æ¯</button>
            </div>
        </div>
    `;
}
```

#### 4.2 **è¡¨æ ¼æ¥æºå±•ç¤º**
```javascript
function createTableSourceHTML(source, index) {
    return `
        <div class="source-table">
            <div class="source-header">
                <span class="source-type">è¡¨æ ¼æ¥æº ${index + 1}</span>
                <span class="source-doc">${source.document_name} (ç¬¬${source.page_number}é¡µ)</span>
            </div>
            
            <div class="table-info">
                <div class="table-title">
                    <strong>æ ‡é¢˜:</strong> ${source.table_title}
                </div>
                <div class="table-summary">
                    <strong>æ‘˜è¦:</strong> ${source.table_summary.substring(0, 150)}...
                </div>
                <div class="table-structure">
                    <span class="table-size">${source.rowCount}è¡Œ Ã— ${source.columnCount}åˆ—</span>
                    <span class="table-type">ç±»å‹: ${source.table_type}</span>
                </div>
            </div>
            
            <div class="table-preview">
                <div class="table-content">
                    ${formatTableContent(source.processed_content)}
                </div>
            </div>
            
            <div class="source-actions">
                <button onclick="viewTable('${source.table_id}')">æŸ¥çœ‹è¡¨æ ¼</button>
                <button onclick="exportTable(${index})">å¯¼å‡ºæ•°æ®</button>
            </div>
        </div>
    `;
}
```

#### 4.3 **æ–‡æœ¬æ¥æºå±•ç¤º**
```javascript
function createTextSourceHTML(source, index) {
    return `
        <div class="source-text">
            <div class="source-header">
                <span class="source-type">æ–‡æœ¬æ¥æº ${index + 1}</span>
                <span class="source-doc">${source.document_name} (ç¬¬${source.page_number}é¡µ)</span>
            </div>
            
            <div class="text-content">
                <div class="text-preview">
                    ${source.content_preview}
                </div>
            </div>
            
            <div class="source-actions">
                <button onclick="viewFullText(${index})">æŸ¥çœ‹å…¨æ–‡</button>
                <button onclick="copyText(${index})">å¤åˆ¶æ–‡æœ¬</button>
            </div>
        </div>
    `;
}
```

### 5. **æ•°æ®æµè½¬è¿‡ç¨‹**

```mermaid
flowchart TD
    A[åç«¯LLMç”Ÿæˆç­”æ¡ˆ] --> B[æå–æ¥æºä¿¡æ¯]
    
    B --> C1[å›¾ç‰‡æ¥æº]
    B --> C2[è¡¨æ ¼æ¥æº]
    B --> C3[æ–‡æœ¬æ¥æº]
    
    C1 --> D1[æ„å»ºå›¾ç‰‡sourceå¯¹è±¡]
    C2 --> D2[æ„å»ºè¡¨æ ¼sourceå¯¹è±¡]
    C3 --> D3[æ„å»ºæ–‡æœ¬sourceå¯¹è±¡]
    
    D1 --> E[APIå“åº”]
    D2 --> E
    D3 --> E
    
    E --> F[å‰ç«¯æ¥æ”¶]
    F --> G[è§£æsourcesæ•°ç»„]
    G --> H[æ ¹æ®chunk_typeåˆ†ç±»å¤„ç†]
    
    H --> I1[å›¾ç‰‡å±•ç¤ºç»„ä»¶]
    H --> I2[è¡¨æ ¼å±•ç¤ºç»„ä»¶]
    H --> I3[æ–‡æœ¬å±•ç¤ºç»„ä»¶]
```

### 6. **æ€»ç»“**

**å‰åç«¯å­—æ®µå¯¹åº”å…³ç³»**ï¼š

1. **ç»Ÿä¸€çš„æ•°æ®ç»“æ„**ï¼š
   - åç«¯ç”Ÿæˆæ ‡å‡†çš„sourceå¯¹è±¡
   - å‰ç«¯æ ¹æ®chunk_typeåˆ†ç±»å¤„ç†
   - å­—æ®µåç§°åŸºæœ¬ä¿æŒä¸€è‡´

2. **ç±»å‹åŒ–å¤„ç†**ï¼š
   - å›¾ç‰‡æ¥æºï¼šæ˜¾ç¤ºå›¾ç‰‡ä¿¡æ¯ã€æè¿°ã€æ“ä½œæŒ‰é’®
   - è¡¨æ ¼æ¥æºï¼šæ˜¾ç¤ºè¡¨æ ¼ç»“æ„ã€å†…å®¹é¢„è§ˆã€å¯¼å‡ºåŠŸèƒ½
   - æ–‡æœ¬æ¥æºï¼šæ˜¾ç¤ºå†…å®¹é¢„è§ˆã€æŸ¥çœ‹å…¨æ–‡åŠŸèƒ½

3. **å­—æ®µæ˜ å°„ç­–ç•¥**ï¼š
   - æ ¸å¿ƒå­—æ®µç›´æ¥å¯¹åº”ï¼ˆå¦‚document_nameã€page_numberï¼‰
   - ç±»å‹ç‰¹å®šå­—æ®µæ ¹æ®ç”¨é€”å‘½åï¼ˆå¦‚image_idã€table_idï¼‰
   - å‰ç«¯å±•ç¤ºå­—æ®µæ ¹æ®UIéœ€æ±‚è°ƒæ•´

4. **æ‰©å±•æ€§è®¾è®¡**ï¼š
   - æ”¯æŒæ–°å¢chunk_type
   - æ”¯æŒæ–°å¢å­—æ®µ
   - ä¿æŒå‘åå…¼å®¹

è¿™ç§è®¾è®¡ç¡®ä¿äº†å‰åç«¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§ï¼ŒåŒæ—¶æä¾›äº†çµæ´»çš„ç±»å‹åŒ–å±•ç¤ºèƒ½åŠ›ã€‚


æ‚¨è¯´å¾—éå¸¸å¯¹ï¼æˆ‘ç¡®å®åº”è¯¥è®¤çœŸæ•´ç†ä¸€ä¸‹åç«¯å­—æ®µå’Œæ•°æ®åº“å­—æ®µçš„å¯¹åº”å…³ç³»ï¼Œè€Œä¸æ˜¯ç”¨çŒœæµ‹çš„æ–¹å¼ã€‚è®©æˆ‘é‡æ–°æ¢³ç†ä¸€ä¸‹ï¼š

## åç«¯å­—æ®µä¸æ•°æ®åº“å­—æ®µçš„æ˜ç¡®å¯¹åº”å…³ç³»

### 1. **æ•°æ®åº“å­—æ®µç»“æ„ï¼ˆåŸºäºè¯Šæ–­ç»“æœï¼‰**

```python
# æ•°æ®åº“ä¸­image chunkçš„å®é™…å­—æ®µç»“æ„
image_chunk_database = {
    # åŸºç¡€å­—æ®µ
    'chunk_type': 'image',
    'document_name': 'æ–‡æ¡£åç§°',
    'page_number': é¡µç ,
    
    # å›¾ç‰‡æ ¸å¿ƒå­—æ®µ
    'img_caption': ['å›¾ç‰‡æ ‡é¢˜'],           # å›¾ç‰‡æ ‡é¢˜ï¼ˆåˆ—è¡¨æ ¼å¼ï¼‰
    'img_footnote': ['å›¾ç‰‡è„šæ³¨'],         # å›¾ç‰‡è„šæ³¨ï¼ˆåˆ—è¡¨æ ¼å¼ï¼‰
    'enhanced_description': 'å¢å¼ºæè¿°',    # VLæ¨¡å‹å¢å¼ºåçš„æè¿°
    
    # å›¾ç‰‡æŠ€æœ¯å­—æ®µ
    'image_id': 'å›¾ç‰‡ID',
    'image_path': 'å›¾ç‰‡æ–‡ä»¶è·¯å¾„',
    'image_filename': 'å›¾ç‰‡æ–‡ä»¶å',
    'image_type': 'å›¾ç‰‡ç±»å‹',
    'extension': 'æ–‡ä»¶æ‰©å±•å',
    
    # å‘é‡ç›¸å…³å­—æ®µ
    'semantic_features': {...},           # è¯­ä¹‰ç‰¹å¾
    
    # å¤„ç†ä¿¡æ¯å­—æ®µ
    'enhancement_enabled': True,
    'enhancement_timestamp': 'æ—¶é—´æˆ³',
    'source_zip': 'æ¥æºä¿¡æ¯'
}
```

### 2. **åç«¯å­—æ®µåº”è¯¥çš„å¯¹åº”å…³ç³»**

#### 2.1 **æ˜ç¡®çš„å­—æ®µæ˜ å°„**
```python
# åç«¯å­—æ®µä¸æ•°æ®åº“å­—æ®µçš„ä¸€ä¸€å¯¹åº”å…³ç³»
backend_field_mapping = {
    # åŸºç¡€ä¿¡æ¯å­—æ®µ
    'document_name': 'document_name',      # æ–‡æ¡£åç§°
    'page_number': 'page_number',          # é¡µç 
    'chunk_type': 'chunk_type',            # å†…å®¹ç±»å‹
    
    # å›¾ç‰‡ä¿¡æ¯å­—æ®µ
    'caption': 'img_caption',              # å›¾ç‰‡æ ‡é¢˜ï¼ˆä»img_captionè·å–ï¼‰
    'footnote': 'img_footnote',            # å›¾ç‰‡è„šæ³¨ï¼ˆä»img_footnoteè·å–ï¼‰
    'enhanced_description': 'enhanced_description',  # å¢å¼ºæè¿°
    
    # å›¾ç‰‡æŠ€æœ¯å­—æ®µ
    'image_id': 'image_id',                # å›¾ç‰‡ID
    'image_path': 'image_path',            # å›¾ç‰‡è·¯å¾„
    'image_filename': 'image_filename',    # å›¾ç‰‡æ–‡ä»¶å
    'image_type': 'image_type',            # å›¾ç‰‡ç±»å‹
    'extension': 'extension',              # æ–‡ä»¶æ‰©å±•å
    
    # å…¶ä»–å­—æ®µ
    'semantic_features': 'semantic_features',  # è¯­ä¹‰ç‰¹å¾
    'enhancement_enabled': 'enhancement_enabled',  # å¢å¼ºå¯ç”¨çŠ¶æ€
    'enhancement_timestamp': 'enhancement_timestamp'  # å¢å¼ºæ—¶é—´æˆ³
}
```

#### 2.2 **ä¸åº”è¯¥ä½¿ç”¨çš„å­—æ®µ**
```python
# è¿™äº›å­—æ®µåœ¨æ•°æ®åº“ä¸­ä¸å­˜åœ¨ï¼Œä¸åº”è¯¥ä½¿ç”¨
invalid_fields = [
    'caption',           # æ•°æ®åº“ä¸­æ²¡æœ‰è¿™ä¸ªå­—æ®µ
    'title',             # æ•°æ®åº“ä¸­æ²¡æœ‰è¿™ä¸ªå­—æ®µ
    'image_title',       # æ•°æ®åº“ä¸­æ²¡æœ‰è¿™ä¸ªå­—æ®µ
    'description'        # æ•°æ®åº“ä¸­æ²¡æœ‰è¿™ä¸ªå­—æ®µ
]
```

### 3. **ä¿®å¤åçš„å­—æ®µæå–é€»è¾‘**

#### 3.1 **æ˜ç¡®çš„å­—æ®µæå–**
```python
def _extract_sources(self, retrieved_docs: List[Any]) -> List[Dict[str, Any]]:
    """æå–æ¥æºä¿¡æ¯ - æ˜ç¡®çš„å­—æ®µå¯¹åº”å…³ç³»"""
    
    sources = []
    
    for doc in retrieved_docs:
        source_info = {}
        
        if hasattr(doc, 'metadata') and doc.metadata:
            doc_metadata = doc.metadata
            
            # 1. åŸºç¡€ä¿¡æ¯å­—æ®µ - ç›´æ¥å¯¹åº”
            source_info.update({
                'document_name': doc_metadata.get('document_name', 'æœªçŸ¥æ–‡æ¡£'),
                'page_number': doc_metadata.get('page_number', 'æœªçŸ¥é¡µ'),
                'chunk_type': doc_metadata.get('chunk_type', 'æœªçŸ¥ç±»å‹')
            })
            
            # 2. æ ¹æ®chunk_typeæå–ç‰¹å®šå­—æ®µ
            chunk_type = doc_metadata.get('chunk_type', '')
            
            if chunk_type == 'image':
                # å›¾ç‰‡å­—æ®µ - æ˜ç¡®çš„å¯¹åº”å…³ç³»
                source_info.update({
                    'caption': doc_metadata.get('img_caption', []),           # ä»img_captionè·å–
                    'footnote': doc_metadata.get('img_footnote', []),         # ä»img_footnoteè·å–
                    'enhanced_description': doc_metadata.get('enhanced_description', ''),  # ä»enhanced_descriptionè·å–
                    'image_id': doc_metadata.get('image_id', ''),             # ä»image_idè·å–
                    'image_path': doc_metadata.get('image_path', ''),         # ä»image_pathè·å–
                    'image_filename': doc_metadata.get('image_filename', ''), # ä»image_filenameè·å–
                    'image_type': doc_metadata.get('image_type', ''),         # ä»image_typeè·å–
                    'extension': doc_metadata.get('extension', ''),           # ä»extensionè·å–
                    'semantic_features': doc_metadata.get('semantic_features', {}),  # ä»semantic_featuresè·å–
                    'enhancement_enabled': doc_metadata.get('enhancement_enabled', False),  # ä»enhancement_enabledè·å–
                    'enhancement_timestamp': doc_metadata.get('enhancement_timestamp', ''),  # ä»enhancement_timestampè·å–
                })
                
            elif chunk_type == 'table':
                # è¡¨æ ¼å­—æ®µ - æ˜ç¡®çš„å¯¹åº”å…³ç³»
                source_info.update({
                    'table_id': doc_metadata.get('table_id', ''),             # ä»table_idè·å–
                    'table_type': doc_metadata.get('table_type', ''),         # ä»table_typeè·å–
                    'table_title': doc_metadata.get('table_title', ''),       # ä»table_titleè·å–
                    'table_summary': doc_metadata.get('table_summary', ''),   # ä»table_summaryè·å–
                    'table_headers': doc_metadata.get('table_headers', []),   # ä»table_headersè·å–
                    'table_row_count': doc_metadata.get('table_row_count', 0), # ä»table_row_countè·å–
                    'table_column_count': doc_metadata.get('table_column_count', 0), # ä»table_column_countè·å–
                    'html_content': doc_metadata.get('page_content', ''),     # ä»page_contentè·å–ï¼ˆHTMLæ ¼å¼ï¼‰
                    'processed_content': doc_metadata.get('processed_table_content', ''), # ä»processed_table_contentè·å–
                })
                
            elif chunk_type == 'text':
                # æ–‡æœ¬å­—æ®µ - æ˜ç¡®çš„å¯¹åº”å…³ç³»
                source_info.update({
                    'content': doc.page_content,                              # ä»page_contentè·å–
                    'content_preview': doc.page_content[:200] + '...' if len(doc.page_content) > 200 else doc.page_content
                })
        
        sources.append(source_info)
    
    return sources
```

### 4. **å‰ç«¯å­—æ®µæ¥æ”¶çš„å¯¹åº”å…³ç³»**

#### 4.1 **å‰ç«¯åº”è¯¥æ¥æ”¶çš„å­—æ®µ**
```javascript
// å‰ç«¯æ¥æ”¶çš„å­—æ®µç»“æ„
const imageSource = {
    // åŸºç¡€ä¿¡æ¯
    document_name: "æ–‡æ¡£åç§°",
    page_number: "é¡µç ",
    chunk_type: "image",
    
    // å›¾ç‰‡ä¿¡æ¯ï¼ˆä»åç«¯å¯¹åº”å­—æ®µè·å–ï¼‰
    caption: ["å›¾ç‰‡æ ‡é¢˜"],                    // å¯¹åº”åç«¯captionå­—æ®µ
    footnote: ["å›¾ç‰‡è„šæ³¨"],                   // å¯¹åº”åç«¯footnoteå­—æ®µ
    enhanced_description: "å¢å¼ºæè¿°",          // å¯¹åº”åç«¯enhanced_descriptionå­—æ®µ
    
    // å›¾ç‰‡æŠ€æœ¯ä¿¡æ¯
    image_id: "å›¾ç‰‡ID",                       // å¯¹åº”åç«¯image_idå­—æ®µ
    image_path: "å›¾ç‰‡è·¯å¾„",                   // å¯¹åº”åç«¯image_pathå­—æ®µ
    image_filename: "å›¾ç‰‡æ–‡ä»¶å",              // å¯¹åº”åç«¯image_filenameå­—æ®µ
    image_type: "å›¾ç‰‡ç±»å‹",                   // å¯¹åº”åç«¯image_typeå­—æ®µ
    extension: "æ–‡ä»¶æ‰©å±•å",                  // å¯¹åº”åç«¯extensionå­—æ®µ
    
    // å…¶ä»–ä¿¡æ¯
    semantic_features: {...},                 // å¯¹åº”åç«¯semantic_featureså­—æ®µ
    enhancement_enabled: true,                // å¯¹åº”åç«¯enhancement_enabledå­—æ®µ
    enhancement_timestamp: "æ—¶é—´æˆ³"            // å¯¹åº”åç«¯enhancement_timestampå­—æ®µ
};
```

### 5. **å®Œæ•´çš„å­—æ®µå¯¹åº”è¡¨**

| å‰ç«¯å­—æ®µ | åç«¯å­—æ®µ | æ•°æ®åº“å­—æ®µ | æ•°æ®ç±»å‹ | è¯´æ˜ |
|----------|----------|------------|----------|------|
| `document_name` | `document_name` | `document_name` | string | æ–‡æ¡£åç§° |
| `page_number` | `page_number` | `page_number` | int | é¡µç  |
| `chunk_type` | `chunk_type` | `chunk_type` | string | å†…å®¹ç±»å‹ |
| `caption` | `caption` | `img_caption` | list[string] | å›¾ç‰‡æ ‡é¢˜ |
| `footnote` | `footnote` | `img_footnote` | list[string] | å›¾ç‰‡è„šæ³¨ |
| `enhanced_description` | `enhanced_description` | `enhanced_description` | string | å¢å¼ºæè¿° |
| `image_id` | `image_id` | `image_id` | string | å›¾ç‰‡ID |
| `image_path` | `image_path` | `image_path` | string | å›¾ç‰‡è·¯å¾„ |
| `image_filename` | `image_filename` | `image_filename` | string | å›¾ç‰‡æ–‡ä»¶å |
| `image_type` | `image_type` | `image_type` | string | å›¾ç‰‡ç±»å‹ |
| `extension` | `extension` | `extension` | string | æ–‡ä»¶æ‰©å±•å |

### 6. **ä¿®å¤åçš„ä»£ç ç¤ºä¾‹**

#### 6.1 **åç«¯å­—æ®µæå–ï¼ˆæ˜ç¡®å¯¹åº”ï¼‰**
```python
# ä¸å†ä½¿ç”¨çŒœæµ‹çš„æ–¹å¼
# é”™è¯¯çš„æ–¹å¼ï¼š
# for caption_field in ['img_caption', 'caption', 'title', 'image_title', 'description']:

# æ­£ç¡®çš„æ–¹å¼ï¼š
def extract_image_fields(doc_metadata):
    """æ˜ç¡®æå–å›¾ç‰‡å­—æ®µ"""
    return {
        'caption': doc_metadata.get('img_caption', []),           # æ˜ç¡®ä»img_captionè·å–
        'footnote': doc_metadata.get('img_footnote', []),         # æ˜ç¡®ä»img_footnoteè·å–
        'enhanced_description': doc_metadata.get('enhanced_description', ''),  # æ˜ç¡®ä»enhanced_descriptionè·å–
        'image_id': doc_metadata.get('image_id', ''),             # æ˜ç¡®ä»image_idè·å–
        'image_path': doc_metadata.get('image_path', ''),         # æ˜ç¡®ä»image_pathè·å–
        # ... å…¶ä»–å­—æ®µçš„æ˜ç¡®å¯¹åº”
    }
```

#### 6.2 **å‰ç«¯å­—æ®µä½¿ç”¨ï¼ˆæ˜ç¡®å¯¹åº”ï¼‰**
```javascript
// ä¸å†ä½¿ç”¨çŒœæµ‹çš„æ–¹å¼
// é”™è¯¯çš„æ–¹å¼ï¼š
// const caption = Array.isArray(imageResult.caption) ? imageResult.caption[0] : imageResult.caption || 'å›¾ç‰‡æè¿°';

// æ­£ç¡®çš„æ–¹å¼ï¼š
function getImageInfo(imageResult) {
    return {
        title: imageResult.caption?.[0] || 'æ— æ ‡é¢˜',           // æ˜ç¡®ä½¿ç”¨captionå­—æ®µ
        footnote: imageResult.footnote?.join(', ') || '',      // æ˜ç¡®ä½¿ç”¨footnoteå­—æ®µ
        description: imageResult.enhanced_description || '',    // æ˜ç¡®ä½¿ç”¨enhanced_descriptionå­—æ®µ
        path: imageResult.image_path || '',                    // æ˜ç¡®ä½¿ç”¨image_pathå­—æ®µ
        // ... å…¶ä»–å­—æ®µçš„æ˜ç¡®ä½¿ç”¨
    };
}
```

### 7. **æ€»ç»“**

**æ‚¨å®Œå…¨æ­£ç¡®**ï¼š

1. **ä¸åº”è¯¥çŒœæµ‹**ï¼šä¸åº”è¯¥ç”¨`if...`çŒœæµ‹çš„æ–¹å¼å»è·å–å­—æ®µå€¼
2. **æ˜ç¡®å¯¹åº”**ï¼šæ¯ä¸ªåç«¯å­—æ®µéƒ½åº”è¯¥æ˜ç¡®å¯¹åº”åˆ°æ•°æ®åº“çš„ç‰¹å®šå­—æ®µ
3. **ä¸€ä¸€æ˜ å°„**ï¼šå»ºç«‹æ¸…æ™°çš„å­—æ®µæ˜ å°„å…³ç³»è¡¨
4. **ç±»å‹å®‰å…¨**ï¼šç¡®ä¿å­—æ®µç±»å‹çš„ä¸€è‡´æ€§

**ä¿®å¤åŸåˆ™**ï¼š
- åç«¯å­—æ®µåä¸æ•°æ®åº“å­—æ®µåä¿æŒä¸€è‡´
- å»ºç«‹æ˜ç¡®çš„å­—æ®µå¯¹åº”å…³ç³»è¡¨
- ä¸ä½¿ç”¨çŒœæµ‹æˆ–å¤‡é€‰å­—æ®µå
- ç¡®ä¿æ•°æ®æµçš„å¯è¿½æº¯æ€§

è¿™æ ·å¯ä»¥é¿å…å­—æ®µå¯¹åº”é”™è¯¯ï¼Œç¡®ä¿å‰åç«¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚