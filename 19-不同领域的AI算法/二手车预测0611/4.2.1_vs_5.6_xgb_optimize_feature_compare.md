# 4.2.1model_xgb_more_feature_save_train_result_4000(best).py 与 5.6_xgb_optimize_feature.py 详细对比

## 1. 数据读取与基础处理

| 项目 | 4.2.1 | 5.6 |
|---|---|---|
| 训练/测试集拼接 | 直接concat，测试集price=-1 | concat，添加is_test标记 |
| seller/offerType处理 | 保留 | 直接删除 |
| SaleID处理 | 保留 | 仅在输出时用，不参与特征 |

## 2. 特征工程

### 2.1 时间特征衍生
- **相同点**：均衍生regDate/creatDate的年、月、日、季节、车龄、车龄分段、每年公里数等。
- **不同点**：
  - 5.6对部分衍生特征如regSeason/creatSeason等缺失填充更细致。
  - 5.6增加了is_new_car、regYear_from_now等衍生。

### 2.2 分箱/分段
- **相同点**：均对power、kilometer、regYear等分箱。
- **不同点**：
  - 4.2.1的kilometer分箱区间为[0,5,10,12,14,15]（单位万），5.6为[0,50000,100000,120000,140000,150000]（单位为实际公里，已放大）。
  - 5.6所有分箱同步了kilometer放大后的区间。

### 2.3 缺失值处理
- **相同点**：均对主要特征做缺失标记和填充。
- **不同点**：
  - 4.2.1数值型用中位数，类别型用众数。
  - 5.6分类别、数值特征分别采用新类别/分组中位数/全局中位数，所有可能缺失的特征都生成缺失指示符。

### 2.4 异常值处理
- **相同点**：均对price、power、kilometer等做clip和异常标记。
- **不同点**：
  - 4.2.1只对训练集clip，5.6对全数据clip。
  - 5.6异常区间基于分位数和IQR，处理更细致。

### 2.5 统计特征
- **相同点**：均生成品牌均值/中位数/标准差/计数等统计特征。
- **不同点**：
  - 5.6增加了区域-品牌统计、品牌-车龄-公里等。
  - 5.6统计特征缺失时用全局中位数填充。

### 2.6 特征交互
- **相同点**：均有brand_model、brand_bodyType、km_age、power_age等交互特征。
- **不同点**：
  - 5.6有power_bin分桶交互，power相关交互均以分桶后类别为主。
  - 5.6有更多交互特征（如powertrain_type、brand_model_age等），但最终未全部用于训练。

### 2.7 高基数类别特征编码
- **相同点**：均对model、brand_model、brand_power_bin、brand_age_segment等做频数编码。
- **不同点**：
  - 5.6对部分高基数特征（如regionCode）只保留频数编码，不直接用原始特征。

### 2.8 其它类别特征编码
- **相同点**：均用LabelEncoder。
- **不同点**：
  - 4.2.1对regionCode、seller、offerType等也做LabelEncoder，5.6已删除seller/offerType，regionCode只用频数编码。

### 2.9 匿名特征PCA降维
- **相同点**：均对v_0~v_14做PCA，保留10维。

### 2.10 数值归一化
- **相同点**：均用StandardScaler归一化主要数值特征。
- **不同点**：
  - 5.6归一化特征更全面，包含所有衍生、统计、交互特征。

## 3. 特征列表（最终用于训练）

- **4.2.1**：特征较全，包含所有统计、交互、匿名、类别、分箱、缺失/异常标记等。
- **5.6**：在5.4/5.5基础上，**显式排除了如下特征**：
  - regionCode_freq, brand_model_age, brand_model_age_freq, powertrain_type, powertrain_type_freq, v3_car_age_interaction, v12_power_log_interaction, power_10bins, is_high_mileage, region_brand_price_mean, region_brand_price_std, brand_mean_car_age, brand_mean_kilometer, car_age_ratio_to_brand_mean_age, kilometer_ratio_to_brand_mean_km, brand_v3_mean, brand_v3_median, brand_v3_std
- 其它特征如model_freq、brand_model_freq、brand_power_bin_freq、brand、bodyType、fuelType、gearbox、regYear_bin、km_bin、power_bin、age_segment、brand_bodyType、brand_regYear_bin、brand_km_bin、notRepairedDamage、kilometer、car_age、km_per_year、power_log、kilometer_log、car_age_log、km_age、brand_price_mean、brand_price_median、brand_price_std、brand_price_count、brand_price_ratio、v_0、v_3、v_10、v_12、v_pca_0~9、缺失/异常标记、regYear、regMonth、creatYear、creatMonth、regYear_from_now、creatYear_from_now、regSeason、creatSeason等均保留。

## 4. 模型参数与训练流程

| 项目 | 4.2.1 | 5.6 |
|---|---|---|
| XGBoost参数 | max_depth=10, learning_rate=0.03, n_estimators=4000, subsample=0.8, colsample_bytree=0.9, random_state=42, n_jobs=-1 | 同左 |
| eval_metric | rmse | rmse |
| early_stopping | 无 | 无（注释掉） |
| 训练集/验证集划分 | test_size=0.15, random_state=42 | 同左 |
| 目标变量 | np.log1p(y) | 同左 |
| 训练日志 | 打印训练时长、超参数 | 同左 |

## 5. 评估与输出

| 项目 | 4.2.1 | 5.6 |
|---|---|---|
| 验证集评估 | MAE、RMSE | MAE、RMSE |
| 预测结果输出 | xgb_save_train_result.csv | 5.6_xgb_optimize_feature_predict.csv |
| 模型保存 | xgb_model_final_4000.joblib | 5.6_xgb_optimize_feature_model.joblib |
| 预测对比图 | price_pred_vs_true_4000.png | 5.6_xgb_optimize_feature_price_pred_vs_true.png |
| 特征重要性图 | xgb_feature_importance_top20_4000.png | 5.6_xgb_optimize_feature_importance_top50.png |

## 6. 其它实现细节
- 5.6日志输出更丰富，特征工程流程更细致，所有输出文件名统一规范。
- 5.6对特征排除、分箱区间、归一化、缺失/异常处理等细节更符合最新优化要求。

---

## 总结与建议
- **5.6_xgb_optimize_feature.py** 在特征工程细节、特征排除、分箱区间、归一化、日志输出、文件名规范等方面更优，适合最终提交和复现。
- **4.2.1model_xgb_more_feature_save_train_result_4000(best).py** 特征更全，适合特征探索和对比分析。
- 推荐根据业务和模型表现，优先采用5.6的特征工程和输出规范，若需特征扩展可参考4.2.1的特征体系。 