# model_xgb_cv_tune_more.py 说明文档

## 一、程序功能简介

本程序用于二手车价格预测，集成了XGBoost、LightGBM、CatBoost三种主流机器学习模型，通过Stacking融合提升预测精度。程序包含了特征工程优化、参数调优、K折交叉验证评估、SHAP特征重要性分析等完整流程，适合大规模结构化数据的回归建模。

## 二、主要特征工程与建模流程

1. **数据读取与拼接**
   - 读取训练集和测试集，拼接为一个DataFrame，便于统一处理。

2. **时间特征处理**
   - 提取注册年、月、创建年、月、车辆使用年限（car_age）、注册年份分桶（regYear_bin）等。

3. **缺失值与异常值处理**
   - 对部分字段用中位数/众数填充。
   - 对价格、功率、公里数等特征做合理区间筛选，剔除极端异常值。

4. **特征交互与分桶**
   - 对power、kilometer、car_age等重要特征做log变换和交互（如km_age、power_age）。
   - 只保留SHAP分析中重要性较高的特征，减少噪声。

5. **匿名特征降维**
   - 对v_0~v_14匿名特征做PCA降维，保留6个主成分。

6. **特征归一化与编码**
   - 对数值特征做标准化，对类别特征做LabelEncoder编码。

7. **模型融合与训练**
   - 采用XGBoost、LightGBM、CatBoost三模型Stacking融合，提升泛化能力。
   - 采用5折KFold交叉验证评估模型稳定性。

8. **特征重要性分析**
   - 用SHAP分析XGBoost模型的特征重要性，输出前20特征的影响力图。

9. **预测与输出**
   - 用融合模型对测试集做预测，输出预测结果为`used_car_sample_submit_stacking.csv`。
   - 输出SHAP特征重要性图为`shap_feature_importance_stacking.png`。

## 三、输出内容说明

- `used_car_sample_submit_stacking.csv`：测试集预测结果，包含SaleID和预测price。
- `shap_feature_importance_stacking.png`：SHAP特征重要性可视化图片，便于理解模型决策依据。
- 控制台输出：包含Stacking 5折CV MAE、RMSE均值等模型评估指标。

## 四、执行硬件需求与时间估算

### 1. 硬件需求
- **内存**：建议16GB及以上（数据量大，模型融合和GridSearch会占用较多内存）。
- **CPU**：建议4核及以上，支持多线程（n_jobs=-1）。
- **显卡**：本程序为CPU版，无需GPU。
- **存储**：建议剩余空间大于5GB。

### 2. 执行时间估算
- **特征工程与数据处理**：约1-2分钟。
- **Stacking模型训练（5折CV）**：约30-60分钟（取决于CPU性能，模型参数，数据量）。
- **SHAP特征重要性分析**：约5-10分钟。
- **总计**：一般在40分钟~1.5小时内完成（普通16G内存、4核CPU台式机）。

> 若硬件配置较低，建议减少n_estimators、降低K折数、减少特征数量以加快速度。

## 五、使用建议

- 建议在空闲时段运行，避免与其他大型程序并行。
- 若只需快速测试，可将KFold折数调为3，n_estimators调低。
- 可根据SHAP图进一步筛选特征，或尝试AutoML等自动特征生成工具。
- 若需进一步提升精度，可考虑外部数据增强、深度学习模型等。

---

如有更多定制化需求或遇到性能瓶颈，欢迎随时咨询！ 