# 4.1.0_stock_predict_lstm.py 程序说明文档

## 一、功能简介

本程序为股票历史数据智能预测系统，基于LSTM神经网络模型，支持用户自定义股票、窗口长度和预测天数，自动从Oracle数据库读取数据，完成特征工程并预测未来n天的收盘价。适用于A股等市场的单只股票短中期走势预测。

---

## 二、主要特性
- 支持输入股票名称、窗口长度（天数）、预测天数，灵活配置。
- 自动从Oracle数据库读取指定股票的历史行情数据。
- 特征工程丰富，涵盖原始特征、衍生特征、周期性时间特征、法定节假日特征。
- 采用LSTM深度学习模型，自动完成训练与未来多天递归预测。
- **集成模型保存与加载功能，自动检测参数一致时直接加载模型和归一化器，无需重复训练，极大提升预测效率。**
- 可视化输出预测趋势图，终端输出预测表格。
- 支持调试/正式模式切换，便于快速调试和全量预测。
- 代码注释详细，中文输出，UTF-8编码，兼容中文环境。

---

## 三、输入输出说明

### 输入
- 股票名称（如：贵州茅台、五粮液等，或直接输入股票代码）
- 窗口长度（如：20，表示用前20天数据预测）
- 预测天数（如：5，表示预测未来5天）

### 输出
- 未来n天的收盘价预测表格（终端markdown格式）
- 预测趋势图（含历史、真实、预测收盘价，保存在4.1.0_lstm_pred_image_show目录）
- 主要特征工程说明

---

## 四、特征工程说明

### 1. 原始特征
- open：开盘价
- high：最高价
- low：最低价
- close：收盘价
- pre_close：昨收价
- change：涨跌额
- pct_chg：涨跌幅（%）
- vol：成交量（手）
- amount：成交额（千元）

### 2. 衍生特征
- ma5、ma10：5日/10日收盘价均线
- pct_chg_mean5、pct_chg_std5：5日涨跌幅均值/标准差
- vol_chg：成交量变化率
- close_ma5_diff、close_ma10_diff：收盘价与均线偏离度

### 3. 周期性时间特征
- weekday：星期几（0=周一，6=周日）
- month_period：每月上中下旬（0=1-10号，1=11-20号，2=21号及以后）
- is_month_end：是否月末
- is_next_workday：是否为假日后第一个工作日

### 4. 节假日特征
- is_holiday：是否为中国法定节假日（含调休，需chinese_calendar库）
- is_workday：是否为中国法定工作日（含调休，需chinese_calendar库）

---

## 五、模型保存与加载功能说明

- 程序会根据股票名称、窗口长度、特征工程参数自动生成模型和归一化器（scaler）的唯一文件名。
- **首次训练后，模型（.h5）、归一化器（.pkl）和参数元信息（.json）会自动保存到`4.1.0_lstm_model`目录。**
- 下次运行时，程序会自动检测模型和scaler文件是否存在，且参数（股票、窗口长度、特征工程）一致时，直接加载模型和scaler，无需重新训练，极大提升预测效率。
- 若参数变动（如窗口长度、特征工程、股票名称等），则自动重新训练并覆盖保存。
- 所有提示信息均为中文，路径安全规范。
- 这样可以实现"训练一次，多次快速预测"，适合生产环境和Web服务部署。

---

## 六、使用方法

1. 安装依赖库（如未安装）：
   ```bash
   pip install pandas numpy matplotlib sqlalchemy scikit-learn keras cx_Oracle chinese_calendar joblib
   ```
2. 配置Oracle数据库连接参数（如有变动请在代码头部修改）。
3. 运行程序：
   ```bash
   python 4.1.0_stock_predict_lstm.py
   ```
4. 按提示输入股票名称、窗口长度、预测天数。
5. 查看终端输出的预测表格和主要特征说明，预测趋势图保存在4.1.0_lstm_pred_image_show目录。
6. **如已训练过同参数模型，程序会自动加载，无需等待训练过程，直接预测。**
7. 如需全量正式预测，将DEBUG参数设为False。

---

## 七、注意事项
- 程序默认调试模式（DEBUG=True）仅取近120天数据，训练轮数较少，便于快速测试。正式预测请将DEBUG=False。
- 需保证Oracle数据库可访问，且表结构与3.1.8版一致。
- 法定节假日特征依赖chinese_calendar库，需提前安装。
- 预测未来多天采用递归方式，误差会逐步放大，建议以短期预测为主。
- 特征工程可根据实际需求进一步扩展。
- **如模型参数（如窗口长度、特征工程、股票名称等）发生变化，程序会自动重新训练并覆盖保存。**
- **模型和归一化器文件保存在`4.1.0_lstm_model`目录下，便于管理和迁移。**

---

## 八、与前版本的区别
- 增加了对中国法定节假日、调休补班日的精细特征支持（需chinese_calendar库）。
- 特征工程更丰富，周期性时间特征与衍生特征全面融合。
- 预测流程和可视化输出更贴近3.1.8版风格，便于业务对比和分析。
- 支持自定义窗口长度和预测天数，灵活性更高。
- **新增模型保存与加载机制，极大提升预测效率和易用性。**

---

## 九、示例

```bash
请输入股票名称（如：贵州茅台）：
贵州茅台
请输入窗口长度（如：20）：
20
请输入预测天数（如：5）：
5
```

终端输出：
```
未来5天预测结果：
| 预测日期   | 预测收盘价 |
|------------|------------|
| 2024-07-01 | 1800.23    |
| 2024-07-02 | 1812.45    |
| ...        | ...        |
```

预测趋势图保存在4.1.0_lstm_pred_image_show目录。

如已存在同参数模型，程序会自动加载并直接预测，无需等待训练过程。 