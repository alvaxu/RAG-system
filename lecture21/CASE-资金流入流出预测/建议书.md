
## 分析与预测方案建议书

### 引言

本方案旨在针对资金流入流出预测竞赛项目，提供一套全面的数据分析、建模及预测策略。通过深入理解竞赛数据特性，结合多种时间序列预测模型，旨在实现对未来申购和赎回金额的准确预测。

### 1. 数据文件分析

竞赛提供了四类主要数据表：用户信息表、用户申购赎回数据表、收益率表和上海银行间同业拆放利率表。

#### 1.1 用户基本信息表 (`user_profile_table`)

*   **字段**: `user_id`, `Sex`, `City`, `constellation`。
*   **内容**: 约2.8万用户的基本静态信息。部分用户在2014年9月首次出现，只在测试数据中。
*   **分析意义**: 这些信息本身可能是影响用户申购赎回行为的重要特征。例如，不同性别、城市或星座的用户群体，其资金管理习惯可能存在差异。在进行聚合预测时，可以直接作为外部变量（或用于更细粒度的分群预测）。

#### 1.2 用户申购赎回数据表 (`user_balance_table`) - **核心预测目标**

*   **字段**: `user_id`, `report_date`, `tBalance`, `yBalance`, `total_purchase_amt`, `direct_purchase_amt`, `purchase_bal_amt`, `purchase_bank_amt`, `total_redeem_amt`, `consume_amt`, `transfer_amt`, `tftobal_amt`, `tftocard_amt`, `share_amt`, `category1`~`category4`。
*   **内容**: 2013年7月1日至2014年8月31日的每日申购和赎回记录。金额单位为“分”。
*   **核心目标**: `total_purchase_amt` (申购总量) 和 `total_redeem_amt` (赎回总量)。
*   **分析意义**: 这是我们主要进行时间序列预测的数据源。其中包含了丰富的日级别操作数据，为预测提供了历史依据。需要特别关注 `report_date` 的时间连续性、金额单位转换（若需）以及 `total_purchase_amt` 和 `total_redeem_amt` 的波动规律。`share_amt`（今日收益）以及各类消费/转出/转入子类目也可能作为有用的外部特征。

#### 1.3 收益率表 (`mfd_day_share_interest`)

*   **字段**: `mfd_date`, `mfd_daily_yield` (万份收益), `mfd_7_daily_yield` (七日年化收益率)。
*   **内容**: 余额宝在14个月内的每日收益率。
*   **分析意义**: 收益率是影响用户申购赎回决策的关键外部因素。通常，收益率上升会吸引更多申购，收益率下降可能导致赎回增加。这些指标可作为 SARIMAX 或机器学习模型的外部回归变量。

#### 1.4 上海银行间同业拆放利率（Shibor）表 (`mfd_bank_shibor`)

*   **字段**: `mfd_date`, `Interest_0_N` (隔夜利率), `Interest_1_W` (1周利率), ..., `Interest_1_Y` (1年利率)。
*   **内容**: 14个月期间银行间的拆借利率（年利率）。
*   **分析意义**: Shibor反映了市场流动性状况。当银行间利率较高时，余额宝的收益率可能相对更具吸引力，从而影响用户行为。这些利率也可以作为外部特征引入模型。

#### 1.5 选手提交结果表 (`tc_comp_predict_table`)

*   **字段**: `report_date`, `purchase`, `redeem`。
*   **内容**: 2014年9月每日申购和赎回总额的预测值，共30行。金额单位为“分”。
*   **分析意义**: 明确了预测的格式和单位，需确保模型输出符合此要求。

### 2. 数据探索性分析 (EDA)

EDA 是理解数据、发现模式、识别异常和指导特征工程的关键步骤。

#### 2.1 数据概览与质量

*   **数据量**: `user_balance_table` 涵盖一年多的日数据，数据量较大。
*   **数据类型与单位**: 确认 `report_date` 需转为日期类型，金额单位为“分”，预测结果也需保持“分”的单位。
*   **缺失值**: 检查 `total_purchase_amt` 和 `total_redeem_amt` 是否存在缺失值。若存在，需进行插值或删除处理。对于 `mfd_day_share_interest` 和 `mfd_bank_shibor`，也要检查缺失值并进行合适的填充（如前值填充或线性插值）。
*   **异常值**: 观察金额数据是否存在异常大的峰值或谷值，特别是在节假日或重大事件期间。

#### 2.2 时间序列趋势与季节性分析

*   **整体趋势**: 绘制 `total_purchase_amt` 和 `total_redeem_amt` 随时间变化的折线图（已在 `plot_trend.py` 中实现）。观察是否存在长期增长/下降趋势。
*   **周期性（季节性）**:
    *   **周效应**: 根据“转入时间-首次显示收益时间”表格，强烈暗示数据存在**周度季节性**（周期为7天）。通过绘制按星期几聚合的平均申购赎回量，可以直观确认这种模式。
    *   **月/季度效应**: 观察是否存在每月或每季度的重复模式。
    *   **节假日效应**: 绘制节假日期间申购赎回量的变化，与非节假日进行对比，分析节假日（包括周末）对资金流向的影响。通常节假日会伴随资金的大规模调动。
*   **平稳性检验**:
    *   使用 ADF (Augmented Dickey-Fuller) 检验（已在 `plot_trend.py` 和 `arima_auto_param.py` 中实现）判断申购和赎回序列的平稳性。
    *   **结果分析**:
        *   申购金额序列通常是平稳或弱平稳的。
        *   赎回金额序列可能存在非平稳性，需要进行差分处理 (d>0)。
    *   根据检验结果确定 ARIMA/SARIMAX 中的 `d` 和 `D` 参数。

#### 2.3 节假日与星期对申购赎回的影响

*   **星期几效应**: 将 `report_date` 转换为星期几特征，并观察不同星期几的申购赎回量均值和标准差。例如，周末和周一可能存在显著差异。
*   **节假日效应**: 创建 `is_holiday` (是否节假日) 二元特征。可以进一步细化为：
    *   `is_before_holiday` (节前)
    *   `is_during_holiday` (节中)
    *   `is_after_holiday` (节后)
    *   不同节假日类型 (例如春节、国庆节的影响可能不同)。
*   **收益显示时间**: `竞赛说明.md` 第5节的“转入时间|首次显示收益时间”表格揭示了资金到账的滞后性。这可能意味着当前周期的申购赎回，会受到前几个交易日收益率的影响。在构建特征时，可以考虑滞后收益率特征。

#### 2.4 外部经济指标与申购赎回的关联

*   **收益率 (`mfd_day_share_interest`)**:
    *   绘制 `mfd_daily_yield` 和 `mfd_7_daily_yield` 随时间变化的图，观察其趋势。
    *   计算这些收益率与 `total_purchase_amt` 和 `total_redeem_amt` 的相关性。
    *   考虑收益率的滞后影响。例如，当日申购可能受前一日收益率影响。
*   **Shibor 利率 (`mfd_bank_shibor`)**:
    *   可视化不同期限 Shibor 利率的走势。
    *   分析 Shibor 利率与申购赎回量的相关性。Shibor 升高通常意味着市场资金紧张，可能影响余额宝的吸引力。
    *   同样考虑滞后效应。

### 3. 预测模型选择与方案建议

结合数据特点和竞赛要求，推荐以下模型方案：

#### 3.1 SARIMAX 模型 (在 `2.holiday_SARIMAX_forecast_201409.py` 和 `3.auto_sarimax_forecast_201409.py` 基础上优化)

**优势**:
*   能够同时处理时间序列的趋势、非季节性自相关、季节性自相关，并有效整合外部变量。
*   对具有明显周期性（如周效应）的数据表现良好。

**优化方向**:
*   **参数自动选择（`pmdarima.auto_arima`）**:
    *   **强制使用**: `pmdarima.auto_arima` 能够根据 AIC/BIC 等信息准则自动搜索最优的 `(p,d,q)(P,D,Q,s)` 参数组合。
    *   **加入外部变量 (`exogenous`)**: 在 `auto_arima` 中传入 `exog` 参数，包含星期几的独热编码和 `is_holiday` 特征。
    *   **季节周期 `m`**: 根据周效应，`m=7` 是合适的选择。
    *   **搜索范围**: 可以通过 `max_p`, `max_q`, `max_P`, `max_Q` 等参数适当调整搜索范围，以平衡计算时间和模型复杂度。
*   **外部变量的引入**:
    *   **星期几**: 独热编码 (已实现)。
    *   **节假日**: `is_holiday` 二元变量 (已实现)。
    *   **收益率**: 考虑将 `mfd_daily_yield` 和 `mfd_7_daily_yield` 作为外部变量引入。
    *   **Shibor 利率**: 考虑将部分关键期限的 Shibor 利率（如 `Interest_0_N`, `Interest_1_W`, `Interest_1_M` 等）作为外部变量引入。
    *   **滞后特征**: 对于收益率和Shibor，尝试引入其滞后值（例如，当前申购赎回量可能受前1-3天的收益率影响）。
*   **模型诊断与残差分析**:
    *   训练模型后，检查模型的残差序列（`results.resid`）。
    *   **Ljung-Box 检验**：检查残差是否为白噪声，若p-value > 0.05，则残差无自相关，模型拟合良好。
    *   **ACF/PACF 图**：绘制残差的 ACF 和 PACF 图，观察是否还有未捕捉到的信息（如残差仍有显著的自相关）。如果有，则需要进一步调整模型参数或引入其他特征。
*   **预测区间可视化**: 在预测图上不仅显示点预测，还要显示预测的置信区间，以评估预测的不确定性。

#### 3.2 机器学习模型 (如 LightGBM / XGBoost)

**优势**:
*   能够处理复杂非线性关系和大量的异构特征。
*   对特征缺失和异常值具有一定的鲁棒性。
*   适合集成多种特征进行预测。

**特征工程建议**:
*   **时间特征**: `year`, `month`, `day`, `dayofweek`, `dayofyear`, `weekofyear`, `quarter`。
*   **滞后特征**:
    *   `total_purchase_amt` 的滞后值 (例如前1天、前7天、前14天)。
    *   `total_redeem_amt` 的滞后值。
    *   外部变量（收益率、Shibor、独热编码的星期几、节假日）的滞后值。
*   **滚动统计特征**:
    *   过去3天、7天、14天的申购/赎回均值、中位数、标准差。
    *   过去3天、7天、14天的收益率、Shibor利率均值等。
*   **节假日特征增强**:
    *   `days_since_last_holiday` (距上次节假日天数)
    *   `days_until_next_holiday` (距下次节假日天数)
    *   不同节假日类型的独热编码。
*   **交互特征**: 例如，星期几与节假日是否叠加。

**建模策略**:
*   **独立建模**: 分别为 `total_purchase_amt` 和 `total_redeem_amt` 训练独立的 LightGBM 或 XGBoost 模型。
*   **时间序列交叉验证**: 采用滚动预测或时间序列 K-折交叉验证 (如 `TimeSeriesSplit`)，避免数据泄露。
*   **超参数调优**: 使用网格搜索或随机搜索对模型超参数进行优化。

#### 3.3 深度学习模型 (如 LSTM, 可选)

**优势**:
*   擅长捕捉时间序列中的长期依赖关系。
*   对序列数据有强大的建模能力。

**适用场景**:
*   当数据量非常大，且时间序列模式复杂、非线性关系显著时，可以考虑 LSTM。
*   **劣势**: 相对复杂，需要更多数据和计算资源，训练时间可能较长，可解释性差。
*   **特征**: 类似机器学习模型中的特征，但需要将它们组织成序列输入。

#### 3.4 模型融合 (Ensemble, 高级)

**优势**:
*   结合不同模型的优点，提高预测的稳定性和鲁棒性。
*   通常能获得比单一模型更好的效果。

**常见方法**:
*   **加权平均**: 对不同模型的预测结果进行加权平均，权重可以通过交叉验证优化。
*   **Stacking/Blending**: 使用一个元模型来学习如何组合基础模型的预测结果。
*   可以尝试融合 SARIMAX 的时序捕捉能力和 LightGBM 的特征处理能力。

### 4. 评估策略

竞赛采用累积相对误差作为评估指标，并对申购和赎回预测得分进行加权（申购45% + 赎回55%）。

*   **内部评估**: 在开发过程中，应模拟竞赛的评估方式，使用历史数据进行回测（特别是滑动窗口预测），计算相对误差，并按照竞赛规则计算得分。
*   **可视化**: 持续可视化模型的预测结果与真实值的对比，尤其关注模型在节假日和波动较大区域的表现。

### 5. 总结与路线图

这是一个多阶段的预测方案，建议按照以下路线图逐步实施：

1.  **数据清洗与特征工程**: 确保所有数据加载正确，并生成包含星期几、节假日、收益率、Shibor 等在内的所有潜在特征。
2.  **SARIMAX 模型强化**:
    *   使用 `3.auto_sarimax_forecast_201409.py` 自动寻找最优SARIMAX参数。
    *   在 SARIMAX 模型中逐步引入更多的外部变量（收益率、Shibor 滞后特征等）。
    *   进行残差分析，确保模型充分拟合数据。
3.  **机器学习模型探索 (LightGBM/XGBoost)**:
    *   独立训练申购和赎回的预测模型。
    *   重点进行滞后特征和滚动统计特征的工程。
    *   使用时间序列交叉验证评估模型性能。
4.  **模型融合 (可选，但推荐)**:
    *   尝试结合 SARIMAX 和机器学习模型的优点。
5.  **最终预测与提交**:
    *   使用表现最好的模型或融合模型，对 2014年9月 的数据进行预测。
    *   确保输出格式严格符合竞赛要求。

通过上述详尽的分析和多模型策略，我们有信心能够显著提升预测的准确性。

