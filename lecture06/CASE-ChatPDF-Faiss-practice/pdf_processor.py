"""
PDF处理模块
"""
from PyPDF2 import PdfReader
from typing import List, Dict, Tuple
import re
from config import CHUNK_SIZE, CHUNK_OVERLAP

class PDFProcessor:
    """
    功能：处理PDF文档，提取文本和元数据
    参数：
        pdf_path: PDF文件路径
    返回：
        chunks: 文本块列表
        metadata: 元数据列表
    """
    def __init__(self):
        self.chunk_size = CHUNK_SIZE
        self.chunk_overlap = CHUNK_OVERLAP

    def process_pdf(self, pdf_path: str) -> Tuple[List[str], List[Dict]]:
        """
        处理PDF文件，返回文本块和元数据
        """
        # 读取PDF
        reader = PdfReader(pdf_path)
        chunks = []
        metadata = []
        
        # 逐页处理
        for page_num, page in enumerate(reader.pages, 1):
            page_text = page.extract_text()
            if page_text:
                # 对每页文本进行分块
                page_chunks = self._split_text(page_text)
                # 为每个文本块创建对应的元数据
                for chunk in page_chunks:
                    chunks.append(chunk)
                    metadata.append({
                        "page": page_num,
                        "source": pdf_path
                    })
        for i in range(len(chunks)):
            print(f"第{i}个chunk,内容为\n{chunks[i] }")
        print(f"metadata={metadata}")
        return chunks, metadata

    def _split_text(self, text: str) -> List[str]:
        """
        将文本分割成块
        """
        # 按段落分割
        paragraphs = re.split(r'\n\s*\n', text)
        chunks = []
        current_chunk = ""
        
        for para in paragraphs:
            if len(current_chunk) + len(para) <= self.chunk_size:
                current_chunk += para + "\n"
            else:
                if current_chunk:
                    chunks.append(current_chunk.strip())
                current_chunk = para + "\n"
        
        if current_chunk:
            chunks.append(current_chunk.strip())
        
        return chunks

# """
#  第0个chunk,内容为
# 百度文库  - 好好学习，天天向上  
# -1 上海浦东发展银行西安分行  
# 个金客户经理管理考核暂行办法  
# 第一章  总   则 
# 第一条   为保证我分行个金客户经理制的顺利实施，有效调动个
# 金客户经理的积极性，促进个金业务快速、稳定地发展，根据总行《上
# 海浦东发展银行个人金融营销体系建设方案（试行）》要求，特制定
# 《上海浦东发展银行西安分行个金客户经理管理考核暂行办法（试
# 行）》（以下简称本办法）。  
# 第二条   个金客户经理系指各支行（营业部）从事个人金融产品
# 营销与市场开拓，为我行个人客户提供综合银行服务的我行市场人
# 员。 
# 第三条   考核内容分为二大类， 即个人业绩考核、 工作质量考核。
# 个人业绩包括个人资产业务、负债业务、卡业务。工作质量指个人业
# 务的资产质量。  
# 第四条   为规范激励规则，客户经理的技术职务和薪资实行每年
# 考核浮动。客户经理的奖金实行每季度考核浮动，即客户经理按其考
# 核内容得分与行员等级结合，享受对应的行员等级待遇。
# 第1个chunk,内容为
# 百度文库  - 好好学习，天天向上  
# -2 第二章  职位设置与职责  
# 第五条   个金客户经理职位设置为：客户经理助理、客户经理、
# 高级客户经理、资深客户经理。  
# 第六条   个金客户经理的基本职责：  
# （一）   客户开发。研究客户信息、联系与选择客户、与客户建
# 立相互依存、相互支持的业务往来关系，扩大业务资源，创造良好业
# 绩； 
# （二）业务创新与产品营销。把握市场竞争变化方向，开展市场
# 与客户需 求的调研，对业务产品及服务进行创新；设计客户需求的产
# 品组合、制订和实施市场营销方案；  
# （三）客户服务。负责我行各类表内外授信业务及中间业务的受
# 理和运作，进行综合性、整体性的客户服务；  
# （四）防范风险，提高收益。提升风险防范意识及能力，提高经
# 营产品质量；  
# （五）培养人材。在提高自身综合素质的同时，发扬团队精神，
# 培养后备业务骨干。
# 第2个chunk,内容为
# 百度文库  - 好好学习，天天向上  
# -3 第三章  基础素质要求  
# 第七条   个金客户经理准入条件：  
# （一）工作经历：须具备大专以上学历，至少二年以上银行工作
# 经验。  
# （二）工作能力：熟悉我行的各项业务，了解市场情况，熟悉各
# 类客户的金融需求，熟悉个人理财工具，有一定的业务管理和客户管
# 理能力。  
# （三）工作业绩：个金客户经理均应达到相应等级的准入标准。
# 该标准可根据全行整体情况由考核部门进行调整。  
# （四）专业培训：个金客户经理应参加有关部门组织的专业培训
# 并通过业务考试。  
# （五）符合分行人事管理和专业管理的要求。  
# 第四章  个人业绩考核标准  
# 第八条   个金客户经理个人业绩以储蓄季日均、季有效净增发卡
# 量、季净增个贷余额 三项业务为主要考核指标，实行季度考核。具体
# 标准如下：  
# 类别 行员级别 考核分值 准入标准  
# 储蓄业务 个贷业务 卡业务 
# 客户经理助理  5 90 300万  500张 
# 4 95
# 第3个chunk,内容为
# 百度文库  - 好好学习，天天向上  
# -4 3 100  
# 2 105  
# 1 110  
# 客户经理 5 115 300万  500张 
# 4 120  
# 3 125  
# 2 130  
# 1 135  
# 高级客户经理  5 140 500万 800万  
# 4 145  
# 3 150  
# 2 155  
# 1 160  
# 资深客户经理  5 165 500万 800万  
# 4 170  
# 3 175  
# 2 180  
# 1 185  
# 说明： 1.储蓄业务（季日均余额）为各类个金客户经理考核进入的最低标准。   
# 2.卡业务（季新增发有效卡量）为见习、 D类、初级客户经理进入的最低标准。  
# 3.有效卡的概念：每张卡月均余额为 100元以上。  
# 4.个贷业务（季新增发放个贷）为中级以上客户经理考核进入的最低标准。  
# 5.超出最低考核标准可相互折算，折算标准： 50万储蓄 =50万个贷 =50张有效卡 =5分（折算以 5分为单位）
# 第4个chunk,内容为
# 百度文库  - 好好学习，天天向上  
# -5 第五章  工作质量考核标准  
# 第九条   工作质量考核实行扣分制。工作质量指个金客户经理在
# 从事所有个人业务时出现投诉、差错及风险。该项考核最多扣 50分，
# 如发生重大差错事故，按分行有关制度处理。  
# （一）服务质量考核：   
# 1、工作责任心不强，缺乏配合协作精神；扣 5分 
# 2、客户服务效率低，态度生硬或不及时为客户提供维护服务，
# 有客户投诉的 ,每投诉一次扣 2分 
# 3、不服从支行工作安排，不认真参加分（支）行宣传活动的，
# 每次扣 2分； 
# 4、未能及时参加分行（支行）组织的各种业务培训、考试和专
# 题活动的每次扣 2分； 
# 5、未按规定要求进行贷前调查、贷后检查工作的，每笔扣 5分； 
# 6、未建立信贷台帐资料及档案的每笔扣 5分； 
# 7、在工作中有不廉洁自律情况的每发现一次扣 50分。 
# （二）个人资产质量考核：  
# 当季考核收息率 97%以上为合格，每降 1个百分点扣 2分；不
# 良资产零为合格，每超一个个百分点扣 1分。 
# A.发生跨月逾期，单笔不超过 10万元，当季收回者，扣 1分。 
# B.发生跨月逾期， 2笔以上累计金额不超过 20万元，当季收回
# 者，扣 2分；累计超过 20万元以上的，扣 4分。
# 第5个chunk,内容为
# 百度文库  - 好好学习，天天向上  
# -6 C.发生逾期超过 3个月，无论金额大小和笔数，扣 10分。 
# 第六章  聘任考核程序  
# 第十条   凡达到本办法第三章规定的该技术职务所要求的行内职
# 工，都可向分行人力资源部申报个金客户经理评聘。  
# 第十一条   每年一月份为客户经理评聘的申报时间，由分行人力
# 资源部、个人业务部每年二月份组织统一的资格考试。考试合格者由
# 分行颁发个金客户经理资格证书，其有效期为一年。  
# 第十二条   客户经理聘任实行开放式、浮动制，即：本人申报  —
# — 所在部门推荐  —— 分行考核  —— 行长聘任  —— 每年考评
# 调整浮动。   
# 第十三条   特别聘任：  
# （一）经分行同意录用从其他单位调入的个金客户经理，由用人
# 单位按 D类人员进行考核， 薪资待遇按其业绩享受行内正式行员工同
# 等待遇。待正式转正后按第十一条规定申报技术职务。  
# （二）对为我行业务创新、工作业绩等方面做出重大贡献的市场
# 人员经支行推荐、分行行长 批准可越级聘任。  
# 第十四条   对于创利业绩较高，而暂未入围技术职务系列，或所
# 评聘技术职务较低的市场人员，各级领导要加大培养力度，使其尽快
# 第6个chunk,内容为
# 百度文库  - 好好学习，天天向上  
# -7 入围，并由所在行制定临时奖励办法。  
# 第七章   考核待遇  
# 第十五条   个人金融业务客户经理的收入基本由三部分组成： 客
# 户经理等级基本收入、业绩奖励收入和日常工作绩效收入。  
# 客户经理等级基本收入是指客户经理的每月基本收入， 基本分为
# 助理客户经理、客户经理、高级客户经理和资深客户经理四大层面，
# 在每一层面分为若干等级。  
# 客户经理的等级标准由客户经理在上年的业绩为核定标准， 如果
# 客户经理在我行第一次进行客户经理评级， 以客户经理自我评价为主
# 要依据，结合客户经理以往工作经验，由个人金融部、人事部门共同
# 最终决定客户经理的等级。  
# 助理客户经理待遇按照人事部门对主办科员以下人员的待遇标
# 准；客户经理待遇按照人事部门对主办科员的待遇标准；高级客户经
# 理待遇按照人事部门对付科级的待遇标准； 资深客户经理待遇 按照人
# 事部门对正科级的待遇标准。  
# 业绩奖励收入是指客户经理每个业绩考核期间的实际业绩所给
# 与兑现的奖金部分。  
# 日常工作绩效收入是按照个金客户经理所从事的事务性工作进
# 行定量化考核，经过工作的完成情况进行奖金分配。该项奖金主要由
# 个人金融部总经理和各支行的行长其从事个人金融业务的人员进行
# 分配，主要侧重分配于从事个金业务的基础工作和创新工作。
# 第7个chunk,内容为
# 百度文库  - 好好学习，天天向上  
# -8 第十五条   各项考核分值总计达到某一档行员级别考核分值标
# 准，个金客户经理即可在下一季度享受该级行员的薪资标准。下一季
# 度考核时，按照已享受行员级别考核折算比值进行考核，以次类推。  
# 第十六条   对已聘为各级客户经理的人员，当工作业绩考核达不
# 到相应技术职务要求下限时，下一年技术职务相应下调 。 
# 第十七条   为保护个人业务客户经理创业的积极性，暂定其收入
# 构成中基础薪点不低于 40%。 
# 第八章  管理与奖惩  
# 第十八条   个金客户经理管理机构为分行客户经理管理委员会。
# 管理委员会组成人员：行长或主管业务副行长，个人业务部、人力资
# 源部、风险管理部负责人。  
# 第十九条   客户经理申报的各种信息必须真实。分行个人业务部
# 需对其工作业绩数据进行核实，并对其真实性负责；分行人事部门需
# 对其学历、工作阅历等基本信息进行核实，并对其真实性负责。  
# 第二十条   对因工作不负责任使资产质量产生严重风险或造成损
# 失的给予降级直至开 除处分，构成渎职罪的提请司法部门追究刑事责
# 任。
# 第8个chunk,内容为
# 百度文库  - 好好学习，天天向上  
# -9 第九章  附    则 
# 第二十一条   本办法自发布之日起执行。  
# 第二十二条   本办法由上海浦东发展银行西安分行行负责解释和
# 修改。
# metadata=[{'page': 1, 'source': '浦发上海浦东发展银行西安分行个金客户经理考核办法.pdf'}, {'page': 2, 'source': '浦发上海浦东发展银行西安分行个金客户经理考核办法.pdf'}, {'page': 3, 'source': '浦发上海浦东发展银行西安分行个金客户经理考核办法.pdf'}, {'page': 4, 'source': '浦发上海浦东发展银行西安分行个金客户经理考核办法.pdf'}, {'page': 5, 'source': '浦发上海浦东发展银行西安分行个金客户经理考核办法.pdf'}, {'page': 6, 'source': '浦发上海浦东发展银行西安分行个金客户经理考核办法.pdf'}, {'page': 7, 'source': '浦发上海浦东发展银行西安分行个金客户经理考核办法.pdf'}, {'page': 8, 'source': '浦发上海浦东发展银行西安分行个金客户经理考核办法.pdf'}, {'page': 9, 'source': '浦发上海浦东发展银行西安分行个金客户经理考核办法.pdf'}]
# """
