<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG智能文档问答系统</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #0d1117;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            background: #0d1117;
        }

        .sidebar {
            width: 280px;
            background: #161b22;
            border-right: 1px solid #30363d;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            gap: 12px;
            background: #21262d;
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #f0f6fc;
            margin: 0;
        }

        .sidebar-header .robot-icon {
            font-size: 24px;
        }

        .sidebar-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .session-info {
            background: #21262d;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #30363d;
            margin-bottom: 20px;
        }

        .session-info h4 {
            color: #f0f6fc;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .session-id {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            background: #0d1117;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            word-break: break-all;
            color: #7d8590;
            border: 1px solid #30363d;
        }

        .preset-questions {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .preset-questions h3 {
            color: #f0f6fc;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 500;
        }

        .preset-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .preset-item {
            background: #21262d;
            padding: 12px 16px;
            border-radius: 6px;
            border: 1px solid #30363d;
            color: #e6edf3;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .preset-item:hover {
            background: #30363d;
            border-color: #58a6ff;
        }

        .memory-panel {
            margin-top: auto;
        }

        .memory-panel h3 {
            color: #f0f6fc;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 500;
        }

        .memory-stats {
            background: #21262d;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #30363d;
            margin-bottom: 12px;
        }

        .memory-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .memory-stat-item:last-child {
            margin-bottom: 0;
        }

        .memory-stat-item span:first-child {
            color: #7d8590;
        }

        .memory-stat-item span:last-child {
            color: #e6edf3;
            font-weight: 500;
        }

        .memory-actions {
            display: flex;
            gap: 8px;
        }

        .memory-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: #21262d;
            color: #e6edf3;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .memory-btn:hover {
            background: #30363d;
        }

        .memory-btn.danger {
            border-color: #da3633;
            color: #da3633;
        }

        .memory-btn.danger:hover {
            background: #da3633;
            color: #f0f6fc;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0d1117;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            max-width: 80%;
            padding: 16px 20px;
            border-radius: 12px;
            position: relative;
        }

        .message.user {
            align-self: flex-end;
            background: #58a6ff;
            color: #f0f6fc;
            margin-left: 20%;
        }

        .message.assistant {
            align-self: flex-start;
            background: #21262d;
            color: #e6edf3;
            margin-right: 20%;
            border: 1px solid #30363d;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            opacity: 0.8;
        }

        .message-content {
            line-height: 1.6;
        }

        .message-content p {
            margin-bottom: 12px;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul, .message-content ol {
            margin-bottom: 12px;
            padding-left: 20px;
        }

        .message-content li {
            margin-bottom: 4px;
        }

        .message-content code {
            background: #0d1117;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message-content pre {
            background: #0d1117;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 12px;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .message-content blockquote {
            border-left: 4px solid #58a6ff;
            padding-left: 16px;
            margin: 12px 0;
            color: #7d8590;
        }

        .message-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            margin: 10px 0;
        }
        
        .message-content h1, .message-content h2, .message-content h3, .message-content h4 {
            color: #f0f6fc;
            margin: 16px 0 8px 0;
        }
        
        .message-content h4 {
            color: #58a6ff;
            font-size: 16px;
            font-weight: 600;
        }
        
        .message-content strong {
            color: #f0f6fc;
            font-weight: 600;
        }
        
        .message-content ul {
            margin: 12px 0;
        }
        
        .message-content li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .message-content .image-container {
            margin: 12px 0;
            text-align: center;
        }

        .message-content .image-container img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            border: 1px solid #30363d;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .message-content .image-caption {
            margin-top: 8px;
            font-size: 12px;
            color: #7d8590;
            text-align: center;
        }

        .cost-info {
            margin-top: 12px;
            padding: 12px;
            background: #0d1117;
            border-radius: 6px;
            border: 1px solid #30363d;
        }

        .cost-info-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .cost-info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .cost-info-item strong {
            font-size: 11px;
            color: #7d8590;
            font-weight: 500;
        }

        .cost-info-item span {
            color: #e6edf3;
            font-size: 12px;
        }
        
        .sources-detail {
            margin-top: 10px;
            padding: 8px;
            background: #161b22;
            border-radius: 6px;
            border-left: 3px solid #58a6ff;
            font-size: 11px;
            line-height: 1.4;
            color: #e6edf3;
        }

        .memory-indicator {
            display: inline-block;
            background: #238636;
            color: #f0f6fc;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 8px;
            font-weight: 500;
        }

        .input-area {
            padding: 20px;
            border-top: 1px solid #30363d;
            background: #0d1117;
        }

        .input-group {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .question-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #30363d;
            border-radius: 8px;
            background: #21262d;
            color: #e6edf3;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .question-input:focus {
            border-color: #58a6ff;
        }

        .question-input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .send-btn {
            padding: 12px 24px;
            background: #238636;
            color: #f0f6fc;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .send-btn:hover:not(:disabled) {
            background: #2ea043;
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            color: #7d8590;
            font-style: italic;
        }

        .error {
            color: #da3633;
        }

        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0d1117;
        }

        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }

        /* 侧边栏滚动条 */
        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: #161b22;
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 3px;
        }

        .preset-list::-webkit-scrollbar {
            width: 4px;
        }

        .preset-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .preset-list::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 2px;
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }
            
            .message.user {
                margin-left: 10%;
            }
            
            .message.assistant {
                margin-right: 10%;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid #30363d;
            }
            
            .message.user {
                margin-left: 5%;
            }
            
            .message.assistant {
                margin-right: 5%;
            }
            
            .cost-info-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <span class="robot-icon">🤖</span>
                <h1>RAG智能问答</h1>
            </div>
            
            <div class="sidebar-content">
                <div class="session-info">
                    <h4>🆔 当前会话</h4>
                    <div class="session-id" id="sessionId">正在创建会话...</div>
                </div>
                
                <div class="preset-questions">
                    <h3>💡 预设问题</h3>
                    <ul class="preset-list" id="presetList">
                        <li class="loading">加载中...</li>
                    </ul>
                </div>
                
                <div class="memory-panel">
                    <h3>🧠 记忆管理</h3>
                    <div class="memory-stats" id="memoryStats">
                        <div class="loading">加载中...</div>
                    </div>
                    <div class="memory-actions">
                        <button class="memory-btn" onclick="clearSessionMemory()">清除会话</button>
                        <button class="memory-btn danger" onclick="clearAllMemory()">清除全部</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-area">
            <div class="chat-messages" id="chatMessages">
                <div class="message assistant">
                    <div class="message-header">
                        <span>🤖 AI助手</span>
                        <span>欢迎使用RAG智能文档问答系统！</span>
                    </div>
                    <div class="message-content">
                        <p>我是您的AI助手，可以帮助您基于文档内容回答问题。系统具有以下特点：</p>
                        <ul>
                            <li><strong>智能检索</strong>：基于向量数据库快速找到相关内容</li>
                            <li><strong>多模态支持</strong>：支持文本、表格和图片的问答</li>
                            <li><strong>记忆功能</strong>：记住我们的对话历史，提供更连贯的回答</li>
                            <li><strong>来源追踪</strong>：显示答案的来源信息和页码</li>
                            <li><strong>多轮对话</strong>：支持上下文理解和连续对话</li>
                        </ul>
                        <p>请选择预设问题或直接输入您的问题开始对话！</p>
                    </div>
                </div>
            </div>
            
            <div class="input-area">
                <div class="input-group">
                    <input type="text" class="question-input" id="questionInput" 
                           placeholder="请输入您的问题..." onkeypress="handleKeyPress(event)">
                    <button class="send-btn" id="sendBtn" onclick="askQuestion()">发送</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentUserId = 'default_user';
        let currentSessionId = null;
        const API_BASE = 'http://localhost:5000/api';

        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('页面加载完成，开始初始化...');
            
            // 创建用户会话
            await createSession();
            
            // 加载预设问题
            await loadPresetQuestions();
            
            // 加载记忆统计
            await loadMemoryStats();
            
            console.log('初始化完成');
        });

        // 创建用户会话
        async function createSession() {
            try {
                // 使用固定的用户ID，这样记忆数据能够保持一致
                currentUserId = 'default_user';
                currentSessionId = currentUserId;
                document.getElementById('sessionId').textContent = currentUserId;
                console.log('会话创建成功:', currentUserId);
            } catch (error) {
                console.error('创建会话时发生错误:', error);
            }
        }

        // 加载预设问题
        async function loadPresetQuestions() {
            try {
                // 从API获取预设问题
                const response = await fetch(`${API_BASE}/qa/preset-questions`);
                if (response.ok) {
                    const data = await response.json();
                    const questions = data.questions || [];
                    
                    const presetList = document.getElementById('presetList');
                    presetList.innerHTML = '';
                    
                    questions.forEach(question => {
                        const li = document.createElement('li');
                        li.className = 'preset-item';
                        li.textContent = question;
                        li.onclick = () => {
                            document.getElementById('questionInput').value = question;
                            askQuestion();
                        };
                        presetList.appendChild(li);
                    });
                } else {
                    throw new Error('获取预设问题失败');
                }
            } catch (error) {
                console.error('加载预设问题失败:', error);
                // 使用默认的预设问题作为后备
                const defaultQuestions = [
                    "文档中有哪些主要内容？",
                    "请总结一下文档的核心观点",
                    "文档中提到了哪些关键数据？",
                    "有哪些重要的图表或图片？",
                    "文档的结构是怎样的？",
                    "请分析文档中的主要结论"
                ];
                
                const presetList = document.getElementById('presetList');
                presetList.innerHTML = '';
                
                defaultQuestions.forEach(question => {
                    const li = document.createElement('li');
                    li.className = 'preset-item';
                    li.textContent = question;
                    li.onclick = () => {
                        document.getElementById('questionInput').value = question;
                        askQuestion();
                    };
                    presetList.appendChild(li);
                });
            }
        }

        // 加载记忆统计
        async function loadMemoryStats() {
            try {
                const response = await fetch(`${API_BASE}/memory/stats?user_id=${currentUserId}`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('记忆统计响应:', data); // 添加调试日志
                    const stats = data.stats;
                    
                    const memoryStats = document.getElementById('memoryStats');
                    memoryStats.innerHTML = `
                        <div class="memory-stat-item">
                            <span>会话记忆:</span>
                            <span>${stats.session_memory_count || 0}</span>
                        </div>
                        <div class="memory-stat-item">
                            <span>历史记忆:</span>
                            <span>${stats.user_memory_count || 0}</span>
                        </div>
                        <div class="memory-stat-item">
                            <span>总记忆数:</span>
                            <span>${stats.total_memory_count || 0}</span>
                        </div>
                    `;
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                console.error('加载记忆统计失败:', error);
                document.getElementById('memoryStats').innerHTML = 
                    '<div class="error">加载记忆统计失败</div>';
            }
        }

        // 处理键盘事件
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                askQuestion();
            }
        }

        // 发送问题
        async function askQuestion() {
            const questionInput = document.getElementById('questionInput');
            const sendBtn = document.getElementById('sendBtn');
            const question = questionInput.value.trim();
            
            if (!question) {
                alert('请输入问题');
                return;
            }
            
            // 禁用输入和按钮
            questionInput.disabled = true;
            sendBtn.disabled = true;
            sendBtn.textContent = '处理中...';
            
            // 添加用户消息
            addMessage('user', question);
            
            try {
                const response = await fetch(`${API_BASE}/qa/ask`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        user_id: currentUserId,
                        use_memory: true,
                        k: 5
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        // 添加AI回答
                        addMessage('assistant', data.answer, {
                            cost: data.cost,
                            sources: data.sources,
                            timestamp: data.timestamp
                        }, false, question);
                        
                        // 清空输入框
                        questionInput.value = '';
                        
                        // 更新记忆统计
                        await loadMemoryStats();
                    } else {
                        throw new Error(data.error || '请求失败');
                    }
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '请求失败');
                }
                
            } catch (error) {
                console.error('发送问题时发生错误:', error);
                addMessage('assistant', `抱歉，处理您的问题时发生错误：${error.message}`, null, true, question);
            } finally {
                // 恢复输入和按钮
                questionInput.disabled = false;
                sendBtn.disabled = false;
                sendBtn.textContent = '发送';
                questionInput.focus();
            }
        }

        // 添加消息到聊天区域
        function addMessage(type, content, metadata = null, isError = false, userQuestion = '') {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const header = document.createElement('div');
            header.className = 'message-header';
            
            if (type === 'user') {
                header.innerHTML = `
                    <span>👤 您</span>
                    <span>${new Date().toLocaleTimeString()}</span>
                `;
            } else {
                header.innerHTML = `
                    <span>🤖 AI助手</span>
                    <span>${new Date().toLocaleTimeString()}</span>
                `;
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (isError) {
                contentDiv.innerHTML = `<p style="color: #da3633;">${content}</p>`;
            } else {
                        // 智能显示逻辑和用户主动控制
        let processedContent = content;
        
        // 检查是否包含图片信息
        if (metadata && metadata.sources) {
            // 提取图片数据
            const imageSources = metadata.sources.filter(source => 
                source.metadata && source.metadata.chunk_type === 'image'
            );
            
            if (imageSources.length > 0) {
                // 检查用户是否明确要求显示特定图片
                const userImageRequests = parseUserImageRequests(userQuestion);
                let imagesToShow = [];
                
                if (userImageRequests.length > 0) {
                    // 用户明确要求显示特定图片
                    imagesToShow = findRequestedImages(userImageRequests, imageSources);
                    console.log('用户明确要求显示图片:', userImageRequests);
                    console.log('找到的图片数量:', imagesToShow.length);
                } else {
                    // 第一轮：靠运气的智能显示
                    imagesToShow = filterRelevantImages(content, imageSources);
                    console.log('第一轮智能显示图片数量:', imagesToShow.length);
                }
                
                const deduplicatedImages = deduplicateImages(imagesToShow);
                
                // 调试信息
                console.log('LLM回答:', content.substring(0, 100));
                console.log('图片源数量:', imageSources.length);
                console.log('最终显示图片数量:', deduplicatedImages.length);
                
                // 处理图片并添加到内容中
                const imageComponents = [];
                
                deduplicatedImages.forEach((source, index) => {
                    const metadata = source.metadata;
                    const imageId = metadata.image_id;
                    
                    // 构建图片URL
                    const imageUrl = buildImageUrl(metadata.image_path);
                    
                    // 提取图片信息
                    const captionText = (metadata.img_caption || []).join(' ');
                    const footnoteText = (metadata.img_footnote || []).join(' ');
                    const chartType = metadata.chart_type || '信息图表';
                    const documentName = metadata.document_name || '未知文档';
                    const pageNumber = metadata.page_number || 1;
                    
                    // 创建图片组件
                    const imageComponent = createImageComponent({
                        url: imageUrl,
                        caption: captionText,
                        footnote: footnoteText,
                        type: chartType,
                        document: documentName,
                        page: pageNumber,
                        index: index + 1
                    });
                    
                    imageComponents.push(imageComponent);
                });
                
                // 将图片组件添加到内容末尾
                if (imageComponents.length > 0) {
                    processedContent += '\n\n' + imageComponents.join('\n\n');
                }
            }
        }
                
                // 使用Marked.js渲染Markdown
                contentDiv.innerHTML = marked.parse(processedContent);
            }
            
            messageDiv.appendChild(header);
            messageDiv.appendChild(contentDiv);
            
            // 如果有元数据，添加成本信息和来源详情
            if (metadata && !isError) {
                const costInfo = document.createElement('div');
                costInfo.className = 'cost-info';
                
                // 构建来源详情
                let sourcesDetail = '';
                if (metadata.sources && metadata.sources.length > 0) {
                    sourcesDetail = '<div class="sources-detail">';
                    sourcesDetail += '<strong>来源详情:</strong><br>';
                    metadata.sources.forEach((source, index) => {
                        const sourceMetadata = source.metadata || {};
                        let docName = sourceMetadata.document_name || '未知文档';
                        let pageNumber = sourceMetadata.page_number || '未知页码';
                        const chunkType = sourceMetadata.chunk_type || 'text';
                        
                        // 对于图片类型，显示图片标题和脚注信息
                        if (chunkType === 'image') {
                            const imgCaption = sourceMetadata.img_caption || [];
                            const imgFootnote = sourceMetadata.img_footnote || [];
                            
                            // 构建图片描述
                            let imageDescription = '';
                            if (imgCaption.length > 0) {
                                imageDescription = imgCaption.join(' ');
                            } else if (imgFootnote.length > 0) {
                                imageDescription = imgFootnote.join(' ');
                            } else {
                                imageDescription = '图片';
                            }
                            
                            // 如果metadata中没有文档名称，尝试从图片路径推断
                            if (!sourceMetadata.document_name && sourceMetadata.image_path) {
                                const imagePath = sourceMetadata.image_path;
                                // 尝试从图片路径中提取文档信息
                                if (imagePath.includes('md_test\\images\\')) {
                                    // 这里可以添加更智能的文档名称提取逻辑
                                    // 暂时使用默认值
                                    if (!docName || docName === '未知文档') {
                                        docName = '文档图片';
                                    }
                                }
                            }
                            
                            // 如果metadata中没有页码信息，使用默认值
                            if (!sourceMetadata.page_number) {
                                pageNumber = '图片';
                            }
                            
                            // 更新描述为图片标题
                            docName = `${docName} - ${imageDescription}`;
                        }
                        
                        sourcesDetail += `${index + 1}. ${docName} (第${pageNumber}页, ${chunkType})<br>`;
                    });
                    sourcesDetail += '</div>';
                }
                
                costInfo.innerHTML = `
                    <div class="cost-info-row">
                        <div class="cost-info-item">
                            <strong>成本:</strong> 
                            <span>${metadata.cost ? metadata.cost.toFixed(6) + ' 元' : 'N/A'}</span>
                        </div>
                        <div class="cost-info-item">
                            <strong>来源数量:</strong> 
                            <span>${metadata.sources ? metadata.sources.length : 0}</span>
                        </div>
                        <div class="cost-info-item">
                            <strong>时间:</strong> 
                            <span>${metadata.timestamp ? new Date(metadata.timestamp).toLocaleTimeString() : 'N/A'}</span>
                        </div>
                        <div class="cost-info-item">
                            <strong>用户ID:</strong> 
                            <span>${currentUserId}</span>
                        </div>
                    </div>
                    ${sourcesDetail}
                `;
                messageDiv.appendChild(costInfo);
            }
            
            chatMessages.appendChild(messageDiv);
            
            // 滚动到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 清除会话记忆
        async function clearSessionMemory() {
            if (confirm('确定要清除当前会话的记忆吗？')) {
                try {
                    const response = await fetch(`${API_BASE}/memory/clear`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: currentUserId,
                            memory_type: 'session'
                        })
                    });
                    
                    if (response.ok) {
                        alert('会话记忆已清除');
                        await loadMemoryStats();
                    } else {
                        throw new Error('清除失败');
                    }
                } catch (error) {
                    console.error('清除会话记忆失败:', error);
                    alert('清除会话记忆失败');
                }
            }
        }

        // 清除所有记忆
        async function clearAllMemory() {
            if (confirm('确定要清除所有记忆吗？这将清除所有用户的会话记忆和历史记忆！')) {
                try {
                    const response = await fetch(`${API_BASE}/memory/clear`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: null,  // 传入null清除所有用户的记忆
                            memory_type: 'all'
                        })
                    });
                    
                    if (response.ok) {
                        alert('所有记忆已清除');
                        await loadMemoryStats();
                    } else {
                        throw new Error('清除失败');
                    }
                } catch (error) {
                    console.error('清除所有记忆失败:', error);
                    alert('清除所有记忆失败');
                }
            }
        }

        // 构建图片URL的辅助函数
        function buildImageUrl(imagePath) {
            if (!imagePath) return '';
            
            let imageUrl = imagePath;
            
            // 处理相对路径
            if (imagePath.startsWith('./') || imagePath.startsWith('md_test/')) {
                imageUrl = imagePath.replace('./', '/').replace('md_test/', '/md_test/');
                if (!imageUrl.startsWith('/')) {
                    imageUrl = '/' + imageUrl;
                }
            } 
            // 处理包含images/的路径
            else if (imagePath.includes('images/')) {
                imageUrl = '/md_test/images/' + imagePath.split('/').pop();
            } 
            // 处理Windows路径分隔符
            else if (imagePath.includes('\\')) {
                const pathParts = imagePath.split('\\');
                const imageFileName = pathParts[pathParts.length - 1];
                imageUrl = '/md_test/images/' + imageFileName;
            }
            
            return imageUrl;
        }

        // 创建图片组件的辅助函数
        function createImageComponent(imageData) {
            const { url, caption, footnote, type, document, page, index } = imageData;
            
            // 构建图片信息
            let imageInfo = '';
            
            // 添加图表类型（如果有）
            if (type && type !== '信息图表') {
                imageInfo += `**图表类型**: ${type}\n\n`;
            }
            
            // 添加图片标题
            if (caption) {
                imageInfo += `**图片标题**: ${caption}\n\n`;
            }
            
            // 添加图片
            imageInfo += `![图片${index}](${url})\n\n`;
            
            // 添加来源信息
            if (document && page) {
                imageInfo += `**来源**: ${document} (第${page}页)\n\n`;
            }
            
            // 添加图片脚注（如果有）
            if (footnote) {
                imageInfo += `**图片脚注**: ${footnote}\n\n`;
            }
            
            return imageInfo;
        }

        // 智能显示逻辑辅助函数
        
        /**
         * 从LLM回答中解析图片ID
         * @param {string} answer - LLM的回答内容
         * @returns {Set} 图片ID集合
         */
        function parseImageIdsFromAnswer(answer) {
            const imageIds = new Set();
            // 支持两种格式：IMAGE_ID和DISPLAY_IMAGE
            const imageIdPatterns = [
                /\[IMAGE_ID:([^\]]+)\]/g,
                /\[DISPLAY_IMAGE:([^\]]+)\]/g
            ];
            
            imageIdPatterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(answer)) !== null) {
                    imageIds.add(match[1]);
                }
            });
            
            return imageIds;
        }
        
        /**
         * 从LLM回答中解析图片标题
         * @param {string} answer - LLM的回答内容
         * @returns {Set} 图片标题集合
         */
        function parseImageTitlesFromAnswer(answer) {
            const imageTitles = new Set();
            const titlePatterns = [
                /图片标题[：:]\s*([^\n]+)/g,
                /图表标题[：:]\s*([^\n]+)/g,
                /标题[：:]\s*([^\n]+)/g
            ];
            
            titlePatterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(answer)) !== null) {
                    imageTitles.add(match[1].trim());
                }
            });
            
            return imageTitles;
        }
        
        /**
         * 从LLM回答中解析图表编号引用
         * @param {string} answer - LLM的回答内容
         * @returns {Set} 图表编号集合
         */
        function parseChartNumbersFromAnswer(answer) {
            const chartNumbers = new Set();
            const chartPatterns = [
                /图(\d+)/g,
                /图表(\d+)/g,
                /图表编号[：:]\s*图(\d+)/g,
                /图表编号[：:]\s*(\d+)/g
            ];
            
            chartPatterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(answer)) !== null) {
                    chartNumbers.add(match[1]);
                }
            });
            
            return chartNumbers;
        }
        
        /**
         * 解析用户明确要求的图片显示请求
         * @param {string} userQuestion - 用户问题
         * @returns {Array} 用户要求的图片标识列表
         */
        function parseUserImageRequests(userQuestion) {
            const requests = [];
            const question = userQuestion.toLowerCase();
            
            console.log('解析用户图片请求:', userQuestion);
            console.log('转换为小写:', question);
            
            // 模糊匹配模式1：提取图表编号
            const chartNumberPatterns = [
                /图(\d+)/g,
                /图表(\d+)/g,
                /图片(\d+)/g
            ];
            
            chartNumberPatterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(question)) !== null) {
                    console.log('模糊匹配到图表编号:', match[1]);
                    requests.push({
                        type: 'chart_number',
                        value: match[1],
                        pattern: match[0]
                    });
                }
            });
            
            // 模糊匹配模式2：提取内容关键词
            const keywords = [
                '营收', '收入', '营业收入',
                '净利润', '利润', '归母净利润',
                '毛利率', '净利率', '利润率',
                '财务', '财务数据',
                '趋势', '增速', '增长',
                '结构', '构成', '分布',
                '对比', '比较', '相对',
                '个股', '股票', '股价'
            ];
            
            keywords.forEach(keyword => {
                if (question.includes(keyword)) {
                    console.log('模糊匹配到关键词:', keyword);
                    requests.push({
                        type: 'content_keyword',
                        value: keyword,
                        pattern: keyword
                    });
                }
            });
            
            // 模糊匹配模式3：显示所有图片的意图
            const allImageKeywords = ['所有图片', '所有图表', '全部图片', '全部图表', '显示所有', '把所有'];
            const hasAllImageIntent = allImageKeywords.some(keyword => question.includes(keyword));
            
            if (hasAllImageIntent) {
                console.log('模糊匹配到显示所有图片意图');
                requests.push({
                    type: 'all_images',
                    value: 'all',
                    pattern: 'all'
                });
            }
            
            console.log('最终解析结果:', requests);
            return requests;
        }
        
        /**
         * 根据用户请求查找对应的图片
         * @param {Array} userRequests - 用户请求列表
         * @param {Array} imageSources - 图片源数据
         * @returns {Array} 匹配的图片列表
         */
        function findRequestedImages(userRequests, imageSources) {
            const matchedImages = new Set(); // 使用Set避免重复
            const matchedImageIds = new Set(); // 跟踪已匹配的图片ID
            
            console.log('开始查找匹配的图片，用户请求:', userRequests);
            console.log('可用图片源数量:', imageSources.length);
            
            userRequests.forEach(request => {
                console.log('处理请求类型:', request.type, '值:', request.value);
                
                switch (request.type) {
                    case 'chart_number':
                        // 查找特定编号的图片
                        imageSources.forEach(source => {
                            const captionText = (source.metadata.img_caption || []).join(' ');
                            console.log('检查图片标题:', captionText, '是否包含图', request.value);
                            
                            if (captionText.includes(`图${request.value}`) || 
                                captionText.includes(`图表${request.value}`)) {
                                console.log('找到匹配的图片:', captionText);
                                if (!matchedImageIds.has(source.metadata.image_id)) {
                                    matchedImages.add(source);
                                    matchedImageIds.add(source.metadata.image_id);
                                }
                            }
                        });
                        break;
                        
                    case 'content_keyword':
                        // 根据内容关键词查找图片
                        const keyword = request.value;
                        imageSources.forEach(source => {
                            const captionText = (source.metadata.img_caption || []).join(' ');
                            const enhancedDescription = (source.metadata.enhanced_description || '');
                            
                            console.log('检查关键词:', keyword, '在标题:', captionText);
                            
                            // 扩展匹配逻辑：检查标题、描述、以及语义相关性
                            let isMatch = false;
                            
                            // 直接关键词匹配
                            if (captionText.includes(keyword) || 
                                enhancedDescription.includes(keyword)) {
                                isMatch = true;
                            }
                            
                            // 语义相关性匹配（针对财务数据）
                            if (keyword === '财务' || keyword === '财务数据') {
                                const financialKeywords = ['营收', '收入', '净利润', '利润', '毛利率', '净利率'];
                                if (financialKeywords.some(fk => captionText.includes(fk))) {
                                    isMatch = true;
                                }
                            }
                            
                            // 语义相关性匹配（针对趋势数据）
                            if (keyword === '趋势' || keyword === '增速') {
                                const trendKeywords = ['增速', '增长', '趋势', '变化'];
                                if (trendKeywords.some(tk => captionText.includes(tk))) {
                                    isMatch = true;
                                }
                            }
                            
                            if (isMatch && !matchedImageIds.has(source.metadata.image_id)) {
                                console.log('找到匹配的图片:', captionText);
                                matchedImages.add(source);
                                matchedImageIds.add(source.metadata.image_id);
                            }
                        });
                        break;
                        
                    case 'all_images':
                        // 返回所有图片
                        console.log('返回所有图片');
                        imageSources.forEach(source => {
                            if (!matchedImageIds.has(source.metadata.image_id)) {
                                matchedImages.add(source);
                                matchedImageIds.add(source.metadata.image_id);
                            }
                        });
                        break;
                }
            });
            
            const result = Array.from(matchedImages);
            console.log('最终匹配到的图片数量:', result.length);
            return result;
        }
        
        /**
         * 简化版图片过滤：根据问题内容智能显示相关图片
         * @param {string} answer - LLM的回答内容
         * @param {Array} imageSources - 图片源数据
         * @returns {Array} 过滤后的图片源数据
         */
        function filterRelevantImages(answer, imageSources) {
            console.log('开始智能过滤图片，LLM回答:', answer.substring(0, 100));
            
            // 策略1：如果LLM明确表示"没有找到"，返回空数组
            const noInfoFound = answer.includes('没有找到相关信息') || 
                              answer.includes('没有找到') || 
                              answer.includes('未找到') ||
                              answer.includes('抱歉，没有找到') ||
                              answer.includes('没有直接描述') ||
                              answer.includes('未提及');
            
            if (noInfoFound) {
                console.log('LLM表示没有找到相关信息，不显示图片');
                return [];
            }
            
            // 策略2：如果LLM回答包含图片相关关键词，显示所有图片
            const imageKeywords = /图片|图表|图|image|chart|财务数据|营收|净利润|毛利率|净利率/;
            if (imageKeywords.test(answer.toLowerCase())) {
                console.log('LLM回答包含图片关键词，显示所有图片');
                return imageSources;
            }
            
            // 策略2.5：如果LLM回答提到了图表内容，显示所有图片
            const hasChartContent = /图\d+|图表|图片|营收|净利润|毛利率|净利率|收入|利润|营业收入|净利润|毛利率|净利率/.test(answer.toLowerCase());
            
            if (hasChartContent) {
                console.log('LLM回答包含图表内容，显示所有图片');
                return imageSources;
            }
            
            // 策略3：基于metadata分类信息进行智能匹配
            const metadataFiltered = filterByMetadata(answer, imageSources);
            console.log('基于metadata过滤后的图片数量:', metadataFiltered.length);
            return metadataFiltered;
        }
        
        /**
         * 基于metadata分类信息进行智能过滤
         * @param {string} answer - LLM的回答内容
         * @param {Array} imageSources - 图片源数据
         * @returns {Array} 过滤后的图片源数据
         */
        function filterByMetadata(answer, imageSources) {
            const matchedImages = [];
            
            console.log('开始基于metadata过滤，LLM回答:', answer.substring(0, 100));
            
            // 定义分类关键词映射
            const categoryKeywords = {
                '财务': ['营收', '收入', '净利润', '利润', '毛利率', '净利率', '财务', '财务数据', '财务指标'],
                '趋势': ['趋势', '变化', '增长', '增速', '增长率', '同比', '环比', '趋势图'],
                '结构': ['结构', '分布', '占比', '比例', '构成', '结构图', '饼图'],
                '对比': ['对比', '比较', '相对', '指数', '表现', '对比图'],
                '季度': ['季度', '单季度', 'Q1', 'Q2', 'Q3', 'Q4', '季度数据'],
                '年度': ['年度', '全年', '年度数据', '年度报告']
            };
            
            // 检查LLM回答中是否包含分类关键词
            const detectedCategories = [];
            for (const [category, keywords] of Object.entries(categoryKeywords)) {
                if (keywords.some(keyword => answer.includes(keyword))) {
                    detectedCategories.push(category);
                    console.log('检测到分类:', category);
                }
            }
            
            // 如果没有检测到分类，但LLM回答提到了图表相关内容，显示所有图片
            if (detectedCategories.length === 0) {
                const chartRelatedPatterns = [
                    /图\d+/, /图表\d+/, /图片\d+/,
                    /营收/, /净利润/, /毛利率/, /净利率/,
                    /财务/, /趋势/, /增长/, /增速/
                ];
                
                const hasChartContent = chartRelatedPatterns.some(pattern => pattern.test(answer));
                if (hasChartContent) {
                    console.log('LLM回答包含图表相关内容，显示所有图片');
                    return imageSources;
                }
                
                console.log('没有检测到分类且无图表内容，不显示图片');
                return [];
            }
            
            console.log('检测到的分类:', detectedCategories);
            
            // 根据检测到的分类过滤图片
            imageSources.forEach(source => {
                const metadata = source.metadata;
                const captionText = (metadata.img_caption || []).join(' ').toLowerCase();
                const footnoteText = (metadata.img_footnote || []).join(' ').toLowerCase();
                const enhancedDescription = (metadata.enhanced_description || '').toLowerCase();
                
                // 检查图片内容是否匹配检测到的分类
                for (const category of detectedCategories) {
                    const keywords = categoryKeywords[category];
                    const hasMatch = keywords.some(keyword => 
                        captionText.includes(keyword.toLowerCase()) ||
                        footnoteText.includes(keyword.toLowerCase()) ||
                        enhancedDescription.includes(keyword.toLowerCase())
                    );
                    
                    if (hasMatch) {
                        console.log('图片匹配分类:', category, '标题:', captionText);
                        matchedImages.push(source);
                        break; // 找到一个匹配就足够了
                    }
                }
            });
            
            console.log('基于metadata过滤后的图片数量:', matchedImages.length);
            return matchedImages;
        }
        
        /**
         * 图片去重机制
         * @param {Array} imageSources - 图片源数据
         * @returns {Array} 去重后的图片源数据
         */
        function deduplicateImages(imageSources) {
            const seenIds = new Set();
            const seenTitles = new Set();
            const deduplicated = [];
            
            console.log('开始去重，输入图片数量:', imageSources.length);
            
            imageSources.forEach(source => {
                const metadata = source.metadata;
                const imageId = metadata.image_id || metadata.image_path.split('/').pop().split('.')[0];
                const captionText = (metadata.img_caption || []).join(' ');
                const footnoteText = (metadata.img_footnote || []).join(' ');
                const titleText = captionText || footnoteText;
                
                // 检查是否重复：基于图片ID和标题（仅在同一批次内去重）
                const isDuplicate = seenIds.has(imageId) || 
                                  (titleText && seenTitles.has(titleText));
                
                if (!isDuplicate) {
                    seenIds.add(imageId);
                    if (titleText) {
                        seenTitles.add(titleText);
                    }
                    deduplicated.push(source);
                    console.log('添加图片:', titleText);
                } else {
                    console.log('跳过重复图片:', titleText);
                }
            });
            
            console.log('去重后图片数量:', deduplicated.length);
            return deduplicated;
        }
    </script>
</body>
</html> 