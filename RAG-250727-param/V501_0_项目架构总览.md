# RAG系统项目架构总览

## 1. 项目概述

### 1.1 项目定位
本项目是一个基于RAG（Retrieval-Augmented Generation）架构的智能问答系统，专门用于处理金融文档（PDF、Markdown）并提供智能问答服务。系统采用模块化设计，支持多模态内容处理，具备完整的文档处理、向量化存储、智能检索和问答功能。

### 1.2 核心功能
- **多格式文档处理**：支持PDF、Markdown格式文档的智能解析
- **多模态内容提取**：自动提取文本、表格、图片内容并进行结构化处理
- **向量化存储**：将文档内容转换为向量进行高效检索
- **智能问答**：基于大语言模型的增强问答系统
- **记忆管理**：支持对话历史记忆和上下文理解
- **Web界面**：提供友好的Web交互界面
- **配置管理**：参数化配置，支持灵活的系统调优
- **增量处理**：支持新增文档的增量处理和向量数据库更新

## 2. 业务架构

### 2.1 业务流程
```
文档输入 → 文档处理 → 向量化存储 → 用户查询 → 智能检索 → 答案生成 → 结果展示
    ↓
记忆管理 ← 对话历史 ← 用户交互
    ↓
增量处理 ← 新增文档 ← 文档更新
```

### 2.2 业务模块划分

#### 2.2.1 一级模块（核心流程）
1. **配置管理模块** - 系统配置和参数管理
2. **文档处理模块** - 文档解析和预处理
3. **向量存储模块** - 向量化存储和检索
4. **智能问答模块** - 问答系统核心
5. **记忆管理模块** - 对话记忆和上下文管理
6. **Web服务模块** - 前端界面和API服务
7. **增量处理模块** - 新增文档处理和数据库更新

#### 2.2.2 二级模块（功能组件）

**配置管理模块**
- 配置加载器 (`config_manager.py`)
- 路径管理 (`paths.py`)
- 设置管理 (`settings.py`)

**文档处理模块**
- 文档分块 (`document_chunker.py`, `enhanced_chunker.py`)
- PDF处理器 (`pdf_processor.py`)
- Markdown处理器 (`markdown_processor.py`)
- 表格处理器 (`table_processor.py`)
- 图片处理器 (`image_processor.py`, `enhanced_image_processor.py`)
- 图片提取器 (`image_extractor.py`)
- 向量生成器 (`vector_generator.py`, `enhanced_vector_generator.py`)
- 处理管道 (`pipeline.py`, `incremental_pipeline.py`)
- 批量处理器 (`minerU_batch_local_files.py`)

**向量存储模块**
- 向量存储管理 (`vector_store.py`)

**智能问答模块**
- 增强问答系统 (`enhanced_qa_system.py`)
- 源过滤引擎 (`source_filter_engine.py`)
- 智能过滤引擎 (`smart_filter_engine.py`)
- 重排序引擎 (`reranking_engine.py`)

**记忆管理模块**
- 记忆管理器 (`memory_manager.py`)

**Web服务模块**
- API应用 (`api/app.py`)
- 路由管理 (`api/routes.py`)
- 前端界面 (`web_app_test/index.html`)

## 3. 技术架构

### 3.1 技术栈

#### 3.1.1 后端技术
- **Python 3.x** - 主要开发语言
- **LangChain** - LLM应用框架
- **ChromaDB** - 向量数据库
- **DashScope API** - 大语言模型服务
- **Flask** - Web框架
- **BeautifulSoup4** - HTML解析
- **PyMuPDF** - PDF处理
- **Pillow** - 图像处理
- **JSON** - 配置和数据存储
- **JSON** - 配置和数据存储

#### 3.1.2 前端技术
- **HTML5/CSS3/JavaScript** - 前端界面
- **Marked.js** - Markdown渲染
- **Fetch API** - 异步请求

### 3.2 系统架构图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端界面      │    │   API服务层     │    │   核心业务层    │
│  (index.html)   │◄──►│   (Flask API)   │◄──►│  (RAG System)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                       │
                                ▼                       ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │   配置管理      │    │   记忆管理      │
                       │  (Config Mgmt)  │    │  (Memory Mgmt)  │
                       └─────────────────┘    └─────────────────┘
                                │                       │
                                ▼                       ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │   文档处理      │    │   向量存储      │
                       │  (Doc Process)  │    │  (Vector Store) │
                       └─────────────────┘    └─────────────────┘
                                │                       │
                                ▼                       ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │   增量处理      │    │   智能问答      │
                       │ (Incremental)   │    │  (QA System)    │
                       └─────────────────┘    └─────────────────┘
```

### 3.3 数据流架构

```
文档文件 → 文档解析 → 内容分块 → 向量化 → 向量存储
    ↓
用户查询 → 向量检索 → 内容过滤 → 重排序 → LLM生成 → 答案输出
    ↓
对话记忆 ← 记忆存储 ← 上下文管理
    ↓
增量更新 ← 新增文档 ← 文档处理
```

## 4. 模块详细分析

### 4.1 配置管理模块

#### 4.1.1 功能职责
- 系统参数配置管理
- 路径配置管理
- API密钥管理
- 处理参数配置
- 嵌入模型配置

#### 4.1.2 核心组件
- **`config_manager.py`**: 配置加载和验证
- **`paths.py`**: 文件路径管理
- **`settings.py`**: 系统设置管理

#### 4.1.3 配置结构
```json
{
  "api": { 
    "dashscope_api_key": "API密钥",
    "mineru_api_key": "备用API密钥"
  },
  "paths": { 
    "pdf_dir": "./document/pdf",
    "output_dir": "./document/md",
    "md_dir": "./document/md",
    "central_images_dir": "./central/images",
    "add_pdf_dir": "./document/add_pdf",
    "add_output_dir": "./document/add_md",
    "add_md_dir": "./document/add_md",
    "vector_db_dir": "./central/vector_db",
    "web_app_dir": "./web_app_test",
    "memory_db_dir": "./memory_db"
  },
  "processing": { 
    "chunk_size": 1000,
    "chunk_overlap": 200,
    "max_table_rows": 100,
    "enable_logging": true,
    "enable_smart_filtering": false,
    "semantic_similarity_threshold": 0.1,
    "content_relevance_threshold": 0.01,
    "max_filtered_results": 5
  },
  "vector_store": { 
    "vector_dimension": 1536,
    "similarity_top_k": 5,
    "similarity_threshold": 0.1,
    "enable_reranking": true,
    "reranking_method": "hybrid",
    "semantic_weight": 0.7,
    "keyword_weight": 0.3,
    "min_similarity_threshold": 0.001,
    "text_embedding_model": "text-embedding-v4",
    "multimodal_embedding_model": "multimodal_embedding_one_peace_v1"
  },
  "qa_system": { 
    "model_name": "qwen-plus-latest",
    "temperature": 0.5,
    "max_tokens": 1500,
    "enable_sources_filtering": true,
    "min_relevance_score": 0.001,
    "enable_keyword_matching": true,
    "enable_image_id_matching": true,
    "enable_similarity_filtering": true
  },
  "memory": { 
    "memory_enabled": true,
    "memory_max_size": 10
  },
  "preset_questions": { 
    "preset_questions_file": "./preset_questions_test.json"
  }
}
```
  "vector_store": { 
    "vector_dimension": 1536,
    "similarity_top_k": 5,
    "similarity_threshold": 0.1,
    "enable_reranking": true,
    "reranking_method": "hybrid",
    "semantic_weight": 0.7,
    "keyword_weight": 0.3,
    "min_similarity_threshold": 0.001,
    "text_embedding_model": "text-embedding-v4",
    "multimodal_embedding_model": "multimodal_embedding_one_peace_v1"
  },
  "qa_system": { 
    "model_name": "qwen-plus-latest",
    "temperature": 0.5,
    "max_tokens": 1500,
    "enable_sources_filtering": true,
    "min_relevance_score": 0.001,
    "enable_keyword_matching": true,
    "enable_image_id_matching": true,
    "enable_similarity_filtering": true
  },
  "memory": { 
    "memory_enabled": true,
    "memory_max_size": 10
  },
  "preset_questions": { 
    "preset_questions_file": "./preset_questions_test.json"
  }
}
```

### 4.2 文档处理模块

#### 4.2.1 功能职责
- 多格式文档解析（PDF、Markdown）
- 文档内容分块和向量化
- 表格数据提取和结构化
- 图片提取和处理
- 增量文档处理

#### 4.2.2 处理流程
```
文档输入 → 格式识别 → 内容提取 → 分块处理 → 向量化 → 存储
    ↓
表格处理 ← 图片处理 ← 文本处理
    ↓
增量处理 ← 新增文档 ← 临时处理
```

#### 4.2.3 核心组件
- **`pipeline.py`**: 文档处理管道，协调各组件
- **`incremental_pipeline.py`**: 增量文档处理管道
- **`enhanced_chunker.py`**: 智能文档分块
- **`table_processor.py`**: 表格数据提取和结构化
- **`enhanced_image_processor.py`**: 图片内容提取和处理
- **`enhanced_vector_generator.py`**: 向量化生成
- **`minerU_batch_local_files.py`**: 批量文件处理

### 4.3 向量存储模块

#### 4.3.1 功能职责
- 向量数据存储管理
- 相似度检索
- 向量索引维护
- 多模态向量支持

#### 4.3.2 核心组件
- **`vector_store.py`**: 向量存储管理，基于ChromaDB

### 4.4 智能问答模块

#### 4.4.1 功能职责
- 用户查询处理
- 相关文档检索
- 内容过滤和重排序
- 答案生成
- 源引用管理
- 多模态内容处理

#### 4.4.2 处理流程
```
用户查询 → 向量检索 → 智能过滤 → 重排序 → LLM生成 → 答案输出
    ↓
源过滤引擎 ← 重排序引擎 ← 智能过滤引擎
    ↓
记忆关联 ← 上下文理解 ← 历史对话
```

#### 4.4.3 核心组件
- **`enhanced_qa_system.py`**: 增强问答系统主引擎
- **`source_filter_engine.py`**: 源内容过滤引擎
- **`smart_filter_engine.py`**: 智能过滤引擎
- **`reranking_engine.py`**: 结果重排序引擎

### 4.5 记忆管理模块

#### 4.5.1 功能职责
- 对话历史管理
- 上下文记忆
- 用户会话管理
- 相关性计算和匹配

#### 4.5.2 核心组件
- **`memory_manager.py`**: 记忆管理器

#### 4.5.3 记忆系统优化
- **相关性阈值优化**: 从0.1降低到0.05，提高记忆关联性
- **指代词识别**: 支持"该"、"此"等指代词识别
- **关键词扩展**: 增加金融领域相关词汇
- **问题类型识别**: 识别"是什么"、"如何"、"怎样"等问题类型

### 4.6 Web服务模块

#### 4.6.1 功能职责
- API接口提供
- 前端界面服务
- 用户交互处理

#### 4.6.2 核心组件
- **`api/app.py`**: Flask应用主程序
- **`api/routes.py`**: API路由定义
- **`web_app_test/index.html`**: 前端界面

## 5. 关键技术特性

### 5.1 嵌入模型参数化配置
- **文本嵌入模型**: `text-embedding-v4`
- **多模态嵌入模型**: `multimodal_embedding_one_peace_v1`
- **统一配置管理**: 所有组件使用配置文件中的模型设置
- **无硬编码**: 完全参数化配置，支持灵活切换

### 5.2 智能过滤机制
- **语义相似度过滤**: 基于向量相似度
- **关键词匹配过滤**: 基于关键词相关性
- **内容相关性过滤**: 基于内容质量评分
- **混合重排序**: 结合多种排序策略
- **多模态过滤**: 支持文本和图片内容的平衡检索

### 5.3 多模态处理
- **文本处理**: 支持中文文本分块和向量化
- **表格处理**: 自动提取表格结构，转换为结构化文本
- **图片处理**: 提取图片标题、脚注，生成描述性文本
- **增量处理**: 支持新增文档的增量处理和向量数据库更新

### 5.4 记忆管理优化
- **会话记忆**: 保存用户对话历史
- **上下文理解**: 基于历史对话提供连贯回答
- **相关性计算**: 改进的相关性计算算法
- **记忆统计**: 提供记忆使用情况统计
- **降级机制**: 完善的错误处理和降级策略

### 5.5 智能图片显示
- **自动图片识别**: 根据LLM回答自动显示相关图片
- **用户控制显示**: 支持用户明确要求显示特定图片
- **元数据过滤**: 基于图片元数据进行智能匹配
- **平衡检索**: 确保文本和图片内容的平衡检索

### 5.6 增量文档处理
- **临时处理**: 在临时目录中进行PDF转换和图片提取
- **文件迁移**: 处理完成后将所有文件迁移到原有目录结构
- **配置管理**: 使用配置文件管理所有路径
- **保持兼容性**: 确保metadata记录正确的值，与现有系统完全兼容

## 6. 部署和运行

### 6.1 系统要求
- Python 3.8+
- 足够的磁盘空间（向量存储）
- 网络连接（API调用）
- 内存：建议8GB以上

### 6.2 启动方式
```bash
# 命令行模式
python V503_unified_main.py --mode cli

# Web服务模式
python V503_unified_main.py --mode web

# 文档处理模式
python V503_unified_main.py --mode process

# 增量处理模式
python V503_unified_main.py --mode incremental
```

### 6.3 配置要求
- 配置DashScope API密钥
- 设置文档目录路径
- 调整处理参数
- 配置嵌入模型参数

## 7. 性能优化

### 7.1 检索优化
- 向量相似度阈值调整
- 重排序策略优化
- 过滤参数调优
- 多模态内容平衡检索

### 7.2 内存优化
- 分块大小调整
- 向量维度优化
- 缓存机制
- 记忆管理优化

### 7.3 响应速度优化
- 异步处理
- 批量操作
- 索引优化
- 降级机制

### 7.4 记忆系统优化
- 相关性阈值调整（0.1 → 0.05）
- 改进相关性计算方法
- 增强指代词识别
- 扩展关键词匹配

## 8. 扩展性设计

### 8.1 模块化架构
- 各模块独立，便于扩展
- 标准化接口设计
- 插件化组件
- 配置驱动设计

### 8.2 配置驱动
- 参数化配置
- 运行时调整
- 环境适配
- 嵌入模型参数化

### 8.3 多模型支持
- 支持多种LLM模型
- 模型切换机制
- API适配层
- 嵌入模型统一配置

### 8.4 增量处理支持
- 新增文档处理
- 向量数据库增量更新
- 临时处理机制
- 文件迁移管理

## 9. 最新技术进展

### 9.1 嵌入模型参数化完成
- ✅ 所有组件使用统一配置
- ✅ 无硬编码模型名称
- ✅ 支持灵活模型切换
- ✅ 完整的测试验证

### 9.2 记忆系统优化完成
- ✅ 相关性阈值优化
- ✅ 改进相关性计算方法
- ✅ 增强指代词识别
- ✅ 完善的错误处理机制

### 9.3 增量处理系统
- ✅ 新增文档处理流程
- ✅ 临时处理机制
- ✅ 文件迁移管理
- ✅ 配置驱动的路径管理

### 9.4 多模态处理增强
- ✅ 文本和图片内容平衡检索
- ✅ 智能图片显示
- ✅ 表格结构化处理
- ✅ 元数据智能匹配

## 10. 总结

本项目采用模块化、配置化的RAG架构设计，具有以下特点：

1. **完整的RAG流程**: 从文档处理到智能问答的完整链路
2. **多模态支持**: 文本、表格、图片的全面处理
3. **智能过滤**: 多层次的内容过滤和重排序机制
4. **记忆管理**: 支持对话历史和上下文理解
5. **用户友好**: Web界面和API服务双重支持
6. **高度可配置**: 参数化配置，便于调优和部署
7. **增量处理**: 支持新增文档的增量处理和数据库更新
8. **嵌入模型参数化**: 统一的模型配置管理
9. **记忆系统优化**: 改进的相关性计算和匹配机制
10. **多模态平衡**: 文本和图片内容的智能平衡检索

该架构为金融文档智能问答提供了完整的技术解决方案，具有良好的扩展性、维护性和性能表现。系统已经完成了核心功能的开发和优化，具备了生产环境部署的条件。 