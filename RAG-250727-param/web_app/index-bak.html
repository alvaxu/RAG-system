<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAGæ™ºèƒ½æ–‡æ¡£é—®ç­”ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #0d1117;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            background: #0d1117;
        }

        .sidebar {
            width: 280px;
            background: #161b22;
            border-right: 1px solid #30363d;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            gap: 12px;
            background: #21262d;
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #f0f6fc;
            margin: 0;
        }

        .sidebar-header .robot-icon {
            font-size: 24px;
        }

        .sidebar-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .session-info {
            background: #21262d;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #30363d;
            margin-bottom: 20px;
        }

        .session-info h4 {
            color: #f0f6fc;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .session-id {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            background: #0d1117;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            word-break: break-all;
            color: #7d8590;
            border: 1px solid #30363d;
        }

        .preset-questions {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .preset-questions h3 {
            color: #f0f6fc;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 500;
        }

        .preset-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .preset-item {
            background: #21262d;
            padding: 12px 16px;
            border-radius: 6px;
            border: 1px solid #30363d;
            color: #e6edf3;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .preset-item:hover {
            background: #30363d;
            border-color: #58a6ff;
        }

        .memory-panel {
            margin-top: auto;
        }

        .memory-panel h3 {
            color: #f0f6fc;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 500;
        }

        .memory-stats {
            background: #21262d;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #30363d;
            margin-bottom: 12px;
        }

        .memory-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .memory-stat-item:last-child {
            margin-bottom: 0;
        }

        .memory-stat-item span:first-child {
            color: #7d8590;
        }

        .memory-stat-item span:last-child {
            color: #e6edf3;
            font-weight: 500;
        }

        .memory-actions {
            display: flex;
            gap: 8px;
        }

        .memory-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: #21262d;
            color: #e6edf3;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .memory-btn:hover {
            background: #30363d;
        }

        .memory-btn.danger {
            border-color: #da3633;
            color: #da3633;
        }

        .memory-btn.danger:hover {
            background: #da3633;
            color: #f0f6fc;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0d1117;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            max-width: 80%;
            padding: 16px 20px;
            border-radius: 12px;
            position: relative;
        }

        .message.user {
            align-self: flex-end;
            background: #58a6ff;
            color: #f0f6fc;
            margin-left: 20%;
        }

        .message.assistant {
            align-self: flex-start;
            background: #21262d;
            color: #e6edf3;
            margin-right: 20%;
            border: 1px solid #30363d;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            opacity: 0.8;
        }

        .message-content {
            line-height: 1.6;
        }

        .message-content p {
            margin-bottom: 12px;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul, .message-content ol {
            margin-bottom: 12px;
            padding-left: 20px;
        }

        .message-content li {
            margin-bottom: 4px;
        }

        .message-content code {
            background: #0d1117;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message-content pre {
            background: #0d1117;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 12px;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .message-content blockquote {
            border-left: 4px solid #58a6ff;
            padding-left: 16px;
            margin: 12px 0;
            color: #7d8590;
        }

        .message-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            margin: 10px 0;
        }
        
        .message-content h1, .message-content h2, .message-content h3, .message-content h4 {
            color: #f0f6fc;
            margin: 16px 0 8px 0;
        }
        
        .message-content h4 {
            color: #58a6ff;
            font-size: 16px;
            font-weight: 600;
        }
        
        .message-content strong {
            color: #f0f6fc;
            font-weight: 600;
        }
        
        .message-content ul {
            margin: 12px 0;
        }
        
        .message-content li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .message-content .image-container {
            margin: 12px 0;
            text-align: center;
        }

        .message-content .image-container img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            border: 1px solid #30363d;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .message-content .image-caption {
            margin-top: 8px;
            font-size: 12px;
            color: #7d8590;
            text-align: center;
        }

        .cost-info {
            margin-top: 12px;
            padding: 12px;
            background: #0d1117;
            border-radius: 6px;
            border: 1px solid #30363d;
        }

        .cost-info-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .cost-info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .cost-info-item strong {
            font-size: 11px;
            color: #7d8590;
            font-weight: 500;
        }

        .cost-info-item span {
            color: #e6edf3;
            font-size: 12px;
        }
        
        .sources-detail {
            margin-top: 10px;
            padding: 8px;
            background: #161b22;
            border-radius: 6px;
            border-left: 3px solid #58a6ff;
            font-size: 11px;
            line-height: 1.4;
            color: #e6edf3;
        }

        .memory-indicator {
            display: inline-block;
            background: #238636;
            color: #f0f6fc;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 8px;
            font-weight: 500;
        }

        .input-area {
            padding: 20px;
            border-top: 1px solid #30363d;
            background: #0d1117;
        }

        .input-group {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .question-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #30363d;
            border-radius: 8px;
            background: #21262d;
            color: #e6edf3;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .question-input:focus {
            border-color: #58a6ff;
        }

        .question-input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .send-btn {
            padding: 12px 24px;
            background: #238636;
            color: #f0f6fc;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .send-btn:hover:not(:disabled) {
            background: #2ea043;
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            color: #7d8590;
            font-style: italic;
        }

        .error {
            color: #da3633;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0d1117;
        }

        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }

        /* ä¾§è¾¹æ æ»šåŠ¨æ¡ */
        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: #161b22;
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 3px;
        }

        .preset-list::-webkit-scrollbar {
            width: 4px;
        }

        .preset-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .preset-list::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 2px;
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }
            
            .message.user {
                margin-left: 10%;
            }
            
            .message.assistant {
                margin-right: 10%;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid #30363d;
            }
            
            .message.user {
                margin-left: 5%;
            }
            
            .message.assistant {
                margin-right: 5%;
            }
            
            .cost-info-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <span class="robot-icon">ğŸ¤–</span>
                <h1>RAGæ™ºèƒ½é—®ç­”</h1>
            </div>
            
            <div class="sidebar-content">
                <div class="session-info">
                    <h4>ğŸ†” å½“å‰ä¼šè¯</h4>
                    <div class="session-id" id="sessionId">æ­£åœ¨åˆ›å»ºä¼šè¯...</div>
                </div>
                
                <div class="preset-questions">
                    <h3>ğŸ’¡ é¢„è®¾é—®é¢˜</h3>
                    <ul class="preset-list" id="presetList">
                        <li class="loading">åŠ è½½ä¸­...</li>
                    </ul>
                </div>
                
                <div class="memory-panel">
                    <h3>ğŸ§  è®°å¿†ç®¡ç†</h3>
                    <div class="memory-stats" id="memoryStats">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                    <div class="memory-actions">
                        <button class="memory-btn" onclick="clearSessionMemory()">æ¸…é™¤ä¼šè¯</button>
                        <button class="memory-btn danger" onclick="clearAllMemory()">æ¸…é™¤å…¨éƒ¨</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-area">
            <div class="chat-messages" id="chatMessages">
                <div class="message assistant">
                    <div class="message-header">
                        <span>ğŸ¤– AIåŠ©æ‰‹</span>
                        <span>æ¬¢è¿ä½¿ç”¨RAGæ™ºèƒ½æ–‡æ¡£é—®ç­”ç³»ç»Ÿï¼</span>
                    </div>
                    <div class="message-content">
                        <p>æˆ‘æ˜¯æ‚¨çš„AIåŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©æ‚¨åŸºäºæ–‡æ¡£å†…å®¹å›ç­”é—®é¢˜ã€‚ç³»ç»Ÿå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
                        <ul>
                            <li><strong>æ™ºèƒ½æ£€ç´¢</strong>ï¼šåŸºäºå‘é‡æ•°æ®åº“å¿«é€Ÿæ‰¾åˆ°ç›¸å…³å†…å®¹</li>
                            <li><strong>å¤šæ¨¡æ€æ”¯æŒ</strong>ï¼šæ”¯æŒæ–‡æœ¬ã€è¡¨æ ¼å’Œå›¾ç‰‡çš„é—®ç­”</li>
                            <li><strong>è®°å¿†åŠŸèƒ½</strong>ï¼šè®°ä½æˆ‘ä»¬çš„å¯¹è¯å†å²ï¼Œæä¾›æ›´è¿è´¯çš„å›ç­”</li>
                            <li><strong>æ¥æºè¿½è¸ª</strong>ï¼šæ˜¾ç¤ºç­”æ¡ˆçš„æ¥æºä¿¡æ¯å’Œé¡µç </li>
                            <li><strong>å¤šè½®å¯¹è¯</strong>ï¼šæ”¯æŒä¸Šä¸‹æ–‡ç†è§£å’Œè¿ç»­å¯¹è¯</li>
                        </ul>
                        <p>è¯·é€‰æ‹©é¢„è®¾é—®é¢˜æˆ–ç›´æ¥è¾“å…¥æ‚¨çš„é—®é¢˜å¼€å§‹å¯¹è¯ï¼</p>
                    </div>
                </div>
            </div>
            
            <div class="input-area">
                <div class="input-group">
                    <input type="text" class="question-input" id="questionInput" 
                           placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." onkeypress="handleKeyPress(event)">
                    <button class="send-btn" id="sendBtn" onclick="askQuestion()">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentUserId = 'default_user';
        let currentSessionId = null;
        const API_BASE = 'http://localhost:5000/api';

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // åˆ›å»ºç”¨æˆ·ä¼šè¯
            await createSession();
            
            // åŠ è½½é¢„è®¾é—®é¢˜
            await loadPresetQuestions();
            
            // åŠ è½½è®°å¿†ç»Ÿè®¡
            await loadMemoryStats();
            
            console.log('åˆå§‹åŒ–å®Œæˆ');
        });

        // åˆ›å»ºç”¨æˆ·ä¼šè¯
        async function createSession() {
            try {
                // ä½¿ç”¨å›ºå®šçš„ç”¨æˆ·IDï¼Œè¿™æ ·è®°å¿†æ•°æ®èƒ½å¤Ÿä¿æŒä¸€è‡´
                currentUserId = 'default_user';
                currentSessionId = currentUserId;
                document.getElementById('sessionId').textContent = currentUserId;
                console.log('ä¼šè¯åˆ›å»ºæˆåŠŸ:', currentUserId);
            } catch (error) {
                console.error('åˆ›å»ºä¼šè¯æ—¶å‘ç”Ÿé”™è¯¯:', error);
            }
        }

        // åŠ è½½é¢„è®¾é—®é¢˜
        async function loadPresetQuestions() {
            try {
                // ä»APIè·å–é¢„è®¾é—®é¢˜
                const response = await fetch(`${API_BASE}/qa/preset-questions`);
                if (response.ok) {
                    const data = await response.json();
                    const questions = data.questions || [];
                    
                    const presetList = document.getElementById('presetList');
                    presetList.innerHTML = '';
                    
                    questions.forEach(question => {
                        const li = document.createElement('li');
                        li.className = 'preset-item';
                        li.textContent = question;
                        li.onclick = () => {
                            document.getElementById('questionInput').value = question;
                            askQuestion();
                        };
                        presetList.appendChild(li);
                    });
                } else {
                    throw new Error('è·å–é¢„è®¾é—®é¢˜å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½é¢„è®¾é—®é¢˜å¤±è´¥:', error);
                // ä½¿ç”¨é»˜è®¤çš„é¢„è®¾é—®é¢˜ä½œä¸ºåå¤‡
                const defaultQuestions = [
                    "æ–‡æ¡£ä¸­æœ‰å“ªäº›ä¸»è¦å†…å®¹ï¼Ÿ",
                    "è¯·æ€»ç»“ä¸€ä¸‹æ–‡æ¡£çš„æ ¸å¿ƒè§‚ç‚¹",
                    "æ–‡æ¡£ä¸­æåˆ°äº†å“ªäº›å…³é”®æ•°æ®ï¼Ÿ",
                    "æœ‰å“ªäº›é‡è¦çš„å›¾è¡¨æˆ–å›¾ç‰‡ï¼Ÿ",
                    "æ–‡æ¡£çš„ç»“æ„æ˜¯æ€æ ·çš„ï¼Ÿ",
                    "è¯·åˆ†ææ–‡æ¡£ä¸­çš„ä¸»è¦ç»“è®º"
                ];
                
                const presetList = document.getElementById('presetList');
                presetList.innerHTML = '';
                
                defaultQuestions.forEach(question => {
                    const li = document.createElement('li');
                    li.className = 'preset-item';
                    li.textContent = question;
                    li.onclick = () => {
                        document.getElementById('questionInput').value = question;
                        askQuestion();
                    };
                    presetList.appendChild(li);
                });
            }
        }

        // åŠ è½½è®°å¿†ç»Ÿè®¡
        async function loadMemoryStats() {
            try {
                const response = await fetch(`${API_BASE}/memory/stats?user_id=${currentUserId}`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('è®°å¿†ç»Ÿè®¡å“åº”:', data); // æ·»åŠ è°ƒè¯•æ—¥å¿—
                    const stats = data.stats;
                    
                    const memoryStats = document.getElementById('memoryStats');
                    memoryStats.innerHTML = `
                        <div class="memory-stat-item">
                            <span>ä¼šè¯è®°å¿†:</span>
                            <span>${stats.session_memory_count || 0}</span>
                        </div>
                        <div class="memory-stat-item">
                            <span>å†å²è®°å¿†:</span>
                            <span>${stats.user_memory_count || 0}</span>
                        </div>
                        <div class="memory-stat-item">
                            <span>æ€»è®°å¿†æ•°:</span>
                            <span>${stats.total_memory_count || 0}</span>
                        </div>
                    `;
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                console.error('åŠ è½½è®°å¿†ç»Ÿè®¡å¤±è´¥:', error);
                document.getElementById('memoryStats').innerHTML = 
                    '<div class="error">åŠ è½½è®°å¿†ç»Ÿè®¡å¤±è´¥</div>';
            }
        }

        // å¤„ç†é”®ç›˜äº‹ä»¶
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                askQuestion();
            }
        }

        // å‘é€é—®é¢˜
        async function askQuestion() {
            const questionInput = document.getElementById('questionInput');
            const sendBtn = document.getElementById('sendBtn');
            const question = questionInput.value.trim();
            
            if (!question) {
                alert('è¯·è¾“å…¥é—®é¢˜');
                return;
            }
            
            // ç¦ç”¨è¾“å…¥å’ŒæŒ‰é’®
            questionInput.disabled = true;
            sendBtn.disabled = true;
            sendBtn.textContent = 'å¤„ç†ä¸­...';
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage('user', question);
            
            try {
                const response = await fetch(`${API_BASE}/qa/ask`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        user_id: currentUserId,
                        use_memory: true,
                        k: 5
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        // æ·»åŠ AIå›ç­”
                        addMessage('assistant', data.answer, {
                            cost: data.cost,
                            sources: data.sources,
                            timestamp: data.timestamp
                        }, false, question);
                        
                        // æ¸…ç©ºè¾“å…¥æ¡†
                        questionInput.value = '';
                        
                        // æ›´æ–°è®°å¿†ç»Ÿè®¡
                        await loadMemoryStats();
                    } else {
                        throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
                    }
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'è¯·æ±‚å¤±è´¥');
                }
                
            } catch (error) {
                console.error('å‘é€é—®é¢˜æ—¶å‘ç”Ÿé”™è¯¯:', error);
                addMessage('assistant', `æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„é—®é¢˜æ—¶å‘ç”Ÿé”™è¯¯ï¼š${error.message}`, null, true, question);
            } finally {
                // æ¢å¤è¾“å…¥å’ŒæŒ‰é’®
                questionInput.disabled = false;
                sendBtn.disabled = false;
                sendBtn.textContent = 'å‘é€';
                questionInput.focus();
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addMessage(type, content, metadata = null, isError = false, userQuestion = '') {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const header = document.createElement('div');
            header.className = 'message-header';
            
            if (type === 'user') {
                header.innerHTML = `
                    <span>ğŸ‘¤ æ‚¨</span>
                    <span>${new Date().toLocaleTimeString()}</span>
                `;
            } else {
                header.innerHTML = `
                    <span>ğŸ¤– AIåŠ©æ‰‹</span>
                    <span>${new Date().toLocaleTimeString()}</span>
                `;
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (isError) {
                contentDiv.innerHTML = `<p style="color: #da3633;">${content}</p>`;
            } else {
                        // æ™ºèƒ½æ˜¾ç¤ºé€»è¾‘å’Œç”¨æˆ·ä¸»åŠ¨æ§åˆ¶
        let processedContent = content;
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å«å›¾ç‰‡ä¿¡æ¯
        if (metadata && metadata.sources) {
            // æå–å›¾ç‰‡æ•°æ®
            const imageSources = metadata.sources.filter(source => 
                source.metadata && source.metadata.chunk_type === 'image'
            );
            
            if (imageSources.length > 0) {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜ç¡®è¦æ±‚æ˜¾ç¤ºç‰¹å®šå›¾ç‰‡
                const userImageRequests = parseUserImageRequests(userQuestion);
                let imagesToShow = [];
                
                if (userImageRequests.length > 0) {
                    // ç”¨æˆ·æ˜ç¡®è¦æ±‚æ˜¾ç¤ºç‰¹å®šå›¾ç‰‡
                    imagesToShow = findRequestedImages(userImageRequests, imageSources);
                    console.log('ç”¨æˆ·æ˜ç¡®è¦æ±‚æ˜¾ç¤ºå›¾ç‰‡:', userImageRequests);
                    console.log('æ‰¾åˆ°çš„å›¾ç‰‡æ•°é‡:', imagesToShow.length);
                } else {
                    // ç¬¬ä¸€è½®ï¼šé è¿æ°”çš„æ™ºèƒ½æ˜¾ç¤º
                    imagesToShow = filterRelevantImages(content, imageSources);
                    console.log('ç¬¬ä¸€è½®æ™ºèƒ½æ˜¾ç¤ºå›¾ç‰‡æ•°é‡:', imagesToShow.length);
                }
                
                const deduplicatedImages = deduplicateImages(imagesToShow);
                
                // è°ƒè¯•ä¿¡æ¯
                console.log('LLMå›ç­”:', content.substring(0, 100));
                console.log('å›¾ç‰‡æºæ•°é‡:', imageSources.length);
                console.log('æœ€ç»ˆæ˜¾ç¤ºå›¾ç‰‡æ•°é‡:', deduplicatedImages.length);
                
                // å¤„ç†å›¾ç‰‡å¹¶æ·»åŠ åˆ°å†…å®¹ä¸­
                const imageComponents = [];
                
                deduplicatedImages.forEach((source, index) => {
                    const metadata = source.metadata;
                    const imageId = metadata.image_id;
                    
                    // æ„å»ºå›¾ç‰‡URL
                    const imageUrl = buildImageUrl(metadata.image_path);
                    
                    // æå–å›¾ç‰‡ä¿¡æ¯
                    const captionText = (metadata.img_caption || []).join(' ');
                    const footnoteText = (metadata.img_footnote || []).join(' ');
                    const chartType = metadata.chart_type || 'ä¿¡æ¯å›¾è¡¨';
                    const documentName = metadata.document_name || 'æœªçŸ¥æ–‡æ¡£';
                    const pageNumber = metadata.page_number || 1;
                    
                    // åˆ›å»ºå›¾ç‰‡ç»„ä»¶
                    const imageComponent = createImageComponent({
                        url: imageUrl,
                        caption: captionText,
                        footnote: footnoteText,
                        type: chartType,
                        document: documentName,
                        page: pageNumber,
                        index: index + 1
                    });
                    
                    imageComponents.push(imageComponent);
                });
                
                // å°†å›¾ç‰‡ç»„ä»¶æ·»åŠ åˆ°å†…å®¹æœ«å°¾
                if (imageComponents.length > 0) {
                    processedContent += '\n\n' + imageComponents.join('\n\n');
                }
            }
        }
                
                // ä½¿ç”¨Marked.jsæ¸²æŸ“Markdown
                contentDiv.innerHTML = marked.parse(processedContent);
            }
            
            messageDiv.appendChild(header);
            messageDiv.appendChild(contentDiv);
            
            // å¦‚æœæœ‰å…ƒæ•°æ®ï¼Œæ·»åŠ æˆæœ¬ä¿¡æ¯å’Œæ¥æºè¯¦æƒ…
            if (metadata && !isError) {
                const costInfo = document.createElement('div');
                costInfo.className = 'cost-info';
                
                // æ„å»ºæ¥æºè¯¦æƒ…
                let sourcesDetail = '';
                if (metadata.sources && metadata.sources.length > 0) {
                    sourcesDetail = '<div class="sources-detail">';
                    sourcesDetail += '<strong>æ¥æºè¯¦æƒ…:</strong><br>';
                    metadata.sources.forEach((source, index) => {
                        const sourceMetadata = source.metadata || {};
                        let docName = sourceMetadata.document_name || 'æœªçŸ¥æ–‡æ¡£';
                        let pageNumber = sourceMetadata.page_number || 'æœªçŸ¥é¡µç ';
                        const chunkType = sourceMetadata.chunk_type || 'text';
                        
                        // å¯¹äºå›¾ç‰‡ç±»å‹ï¼Œæ˜¾ç¤ºå›¾ç‰‡æ ‡é¢˜å’Œè„šæ³¨ä¿¡æ¯
                        if (chunkType === 'image') {
                            const imgCaption = sourceMetadata.img_caption || [];
                            const imgFootnote = sourceMetadata.img_footnote || [];
                            
                            // æ„å»ºå›¾ç‰‡æè¿°
                            let imageDescription = '';
                            if (imgCaption.length > 0) {
                                imageDescription = imgCaption.join(' ');
                            } else if (imgFootnote.length > 0) {
                                imageDescription = imgFootnote.join(' ');
                            } else {
                                imageDescription = 'å›¾ç‰‡';
                            }
                            
                            // å¦‚æœmetadataä¸­æ²¡æœ‰æ–‡æ¡£åç§°ï¼Œå°è¯•ä»å›¾ç‰‡è·¯å¾„æ¨æ–­
                            if (!sourceMetadata.document_name && sourceMetadata.image_path) {
                                const imagePath = sourceMetadata.image_path;
                                // å°è¯•ä»å›¾ç‰‡è·¯å¾„ä¸­æå–æ–‡æ¡£ä¿¡æ¯
                                if (imagePath.includes('md_test\\images\\')) {
                                    // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´æ™ºèƒ½çš„æ–‡æ¡£åç§°æå–é€»è¾‘
                                    // æš‚æ—¶ä½¿ç”¨é»˜è®¤å€¼
                                    if (!docName || docName === 'æœªçŸ¥æ–‡æ¡£') {
                                        docName = 'æ–‡æ¡£å›¾ç‰‡';
                                    }
                                }
                            }
                            
                            // å¦‚æœmetadataä¸­æ²¡æœ‰é¡µç ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å€¼
                            if (!sourceMetadata.page_number) {
                                pageNumber = 'å›¾ç‰‡';
                            }
                            
                            // æ›´æ–°æè¿°ä¸ºå›¾ç‰‡æ ‡é¢˜
                            docName = `${docName} - ${imageDescription}`;
                        }
                        
                        sourcesDetail += `${index + 1}. ${docName} (ç¬¬${pageNumber}é¡µ, ${chunkType})<br>`;
                    });
                    sourcesDetail += '</div>';
                }
                
                costInfo.innerHTML = `
                    <div class="cost-info-row">
                        <div class="cost-info-item">
                            <strong>æˆæœ¬:</strong> 
                            <span>${metadata.cost ? metadata.cost.toFixed(6) + ' å…ƒ' : 'N/A'}</span>
                        </div>
                        <div class="cost-info-item">
                            <strong>æ¥æºæ•°é‡:</strong> 
                            <span>${metadata.sources ? metadata.sources.length : 0}</span>
                        </div>
                        <div class="cost-info-item">
                            <strong>æ—¶é—´:</strong> 
                            <span>${metadata.timestamp ? new Date(metadata.timestamp).toLocaleTimeString() : 'N/A'}</span>
                        </div>
                        <div class="cost-info-item">
                            <strong>ç”¨æˆ·ID:</strong> 
                            <span>${currentUserId}</span>
                        </div>
                    </div>
                    ${sourcesDetail}
                `;
                messageDiv.appendChild(costInfo);
            }
            
            chatMessages.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æ¸…é™¤ä¼šè¯è®°å¿†
        async function clearSessionMemory() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤å½“å‰ä¼šè¯çš„è®°å¿†å—ï¼Ÿ')) {
                try {
                    const response = await fetch(`${API_BASE}/memory/clear`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: currentUserId,
                            memory_type: 'session'
                        })
                    });
                    
                    if (response.ok) {
                        alert('ä¼šè¯è®°å¿†å·²æ¸…é™¤');
                        await loadMemoryStats();
                    } else {
                        throw new Error('æ¸…é™¤å¤±è´¥');
                    }
                } catch (error) {
                    console.error('æ¸…é™¤ä¼šè¯è®°å¿†å¤±è´¥:', error);
                    alert('æ¸…é™¤ä¼šè¯è®°å¿†å¤±è´¥');
                }
            }
        }

        // æ¸…é™¤æ‰€æœ‰è®°å¿†
        async function clearAllMemory() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è®°å¿†å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰ç”¨æˆ·çš„ä¼šè¯è®°å¿†å’Œå†å²è®°å¿†ï¼')) {
                try {
                    const response = await fetch(`${API_BASE}/memory/clear`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: null,  // ä¼ å…¥nullæ¸…é™¤æ‰€æœ‰ç”¨æˆ·çš„è®°å¿†
                            memory_type: 'all'
                        })
                    });
                    
                    if (response.ok) {
                        alert('æ‰€æœ‰è®°å¿†å·²æ¸…é™¤');
                        await loadMemoryStats();
                    } else {
                        throw new Error('æ¸…é™¤å¤±è´¥');
                    }
                } catch (error) {
                    console.error('æ¸…é™¤æ‰€æœ‰è®°å¿†å¤±è´¥:', error);
                    alert('æ¸…é™¤æ‰€æœ‰è®°å¿†å¤±è´¥');
                }
            }
        }

        // æ„å»ºå›¾ç‰‡URLçš„è¾…åŠ©å‡½æ•°
        function buildImageUrl(imagePath) {
            if (!imagePath) return '';
            
            let imageUrl = imagePath;
            
            // å¤„ç†ç›¸å¯¹è·¯å¾„
            if (imagePath.startsWith('./') || imagePath.startsWith('md_test/')) {
                imageUrl = imagePath.replace('./', '/').replace('md_test/', '/md_test/');
                if (!imageUrl.startsWith('/')) {
                    imageUrl = '/' + imageUrl;
                }
            } 
            // å¤„ç†åŒ…å«images/çš„è·¯å¾„
            else if (imagePath.includes('images/')) {
                imageUrl = '/md_test/images/' + imagePath.split('/').pop();
            } 
            // å¤„ç†Windowsè·¯å¾„åˆ†éš”ç¬¦
            else if (imagePath.includes('\\')) {
                const pathParts = imagePath.split('\\');
                const imageFileName = pathParts[pathParts.length - 1];
                imageUrl = '/md_test/images/' + imageFileName;
            }
            
            return imageUrl;
        }

        // åˆ›å»ºå›¾ç‰‡ç»„ä»¶çš„è¾…åŠ©å‡½æ•°
        function createImageComponent(imageData) {
            const { url, caption, footnote, type, document, page, index } = imageData;
            
            // æ„å»ºå›¾ç‰‡ä¿¡æ¯
            let imageInfo = '';
            
            // æ·»åŠ å›¾è¡¨ç±»å‹ï¼ˆå¦‚æœæœ‰ï¼‰
            if (type && type !== 'ä¿¡æ¯å›¾è¡¨') {
                imageInfo += `**å›¾è¡¨ç±»å‹**: ${type}\n\n`;
            }
            
            // æ·»åŠ å›¾ç‰‡æ ‡é¢˜
            if (caption) {
                imageInfo += `**å›¾ç‰‡æ ‡é¢˜**: ${caption}\n\n`;
            }
            
            // æ·»åŠ å›¾ç‰‡
            imageInfo += `![å›¾ç‰‡${index}](${url})\n\n`;
            
            // æ·»åŠ æ¥æºä¿¡æ¯
            if (document && page) {
                imageInfo += `**æ¥æº**: ${document} (ç¬¬${page}é¡µ)\n\n`;
            }
            
            // æ·»åŠ å›¾ç‰‡è„šæ³¨ï¼ˆå¦‚æœæœ‰ï¼‰
            if (footnote) {
                imageInfo += `**å›¾ç‰‡è„šæ³¨**: ${footnote}\n\n`;
            }
            
            return imageInfo;
        }

        // æ™ºèƒ½æ˜¾ç¤ºé€»è¾‘è¾…åŠ©å‡½æ•°
        
        /**
         * ä»LLMå›ç­”ä¸­è§£æå›¾ç‰‡ID
         * @param {string} answer - LLMçš„å›ç­”å†…å®¹
         * @returns {Set} å›¾ç‰‡IDé›†åˆ
         */
        function parseImageIdsFromAnswer(answer) {
            const imageIds = new Set();
            // æ”¯æŒä¸¤ç§æ ¼å¼ï¼šIMAGE_IDå’ŒDISPLAY_IMAGE
            const imageIdPatterns = [
                /\[IMAGE_ID:([^\]]+)\]/g,
                /\[DISPLAY_IMAGE:([^\]]+)\]/g
            ];
            
            imageIdPatterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(answer)) !== null) {
                    imageIds.add(match[1]);
                }
            });
            
            return imageIds;
        }
        
        /**
         * ä»LLMå›ç­”ä¸­è§£æå›¾ç‰‡æ ‡é¢˜
         * @param {string} answer - LLMçš„å›ç­”å†…å®¹
         * @returns {Set} å›¾ç‰‡æ ‡é¢˜é›†åˆ
         */
        function parseImageTitlesFromAnswer(answer) {
            const imageTitles = new Set();
            const titlePatterns = [
                /å›¾ç‰‡æ ‡é¢˜[ï¼š:]\s*([^\n]+)/g,
                /å›¾è¡¨æ ‡é¢˜[ï¼š:]\s*([^\n]+)/g,
                /æ ‡é¢˜[ï¼š:]\s*([^\n]+)/g
            ];
            
            titlePatterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(answer)) !== null) {
                    imageTitles.add(match[1].trim());
                }
            });
            
            return imageTitles;
        }
        
        /**
         * ä»LLMå›ç­”ä¸­è§£æå›¾è¡¨ç¼–å·å¼•ç”¨
         * @param {string} answer - LLMçš„å›ç­”å†…å®¹
         * @returns {Set} å›¾è¡¨ç¼–å·é›†åˆ
         */
        function parseChartNumbersFromAnswer(answer) {
            const chartNumbers = new Set();
            const chartPatterns = [
                /å›¾(\d+)/g,
                /å›¾è¡¨(\d+)/g,
                /å›¾è¡¨ç¼–å·[ï¼š:]\s*å›¾(\d+)/g,
                /å›¾è¡¨ç¼–å·[ï¼š:]\s*(\d+)/g
            ];
            
            chartPatterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(answer)) !== null) {
                    chartNumbers.add(match[1]);
                }
            });
            
            return chartNumbers;
        }
        
        /**
         * è§£æç”¨æˆ·æ˜ç¡®è¦æ±‚çš„å›¾ç‰‡æ˜¾ç¤ºè¯·æ±‚
         * @param {string} userQuestion - ç”¨æˆ·é—®é¢˜
         * @returns {Array} ç”¨æˆ·è¦æ±‚çš„å›¾ç‰‡æ ‡è¯†åˆ—è¡¨
         */
        function parseUserImageRequests(userQuestion) {
            const requests = [];
            const question = userQuestion.toLowerCase();
            
            console.log('è§£æç”¨æˆ·å›¾ç‰‡è¯·æ±‚:', userQuestion);
            console.log('è½¬æ¢ä¸ºå°å†™:', question);
            
            // æ¨¡ç³ŠåŒ¹é…æ¨¡å¼1ï¼šæå–å›¾è¡¨ç¼–å·
            const chartNumberPatterns = [
                /å›¾(\d+)/g,
                /å›¾è¡¨(\d+)/g,
                /å›¾ç‰‡(\d+)/g
            ];
            
            chartNumberPatterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(question)) !== null) {
                    console.log('æ¨¡ç³ŠåŒ¹é…åˆ°å›¾è¡¨ç¼–å·:', match[1]);
                    requests.push({
                        type: 'chart_number',
                        value: match[1],
                        pattern: match[0]
                    });
                }
            });
            
            // æ¨¡ç³ŠåŒ¹é…æ¨¡å¼2ï¼šæå–å†…å®¹å…³é”®è¯
            const keywords = [
                'è¥æ”¶', 'æ”¶å…¥', 'è¥ä¸šæ”¶å…¥',
                'å‡€åˆ©æ¶¦', 'åˆ©æ¶¦', 'å½’æ¯å‡€åˆ©æ¶¦',
                'æ¯›åˆ©ç‡', 'å‡€åˆ©ç‡', 'åˆ©æ¶¦ç‡',
                'è´¢åŠ¡', 'è´¢åŠ¡æ•°æ®',
                'è¶‹åŠ¿', 'å¢é€Ÿ', 'å¢é•¿',
                'ç»“æ„', 'æ„æˆ', 'åˆ†å¸ƒ',
                'å¯¹æ¯”', 'æ¯”è¾ƒ', 'ç›¸å¯¹',
                'ä¸ªè‚¡', 'è‚¡ç¥¨', 'è‚¡ä»·'
            ];
            
            keywords.forEach(keyword => {
                if (question.includes(keyword)) {
                    console.log('æ¨¡ç³ŠåŒ¹é…åˆ°å…³é”®è¯:', keyword);
                    requests.push({
                        type: 'content_keyword',
                        value: keyword,
                        pattern: keyword
                    });
                }
            });
            
            // æ¨¡ç³ŠåŒ¹é…æ¨¡å¼3ï¼šæ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡çš„æ„å›¾
            const allImageKeywords = ['æ‰€æœ‰å›¾ç‰‡', 'æ‰€æœ‰å›¾è¡¨', 'å…¨éƒ¨å›¾ç‰‡', 'å…¨éƒ¨å›¾è¡¨', 'æ˜¾ç¤ºæ‰€æœ‰', 'æŠŠæ‰€æœ‰'];
            const hasAllImageIntent = allImageKeywords.some(keyword => question.includes(keyword));
            
            if (hasAllImageIntent) {
                console.log('æ¨¡ç³ŠåŒ¹é…åˆ°æ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡æ„å›¾');
                requests.push({
                    type: 'all_images',
                    value: 'all',
                    pattern: 'all'
                });
            }
            
            console.log('æœ€ç»ˆè§£æç»“æœ:', requests);
            return requests;
        }
        
        /**
         * æ ¹æ®ç”¨æˆ·è¯·æ±‚æŸ¥æ‰¾å¯¹åº”çš„å›¾ç‰‡
         * @param {Array} userRequests - ç”¨æˆ·è¯·æ±‚åˆ—è¡¨
         * @param {Array} imageSources - å›¾ç‰‡æºæ•°æ®
         * @returns {Array} åŒ¹é…çš„å›¾ç‰‡åˆ—è¡¨
         */
        function findRequestedImages(userRequests, imageSources) {
            const matchedImages = new Set(); // ä½¿ç”¨Seté¿å…é‡å¤
            const matchedImageIds = new Set(); // è·Ÿè¸ªå·²åŒ¹é…çš„å›¾ç‰‡ID
            
            console.log('å¼€å§‹æŸ¥æ‰¾åŒ¹é…çš„å›¾ç‰‡ï¼Œç”¨æˆ·è¯·æ±‚:', userRequests);
            console.log('å¯ç”¨å›¾ç‰‡æºæ•°é‡:', imageSources.length);
            
            userRequests.forEach(request => {
                console.log('å¤„ç†è¯·æ±‚ç±»å‹:', request.type, 'å€¼:', request.value);
                
                switch (request.type) {
                    case 'chart_number':
                        // æŸ¥æ‰¾ç‰¹å®šç¼–å·çš„å›¾ç‰‡
                        imageSources.forEach(source => {
                            const captionText = (source.metadata.img_caption || []).join(' ');
                            console.log('æ£€æŸ¥å›¾ç‰‡æ ‡é¢˜:', captionText, 'æ˜¯å¦åŒ…å«å›¾', request.value);
                            
                            if (captionText.includes(`å›¾${request.value}`) || 
                                captionText.includes(`å›¾è¡¨${request.value}`)) {
                                console.log('æ‰¾åˆ°åŒ¹é…çš„å›¾ç‰‡:', captionText);
                                if (!matchedImageIds.has(source.metadata.image_id)) {
                                    matchedImages.add(source);
                                    matchedImageIds.add(source.metadata.image_id);
                                }
                            }
                        });
                        break;
                        
                    case 'content_keyword':
                        // æ ¹æ®å†…å®¹å…³é”®è¯æŸ¥æ‰¾å›¾ç‰‡
                        const keyword = request.value;
                        imageSources.forEach(source => {
                            const captionText = (source.metadata.img_caption || []).join(' ');
                            const enhancedDescription = (source.metadata.enhanced_description || '');
                            
                            console.log('æ£€æŸ¥å…³é”®è¯:', keyword, 'åœ¨æ ‡é¢˜:', captionText);
                            
                            // æ‰©å±•åŒ¹é…é€»è¾‘ï¼šæ£€æŸ¥æ ‡é¢˜ã€æè¿°ã€ä»¥åŠè¯­ä¹‰ç›¸å…³æ€§
                            let isMatch = false;
                            
                            // ç›´æ¥å…³é”®è¯åŒ¹é…
                            if (captionText.includes(keyword) || 
                                enhancedDescription.includes(keyword)) {
                                isMatch = true;
                            }
                            
                            // è¯­ä¹‰ç›¸å…³æ€§åŒ¹é…ï¼ˆé’ˆå¯¹è´¢åŠ¡æ•°æ®ï¼‰
                            if (keyword === 'è´¢åŠ¡' || keyword === 'è´¢åŠ¡æ•°æ®') {
                                const financialKeywords = ['è¥æ”¶', 'æ”¶å…¥', 'å‡€åˆ©æ¶¦', 'åˆ©æ¶¦', 'æ¯›åˆ©ç‡', 'å‡€åˆ©ç‡'];
                                if (financialKeywords.some(fk => captionText.includes(fk))) {
                                    isMatch = true;
                                }
                            }
                            
                            // è¯­ä¹‰ç›¸å…³æ€§åŒ¹é…ï¼ˆé’ˆå¯¹è¶‹åŠ¿æ•°æ®ï¼‰
                            if (keyword === 'è¶‹åŠ¿' || keyword === 'å¢é€Ÿ') {
                                const trendKeywords = ['å¢é€Ÿ', 'å¢é•¿', 'è¶‹åŠ¿', 'å˜åŒ–'];
                                if (trendKeywords.some(tk => captionText.includes(tk))) {
                                    isMatch = true;
                                }
                            }
                            
                            if (isMatch && !matchedImageIds.has(source.metadata.image_id)) {
                                console.log('æ‰¾åˆ°åŒ¹é…çš„å›¾ç‰‡:', captionText);
                                matchedImages.add(source);
                                matchedImageIds.add(source.metadata.image_id);
                            }
                        });
                        break;
                        
                    case 'all_images':
                        // è¿”å›æ‰€æœ‰å›¾ç‰‡
                        console.log('è¿”å›æ‰€æœ‰å›¾ç‰‡');
                        imageSources.forEach(source => {
                            if (!matchedImageIds.has(source.metadata.image_id)) {
                                matchedImages.add(source);
                                matchedImageIds.add(source.metadata.image_id);
                            }
                        });
                        break;
                }
            });
            
            const result = Array.from(matchedImages);
            console.log('æœ€ç»ˆåŒ¹é…åˆ°çš„å›¾ç‰‡æ•°é‡:', result.length);
            return result;
        }
        
        /**
         * ç®€åŒ–ç‰ˆå›¾ç‰‡è¿‡æ»¤ï¼šæ ¹æ®é—®é¢˜å†…å®¹æ™ºèƒ½æ˜¾ç¤ºç›¸å…³å›¾ç‰‡
         * @param {string} answer - LLMçš„å›ç­”å†…å®¹
         * @param {Array} imageSources - å›¾ç‰‡æºæ•°æ®
         * @returns {Array} è¿‡æ»¤åçš„å›¾ç‰‡æºæ•°æ®
         */
        function filterRelevantImages(answer, imageSources) {
            console.log('å¼€å§‹æ™ºèƒ½è¿‡æ»¤å›¾ç‰‡ï¼ŒLLMå›ç­”:', answer.substring(0, 100));
            
            // ç­–ç•¥1ï¼šå¦‚æœLLMæ˜ç¡®è¡¨ç¤º"æ²¡æœ‰æ‰¾åˆ°"ï¼Œè¿”å›ç©ºæ•°ç»„
            const noInfoFound = answer.includes('æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ä¿¡æ¯') || 
                              answer.includes('æ²¡æœ‰æ‰¾åˆ°') || 
                              answer.includes('æœªæ‰¾åˆ°') ||
                              answer.includes('æŠ±æ­‰ï¼Œæ²¡æœ‰æ‰¾åˆ°') ||
                              answer.includes('æ²¡æœ‰ç›´æ¥æè¿°') ||
                              answer.includes('æœªæåŠ');
            
            if (noInfoFound) {
                console.log('LLMè¡¨ç¤ºæ²¡æœ‰æ‰¾åˆ°ç›¸å…³ä¿¡æ¯ï¼Œä¸æ˜¾ç¤ºå›¾ç‰‡');
                return [];
            }
            
            // ç­–ç•¥2ï¼šå¦‚æœLLMå›ç­”åŒ…å«å›¾ç‰‡ç›¸å…³å…³é”®è¯ï¼Œæ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡
            const imageKeywords = /å›¾ç‰‡|å›¾è¡¨|å›¾|image|chart|è´¢åŠ¡æ•°æ®|è¥æ”¶|å‡€åˆ©æ¶¦|æ¯›åˆ©ç‡|å‡€åˆ©ç‡/;
            if (imageKeywords.test(answer.toLowerCase())) {
                console.log('LLMå›ç­”åŒ…å«å›¾ç‰‡å…³é”®è¯ï¼Œæ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡');
                return imageSources;
            }
            
            // ç­–ç•¥2.5ï¼šå¦‚æœLLMå›ç­”æåˆ°äº†å›¾è¡¨å†…å®¹ï¼Œæ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡
            const hasChartContent = /å›¾\d+|å›¾è¡¨|å›¾ç‰‡|è¥æ”¶|å‡€åˆ©æ¶¦|æ¯›åˆ©ç‡|å‡€åˆ©ç‡|æ”¶å…¥|åˆ©æ¶¦|è¥ä¸šæ”¶å…¥|å‡€åˆ©æ¶¦|æ¯›åˆ©ç‡|å‡€åˆ©ç‡/.test(answer.toLowerCase());
            
            if (hasChartContent) {
                console.log('LLMå›ç­”åŒ…å«å›¾è¡¨å†…å®¹ï¼Œæ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡');
                return imageSources;
            }
            
            // ç­–ç•¥3ï¼šåŸºäºmetadataåˆ†ç±»ä¿¡æ¯è¿›è¡Œæ™ºèƒ½åŒ¹é…
            const metadataFiltered = filterByMetadata(answer, imageSources);
            console.log('åŸºäºmetadataè¿‡æ»¤åçš„å›¾ç‰‡æ•°é‡:', metadataFiltered.length);
            return metadataFiltered;
        }
        
        /**
         * åŸºäºmetadataåˆ†ç±»ä¿¡æ¯è¿›è¡Œæ™ºèƒ½è¿‡æ»¤
         * @param {string} answer - LLMçš„å›ç­”å†…å®¹
         * @param {Array} imageSources - å›¾ç‰‡æºæ•°æ®
         * @returns {Array} è¿‡æ»¤åçš„å›¾ç‰‡æºæ•°æ®
         */
        function filterByMetadata(answer, imageSources) {
            const matchedImages = [];
            
            console.log('å¼€å§‹åŸºäºmetadataè¿‡æ»¤ï¼ŒLLMå›ç­”:', answer.substring(0, 100));
            
            // å®šä¹‰åˆ†ç±»å…³é”®è¯æ˜ å°„
            const categoryKeywords = {
                'è´¢åŠ¡': ['è¥æ”¶', 'æ”¶å…¥', 'å‡€åˆ©æ¶¦', 'åˆ©æ¶¦', 'æ¯›åˆ©ç‡', 'å‡€åˆ©ç‡', 'è´¢åŠ¡', 'è´¢åŠ¡æ•°æ®', 'è´¢åŠ¡æŒ‡æ ‡'],
                'è¶‹åŠ¿': ['è¶‹åŠ¿', 'å˜åŒ–', 'å¢é•¿', 'å¢é€Ÿ', 'å¢é•¿ç‡', 'åŒæ¯”', 'ç¯æ¯”', 'è¶‹åŠ¿å›¾'],
                'ç»“æ„': ['ç»“æ„', 'åˆ†å¸ƒ', 'å æ¯”', 'æ¯”ä¾‹', 'æ„æˆ', 'ç»“æ„å›¾', 'é¥¼å›¾'],
                'å¯¹æ¯”': ['å¯¹æ¯”', 'æ¯”è¾ƒ', 'ç›¸å¯¹', 'æŒ‡æ•°', 'è¡¨ç°', 'å¯¹æ¯”å›¾'],
                'å­£åº¦': ['å­£åº¦', 'å•å­£åº¦', 'Q1', 'Q2', 'Q3', 'Q4', 'å­£åº¦æ•°æ®'],
                'å¹´åº¦': ['å¹´åº¦', 'å…¨å¹´', 'å¹´åº¦æ•°æ®', 'å¹´åº¦æŠ¥å‘Š']
            };
            
            // æ£€æŸ¥LLMå›ç­”ä¸­æ˜¯å¦åŒ…å«åˆ†ç±»å…³é”®è¯
            const detectedCategories = [];
            for (const [category, keywords] of Object.entries(categoryKeywords)) {
                if (keywords.some(keyword => answer.includes(keyword))) {
                    detectedCategories.push(category);
                    console.log('æ£€æµ‹åˆ°åˆ†ç±»:', category);
                }
            }
            
            // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°åˆ†ç±»ï¼Œä½†LLMå›ç­”æåˆ°äº†å›¾è¡¨ç›¸å…³å†…å®¹ï¼Œæ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡
            if (detectedCategories.length === 0) {
                const chartRelatedPatterns = [
                    /å›¾\d+/, /å›¾è¡¨\d+/, /å›¾ç‰‡\d+/,
                    /è¥æ”¶/, /å‡€åˆ©æ¶¦/, /æ¯›åˆ©ç‡/, /å‡€åˆ©ç‡/,
                    /è´¢åŠ¡/, /è¶‹åŠ¿/, /å¢é•¿/, /å¢é€Ÿ/
                ];
                
                const hasChartContent = chartRelatedPatterns.some(pattern => pattern.test(answer));
                if (hasChartContent) {
                    console.log('LLMå›ç­”åŒ…å«å›¾è¡¨ç›¸å…³å†…å®¹ï¼Œæ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡');
                    return imageSources;
                }
                
                console.log('æ²¡æœ‰æ£€æµ‹åˆ°åˆ†ç±»ä¸”æ— å›¾è¡¨å†…å®¹ï¼Œä¸æ˜¾ç¤ºå›¾ç‰‡');
                return [];
            }
            
            console.log('æ£€æµ‹åˆ°çš„åˆ†ç±»:', detectedCategories);
            
            // æ ¹æ®æ£€æµ‹åˆ°çš„åˆ†ç±»è¿‡æ»¤å›¾ç‰‡
            imageSources.forEach(source => {
                const metadata = source.metadata;
                const captionText = (metadata.img_caption || []).join(' ').toLowerCase();
                const footnoteText = (metadata.img_footnote || []).join(' ').toLowerCase();
                const enhancedDescription = (metadata.enhanced_description || '').toLowerCase();
                
                // æ£€æŸ¥å›¾ç‰‡å†…å®¹æ˜¯å¦åŒ¹é…æ£€æµ‹åˆ°çš„åˆ†ç±»
                for (const category of detectedCategories) {
                    const keywords = categoryKeywords[category];
                    const hasMatch = keywords.some(keyword => 
                        captionText.includes(keyword.toLowerCase()) ||
                        footnoteText.includes(keyword.toLowerCase()) ||
                        enhancedDescription.includes(keyword.toLowerCase())
                    );
                    
                    if (hasMatch) {
                        console.log('å›¾ç‰‡åŒ¹é…åˆ†ç±»:', category, 'æ ‡é¢˜:', captionText);
                        matchedImages.push(source);
                        break; // æ‰¾åˆ°ä¸€ä¸ªåŒ¹é…å°±è¶³å¤Ÿäº†
                    }
                }
            });
            
            console.log('åŸºäºmetadataè¿‡æ»¤åçš„å›¾ç‰‡æ•°é‡:', matchedImages.length);
            return matchedImages;
        }
        
        /**
         * å›¾ç‰‡å»é‡æœºåˆ¶
         * @param {Array} imageSources - å›¾ç‰‡æºæ•°æ®
         * @returns {Array} å»é‡åçš„å›¾ç‰‡æºæ•°æ®
         */
        function deduplicateImages(imageSources) {
            const seenIds = new Set();
            const seenTitles = new Set();
            const deduplicated = [];
            
            console.log('å¼€å§‹å»é‡ï¼Œè¾“å…¥å›¾ç‰‡æ•°é‡:', imageSources.length);
            
            imageSources.forEach(source => {
                const metadata = source.metadata;
                const imageId = metadata.image_id || metadata.image_path.split('/').pop().split('.')[0];
                const captionText = (metadata.img_caption || []).join(' ');
                const footnoteText = (metadata.img_footnote || []).join(' ');
                const titleText = captionText || footnoteText;
                
                // æ£€æŸ¥æ˜¯å¦é‡å¤ï¼šåŸºäºå›¾ç‰‡IDå’Œæ ‡é¢˜ï¼ˆä»…åœ¨åŒä¸€æ‰¹æ¬¡å†…å»é‡ï¼‰
                const isDuplicate = seenIds.has(imageId) || 
                                  (titleText && seenTitles.has(titleText));
                
                if (!isDuplicate) {
                    seenIds.add(imageId);
                    if (titleText) {
                        seenTitles.add(titleText);
                    }
                    deduplicated.push(source);
                    console.log('æ·»åŠ å›¾ç‰‡:', titleText);
                } else {
                    console.log('è·³è¿‡é‡å¤å›¾ç‰‡:', titleText);
                }
            });
            
            console.log('å»é‡åå›¾ç‰‡æ•°é‡:', deduplicated.length);
            return deduplicated;
        }
    </script>
</body>
</html> 