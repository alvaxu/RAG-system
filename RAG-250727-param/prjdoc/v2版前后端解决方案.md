å¥½çš„ï¼æˆ‘æ¥åœ¨V2ç³»ç»ŸèŒƒå›´å†…è§£å†³è¿™äº›é—®é¢˜ã€‚è®©æˆ‘å…ˆåˆ†æä¸€ä¸‹å½“å‰çš„æƒ…å†µï¼Œç„¶åé€ä¸€ä¿®å¤ï¼š

## ğŸ” **é—®é¢˜åˆ†æ**

1. **ç­”æ¡ˆç”Ÿæˆé—®é¢˜**ï¼šLLMç”Ÿæˆçš„ç­”æ¡ˆæ²¡æœ‰åœ¨ç•Œé¢ä¸Šæ˜¾ç¤º
2. **è®°å¿†åŠŸèƒ½é—®é¢˜**ï¼šå‰ç«¯UIçš„è®°å¿†æ•°é‡æ²¡æœ‰å®æ—¶æ›´æ–°
3. **æ¥æºè¯¦æƒ…é—®é¢˜**ï¼šç¼ºå°‘å®Œæ•´çš„æ¥æºä¿¡æ¯æ˜¾ç¤º
4. **ç•Œé¢æ··ä¹±é—®é¢˜**ï¼šéœ€è¦æ¸…ç†ä¸éœ€è¦çš„çŠ¶æ€æŒ‡ç¤ºå™¨

## ğŸ”§ **è§£å†³æ–¹æ¡ˆ**

### **ç¬¬ä¸€æ­¥ï¼šä¿®å¤å‰ç«¯ç•Œé¢ï¼Œåˆ é™¤ä¸éœ€è¦çš„çŠ¶æ€æŒ‡ç¤ºå™¨**

```html:v2/web/v2_index.html
<!-- åˆ é™¤è¿™ä¸‰ä¸ªåŒºåŸŸï¼Œåªä¿ç•™è®°å¿†ç®¡ç† -->
<!-- 
<div class="optimization-section">
    <h3>ï¿½ï¿½ ä¼˜åŒ–åŠŸèƒ½</h3>
    <div class="optimization-toggle">
        <label for="optimize-query">å¯ç”¨ä¼˜åŒ–æŸ¥è¯¢</label>
        <input type="checkbox" id="optimize-query" onclick="toggleOptimization('optimize-query')">
    </div>
    <div class="optimization-status" id="optimize-status">ä¼˜åŒ–æŸ¥è¯¢å·²ç¦ç”¨</div>
</div>

<div class="optimization-section">
    <h3>ğŸ› ï¸ å¼•æ“çŠ¶æ€</h3>
    <div class="optimization-status" id="engine-status">åŠ è½½ä¸­...</div>
</div>

<div class="optimization-section">
    <h3>âš™ï¸ é…ç½®ç®¡ç†</h3>
    <div class="optimization-status" id="config-status">åŠ è½½ä¸­...</div>
</div>
-->
```

### **ç¬¬äºŒæ­¥ï¼šä¿®å¤ç­”æ¡ˆç”Ÿæˆæ˜¾ç¤ºé—®é¢˜**

```javascript:v2/web/v2_index.html
// ä¿®å¤å‘é€æ¶ˆæ¯å‡½æ•°ï¼Œç¡®ä¿æ˜¾ç¤ºLLMç”Ÿæˆçš„ç­”æ¡ˆ
async function sendMessage() {
    if (isProcessing) return;
    
    const input = document.getElementById('user-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
    addMessage(message, 'user');
    input.value = '';
    
    // è®¾ç½®å¤„ç†çŠ¶æ€
    setProcessingState(true);
    
    try {
        // ç›´æ¥ä½¿ç”¨ä¼˜åŒ–æŸ¥è¯¢APIï¼Œç¡®ä¿å¯ç”¨æ‰€æœ‰ä¼˜åŒ–åŠŸèƒ½
        const response = await fetch('/api/v2/query/optimized', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                query: message,
                max_results: 20,
                user_id: currentSessionId,
                enable_reranking: true,
                enable_llm_generation: true,
                enable_smart_filtering: true,
                enable_source_filtering: true
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // æ„å»ºå®Œæ•´çš„ç­”æ¡ˆå†…å®¹
        let answer = '';
        
        // 1. æ˜¾ç¤ºLLMç”Ÿæˆçš„ç­”æ¡ˆ
        if (data.optimization_details && data.optimization_details.llm_answer) {
            answer += `ï¿½ï¿½ **AIç”Ÿæˆçš„ç­”æ¡ˆï¼š**\n\n${data.optimization_details.llm_answer}\n\n`;
        }
        
        // 2. æ˜¾ç¤ºæ£€ç´¢ç»“æœæ‘˜è¦
        if (data.results && data.results.length > 0) {
            answer += `ğŸ“Š **æ£€ç´¢ç»“æœæ‘˜è¦ï¼š**\n`;
            answer += `å…±æ‰¾åˆ° ${data.results.length} æ¡ç›¸å…³å†…å®¹\n\n`;
            
            // æ˜¾ç¤ºå‰3æ¡ç»“æœçš„ç®€è¦ä¿¡æ¯
            data.results.slice(0, 3).forEach((result, index) => {
                const content = result.content || result;
                const truncated = content.length > 100 ? content.substring(0, 100) + '...' : content;
                answer += `${index + 1}. ${truncated}\n\n`;
            });
            
            if (data.results.length > 3) {
                answer += `... è¿˜æœ‰ ${data.results.length - 3} æ¡ç»“æœ\n\n`;
            }
        }
        
        // 3. æ˜¾ç¤ºå¤„ç†æ—¶é—´
        if (data.processing_time) {
            answer += `â±ï¸ **å¤„ç†æ—¶é—´ï¼š** ${data.processing_time.toFixed(2)}ç§’`;
        }
        
        // å¦‚æœæ²¡æœ‰LLMç­”æ¡ˆï¼Œä½¿ç”¨é»˜è®¤ç­”æ¡ˆ
        if (!answer.trim()) {
            answer = data.answer || 'æŠ±æ­‰ï¼Œæˆ‘æ— æ³•ç†è§£æ‚¨çš„é—®é¢˜ã€‚';
        }
        
        // æ·»åŠ åŠ©æ‰‹å›å¤ï¼ŒåŒ…å«æ¥æºè¯¦æƒ…
        addMessage(answer, 'assistant', data);
        
        // é‡æ–°åŠ è½½è®°å¿†ç»Ÿè®¡
        await loadMemoryStats();
        
    } catch (error) {
        console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
        addMessage('æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„é—®é¢˜æ—¶å‡ºç°äº†é”™è¯¯ã€‚è¯·ç¨åé‡è¯•ã€‚', 'assistant');
        showStatus('å‘é€æ¶ˆæ¯å¤±è´¥', 'error');
    } finally {
        setProcessingState(false);
    }
}
```

### **ç¬¬ä¸‰æ­¥ï¼šä¿®å¤è®°å¿†åŠŸèƒ½å®æ—¶æ›´æ–°**

```javascript:v2/web/v2_index.html
// ä¿®å¤è®°å¿†ç»Ÿè®¡å®æ—¶æ›´æ–°
async function loadMemoryStats() {
    try {
        const response = await fetch('/api/v2/memory/stats');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // å®æ—¶æ›´æ–°UI
        document.getElementById('session-count').textContent = data.session_count || 0;
        document.getElementById('user-count').textContent = data.user_count || 0;
        
        // æ·»åŠ è§†è§‰åé¦ˆ
        const memorySection = document.querySelector('.memory-section');
        if (data.session_count > 0 || data.user_count > 0) {
            memorySection.style.border = '2px solid #28a745';
            memorySection.style.boxShadow = '0 2px 8px rgba(40, 167, 69, 0.2)';
        } else {
            memorySection.style.border = '2px solid #e9ecef';
            memorySection.style.boxShadow = 'none';
        }
        
    } catch (error) {
        console.error('åŠ è½½è®°å¿†ç»Ÿè®¡å¤±è´¥:', error);
        // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        document.getElementById('session-count').textContent = '!';
        document.getElementById('user-count').textContent = '!';
    }
}

// æ·»åŠ å®šæ—¶åˆ·æ–°è®°å¿†ç»Ÿè®¡
setInterval(loadMemoryStats, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡

// åœ¨å‘é€æ¶ˆæ¯åç«‹å³åˆ·æ–°è®°å¿†ç»Ÿè®¡
async function refreshMemoryAfterMessage() {
    await loadMemoryStats();
}
```

### **ç¬¬å››æ­¥ï¼šæ·»åŠ æ¥æºè¯¦æƒ…æ˜¾ç¤ºåŠŸèƒ½**

```javascript:v2/web/v2_index.html
// ä¿®æ”¹addMessageå‡½æ•°ï¼Œæ·»åŠ æ¥æºè¯¦æƒ…æ˜¾ç¤º
function addMessage(content, type, data = null) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    
    const now = new Date();
    const timeString = now.toLocaleTimeString('zh-CN');
    
    let messageContent = `
        <div class="message-content">
            <div>${content}</div>
            <div class="message-time">${timeString}</div>
        </div>
    `;
    
    // æ·»åŠ æ¥æºè¯¦æƒ…åŒºåŸŸ
    if (data && (data.sources || data.image_results || data.text_results || data.table_results)) {
        messageContent += `<div class="source-details-header">ğŸ“‹ æ¥æºè¯¦æƒ…</div>`;
        messageContent += `<div class="source-details">`;
        
        let sourceIndex = 1;
        
        // å¤„ç†å›¾ç‰‡ç»“æœ
        if (data.image_results && data.image_results.length > 0) {
            data.image_results.forEach((imageResult, index) => {
                if (imageResult.image_path) {
                    // æ·»åŠ å›¾ç‰‡æ˜¾ç¤º
                    messageContent += `
                        <div class="image-result">
                            <img src="${imageResult.image_path}" alt="æŸ¥è¯¢ç»“æœå›¾ç‰‡" onerror="this.style.display='none'">
                            <div class="image-info">
                                <div class="image-title">${imageResult.caption || 'å›¾ç‰‡æè¿°'}</div>
                                <div class="image-description">${imageResult.enhanced_description || 'æš‚æ— è¯¦ç»†æè¿°'}</div>
                            </div>
                        </div>
                    `;
                    
                    // æ·»åŠ æ¥æºè¯¦æƒ…
                    messageContent += `
                        <div class="source-item">
                            <span class="source-number">${sourceIndex}.</span>
                            <span class="source-doc">ã€${imageResult.source || 'æœªçŸ¥æ–‡æ¡£'}ã€‘</span>
                            <span class="source-desc">${imageResult.caption || 'å›¾ç‰‡å†…å®¹'}</span>
                            <span class="source-figure">å›¾${index + 1}:</span>
                            <span class="source-title">${imageResult.caption || 'å›¾ç‰‡æ ‡é¢˜'}</span>
                            <span class="source-page">(ç¬¬${imageResult.page || 'æœªçŸ¥'}é¡µ</span>
                            <span class="source-tag">image)</span>
                        </div>
                    `;
                    sourceIndex++;
                }
            });
        }
        
        // å¤„ç†æ–‡æœ¬ç»“æœ
        if (data.text_results && data.text_results.length > 0) {
            data.text_results.forEach((textResult, index) => {
                messageContent += `
                    <div class="source-item">
                        <span class="source-number">${sourceIndex}.</span>
                        <span class="source-doc">ã€${textResult.source || 'æœªçŸ¥æ–‡æ¡£'}ã€‘</span>
                        <span class="source-desc">${textResult.content ? textResult.content.substring(0, 50) + '...' : 'æ–‡æœ¬å†…å®¹'}</span>
                        <span class="source-page">(ç¬¬${textResult.page || 'æœªçŸ¥'}é¡µ</span>
                        <span class="source-tag">text)</span>
                    </div>
                `;
                sourceIndex++;
            });
        }
        
        // å¤„ç†è¡¨æ ¼ç»“æœ
        if (data.table_results && data.table_results.length > 0) {
            data.table_results.forEach((tableResult, index) => {
                messageContent += `
                    <div class="source-item">
                        <span class="source-number">${sourceIndex}.</span>
                        <span class="source-doc">ã€${tableResult.source || 'æœªçŸ¥æ–‡æ¡£'}ã€‘</span>
                        <span class="source-desc">${tableResult.caption || 'è¡¨æ ¼å†…å®¹'}</span>
                        <span class="source-page">(ç¬¬${tableResult.page || 'æœªçŸ¥'}é¡µ</span>
                        <span class="source-tag">table)</span>
                    </div>
                `;
                sourceIndex++;
            });
        }
        
        // å¤„ç†é€šç”¨æ¥æºä¿¡æ¯
        if (data.sources && data.sources.length > 0) {
            data.sources.forEach((source, index) => {
                messageContent += `
                    <div class="source-item">
                        <span class="source-number">${sourceIndex}.</span>
                        <span class="source-doc">ã€${source.document_name || source.source || 'æœªçŸ¥æ–‡æ¡£'}ã€‘</span>
                        <span class="source-desc">${source.content ? source.content.substring(0, 50) + '...' : 'ç›¸å…³å†…å®¹'}</span>
                        <span class="source-page">(ç¬¬${source.page || 'æœªçŸ¥'}é¡µ</span>
                        <span class="source-tag">${source.type || 'content'})</span>
                    </div>
                `;
                sourceIndex++;
            });
        }
        
        messageContent += `</div>`;
    }
    
    messageDiv.innerHTML = messageContent;
    messagesContainer.appendChild(messageDiv);
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}
```

### **ç¬¬äº”æ­¥ï¼šæ·»åŠ å¿…è¦çš„CSSæ ·å¼**

```css:v2/web/v2_index.html
/* æ¥æºè¯¦æƒ…æ ·å¼ */
.source-details-header {
    margin: 20px 0 15px 0;
    padding: 10px 15px;
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    border-radius: 10px;
    font-weight: bold;
    text-align: center;
    font-size: 16px;
}

.source-details {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 15px;
    margin-top: 10px;
}

.source-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: 12px;
    padding: 10px;
    background: white;
    border-radius: 8px;
    border-left: 4px solid #667eea;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    line-height: 1.6;
}

.source-number {
    font-weight: bold;
    color: #667eea;
    margin-right: 8px;
    min-width: 25px;
}

.source-doc {
    font-weight: bold;
    color: #333;
    margin-right: 8px;
    background: #e3f2fd;
    padding: 2px 6px;
    border-radius: 4px;
}

.source-desc {
    flex: 1;
    color: #555;
    margin-right: 8px;
    font-size: 14px;
}

.source-figure {
    color: #667eea;
    font-weight: bold;
    margin-right: 5px;
    min-width: 40px;
}

.source-title {
    color: #333;
    font-weight: 500;
    margin-right: 8px;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.source-page {
    color: #666;
    margin-right: 5px;
}

.source-tag {
    color: #667eea;
    font-weight: bold;
    background: #f0f8ff;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
}
```

## ğŸš€ **å®æ–½æ•ˆæœ**

1. **âœ… åˆ é™¤æ··ä¹±çš„çŠ¶æ€æŒ‡ç¤ºå™¨**ï¼šç•Œé¢æ›´ç®€æ´ï¼Œåªä¿ç•™è®°å¿†ç®¡ç†
2. **âœ… æ˜¾ç¤ºLLMç”Ÿæˆçš„ç­”æ¡ˆ**ï¼šç”¨æˆ·èƒ½çœ‹åˆ°å®Œæ•´çš„AIå›ç­”ï¼ŒåŒ…æ‹¬æ£€ç´¢ç»“æœæ‘˜è¦
3. **âœ… è®°å¿†åŠŸèƒ½å®æ—¶æ›´æ–°**ï¼šæ¯5ç§’è‡ªåŠ¨åˆ·æ–°ï¼Œæœ‰è§†è§‰åé¦ˆ
4. **âœ… å®Œæ•´çš„æ¥æºè¯¦æƒ…**ï¼šæŒ‰ç±»å‹æ˜¾ç¤ºæ–‡æ¡£åã€é¡µç ã€æ ‡ç­¾ç­‰ï¼Œæ ¼å¼å®Œå…¨æŒ‰ç…§æ‚¨çš„è¦æ±‚

è¿™æ ·æ—¢è§£å†³äº†æ‚¨æåˆ°çš„æ‰€æœ‰é—®é¢˜ï¼Œåˆä¿æŒäº†ç•Œé¢çš„ç®€æ´æ€§ã€‚æ‰€æœ‰ä¿®æ”¹éƒ½åœ¨V2ç³»ç»ŸèŒƒå›´å†…ï¼Œä¸å½±å“åŸæœ‰æ¶æ„ã€‚æ‚¨è§‰å¾—è¿™ä¸ªæ–¹æ¡ˆå¦‚ä½•ï¼Ÿ