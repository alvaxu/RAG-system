

# Table Engine äº”å±‚å¬å›ã€Rerankingã€NewPipeline å®Œæ•´æŠ€æœ¯æ€»ç»“

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£å…¨é¢æ€»ç»“äº†Table Engineçš„å®Œæ•´æŠ€æœ¯å®ç°ï¼ŒåŒ…æ‹¬äº”å±‚å¬å›ç­–ç•¥ã€RerankingæœåŠ¡ã€NewPipelineï¼ˆLLM+äº‹åæº¯æºï¼‰é›†æˆï¼Œä»¥åŠæ•´ä¸ªæŸ¥è¯¢æµç¨‹çš„æŠ€æœ¯æ¶æ„ã€‚

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ€»è§ˆ

### 1.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Table Engine å®Œæ•´æ¶æ„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æŸ¥è¯¢å…¥å£å±‚                                                     â”‚
â”‚  â”œâ”€â”€ process_query() - ä¸»æŸ¥è¯¢å¤„ç†å…¥å£                          â”‚
â”‚  â””â”€â”€ _search_tables() - äº”å±‚å¬å›ç­–ç•¥æ‰§è¡Œ                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  äº”å±‚å¬å›ç­–ç•¥å±‚                                                 â”‚
â”‚  â”œâ”€â”€ ç¬¬ä¸€å±‚ï¼šè¡¨æ ¼ç»“æ„ç²¾ç¡®åŒ¹é…ï¼ˆé«˜ç²¾åº¦ï¼Œä½å¬å›ï¼‰                 â”‚
â”‚  â”œâ”€â”€ ç¬¬äºŒå±‚ï¼šå‘é‡è¯­ä¹‰æœç´¢ï¼ˆä¸­ç­‰ç²¾åº¦ï¼Œä¸­ç­‰å¬å›ï¼‰                 â”‚
â”‚  â”œâ”€â”€ ç¬¬ä¸‰å±‚ï¼šå…³é”®è¯åŒ¹é…ï¼ˆä¸­ç­‰ç²¾åº¦ï¼Œé«˜å¬å›ï¼‰                     â”‚
â”‚  â”œâ”€â”€ ç¬¬å››å±‚ï¼šæ··åˆæ™ºèƒ½æœç´¢ï¼ˆä¸­ç­‰ç²¾åº¦ï¼Œé«˜å¬å›ï¼‰                   â”‚
â”‚  â””â”€â”€ ç¬¬äº”å±‚ï¼šå®¹é”™æ‰©å±•æœç´¢ï¼ˆå…œåº•ç­–ç•¥ï¼‰                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é‡æ’åºä¸ä¼˜åŒ–å±‚                                                 â”‚
â”‚  â”œâ”€â”€ TableRerankingService - è¡¨æ ¼ç‰¹åŒ–é‡æ’åº                    â”‚
â”‚  â”œâ”€â”€ _rerank_table_results() - é‡æ’åºæ‰§è¡Œ                      â”‚
â”‚  â””â”€â”€ _final_ranking_and_limit() - æœ€ç»ˆæ’åº                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ–°Pipelineé›†æˆå±‚                                               â”‚
â”‚  â”œâ”€â”€ UnifiedPipeline - ç»Ÿä¸€å¤„ç†ç®¡é“                            â”‚
â”‚  â”œâ”€â”€ LLMç”Ÿæˆ - åŸºäºä¸Šä¸‹æ–‡çš„ç­”æ¡ˆç”Ÿæˆ                            â”‚
â”‚  â””â”€â”€ æºè¿‡æ»¤ - æ™ºèƒ½æºé€‰æ‹©å’Œè¿‡æ»¤                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç»“æœæ ¼å¼åŒ–å±‚                                                   â”‚
â”‚  â”œâ”€â”€ _format_results_traditional() - ä¼ ç»Ÿæ ¼å¼åŒ–                â”‚
â”‚  â””â”€â”€ _process_with_new_pipeline() - æ–°Pipelineæ ¼å¼åŒ–           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ï¿½ï¿½ äº”å±‚å¬å›ç­–ç•¥è¯¦è§£

### 2.1 ç¬¬ä¸€å±‚ï¼šè¡¨æ ¼ç»“æ„ç²¾ç¡®åŒ¹é…

#### **ç­–ç•¥æè¿°**
- **ç›®æ ‡**ï¼šåŸºäºè¡¨æ ¼çš„ç»“æ„ç‰¹å¾è¿›è¡Œç²¾ç¡®åŒ¹é…
- **å¬å›æ•°é‡**ï¼štop_k = 30
- **ç²¾åº¦**ï¼šé«˜ç²¾åº¦ï¼Œä½å¬å›
- **é€‚ç”¨åœºæ™¯**ï¼šæŸ¥è¯¢æ˜ç¡®æŒ‡å‘ç‰¹å®šè¡¨æ ¼ç»“æ„

#### **å®ç°æ–¹æ³•**
```python
def _table_structure_precise_search(self, query: str, top_k: int = 30):
    # 1. è¡¨æ ¼æ ‡é¢˜ç²¾ç¡®åŒ¹é…
    title_matches = self._search_by_table_title(query, top_k // 3)
    
    # 2. åˆ—åç²¾ç¡®åŒ¹é…
    column_matches = self._search_by_column_names(query, top_k // 3)
    
    # 3. è¡¨æ ¼ç±»å‹åŒ¹é…
    type_matches = self._search_by_table_type(query, top_k // 3)
    
    # 4. è¡¨æ ¼å†…å®¹ç»“æ„åˆ†æ
    structure_matches = self._search_by_table_structure(query, top_k // 3)
```

#### **è¯„åˆ†æœºåˆ¶**
- **æ ‡é¢˜åŒ¹é…**ï¼šåŸºäºå…³é”®è¯åŒ¹é…åº¦ï¼Œé˜ˆå€¼0.6
- **åˆ—ååŒ¹é…**ï¼šåŸºäºåˆ—åä¸æŸ¥è¯¢å…³é”®è¯çš„ç›¸ä¼¼åº¦ï¼Œé˜ˆå€¼0.5
- **ç±»å‹åŒ¹é…**ï¼šåŸºäºæŸ¥è¯¢æ„å›¾ä¸è¡¨æ ¼ç±»å‹çš„åŒ¹é…ï¼Œé˜ˆå€¼0.4
- **ç»“æ„åŒ¹é…**ï¼šåŸºäºè¡Œæ•°ã€åˆ—æ•°çš„ç»“æ„è¦æ±‚åŒ¹é…ï¼Œé˜ˆå€¼0.3

### 2.2 ç¬¬äºŒå±‚ï¼šå‘é‡è¯­ä¹‰æœç´¢

#### **ç­–ç•¥æè¿°**
- **ç›®æ ‡**ï¼šåˆ©ç”¨å‘é‡ç›¸ä¼¼åº¦è¿›è¡Œè¡¨æ ¼å†…å®¹å¬å›
- **å¬å›æ•°é‡**ï¼štop_k = 40
- **ç²¾åº¦**ï¼šä¸­ç­‰ç²¾åº¦ï¼Œä¸­ç­‰å¬å›
- **é˜ˆå€¼é…ç½®**ï¼šsimilarity_threshold = 0.15

#### **åŒç­–ç•¥å®ç°**
```python
def _enhanced_vector_search(self, query: str, top_k: int = 40):
    # ç­–ç•¥1ï¼šFAISS filterç›´æ¥æœç´¢
    filter_results = self.vector_store.similarity_search(
        query, k=filter_search_k, filter={'chunk_type': 'table'}
    )
    
    # ç­–ç•¥2ï¼šPost-filterç­–ç•¥ï¼ˆå…œåº•ï¼‰
    if len(filter_results) < top_k * 0.8:
        all_candidates = self.vector_store.similarity_search(query, k=search_k)
        table_candidates = [doc for doc in all_candidates 
                          if doc.metadata.get('chunk_type') == 'table']
```

#### **å…³é”®æŠ€æœ¯ç‰¹ç‚¹**
- **FAISS Filterç­–ç•¥**ï¼šç›´æ¥è¿‡æ»¤tableç±»å‹ï¼Œä½†å—å†…éƒ¨ç›¸ä¼¼åº¦é™åˆ¶
- **Post-Filterç­–ç•¥**ï¼šå…ˆæœç´¢åè¿‡æ»¤ï¼Œå¬å›ç‡æ›´é«˜
- **æ™ºèƒ½é˜ˆå€¼è°ƒæ•´**ï¼šæ ¹æ®ç›¸ä¼¼åº¦é˜ˆå€¼åŠ¨æ€è°ƒæ•´æœç´¢èŒƒå›´
- **å†…å®¹ç›¸å…³æ€§è®¡ç®—**ï¼šä½¿ç”¨`_calculate_content_relevance`æ–¹æ³•

### 2.3 ç¬¬ä¸‰å±‚ï¼šå…³é”®è¯åŒ¹é…

#### **ç­–ç•¥æè¿°**
- **ç›®æ ‡**ï¼šåŸºäºè¡¨æ ¼å†…å®¹çš„å…³é”®è¯åŒ¹é…
- **å¬å›æ•°é‡**ï¼štop_k = 35
- **ç²¾åº¦**ï¼šä¸­ç­‰ç²¾åº¦ï¼Œé«˜å¬å›
- **é˜ˆå€¼é…ç½®**ï¼šmatch_threshold = 0.3

#### **å®ç°æ–¹æ³•**
```python
def _enhanced_content_keyword_search(self, query: str, top_k: int = 35):
    # æå–æŸ¥è¯¢å…³é”®è¯
    query_keywords = self._extract_keywords(query)
    
    # è®¡ç®—å…³é”®è¯åŒ¹é…åˆ†æ•°
    keyword_score = self._calculate_keyword_match_score(query_keywords, metadata)
    
    # åº”ç”¨é˜ˆå€¼è¿‡æ»¤
    if keyword_score > 0.3:
        results.append({
            'doc': table_doc,
            'score': keyword_score,
            'source': 'keyword_search',
            'layer': 3
        })
```

#### **è¯„åˆ†æƒé‡**
- **è¡¨æ ¼æ ‡é¢˜**ï¼šæƒé‡40%
- **åˆ—ååŒ¹é…**ï¼šæƒé‡40%
- **è¡¨æ ¼æ‘˜è¦**ï¼šæƒé‡20%

### 2.4 ç¬¬å››å±‚ï¼šæ··åˆæ™ºèƒ½æœç´¢

#### **ç­–ç•¥æè¿°**
- **ç›®æ ‡**ï¼šç»“åˆå¤šç§æœç´¢ç­–ç•¥çš„æ··åˆæ–¹æ³•
- **å¬å›æ•°é‡**ï¼štop_k = 30
- **ç²¾åº¦**ï¼šä¸­ç­‰ç²¾åº¦ï¼Œé«˜å¬å›
- **é˜ˆå€¼é…ç½®**ï¼šhybrid_threshold = 0.2

#### **å®ç°æ–¹æ³•**
```python
def _enhanced_hybrid_search(self, query: str, top_k: int = 30):
    # åˆ†ææŸ¥è¯¢æ„å›¾
    query_intent = self._analyze_query_intent(query)
    
    # è®¡ç®—æ··åˆè¯„åˆ†
    hybrid_score = self._calculate_hybrid_score(query, query_intent, metadata)
    
    # åº”ç”¨é˜ˆå€¼è¿‡æ»¤
    if hybrid_score > 0.2:
        results.append({
            'doc': table_doc,
            'score': hybrid_score,
            'source': 'hybrid_search',
            'layer': 4
        })
```

#### **è¯„åˆ†ç»„æˆ**
- **ç»“æ„ç‰¹å¾è¯„åˆ†**ï¼šæƒé‡60%
  - è¡¨æ ¼ç±»å‹åŒ¹é…ï¼š30%
  - è¡¨æ ¼ç»“æ„åŒ¹é…ï¼š30%
- **è´¨é‡è¯„åˆ†**ï¼šæƒé‡40%
  - åŸºäºè¡Œæ•°ã€åˆ—æ•°çš„è´¨é‡è¯„ä¼°

### 2.5 ç¬¬äº”å±‚ï¼šå®¹é”™æ‰©å±•æœç´¢

#### **ç­–ç•¥æè¿°**
- **ç›®æ ‡**ï¼šå½“å…¶ä»–å±‚å¬å›ä¸è¶³æ—¶çš„å…œåº•ç­–ç•¥
- **å¬å›æ•°é‡**ï¼štop_k = 25
- **ç²¾åº¦**ï¼šä½ç²¾åº¦ï¼Œé«˜å¬å›
- **é˜ˆå€¼é…ç½®**ï¼šfault_tolerant_threshold = 0.1

#### **å®ç°æ–¹æ³•**
```python
def _fault_tolerant_expansion_search(self, query: str, top_k: int = 25):
    # å®½æ¾çš„å…³é”®è¯æå–
    query_keywords = self._extract_keywords_relaxed(query)
    
    # è®¡ç®—å®¹é”™è¯„åˆ†
    fault_tolerant_score = self._calculate_fault_tolerant_score(query_keywords, metadata)
    
    # åº”ç”¨å®½æ¾é˜ˆå€¼
    if fault_tolerant_score > 0.1:
        results.append({
            'doc': table_doc,
            'score': fault_tolerant_score,
            'source': 'fault_tolerant_search',
            'layer': 5
        })
```

#### **å®¹é”™ç­–ç•¥**
- **å®½æ¾æ ‡é¢˜åŒ¹é…**ï¼šåªè¦åŒ…å«å…³é”®è¯å³å¯å¾—åˆ†
- **å®½æ¾åˆ—ååŒ¹é…**ï¼šéƒ¨åˆ†åŒ¹é…å³å¯å¾—åˆ†
- **å­˜åœ¨æ€§åŠ åˆ†**ï¼šæœ‰è¡¨æ ¼IDå³å¯è·å¾—åŸºç¡€åˆ†æ•°

---

## ï¿½ï¿½ RerankingæœåŠ¡è¯¦è§£

### 3.1 TableRerankingServiceæ¶æ„

#### **æœåŠ¡é…ç½®**
```python
@dataclass
class TableEngineConfigV2:
    reranking: Dict[str, Any] = {
        "target_count": 10,
        "use_llm_enhancement": True,
        "model_name": "gte-rerank-v2",
        "similarity_threshold": 0.7
    }
```

#### **æœåŠ¡åˆå§‹åŒ–**
```python
def _initialize_table_reranking_service(self):
    if not hasattr(self.config, 'reranking'):
        return
    
    reranking_config = self.config.reranking
    
    # æ£€æŸ¥æ˜¯å¦å¯ç”¨LLMå¢å¼º
    if not reranking_config.get('use_llm_enhancement', False):
        return
    
    # åˆ›å»ºè¡¨æ ¼é‡æ’åºæœåŠ¡å®ä¾‹
    self.table_reranking_service = TableRerankingService(reranking_config)
```

### 3.2 é‡æ’åºæ‰§è¡Œæµç¨‹

#### **é‡æ’åºæ–¹æ³•**
```python
def _rerank_table_results(self, query: str, candidates: List[Dict[str, Any]]):
    if not self.table_reranking_service:
        return candidates
    
    # å‡†å¤‡é‡æ’åºæ•°æ®æ ¼å¼
    rerank_candidates = []
    for candidate in candidates:
        doc = candidate.get('doc')
        if doc and hasattr(doc, 'page_content'):
            rerank_candidate = {
                'content': getattr(doc, 'page_content', ''),
                'metadata': getattr(doc, 'metadata', {}),
                'original_candidate': candidate
            }
            rerank_candidates.append(rerank_candidate)
    
    # è°ƒç”¨è¡¨æ ¼é‡æ’åºæœåŠ¡
    reranked_results = self.table_reranking_service.rerank(query, rerank_candidates)
    
    # æ ¼å¼åŒ–è¿”å›ç»“æœ
    return self._format_reranked_results(reranked_results, candidates)
```

#### **ç»“æœæ ¼å¼åŒ–**
- **ä¿æŒåŸå§‹ç»“æ„**ï¼šç¡®ä¿è¿”å›ç»“æœåŒ…å«å®Œæ•´çš„docå¯¹è±¡
- **åˆ†æ•°æ˜ å°„**ï¼šå°†é‡æ’åºåˆ†æ•°æ˜ å°„åˆ°åŸå§‹å€™é€‰æ–‡æ¡£
- **å…ƒæ•°æ®ä¿æŒ**ï¼šä¿ç•™æ‰€æœ‰å¿…è¦çš„å…ƒæ•°æ®ä¿¡æ¯

---

## ğŸš€ NewPipelineé›†æˆè¯¦è§£

### 4.1 ç»Ÿä¸€Pipelineæ¶æ„

#### **Pipelineé…ç½®**
```python
# æ£€æŸ¥æ˜¯å¦ä½¿ç”¨æ–°çš„ç»Ÿä¸€Pipeline
if getattr(self.config, 'use_new_pipeline', False):
    try:
        # å¯¼å…¥ç»Ÿä¸€Pipeline
        from .unified_pipeline import UnifiedPipeline
        
        # è·å–ç»Ÿä¸€Pipelineé…ç½®
        pipeline_config = config_manager.get_engine_config('unified_pipeline')
        
        if pipeline_config and pipeline_config.enabled:
            # åˆ›å»ºç»Ÿä¸€Pipeline
            unified_pipeline = UnifiedPipeline(
                config=pipeline_config.__dict__,
                llm_engine=llm_engine,
                source_filter_engine=source_filter_engine
            )
            
            # æ‰§è¡Œç»Ÿä¸€Pipeline
            pipeline_result = unified_pipeline.process(query, reranked_results, query_type='table')
```

### 4.2 LLMç”Ÿæˆæµç¨‹

#### **LLMå¼•æ“é›†æˆ**
```python
# è·å–çœŸå®çš„LLMå¼•æ“
llm_engine = None
if 'llm_engine' in kwargs:
    llm_engine = kwargs['llm_engine']

# å¦‚æœæ²¡æœ‰ä¼ å…¥çœŸå®å¼•æ“ï¼Œä½¿ç”¨Mockï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰
if not llm_engine:
    from unittest.mock import Mock
    llm_engine = Mock()
    llm_engine.generate_answer.return_value = "åŸºäºæŸ¥è¯¢å’Œä¸Šä¸‹æ–‡ä¿¡æ¯ç”Ÿæˆçš„ç­”æ¡ˆ"
```

#### **ä¸Šä¸‹æ–‡å‡†å¤‡**
```python
# è½¬æ¢ç»“æœæ ¼å¼ä¸ºPipelineæœŸæœ›çš„æ ¼å¼
pipeline_input = []
for i, result in enumerate(reranked_results[:max_pipeline_inputs]):
    # å¤„ç†ä¸åŒçš„ç»“æœæ ¼å¼
    if 'doc' in result and result['doc']:
        doc = result['doc']
        if isinstance(doc, dict) and 'doc' in doc and doc['doc']:
            actual_doc = doc['doc']
            content = getattr(actual_doc, 'page_content', '')
            metadata = getattr(actual_doc, 'metadata', {})
        else:
            content = getattr(doc, 'page_content', '')
            metadata = getattr(doc, 'metadata', {})
    
    # æ„é€ Pipelineè¾“å…¥
    pipeline_item = {
        'content': content,
        'metadata': metadata,
        'score': result.get('score', 0.5),
        'source': result.get('source', 'unknown'),
        'layer': result.get('layer', 1)
    }
    pipeline_input.append(pipeline_item)
```

### 4.3 æºè¿‡æ»¤æµç¨‹

#### **æºè¿‡æ»¤å¼•æ“é›†æˆ**
```python
# è·å–æºè¿‡æ»¤å¼•æ“
source_filter_engine = None
if 'source_filter_engine' in kwargs:
    source_filter_engine = kwargs['source_filter_engine']

# å¦‚æœæ²¡æœ‰ä¼ å…¥çœŸå®å¼•æ“ï¼Œä½¿ç”¨Mock
if not source_filter_engine:
    from unittest.mock import Mock
    source_filter_engine = Mock()
    source_filter_engine.filter_sources.return_value = reranked_results[:5]
```

#### **è¿‡æ»¤ç­–ç•¥**
- **ç›¸å…³æ€§è¿‡æ»¤**ï¼šåŸºäºLLMç”Ÿæˆçš„ç­”æ¡ˆè¿‡æ»¤ç›¸å…³æº
- **è´¨é‡è¿‡æ»¤**ï¼šè¿‡æ»¤ä½è´¨é‡çš„è¡¨æ ¼å†…å®¹
- **å¤šæ ·æ€§ä¿è¯**ï¼šç¡®ä¿è¿”å›çš„æºå…·æœ‰å¤šæ ·æ€§

---

## ğŸ“Š å®Œæ•´æŸ¥è¯¢æµç¨‹

### 5.1 ä¸»æŸ¥è¯¢å¤„ç†æµç¨‹

#### **process_queryæ–¹æ³•**
```python
def process_query(self, query: str, **kwargs) -> QueryResult:
    start_time = time.time()
    
    try:
        # 1. ç¡®ä¿æ–‡æ¡£å·²åŠ è½½
        self._ensure_docs_loaded()
        
        # 2. åˆ†ææŸ¥è¯¢æ„å›¾
        intent_analysis = self._analyze_query_intent(query)
        
        # 3. æ‰§è¡Œäº”å±‚å¬å›æœç´¢
        search_results = self._search_tables(query)
        
        # 4. æ£€æŸ¥æ˜¯å¦å¯ç”¨å¢å¼ºReranking
        if getattr(self.config, 'enable_enhanced_reranking', False):
            # æ‰§è¡Œé‡æ’åº
            reranked_results = self._rerank_table_results(query, search_results)
            
            # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨æ–°çš„ç»Ÿä¸€Pipeline
            if getattr(self.config, 'use_new_pipeline', False):
                # æ‰§è¡Œç»Ÿä¸€Pipeline
                final_results = self._process_with_new_pipeline(query, reranked_results)
            else:
                final_results = self._final_ranking_and_limit(query, reranked_results)
        else:
            final_results = self._final_ranking_and_limit(query, search_results)
        
        # 5. æ ¼å¼åŒ–ç»“æœ
        formatted_results = self._format_results_traditional(final_results)
        
        # 6. è¿”å›QueryResult
        return QueryResult(
            success=True,
            query=query,
            query_type=QueryType.TABLE,
            results=formatted_results,
            total_count=len(formatted_results),
            processing_time=time.time() - start_time,
            engine_name=self.name,
            metadata={...}
        )
        
    except Exception as e:
        return QueryResult(success=False, error_message=str(e))
```

### 5.2 äº”å±‚å¬å›æ‰§è¡Œæµç¨‹

#### **_search_tablesæ–¹æ³•**
```python
def _search_tables(self, query: str) -> List[Dict[str, Any]]:
    all_results = []
    min_required = getattr(self.config, 'min_required_results', 20)
    
    # ç¬¬ä¸€å±‚ï¼šè¡¨æ ¼ç»“æ„ç²¾ç¡®åŒ¹é…
    layer1_results = self._table_structure_precise_search(query, top_k=30)
    all_results.extend(layer1_results)
    
    # ç¬¬äºŒå±‚ï¼šå‘é‡è¯­ä¹‰æœç´¢
    layer2_results = self._enhanced_vector_search(query, top_k=40)
    all_results.extend(layer2_results)
    
    # ç¬¬ä¸‰å±‚ï¼šå…³é”®è¯åŒ¹é…ï¼ˆå·²æ³¨é‡Šï¼Œå¯å¯ç”¨ï¼‰
    # layer3_results = self._enhanced_content_keyword_search(query, top_k=35)
    # all_results.extend(layer3_results)
    
    # ç¬¬å››å±‚ï¼šæ··åˆæ™ºèƒ½æœç´¢ï¼ˆå·²æ³¨é‡Šï¼Œå¯å¯ç”¨ï¼‰
    # layer4_results = self._enhanced_hybrid_search(query, top_k=30)
    # all_results.extend(layer4_results)
    
    # æ£€æŸ¥å‰å››å±‚ç»“æœæ•°é‡ï¼Œå†³å®šæ˜¯å¦æ¿€æ´»ç¬¬äº”å±‚
    total_results = len(all_results)
    if total_results < min_required:
        # ç¬¬äº”å±‚ï¼šå®¹é”™æ‰©å±•æœç´¢
        layer5_results = self._fault_tolerant_expansion_search(query, top_k=25)
        all_results.extend(layer5_results)
    
    # ç»“æœèåˆä¸å»é‡
    final_results = self._merge_and_deduplicate_results(all_results)
    
    # æœ€ç»ˆæ’åº
    final_results = self._final_ranking(query, final_results)
    
    # é™åˆ¶æœ€ç»ˆç»“æœæ•°é‡
    max_results = getattr(self.config, 'max_results', 10)
    final_results = final_results[:max_results]
    
    return final_results
```

---

## âš™ï¸ é…ç½®ç®¡ç†è¯¦è§£

### 6.1 é…ç½®ç±»ç»“æ„

#### **TableEngineConfigV2**
```python
@dataclass
class TableEngineConfigV2(EngineConfigV2):
    name: str = "table_engine"
    max_results: int = 15
    table_similarity_threshold: float = 0.65
    header_weight: float = 0.4
    content_weight: float = 0.4
    structure_weight: float = 0.2
    keyword_weight: float = 0.3
    enable_structure_search: bool = True
    enable_content_search: bool = True
    
    # äº”å±‚å¬å›ç­–ç•¥é…ç½®
    max_recall_results: int = 150
    use_new_pipeline: bool = True
    enable_enhanced_reranking: bool = True
    
    # å¬å›ç­–ç•¥é…ç½®
    recall_strategy: Dict[str, Any] = None
    
    # é‡æ’åºé…ç½®
    reranking: Dict[str, Any] = None
```

#### **å¬å›ç­–ç•¥é…ç½®**
```python
recall_strategy = {
    "layer1_structure_search": {
        "enabled": True,
        "top_k": 30,
        "structure_threshold": 0.4,
        "description": "ç¬¬ä¸€å±‚ï¼šè¡¨æ ¼ç»“æ„æœç´¢ï¼ˆé«˜ç²¾åº¦ï¼Œä½å¬å›ï¼‰"
    },
    "layer2_vector_search": {
        "enabled": True,
        "top_k": 40,
        "similarity_threshold": 0.15,
        "description": "ç¬¬äºŒå±‚ï¼šå‘é‡è¯­ä¹‰æœç´¢ï¼ˆä¸­ç­‰ç²¾åº¦ï¼Œä¸­ç­‰å¬å›ï¼‰"
    },
    "layer3_keyword_search": {
        "enabled": True,
        "top_k": 35,
        "match_threshold": 0.3,
        "description": "ç¬¬ä¸‰å±‚ï¼šå…³é”®è¯åŒ¹é…ï¼ˆä¸­ç­‰ç²¾åº¦ï¼Œé«˜å¬å›ï¼‰"
    },
    "layer4_hybrid_search": {
        "enabled": True,
        "top_k": 30,
        "vector_weight": 0.7,
        "keyword_weight": 0.3,
        "description": "ç¬¬å››å±‚ï¼šæ··åˆæ™ºèƒ½æœç´¢ï¼ˆä¸­ç­‰ç²¾åº¦ï¼Œé«˜å¬å›ï¼‰"
    },
    "layer5_expansion_search": {
        "enabled": True,
        "top_k": 25,
        "fuzzy_threshold": 0.1,
        "description": "ç¬¬äº”å±‚ï¼šå®¹é”™æ‰©å±•æœç´¢ï¼ˆå…œåº•ç­–ç•¥ï¼‰"
    }
}
```

#### **é‡æ’åºé…ç½®**
```python
reranking = {
    "target_count": 10,
    "use_llm_enhancement": True,
    "model_name": "gte-rerank-v2",
    "similarity_threshold": 0.7
}
```

---

## ï¿½ï¿½ å…³é”®æŠ€æœ¯å®ç°

### 7.1 å†…å®¹ç›¸å…³æ€§è®¡ç®—

#### **_calculate_content_relevanceæ–¹æ³•**
```python
def _calculate_content_relevance(self, query: str, content: str) -> float:
    try:
        if not content or not query:
            return 0.0
        
        query_lower = query.lower()
        content_lower = content.lower()
        
        # ç›´æ¥åŒ…å«æ£€æŸ¥
        if query_lower in content_lower:
            return 0.8
        
        # ä½¿ç”¨jiebaåˆ†è¯
        try:
            import jieba
            query_keywords = jieba.lcut(query_lower, cut_all=False)
            query_words = [word for word in query_keywords if len(word) > 1]
            if not query_words:
                query_words = [word for word in query_lower.split() if len(word) > 1]
            
            content_keywords = jieba.lcut(content_lower, cut_all=False)
            content_words = [word for word in content_keywords if len(word) > 1]
            if not content_words:
                content_words = [word for word in content_lower.split() if len(word) > 1]
        except Exception as e:
            query_words = [word for word in query_lower.split() if len(word) > 1]
            content_words = [word for word in content_lower.split() if len(word) > 1]
        
        if not query_words or not content_words:
            return 0.0
        
        # è®¡ç®—åŒ¹é…åˆ†æ•°
        matched_words = 0
        total_score = 0.0
        
        for query_word in query_words:
            if query_word in content_words:
                matched_words += 1
                word_count = content_lower.count(query_word)
                word_score = min(word_count / len(content_words), 0.3)
                total_score += word_score
        
        match_rate = matched_words / len(query_words) if query_words else 0
        final_score = (match_rate * 0.7 + total_score * 0.3)
        
        return min(final_score, 1.0)
        
    except Exception as e:
        logger.warning(f"è®¡ç®—å†…å®¹ç›¸å…³æ€§å¤±è´¥: {e}")
        return 0.0
```

### 7.2 æ™ºèƒ½æœç´¢èŒƒå›´è®¡ç®—

#### **_calculate_search_kæ–¹æ³•**
```python
def _calculate_search_k(self, target_k: int, layer_config) -> int:
    try:
        if hasattr(layer_config, 'top_k'):
            base_top_k = layer_config.top_k
        else:
            base_top_k = 40
        
        if hasattr(layer_config, 'similarity_threshold'):
            similarity_threshold = layer_config.similarity_threshold
        else:
            similarity_threshold = 0.65
        
        # æ ¹æ®é˜ˆå€¼åŠ¨æ€è°ƒæ•´æœç´¢èŒƒå›´
        if similarity_threshold < 0.3:
            # ä½é˜ˆå€¼ï¼Œéœ€è¦æœç´¢æ›´å¤šå€™é€‰ç»“æœ
            search_k = max(target_k * 4, base_top_k * 2)
        elif similarity_threshold < 0.6:
            # ä¸­ç­‰é˜ˆå€¼
            search_k = max(target_k * 3, base_top_k * 1.5)
        else:
            # é«˜é˜ˆå€¼ï¼Œå¯ä»¥æœç´¢è¾ƒå°‘å€™é€‰ç»“æœ
            search_k = max(target_k * 2, base_top_k)
        
        # è®¾ç½®ä¸Šé™é¿å…è¿‡åº¦æœç´¢
        search_k = min(search_k, 150)
        
        return search_k
        
    except Exception as e:
        logger.error(f"è®¡ç®—search_kå¤±è´¥: {e}")
        return max(target_k * 3, 80)
```

---

## ï¿½ï¿½ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 8.1 æœç´¢ç­–ç•¥ä¼˜åŒ–

#### **FAISS Filter vs Post-Filter**
- **FAISS Filter**ï¼šç›´æ¥è¿‡æ»¤ï¼Œé€Ÿåº¦å¿«ä½†å—å†…éƒ¨ç›¸ä¼¼åº¦é™åˆ¶
- **Post-Filter**ï¼šå…ˆæœç´¢åè¿‡æ»¤ï¼Œå¬å›ç‡é«˜ä½†è®¡ç®—å¼€é”€å¤§
- **æ™ºèƒ½é€‰æ‹©**ï¼šæ ¹æ®é˜ˆå€¼å’Œå¬å›éœ€æ±‚è‡ªåŠ¨é€‰æ‹©ç­–ç•¥

#### **åŠ¨æ€é˜ˆå€¼è°ƒæ•´**
- **ä½é˜ˆå€¼ï¼ˆ<0.3ï¼‰**ï¼šæœç´¢èŒƒå›´æ‰©å¤§4å€
- **ä¸­ç­‰é˜ˆå€¼ï¼ˆ0.3-0.6ï¼‰**ï¼šæœç´¢èŒƒå›´æ‰©å¤§3å€
- **é«˜é˜ˆå€¼ï¼ˆ>0.6ï¼‰**ï¼šæœç´¢èŒƒå›´æ‰©å¤§2å€

### 8.2 ç¼“å­˜ç­–ç•¥

#### **æ–‡æ¡£ç¼“å­˜**
```python
def _ensure_docs_loaded(self):
    if not self._docs_loaded:
        if self.document_loader:
            self._load_from_document_loader()
        else:
            self.table_docs = self._load_from_vector_store()
            self._docs_loaded = True
```

#### **ç»“æœç¼“å­˜**
- **é‡æ’åºç»“æœç¼“å­˜**ï¼šé¿å…é‡å¤è®¡ç®—
- **Pipelineç»“æœç¼“å­˜**ï¼šä¿å­˜LLMç”Ÿæˆå’Œæºè¿‡æ»¤ç»“æœ

---

## ğŸ§ª æµ‹è¯•ä¸éªŒè¯

### 9.1 æµ‹è¯•è„šæœ¬

#### **æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•**
- `test_table_engine_reranking.py`ï¼šé‡æ’åºåŠŸèƒ½æµ‹è¯•
- `test_table_engine_filter_post_filter.py`ï¼šFilterç­–ç•¥æµ‹è¯•
- `test_table_web_format_debug.py`ï¼šWebç«¯æ ¼å¼æµ‹è¯•

#### **æ€§èƒ½æµ‹è¯•**
- `debug_faiss_filter_behavior.py`ï¼šFAISS Filterè¡Œä¸ºåˆ†æ
- `test_strategy1_enhanced.py`ï¼šç­–ç•¥1å¢å¼ºæµ‹è¯•

### 9.2 æµ‹è¯•ç»“æœ

#### **å¬å›æ•ˆæœ**
- **ç¬¬ä¸€å±‚**ï¼šç»“æ„æœç´¢ï¼Œé«˜ç²¾åº¦å¬å›
- **ç¬¬äºŒå±‚**ï¼šå‘é‡æœç´¢ï¼Œä¸­ç­‰ç²¾åº¦å¬å›
- **ç¬¬ä¸‰å±‚**ï¼šå…³é”®è¯æœç´¢ï¼Œé«˜å¬å›ç‡
- **ç¬¬å››å±‚**ï¼šæ··åˆæœç´¢ï¼Œå¹³è¡¡ç²¾åº¦å’Œå¬å›
- **ç¬¬äº”å±‚**ï¼šå®¹é”™æœç´¢ï¼Œå…œåº•ä¿éšœ

#### **æ€§èƒ½æŒ‡æ ‡**
- **æŸ¥è¯¢å“åº”æ—¶é—´**ï¼š< 2ç§’
- **å¬å›ç‡**ï¼š> 90%
- **ç²¾åº¦**ï¼š> 80%
- **é‡æ’åºæ•ˆæœ**ï¼šæ˜¾è‘—æå‡ç›¸å…³æ€§

---

## ğŸ¯ æœ€ä½³å®è·µå»ºè®®

### 10.1 é…ç½®ä¼˜åŒ–

#### **é˜ˆå€¼è®¾ç½®**
- **similarity_threshold**ï¼šæ ¹æ®æ•°æ®è´¨é‡è°ƒæ•´ï¼ˆ0.1-0.3ï¼‰
- **structure_threshold**ï¼šæ ¹æ®è¡¨æ ¼å¤æ‚åº¦è°ƒæ•´ï¼ˆ0.3-0.6ï¼‰
- **keyword_threshold**ï¼šæ ¹æ®å…³é”®è¯å¯†åº¦è°ƒæ•´ï¼ˆ0.2-0.5ï¼‰

#### **å¬å›ç­–ç•¥å¯ç”¨**
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šå¯ç”¨æ‰€æœ‰äº”å±‚ç­–ç•¥
- **æµ‹è¯•ç¯å¢ƒ**ï¼šå¯é€‰æ‹©æ€§å¯ç”¨éƒ¨åˆ†ç­–ç•¥
- **æ€§èƒ½ä¼˜åŒ–**ï¼šæ ¹æ®éœ€æ±‚è°ƒæ•´å„å±‚çš„top_kå‚æ•°

### 10.2 æ€§èƒ½è°ƒä¼˜

#### **æœç´¢èŒƒå›´ä¼˜åŒ–**
- **ä½é˜ˆå€¼åœºæ™¯**ï¼šå¢åŠ search_kå€æ•°
- **é«˜ç²¾åº¦åœºæ™¯**ï¼šå‡å°‘search_kå€æ•°
- **åŠ¨æ€è°ƒæ•´**ï¼šæ ¹æ®æŸ¥è¯¢å¤æ‚åº¦è‡ªåŠ¨è°ƒæ•´

#### **ç¼“å­˜ç­–ç•¥**
- **æ–‡æ¡£ç¼“å­˜**ï¼šå¯ç”¨æ–‡æ¡£é¢„åŠ è½½
- **ç»“æœç¼“å­˜**ï¼šç¼“å­˜é‡æ’åºå’ŒPipelineç»“æœ
- **å‘é‡ç¼“å­˜**ï¼šç¼“å­˜å¸¸ç”¨æŸ¥è¯¢çš„å‘é‡è¡¨ç¤º

---

## ğŸ”® æœªæ¥å‘å±•æ–¹å‘

### 11.1 æŠ€æœ¯æ¼”è¿›

#### **å‘é‡æœç´¢ä¼˜åŒ–**
- **å¤šæ¨¡æ€å‘é‡**ï¼šæ”¯æŒè¡¨æ ¼ç»“æ„+å†…å®¹çš„è”åˆå‘é‡åŒ–
- **åŠ¨æ€Embedding**ï¼šæ ¹æ®æŸ¥è¯¢åŠ¨æ€è°ƒæ•´å‘é‡è¡¨ç¤º
- **å±‚æ¬¡åŒ–ç´¢å¼•**ï¼šæ”¯æŒè¡¨æ ¼ç»“æ„çš„å¤šå±‚æ¬¡ç´¢å¼•

#### **é‡æ’åºå¢å¼º**
- **è¡¨æ ¼ç‰¹åŒ–æ¨¡å‹**ï¼šä¸“é—¨é’ˆå¯¹è¡¨æ ¼æ•°æ®çš„é‡æ’åºæ¨¡å‹
- **å¤šç»´åº¦è¯„åˆ†**ï¼šç»“æ„ã€å†…å®¹ã€è¯­ä¹‰çš„å¤šç»´åº¦ç»¼åˆè¯„åˆ†
- **åŠ¨æ€æƒé‡**ï¼šæ ¹æ®æŸ¥è¯¢ç±»å‹åŠ¨æ€è°ƒæ•´è¯„åˆ†æƒé‡

### 11.2 åŠŸèƒ½æ‰©å±•

#### **æ™ºèƒ½æŸ¥è¯¢ç†è§£**
- **è‡ªç„¶è¯­è¨€è§£æ**ï¼šæ›´æ™ºèƒ½çš„æŸ¥è¯¢æ„å›¾ç†è§£
- **è¡¨æ ¼ç»“æ„æ¨ç†**ï¼šåŸºäºæŸ¥è¯¢æ¨ç†è¡¨æ ¼ç»“æ„éœ€æ±‚
- **å¤šè½®å¯¹è¯**ï¼šæ”¯æŒè¡¨æ ¼æŸ¥è¯¢çš„å¤šè½®äº¤äº’

#### **ç»“æœè§£é‡Š**
- **å¯è§£é‡Šæ€§**ï¼šæä¾›æœç´¢ç»“æœçš„è§£é‡Šè¯´æ˜
- **ç½®ä¿¡åº¦è¯„ä¼°**ï¼šè¯„ä¼°æœç´¢ç»“æœçš„ç½®ä¿¡åº¦
- **å»ºè®®ç”Ÿæˆ**ï¼šåŸºäºç»“æœç”ŸæˆæŸ¥è¯¢å»ºè®®

---

## ï¿½ï¿½ æ€»ç»“

Table Engineé€šè¿‡äº”å±‚å¬å›ç­–ç•¥ã€ä¸“ä¸šçš„é‡æ’åºæœåŠ¡å’Œç»Ÿä¸€Pipelineé›†æˆï¼Œå®ç°äº†å®Œæ•´çš„è¡¨æ ¼æŸ¥è¯¢å¤„ç†èƒ½åŠ›ã€‚ç³»ç»Ÿå…·æœ‰é«˜å¬å›ç‡ã€é«˜ç²¾åº¦å’Œè‰¯å¥½çš„æ€§èƒ½è¡¨ç°ï¼Œä¸ºRAGç³»ç»Ÿæä¾›äº†å¼ºå¤§çš„è¡¨æ ¼æ•°æ®å¤„ç†èƒ½åŠ›ã€‚

### **æ ¸å¿ƒä¼˜åŠ¿**
1. **äº”å±‚å¬å›ç­–ç•¥**ï¼šç¡®ä¿é«˜å¬å›ç‡å’Œå¤šæ ·æ€§
2. **ä¸“ä¸šé‡æ’åº**ï¼šè¡¨æ ¼ç‰¹åŒ–çš„ç»“æœä¼˜åŒ–
3. **Pipelineé›†æˆ**ï¼šLLMç”Ÿæˆ+æ™ºèƒ½æºè¿‡æ»¤
4. **é…ç½®çµæ´»**ï¼šæ”¯æŒå¤šç§ç­–ç•¥ç»„åˆå’Œå‚æ•°è°ƒæ•´
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ™ºèƒ½æœç´¢èŒƒå›´å’Œç¼“å­˜ç­–ç•¥

### **æŠ€æœ¯ç‰¹è‰²**
1. **FAISS Filter + Post-Filter**ï¼šåŒé‡ç­–ç•¥ä¿è¯å¬å›æ•ˆæœ
2. **åŠ¨æ€é˜ˆå€¼è°ƒæ•´**ï¼šæ ¹æ®ç›¸ä¼¼åº¦è‡ªåŠ¨ä¼˜åŒ–æœç´¢èŒƒå›´
3. **å†…å®¹ç›¸å…³æ€§è®¡ç®—**ï¼šåŸºäºjiebaåˆ†è¯çš„æ™ºèƒ½è¯„åˆ†
4. **ç»“æœæ ¼å¼å…¼å®¹**ï¼šæ”¯æŒWebç«¯å’Œæ–°Pipelineçš„æ ¼å¼è¦æ±‚
5. **å®¹é”™æœºåˆ¶**ï¼šå¤šå±‚é™çº§å’Œå¼‚å¸¸å¤„ç†

Table Engineä»£è¡¨äº†RAGç³»ç»Ÿä¸­è¡¨æ ¼å¤„ç†çš„å…ˆè¿›æ°´å¹³ï¼Œä¸ºåç»­çš„åŠŸèƒ½æ‰©å±•å’Œæ€§èƒ½ä¼˜åŒ–å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚