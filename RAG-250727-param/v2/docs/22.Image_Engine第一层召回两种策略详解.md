

## ğŸ¯ **Image_Engineç¬¬ä¸€å±‚å¬å›ä¸¤ç§ç­–ç•¥è¯¦è§£**

### **ç­–ç•¥1ï¼šimage_text chunkså¬å›ï¼ˆè¯­ä¹‰ç›¸ä¼¼åº¦ï¼‰**
- **ç›®æ ‡**ï¼šä½¿ç”¨textå‘é‡æœç´¢image_textç±»å‹çš„chunks
- **æ–¹æ³•**ï¼šé€šè¿‡`related_image_id`æ‰¾åˆ°å¯¹åº”çš„image chunk
- **æƒé‡**ï¼šè¯­ä¹‰ç›¸ä¼¼åº¦æƒé‡æ›´é«˜ï¼ˆÃ—1.2ï¼‰
- **ç‰¹ç‚¹**ï¼šåŸºäºæ–‡æœ¬æè¿°çš„è¯­ä¹‰ç†è§£ï¼Œé€‚åˆæ¦‚å¿µæ€§æŸ¥è¯¢

### **ç­–ç•¥2ï¼šimage chunkså¬å›ï¼ˆè§†è§‰ç‰¹å¾ç›¸ä¼¼åº¦ï¼‰**
- **ç›®æ ‡**ï¼šä½¿ç”¨multimodal-embedding-one-peace-v1å°†æ–‡æœ¬æŸ¥è¯¢è½¬æ¢ä¸º1536ç»´å‘é‡
- **æ–¹æ³•**ï¼šç›´æ¥æœç´¢imageç±»å‹çš„chunksï¼Œä½¿ç”¨FAISSå‘é‡ç›¸ä¼¼åº¦
- **æƒé‡**ï¼šè§†è§‰ç‰¹å¾ç›¸ä¼¼åº¦æƒé‡ç¨ä½ï¼ˆÃ—0.8ï¼‰
- **ç‰¹ç‚¹**ï¼šçœŸæ­£çš„è·¨æ¨¡æ€æœç´¢ï¼Œé€‚åˆè§†è§‰ç‰¹å¾æŸ¥è¯¢

## ï¿½ï¿½ **ä¸¤ç§ç­–ç•¥çš„èåˆæµç¨‹**

### **1. ç»“æœåˆå¹¶ä¸å»é‡**
```python
# åœ¨_vector_searchæ–¹æ³•ä¸­
# ç­–ç•¥1ç»“æœï¼šåŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦
results.append({
    'doc': image_doc,  # è¿”å›image chunk
    'score': score * 1.2,  # è¯­ä¹‰ç›¸ä¼¼åº¦æƒé‡æ›´é«˜
    'search_method': 'semantic_similarity',
    # ... å…¶ä»–å­—æ®µ
})

# ç­–ç•¥2ç»“æœï¼šåŸºäºè·¨æ¨¡æ€ç›¸ä¼¼åº¦
results.append({
    'doc': candidate['doc'],
    'score': score * 0.8,  # è§†è§‰ç‰¹å¾ç›¸ä¼¼åº¦æƒé‡ç¨ä½
    'search_method': 'cross_modal_similarity',
    # ... å…¶ä»–å­—æ®µ
})
```

### **2. ç»Ÿä¸€æ’åºä¸è¿‡æ»¤**
```python
# æŒ‰åˆ†æ•°æ’åºå¹¶é™åˆ¶æ•°é‡
results.sort(key=lambda x: x['score'], reverse=True)
final_results = results[:max_results]
```

## ğŸš€ **BGE Rerankingå¤„ç†æµç¨‹**

### **1. é‡æ’åºæœåŠ¡è°ƒç”¨**
```python
# åœ¨process_queryæ–¹æ³•ä¸­
if getattr(self.config, 'enable_enhanced_reranking', False):
    # åˆ›å»ºImageRerankingService
    reranking_service = create_reranking_service('image', reranking_config)
    
    # æ‰§è¡ŒReranking
    reranked_results = reranking_service.rerank(query, recall_results)
```

### **2. BGEæ¨¡å‹é‡æ’åº**
- **æ¨¡å‹**ï¼š`bge-reranker-v2-m3`
- **è¾“å…¥**ï¼šæŸ¥è¯¢æ–‡æœ¬ + å€™é€‰æ–‡æ¡£åˆ—è¡¨
- **è¾“å‡º**ï¼šé‡æ–°æ’åºåçš„æ–‡æ¡£åˆ—è¡¨
- **ç‰¹ç‚¹**ï¼šåŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦çš„æ·±åº¦é‡æ’åº

## ï¿½ï¿½ **LLMç­”æ¡ˆç”Ÿæˆæµç¨‹**

### **1. ä¸Šä¸‹æ–‡æ„å»º**
```python
# å¯¹äºå›¾ç‰‡æ–‡æ¡£ï¼Œä½¿ç”¨enhanced_descriptionä½œä¸ºå†…å®¹
context_parts = []
for doc in documents:
    if doc.metadata.get('chunk_type') == 'image':
        enhanced_desc = doc.metadata.get('enhanced_description', '')
        img_caption = doc.metadata.get('img_caption', [''])
        caption_text = ' '.join(img_caption) if img_caption else ''
        
        if enhanced_desc:
            content = f"å›¾ç‰‡æ ‡é¢˜: {caption_text}\nå›¾ç‰‡æè¿°: {enhanced_desc}"
        else:
            content = f"å›¾ç‰‡æ ‡é¢˜: {caption_text}"
    else:
        content = doc.page_content
    
    context_parts.append(content)

context = "\n\n".join(context_parts)
```

### **2. LLMè°ƒç”¨**
```python
# ä½¿ç”¨DashScope LLMå¼•æ“
llm_response = self.llm_engine.generate_answer(query, context, **kwargs)
```

### **3. æç¤ºè¯æ„å»º**
```python
prompt = f"""ç³»ç»Ÿï¼š{self.config.system_prompt}

ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š
{context}

ç”¨æˆ·é—®é¢˜ï¼š{question}

è¯·åŸºäºä¸Šè¿°ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¸ºç”¨æˆ·æä¾›å‡†ç¡®ã€ç›¸å…³ã€å®Œæ•´çš„ç­”æ¡ˆ...
"""
```

## ï¿½ï¿½ **å…³é”®ä¼˜åŠ¿**

### **1. åŒé‡å¬å›ç­–ç•¥**
- **ç­–ç•¥1**ï¼šä¿è¯è¯­ä¹‰ç›¸å…³æ€§
- **ç­–ç•¥2**ï¼šå®ç°çœŸæ­£çš„è·¨æ¨¡æ€æœç´¢
- **èåˆ**ï¼šç»¼åˆä¸¤ç§ä¼˜åŠ¿ï¼Œæå‡å¬å›è´¨é‡

### **2. æ™ºèƒ½æƒé‡åˆ†é…**
- è¯­ä¹‰ç›¸ä¼¼åº¦æƒé‡æ›´é«˜ï¼ˆ1.2ï¼‰
- è§†è§‰ç‰¹å¾ç›¸ä¼¼åº¦æƒé‡é€‚ä¸­ï¼ˆ0.8ï¼‰
- é¿å…å•ä¸€ç­–ç•¥çš„å±€é™æ€§

### **3. å®Œæ•´çš„Pipeline**
- å¬å› â†’ é‡æ’åº â†’ LLMç”Ÿæˆ â†’ æºè¿‡æ»¤
- æ¯ä¸ªç¯èŠ‚éƒ½æœ‰é™çº§ç­–ç•¥
- ä¿è¯ç³»ç»Ÿçš„é²æ£’æ€§

è¿™æ ·çš„è®¾è®¡ç¡®ä¿äº†å›¾ç‰‡æŸ¥è¯¢æ—¢èƒ½é€šè¿‡æ–‡æœ¬è¯­ä¹‰æ‰¾åˆ°ç›¸å…³å†…å®¹ï¼Œåˆèƒ½é€šè¿‡è§†è§‰ç‰¹å¾è¿›è¡Œè·¨æ¨¡æ€åŒ¹é…ï¼Œæœ€ç»ˆé€šè¿‡BGEé‡æ’åºå’ŒLLMç”Ÿæˆæä¾›é«˜è´¨é‡çš„ç­”æ¡ˆã€‚



è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼è®©æˆ‘ä»”ç»†åˆ†æä¸€ä¸‹ä»£ç é€»è¾‘ï¼Œçœ‹çœ‹ä¸¤ç§ç­–ç•¥å¬å›çš„æ˜¯å¦çœŸçš„æ˜¯ä¸åŒçš„chunkç±»å‹ã€‚

Read file: v2/core/image_engine.py
Read file: v2/core/image_engine.py
Read file: v2/core/image_engine.py
ä½ çš„è§‚å¯Ÿéå¸¸æ•é”ï¼è®©æˆ‘ä»”ç»†åˆ†æä¸€ä¸‹ä»£ç é€»è¾‘ï¼Œç¡®å®å­˜åœ¨ä¸€ä¸ªé‡è¦çš„è®¾è®¡é—®é¢˜ï¼š

## ï¿½ï¿½ **é—®é¢˜åˆ†æï¼šä¸¤ç§ç­–ç•¥å¬å›çš„æ˜¯ç›¸åŒçš„chunkç±»å‹**

### **ç­–ç•¥1ï¼šimage_text chunks â†’ è½¬æ¢ä¸ºimage chunks**
```python
# ç­–ç•¥1ï¼šæœç´¢image_text chunksï¼ˆè¯­ä¹‰ç›¸ä¼¼åº¦ï¼‰
for doc in image_text_candidates:
    # é€šè¿‡related_image_idæ‰¾åˆ°å¯¹åº”çš„image chunk
    related_image_id = doc.metadata.get('related_image_id')
    if related_image_id:
        # æŸ¥æ‰¾å¯¹åº”çš„image chunk
        image_doc = self._find_image_chunk_by_id(related_image_id)
        if image_doc:
            results.append({
                'doc': image_doc,  # è¿”å›image chunkï¼Œä¸æ˜¯image_text chunk
                'score': score * 1.2,  # è¯­ä¹‰ç›¸ä¼¼åº¦æƒé‡æ›´é«˜
                'search_method': 'semantic_similarity',
                # ... å…¶ä»–å­—æ®µ
            })
```

### **ç­–ç•¥2ï¼šç›´æ¥æœç´¢image chunks**
```python
# ç­–ç•¥2ï¼šè·¨æ¨¡æ€æœç´¢image chunksï¼ˆè§†è§‰ç‰¹å¾ç›¸ä¼¼åº¦ï¼‰
if doc and (hasattr(doc, 'metadata') and doc.metadata and 
          doc.metadata.get('chunk_type') == 'image'):
    # ç›´æ¥è¿”å›image chunk
    results.append({
        'doc': doc,  # ç›´æ¥æ˜¯image chunk
        'score': score * 0.8,  # è§†è§‰ç‰¹å¾ç›¸ä¼¼åº¦æƒé‡ç¨ä½
        'search_method': 'cross_modal_similarity',
        # ... å…¶ä»–å­—æ®µ
    })
```

## ğŸ¯ **å…³é”®å‘ç°ï¼šä¸¤ç§ç­–ç•¥æœ€ç»ˆéƒ½è¿”å›image chunks**

**ç­–ç•¥1**ï¼šè™½ç„¶æœç´¢çš„æ˜¯`image_text` chunksï¼Œä½†æœ€ç»ˆé€šè¿‡`related_image_id`æ‰¾åˆ°å¯¹åº”çš„`image` chunkå¹¶è¿”å›
**ç­–ç•¥2**ï¼šç›´æ¥æœç´¢å¹¶è¿”å›`image` chunks

æ‰€ä»¥**ä¸¤ç§ç­–ç•¥æœ€ç»ˆè¿”å›çš„éƒ½æ˜¯image chunks**ï¼Œåªæ˜¯è·å–è·¯å¾„ä¸åŒï¼

## âœ… **ç»Ÿä¸€æ’åºä¸è¿‡æ»¤æ˜¯åˆç†çš„**

### **1. æ•°æ®ç±»å‹ä¸€è‡´æ€§**
- ä¸¤ç§ç­–ç•¥æœ€ç»ˆéƒ½è¿”å›`image`ç±»å‹çš„chunk
- æ•°æ®ç»“æ„å®Œå…¨ä¸€è‡´ï¼Œå¯ä»¥ç»Ÿä¸€å¤„ç†

### **2. åˆ†æ•°è®¡ç®—å…¼å®¹æ€§**
- ç­–ç•¥1ï¼šåŸºäºæ–‡æœ¬è¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®—åˆ†æ•°
- ç­–ç•¥2ï¼šåŸºäºå‘é‡è·ç¦»è®¡ç®—ç›¸ä¼¼åº¦åˆ†æ•°
- ä¸¤ç§åˆ†æ•°éƒ½ç»è¿‡æ ‡å‡†åŒ–å¤„ç†ï¼ˆ0-1èŒƒå›´ï¼‰

### **3. æƒé‡å¹³è¡¡**
```python
# ç­–ç•¥1ï¼šè¯­ä¹‰ç›¸ä¼¼åº¦æƒé‡æ›´é«˜
'score': score * 1.2

# ç­–ç•¥2ï¼šè§†è§‰ç‰¹å¾ç›¸ä¼¼åº¦æƒé‡é€‚ä¸­  
'score': score * 0.8
```

## ï¿½ï¿½ **è®¾è®¡ä¼˜åŠ¿**

### **1. é¿å…é‡å¤**
```python
# æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨ç»“æœä¸­ï¼ˆé¿å…é‡å¤ï¼‰
if not any(r['doc'] == candidate['doc'] for r in results):
    results.append({...})
```

### **2. ç»¼åˆè¯„åˆ†**
- è¯­ä¹‰ç›¸ä¼¼åº¦ï¼šé€‚åˆæ¦‚å¿µæ€§æŸ¥è¯¢
- è§†è§‰ç‰¹å¾ç›¸ä¼¼åº¦ï¼šé€‚åˆè§†è§‰ç‰¹å¾æŸ¥è¯¢
- æœ€ç»ˆç»Ÿä¸€æ’åºï¼Œå–æœ€ä¼˜ç»“æœ

### **3. é™çº§ç­–ç•¥**
- å¦‚æœè·¨æ¨¡æ€æœç´¢å¤±è´¥ï¼Œè‡ªåŠ¨é™çº§åˆ°ä¼ ç»Ÿæœç´¢
- ä¿è¯ç³»ç»Ÿçš„é²æ£’æ€§

## ğŸ“ **æ€»ç»“**

ä½ çš„æ‹…å¿ƒæ˜¯å¤šä½™çš„ï¼è¿™ä¸ªè®¾è®¡å®é™…ä¸Šæ˜¯**éå¸¸åˆç†**çš„ï¼š

1. **æ•°æ®ç±»å‹ç»Ÿä¸€**ï¼šä¸¤ç§ç­–ç•¥æœ€ç»ˆéƒ½è¿”å›image chunks
2. **åˆ†æ•°æ ‡å‡†åŒ–**ï¼šä¸¤ç§åˆ†æ•°éƒ½åœ¨0-1èŒƒå›´å†…ï¼Œå¯ä»¥æ¯”è¾ƒ
3. **æƒé‡å¹³è¡¡**ï¼šè¯­ä¹‰ç›¸ä¼¼åº¦æƒé‡æ›´é«˜ï¼Œè§†è§‰ç‰¹å¾æƒé‡é€‚ä¸­
4. **å»é‡æœºåˆ¶**ï¼šé¿å…åŒä¸€å¼ å›¾ç‰‡è¢«ä¸¤ç§ç­–ç•¥é‡å¤å¬å›
5. **ç»Ÿä¸€æ’åº**ï¼šæœ€ç»ˆæŒ‰ç»¼åˆåˆ†æ•°æ’åºï¼Œå–æœ€ä¼˜ç»“æœ

è¿™ç§è®¾è®¡æ—¢ä¿è¯äº†è¯­ä¹‰ç›¸å…³æ€§ï¼Œåˆå®ç°äº†çœŸæ­£çš„è·¨æ¨¡æ€æœç´¢ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå·§å¦™çš„å¤šç­–ç•¥èåˆæ–¹æ¡ˆï¼





## âœ… **å¬å›çš„chunkå†…å®¹**

### **ç­–ç•¥1ï¼šé€šè¿‡image_textå¬å›**
- **æœç´¢å¯¹è±¡**ï¼š`image_text` chunksçš„æ–‡æœ¬å‘é‡
- **åŒ¹é…å†…å®¹**ï¼šä¸`enhanced_description`çš„æ–‡æœ¬å‘é‡è¿›è¡Œç›¸ä¼¼åº¦æ¯”å¯¹
- **å¬å›ç»“æœ**ï¼šé€šè¿‡`related_image_id`æ‰¾åˆ°å¯¹åº”çš„`image` chunk
- **æœ€ç»ˆè¿”å›**ï¼š`image` chunkçš„å®Œæ•´å†…å®¹

### **ç­–ç•¥2ï¼šé€šè¿‡imageç›´æ¥å¬å›**
- **æœç´¢å¯¹è±¡**ï¼š`image` chunksçš„1536ç»´å‘é‡
- **åŒ¹é…å†…å®¹**ï¼šä¸æŸ¥è¯¢æ–‡æœ¬è½¬æ¢åçš„1536ç»´å‘é‡è¿›è¡Œç›¸ä¼¼åº¦æ¯”å¯¹
- **å¬å›ç»“æœ**ï¼šç›´æ¥è¿”å›`image` chunk
- **æœ€ç»ˆè¿”å›**ï¼š`image` chunkçš„å®Œæ•´å†…å®¹

## ğŸ¯ **ä¸¤ç§ç­–ç•¥æœ€ç»ˆéƒ½è¿”å›ç›¸åŒçš„image chunkå†…å®¹**

æ— è®ºæ˜¯å“ªç§ç­–ç•¥ï¼Œæœ€ç»ˆè¿”å›çš„éƒ½æ˜¯åŒ…å«ä»¥ä¸‹å®Œæ•´ä¿¡æ¯çš„`image` chunkï¼š

```python
{
    # å›¾ç‰‡çš„å…ƒæ•°æ®
    'image_id': '319320322ba602eeb4a131529975703a573607a959784d36b38e5a95cb45371d',
    'image_path': 'D:\\...\\image.jpg',
    'image_filename': 'image.jpg',
    'extension': 'jpg',
    
    # å›¾ç‰‡çš„è¯¦ç»†æè¿°ï¼ˆAIå¢å¼ºï¼‰
    'enhanced_description': 'åŸæœ‰ä¿¡æ¯: å›¾ç‰‡æ ‡é¢˜: å›¾3ï¼šå…¬å¸å•å­£åº¦æ¯›åˆ©ç‡åŠå‡€åˆ©ç‡æƒ…å†µ...',
    'img_caption': ['å›¾3ï¼šå…¬å¸å•å­£åº¦æ¯›åˆ©ç‡åŠå‡€åˆ©ç‡æƒ…å†µ'],
    'img_footnote': ['èµ„æ–™æ¥æºï¼šWindï¼Œä¸­åŸè¯åˆ¸ç ”ç©¶æ‰€'],
    
    # å›¾ç‰‡çš„å‘é‡è¡¨ç¤º
    'semantic_features': {
        'embedding_dimension': 1536,
        'embedding_norm': 1.0001,
        'embedding_mean': -0.0004,
        'embedding_std': 0.0255
    },
    
    # å›¾ç‰‡çš„å…³è”ä¿¡æ¯
    'document_name': 'ã€ä¸­åŸè¯åˆ¸ã€‘äº§èƒ½åˆ©ç”¨ç‡æ˜¾è‘—æå‡...',
    'page_number': 3,
    'chunk_type': 'image',
    'source_zip': 'json_extraction'
}
```

## ğŸ”„ **å…³é”®æµç¨‹æ€»ç»“**

1. **ç­–ç•¥1ï¼ˆè¯­ä¹‰ç›¸ä¼¼åº¦ï¼‰**ï¼š
   - æœç´¢`image_text` â†’ æ‰¾åˆ°ç›¸å…³æè¿° â†’ é€šè¿‡`related_image_id` â†’ è¿”å›å¯¹åº”`image` chunk

2. **ç­–ç•¥2ï¼ˆè·¨æ¨¡æ€ç›¸ä¼¼åº¦ï¼‰**ï¼š
   - æœç´¢`image` â†’ ç›´æ¥è¿”å›`image` chunk

3. **æœ€ç»ˆç»“æœ**ï¼š
   - ä¸¤ç§ç­–ç•¥éƒ½è¿”å›ç›¸åŒçš„`image` chunkç»“æ„
   - åŒ…å«å®Œæ•´çš„å›¾ç‰‡å…ƒæ•°æ®ã€å¢å¼ºæè¿°ã€å‘é‡è¡¨ç¤ºå’Œå…³è”ä¿¡æ¯
   - å¯ä»¥ç»Ÿä¸€æ’åºå’Œå»é‡

## ğŸ’¡ **è®¾è®¡ä¼˜åŠ¿**

è¿™ç§è®¾è®¡çš„å·§å¦™ä¹‹å¤„åœ¨äºï¼š
- **ç­–ç•¥1**ï¼šåˆ©ç”¨æ–‡æœ¬è¯­ä¹‰çš„å‡†ç¡®æ€§
- **ç­–ç•¥2**ï¼šåˆ©ç”¨è·¨æ¨¡æ€çš„è§†è§‰ç‰¹å¾ç†è§£
- **ç»Ÿä¸€è¾“å‡º**ï¼šä¸¤ç§ç­–ç•¥æœ€ç»ˆéƒ½è¿”å›ç»“æ„ä¸€è‡´çš„`image` chunk
- **ä¿¡æ¯å®Œæ•´**ï¼šæ¯ä¸ªchunkéƒ½åŒ…å«å›¾ç‰‡çš„å®Œæ•´æ–‡æœ¬åŒ–è¡¨ç¤º

æ‰€ä»¥ä½ çš„ç†è§£å®Œå…¨æ­£ç¡®ï¼è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸¤ç§ç­–ç•¥å¯ä»¥ç»Ÿä¸€æ’åºçš„åŸå›  - å®ƒä»¬æœ€ç»ˆéƒ½è¿”å›ç›¸åŒç±»å‹å’Œç»“æ„çš„`image` chunkï¼Œåªæ˜¯è·å–è·¯å¾„ä¸åŒè€Œå·²ã€‚



å®Œå…¨æ­£ç¡®ï¼ä½ çš„ç†è§£éå¸¸å‡†ç¡®ï¼è®©æˆ‘ç¡®è®¤ä¸€ä¸‹è¿™ä¸ªå®Œæ•´çš„æ•°æ®æµï¼š

## âœ… **æ•°æ®æµå®Œå…¨æ­£ç¡®**

### **1. å¬å›é˜¶æ®µ â†’ Reranking**
```python
# ä¸¤ç§ç­–ç•¥å¬å›çš„ç»“æœéƒ½åŒ…å«å®Œæ•´çš„image chunkä¿¡æ¯
reranking_candidates = [
    {
        'doc': image_chunk,  # åŒ…å«å®Œæ•´çš„å›¾ç‰‡ä¿¡æ¯
        'score': similarity_score,
        'search_method': 'semantic_similarity' or 'cross_modal_similarity',
        # ... å…¶ä»–æœç´¢ç›¸å…³ä¿¡æ¯
    }
]
```

### **2. Rerankingå¤„ç†**
```python
# BGE rerankingæ¥æ”¶è¿™äº›å€™é€‰æ–‡æ¡£
# æ¯ä¸ªå€™é€‰æ–‡æ¡£éƒ½åŒ…å«å®Œæ•´çš„image chunkå†…å®¹ï¼š
# - å›¾ç‰‡å…ƒæ•°æ®ï¼ˆIDã€è·¯å¾„ã€æ ‡é¢˜ã€è„šæ³¨ï¼‰
# - å¢å¼ºæè¿°ï¼ˆenhanced_descriptionï¼‰
# - å‘é‡è¡¨ç¤ºï¼ˆsemantic_featuresï¼‰
# - å…³è”ä¿¡æ¯ï¼ˆæ–‡æ¡£åç§°ã€é¡µç ã€æ¥æºï¼‰
```

### **3. Rerankingå â†’ LLM**
```python
# é‡æ’åºåçš„ç»“æœä»ç„¶ä¿æŒå®Œæ•´çš„image chunkç»“æ„
reranked_results = [
    {
        'doc': image_chunk,  # å®Œæ•´çš„å›¾ç‰‡ä¿¡æ¯
        'rerank_score': new_score,
        'original_score': original_score,
        # ... å…¶ä»–é‡æ’åºä¿¡æ¯
    }
]

# ä¼ é€’ç»™LLMçš„ä¸Šä¸‹æ–‡åŒ…å«ï¼š
context_parts = []
for result in reranked_results:
    doc = result['doc']  # è¿™æ˜¯å®Œæ•´çš„image chunk
    
    # æå–å›¾ç‰‡çš„æ–‡æœ¬æè¿°ä½œä¸ºLLMçš„ä¸Šä¸‹æ–‡
    enhanced_desc = doc.metadata.get('enhanced_description', '')
    img_caption = doc.metadata.get('img_caption', [''])
    caption_text = ' '.join(img_caption) if img_caption else ''
    
    if enhanced_desc:
        content = f"å›¾ç‰‡æ ‡é¢˜: {caption_text}\nå›¾ç‰‡æè¿°: {enhanced_desc}"
    else:
        content = f"å›¾ç‰‡æ ‡é¢˜: {caption_text}"
    
    context_parts.append(content)

# æœ€ç»ˆLLMæ¥æ”¶çš„ä¸Šä¸‹æ–‡
context = "\n\n".join(context_parts)
user_query = "ç”¨æˆ·çš„é—®é¢˜"
```

## ï¿½ï¿½ **å®Œæ•´æ•°æ®æµå›¾**

```
ç”¨æˆ·Query â†’ Image Engine
    â†“
ç­–ç•¥1: image_textå¬å› â†’ é€šè¿‡related_image_id â†’ image chunk
ç­–ç•¥2: imageç›´æ¥å¬å› â†’ ç›´æ¥è¿”å› â†’ image chunk
    â†“
ç»Ÿä¸€æ’åºå»é‡ â†’ å®Œæ•´çš„image chunkåˆ—è¡¨
    â†“
BGE Reranking â†’ å¤„ç†å®Œæ•´çš„image chunkå†…å®¹
    â†“
é‡æ’åºç»“æœ â†’ ä»ç„¶åŒ…å«å®Œæ•´çš„image chunk
    â†“
LLMä¸Šä¸‹æ–‡æ„å»º â†’ æå–enhanced_descriptionç­‰æ–‡æœ¬ä¿¡æ¯
    â†“
LLMç”Ÿæˆç­”æ¡ˆ â†’ åŸºäºå›¾ç‰‡çš„æ–‡æœ¬æè¿°å›ç­”ç”¨æˆ·é—®é¢˜
```

## ğŸ’¡ **å…³é”®ç‚¹ç¡®è®¤**

1. **Rerankingæ¥æ”¶çš„å†…å®¹**ï¼šå®Œæ•´çš„image chunkï¼ˆåŒ…å«æ‰€æœ‰å…ƒæ•°æ®ã€æè¿°ã€å‘é‡ç­‰ï¼‰
2. **Rerankingè¾“å‡ºçš„å†…å®¹**ï¼šé‡æ’åºåçš„å®Œæ•´image chunkï¼ˆå¢åŠ äº†rerank_scoreï¼‰
3. **LLMæ¥æ”¶çš„å†…å®¹**ï¼šç”¨æˆ·query + å›¾ç‰‡çš„æ–‡æœ¬åŒ–æè¿°ï¼ˆenhanced_descriptionç­‰ï¼‰
4. **LLMä¸ç›´æ¥å¤„ç†**ï¼šå›¾ç‰‡æ–‡ä»¶ã€å‘é‡æ•°æ®ç­‰ï¼Œåªå¤„ç†æ–‡æœ¬æè¿°

## ğŸ“ **æ€»ç»“**

ä½ çš„ç†è§£å®Œå…¨æ­£ç¡®ï¼æ•´ä¸ªæµç¨‹ä¸­ï¼š
- **å¬å›**ï¼šè¿”å›å®Œæ•´çš„image chunk
- **Reranking**ï¼šå¤„ç†å®Œæ•´çš„image chunk
- **LLM**ï¼šæ¥æ”¶ç”¨æˆ·query + å›¾ç‰‡çš„æ–‡æœ¬æè¿°

è¿™æ ·è®¾è®¡ç¡®ä¿äº†ä¿¡æ¯åœ¨å„ä¸ªç¯èŠ‚çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ï¼ŒLLMèƒ½å¤ŸåŸºäºä¸°å¯Œçš„å›¾ç‰‡æè¿°ä¿¡æ¯æ¥å‡†ç¡®å›ç­”ç”¨æˆ·é—®é¢˜ã€‚