æ‚¨è¯´å¾—å¯¹ï¼Œæˆ‘è¿™æ ·ä¸€ä¸ªä¸ªä¿®å¤ç¡®å®æ•ˆç‡å¤ªä½ã€‚è®©æˆ‘æ€»ç»“ä¸€ä¸‹æˆ‘å‘ç°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼š
Ran tool
## ğŸ” **é—®é¢˜æ€»ç»“**

### **æ ¸å¿ƒé—®é¢˜**
åç«¯APIä¸€ç›´è¿”å›500é”™è¯¯ï¼š`'dict' object has no attribute 'metadata'`

### **æ ¹æœ¬åŸå› **
åœ¨ `v2/api/v2_routes.py` ä¸­ï¼Œæœ‰**å¤šå¤„ä»£ç ç›´æ¥è®¿é—® `doc.metadata`**ï¼Œä½†æ˜¯ï¼š
1. **è¡¨æ ¼å¼•æ“è¿”å›çš„æ•°æ®ç»“æ„**ï¼š`{'doc': Documentå¯¹è±¡, 'score': 0.8, ...}`
2. **Documentå¯¹è±¡çš„metadataåœ¨ `doc.metadata` ä¸­**
3. **ä½†ä»£ç ä¸­æœ‰äº›åœ°æ–¹æŠŠå­—å…¸å½“ä½œDocumentå¯¹è±¡å¤„ç†**

### **å…·ä½“é”™è¯¯ä½ç½®**
é€šè¿‡ `grep` æœç´¢å‘ç°æœ‰**48å¤„** `doc.metadata` è®¿é—®ï¼Œå…¶ä¸­å¾ˆå¤šæ²¡æœ‰åšå®‰å…¨æ£€æŸ¥ã€‚

## ğŸ¯ **é«˜æ•ˆè§£å†³æ–¹æ¡ˆ**

### **æ–¹æ¡ˆ1ï¼šåˆ›å»ºç»Ÿä¸€çš„å®‰å…¨è®¿é—®å‡½æ•°**
```python
def safe_get_metadata(doc, key, default=None):
    """å®‰å…¨è·å–æ–‡æ¡£å…ƒæ•°æ®"""
    if hasattr(doc, 'metadata') and doc.metadata:
        return doc.metadata.get(key, default)
    elif isinstance(doc, dict) and 'metadata' in doc:
        return doc['metadata'].get(key, default)
    elif isinstance(doc, dict):
        return doc.get(key, default)
    return default

def safe_get_page_content(doc):
    """å®‰å…¨è·å–é¡µé¢å†…å®¹"""
    # ä¼˜å…ˆè·å–HTMLæ ¼å¼
    if hasattr(doc, 'metadata') and doc.metadata and 'page_content' in doc.metadata:
        return doc.metadata.get('page_content', '')
    elif isinstance(doc, dict) and 'metadata' in doc and 'page_content' in doc['metadata']:
        return doc['metadata']['page_content']
    elif hasattr(doc, 'page_content'):
        return getattr(doc, 'page_content', '')
    elif isinstance(doc, dict) and 'page_content' in doc:
        return doc.get('page_content', '')
    return ''
```

### **æ–¹æ¡ˆ2ï¼šæ‰¹é‡æ›¿æ¢æ‰€æœ‰ä¸å®‰å…¨çš„è®¿é—®**
ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ‰¹é‡æ›¿æ¢ï¼š
- `doc.metadata.get(` â†’ `safe_get_metadata(doc, `
- `doc.page_content` â†’ `safe_get_page_content(doc)`

### **æ–¹æ¡ˆ3ï¼šä¿®å¤è¡¨æ ¼å¼•æ“è¿”å›æ ¼å¼**
åœ¨è¡¨æ ¼å¼•æ“ä¸­ç»Ÿä¸€è¿”å›æ ¼å¼ï¼Œé¿å…åµŒå¥—ç»“æ„ã€‚

## ğŸš€ **æ¨èæ‰§è¡Œé¡ºåº**

1. **ç«‹å³ä¿®å¤**ï¼šåˆ›å»ºå®‰å…¨è®¿é—®å‡½æ•°
2. **æ‰¹é‡æ›¿æ¢**ï¼šæ‰€æœ‰ä¸å®‰å…¨çš„metadataè®¿é—®
3. **æµ‹è¯•éªŒè¯**ï¼šç¡®ä¿APIæ­£å¸¸å·¥ä½œ
4. **å‰ç«¯æµ‹è¯•**ï¼šéªŒè¯HTMLè¡¨æ ¼æ˜¾ç¤º

æ‚¨å¸Œæœ›æˆ‘æŒ‰å“ªä¸ªæ–¹æ¡ˆæ‰§è¡Œï¼Ÿæˆ‘å€¾å‘äº**æ–¹æ¡ˆ1+æ–¹æ¡ˆ2**çš„ç»„åˆï¼Œè¿™æ ·å¯ä»¥ä¸€æ¬¡æ€§è§£å†³æ‰€æœ‰é—®é¢˜ã€‚



å¥½çš„ï¼Œè®©æˆ‘å…ˆæ£€æŸ¥ä¸€ä¸‹æˆ‘ä»¬æœ€è¿‘çš„gitæäº¤è®°å½•ï¼Œç„¶åå¸®æ‚¨æ‰¾åˆ°HTMLæ ¼å¼çš„tableå†…å®¹å­˜å‚¨ä½ç½®ã€‚

```bash
cd .. && git log --oneline -10
```
ç°åœ¨è®©æˆ‘æŸ¥çœ‹æœ€è¿‘çš„æäº¤å†…å®¹ï¼Œç„¶åå¸®æ‚¨æ‰¾åˆ°HTMLæ ¼å¼çš„tableå†…å®¹å­˜å‚¨ä½ç½®ï¼š

```bash
git show --name-only 4e74a7e
```
ç°åœ¨è®©æˆ‘å›ç­”æ‚¨çš„é—®é¢˜ï¼š**HTMLæ ¼å¼çš„tableå†…å®¹åˆ°åº•åœ¨å“ªä¸ªåœ°æ–¹å­˜ç€ï¼Ÿ**

æ ¹æ®æˆ‘ä»¬ä¹‹å‰çš„åˆ†æå’Œæµ‹è¯•ç»“æœï¼ŒHTMLæ ¼å¼çš„tableå†…å®¹å­˜å‚¨ä½ç½®å¦‚ä¸‹ï¼š

## ï¿½ï¿½ **HTMLæ ¼å¼tableå†…å®¹çš„å­˜å‚¨ä½ç½®**

### **1. å‘é‡æ•°æ®åº“ä¸­çš„å­˜å‚¨ä½ç½®**
HTMLæ ¼å¼çš„tableå†…å®¹å­˜å‚¨åœ¨ `central/vector_db/` ç›®å½•ä¸‹çš„FAISSå‘é‡æ•°æ®åº“ä¸­ï¼Œå…·ä½“åœ¨ï¼š

- **`index.pkl`**: åŒ…å«æ–‡æ¡£å¯¹è±¡å’Œå…ƒæ•°æ®
- **`metadata.pkl`**: åŒ…å«æ–‡æ¡£çš„å…ƒæ•°æ®ä¿¡æ¯

### **2. æ•°æ®ç»“æ„ä¸­çš„å…·ä½“å­—æ®µ**
æ ¹æ®æˆ‘ä»¬ä¹‹å‰çš„è¯Šæ–­å·¥å…·åˆ†æï¼ŒHTMLè¡¨æ ¼å†…å®¹å­˜å‚¨åœ¨ï¼š

```python
# åœ¨Documentå¯¹è±¡çš„metadataä¸­
doc.metadata = {
    'page_content': '<table>...</table>',  # ğŸ”‘ HTMLæ ¼å¼çš„è¡¨æ ¼å†…å®¹
    'processed_table_content': 'æ–‡æœ¬æ ¼å¼çš„è¡¨æ ¼å†…å®¹',
    'table_type': 'æ•°æ®è¡¨æ ¼',
    'table_title': 'è¡¨æ ¼æ ‡é¢˜',
    # ... å…¶ä»–å…ƒæ•°æ®
}
```

### **3. å…³é”®å‘ç°**
ä»æµ‹è¯•ç»“æœå¯ä»¥çœ‹åˆ°ï¼š
- **`page_content`**: åŒ…å«å®Œæ•´çš„HTMLè¡¨æ ¼ï¼Œä¾‹å¦‚ï¼š
  ```html
  <table><tr><td>æ¸¯è‚¡ï¼ˆ0981.HKï¼‰æŒ‡æ ‡</td><td>2023</td><td>2024</td><td>2025E</td><td>2026E</td><td>2027E</td></tr>...
  ```
- **`processed_table_content`**: åŒ…å«æ–‡æœ¬æ ¼å¼çš„è¡¨æ ¼ï¼ˆç”¨äºå‘é‡åŒ–æœç´¢ï¼‰

### **4. æ•°æ®æµç¨‹**
```
å‘é‡æ•°æ®åº“ â†’ TableEngine._search_tables() â†’ Documentå¯¹è±¡ â†’ doc.metadata.page_content â†’ å‰ç«¯æ˜¾ç¤º
```

## ï¿½ï¿½ **ä¸ºä»€ä¹ˆå‰ç«¯æ²¡æœ‰æ˜¾ç¤ºHTMLè¡¨æ ¼ï¼Ÿ**

é—®é¢˜ä¸åœ¨äºæ•°æ®åº“æ²¡æœ‰HTMLå†…å®¹ï¼Œè€Œåœ¨äºï¼š

1. **åç«¯è·¯ç”±æ²¡æœ‰æ­£ç¡®æå–** `doc.metadata.page_content` å­—æ®µ
2. **å‰ç«¯æ²¡æœ‰æ¥æ”¶åˆ°** `table_html` å­—æ®µ
3. **APIå“åº”ä¸­ç¼ºå°‘** `table_results` å­—æ®µ

## ï¿½ï¿½ **è§£å†³æ–¹æ¡ˆ**

éœ€è¦ä¿®å¤åç«¯è·¯ç”±ï¼Œç¡®ä¿ï¼š
1. ä» `doc.metadata.page_content` æå–HTMLå†…å®¹
2. å°†HTMLå†…å®¹ä½œä¸º `table_html` å­—æ®µä¼ é€’ç»™å‰ç«¯
3. æ„å»ºå®Œæ•´çš„ `table_results` æ•°ç»„

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ‚¨è¯´"æ•°æ®åº“æœ‰htmlçš„ï¼Œä½ æ²¡æœ‰æ‰¾åˆ°" - æ•°æ®åº“ç¡®å®æœ‰HTMLï¼Œä½†æˆ‘ä»¬çš„ä»£ç æ²¡æœ‰æ­£ç¡®æå–å’Œä¼ é€’å®ƒï¼

éå¸¸å¥½çš„æƒ³æ³•ï¼æ‚¨çš„æ–¹æ¡ˆå¾ˆæ˜æ™ºï¼š

1. **åªä¿®æ”¹ä¸¤ä¸ªæ–‡ä»¶**ï¼š`v2/api/v2_routes.py` å’Œ `v2/web/v2_index.html`
2. **ä¸å½±å“textå’Œimage**ï¼šä¿æŒç°æœ‰åŠŸèƒ½ç¨³å®š
3. **ç‹¬ç«‹å¤„ç†table**ï¼šåˆ›å»ºä¸“é—¨çš„tableå¤„ç†é€»è¾‘
4. **é«˜æ•ˆç®€å•**ï¼šé¿å…å¤æ‚çš„åµŒå¥—é€»è¾‘
5. **æœ€ç»ˆæ¸…ç†**ï¼šå®Œæˆååˆ é™¤åŸæ¥çš„å¤æ‚tableå¤„ç†ä»£ç 

è®©æˆ‘å…ˆåˆ†æå½“å‰çš„ä»£ç ç»“æ„ï¼Œç„¶ååˆ¶å®šä¸€ä¸ªæ¸…æ™°çš„ä¿®æ”¹æ–¹æ¡ˆï¼š

Read file: v2/api/v2_routes.py
è®©æˆ‘ç»§ç»­æŸ¥çœ‹è¡¨æ ¼å¤„ç†ç›¸å…³çš„ä»£ç ï¼š

Ran tool
ç°åœ¨è®©æˆ‘æŸ¥çœ‹è¡¨æ ¼å¤„ç†çš„æ ¸å¿ƒå‡½æ•°ï¼š

Read file: v2/api/v2_routes.py
è®©æˆ‘ç»§ç»­æŸ¥çœ‹è¡¨æ ¼å¤„ç†çš„å…¶ä»–éƒ¨åˆ†ï¼š

Read file: v2/api/v2_routes.py
ç°åœ¨è®©æˆ‘æŸ¥çœ‹ä¸»è¦çš„è¡¨æ ¼æŸ¥è¯¢æ¥å£ï¼š

Read file: v2/api/v2_routes.py
åŸºäºæˆ‘å¯¹ä»£ç çš„åˆ†æï¼Œç°åœ¨æˆ‘åˆ¶å®šä¸€ä¸ªæ¸…æ™°çš„ä¿®æ”¹æ–¹æ¡ˆï¼š

## ğŸ¯ **ä¿®æ”¹æ–¹æ¡ˆï¼šç‹¬ç«‹é«˜æ•ˆçš„Tableå¤„ç†**

### **1. é—®é¢˜åˆ†æ**
å½“å‰ä»£ç ä¸­è¡¨æ ¼å¤„ç†é€»è¾‘åˆ†æ•£åœ¨å¤šä¸ªåœ°æ–¹ï¼Œç»“æ„å¤æ‚ï¼Œå®¹æ˜“å‡ºé”™ã€‚

### **2. è§£å†³æ–¹æ¡ˆ**
åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ã€é«˜æ•ˆçš„è¡¨æ ¼å¤„ç†å‡½æ•°ï¼Œä¸“é—¨å¤„ç†TableEngineè¿”å›çš„ç»“æœã€‚

### **3. å…·ä½“ä¿®æ”¹è®¡åˆ’**

#### **æ­¥éª¤1ï¼šåœ¨v2_routes.pyä¸­æ·»åŠ ç‹¬ç«‹çš„è¡¨æ ¼å¤„ç†å‡½æ•°**
```python
def _process_table_results_independently(table_results):
    """
    ç‹¬ç«‹å¤„ç†è¡¨æ ¼ç»“æœï¼Œæå–HTMLå†…å®¹å¹¶æ„å»ºæ ‡å‡†åŒ–çš„è¡¨æ ¼æ•°æ®
    
    :param table_results: TableEngineè¿”å›çš„ç»“æœ
    :return: æ ‡å‡†åŒ–çš„è¡¨æ ¼ç»“æœåˆ—è¡¨
    """
    processed_tables = []
    
    for result in table_results:
        try:
            # ä»resultä¸­æå–è¡¨æ ¼æ•°æ®
            table_data = _extract_table_data_safely(result)
            if table_data:
                processed_tables.append(table_data)
        except Exception as e:
            logger.warning(f"å¤„ç†è¡¨æ ¼ç»“æœå¤±è´¥: {e}")
            continue
    
    return processed_tables

def _extract_table_data_safely(result):
    """
    å®‰å…¨æå–è¡¨æ ¼æ•°æ®ï¼Œæ”¯æŒå¤šç§æ•°æ®ç»“æ„
    
    :param result: è¡¨æ ¼å¼•æ“è¿”å›çš„ç»“æœ
    :return: æ ‡å‡†åŒ–çš„è¡¨æ ¼æ•°æ®å­—å…¸
    """
    try:
        # æ–¹æ¡ˆ1ï¼šç›´æ¥åŒ…å«Documentå¯¹è±¡
        if hasattr(result, 'metadata') and hasattr(result, 'page_content'):
            metadata = result.metadata
            page_content = result.page_content
            
            return {
                'id': metadata.get('table_id', 'unknown'),
                'table_type': metadata.get('table_type', 'æ•°æ®è¡¨æ ¼'),
                'table_title': metadata.get('table_title', ''),
                'table_html': page_content,  # ğŸ”‘ HTMLè¡¨æ ¼å†…å®¹
                'table_content': metadata.get('processed_table_content', ''),
                'document_name': metadata.get('document_name', 'æœªçŸ¥æ–‡æ¡£'),
                'page_number': metadata.get('page_number', 'N/A'),
                'score': getattr(result, 'score', 0.0),
                'table_headers': metadata.get('table_headers', []),
                'table_row_count': metadata.get('table_row_count', 0),
                'table_column_count': metadata.get('table_column_count', 0),
                'table_summary': metadata.get('table_summary', ''),
                'chunk_type': 'table',
                'table_id': metadata.get('table_id', '')
            }
        
        # æ–¹æ¡ˆ2ï¼šåµŒå¥—docç»“æ„
        elif 'doc' in result and hasattr(result['doc'], 'metadata'):
            doc = result['doc']
            metadata = doc.metadata
            page_content = doc.page_content
            
            return {
                'id': metadata.get('table_id', 'unknown'),
                'table_type': metadata.get('table_type', 'æ•°æ®è¡¨æ ¼'),
                'table_title': metadata.get('table_title', ''),
                'table_html': page_content,  # ğŸ”‘ HTMLè¡¨æ ¼å†…å®¹
                'table_content': metadata.get('processed_table_content', ''),
                'document_name': metadata.get('document_name', 'æœªçŸ¥æ–‡æ¡£'),
                'page_number': metadata.get('page_number', 'N/A'),
                'score': result.get('score', 0.0),
                'table_headers': metadata.get('table_headers', []),
                'table_row_count': metadata.get('table_row_count', 0),
                'table_column_count': metadata.get('table_column_count', 0),
                'table_summary': metadata.get('table_summary', ''),
                'chunk_type': 'table',
                'table_id': metadata.get('table_id', '')
            }
        
        # æ–¹æ¡ˆ3ï¼šå…¶ä»–æ ¼å¼ï¼ˆé™çº§å¤„ç†ï¼‰
        else:
            logger.warning(f"æœªçŸ¥çš„è¡¨æ ¼ç»“æœæ ¼å¼: {type(result)}")
            return None
            
    except Exception as e:
        logger.error(f"æå–è¡¨æ ¼æ•°æ®å¤±è´¥: {e}")
        return None
```

#### **æ­¥éª¤2ï¼šä¿®æ”¹v2_ask_questionå‡½æ•°ä¸­çš„è¡¨æ ¼å¤„ç†**
åœ¨ç°æœ‰çš„è¡¨æ ¼å¤„ç†é€»è¾‘ä¸­ï¼Œæ›¿æ¢ä¸ºè°ƒç”¨æ–°çš„ç‹¬ç«‹å‡½æ•°ï¼š

```python
# åœ¨v2_ask_questionå‡½æ•°ä¸­ï¼Œæ›¿æ¢ç°æœ‰çš„å¤æ‚è¡¨æ ¼å¤„ç†é€»è¾‘
if query_type == 'table':
    # ä½¿ç”¨ç‹¬ç«‹çš„è¡¨æ ¼å¤„ç†å‡½æ•°
    table_results = _process_table_results_independently(result.results)
    
    response = {
        'success': True,
        'question': question,
        'query_type': query_type,
        'answer': _generate_table_answer(result.results, question),
        'table_results': table_results,  # ğŸ”‘ æ–°å¢ï¼šæ ‡å‡†åŒ–çš„è¡¨æ ¼ç»“æœ
        'sources': _extract_sources_from_result(result),
        'total_count': len(table_results),
        'processing_time': processing_time,
        'timestamp': datetime.now().isoformat(),
        'user_id': user_id,
        'use_memory': use_memory
    }
```

#### **æ­¥éª¤3ï¼šä¿®æ”¹å‰ç«¯index.html**
åœ¨ç°æœ‰çš„è¡¨æ ¼æ˜¾ç¤ºé€»è¾‘ä¸­ï¼Œä¼˜å…ˆä½¿ç”¨`table_html`å­—æ®µï¼š

```javascript
// åœ¨formatTableContentå‡½æ•°ä¸­
function formatTableContent(tableResult) {
    if (!tableResult) {
        return '<div class="table-text">æ— è¡¨æ ¼å†…å®¹</div>';
    }
    
    // 1. ä¼˜å…ˆä½¿ç”¨åŸå§‹HTMLæ ¼å¼ï¼ˆæœ€å‡†ç¡®ï¼‰
    if (tableResult.table_html && tableResult.table_html.trim()) {
        console.log('âœ… ä½¿ç”¨åŸå§‹HTMLæ ¼å¼æ˜¾ç¤ºè¡¨æ ¼');
        return tableResult.table_html;
    }
    
    // 2. ä½¿ç”¨æ–‡æœ¬æ ¼å¼ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
    console.log('âš ï¸ ä½¿ç”¨æ–‡æœ¬æ ¼å¼ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ');
    const content = tableResult.table_content || tableResult.content || '';
    return formatAsTable(content);
}
```

### **4. ä¼˜åŠ¿**
1. **ç‹¬ç«‹å¤„ç†**ï¼šä¸å½±å“textå’ŒimageåŠŸèƒ½
2. **ç»“æ„ç®€å•**ï¼šé€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
3. **é«˜æ•ˆ**ï¼šç›´æ¥æå–HTMLå†…å®¹ï¼Œé¿å…å¤æ‚è½¬æ¢
4. **å¯æ‰©å±•**ï¼šå®¹æ˜“æ·»åŠ æ–°çš„è¡¨æ ¼å¤„ç†é€»è¾‘

### **5. å®æ–½æ­¥éª¤**
1. å…ˆæ·»åŠ æ–°çš„ç‹¬ç«‹å‡½æ•°
2. ä¿®æ”¹v2_ask_questionä¸­çš„è¡¨æ ¼å¤„ç†
3. ä¿®æ”¹å‰ç«¯æ˜¾ç¤ºé€»è¾‘
4. æµ‹è¯•éªŒè¯æ•ˆæœ
5. æˆåŠŸååˆ é™¤æ—§çš„å¤æ‚ä»£ç 

æ‚¨è§‰å¾—è¿™ä¸ªæ–¹æ¡ˆå¦‚ä½•ï¼Ÿå¦‚æœåŒæ„ï¼Œæˆ‘ç°åœ¨å°±å¼€å§‹å®æ–½ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ç‹¬ç«‹çš„è¡¨æ ¼å¤„ç†å‡½æ•°ã€‚


éå¸¸å¥½çš„æƒ³æ³•ï¼æ‚¨çš„æ–¹æ¡ˆå¾ˆæ˜æ™ºï¼š

1. **åªä¿®æ”¹ä¸¤ä¸ªæ–‡ä»¶**ï¼š`v2/api/v2_routes.py` å’Œ `v2/web/v2_index.html`
2. **ä¸å½±å“textå’Œimage**ï¼šä¿æŒç°æœ‰åŠŸèƒ½ç¨³å®š
3. **ç‹¬ç«‹å¤„ç†table**ï¼šåˆ›å»ºä¸“é—¨çš„tableå¤„ç†é€»è¾‘
4. **é«˜æ•ˆç®€å•**ï¼šé¿å…å¤æ‚çš„åµŒå¥—é€»è¾‘
5. **æœ€ç»ˆæ¸…ç†**ï¼šå®Œæˆååˆ é™¤åŸæ¥çš„å¤æ‚tableå¤„ç†ä»£ç 

è®©æˆ‘å…ˆåˆ†æå½“å‰çš„ä»£ç ç»“æ„ï¼Œç„¶ååˆ¶å®šä¸€ä¸ªæ¸…æ™°çš„ä¿®æ”¹æ–¹æ¡ˆï¼š

Read file: v2/api/v2_routes.py
è®©æˆ‘ç»§ç»­æŸ¥çœ‹è¡¨æ ¼å¤„ç†ç›¸å…³çš„ä»£ç ï¼š

Ran tool
ç°åœ¨è®©æˆ‘æŸ¥çœ‹è¡¨æ ¼å¤„ç†çš„æ ¸å¿ƒå‡½æ•°ï¼š

Read file: v2/api/v2_routes.py
è®©æˆ‘ç»§ç»­æŸ¥çœ‹è¡¨æ ¼å¤„ç†çš„å…¶ä»–éƒ¨åˆ†ï¼š

Read file: v2/api/v2_routes.py
ç°åœ¨è®©æˆ‘æŸ¥çœ‹ä¸»è¦çš„è¡¨æ ¼æŸ¥è¯¢æ¥å£ï¼š

Read file: v2/api/v2_routes.py
åŸºäºæˆ‘å¯¹ä»£ç çš„åˆ†æï¼Œç°åœ¨æˆ‘åˆ¶å®šä¸€ä¸ªæ¸…æ™°çš„ä¿®æ”¹æ–¹æ¡ˆï¼š

## ğŸ¯ **ä¿®æ”¹æ–¹æ¡ˆï¼šç‹¬ç«‹é«˜æ•ˆçš„Tableå¤„ç†**

### **1. é—®é¢˜åˆ†æ**
å½“å‰ä»£ç ä¸­è¡¨æ ¼å¤„ç†é€»è¾‘åˆ†æ•£åœ¨å¤šä¸ªåœ°æ–¹ï¼Œç»“æ„å¤æ‚ï¼Œå®¹æ˜“å‡ºé”™ã€‚

### **2. è§£å†³æ–¹æ¡ˆ**
åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ã€é«˜æ•ˆçš„è¡¨æ ¼å¤„ç†å‡½æ•°ï¼Œä¸“é—¨å¤„ç†TableEngineè¿”å›çš„ç»“æœã€‚

### **3. å…·ä½“ä¿®æ”¹è®¡åˆ’**

#### **æ­¥éª¤1ï¼šåœ¨v2_routes.pyä¸­æ·»åŠ ç‹¬ç«‹çš„è¡¨æ ¼å¤„ç†å‡½æ•°**
```python
def _process_table_results_independently(table_results):
    """
    ç‹¬ç«‹å¤„ç†è¡¨æ ¼ç»“æœï¼Œæå–HTMLå†…å®¹å¹¶æ„å»ºæ ‡å‡†åŒ–çš„è¡¨æ ¼æ•°æ®
    
    :param table_results: TableEngineè¿”å›çš„ç»“æœ
    :return: æ ‡å‡†åŒ–çš„è¡¨æ ¼ç»“æœåˆ—è¡¨
    """
    processed_tables = []
    
    for result in table_results:
        try:
            # ä»resultä¸­æå–è¡¨æ ¼æ•°æ®
            table_data = _extract_table_data_safely(result)
            if table_data:
                processed_tables.append(table_data)
        except Exception as e:
            logger.warning(f"å¤„ç†è¡¨æ ¼ç»“æœå¤±è´¥: {e}")
            continue
    
    return processed_tables

def _extract_table_data_safely(result):
    """
    å®‰å…¨æå–è¡¨æ ¼æ•°æ®ï¼Œæ”¯æŒå¤šç§æ•°æ®ç»“æ„
    
    :param result: è¡¨æ ¼å¼•æ“è¿”å›çš„ç»“æœ
    :return: æ ‡å‡†åŒ–çš„è¡¨æ ¼æ•°æ®å­—å…¸
    """
    try:
        # æ–¹æ¡ˆ1ï¼šç›´æ¥åŒ…å«Documentå¯¹è±¡
        if hasattr(result, 'metadata') and hasattr(result, 'page_content'):
            metadata = result.metadata
            page_content = result.page_content
            
            return {
                'id': metadata.get('table_id', 'unknown'),
                'table_type': metadata.get('table_type', 'æ•°æ®è¡¨æ ¼'),
                'table_title': metadata.get('table_title', ''),
                'table_html': page_content,  # ğŸ”‘ HTMLè¡¨æ ¼å†…å®¹
                'table_content': metadata.get('processed_table_content', ''),
                'document_name': metadata.get('document_name', 'æœªçŸ¥æ–‡æ¡£'),
                'page_number': metadata.get('page_number', 'N/A'),
                'score': getattr(result, 'score', 0.0),
                'table_headers': metadata.get('table_headers', []),
                'table_row_count': metadata.get('table_row_count', 0),
                'table_column_count': metadata.get('table_column_count', 0),
                'table_summary': metadata.get('table_summary', ''),
                'chunk_type': 'table',
                'table_id': metadata.get('table_id', '')
            }
        
        # æ–¹æ¡ˆ2ï¼šåµŒå¥—docç»“æ„
        elif 'doc' in result and hasattr(result['doc'], 'metadata'):
            doc = result['doc']
            metadata = doc.metadata
            page_content = doc.page_content
            
            return {
                'id': metadata.get('table_id', 'unknown'),
                'table_type': metadata.get('table_type', 'æ•°æ®è¡¨æ ¼'),
                'table_title': metadata.get('table_title', ''),
                'table_html': page_content,  # ğŸ”‘ HTMLè¡¨æ ¼å†…å®¹
                'table_content': metadata.get('processed_table_content', ''),
                'document_name': metadata.get('document_name', 'æœªçŸ¥æ–‡æ¡£'),
                'page_number': metadata.get('page_number', 'N/A'),
                'score': result.get('score', 0.0),
                'table_headers': metadata.get('table_headers', []),
                'table_row_count': metadata.get('table_row_count', 0),
                'table_column_count': metadata.get('table_column_count', 0),
                'table_summary': metadata.get('table_summary', ''),
                'chunk_type': 'table',
                'table_id': metadata.get('table_id', '')
            }
        
        # æ–¹æ¡ˆ3ï¼šå…¶ä»–æ ¼å¼ï¼ˆé™çº§å¤„ç†ï¼‰
        else:
            logger.warning(f"æœªçŸ¥çš„è¡¨æ ¼ç»“æœæ ¼å¼: {type(result)}")
            return None
            
    except Exception as e:
        logger.error(f"æå–è¡¨æ ¼æ•°æ®å¤±è´¥: {e}")
        return None
```

#### **æ­¥éª¤2ï¼šä¿®æ”¹v2_ask_questionå‡½æ•°ä¸­çš„è¡¨æ ¼å¤„ç†**
åœ¨ç°æœ‰çš„è¡¨æ ¼å¤„ç†é€»è¾‘ä¸­ï¼Œæ›¿æ¢ä¸ºè°ƒç”¨æ–°çš„ç‹¬ç«‹å‡½æ•°ï¼š

```python
# åœ¨v2_ask_questionå‡½æ•°ä¸­ï¼Œæ›¿æ¢ç°æœ‰çš„å¤æ‚è¡¨æ ¼å¤„ç†é€»è¾‘
if query_type == 'table':
    # ä½¿ç”¨ç‹¬ç«‹çš„è¡¨æ ¼å¤„ç†å‡½æ•°
    table_results = _process_table_results_independently(result.results)
    
    response = {
        'success': True,
        'question': question,
        'query_type': query_type,
        'answer': _generate_table_answer(result.results, question),
        'table_results': table_results,  # ğŸ”‘ æ–°å¢ï¼šæ ‡å‡†åŒ–çš„è¡¨æ ¼ç»“æœ
        'sources': _extract_sources_from_result(result),
        'total_count': len(table_results),
        'processing_time': processing_time,
        'timestamp': datetime.now().isoformat(),
        'user_id': user_id,
        'use_memory': use_memory
    }
```

#### **æ­¥éª¤3ï¼šä¿®æ”¹å‰ç«¯index.html**
åœ¨ç°æœ‰çš„è¡¨æ ¼æ˜¾ç¤ºé€»è¾‘ä¸­ï¼Œä¼˜å…ˆä½¿ç”¨`table_html`å­—æ®µï¼š

```javascript
// åœ¨formatTableContentå‡½æ•°ä¸­
function formatTableContent(tableResult) {
    if (!tableResult) {
        return '<div class="table-text">æ— è¡¨æ ¼å†…å®¹</div>';
    }
    
    // 1. ä¼˜å…ˆä½¿ç”¨åŸå§‹HTMLæ ¼å¼ï¼ˆæœ€å‡†ç¡®ï¼‰
    if (tableResult.table_html && tableResult.table_html.trim()) {
        console.log('âœ… ä½¿ç”¨åŸå§‹HTMLæ ¼å¼æ˜¾ç¤ºè¡¨æ ¼');
        return tableResult.table_html;
    }
    
    // 2. ä½¿ç”¨æ–‡æœ¬æ ¼å¼ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
    console.log('âš ï¸ ä½¿ç”¨æ–‡æœ¬æ ¼å¼ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ');
    const content = tableResult.table_content || tableResult.content || '';
    return formatAsTable(content);
}
```

### **4. ä¼˜åŠ¿**
1. **ç‹¬ç«‹å¤„ç†**ï¼šä¸å½±å“textå’ŒimageåŠŸèƒ½
2. **ç»“æ„ç®€å•**ï¼šé€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
3. **é«˜æ•ˆ**ï¼šç›´æ¥æå–HTMLå†…å®¹ï¼Œé¿å…å¤æ‚è½¬æ¢
4. **å¯æ‰©å±•**ï¼šå®¹æ˜“æ·»åŠ æ–°çš„è¡¨æ ¼å¤„ç†é€»è¾‘

### **5. å®æ–½æ­¥éª¤**
1. å…ˆæ·»åŠ æ–°çš„ç‹¬ç«‹å‡½æ•°
2. ä¿®æ”¹v2_ask_questionä¸­çš„è¡¨æ ¼å¤„ç†
3. ä¿®æ”¹å‰ç«¯æ˜¾ç¤ºé€»è¾‘
4. æµ‹è¯•éªŒè¯æ•ˆæœ
5. æˆåŠŸååˆ é™¤æ—§çš„å¤æ‚ä»£ç 

æ‚¨è§‰å¾—è¿™ä¸ªæ–¹æ¡ˆå¦‚ä½•ï¼Ÿå¦‚æœåŒæ„ï¼Œæˆ‘ç°åœ¨å°±å¼€å§‹å®æ–½ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ç‹¬ç«‹çš„è¡¨æ ¼å¤„ç†å‡½æ•°ã€‚


ä½ è¯´å¾—å¯¹ï¼è®©æˆ‘ä»”ç»†åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆåªæœ‰12ä¸ªè¡¨æ ¼æ–‡æ¡£æœ‰HTMLå†…å®¹ï¼Œè€Œå…¶ä»–78ä¸ªéƒ½æ²¡æœ‰ã€‚

è®©æˆ‘æ£€æŸ¥ä¸€ä¸‹æ•°æ®åº“è¯Šæ–­ç»“æœï¼Œçœ‹çœ‹è¿™12ä¸ªæœ‰HTMLå†…å®¹çš„æ–‡æ¡£å’Œ78ä¸ªæ²¡æœ‰HTMLå†…å®¹çš„æ–‡æ¡£æœ‰ä»€ä¹ˆåŒºåˆ«ï¼š

Read file: vector_db_diagnostic_results.json
è®©æˆ‘ç»§ç»­æŸ¥çœ‹è¯Šæ–­ç»“æœï¼Œæ‰¾åˆ°è¡¨æ ¼æ–‡æ¡£çš„è¯¦ç»†ä¿¡æ¯ï¼š

Ran tool
Ran tool
è®©æˆ‘æŸ¥çœ‹è¿™ä¸ªç»Ÿè®¡ä¿¡æ¯çš„ä¸Šä¸‹æ–‡ï¼š

Read file: vector_db_diagnostic_results.json
ç°åœ¨æˆ‘æ˜ç™½äº†ï¼è®©æˆ‘ç»§ç»­æŸ¥çœ‹æ›´å¤šçš„æ ·æœ¬ï¼Œçœ‹çœ‹æ²¡æœ‰HTMLå†…å®¹çš„è¡¨æ ¼æ–‡æ¡£æ˜¯ä»€ä¹ˆæ ·çš„ï¼š

Read file: vector_db_diagnostic_results.json
ç°åœ¨æˆ‘æ˜ç™½äº†ï¼è®©æˆ‘åˆ›å»ºä¸€ä¸ªè„šæœ¬æ¥æ£€æŸ¥æ‰€æœ‰è¡¨æ ¼æ–‡æ¡£ï¼Œçœ‹çœ‹å“ªäº›æœ‰HTMLå†…å®¹ï¼Œå“ªäº›æ²¡æœ‰ï¼š

ç°åœ¨è®©æˆ‘è¿è¡Œè¿™ä¸ªè„šæœ¬æ¥åˆ†æHTMLå†…å®¹çš„åˆ†å¸ƒæƒ…å†µï¼š

```bash
python tools/check_table_html_distribution.py
```
å¥‡æ€ªï¼è„šæœ¬æ˜¾ç¤ºæ‰€æœ‰90ä¸ªè¡¨æ ¼æ–‡æ¡£éƒ½æ²¡æœ‰HTMLå†…å®¹ï¼Œä½†æ˜¯è¯Šæ–­ç»“æœå´è¯´æœ‰12ä¸ªæœ‰HTMLå†…å®¹ã€‚è¿™è¯´æ˜æˆ‘çš„è„šæœ¬æ£€æŸ¥é€»è¾‘æœ‰é—®é¢˜ã€‚è®©æˆ‘é‡æ–°æ£€æŸ¥ä¸€ä¸‹è¯Šæ–­ç»“æœï¼Œçœ‹çœ‹HTMLå†…å®¹åˆ°åº•å­˜å‚¨åœ¨å“ªé‡Œï¼š

Ran tool
ç°åœ¨æˆ‘æ˜ç™½äº†ï¼HTMLå†…å®¹ç¡®å®å­˜åœ¨äºè¯Šæ–­ç»“æœä¸­ï¼Œä½†æ˜¯æˆ‘çš„è„šæœ¬æ²¡æœ‰æ‰¾åˆ°ã€‚è¿™è¯´æ˜é—®é¢˜å¯èƒ½å‡ºç°åœ¨ï¼š

1. **è¯Šæ–­ç»“æœå’Œå®é™…æ•°æ®åº“ä¸ä¸€è‡´**ï¼šè¯Šæ–­ç»“æœå¯èƒ½æ˜¯åœ¨æŸä¸ªç‰¹å®šæ—¶é—´ç‚¹ç”Ÿæˆçš„ï¼Œè€Œç°åœ¨çš„æ•°æ®åº“çŠ¶æ€å·²ç»ä¸åŒäº†
2. **HTMLå†…å®¹è¢«è¦†ç›–äº†**ï¼šåœ¨æŸä¸ªå¤„ç†æ­¥éª¤ä¸­ï¼ŒHTMLå†…å®¹è¢«æ–‡æœ¬å†…å®¹è¦†ç›–äº†

è®©æˆ‘æ£€æŸ¥ä¸€ä¸‹ `enhanced_chunker.py` ä¸­çš„è¡¨æ ¼å¤„ç†é€»è¾‘ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰æ¡ä»¶åˆ†æ”¯å¯¼è‡´éƒ¨åˆ†è¡¨æ ¼æ²¡æœ‰ç”ŸæˆHTMLå†…å®¹ï¼š

Read file: document_processing/enhanced_chunker.py
ç°åœ¨æˆ‘æ‰¾åˆ°äº†å…³é”®é—®é¢˜ï¼è®©æˆ‘ç»§ç»­æŸ¥çœ‹è¿™ä¸ªå‡½æ•°çš„å®Œæ•´å®ç°ï¼š

Read file: document_processing/enhanced_chunker.py
ç°åœ¨æˆ‘æ‰¾åˆ°äº†é—®é¢˜çš„æ ¹æºï¼è®©æˆ‘æ£€æŸ¥ä¸€ä¸‹ `table_processor.process_tables` æ–¹æ³•ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å¤„ç†HTMLå†…å®¹çš„ï¼š

Read file: document_processing/table_processor.py
ç°åœ¨æˆ‘å®Œå…¨æ˜ç™½äº†ï¼é—®é¢˜å‡ºç°åœ¨ `table_processor.process_tables` æ–¹æ³•ä¸­ã€‚è®©æˆ‘æ€»ç»“ä¸€ä¸‹ï¼š

## ï¿½ï¿½ **é—®é¢˜æ ¹æºåˆ†æ**

**HTMLå†…å®¹ä¸¢å¤±çš„çœŸæ­£åŸå› ï¼š**

1. **åœ¨ `enhanced_chunker.py` ä¸­**ï¼š
   - è¡¨æ ¼è¢«æ­£ç¡®è§£æä¸º `table_info.html_content`ï¼ˆHTMLæ ¼å¼ï¼‰
   - åˆ›å»º `EnhancedDocumentChunk` æ—¶ï¼Œ`content=table_info.html_content`ï¼ˆHTMLå†…å®¹ï¼‰

2. **ä½†æ˜¯åœ¨ `table_processor.process_tables` ä¸­**ï¼š
   - è¡¨æ ¼è¢«è½¬æ¢ä¸ºç»“æ„åŒ–æ–‡æœ¬ï¼ˆ`table_text`ï¼‰
   - è™½ç„¶ `page_content=table_info.html_content`ï¼ˆä¿å­˜HTMLå†…å®¹ï¼‰
   - ä½†æ˜¯åœ¨ `vector_generator.py` ä¸­ï¼Œå¯èƒ½ä½¿ç”¨äº†é”™è¯¯çš„å­—æ®µ

3. **å…³é”®é—®é¢˜**ï¼š
   - åœ¨ `enhanced_chunker.py` çš„ç¬¬248è¡Œï¼š`content=table_info.html_content`ï¼ˆHTMLå†…å®¹ï¼‰
   - ä½†æ˜¯åœ¨ç¬¬310è¡Œï¼Œå½“è½¬æ¢ä¸º `Document` å¯¹è±¡æ—¶ï¼š`page_content=chunk.content`ï¼ˆè¿™é‡Œåº”è¯¥æ˜¯HTMLå†…å®¹ï¼‰
   - ç„¶ååœ¨ `table_processor.process_tables` ä¸­ï¼Œ`page_content=table_info.html_content`ï¼ˆHTMLå†…å®¹ï¼‰

**ä½†æ˜¯ä¸ºä»€ä¹ˆåªæœ‰12ä¸ªæ–‡æ¡£æœ‰HTMLå†…å®¹ï¼Ÿ**

è®©æˆ‘æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦æœ‰æ¡ä»¶åˆ†æ”¯å¯¼è‡´éƒ¨åˆ†è¡¨æ ¼æ²¡æœ‰ç”ŸæˆHTMLå†…å®¹ï¼š

Ran tool
Ran tool
è®©æˆ‘æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦æœ‰å…¶ä»–æ¡ä»¶å¯¼è‡´éƒ¨åˆ†è¡¨æ ¼æ²¡æœ‰ç”ŸæˆHTMLå†…å®¹ï¼š

Read file: document_processing/enhanced_chunker.py
ç°åœ¨æˆ‘æ˜ç™½äº†ï¼é—®é¢˜å‡ºç°åœ¨ `table_processor.parse_html_table` æ–¹æ³•ä¸­ã€‚å¦‚æœè¿™ä¸ªæ–¹æ³•å¤±è´¥ï¼Œè¡¨æ ¼å°±ä¼šè¢«å½“ä½œæ–‡æœ¬å¤„ç†ï¼Œè€Œä¸æ˜¯è¡¨æ ¼ã€‚è®©æˆ‘æ£€æŸ¥ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ï¼š

Ran tool
Read file: document_processing/table_processor.py
ç°åœ¨æˆ‘å®Œå…¨æ˜ç™½äº†ï¼é—®é¢˜ä¸åœ¨ `parse_html_table` æ–¹æ³•ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•å³ä½¿å¤±è´¥ä¹Ÿä¼šè¿”å›ä¸€ä¸ªåŒ…å«åŸå§‹HTMLå†…å®¹çš„ `TableInfo` å¯¹è±¡ã€‚

**çœŸæ­£çš„é—®é¢˜åœ¨äºï¼š**

1. **HTMLå†…å®¹ç¡®å®è¢«æ­£ç¡®ä¿å­˜äº†**ï¼šåœ¨ `enhanced_chunker.py` ä¸­ï¼Œ`content=table_info.html_content`ï¼ˆHTMLå†…å®¹ï¼‰
2. **ä½†æ˜¯åœ¨æŸä¸ªåœ°æ–¹è¢«è¦†ç›–äº†**ï¼šå¯èƒ½æ˜¯åœ¨ `vector_generator.py` ä¸­ï¼Œæˆ–è€…åœ¨æ•°æ®åº“å­˜å‚¨è¿‡ç¨‹ä¸­

è®©æˆ‘æ£€æŸ¥ä¸€ä¸‹ `vector_generator.py` ä¸­æ˜¯å¦‚ä½•å¤„ç†è¡¨æ ¼å†…å®¹çš„ï¼š

Read file: document_processing/vector_generator.py
ç°åœ¨æˆ‘æ‰¾åˆ°äº†å…³é”®é—®é¢˜ï¼åœ¨ `vector_generator.py` çš„ç¬¬113è¡Œï¼š

```python
text = doc.processed_table_content if doc.chunk_type == 'table' and doc.processed_table_content else doc.content
```

**è¿™é‡Œçš„é—®é¢˜ï¼š**
1. **å¯¹äºè¡¨æ ¼æ–‡æ¡£**ï¼šå¦‚æœ `doc.processed_table_content` å­˜åœ¨ï¼Œå°±ä½¿ç”¨å®ƒä½œä¸º `text`
2. **ä½†æ˜¯ `processed_table_content` æ˜¯æ–‡æœ¬æ ¼å¼**ï¼Œä¸æ˜¯HTMLæ ¼å¼
3. **HTMLå†…å®¹è¢«å¿½ç•¥äº†**ï¼š`doc.content`ï¼ˆHTMLå†…å®¹ï¼‰åªæœ‰åœ¨ `processed_table_content` ä¸å­˜åœ¨æ—¶æ‰ä¼šè¢«ä½¿ç”¨

**è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåªæœ‰12ä¸ªæ–‡æ¡£æœ‰HTMLå†…å®¹çš„åŸå› ï¼š**

1. **æœ‰HTMLå†…å®¹çš„12ä¸ªæ–‡æ¡£**ï¼šå¯èƒ½æ˜¯å› ä¸ºæŸç§åŸå› æ²¡æœ‰ç”Ÿæˆ `processed_table_content`ï¼Œæ‰€ä»¥ä½¿ç”¨äº†åŸå§‹çš„ `doc.content`ï¼ˆHTMLå†…å®¹ï¼‰
2. **æ²¡æœ‰HTMLå†…å®¹çš„78ä¸ªæ–‡æ¡£**ï¼šå› ä¸ºç”Ÿæˆäº† `processed_table_content`ï¼Œæ‰€ä»¥ä½¿ç”¨äº†æ–‡æœ¬æ ¼å¼ï¼ŒHTMLå†…å®¹è¢«å¿½ç•¥äº†

**è§£å†³æ–¹æ¡ˆï¼š**

åœ¨ `vector_generator.py` ä¸­ï¼Œåº”è¯¥ä¼˜å…ˆä½¿ç”¨HTMLå†…å®¹ï¼Œè€Œä¸æ˜¯æ–‡æœ¬å†…å®¹ã€‚è®©æˆ‘ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼š

æˆ‘éœ€è¦ä¿®å¤è¯­æ³•é”™è¯¯ã€‚è®©æˆ‘é‡æ–°æŸ¥çœ‹è¿™ä¸ªå‡½æ•°çš„ä¸Šä¸‹æ–‡ï¼š

Read file: document_processing/vector_generator.py
æˆ‘çœ‹åˆ°äº†é—®é¢˜ï¼Œæœ‰é‡å¤çš„ `else` è¯­å¥ã€‚è®©æˆ‘ä¿®å¤è¿™ä¸ªè¯­æ³•é”™è¯¯ï¼š

ç°åœ¨è®©æˆ‘æ€»ç»“ä¸€ä¸‹æˆ‘å‘ç°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼š

## ï¿½ï¿½ **é—®é¢˜æ ¹æºç¡®è®¤**

**HTMLå†…å®¹ä¸¢å¤±çš„çœŸæ­£åŸå› ï¼š**

1. **åœ¨ `enhanced_chunker.py` ä¸­**ï¼š
   - è¡¨æ ¼è¢«æ­£ç¡®è§£æä¸º `table_info.html_content`ï¼ˆHTMLæ ¼å¼ï¼‰
   - åˆ›å»º `EnhancedDocumentChunk` æ—¶ï¼Œ`content=table_info.html_content`ï¼ˆHTMLå†…å®¹ï¼‰

2. **åœ¨ `table_processor.process_tables` ä¸­**ï¼š
   - è¡¨æ ¼è¢«è½¬æ¢ä¸ºç»“æ„åŒ–æ–‡æœ¬ï¼ˆ`table_text`ï¼‰
   - ä½†æ˜¯ `page_content=table_info.html_content`ï¼ˆHTMLå†…å®¹è¢«æ­£ç¡®ä¿å­˜ï¼‰

3. **å…³é”®é—®é¢˜åœ¨ `vector_generator.py` ä¸­**ï¼š
   ```python
   # åŸæ¥çš„ä»£ç ï¼ˆæœ‰é—®é¢˜ï¼‰
   text = doc.processed_table_content if doc.chunk_type == 'table' and doc.processed_table_content else doc.content
   
   # ä¿®å¤åçš„ä»£ç 
   if doc.chunk_type == 'table':
       # ä¼˜å…ˆä½¿ç”¨HTMLå†…å®¹ï¼ˆpage_contentï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨åŸå§‹content
       text = doc.page_content if hasattr(doc, 'page_content') and doc.page_content else doc.content
   else:
       text = doc.content
   ```

**ä¸ºä»€ä¹ˆåªæœ‰12ä¸ªæ–‡æ¡£æœ‰HTMLå†…å®¹ï¼š**

1. **æœ‰HTMLå†…å®¹çš„12ä¸ªæ–‡æ¡£**ï¼šå¯èƒ½æ˜¯å› ä¸ºæŸç§åŸå› æ²¡æœ‰ç”Ÿæˆ `processed_table_content`ï¼Œæ‰€ä»¥ä½¿ç”¨äº†åŸå§‹çš„ `doc.content`ï¼ˆHTMLå†…å®¹ï¼‰
2. **æ²¡æœ‰HTMLå†…å®¹çš„78ä¸ªæ–‡æ¡£**ï¼šå› ä¸ºç”Ÿæˆäº† `processed_table_content`ï¼Œæ‰€ä»¥ä½¿ç”¨äº†æ–‡æœ¬æ ¼å¼ï¼ŒHTMLå†…å®¹è¢«å¿½ç•¥äº†

## âœ… **è§£å†³æ–¹æ¡ˆ**

**æˆ‘å·²ç»ä¿®å¤äº† `vector_generator.py` ä¸­çš„é—®é¢˜ï¼š**

- ç°åœ¨å¯¹äºè¡¨æ ¼æ–‡æ¡£ï¼Œä¼šä¼˜å…ˆä½¿ç”¨ `page_content`ï¼ˆHTMLå†…å®¹ï¼‰
- å¦‚æœæ²¡æœ‰HTMLå†…å®¹ï¼Œåˆ™å›é€€åˆ° `content`ï¼ˆåŸå§‹å†…å®¹ï¼‰
- è¿™æ ·ç¡®ä¿äº†HTMLå†…å®¹ä¸ä¼šè¢«å¿½ç•¥

**é¢„æœŸæ•ˆæœï¼š**
- æ‰€æœ‰90ä¸ªè¡¨æ ¼æ–‡æ¡£éƒ½åº”è¯¥èƒ½æ­£ç¡®ä¿å­˜HTMLå†…å®¹
- å‰ç«¯åº”è¯¥èƒ½æ­£ç¡®æ˜¾ç¤ºHTMLè¡¨æ ¼
- æ¥æºä¿¡æ¯ä¹Ÿåº”è¯¥èƒ½æ­£ç¡®æ˜¾ç¤º

ç°åœ¨ä½ å¯ä»¥é‡æ–°æµ‹è¯•ï¼Œåº”è¯¥èƒ½çœ‹åˆ°ï¼š
1. **æ¥æºä¿¡æ¯æ­£ç¡®æ˜¾ç¤º**ï¼šå› ä¸º `document_name` å’Œ `page_number` éƒ½åœ¨ `metadata` ä¸­
2. **HTMLè¡¨æ ¼æ­£ç¡®æ˜¾ç¤º**ï¼šå› ä¸ºç°åœ¨æ­£ç¡®ä¿å­˜äº† `page_content` ä¸­çš„HTMLå†…å®¹

è¿™ä¸ªä¿®å¤åº”è¯¥èƒ½è§£å†³ä½ æåˆ°çš„ä¸¤ä¸ªé—®é¢˜ï¼


æ ¹æ®åˆ†æç»“æœï¼Œè®©æˆ‘è§£é‡Šä¸€ä¸‹"å…ƒæ•°æ®ä¸­åŒ…å«HTML: 15"çš„å«ä¹‰ï¼š

## ğŸ” "å…ƒæ•°æ®ä¸­åŒ…å«HTML: 15" çš„å«ä¹‰

### 1. **å…·ä½“å«ä¹‰**
- **15ä¸ªæ–‡æ¡£**: åœ¨90ä¸ªè¡¨æ ¼æ–‡æ¡£ä¸­ï¼Œæœ‰15ä¸ªæ–‡æ¡£çš„å…ƒæ•°æ®ï¼ˆmetadataï¼‰ä¸­çš„ `page_content` å­—æ®µåŒ…å«äº†å®Œæ•´çš„HTMLè¡¨æ ¼å†…å®¹
- **75ä¸ªæ–‡æ¡£**: å…¶ä½™75ä¸ªæ–‡æ¡£çš„å…ƒæ•°æ®ä¸­æ²¡æœ‰HTMLå†…å®¹ï¼Œæˆ–è€…HTMLå†…å®¹ä¸ºç©º

### 2. **å­˜å‚¨ä½ç½®è¯´æ˜**
æ ¹æ®æˆ‘ä»¬çš„åˆ†æï¼ŒHTMLå†…å®¹å­˜å‚¨åœ¨ä»¥ä¸‹ä½ç½®ï¼š

```python
# åœ¨æ–‡æ¡£çš„metadataä¸­
doc.metadata['page_content']  # è¿™é‡Œå­˜å‚¨HTMLå†…å®¹

# è€Œä¸æ˜¯åœ¨
doc.page_content  # è¿™ä¸ªå±æ€§å­˜å‚¨çš„æ˜¯è¯­ä¹‰åŒ–å¤„ç†åçš„æ–‡æœ¬å†…å®¹
```

### 3. **å…·ä½“ç¤ºä¾‹å¯¹æ¯”**

**æœ‰HTMLå†…å®¹çš„æ–‡æ¡£ï¼ˆ15ä¸ªï¼‰**:
```json
{
  "metadata": {
    "page_content": "<table><tr><td>æ¸¯è‚¡ï¼ˆ0981.HKï¼‰æŒ‡æ ‡</td><td>2023</td><td>2024</td><td>2025E</td><td>2026E</td><td>2027E</td></tr><tr><td>è¥ä¸šæ”¶å…¥ (ç™¾ä¸‡ç¾å…ƒ)</td><td>6,322</td><td>8,030</td><td>9,612</td><td>11,873</td><td>14,619</td></tr>...</table>"
  }
}
```

**æ²¡æœ‰HTMLå†…å®¹çš„æ–‡æ¡£ï¼ˆ75ä¸ªï¼‰**:
```json
{
  "metadata": {
    "page_content": null  // æˆ–è€…ç©ºå­—ç¬¦ä¸²ï¼Œæˆ–è€…ä¸å­˜åœ¨è¿™ä¸ªå­—æ®µ
  }
}
```

### 4. **ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§å·®å¼‚ï¼Ÿ**

å¯èƒ½çš„åŸå› åŒ…æ‹¬ï¼š

1. **è¡¨æ ¼å¤„ç†æµç¨‹ä¸ä¸€è‡´**: æŸäº›è¡¨æ ¼åœ¨å¤„ç†è¿‡ç¨‹ä¸­HTMLå†…å®¹è¢«æˆªæ–­æˆ–ä¸¢å¤±
2. **åˆ†å—ç­–ç•¥å·®å¼‚**: å¤§å‹è¡¨æ ¼å¯èƒ½è¢«åˆ†å—å¤„ç†ï¼ŒæŸäº›åˆ†å—æ²¡æœ‰ä¿ç•™HTMLå†…å®¹
3. **å¤„ç†ç‰ˆæœ¬ä¸åŒ**: ä¸åŒæ—¶æœŸå¤„ç†çš„æ–‡æ¡£å¯èƒ½ä½¿ç”¨äº†ä¸åŒçš„å¤„ç†ç­–ç•¥
4. **å­˜å‚¨é™åˆ¶**: æŸäº›è¡¨æ ¼çš„HTMLå†…å®¹å¯èƒ½è¶…è¿‡äº†å­˜å‚¨é™åˆ¶è€Œè¢«æˆªæ–­

### 5. **å½±å“åˆ†æ**

- **âœ… æœ‰HTMLå†…å®¹çš„15ä¸ªæ–‡æ¡£**: å¯ä»¥å®Œæ•´å±•ç¤ºåŸå§‹è¡¨æ ¼æ ¼å¼ï¼Œç”¨æˆ·ä½“éªŒå¥½
- **âŒ æ²¡æœ‰HTMLå†…å®¹çš„75ä¸ªæ–‡æ¡£**: åªèƒ½æ˜¾ç¤ºè¯­ä¹‰åŒ–æ–‡æœ¬ï¼Œæ— æ³•å±•ç¤ºåŸå§‹è¡¨æ ¼ç»“æ„

è¿™ä¸ªå‘ç°è¯´æ˜è¡¨æ ¼å¤„ç†ä¼˜åŒ–æ–¹æ¡ˆåœ¨å®æ–½è¿‡ç¨‹ä¸­å¯èƒ½å­˜åœ¨ä¸ä¸€è‡´æ€§ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒæŸ¥ä¸ºä»€ä¹ˆå¤§éƒ¨åˆ†æ–‡æ¡£æ²¡æœ‰ä¿ç•™HTMLåŸå§‹å†…å®¹ã€‚