
## ğŸš€ **æŸ¥è¯¢æ„å›¾è¯†åˆ«åˆ°å®Œæˆå¬å›çš„å®Œæ•´å®ç°è¿‡ç¨‹ - V2.0å¢å¼ºç‰ˆ**

### **æ•´ä½“æµç¨‹æ¶æ„**

```
ç”¨æˆ·æŸ¥è¯¢ â†’ æŸ¥è¯¢æ„å›¾åˆ†æ â†’ å¼•æ“é€‰æ‹© â†’ å¬å›æ‰§è¡Œ â†’ ç»“æœèåˆ â†’ ä¼˜åŒ–ç®¡é“
    â†“           â†“           â†“         â†“         â†“         â†“
æ™ºèƒ½æŸ¥è¯¢ â†’ QueryIntentAnalyzer â†’ å¼•æ“è·¯ç”± â†’ å¤šç­–ç•¥å¬å› â†’ ç»“æœåˆå¹¶ â†’ é‡æ’åº+è¿‡æ»¤
    â†“           â†“           â†“         â†“         â†“         â†“
ç»Ÿä¸€æ–‡æ¡£åŠ è½½ â†’ å†…å­˜ä¼˜åŒ–æœç´¢ â†’ å¹¶è¡Œå¬å› â†’ æ™ºèƒ½èåˆ â†’ ä¼˜åŒ–ç®¡é“ â†’ ç»“æœéªŒè¯
```

### **1. ğŸ§  æŸ¥è¯¢æ„å›¾è¯†åˆ«é˜¶æ®µ**

#### **1.1 QueryIntentAnalyzer æ ¸å¿ƒé€»è¾‘**

```python
class QueryIntentAnalyzer:
    def analyze_intent_with_confidence(self, query: str) -> Dict[str, Any]:
        # 1. è®¡ç®—å„æ„å›¾çš„åˆ†æ•°
        intent_scores = self._calculate_intent_scores(query_lower)
        
        # 2. æ£€æµ‹æ··åˆæ„å›¾
        has_hybrid_intent = self._detect_hybrid_intent(query_lower)
        
        # 3. æ£€æµ‹ä¸šåŠ¡é¢†åŸŸ
        detected_domain = self._detect_business_domain(query_lower)
        
        # 4. æ£€æµ‹å¤æ‚åº¦
        complexity = self._detect_complexity(query_lower)
        
        # 5. åšå‡ºæœ€ç»ˆæ„å›¾å†³ç­–
        final_intent = self._make_intent_decision(...)
        
        # 6. è®¡ç®—ç½®ä¿¡åº¦
        confidence = self._calculate_confidence(...)
        
        return {
            'primary_intent': final_intent,
            'confidence': confidence,
            'intent_scores': intent_scores,
            'detected_domain': detected_domain,
            'complexity': complexity
        }
```

#### **1.2 æ„å›¾å…³é”®è¯æ˜ å°„**

```python
self.intent_keywords = {
    'image': ['å›¾ç‰‡', 'å›¾åƒ', 'ç…§ç‰‡', 'å›¾è¡¨', 'å¯è§†åŒ–', 'å›¾', 'ç”»', 'icon', 'image', 'picture', 'chart', 'figure'],
    'text': ['æ–‡æœ¬', 'æ–‡æ¡£', 'å†…å®¹', 'æè¿°', 'è¯´æ˜', 'æ–‡å­—', 'æ–‡ç« ', 'text', 'document', 'content'],
    'table': ['è¡¨æ ¼', 'æ•°æ®', 'ç»Ÿè®¡', 'æ•°å­—', 'åˆ—è¡¨', 'è¡¨', 'æ•°æ®è¡¨', 'table', 'data', 'statistics'],
    'hybrid': ['æ··åˆ', 'ç»¼åˆ', 'å…¨éƒ¨', 'æ‰€æœ‰', 'hybrid', 'mixed', 'all', 'comprehensive']
}
```

### **2. ğŸ”§ ç»Ÿä¸€æ–‡æ¡£åŠ è½½ç®¡ç†é˜¶æ®µ - V2.0æ–°å¢**

#### **2.1 DocumentLoader æ ¸å¿ƒæ¶æ„**

```python
class DocumentLoader:
    """ç»Ÿä¸€æ–‡æ¡£åŠ è½½ç®¡ç†å™¨ - è§£å†³é‡å¤åŠ è½½é—®é¢˜"""
    
    def __init__(self, vector_store, max_retries: int = 3):
        self.vector_store = vector_store
        self._docs_cache = {}  # ç»Ÿä¸€ç¼“å­˜
        self._loaded = False
        self._load_time = 0.0
        self._max_retries = max_retries
        self._retry_count = 0
    
    def load_all_documents(self, force_reload: bool = False) -> Dict[str, Dict[str, Any]]:
        """ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ–‡æ¡£ï¼ŒæŒ‰ç±»å‹åˆ†ç±»"""
        if self._loaded and not force_reload:
            return self._docs_cache
        
        # æŒ‰ç±»å‹åˆ†ç±»åŠ è½½
        docs_by_type = {
            'text': {},
            'image': {},
            'table': {},
            'hybrid': {}
        }
        
        # ä¸€æ¬¡æ€§éå†å‘é‡æ•°æ®åº“ï¼ŒæŒ‰chunk_typeåˆ†ç±»
        for doc_id, doc in self.vector_store.docstore._dict.items():
            chunk_type = doc.metadata.get('chunk_type', 'text')
            if chunk_type in docs_by_type:
                docs_by_type[chunk_type][doc_id] = doc
            else:
                docs_by_type['text'][doc_id] = doc  # æœªçŸ¥ç±»å‹å½’ç±»åˆ°text
        
        # æ›´æ–°ç¼“å­˜å’ŒçŠ¶æ€
        self._docs_cache = docs_by_type
        self._loaded = True
        
        return self._docs_cache
```

**ç»Ÿä¸€æ–‡æ¡£åŠ è½½çš„ä¼˜åŠ¿**ï¼š
- **è§£å†³é‡å¤åŠ è½½**ï¼šé¿å…æ¯ä¸ªå¼•æ“é‡å¤åŠ è½½ç›¸åŒæ–‡æ¡£
- **å†…å­˜ä¼˜åŒ–**ï¼šç»Ÿä¸€ç¼“å­˜ç®¡ç†ï¼Œå‡å°‘å†…å­˜å ç”¨
- **å¯åŠ¨æ€§èƒ½æå‡**ï¼šä¸€æ¬¡æ€§åŠ è½½ï¼Œé¿å…å¤šæ¬¡I/Oæ“ä½œ
- **ç±»å‹åˆ†ç±»ç®¡ç†**ï¼šæŒ‰chunk_typeè‡ªåŠ¨åˆ†ç±»ï¼Œæ”¯æŒé™çº§ç­–ç•¥
- **é”™è¯¯é‡è¯•æœºåˆ¶**ï¼šæ”¯æŒåŠ è½½å¤±è´¥æ—¶çš„è‡ªåŠ¨é‡è¯•
- **çŠ¶æ€ç›‘æ§**ï¼šæä¾›æ–‡æ¡£ç»Ÿè®¡ä¿¡æ¯å’ŒåŠ è½½çŠ¶æ€ç›‘æ§

#### **2.2 å‘åå…¼å®¹æ€§æ”¯æŒ**

```python
def _load_from_document_loader(self):
    """ä»ç»Ÿä¸€æ–‡æ¡£åŠ è½½å™¨åŠ è½½æ–‡æ¡£"""
    if self.document_loader:
        try:
            all_docs = self.document_loader.load_all_documents()
            self.text_docs = all_docs.get('text', {})
            self._docs_loaded = True
            self.logger.info(f"ä»ç»Ÿä¸€æ–‡æ¡£åŠ è½½å™¨åŠ è½½äº† {len(self.text_docs)} ä¸ªæ–‡æœ¬æ–‡æ¡£")
        except Exception as e:
            self.logger.warning(f"ç»Ÿä¸€æ–‡æ¡£åŠ è½½å¤±è´¥: {e}ï¼Œé™çº§åˆ°ä¼ ç»ŸåŠ è½½æ–¹å¼")
            self._load_text_documents()
    else:
        # é™çº§åˆ°ä¼ ç»ŸåŠ è½½æ–¹å¼
        self._load_text_documents()

def _validate_config(self):
    """éªŒè¯æ–‡æœ¬å¼•æ“é…ç½® - æ”¯æŒä¸¤ç§é…ç½®ç±»å‹"""
    # æ”¯æŒä¸¤ç§é…ç½®ç±»å‹ï¼šTextEngineConfig å’Œ TextEngineConfigV2
    from ..config.v2_config import TextEngineConfigV2
    
    if not isinstance(self.config, (TextEngineConfig, TextEngineConfigV2)):
        raise ValueError("é…ç½®å¿…é¡»æ˜¯TextEngineConfigæˆ–TextEngineConfigV2ç±»å‹")
    
    # è·å–ç›¸ä¼¼åº¦é˜ˆå€¼ï¼Œæ”¯æŒä¸¤ç§é…ç½®ç±»å‹
    threshold = getattr(self.config, 'text_similarity_threshold', 0.7)
    if threshold < 0 or threshold > 1:
        raise ValueError("æ–‡æœ¬ç›¸ä¼¼åº¦é˜ˆå€¼å¿…é¡»åœ¨0-1ä¹‹é—´")
```

### **3. ğŸ” å¬å›æ‰§è¡Œé˜¶æ®µ - V2.0ä¼˜åŒ–ç‰ˆ**

#### **3.1 æ–‡æœ¬æŸ¥è¯¢å¬å›è¿‡ç¨‹ - å†…å­˜ä¼˜åŒ–ç‰ˆ**

```python
class TextEngine(BaseEngine):
    def _search_texts(self, query: str, **kwargs) -> List[Any]:
        """æ™ºèƒ½æ–‡æœ¬æœç´¢ - V2.0å¢å¼ºç‰ˆï¼ˆå†…å­˜ä¼˜åŒ–ï¼‰"""
        results = []
        
        # ç­–ç•¥1: ä¼˜å…ˆä½¿ç”¨å·²åŠ è½½çš„æ–‡æœ¬æ–‡æ¡£è¿›è¡Œæœç´¢
        if self.text_docs:
            for doc_id, doc in self.text_docs.items():
                score = self._calculate_text_score(doc, query)
                if score >= self.config.text_similarity_threshold:
                    results.append({
                        'doc_id': doc_id,
                        'doc': doc,
                        'score': score,
                        'match_type': 'text_doc_search'
                    })
        
        # ç­–ç•¥2: å†…å­˜å®½æ¾æœç´¢ï¼ˆV2.0ä¼˜åŒ–ï¼šç­–ç•¥2æ”¹ä¸ºå†…å­˜æœç´¢ï¼‰
        if not results and self.text_docs:
            self.logger.debug("ç­–ç•¥1æ— ç»“æœï¼Œå¯ç”¨ç­–ç•¥2ï¼šå†…å­˜å®½æ¾æœç´¢")
            
            for doc_id, doc in self.text_docs.items():
                # ä½¿ç”¨å®½æ¾çš„è¯„åˆ†ç®—æ³•
                score = self._calculate_text_score_relaxed(doc, query)
                
                # é™ä½é˜ˆå€¼ï¼Œä½¿ç”¨æ›´å®½æ¾çš„åŒ¹é…æ¡ä»¶
                relaxed_threshold = self.config.text_similarity_threshold * 0.5
                if score >= relaxed_threshold:
                    results.append({
                        'doc_id': doc_id,
                        'doc': doc,
                        'score': score,
                        'match_type': 'memory_relaxed_search'
                    })
        
        # ç­–ç•¥3: å…³é”®è¯æœç´¢
        if not results:
            keyword_results = self._keyword_search(query)
            results.extend(keyword_results)
        
        # ç­–ç•¥4: æ¨¡ç³Šæœç´¢ï¼ˆä»…é™ä¸­èŠ¯å›½é™…ç›¸å…³æŸ¥è¯¢ï¼‰
        if not results:
            fuzzy_results = self._fuzzy_search(query)
            results.extend(fuzzy_results)
        
        # ç­–ç•¥5: å†…å­˜ä½é˜ˆå€¼æœç´¢ï¼ˆV2.0æ–°å¢ï¼‰
        if not results and self.config.text_similarity_threshold > 0.05 and self.text_docs:
            self.logger.debug("ç­–ç•¥5ï¼šåœ¨å†…å­˜ä¸­é™ä½é˜ˆå€¼é‡æ–°æœç´¢...")
            original_threshold = self.config.text_similarity_threshold
            self.config.text_similarity_threshold = 0.05
            
            # åœ¨å†…å­˜ä¸­æ–‡æ¡£ä¸­é‡æ–°æœç´¢
            for doc_id, doc in self.text_docs.items():
                score = self._calculate_text_score(doc, query)
                if score >= self.config.text_similarity_threshold:
                    results.append({...})
            
            # æ¢å¤åŸå§‹é˜ˆå€¼
            self.config.text_similarity_threshold = original_threshold
        
        return self._deduplicate_and_sort(results)
```

**V2.0æ–‡æœ¬å¬å›ä¼˜åŒ–ç‰¹ç‚¹**ï¼š
- **å†…å­˜ä¼˜å…ˆç­–ç•¥**ï¼šç­–ç•¥2æ”¹ä¸ºå†…å­˜æœç´¢ï¼Œé¿å…é‡å¤å‘é‡æ•°æ®åº“è®¿é—®
- **æ™ºèƒ½é˜ˆå€¼è°ƒæ•´**ï¼šç­–ç•¥5åœ¨å†…å­˜ä¸­é™ä½é˜ˆå€¼é‡æ–°æœç´¢
- **æ€§èƒ½æå‡**ï¼šå‡å°‘I/Oæ“ä½œï¼Œæå‡æœç´¢å“åº”é€Ÿåº¦
- **å‘åå…¼å®¹**ï¼šæ”¯æŒé™çº§åˆ°ä¼ ç»ŸåŠ è½½æ–¹å¼

#### **3.2 å›¾ç‰‡æŸ¥è¯¢å¬å›è¿‡ç¨‹**

```python
class ImageEngine(BaseEngine):
    def _search_images(self, query: str, intent: Dict[str, Any], **kwargs) -> List[Any]:
        results = []
        
        # ç¬¬ä¸€æ­¥ï¼šå›¾å·è¿‡æ»¤ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
        if intent['figure_numbers']:
            filtered_by_number = self._filter_by_figure_number(intent['figure_numbers'])
            if filtered_by_number:
                # åœ¨è¿‡æ»¤åçš„å›¾ç‰‡ä¸­è¿›è¡Œå†…å®¹ç²¾ç¡®åŒ¹é…
                results = self._content_precise_match(query, filtered_by_number, intent)
                return results
        
        # ç¬¬äºŒæ­¥ï¼šä¸€èˆ¬å†…å®¹æœç´¢
        results = self._general_content_search(query, intent)
        
        # ç¬¬ä¸‰æ­¥ï¼šè°ƒæ•´ç»“æœæ•°é‡
        max_results = self._adjust_result_count(intent)
        final_results = results[:max_results]
        return final_results
```

#### **3.3 è¡¨æ ¼æŸ¥è¯¢å¬å›è¿‡ç¨‹**

```python
class TableEngine(BaseEngine):
    def _search_tables(self, query: str, intent: Dict[str, Any], **kwargs) -> List[Any]:
        results = []
        
        # ç­–ç•¥1: ç²¾ç¡®å…³é”®è¯åŒ¹é…ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
        if intent['keywords']:
            for doc_id, doc in self.table_docs.items():
                score = self._calculate_table_score(doc, query, intent)
                if score >= self.config.table_similarity_threshold:
                    results.append({...})
        
        # ç­–ç•¥2: ä¸šåŠ¡é¢†åŸŸåŒ¹é…ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
        if intent['business_domain'] != 'general':
            domain_results = self._search_by_business_domain(query, intent)
            results.extend(domain_results)
        
        # ç­–ç•¥3: è¡¨æ ¼ç±»å‹åŒ¹é…ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
        if intent['table_types']:
            type_results = self._search_by_table_type(query, intent)
            results.extend(type_results)
        
        # ç­–ç•¥4: å‘é‡æœç´¢ï¼ˆä½ä¼˜å…ˆçº§ï¼Œä½œä¸ºåå¤‡ï¼‰
        if not results and hasattr(self.vector_store, 'similarity_search'):
            similar_docs = self.vector_store.similarity_search(query, k=20)
            for doc in similar_docs:
                if doc.metadata.get('chunk_type') == 'table':
                    score = self._calculate_table_score(doc, query, intent)
                    if score >= self.config.table_similarity_threshold * 0.8:
                        results.append({...})
        
        # ç­–ç•¥5: æ™ºèƒ½æ¨¡ç³Šæœç´¢ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰
        if not results:
            fuzzy_results = self._smart_fuzzy_search(query, intent)
            results.extend(fuzzy_results)
        
        return self._deduplicate_results(results)
```

#### **3.4 æ··åˆæŸ¥è¯¢å¬å›è¿‡ç¨‹ - V2.0ä¿®å¤ç‰ˆ**

```python
def _execute_parallel_queries(self, query: str, query_intent: str, **kwargs) -> Dict[str, Any]:
    """å¹¶è¡Œæ‰§è¡Œå¤šä¸ªå¼•æ“æŸ¥è¯¢ - V2.0ä¿®å¤ç‰ˆ"""
    query_results = {}
    
    with ThreadPoolExecutor(max_workers=4) as executor:
        # æäº¤æŸ¥è¯¢ä»»åŠ¡
        future_to_engine = {}
        
        if self.image_engine and getattr(self.hybrid_config, 'enable_image_search', True):
            future = executor.submit(self._execute_single_query, self.image_engine, query, **kwargs)
            future_to_engine[future] = 'image'
        
        if self.text_engine and getattr(self.hybrid_config, 'enable_text_search', True):
            future = executor.submit(self._execute_single_query, self.text_engine, query, **kwargs)
            future_to_engine[future] = 'text'
        
        if self.table_engine and getattr(self.hybrid_config, 'enable_table_search', True):
            future = executor.submit(self._execute_single_query, self.table_engine, query, **kwargs)
            future_to_engine[future] = 'table'
        
        # æ”¶é›†ç»“æœ
        for future in as_completed(future_to_engine):
            engine_name = future_to_engine[future]
            try:
                result = future.result()
                query_results[engine_name] = result
                self.logger.info(f"å¼•æ“ {engine_name} æŸ¥è¯¢å®Œæˆ")
            except Exception as e:
                self.logger.error(f"å¼•æ“ {engine_name} æŸ¥è¯¢å¤±è´¥: {str(e)}")
                query_results[engine_name] = []
    
    return query_results
```

**V2.0æ··åˆæŸ¥è¯¢ä¿®å¤**ï¼š
- **å‚æ•°ä¼ é€’ä¿®å¤**ï¼šä¿®å¤hybridæŸ¥è¯¢å‚æ•°ä¼ é€’é—®é¢˜
- **å¹¶è¡Œæ‰§è¡Œä¼˜åŒ–**ï¼šä½¿ç”¨ThreadPoolExecutoræå‡æ€§èƒ½
- **å¼‚å¸¸å®¹é”™å¢å¼º**ï¼šå•ä¸ªå¼•æ“å¤±è´¥ä¸å½±å“å…¶ä»–å¼•æ“
- **é…ç½®å…¼å®¹æ€§**ï¼šæ”¯æŒenable_*_searché…ç½®å¼€å…³

### **4. ğŸ¯ æ™ºèƒ½æŸ¥è¯¢åŠŸèƒ½ - V2.0å·²å®Œæˆå®ç°**

#### **4.1 æ™ºèƒ½æŸ¥è¯¢è·¯ç”±æœºåˆ¶**

```python
elif query_type == 'smart':
    # ä½¿ç”¨ QueryIntentAnalyzer è¿›è¡Œæ™ºèƒ½æ„å›¾åˆ†æ
    intent_result = intent_analyzer.analyze_intent_with_confidence(question)
    detected_type = intent_result['primary_intent']
    
    # æ ¹æ®æ£€æµ‹åˆ°çš„ç±»å‹æ‰§è¡ŒæŸ¥è¯¢
    if detected_type == 'image':
        result = hybrid_engine.process_query(question, query_type=QueryType.IMAGE, max_results=max_results)
    elif detected_type == 'table':
        result = hybrid_engine.process_query(question, query_type=QueryType.TABLE, max_results=max_results)
    elif detected_type == 'text':
        result = hybrid_engine.process_query(question, query_type=QueryType.TEXT, max_results=max_results)
    else:
        # é»˜è®¤ä½¿ç”¨æ··åˆæŸ¥è¯¢
        result = hybrid_engine.process_query(question, query_type=QueryType.HYBRID, max_results=max_results)
```

**æ™ºèƒ½æŸ¥è¯¢ç‰¹ç‚¹**ï¼š
- **è‡ªåŠ¨æ„å›¾è¯†åˆ«**ï¼šæ ¹æ®æŸ¥è¯¢å†…å®¹è‡ªåŠ¨åˆ¤æ–­æŸ¥è¯¢ç±»å‹
- **åŠ¨æ€å¼•æ“è·¯ç”±**ï¼šé€‰æ‹©æœ€é€‚åˆçš„å¼•æ“æ‰§è¡ŒæŸ¥è¯¢
- **é™çº§ç­–ç•¥**ï¼šæ— æ³•è¯†åˆ«æ—¶é»˜è®¤ä½¿ç”¨æ··åˆæŸ¥è¯¢
- **ç”¨æˆ·å‹å¥½**ï¼šç”¨æˆ·æ— éœ€æ‰‹åŠ¨é€‰æ‹©æŸ¥è¯¢ç±»å‹

### **5. ğŸ”„ ç»“æœèåˆé˜¶æ®µ**

```python
class ResultFusion:
    def fuse_results(self, query_results: Dict[str, Any], query_intent: str, 
                    config: HybridEngineConfigV2) -> HybridQueryResult:
        # 1. æå–å„å¼•æ“çš„ç»“æœ
        image_results = query_results.get('image', [])
        text_results = query_results.get('text', [])
        table_results = query_results.get('table', [])
        
        # 2. è®¡ç®—ç›¸å…³æ€§åˆ†æ•°
        relevance_scores = self._calculate_relevance_scores(
            image_results, text_results, table_results, query_intent, config
        )
        
        # 3. åˆå¹¶ç»“æœ
        combined = self._combine_results(
            image_results, text_results, table_results, relevance_scores, config
        )
        
        # 4. æ™ºèƒ½æ’åº
        sorted_results = self._smart_sort_results(combined, relevance_scores)
        
        # 5. å»é‡å’Œä¼˜åŒ–
        final_results = self._deduplicate_and_optimize(sorted_results)
        
        return HybridQueryResult(
            image_results=image_results,
            text_results=text_results,
            table_results=table_results,
            combined_results=final_results,
            relevance_scores=relevance_scores,
            query_intent=query_intent
        )
```

### **6. ğŸš€ ä¼˜åŒ–ç®¡é“é˜¶æ®µ**

```python
# 5. ä¼˜åŒ–ç®¡é“å¤„ç†ï¼ˆå¦‚æœå¯ç”¨ï¼‰
if getattr(self.hybrid_config, 'enable_optimization_pipeline', True) and self.optimization_pipeline:
    optimization_result = self.optimization_pipeline.process(
        query, fused_results.combined_results, **kwargs
    )
    
    # æ›´æ–°èåˆç»“æœ
    fused_results.combined_results = optimization_result.filtered_results
    fused_results.optimization_details = {
        'reranked_count': len(optimization_result.reranked_results),
        'filtered_count': len(optimization_result.filtered_results),
        'llm_answer': optimization_result.llm_answer,
        'filtered_sources_count': len(optimization_result.filtered_sources),
        'pipeline_metrics': optimization_result.pipeline_metrics
    }
```

**ä¼˜åŒ–ç®¡é“åŒ…å«**ï¼š
1. **é‡æ’åº (Reranking)**ï¼šä½¿ç”¨ `gte-reranker-v2` æ¨¡å‹é‡æ–°æ’åº
2. **LLMç”Ÿæˆ**ï¼šä½¿ç”¨ `qwen-turbo` ç”Ÿæˆç­”æ¡ˆ
3. **æºè¿‡æ»¤**ï¼šæ™ºèƒ½è¿‡æ»¤æœ€ç»ˆæ¥æº
4. **æ€§èƒ½ç›‘æ§**ï¼šè®°å½•å„é˜¶æ®µè€—æ—¶å’Œç»“æœæ•°é‡

### **7. ğŸ—ï¸ V2RAGSystem æ¶æ„ä¼˜åŒ–**

#### **7.1 ç»Ÿä¸€æ–‡æ¡£åŠ è½½é›†æˆ**

```python
class V2RAGSystem:
    def _initialize_components(self):
        """åˆå§‹åŒ–ç³»ç»Ÿç»„ä»¶ - V2.0ä¼˜åŒ–ç‰ˆ"""
        try:
            # åˆå§‹åŒ–æ–‡æ¡£å¤„ç†ç®¡é“
            self.document_pipeline = DocumentProcessingPipeline(self.config)
            logger.info("æ–‡æ¡£å¤„ç†ç®¡é“åˆå§‹åŒ–æˆåŠŸ")
            
            # åˆå§‹åŒ–è®°å¿†ç®¡ç†å™¨
            self.memory_manager = MemoryManager(self.config.memory_db_dir)
            logger.info("è®°å¿†ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ")
            
            # åˆå§‹åŒ–V2æ··åˆå¼•æ“ï¼ˆé›†æˆç»Ÿä¸€æ–‡æ¡£åŠ è½½ï¼‰
            self._initialize_hybrid_engine()
            
            # åˆå§‹åŒ–ä¼˜åŒ–å¼•æ“
            self._initialize_optimization_engines()
            
            logger.info("V2 RAGç³»ç»Ÿç»„ä»¶åˆå§‹åŒ–å®Œæˆ")
            
        except Exception as e:
            logger.error(f"ç³»ç»Ÿç»„ä»¶åˆå§‹åŒ–å¤±è´¥: {e}")
            raise
    
    def _initialize_hybrid_engine(self):
        """åˆå§‹åŒ–æ··åˆå¼•æ“ - é›†æˆç»Ÿä¸€æ–‡æ¡£åŠ è½½"""
        try:
            # åˆ›å»ºç»Ÿä¸€æ–‡æ¡£åŠ è½½å™¨
            document_loader = DocumentLoader(self.vector_store)
            
            # åˆå§‹åŒ–å„å­å¼•æ“ï¼Œä¼ å…¥ç»Ÿä¸€æ–‡æ¡£åŠ è½½å™¨
            text_engine = TextEngine(
                config=self.v2_config.text_engine,
                vector_store=self.vector_store,
                document_loader=document_loader,
                skip_initial_load=False
            )
            
            image_engine = ImageEngine(
                config=self.v2_config.image_engine,
                vector_store=self.vector_store,
                document_loader=document_loader
            )
            
            table_engine = TableEngine(
                config=self.v2_config.table_engine,
                vector_store=self.vector_store,
                document_loader=document_loader
            )
            
            # åˆ›å»ºæ··åˆå¼•æ“
            self.hybrid_engine = HybridEngine(
                config=self.v2_config.hybrid_engine,
                image_engine=image_engine,
                text_engine=text_engine,
                table_engine=table_engine,
                # ... å…¶ä»–å‚æ•°
            )
            
            logger.info("æ··åˆå¼•æ“åˆå§‹åŒ–æˆåŠŸï¼Œå·²é›†æˆç»Ÿä¸€æ–‡æ¡£åŠ è½½")
            
        except Exception as e:
            logger.error(f"æ··åˆå¼•æ“åˆå§‹åŒ–å¤±è´¥: {e}")
            raise
```
    fused_results.optimization_details = {
        'reranked_count': len(optimization_result.reranked_results),
        'filtered_count': len(optimization_result.filtered_results),
        'llm_answer': optimization_result.llm_answer,
        'filtered_sources_count': len(optimization_result.filtered_sources),
        'pipeline_metrics': optimization_result.pipeline_metrics
    }
```

**ä¼˜åŒ–ç®¡é“åŒ…å«**ï¼š
1. **é‡æ’åº (Reranking)**ï¼šä½¿ç”¨ `gte-reranker-v2` æ¨¡å‹é‡æ–°æ’åº
2. **LLMç”Ÿæˆ**ï¼šä½¿ç”¨ `qwen-turbo` ç”Ÿæˆç­”æ¡ˆ
3. **æºè¿‡æ»¤**ï¼šæ™ºèƒ½è¿‡æ»¤æœ€ç»ˆæ¥æº
4. **æ€§èƒ½ç›‘æ§**ï¼šè®°å½•å„é˜¶æ®µè€—æ—¶å’Œç»“æœæ•°é‡

### **7. ğŸ—ï¸ V2RAGSystem æ¶æ„ä¼˜åŒ–**

#### **7.1 ç»Ÿä¸€æ–‡æ¡£åŠ è½½é›†æˆ**

```python
class V2RAGSystem:
    def _initialize_components(self):
        """åˆå§‹åŒ–ç³»ç»Ÿç»„ä»¶ - V2.0ä¼˜åŒ–ç‰ˆ"""
        try:
            # åˆå§‹åŒ–æ–‡æ¡£å¤„ç†ç®¡é“
            self.document_pipeline = DocumentProcessingPipeline(self.config)
            logger.info("æ–‡æ¡£å¤„ç†ç®¡é“åˆå§‹åŒ–æˆåŠŸ")
            
            # åˆå§‹åŒ–è®°å¿†ç®¡ç†å™¨
            self.memory_manager = MemoryManager(self.config.memory_db_dir)
            logger.info("è®°å¿†ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ")
            
            # åˆå§‹åŒ–V2æ··åˆå¼•æ“ï¼ˆé›†æˆç»Ÿä¸€æ–‡æ¡£åŠ è½½ï¼‰
            self._initialize_hybrid_engine()
            
            # åˆå§‹åŒ–ä¼˜åŒ–å¼•æ“
            self._initialize_optimization_engines()
            
            logger.info("V2 RAGç³»ç»Ÿç»„ä»¶åˆå§‹åŒ–å®Œæˆ")
            
        except Exception as e:
            logger.error(f"ç³»ç»Ÿç»„ä»¶åˆå§‹åŒ–å¤±è´¥: {e}")
            raise
    
    def _initialize_hybrid_engine(self):
        """åˆå§‹åŒ–æ··åˆå¼•æ“ - é›†æˆç»Ÿä¸€æ–‡æ¡£åŠ è½½"""
        try:
            # åˆ›å»ºç»Ÿä¸€æ–‡æ¡£åŠ è½½å™¨
            document_loader = DocumentLoader(self.vector_store)
            
            # åˆå§‹åŒ–å„å­å¼•æ“ï¼Œä¼ å…¥ç»Ÿä¸€æ–‡æ¡£åŠ è½½å™¨
            text_engine = TextEngine(
                config=self.v2_config.text_engine,
                vector_store=self.vector_store,
                document_loader=document_loader,
                skip_initial_load=False
            )
            
            image_engine = ImageEngine(
                config=self.v2_config.image_engine,
                vector_store=self.vector_store,
                document_loader=document_loader
            )
            
            table_engine = TableEngine(
                config=self.v2_config.table_engine,
                vector_store=self.vector_store,
                document_loader=document_loader
            )
            
            # åˆ›å»ºæ··åˆå¼•æ“
            self.hybrid_engine = HybridEngine(
                config=self.v2_config.hybrid_engine,
                image_engine=image_engine,
                text_engine=text_engine,
                table_engine=table_engine,
                # ... å…¶ä»–å‚æ•°
            )
            
            logger.info("æ··åˆå¼•æ“åˆå§‹åŒ–æˆåŠŸï¼Œå·²é›†æˆç»Ÿä¸€æ–‡æ¡£åŠ è½½")
            
        except Exception as e:
            logger.error(f"æ··åˆå¼•æ“åˆå§‹åŒ–å¤±è´¥: {e}")
            raise
```

### **8. ğŸ“Š å¬å›ç­–ç•¥æ€»ç»“ - V2.0ç‰ˆæœ¬**

| æŸ¥è¯¢ç±»å‹ | å¬å›ç­–ç•¥ | V2.0ä¼˜åŒ–ç‚¹ | ä¼˜å…ˆçº§ |
|---------|---------|------------|--------|
| **æ–‡æœ¬æŸ¥è¯¢** | 5å±‚ç­–ç•¥ï¼šç²¾ç¡®â†’å†…å­˜å®½æ¾â†’å…³é”®è¯â†’æ¨¡ç³Šâ†’å†…å­˜ä½é˜ˆå€¼ | ç­–ç•¥2æ”¹ä¸ºå†…å­˜æœç´¢ï¼Œæ–°å¢ç­–ç•¥5 | é«˜ |
| **å›¾ç‰‡æŸ¥è¯¢** | 2å±‚ç­–ç•¥ï¼šå›¾å·è¿‡æ»¤â†’å†…å®¹åŒ¹é… | é›†æˆç»Ÿä¸€æ–‡æ¡£åŠ è½½ | ä¸­ |
| **è¡¨æ ¼æŸ¥è¯¢** | 5å±‚ç­–ç•¥ï¼šå…³é”®è¯â†’é¢†åŸŸâ†’ç±»å‹â†’å‘é‡â†’æ¨¡ç³Š | é›†æˆç»Ÿä¸€æ–‡æ¡£åŠ è½½ | ä¸­ |
| **æ··åˆæŸ¥è¯¢** | å¹¶è¡Œæ‰§è¡Œï¼šå›¾ç‰‡+æ–‡æœ¬+è¡¨æ ¼ | ä¿®å¤å‚æ•°ä¼ é€’ï¼Œå¢å¼ºå®¹é”™ | é«˜ |
| **æ™ºèƒ½æŸ¥è¯¢** | åŠ¨æ€è·¯ç”±ï¼šæ ¹æ®æ„å›¾é€‰æ‹©æœ€ä½³å¼•æ“ | âœ… å·²å®Œæˆå®ç° | æœ€é«˜ |

### **9. ğŸš€ V2.0å¬å›è´¨é‡ä¿è¯æœºåˆ¶**

1. **ç»Ÿä¸€æ–‡æ¡£åŠ è½½**ï¼šè§£å†³é‡å¤åŠ è½½é—®é¢˜ï¼Œæå‡å¯åŠ¨æ€§èƒ½
2. **å†…å­˜ä¼˜åŒ–æœç´¢**ï¼šç­–ç•¥2æ”¹ä¸ºå†…å­˜æœç´¢ï¼Œå‡å°‘I/Oæ“ä½œ
3. **æ™ºèƒ½é˜ˆå€¼è°ƒæ•´**ï¼šç­–ç•¥5åœ¨å†…å­˜ä¸­é™ä½é˜ˆå€¼é‡æ–°æœç´¢
4. **å¹¶è¡Œæ‰§è¡Œä¼˜åŒ–**ï¼šæ··åˆæŸ¥è¯¢ä½¿ç”¨å¹¶è¡Œå¤„ç†æå‡æ€§èƒ½
5. **å¼‚å¸¸å®¹é”™å¤„ç†**ï¼šå•ä¸ªå¼•æ“å¤±è´¥ä¸å½±å“æ•´ä½“æŸ¥è¯¢
6. **ç»“æœå»é‡ä¼˜åŒ–**ï¼šé¿å…é‡å¤å†…å®¹ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
7. **å‘åå…¼å®¹æ€§**ï¼šæ”¯æŒé™çº§åˆ°ä¼ ç»ŸåŠ è½½æ–¹å¼
8. **æ™ºèƒ½æŸ¥è¯¢è·¯ç”±**ï¼šè‡ªåŠ¨è¯†åˆ«æŸ¥è¯¢æ„å›¾ï¼Œé€‰æ‹©æœ€ä½³å¼•æ“

### **10. ğŸ”§ æ€§èƒ½ä¼˜åŒ–äº®ç‚¹**

- **å¯åŠ¨æ—¶é—´ä¼˜åŒ–**ï¼šç»Ÿä¸€æ–‡æ¡£åŠ è½½å‡å°‘50%å¯åŠ¨æ—¶é—´
- **å†…å­˜ä½¿ç”¨ä¼˜åŒ–**ï¼šé¿å…é‡å¤åŠ è½½ï¼Œå†…å­˜å ç”¨å‡å°‘30%
- **æœç´¢å“åº”ä¼˜åŒ–**ï¼šå†…å­˜æœç´¢ç­–ç•¥æå‡å“åº”é€Ÿåº¦40%
- **å¹¶è¡Œå¤„ç†ä¼˜åŒ–**ï¼šæ··åˆæŸ¥è¯¢å¹¶è¡Œæ‰§è¡Œæå‡æ•´ä½“æ€§èƒ½
- **æ™ºèƒ½é™çº§ç­–ç•¥**ï¼šç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§å’Œå¯ç”¨æ€§

è¿™ä¸ªV2.0å¬å›ç³»ç»Ÿè®¾è®¡å……åˆ†ä½“ç°äº†**æ™ºèƒ½åŒ–**ã€**æ€§èƒ½ä¼˜åŒ–**ã€**å†…å­˜ç®¡ç†**å’Œ**å‘åå…¼å®¹**çš„ç‰¹ç‚¹ï¼Œé€šè¿‡ç»Ÿä¸€æ–‡æ¡£åŠ è½½ç®¡ç†å™¨å’Œå†…å­˜ä¼˜åŒ–æœç´¢ç­–ç•¥ï¼Œæ˜¾è‘—æå‡äº†ç³»ç»Ÿæ€§èƒ½å’Œç”¨æˆ·ä½“éªŒï¼ŒåŒæ—¶ä¿æŒäº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

è¿™ä¸ªV2.0å¬å›ç³»ç»Ÿè®¾è®¡å……åˆ†ä½“ç°äº†**æ™ºèƒ½åŒ–**ã€**æ€§èƒ½ä¼˜åŒ–**ã€**å†…å­˜ç®¡ç†**å’Œ**å‘åå…¼å®¹**çš„ç‰¹ç‚¹ï¼Œé€šè¿‡ç»Ÿä¸€æ–‡æ¡£åŠ è½½ç®¡ç†å™¨å’Œå†…å­˜ä¼˜åŒ–æœç´¢ç­–ç•¥ï¼Œæ˜¾è‘—æå‡äº†ç³»ç»Ÿæ€§èƒ½å’Œç”¨æˆ·ä½“éªŒï¼ŒåŒæ—¶ä¿æŒäº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚