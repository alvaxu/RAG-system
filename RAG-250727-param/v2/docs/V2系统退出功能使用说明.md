# 🛑 V2系统退出功能使用说明

## 📋 功能概述

V2 RAG系统新增了优雅退出Web服务的功能，用户可以通过Web页面安全地关闭系统，系统会自动执行资源清理和内存释放工作。

## 🎯 主要特性

### 1. **Web页面退出功能**
- 在左侧边栏新增"系统管理"区域
- 提供"重启系统"和"退出服务"两个按钮
- 实时显示系统运行状态和运行时间

### 2. **优雅关闭流程**
- 自动清理记忆管理器缓存
- 清理文档加载器缓存
- 清理各引擎缓存（文本、图片、表格）
- 清理优化引擎缓存（重排序、LLM）
- 保存系统状态
- 记录详细的操作日志

### 3. **信号处理支持**
- 支持Ctrl+C优雅关闭
- 支持SIGTERM信号处理
- 自动注册信号处理器

## 🚀 使用方法

### **方法1：Web页面退出（推荐）**

1. 打开V2 Web应用页面
2. 在左侧边栏找到"⚙️ 系统管理"区域
3. 点击"🛑 退出服务"按钮
4. 确认退出操作
5. 系统自动执行清理流程
6. 等待清理完成后关闭浏览器

### **方法2：命令行强制退出**

```bash
# 在运行V2系统的终端中按Ctrl+C
# 系统会自动执行优雅关闭流程
```

### **方法3：系统重启**

1. 在Web页面点击"🔄 重启系统"按钮
2. 系统会清理缓存并重新初始化
3. 页面自动刷新，系统重新就绪

## 🔧 技术实现

### **API接口**

#### 1. 系统状态接口
```http
GET /api/v2/status
```

#### 2. 系统重启接口
```http
POST /api/v2/system/restart
Content-Type: application/json

{
    "reason": "用户主动重启",
    "cleanup_before_restart": true
}
```

#### 3. 系统关闭接口
```http
POST /api/v2/system/shutdown
Content-Type: application/json

{
    "reason": "用户主动关闭",
    "cleanup_memory": true,
    "save_state": true
}
```

### **清理流程**

```python
def _graceful_shutdown(self):
    """优雅关闭系统，执行清理工作"""
    try:
        # 1. 清理记忆管理器
        if self.memory_manager:
            self.memory_manager.clear_all_memories()
        
        # 2. 清理文档加载器缓存
        if self.document_loader:
            self.document_loader.clear_cache()
        
        # 3. 清理混合引擎缓存
        if self.hybrid_engine:
            # 清理各子引擎缓存
            for engine_name in ['text_engine', 'image_engine', 'table_engine']:
                engine = getattr(self.hybrid_engine, engine_name)
                if engine and hasattr(engine, 'clear_cache'):
                    engine.clear_cache()
            
            # 清理优化引擎缓存
            if self.hybrid_engine.reranking_engine:
                self.hybrid_engine.reranking_engine.clear_cache()
            
            if self.hybrid_engine.llm_engine:
                self.hybrid_engine.llm_engine.clear_cache()
        
        # 4. 保存系统状态
        # 5. 关闭日志
        logger.info("优雅关闭流程完成，系统资源已清理")
        
    except Exception as e:
        logger.error(f"优雅关闭过程中发生错误: {e}")
```

## 📊 页面界面

### **系统管理区域样式**

```css
.system-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
    border: 2px solid #e9ecef;
}

.system-section h3 {
    background: linear-gradient(45deg, #dc3545, #fd7e14);
    color: white;
    border-radius: 8px;
    padding: 8px 12px;
    text-align: center;
}

.system-actions {
    display: flex;
    gap: 8px;
    margin-bottom: 15px;
}

.system-btn {
    flex: 1;
    padding: 10px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    min-height: 50px;
}

.system-btn.restart {
    background: #ffc107;
    color: #333;
}

.system-btn.shutdown {
    background: #dc3545;
    color: white;
}
```

### **状态显示**

- **系统状态**: 显示当前系统运行状态
- **运行时间**: 实时显示系统运行时长（HH:MM:SS格式）
- **状态颜色**: 
  - 🟢 绿色：运行中
  - 🟡 黄色：正在关闭
  - 🔴 红色：已关闭

## 🧪 测试验证

### **测试脚本**

使用提供的测试脚本验证功能：

```bash
# 进入tools目录
cd tools

# 运行测试脚本
python test_system_shutdown.py

# 指定自定义URL测试
python test_system_shutdown.py http://localhost:8080
```

### **测试内容**

1. **系统状态接口测试**
2. **系统重启接口测试**
3. **系统关闭接口测试**
4. **完整优雅关闭流程测试**

## ⚠️ 注意事项

### **安全提醒**

1. **退出操作不可逆**：点击"退出服务"后，系统将完全关闭
2. **数据保存**：退出前确保重要数据已保存
3. **用户确认**：系统会要求用户二次确认退出操作

### **使用建议**

1. **开发环境**：建议使用重启功能，避免重复启动
2. **生产环境**：谨慎使用退出功能，确保服务可用性
3. **调试模式**：退出功能会记录详细日志，便于问题排查

### **故障处理**

1. **退出失败**：检查网络连接和API接口状态
2. **清理异常**：查看日志文件了解具体错误
3. **强制退出**：如果优雅退出失败，使用Ctrl+C强制退出

## 🔄 更新日志

### **V2.0.0 (2025-08-14)**
- ✅ 新增Web页面退出服务功能
- ✅ 新增系统重启功能
- ✅ 实现优雅关闭流程
- ✅ 添加信号处理器支持
- ✅ 完善资源清理机制
- ✅ 新增系统状态监控
- ✅ 提供测试脚本和文档

## 📞 技术支持

如果在使用过程中遇到问题，请：

1. 查看系统日志文件
2. 运行测试脚本验证功能
3. 检查网络连接和API状态
4. 联系开发团队获取支持

---

**🎯 总结**：V2系统退出功能提供了安全、优雅的系统关闭方式，通过Web界面即可完成，无需强制终止进程，确保系统资源得到妥善清理。
