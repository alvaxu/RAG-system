å¥½çš„ï¼æˆ‘æ¥å†™V3 RAGç³»ç»Ÿæº¯æºæ¨¡å—çš„è¯¦ç»†è®¾è®¡æ–‡æ¡£ï¼š

# M19-RAGç³»ç»Ÿæº¯æºæ¨¡å—è¯¦ç»†è®¾è®¡æ–‡æ¡£

## ä¸€ã€æ–‡æ¡£åŸºç¡€ä¿¡æ¯

| æ¨¡å—åç§° | M19-RAGç³»ç»Ÿæº¯æºæ¨¡å—                                          | æ‰€å±é¡¹ç›® | V3ç‰ˆæœ¬RAGç³»ç»Ÿ                     |
| -------- | ------------------------------------------------------------ | -------- | --------------------------------- |
| æ–‡æ¡£ç‰ˆæœ¬ | V1.0                                                         | æ–‡æ¡£çŠ¶æ€ | â˜‘ è‰ç¨¿ â–¡ è¯„å®¡ä¸­ â–¡ å·²ç¡®è®¤ â–¡ å·²å½’æ¡£ |
| ç¼–å†™äºº   | AIåŠ©æ‰‹                                                       | ç¼–å†™æ—¥æœŸ | 2025å¹´8æœˆ                         |
| å…³è”æ–‡æ¡£ | ã€ŠM18-RAGç³»ç»ŸRerankingæ¨¡å—è¯¦ç»†è®¾è®¡æ–‡æ¡£ã€‹ã€ŠV3_RAGç³»ç»Ÿå‰ç«¯æŠ€æœ¯é€‰æ‹©ã€‹ |          |                                   |

## äºŒã€æ¨¡å—æ¦‚è¿°

### 1. å®šä½ä¸ç›®æ ‡

ä½œä¸ºRAGç³»ç»Ÿçš„**æ™ºèƒ½æº¯æºæ ¸å¿ƒæ¨¡å—**ï¼Œæº¯æºæ¨¡å—æ‰¿æ‹…ä¸ºLLMç”Ÿæˆçš„ç­”æ¡ˆæä¾›å‡†ç¡®ã€æ¸…æ™°çš„ä¿¡æ¯æ¥æºçš„èŒè´£ã€‚æœ¬æ¨¡å—é‡‡ç”¨"å¼€å…³æ§åˆ¶+é»˜è®¤ç­–ç•¥"çš„è®¾è®¡ç†å¿µï¼Œé»˜è®¤ä½¿ç”¨åå‘æº¯æºï¼ˆåŸºäºLLMç­”æ¡ˆå†…å®¹æº¯æºï¼‰ï¼ŒåŒæ—¶æ”¯æŒæ­£å‘æº¯æºï¼ˆåŸºäºè¾“å…¥æ–‡æ¡£æº¯æºï¼‰ï¼Œç¡®ä¿æº¯æºä¿¡æ¯çš„å‡†ç¡®æ€§å’Œç”¨æˆ·ä½“éªŒçš„ä¼˜è¶Šæ€§ã€‚

### 2. è®¾è®¡åŸåˆ™

- **çµæ´»æ§åˆ¶**ï¼šæ”¯æŒæ­£å‘/åå‘æº¯æºæ¨¡å¼åˆ‡æ¢
- **é»˜è®¤åå‘**ï¼šé»˜è®¤ä½¿ç”¨åå‘æº¯æºï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
- **é€‚åº¦æ™ºèƒ½**ï¼šæº¯æºé€»è¾‘ä¸è¿‡åº¦å¤æ‚ï¼Œä¿æŒå¯ç»´æŠ¤æ€§
- **å‰ç«¯å‹å¥½**ï¼šç¡®ä¿æº¯æºä¿¡æ¯æ»¡è¶³å‰ç«¯æ˜¾ç¤ºå’Œäº¤äº’éœ€æ±‚

### 3. ä¾èµ–ä¸äº¤äº’

| å…³è”æ¨¡å—        | äº¤äº’æ–¹å‘ | æ ¸å¿ƒäº¤äº’å†…å®¹                  |
| --------------- | -------- | ----------------------------- |
| RAGæŸ¥è¯¢å¤„ç†æ¨¡å— | è¢«è°ƒç”¨   | è·å–LLMç­”æ¡ˆå’Œrerankingç»“æœ    |
| Rerankingæ¨¡å—   | ä¾èµ–     | ä½¿ç”¨rerankingåˆ†æ•°è¿›è¡Œæº¯æºæ’åº |
| V3å…ƒæ•°æ®ç®¡ç†    | ä¾èµ–     | è¯»å–æ–‡æ¡£å…ƒæ•°æ®ï¼Œæ„å»ºæº¯æºä¿¡æ¯  |
| å‰ç«¯æ˜¾ç¤ºæ¨¡å—    | è¢«è°ƒç”¨   | æä¾›æ ¼å¼åŒ–çš„æº¯æºä¿¡æ¯          |

## ä¸‰ã€æ ¸å¿ƒåŠŸèƒ½è®¾è®¡

### 1. åŠŸèƒ½æ¸…å•

| åŠŸèƒ½ID | åŠŸèƒ½åç§°       | æ ¸å¿ƒæè¿°                        | æ“ä½œè§’è‰²   | å‰ç½®æ¡ä»¶           |
| ------ | -------------- | ------------------------------- | ---------- | ------------------ |
| F001   | æº¯æºæ¨¡å¼åˆ‡æ¢   | æ”¯æŒæ­£å‘/åå‘æº¯æºæ¨¡å¼åŠ¨æ€åˆ‡æ¢   | ç³»ç»Ÿç®¡ç†å‘˜ | æº¯æºæ¨¡å—åˆå§‹åŒ–å®Œæˆ |
| F002   | åå‘æº¯æº       | åŸºäºLLMç­”æ¡ˆå†…å®¹æ™ºèƒ½æº¯æºæ”¯æŒä¿¡æ¯ | æº¯æºæœåŠ¡   | LLMç­”æ¡ˆç”Ÿæˆå®Œæˆ    |
| F003   | æ­£å‘æº¯æº       | åŸºäºè¾“å…¥æ–‡æ¡£ç›´æ¥æº¯æº            | æº¯æºæœåŠ¡   | Rerankingç»“æœå¯ç”¨  |
| F004   | å…³é”®ä¿¡æ¯æå–   | ä»LLMç­”æ¡ˆä¸­æå–å…³é”®å®ä½“å’Œä¿¡æ¯   | æº¯æºæœåŠ¡   | LLMç­”æ¡ˆå†…å®¹å®Œæ•´    |
| F005   | æ™ºèƒ½åŒ¹é…æº¯æº   | åŸºäºå…³é”®ä¿¡æ¯åŒ¹é…ç›¸å…³æ–‡æ¡£        | æº¯æºæœåŠ¡   | å…³é”®ä¿¡æ¯æå–å®Œæˆ   |
| F006   | æº¯æºä¿¡æ¯æ ¼å¼åŒ– | æ ¼å¼åŒ–æº¯æºä¿¡æ¯ï¼Œæ»¡è¶³å‰ç«¯éœ€æ±‚    | æº¯æºæœåŠ¡   | æº¯æºåŒ¹é…å®Œæˆ       |

### 2. æ ¸å¿ƒä¸šåŠ¡æµç¨‹

#### 2.1 åå‘æº¯æºæµç¨‹
```
LLMç”Ÿæˆç­”æ¡ˆ â†’ æå–å…³é”®ä¿¡æ¯ â†’ åŒ¹é…ç›¸å…³æ–‡æ¡£ â†’ è®¡ç®—åŒ¹é…åˆ†æ•° â†’ æ’åºç­›é€‰ â†’ æ ¼å¼åŒ–è¾“å‡º
```

#### 2.2 æ­£å‘æº¯æºæµç¨‹
```
Rerankingç»“æœ â†’ å–å‰Nä¸ªç»“æœ â†’ æå–å…ƒæ•°æ® â†’ æ ¼å¼åŒ–è¾“å‡º
```

#### 2.3 æ¨¡å¼åˆ‡æ¢æµç¨‹
```
é…ç½®æ£€æŸ¥ â†’ æ¨¡å¼åˆ¤æ–­ â†’ æ‰§è¡Œå¯¹åº”æº¯æºç­–ç•¥ â†’ è¿”å›ç»“æœ
```

## å››ã€è¯¦ç»†è®¾è®¡

### 1. æ ¸å¿ƒæ¶æ„è®¾è®¡

#### 1.1 æ¶æ„å›¾
```mermaid
graph TD
    A[LLMç­”æ¡ˆ + Rerankingç»“æœ] --> B[SourceService]
    B --> C{æº¯æºæ¨¡å¼}
    C -->|åå‘æº¯æº| D[åå‘æº¯æºå¤„ç†å™¨]
    C -->|æ­£å‘æº¯æº| E[æ­£å‘æº¯æºå¤„ç†å™¨]
    
    D --> F[å…³é”®ä¿¡æ¯æå–å™¨]
    F --> G[æ™ºèƒ½åŒ¹é…å™¨]
    G --> H[æº¯æºæ’åºå™¨]
    
    E --> I[å…ƒæ•°æ®æå–å™¨]
    I --> J[ç»“æœæ’åºå™¨]
    
    H --> K[æº¯æºä¿¡æ¯æ ¼å¼åŒ–å™¨]
    J --> K
    K --> L[å‰ç«¯æº¯æºä¿¡æ¯]
    
    M[é…ç½®ç®¡ç†å™¨] --> B
    N[æç¤ºè¯ä¼˜åŒ–å™¨] --> O[LLM]
```

#### 1.2 è®¾è®¡ç‰¹ç‚¹
- **ç»Ÿä¸€æ¥å£**ï¼šæ‰€æœ‰æº¯æºæ¨¡å¼ä½¿ç”¨ç›¸åŒçš„æ¥å£
- **æ¨¡å¼åˆ‡æ¢**ï¼šæ”¯æŒè¿è¡Œæ—¶åŠ¨æ€åˆ‡æ¢æº¯æºæ¨¡å¼
- **æ™ºèƒ½å¤„ç†**ï¼šåå‘æº¯æºåŒ…å«é€‚åº¦çš„æ™ºèƒ½åŒ¹é…é€»è¾‘
- **å‰ç«¯ä¼˜åŒ–**ï¼šæº¯æºä¿¡æ¯æ ¼å¼å®Œå…¨æ»¡è¶³å‰ç«¯éœ€æ±‚

### 2. æ ¸å¿ƒç±»è®¾è®¡

#### 2.1 SourceServiceç±»
```python
class SourceService:
    """æº¯æºæœåŠ¡ - æ”¯æŒæ­£å‘/åå‘æº¯æºæ¨¡å¼"""
    
    def __init__(self, config: Dict[str, Any]):
        """
        åˆå§‹åŒ–æº¯æºæœåŠ¡
        
        :param config: é…ç½®å­—å…¸
        """
        self.config = config
        self.mode = config.get('mode', 'reverse')  # é»˜è®¤åå‘æº¯æº
        self.max_sources = config.get('max_sources', 5)
        self.min_relevance_score = config.get('min_relevance_score', 0.3)
        self.extract_entities = config.get('extract_entities', True)
        self.match_threshold = config.get('match_threshold', 0.3)
        
        logger.info(f"æº¯æºæœåŠ¡åˆå§‹åŒ–å®Œæˆï¼Œæ¨¡å¼: {self.mode}")
    
    def get_sources(self, llm_answer: str, reranked_results: List[Dict]) -> List[Dict]:
        """
        è·å–æº¯æºä¿¡æ¯
        
        :param llm_answer: LLMç”Ÿæˆçš„ç­”æ¡ˆ
        :param reranked_results: Rerankingåçš„ç»“æœ
        :return: æº¯æºä¿¡æ¯åˆ—è¡¨
        """
        try:
            if self.mode == 'reverse':
                return self._reverse_source_tracking(llm_answer, reranked_results)
            else:
                return self._forward_source_tracking(reranked_results)
                
        except Exception as e:
            logger.error(f"è·å–æº¯æºä¿¡æ¯å¤±è´¥: {e}")
            return []
    
    def set_mode(self, mode: str):
        """è®¾ç½®æº¯æºæ¨¡å¼"""
        if mode in ['reverse', 'forward']:
            self.mode = mode
            logger.info(f"æº¯æºæ¨¡å¼å·²åˆ‡æ¢ä¸º: {mode}")
        else:
            logger.warning(f"ä¸æ”¯æŒçš„æº¯æºæ¨¡å¼: {mode}")
```

#### 2.2 åå‘æº¯æºå¤„ç†å™¨
```python
def _reverse_source_tracking(self, llm_answer: str, reranked_results: List[Dict]) -> List[Dict]:
    """åå‘æº¯æº - åŸºäºLLMç­”æ¡ˆå†…å®¹æ™ºèƒ½æº¯æº"""
    
    try:
        # 1. æå–LLMç­”æ¡ˆä¸­çš„å…³é”®ä¿¡æ¯
        key_info = self._extract_key_info(llm_answer)
        logger.info(f"ä»LLMç­”æ¡ˆä¸­æå–åˆ° {len(key_info)} ä¸ªå…³é”®ä¿¡æ¯")
        
        # 2. åœ¨æ–‡æ¡£ä¸­åŒ¹é…è¿™äº›å…³é”®ä¿¡æ¯
        matched_sources = []
        for result in reranked_results:
            match_score = self._calculate_match_score(result, key_info)
            if match_score >= self.match_threshold:
                matched_sources.append((match_score, result))
        
        # 3. æŒ‰åŒ¹é…åˆ†æ•°æ’åºï¼Œå–å‰Nä¸ª
        matched_sources.sort(key=lambda x: x[0], reverse=True)
        final_sources = matched_sources[:self.max_sources]
        
        # 4. æ ¼å¼åŒ–æº¯æºä¿¡æ¯
        sources = []
        for i, (score, result) in enumerate(final_sources):
            source = self._format_source(result, i + 1, score)
            sources.append(source)
        
        logger.info(f"åå‘æº¯æºå®Œæˆï¼Œæ‰¾åˆ° {len(sources)} ä¸ªç›¸å…³æ¥æº")
        return sources
        
    except Exception as e:
        logger.error(f"åå‘æº¯æºå¤±è´¥: {e}")
        return []
```

#### 2.3 æ­£å‘æº¯æºå¤„ç†å™¨
```python
def _forward_source_tracking(self, reranked_results: List[Dict]) -> List[Dict]:
    """æ­£å‘æº¯æº - åŸºäºè¾“å…¥æ–‡æ¡£ç›´æ¥æº¯æº"""
    
    try:
        # 1. å–å‰Nä¸ªrerankingç»“æœ
        top_results = reranked_results[:self.max_sources]
        
        # 2. æå–å…ƒæ•°æ®ï¼Œæ ¼å¼åŒ–æº¯æºä¿¡æ¯
        sources = []
        for i, result in enumerate(top_results):
            source = self._format_source(result, i + 1, result.get('rerank_score', 0.0))
            sources.append(source)
        
        logger.info(f"æ­£å‘æº¯æºå®Œæˆï¼Œè¿”å› {len(sources)} ä¸ªæ¥æº")
        return sources
        
    except Exception as e:
        logger.error(f"æ­£å‘æº¯æºå¤±è´¥: {e}")
        return []
```

#### 2.4 å…³é”®ä¿¡æ¯æå–å™¨
```python
def _extract_key_info(self, answer: str) -> List[Dict]:
    """æå–LLMç­”æ¡ˆä¸­çš„å…³é”®ä¿¡æ¯ - é€‚åº¦æ™ºèƒ½"""
    
    key_info = []
    
    try:
        # 1. æå–æ•°å­—ä¿¡æ¯ï¼ˆé‡‘é¢ã€ç™¾åˆ†æ¯”ã€æ•°é‡ç­‰ï¼‰
        import re
        numbers = re.findall(r'\d+(?:\.\d+)?(?:äº¿|ä¸‡|%|å…ƒ|ä¸ª|å°|ä»¶)?', answer)
        for num in numbers:
            key_info.append({
                'type': 'number',
                'value': num,
                'weight': 0.8
            })
        
        # 2. æå–å…¬å¸/äº§å“åç§°ï¼ˆç®€å•è§„åˆ™ï¼‰
        company_patterns = ['ä¸­èŠ¯å›½é™…', 'åä¸º', 'è…¾è®¯', 'é˜¿é‡Œå·´å·´', 'ç™¾åº¦']
        for pattern in company_patterns:
            if pattern in answer:
                key_info.append({
                    'type': 'company',
                    'value': pattern,
                    'weight': 0.9
                })
        
        # 3. æå–æ—¶é—´ä¿¡æ¯
        time_patterns = ['2025å¹´', '2024å¹´', 'ä¸€å­£åº¦', 'äºŒå­£åº¦', 'ä¸ŠåŠå¹´']
        for pattern in time_patterns:
            if pattern in answer:
                key_info.append({
                    'type': 'time',
                    'value': pattern,
                    'weight': 0.7
                })
        
        # 4. æå–å…³é”®æ¦‚å¿µ
        concept_patterns = ['è¥æ”¶', 'å‡€åˆ©æ¶¦', 'æ¯›åˆ©ç‡', 'å¸‚åœºä»½é¢', 'æŠ€æœ¯å‚æ•°']
        for pattern in concept_patterns:
            if pattern in answer:
                key_info.append({
                    'type': 'concept',
                    'value': pattern,
                    'weight': 0.6
                })
        
        logger.info(f"æå–åˆ° {len(key_info)} ä¸ªå…³é”®ä¿¡æ¯")
        return key_info
        
    except Exception as e:
        logger.warning(f"å…³é”®ä¿¡æ¯æå–å¤±è´¥: {e}")
        return []
```

#### 2.5 æ™ºèƒ½åŒ¹é…å™¨
```python
def _calculate_match_score(self, result: Dict, key_info: List[Dict]) -> float:
    """è®¡ç®—æ–‡æ¡£ä¸å…³é”®ä¿¡æ¯çš„åŒ¹é…åˆ†æ•°"""
    
    try:
        doc = result.get('doc', {})
        metadata = doc.get('metadata', {})
        content = metadata.get('content', '')
        
        if not content:
            return 0.0
        
        total_score = 0.0
        max_possible_score = 0.0
        
        for info in key_info:
            info_value = info['value']
            info_weight = info['weight']
            
            # è®¡ç®—åŒ¹é…åˆ†æ•°
            if info_value in content:
                # å®Œå…¨åŒ¹é…
                match_score = 1.0
            elif any(word in content for word in info_value.split()):
                # éƒ¨åˆ†åŒ¹é…
                match_score = 0.7
            else:
                # æ— åŒ¹é…
                match_score = 0.0
            
            # åŠ æƒè®¡ç®—
            weighted_score = match_score * info_weight
            total_score += weighted_score
            max_possible_score += info_weight
        
        # å½’ä¸€åŒ–åˆ†æ•°
        if max_possible_score > 0:
            final_score = total_score / max_possible_score
        else:
            final_score = 0.0
        
        return final_score
        
    except Exception as e:
        logger.warning(f"è®¡ç®—åŒ¹é…åˆ†æ•°å¤±è´¥: {e}")
        return 0.0
```

#### 2.6 æº¯æºä¿¡æ¯æ ¼å¼åŒ–å™¨
```python
def _format_source(self, result: Dict, index: int, match_score: float) -> Dict:
    """æ ¼å¼åŒ–æº¯æºä¿¡æ¯ï¼Œç¡®ä¿æ»¡è¶³å‰ç«¯éœ€æ±‚"""
    
    try:
        doc = result.get('doc', {})
        metadata = doc.get('metadata', {})
        
        # åŸºç¡€ä¿¡æ¯
        source = {
            'index': index,
            'document_name': metadata.get('document_name', 'æœªçŸ¥æ–‡æ¡£'),
            'page_number': metadata.get('page_number', 'æœªçŸ¥é¡µ'),
            'chunk_type': metadata.get('chunk_type', 'æœªçŸ¥ç±»å‹'),
            'content_preview': metadata.get('content', '')[:100] + '...',
            'relevance_score': result.get('rerank_score', 0.0),
            'match_score': match_score,
            'source_path': metadata.get('source_path', ''),
            'update_time': metadata.get('update_time', ''),
            'document_type': metadata.get('document_type', 'æœªçŸ¥ç±»å‹')
        }
        
        # ç”Ÿæˆå‰ç«¯æ˜¾ç¤ºéœ€è¦çš„æ ¼å¼åŒ–æ–‡æœ¬
        source['formatted_text'] = self._generate_formatted_text(source)
        
        # å‰ç«¯äº¤äº’éœ€è¦çš„é¢å¤–ä¿¡æ¯
        source['can_expand'] = True
        source['expand_content'] = metadata.get('content', '')
        source['expand_metadata'] = {
            'file_size': metadata.get('file_size', ''),
            'creation_time': metadata.get('creation_time', ''),
            'last_modified': metadata.get('last_modified', ''),
            'file_type': metadata.get('file_type', '')
        }
        
        return source
        
    except Exception as e:
        logger.error(f"æ ¼å¼åŒ–æº¯æºä¿¡æ¯å¤±è´¥: {e}")
        return {}
    
def _generate_formatted_text(self, source: Dict) -> str:
    """ç”Ÿæˆå‰ç«¯æ˜¾ç¤ºçš„æ ¼å¼åŒ–æ–‡æœ¬"""
    
    doc_name = source['document_name']
    page_num = source['page_number']
    chunk_type = source['chunk_type']
    
    # æ ¹æ®å†…å®¹ç±»å‹ç”Ÿæˆä¸åŒæ ¼å¼
    if chunk_type == 'image':
        return f"{doc_name} - ç¬¬{page_num}é¡µ (å›¾ç‰‡)"
    elif chunk_type == 'table':
        return f"{doc_name} - ç¬¬{page_num}é¡µ (è¡¨æ ¼)"
    elif chunk_type == 'text':
        return f"{doc_name} - ç¬¬{page_num}é¡µ (æ–‡æœ¬)"
    else:
        return f"{doc_name} - ç¬¬{page_num}é¡µ"
```

### 3. é…ç½®ç®¡ç†è®¾è®¡

#### 3.1 é…ç½®ç»“æ„
```json
{
  "rag_system": {
    "source_attribution": {
      "enabled": true,
      "mode": "reverse",
      "max_sources": 5,
      "min_relevance_score": 0.3,
      "extract_entities": true,
      "match_threshold": 0.3,
      "show_match_score": false,
      "show_relevance_score": false
    }
  }
}
```

#### 3.2 é…ç½®å‚æ•°è¯´æ˜

| å‚æ•°åç§°               | é»˜è®¤å€¼    | è¯´æ˜                                           |
| ---------------------- | --------- | ---------------------------------------------- |
| `enabled`              | true      | æ˜¯å¦å¯ç”¨æº¯æºåŠŸèƒ½                               |
| `mode`                 | "reverse" | æº¯æºæ¨¡å¼ï¼š"reverse"ï¼ˆåå‘ï¼‰æˆ–"forward"ï¼ˆæ­£å‘ï¼‰ |
| `max_sources`          | 5         | æœ€å¤§æº¯æºæ•°é‡                                   |
| `min_relevance_score`  | 0.3       | æœ€å°ç›¸å…³æ€§åˆ†æ•°é˜ˆå€¼                             |
| `extract_entities`     | true      | æ˜¯å¦æå–å…³é”®å®ä½“                               |
| `match_threshold`      | 0.3       | åŒ¹é…åˆ†æ•°é˜ˆå€¼                                   |
| `show_match_score`     | false     | æ˜¯å¦æ˜¾ç¤ºåŒ¹é…åˆ†æ•°                               |
| `show_relevance_score` | false     | æ˜¯å¦æ˜¾ç¤ºç›¸å…³æ€§åˆ†æ•°                             |

### 4. æç¤ºè¯ä¼˜åŒ–è®¾è®¡

#### 4.1 LLMæç¤ºè¯æ¨¡æ¿
```python
REVERSE_SOURCE_PROMPT_TEMPLATE = """
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIåŠ©æ‰‹ã€‚è¯·åŸºäºä»¥ä¸‹ä¸Šä¸‹æ–‡ä¿¡æ¯å›ç­”é—®é¢˜ï¼š

è¦æ±‚ï¼š
1. å›ç­”è¦å‡†ç¡®ã€å®Œæ•´ã€æœ‰ä¾æ®
2. åœ¨å›ç­”ä¸­æ˜ç¡®æåŠå…·ä½“çš„æ•°æ®ã€äº‹å®ã€æ¥æº
3. å¦‚æœå¼•ç”¨å…·ä½“æ•°å­—ï¼Œè¯·è¯´æ˜æ¥æºå’Œä¾æ®
4. å¦‚æœå¾—å‡ºç»“è®ºï¼Œè¯·è¯´æ˜åˆ†æè¿‡ç¨‹å’Œä¾æ®
5. ä½¿ç”¨æ¸…æ™°çš„è¯­è¨€ç»“æ„ï¼Œä¾¿äºåç»­æº¯æº

ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š
{context}

é—®é¢˜ï¼š{question}

è¯·æŒ‰ç…§ä»¥ä¸Šè¦æ±‚å›ç­”ï¼š
"""
```

#### 4.2 æç¤ºè¯ä¼˜åŒ–æ•ˆæœ
- **æ˜ç¡®æ•°æ®æ¥æº**ï¼šLLMä¼šè¯´æ˜"æ ¹æ®XXæŠ¥å‘Šç¬¬Xé¡µæ˜¾ç¤º..."
- **å…·ä½“æ•°å­—å¼•ç”¨**ï¼šLLMä¼šæåˆ°"è´¢æŠ¥æ˜¾ç¤ºè¥æ”¶ä¸ºXXäº¿å…ƒ"
- **ç»“è®ºä¾æ®**ï¼šLLMä¼šè¯´æ˜"åŸºäºä»¥ä¸Šè´¢åŠ¡æ•°æ®åˆ†æ..."
- **ç»“æ„åŒ–å›ç­”**ï¼šLLMä¼šä½¿ç”¨æ¸…æ™°çš„æ®µè½å’Œé€»è¾‘ç»“æ„

## äº”ã€æ¥å£è®¾è®¡

### 1. æ ¸å¿ƒæ¥å£

#### 1.1 è·å–æº¯æºä¿¡æ¯æ¥å£
```python
def get_sources(self, llm_answer: str, reranked_results: List[Dict]) -> List[Dict]:
    """
    è·å–æº¯æºä¿¡æ¯
    
    :param llm_answer: LLMç”Ÿæˆçš„ç­”æ¡ˆ
    :param reranked_results: Rerankingåçš„ç»“æœ
    :return: æº¯æºä¿¡æ¯åˆ—è¡¨
    """
```

#### 1.2 è®¾ç½®æº¯æºæ¨¡å¼æ¥å£
```python
def set_mode(self, mode: str):
    """
    è®¾ç½®æº¯æºæ¨¡å¼
    
    :param mode: æº¯æºæ¨¡å¼ï¼Œ"reverse"æˆ–"forward"
    """
```

### 2. è¿”å›æ•°æ®ç»“æ„

```python
{
    'index': int,                    # æº¯æºåºå·
    'document_name': str,            # æ–‡æ¡£åç§°
    'page_number': str,              # é¡µç 
    'chunk_type': str,               # å†…å®¹ç±»å‹
    'content_preview': str,          # å†…å®¹é¢„è§ˆ
    'relevance_score': float,        # ç›¸å…³æ€§åˆ†æ•°
    'match_score': float,            # åŒ¹é…åˆ†æ•°
    'source_path': str,              # æºæ–‡ä»¶è·¯å¾„
    'update_time': str,              # æ›´æ–°æ—¶é—´
    'document_type': str,            # æ–‡æ¡£ç±»å‹
    'formatted_text': str,           # æ ¼å¼åŒ–çš„æ˜¾ç¤ºæ–‡æœ¬
    'can_expand': bool,              # æ˜¯å¦å¯ä»¥å±•å¼€
    'expand_content': str,           # å±•å¼€åçš„å®Œæ•´å†…å®¹
    'expand_metadata': Dict          # å±•å¼€åçš„å…ƒæ•°æ®
}
```

## å…­ã€ä¸V3ç³»ç»Ÿé›†æˆ

### 1. é›†æˆç‚¹
- **æŸ¥è¯¢å¤„ç†æ¨¡å—**ï¼šåœ¨LLMè°ƒç”¨åã€è¿”å›ç»“æœå‰æ‰§è¡Œæº¯æº
- **é…ç½®ç®¡ç†**ï¼šä½¿ç”¨V3çš„ç»Ÿä¸€é…ç½®ç®¡ç†
- **å…ƒæ•°æ®ç®¡ç†**ï¼šå……åˆ†åˆ©ç”¨V3çš„ä¸°å¯Œå…ƒæ•°æ®

### 2. æ•°æ®æµ
```
æŸ¥è¯¢ç»“æœ â†’ Reranking â†’ LLMè°ƒç”¨ â†’ æº¯æºä¿¡æ¯æå– â†’ æº¯æºæ ¼å¼åŒ– â†’ å‰ç«¯æ˜¾ç¤º
```

### 3. é›†æˆç¤ºä¾‹
```python
# åœ¨æŸ¥è¯¢å¤„ç†æ¨¡å—ä¸­çš„ä½¿ç”¨
class RAGQueryProcessor:
    def process_query(self, query: str, query_type: str):
        # 1. æ‰§è¡Œå¬å›
        candidates = self.recall_engine.search(query, query_type)
        
        # 2. æ‰§è¡Œreranking
        if self.config.get('reranking.enabled', True):
            candidates = self.reranking_service.rerank(query, candidates)
        
        # 3. è°ƒç”¨LLMï¼ˆä½¿ç”¨ä¼˜åŒ–çš„æç¤ºè¯ï¼‰
        optimized_prompt = self._build_optimized_prompt(query, candidates)
        answer = self.llm_service.generate_answer(optimized_prompt)
        
        # 4. è·å–æº¯æºä¿¡æ¯
        sources = self.source_service.get_sources(answer, candidates)
        
        # 5. è¿”å›å®Œæ•´ç»“æœ
        return {
            'answer': answer,
            'sources': sources,
            'query_type': query_type
        }
```

## ä¸ƒã€å‰ç«¯æº¯æºæ˜¾ç¤ºè®¾è®¡

### 1. Vue 3ç»„ä»¶è®¾è®¡
```vue
<template>
  <div class="source-attribution-section">
    <div class="source-header">
      <h4>ğŸ“š ä¿¡æ¯æ¥æº ({{ sources.length }})</h4>
      <div class="source-mode-indicator">
        {{ modeText }}
      </div>
    </div>
    
    <div class="source-list">
      <div v-for="source in sources" :key="source.index" class="source-item">
        <div class="source-main">
          <span class="source-number">{{ source.index }}</span>
          <span class="source-text">{{ source.formatted_text }}</span>
          <div class="source-scores">
            <span v-if="showRelevanceScore" class="score-item">
              ç›¸å…³æ€§: {{ (source.relevance_score * 100).toFixed(0) }}%
            </span>
            <span v-if="showMatchScore" class="score-item">
              åŒ¹é…åº¦: {{ (source.match_score * 100).toFixed(0) }}%
            </span>
          </div>
        </div>
        
        <div class="source-preview">{{ source.content_preview }}</div>
        
        <div class="source-actions">
          <button @click="expandSource(source)" v-if="source.can_expand" class="expand-btn">
            æŸ¥çœ‹è¯¦æƒ…
          </button>
          <button @click="copySourceInfo(source)" class="copy-btn">
            å¤åˆ¶ä¿¡æ¯
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  props: {
    sources: {
      type: Array,
      default: () => []
    },
    mode: {
      type: String,
      default: 'reverse'
    },
    showRelevanceScore: {
      type: Boolean,
      default: false
    },
    showMatchScore: {
      type: Boolean,
      default: false
    }
  },
  
  computed: {
    modeText() {
      return this.mode === 'reverse' ? 'æ™ºèƒ½æº¯æº' : 'ç›´æ¥æº¯æº'
    }
  },
  
  methods: {
    expandSource(source) {
      // å±•å¼€æº¯æºè¯¦æƒ…
      this.$emit('expand-source', source)
    },
    
    copySourceInfo(source) {
      // å¤åˆ¶æº¯æºä¿¡æ¯
      const info = `${source.formatted_text}\n${source.content_preview}`
      navigator.clipboard.writeText(info)
    }
  }
}
</script>
```

### 2. CSSæ ·å¼è®¾è®¡
```css
.source-attribution-section {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
}

.source-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 2px solid #e9ecef;
}

.source-mode-indicator {
  background: #007bff;
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
}

.source-item {
  background: white;
  border: 1px solid #e9ecef;
  border-radius: 6px;
  padding: 15px;
  margin-bottom: 10px;
  transition: all 0.3s ease;
}

.source-item:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  border-color: #007bff;
}

.source-main {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 10px;
}

.source-number {
  background: #007bff;
  color: white;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
}

.source-text {
  flex: 1;
  font-weight: 500;
  color: #333;
}

.source-scores {
  display: flex;
  gap: 10px;
}

.score-item {
  background: #e9ecef;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 11px;
  color: #666;
}

.source-preview {
  color: #666;
  font-size: 14px;
  line-height: 1.5;
  margin-bottom: 10px;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 4px;
}

.source-actions {
  display: flex;
  gap: 10px;
}

.expand-btn, .copy-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.3s ease;
}

.expand-btn {
  background: #007bff;
  color: white;
}

.expand-btn:hover {
  background: #0056b3;
}

.copy-btn {
  background: #6c757d;
  color: white;
}

.copy-btn:hover {
  background: #545b62;
}
```

## å…«ã€æ€§èƒ½ä¼˜åŒ–è®¾è®¡

### 1. æº¯æºå¤„ç†ä¼˜åŒ–
- **æ‰¹é‡å¤„ç†**ï¼šä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰æº¯æºä¿¡æ¯
- **ç¼“å­˜æœºåˆ¶**ï¼šå¯¹ç›¸åŒæŸ¥è¯¢çš„æº¯æºç»“æœè¿›è¡Œç¼“å­˜
- **å¼‚æ­¥å¤„ç†**ï¼šæº¯æºå¤„ç†ä¸é˜»å¡ä¸»æµç¨‹

### 2. å‰ç«¯æ¸²æŸ“ä¼˜åŒ–
- **è™šæ‹Ÿæ»šåŠ¨**ï¼šå¤§é‡æº¯æºä¿¡æ¯æ—¶ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨
- **æ‡’åŠ è½½**ï¼šæŒ‰éœ€åŠ è½½æº¯æºè¯¦ç»†ä¿¡æ¯
- **ç»„ä»¶åŒ–**ï¼šæº¯æºç»„ä»¶å¯ç‹¬ç«‹æ›´æ–°

### 3. ç›‘æ§æŒ‡æ ‡
- **æº¯æºå“åº”æ—¶é—´**ï¼šæº¯æºå¤„ç†çš„å¹³å‡å“åº”æ—¶é—´
- **æº¯æºå‡†ç¡®ç‡**ï¼šæº¯æºä¿¡æ¯çš„å‡†ç¡®æ€§è¯„ä¼°
- **ç¼“å­˜å‘½ä¸­ç‡**ï¼šæº¯æºç¼“å­˜çš„ä½¿ç”¨æ•ˆç‡

## ä¹ã€æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•
- **åŠŸèƒ½æµ‹è¯•**ï¼šæµ‹è¯•å„ç§æº¯æºæ¨¡å¼çš„åŠŸèƒ½
- **æ¨¡å¼åˆ‡æ¢æµ‹è¯•**ï¼šæµ‹è¯•æº¯æºæ¨¡å¼åŠ¨æ€åˆ‡æ¢
- **é”™è¯¯å¤„ç†æµ‹è¯•**ï¼šæµ‹è¯•å„ç§å¼‚å¸¸æƒ…å†µçš„å¤„ç†

### 2. é›†æˆæµ‹è¯•
- **ç³»ç»Ÿé›†æˆæµ‹è¯•**ï¼šæµ‹è¯•ä¸V3ç³»ç»Ÿçš„é›†æˆ
- **å‰ç«¯é›†æˆæµ‹è¯•**ï¼šæµ‹è¯•æº¯æºä¿¡æ¯çš„æ˜¾ç¤ºæ•ˆæœ
- **æ€§èƒ½æµ‹è¯•**ï¼šæµ‹è¯•æº¯æºå¤„ç†çš„æ€§èƒ½è¡¨ç°

### 3. æµ‹è¯•åœºæ™¯
- **æ­£å¸¸åœºæ™¯**ï¼šLLMç­”æ¡ˆæœ‰æ˜ç¡®ä¿¡æ¯çš„æƒ…å†µ
- **è¾¹ç•Œåœºæ™¯**ï¼šLLMç­”æ¡ˆä¿¡æ¯ä¸æ˜ç¡®çš„æƒ…å†µ
- **å¼‚å¸¸åœºæ™¯**ï¼šé…ç½®é”™è¯¯ã€æ•°æ®ç¼ºå¤±ç­‰å¼‚å¸¸æƒ…å†µ

## åã€éƒ¨ç½²ä¸è¿ç»´

### 1. éƒ¨ç½²è¦æ±‚
- **Pythonç¯å¢ƒ**ï¼š3.8+
- **ä¾èµ–åŒ…**ï¼šreï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰ã€loggingç­‰æ ‡å‡†åº“
- **é…ç½®ç®¡ç†**ï¼šæ”¯æŒåŠ¨æ€é…ç½®æ›´æ–°

### 2. é…ç½®ç®¡ç†
- **é…ç½®æ–‡ä»¶**ï¼šv3_config.jsonä¸­çš„rag_system.source_attributionèŠ‚ç‚¹
- **è¿è¡Œæ—¶é…ç½®**ï¼šæ”¯æŒåŠ¨æ€è°ƒæ•´æº¯æºæ¨¡å¼å’Œå‚æ•°
- **ç¯å¢ƒå˜é‡**ï¼šæ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–é…ç½®

### 3. ç›‘æ§å‘Šè­¦
- **æ€§èƒ½ç›‘æ§**ï¼šæº¯æºå“åº”æ—¶é—´ã€æˆåŠŸç‡ç­‰æŒ‡æ ‡
- **é”™è¯¯å‘Šè­¦**ï¼šæº¯æºå¤„ç†å¤±è´¥ã€é…ç½®é”™è¯¯ç­‰å¼‚å¸¸æƒ…å†µ
- **èµ„æºç›‘æ§**ï¼šå†…å­˜ä½¿ç”¨ã€CPUä½¿ç”¨ç­‰èµ„æºæŒ‡æ ‡

## åä¸€ã€æ€»ç»“

### 1. è®¾è®¡äº®ç‚¹
- **æ¨¡å¼çµæ´»**ï¼šæ”¯æŒæ­£å‘/åå‘æº¯æºæ¨¡å¼åˆ‡æ¢
- **é»˜è®¤åå‘**ï¼šé»˜è®¤ä½¿ç”¨åå‘æº¯æºï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
- **é€‚åº¦æ™ºèƒ½**ï¼šæº¯æºé€»è¾‘ä¸è¿‡åº¦å¤æ‚ï¼Œä¿æŒå¯ç»´æŠ¤æ€§
- **å‰ç«¯å‹å¥½**ï¼šæº¯æºä¿¡æ¯å®Œå…¨æ»¡è¶³å‰ç«¯æ˜¾ç¤ºå’Œäº¤äº’éœ€æ±‚

### 2. æŠ€æœ¯ä¼˜åŠ¿
- **æ¶æ„æ¸…æ™°**ï¼šæº¯æºé€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
- **æ€§èƒ½ä¼˜ç§€**ï¼šæº¯æºå¤„ç†å¿«é€Ÿï¼Œä¸å½±å“æŸ¥è¯¢æ€§èƒ½
- **æ‰©å±•æ€§å¥½**ï¼šæ”¯æŒæ–°å¢æº¯æºç­–ç•¥å’Œä¼˜åŒ–ç®—æ³•
- **é›†æˆç®€å•**ï¼šä¸V3ç³»ç»Ÿé›†æˆåªéœ€è¦å‡ è¡Œä»£ç 

### 3. åº”ç”¨ä»·å€¼
- **ç”¨æˆ·ä½“éªŒæå‡**ï¼šæ¸…æ™°ã€ç¾è§‚çš„æº¯æºä¿¡æ¯å±•ç¤º
- **ç³»ç»Ÿçµæ´»æ€§æå‡**ï¼šæ”¯æŒä¸åŒåœºæ™¯çš„æº¯æºéœ€æ±‚
- **ç»´æŠ¤æˆæœ¬é™ä½**ï¼šä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
- **æº¯æºè´¨é‡æå‡**ï¼šæ™ºèƒ½åŒ¹é…ç¡®ä¿æº¯æºå‡†ç¡®æ€§

### 4. ä¸V2çš„å¯¹æ¯”
| æ–¹é¢           | V2ç³»ç»Ÿ                 | V3ç³»ç»Ÿ                  |
| -------------- | ---------------------- | ----------------------- |
| **æº¯æºé€»è¾‘**   | å¤æ‚è¿‡æ»¤å¼•æ“ï¼Œç±»å‹ç‰¹åŒ– | ç»Ÿä¸€æº¯æºæœåŠ¡ï¼Œæ¨¡å¼åˆ‡æ¢  |
| **ä»£ç é‡**     | 700+ è¡Œ                | 200-300 è¡Œ              |
| **ç»´æŠ¤æˆæœ¬**   | é«˜ï¼ˆå¤æ‚è¿‡æ»¤é€»è¾‘ï¼‰     | ä½ï¼ˆæ¸…æ™°æº¯æºé€»è¾‘ï¼‰      |
| **ç”¨æˆ·ä½“éªŒ**   | ä¸­ç­‰ï¼ˆåŸºç¡€æº¯æºæ˜¾ç¤ºï¼‰   | å¥½ï¼ˆæ™ºèƒ½æº¯æº+ç°ä»£å‰ç«¯ï¼‰ |
| **ç³»ç»Ÿçµæ´»æ€§** | ä½ï¼ˆå›ºå®šæº¯æºç­–ç•¥ï¼‰     | é«˜ï¼ˆæ”¯æŒæ¨¡å¼åˆ‡æ¢ï¼‰      |

è¿™ä¸ªV3æº¯æºæ¨¡å—è®¾è®¡å……åˆ†ä½“ç°äº†"çµæ´»æ§åˆ¶+é»˜è®¤ç­–ç•¥"çš„è®¾è®¡ç†å¿µï¼Œåœ¨ä¿æŒæº¯æºè´¨é‡çš„åŒæ—¶ï¼Œæä¾›äº†æ¨¡å¼åˆ‡æ¢çš„çµæ´»æ€§ï¼Œæ—¢æ»¡è¶³äº†ä¸åŒåœºæ™¯çš„éœ€æ±‚ï¼Œåˆç¡®ä¿äº†ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§ã€‚é€šè¿‡é€‚åº¦çš„æ™ºèƒ½å¤„ç†å’Œç°ä»£å‰ç«¯æŠ€æœ¯ï¼Œä¸ºç”¨æˆ·æä¾›äº†æ¸…æ™°ã€ç¾è§‚ã€æœ‰ç”¨çš„æº¯æºä¿¡æ¯ï¼Œå®Œå…¨ç¬¦åˆV3ç³»ç»Ÿçš„è®¾è®¡åŸåˆ™ã€‚