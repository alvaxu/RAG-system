好的，让我总结一下对于 text 和 table 需要做的修改。

## **📋 Text 和 Table 修改总结**

### **🎯 目标**
**移除 TextProcessor 和 TableProcessor，让 ContentProcessor 直接使用 ContentMetadataExtractor 的结果，简化整个数据流。**

### **�� 需要修改的文件和内容**

#### **1. 修改 TextVectorizer.vectorize_batch()**
**文件：** `v3/vectorization/text_vectorizer.py`
**修改内容：**
```python
def vectorize_batch(self, texts: List[Dict]) -> List[Dict[str, Any]]:
    vectorized_texts = []
    
    for i, text_item in enumerate(texts):
        try:
            # 修改：使用 'text' 而不是 'text_content'
            text_content = text_item.get('text', '')  # ← 这里改为 'text'
            metadata = text_item.get('metadata', {})
            
            if not text_content:
                logging.warning(f"文本 {i+1} 缺少内容")
                continue
            
            # ... 其他逻辑保持不变
```

#### **2. 修改 TableVectorizer.vectorize_batch()**
**文件：** `v3/vectorization/table_vectorizer.py`
**修改内容：**
```python
def vectorize_batch(self, tables: List[Dict]) -> List[Dict[str, Any]]:
    vectorized_tables = []
    
    for i, table_item in enumerate(tables):
        try:
            # 修改：使用 'table_content' 而不是 'table_body'
            table_content = table_item.get('table_content', '')  # ← 这里改为 'table_content'
            metadata = table_item.get('metadata', {})
            
            if not table_content:
                logging.warning(f"表格 {i+1} 缺少内容")
                continue
            
            # ... 其他逻辑保持不变
```

#### **3. 修改 TableVectorizer.vectorize() 方法签名**
**文件：** `v3/vectorization/table_vectorizer.py`
**修改内容：**
```python
def vectorize(self, table_content: str, metadata: Dict = None) -> Dict[str, Any]:
    """
    对单个表格进行向量化
    
    :param table_content: 表格纯文本内容（用于向量化）
    :param metadata: 表格元数据
    :return: 向量化结果字典
    """
    try:
        if not table_content or not table_content.strip():
            raise ValueError("表格内容为空")
        
        logging.info(f"开始向量化表格: {table_content[:50]}...")
        
        # 步骤1: 表格内容预处理（已经是纯文本，不需要再提取）
        processed_content = self._preprocess_table_content(table_content)
        
        # ... 其他逻辑保持不变
```

#### **4. 修改 ContentProcessor.process_document_content()**
**文件：** `v3/core/content_processor.py`
**修改内容：**
```python
def process_document_content(self, json_path: str, doc_name: str) -> Dict[str, Any]:
    try:
        start_time = time.time()
        logging.info(f"开始处理文档内容: {doc_name}")
        
        # 1. 提取元数据（已经包含完整的 text 和 table 处理结果）
        metadata_results = self.metadata_extractor.extract_metadata_from_json(json_path, doc_name)
        
        # 2. 处理文本内容（直接使用，不需要再处理）
        if metadata_results.get('text_chunks'):
            text_count = len(metadata_results['text_chunks'])
            logging.info(f"文本处理完成: {text_count} 个（预分析已完成）")
            # 移除：metadata_results['text_chunks'] = self.text_processor.process_batch(...)
        
        # 3. 处理表格内容（直接使用，不需要再处理）
        if metadata_results.get('tables'):
            table_count = len(metadata_results['tables'])
            logging.info(f"表格处理完成: {table_count} 个（预分析已完成）")
            # 移除：metadata_results['tables'] = self.table_processor.process_batch(...)
        
        # 4. 处理图片内容（需要 AI 增强和向量化）
        if metadata_results.get('images'):
            image_count = len(metadata_results['images'])
            logging.info(f"处理图片: {image_count} 张")
            metadata_results['images'] = self.image_processor.process_images(
                metadata_results['images']
            )
            logging.info(f"图片处理完成: {image_count} 张")
        
        # ... 其他逻辑保持不变
```

#### **5. 修改 ContentProcessor 的初始化**
**文件：** `v3/core/content_processor.py`
**修改内容：**
```python
def __init__(self, config_manager):
    self.config_manager = config_manager
    self.config = config_manager.get_all_config()
    
    # 获取失败处理器
    self.failure_handler = config_manager.get_failure_handler()
    
    # 移除：self._initialize_processors() 中的 text_processor 和 table_processor
    
    # 只保留 image_processor（因为图片确实需要 AI 增强和向量化）
    from processors.image_processor import ImageProcessor
    self.image_processor = ImageProcessor(config_manager)
    
    # 初始化元数据提取器
    self.metadata_extractor = ContentMetadataExtractor(config_manager)
    
    # ... 其他逻辑保持不变
```

### **��️ 可以删除的文件**

1. **`v3/processors/text_processor.py`** - 完全删除
2. **`v3/processors/table_processor.py`** - 完全删除

### **�� 修改后的数据流**

```
修改前：
ContentMetadataExtractor.extract_metadata_from_json()
    ↓
ContentProcessor.process_document_content()
    ├── TextProcessor.process_batch()     # 元数据重包装
    ├── TableProcessor.process_batch()    # 元数据重包装
    └── ImageProcessor.process_images()   # 实质工作
    ↓
VectorizationManager.vectorize_all_content()
    ├── TextVectorizer.vectorize_batch()     # 需要字段转换
    └── TableVectorizer.vectorize_batch()    # 需要字段转换

修改后：
ContentMetadataExtractor.extract_metadata_from_json()
    ↓ (直接生成标准格式)
ContentProcessor.process_document_content()
    ├── 直接使用 text_chunks（无需处理）
    ├── 直接使用 tables（无需处理）
    └── ImageProcessor.process_images()   # 实质工作
    ↓
VectorizationManager.vectorize_all_content()
    ├── TextVectorizer.vectorize_batch()     # 直接使用 'text' 字段
    └── TableVectorizer.vectorize_batch()    # 直接使用 'table_content' 字段
```

### **✅ 修改后的优势**

1. **简化架构**：移除不必要的 Processor 层
2. **提高性能**：避免重复的元数据生成和转换
3. **减少维护成本**：减少代码重复和复杂性
4. **数据一致性**：确保字段名在整个流程中保持一致

**这样修改后，text 和 table 的处理就完全简化了，整个系统更加高效和易于维护。**