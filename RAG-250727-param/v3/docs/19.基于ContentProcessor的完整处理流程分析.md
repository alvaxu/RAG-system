## ğŸ“‹ **åŸºäºContentProcessorçš„å®Œæ•´å¤„ç†æµç¨‹åˆ†æ**

è®©æˆ‘åˆ†æ `ContentProcessor.process_document_content()` æ–¹æ³•ï¼Œå®Œæ•´æè¿°å¯¹textã€tableå’Œimageçš„å¤„ç†è¿‡ç¨‹ã€‚

### **ï¿½ï¿½ åˆ†æContentProcessor.process_document_content()æ–¹æ³•**

ä»ä»£ç åˆ†æï¼Œ`process_document_content()` æ–¹æ³•æ˜¯å†…å®¹å¤„ç†çš„æ ¸å¿ƒå…¥å£ï¼Œå®ƒåè°ƒäº†ä¸‰ä¸ªä¸“ç”¨å¤„ç†å™¨ï¼š

```python
def process_document_content(self, json_path: str, doc_name: str) -> Dict[str, Any]:
    """
    å¤„ç†æ–‡æ¡£å†…å®¹ï¼Œä»JSONæ–‡ä»¶æå–å¹¶å¤„ç†æ‰€æœ‰å†…å®¹ç±»å‹
    
    :param json_path: JSONæ–‡ä»¶è·¯å¾„
    :param doc_name: æ–‡æ¡£åç§°
    :return: å¤„ç†ç»“æœ
    """
```

### **ğŸ“Š å®Œæ•´å¤„ç†æµç¨‹å›¾**

```
ContentProcessor.process_document_content(json_path, doc_name)
    â†“
1. æå–å…ƒæ•°æ® (ContentMetadataExtractor.extract_metadata_from_json)
    â†“
2. å¤„ç†æ–‡æœ¬å†…å®¹ (TextProcessor.process_batch)
    â†“
3. å¤„ç†è¡¨æ ¼å†…å®¹ (TableProcessor.process_batch)
    â†“
4. å¤„ç†å›¾ç‰‡å†…å®¹ (ImageProcessor.process_images)
    â†“
5. è¿”å›å®Œæ•´å¤„ç†ç»“æœ
```

### **ğŸ”§ è¯¦ç»†å¤„ç†æ­¥éª¤åˆ†æ**

#### **æ­¥éª¤1ï¼šå…ƒæ•°æ®æå–**
```python
# 1. æå–å…ƒæ•°æ®
metadata_results = self.metadata_extractor.extract_metadata_from_json(json_path, doc_name)
```
- **åŠŸèƒ½**ï¼šä»JSONæ–‡ä»¶ä¸­æå–æ‰€æœ‰å†…å®¹ç±»å‹çš„å…ƒæ•°æ®
- **è¾“å‡º**ï¼šåŒ…å« `text_chunks`ã€`tables`ã€`images` çš„å®Œæ•´å…ƒæ•°æ®ç»“æ„
- **ä½œç”¨**ï¼šä¸ºåç»­å¤„ç†æä¾›å†…å®¹åˆ†ç±»å’ŒåŸºç¡€ä¿¡æ¯

#### **æ­¥éª¤2ï¼šæ–‡æœ¬å†…å®¹å¤„ç†**
```python
# 2. å¤„ç†æ–‡æœ¬å†…å®¹
if metadata_results.get('text_chunks'):
    text_count = len(metadata_results['text_chunks'])
    logging.info(f"å¤„ç†æ–‡æœ¬å—: {text_count} ä¸ª")
    metadata_results['text_chunks'] = self.text_processor.process_batch(
        metadata_results['text_chunks']
    )
    self.processing_statistics['total_text_chunks'] += text_count
    logging.info(f"æ–‡æœ¬å¤„ç†å®Œæˆ: {text_count} ä¸ª")
```

**TextProcessor.process_batch() å†…éƒ¨æµç¨‹ï¼š**
```
TextProcessor.process_batch(text_chunks)
    â†“
â”œâ”€â”€ æ™ºèƒ½åˆ†å—å¤„ç†
â”œâ”€â”€ æ–‡æœ¬é¢„å¤„ç†ï¼ˆæ ‡å‡†åŒ–æ ‡ç‚¹ç¬¦å·ï¼Œå»é™¤ç‰¹æ®Šå­—ç¬¦ï¼‰
â”œâ”€â”€ æ–‡æœ¬åˆ†æï¼ˆè¯­ä¹‰åˆ†æï¼Œç»“æ„è¯†åˆ«ï¼‰
â”œâ”€â”€ å…ƒæ•°æ®ç”Ÿæˆï¼ˆä¸¥æ ¼æŒ‰ç…§TEXT_METADATA_SCHEMAï¼‰
â””â”€â”€ è¿”å›å¤„ç†åçš„æ–‡æœ¬å—åˆ—è¡¨
```

**å¤„ç†ç‰¹ç‚¹ï¼š**
- âœ… **æ‰¹é‡å¤„ç†**ï¼šä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰æ–‡æœ¬å—
- âœ… **æ™ºèƒ½åˆ†å—**ï¼šåŸºäºé…ç½®çš„æ–‡æœ¬åˆ†å—ç­–ç•¥
- âœ… **å…ƒæ•°æ®è§„èŒƒ**ï¼šä¸¥æ ¼æŒ‰ç…§è®¾è®¡æ–‡æ¡£çš„å…ƒæ•°æ®è§„èŒƒ
- âœ… **ç»Ÿè®¡è·Ÿè¸ª**ï¼šæ›´æ–°å¤„ç†ç»Ÿè®¡ä¿¡æ¯

#### **æ­¥éª¤3ï¼šè¡¨æ ¼å†…å®¹å¤„ç†**
```python
# 3. å¤„ç†è¡¨æ ¼å†…å®¹
if metadata_results.get('tables'):
    table_count = len(metadata_results['tables'])
    logging.info(f"å¤„ç†è¡¨æ ¼: {table_count} ä¸ª")
    metadata_results['tables'] = self.table_processor.process_batch(
        metadata_results['tables']
    )
    self.processing_statistics['total_tables'] += table_count
    logging.info(f"è¡¨æ ¼å¤„ç†å®Œæˆ: {table_count} ä¸ª")
```

**TableProcessor.process_batch() å†…éƒ¨æµç¨‹ï¼š**
```
TableProcessor.process_batch(tables)
    â†“
â”œâ”€â”€ è¡¨æ ¼ç»“æ„åˆ†æï¼ˆè¯†åˆ«è¡¨å¤´ã€åˆ†éš”ç¬¦ã€æ•°æ®ç±»å‹ï¼‰
â”œâ”€â”€ è¡¨æ ¼å†…å®¹æå–ï¼ˆæ–‡æœ¬å†…å®¹ã€æ•°å€¼æ•°æ®ï¼‰
â”œâ”€â”€ è¡¨æ ¼åˆ†å—å¤„ç†ï¼ˆå¤§å‹è¡¨æ ¼æŒ‰è¡Œåˆ†å—ï¼‰
â”œâ”€â”€ HTMLæ ¼å¼ç”Ÿæˆï¼ˆæ ‡å‡†åŒ–è¡¨æ ¼è¡¨ç¤ºï¼‰
â”œâ”€â”€ å…ƒæ•°æ®ç”Ÿæˆï¼ˆä¸¥æ ¼æŒ‰ç…§TABLE_METADATA_SCHEMAï¼‰
â””â”€â”€ è¿”å›å¤„ç†åçš„è¡¨æ ¼åˆ—è¡¨
```

**å¤„ç†ç‰¹ç‚¹ï¼š**
- âœ… **ç»“æ„åˆ†æ**ï¼šæ™ºèƒ½è¯†åˆ«è¡¨æ ¼ç»“æ„å’Œç±»å‹
- âœ… **å†…å®¹æå–**ï¼šæå–è¡¨æ ¼ä¸­çš„æ–‡æœ¬å’Œæ•°å€¼ä¿¡æ¯
- âœ… **æ ¼å¼æ ‡å‡†åŒ–**ï¼šç”Ÿæˆæ ‡å‡†HTMLè¡¨æ ¼è¡¨ç¤º
- âœ… **åˆ†å—å¤„ç†**ï¼šæ”¯æŒå¤§å‹è¡¨æ ¼çš„åˆ†å—å¤„ç†

#### **æ­¥éª¤4ï¼šå›¾ç‰‡å†…å®¹å¤„ç†ï¼ˆåŒ…å«å‘é‡åŒ–ï¼‰**
```python
# 4. å¤„ç†å›¾ç‰‡å†…å®¹ï¼ˆåŒ…æ‹¬å¢å¼ºå’Œå‘é‡åŒ–ï¼‰
if metadata_results.get('images'):
    image_count = len(metadata_results['images'])
    logging.info(f"å¤„ç†å›¾ç‰‡: {image_count} å¼ ")
    metadata_results['images'] = self.image_processor.process_images(
        metadata_results['images']
    )
    self.processing_statistics['total_images'] += image_count
    logging.info(f"å›¾ç‰‡å¤„ç†å®Œæˆ: {image_count} å¼ ")
```

**ImageProcessor.process_images() å†…éƒ¨æµç¨‹ï¼š**
```
ImageProcessor.process_images(images)
    â†“
â”œâ”€â”€ å›¾ç‰‡ä¿¡æ¯æå–ï¼ˆè·¯å¾„ã€æ ¼å¼ã€å°ºå¯¸ç­‰ï¼‰
â”œâ”€â”€ å›¾ç‰‡å¤åˆ¶ï¼ˆåˆ°æŒ‡å®šç›®å½•ï¼‰
â”œâ”€â”€ å›¾ç‰‡å¢å¼ºï¼ˆé€šè¿‡DashScope APIï¼‰
â”‚   â”œâ”€â”€ å›¾åƒæè¿°ç”Ÿæˆ
â”‚   â””â”€â”€ å›¾åƒè´¨é‡ä¼˜åŒ–
â”œâ”€â”€ åŒé‡å‘é‡åŒ–
â”‚   â”œâ”€â”€ è§†è§‰å‘é‡ï¼ˆå›¾åƒæœ¬èº«ï¼‰
â”‚   â””â”€â”€ è¯­ä¹‰å‘é‡ï¼ˆå¢å¼ºæè¿°ï¼‰
â”œâ”€â”€ å…ƒæ•°æ®ç”Ÿæˆï¼ˆä¸¥æ ¼æŒ‰ç…§IMAGE_METADATA_SCHEMAï¼‰
â””â”€â”€ è¿”å›å¤„ç†åçš„å›¾ç‰‡åˆ—è¡¨ï¼ˆåŒ…å«å‘é‡ï¼‰
```

**å¤„ç†ç‰¹ç‚¹ï¼š**
- âœ… **å®Œæ•´æµç¨‹**ï¼šä»å›¾ç‰‡æå–åˆ°å‘é‡åŒ–çš„å®Œæ•´å¤„ç†
- âœ… **åŒé‡å‘é‡åŒ–**ï¼šè§†è§‰å‘é‡ + è¯­ä¹‰å‘é‡çš„åŒé‡ç­–ç•¥
- âœ… **å¢å¼ºå¤„ç†**ï¼šé€šè¿‡AIæ¨¡å‹ç”Ÿæˆå›¾åƒæè¿°
- âœ… **å‘é‡ç”Ÿæˆ**ï¼šç›´æ¥ç”Ÿæˆå¯ç”¨çš„å‘é‡æ•°æ®

### **ğŸ“ˆ å¤„ç†ç»Ÿè®¡å’ŒçŠ¶æ€è·Ÿè¸ª**

```python
# æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
processing_time = time.time() - start_time
self.processing_statistics['total_documents'] += 1
self.processing_statistics['successful_processing'] += 1
self.processing_statistics['last_processing_time'] = int(time.time())
```

**ç»Ÿè®¡ä¿¡æ¯åŒ…æ‹¬ï¼š**
- `total_documents`: å¤„ç†çš„æ–‡æ¡£æ€»æ•°
- `total_text_chunks`: å¤„ç†çš„æ–‡æœ¬å—æ€»æ•°
- `total_images`: å¤„ç†çš„å›¾ç‰‡æ€»æ•°
- `total_tables`: å¤„ç†çš„è¡¨æ ¼æ€»æ•°
- `successful_processing`: æˆåŠŸå¤„ç†çš„æ•°é‡
- `failed_processing`: å¤±è´¥å¤„ç†çš„æ•°é‡
- `last_processing_time`: æœ€åå¤„ç†æ—¶é—´

### **ğŸ”„ é”™è¯¯å¤„ç†å’Œå¤±è´¥ç®¡ç†**

```python
except Exception as e:
    error_msg = f"æ–‡æ¡£å†…å®¹å¤„ç†å¤±è´¥: {doc_name}, é”™è¯¯: {e}"
    logging.error(error_msg)
    
    # è®°å½•å¤±è´¥
    self.failure_handler.record_failure(json_path, 'document_content_processing', str(e))
    
    # æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    self.processing_statistics['failed_processing'] += 1
    
    raise RuntimeError(error_msg)
```

**é”™è¯¯å¤„ç†æœºåˆ¶ï¼š**
- âœ… **å¼‚å¸¸æ•è·**ï¼šæ•è·æ‰€æœ‰å¤„ç†è¿‡ç¨‹ä¸­çš„å¼‚å¸¸
- âœ… **å¤±è´¥è®°å½•**ï¼šé€šè¿‡FailureHandlerè®°å½•å¤±è´¥ä¿¡æ¯
- âœ… **ç»Ÿè®¡æ›´æ–°**ï¼šæ›´æ–°å¤±è´¥å¤„ç†ç»Ÿè®¡
- âœ… **é”™è¯¯ä¼ æ’­**ï¼šå‘ä¸Šå±‚æŠ›å‡ºRuntimeError

### **ï¿½ï¿½ å¤„ç†ç»“æœç»“æ„**

**æˆåŠŸå¤„ç†åçš„è¿”å›ç»“æœï¼š**
```python
{
    'text_chunks': [å¤„ç†åçš„æ–‡æœ¬å—åˆ—è¡¨],
    'tables': [å¤„ç†åçš„è¡¨æ ¼åˆ—è¡¨],
    'images': [å¤„ç†åçš„å›¾ç‰‡åˆ—è¡¨ï¼ˆåŒ…å«å‘é‡ï¼‰],
    'metadata': {æ–‡æ¡£çº§åˆ«çš„å…ƒæ•°æ®},
    'processing_statistics': {å¤„ç†ç»Ÿè®¡ä¿¡æ¯}
}
```

**æ¯ä¸ªå†…å®¹ç±»å‹éƒ½åŒ…å«ï¼š**
- **å¤„ç†çŠ¶æ€**ï¼šsuccess/failed
- **å¤„ç†å†…å®¹**ï¼šåŸå§‹å†…å®¹ + å¤„ç†ç»“æœ
- **å…ƒæ•°æ®**ï¼šç¬¦åˆè®¾è®¡æ–‡æ¡£è§„èŒƒçš„å…ƒæ•°æ®
- **å‘é‡æ•°æ®**ï¼šå›¾ç‰‡åŒ…å«åŒé‡å‘é‡ï¼Œæ–‡æœ¬/è¡¨æ ¼ä¸ºåç»­å‘é‡åŒ–å‡†å¤‡

### **ğŸ” å…³é”®è®¾è®¡ç‰¹ç‚¹æ€»ç»“**

1. **ç»Ÿä¸€å…¥å£**ï¼š`process_document_content()` ä½œä¸ºå•ä¸€å…¥å£ç‚¹
2. **æ¨¡å—åŒ–å¤„ç†**ï¼šä¸‰ä¸ªä¸“ç”¨å¤„ç†å™¨å„å¸å…¶èŒ
3. **æ‰¹é‡å¤„ç†**ï¼šæ”¯æŒæ‰¹é‡å†…å®¹å¤„ç†ï¼Œæé«˜æ•ˆç‡
4. **å®Œæ•´æµç¨‹**ï¼šå›¾ç‰‡å¤„ç†åŒ…å«å®Œæ•´çš„å‘é‡åŒ–æµç¨‹
5. **ç»Ÿè®¡è·Ÿè¸ª**ï¼šå…¨é¢çš„å¤„ç†ç»Ÿè®¡å’ŒçŠ¶æ€è·Ÿè¸ª
6. **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œå¤±è´¥ç®¡ç†
7. **å…ƒæ•°æ®è§„èŒƒ**ï¼šä¸¥æ ¼æŒ‰ç…§è®¾è®¡æ–‡æ¡£çš„å…ƒæ•°æ®è§„èŒƒ
8. **å‘é‡åŒ–é›†æˆ**ï¼šå›¾ç‰‡å‘é‡åŒ–ç›´æ¥é›†æˆï¼Œæ–‡æœ¬/è¡¨æ ¼ä¸ºåç»­å‘é‡åŒ–å‡†å¤‡

è¿™ä¸ªè®¾è®¡ç¡®ä¿äº†å†…å®¹å¤„ç†çš„å®Œæ•´æ€§ã€ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œå®Œå…¨ç¬¦åˆV3æ¶æ„çš„è®¾è®¡è¦æ±‚ã€‚