# 库存管理模块详细设计文档

## 一、文档基础信息

| 模块名称 | 库存管理模块                           | 所属项目 | [填写项目全称，如 “中小商家库存管理系统”] |
| -------- | -------------------------------------- | -------- | ----------------------------------------- |
| 文档版本 | V1.0                                   | 文档状态 | □ 草稿 □ 评审中 □ 已确认 □ 已归档         |
| 编写人   | __________                             | 编写日期 | ____年__月__日                            |
| 关联文档 | 《项目简要设计文档》《数据库设计总纲》 |          |                                           |

## 二、模块概述

### 1. 定位与目标

作为系统**核心数据支撑模块**，承担库存数据存储、更新、查询核心职责，为 “入库管理”“出库管理”“预警管理” 提供实时准确的库存数据，同时通过日志记录与数据同步保障库存一致性，避免业务风险。

### 2. 依赖与交互

| 关联模块     | 交互方向 | 核心交互内容                                       |
| ------------ | -------- | -------------------------------------------------- |
| 入库管理模块 | 接收数据 | 接收入库订单确认信息，更新库存数量                 |
| 出库管理模块 | 双向交互 | 出库前校验库存余量，出库后扣减库存                 |
| 预警管理模块 | 提供数据 | 推送 “商品 ID + 当前库存 + 预警阈值”，支撑预警判断 |
| 报表中心模块 | 提供数据 | 响应库存变动、当前库存等查询请求，生成报表         |

## 三、核心功能设计

### 1. 功能清单

| 功能 ID | 功能名称     | 核心描述                                                     | 操作角色           | 前置条件                    |
| ------- | ------------ | ------------------------------------------------------------ | ------------------ | --------------------------- |
| FM01    | 库存查询     | 按商品 ID / 分类 / 库存状态（正常 / 预警 / 缺货）筛选，分页展示库存数据 | 管理员、店长、仓管 | 已登录 + 有 “库存查询” 权限 |
| FM02    | 手动调整     | 修改单个商品库存，需填写调整原因，生成变动记录               | 仅系统管理员       | 已登录 + 有 “库存调整” 权限 |
| FM03    | 变动记录查询 | 按时间范围 / 变动类型（入库 / 出库 / 调整）筛选，查看历史操作 | 管理员、仓管       | 已登录 + 有 “日志查询” 权限 |
| FM04    | 数据同步     | 定时（5 分钟）或手动触发，同步订单与库存数据，校准偏差       | 仅系统管理员       | 已登录 + 有 “数据同步” 权限 |

### 2. 关键功能流程（手动调整为例）

1. 管理员在 “库存列表” 找到目标商品→点击 “调整库存”；

1. 输入 “目标库存” 与 “调整原因”→提交请求；

1. 系统校验权限与数据合法性（目标库存≥0、商品 ID 存在）；

1. 校验通过→更新库存表→生成变动记录；

1. 前端展示 “调整成功” 提示，刷新库存数据。

## 四、核心函数设计与调用关系

### 1. 函数清单

| 函数名                                                  | 功能描述                            | 输入参数                                                     | 返回结果                                        | 所属服务            |
| ------------------------------------------------------- | ----------------------------------- | ------------------------------------------------------------ | ----------------------------------------------- | ------------------- |
| queryStockList(params)                                  | 多条件查询库存，支持分页            | params{productId, categoryId, stockStatus, pageNum, pageSize} | 分页结果 {total, list: 库存数据列表}            | StockQueryService   |
| adjustStock(productId, targetStock, reason, operatorId) | 手动调整库存，含校验逻辑            | 商品 ID、目标库存、调整原因、操作人 ID                       | 结果 {success, beforeStock, afterStock, logId}  | StockOperateService |
| syncStockData(isManual)                                 | 同步订单与库存数据                  | isManual（是否手动：true/false）                             | 结果 {handledCount, calibratedCount, failCount} | StockSyncService    |
| getChangeLog(params)                                    | 查询库存变动记录，支持分页          | params{productId, changeType, startTime, endTime, pageNum}   | 分页结果 {total, list: 日志列表}                | StockLogService     |
| checkPerm(operatorId, permCode)                         | 校验操作人权限（如 “stock:adjust”） | 操作人 ID、权限编码                                          | 结果 {hasPerm, message}                         | AuthService         |

### 2. 关键调用流程

1. 前端提交请求→调用adjustStock函数；

1. 先调用checkPerm(operatorId, "stock:adjust")→无权限则返回失败；

1. 调用queryStockList({productId})→获取当前库存（beforeStock）；

1. 校验 “targetStock≥0”→不满足则返回失败；

1. 更新库存表→调用createChangeLog()生成变动记录；

1. 返回 “调整前后库存 + 日志 ID” 给前端。

## 五、数据结构设计

### 1. 核心数据表

#### 商品库存表（product_stock）

| 字段名            | 数据类型    | 主键 | 说明         | 示例             |
| ----------------- | ----------- | ---- | ------------ | ---------------- |
| product_id        | VARCHAR(32) | 是   | 商品唯一标识 | PROD202405001    |
| stock_quantity    | INT         | 否   | 当前库存数量 | 150              |
| warning_threshold | INT         | 否   | 库存预警阈值 | 50               |
| last_update_time  | DATETIME    | 否   | 最后更新时间 | 2024-05-20 14:30 |

#### 库存变动记录表（stock_change_log）

| 字段名       | 数据类型    | 主键 | 说明         | 示例           |
| ------------ | ----------- | ---- | ------------ | -------------- |
| log_id       | VARCHAR(64) | 是   | 日志唯一标识 | LOG20240520001 |
| product_id   | VARCHAR(32) | 否   | 关联商品 ID  | PROD202405001  |
| change_type  | VARCHAR(20) | 否   | 变动类型     | 手动调整       |
| before_stock | INT         | 否   | 变动前库存   | 150            |
| after_stock  | INT         | 否   | 变动后库存   | 180            |
| operator_id  | VARCHAR(32) | 否   | 操作人 ID    | USER202401003  |

## 六、核心接口设计

| 接口名       | 请求方式 | 请求地址          | 核心参数                         | 返回结果                   | 功能归属 |
| ------------ | -------- | ----------------- | -------------------------------- | -------------------------- | -------- |
| 库存查询接口 | GET      | /api/stock/list   | productId、categoryId、pageNum   | 分页库存数据、总条数       | FM01     |
| 手动调整接口 | POST     | /api/stock/adjust | productId、targetStock、reason   | 调整结果、日志 ID          | FM02     |
| 变动记录接口 | GET      | /api/stock/log    | productId、changeType、startTime | 分页日志数据、总条数       | FM03     |
| 手动同步接口 | POST     | /api/stock/sync   | -                                | 处理订单数、校准数、失败数 | FM04     |

## 七、非功能需求

- **性能**：单条件查询≤300ms，批量操作（500 条）≤5s，并发 100 用户成功率≥99.9%；

- **安全**：接口需 Token + 权限校验，输入参数合法性检查，所有变动可追溯；

- **可靠性**：同步失败生成日志并推送运维告警，核心表每日备份（保留 30 天）。

## 八、风险与应对措施

| 潜在风险         | 应对措施                                                     |
| ---------------- | ------------------------------------------------------------ |
| 误操作调整库存   | 单次调整量超当前库存 50% 时，触发二次审批；提交前增加确认弹窗 |
| 数据同步延迟     | 缩短定时同步周期至 5 分钟，同步失败时立即推送告警            |
| 批量导入数据错误 | 导入前预览校验，标注错误数据（如 “商品 ID 不存在”），支持仅导入合法数据 |

## 九、附件

- 附件 1：模块核心页面原型链接（Figma/AXURE）；

- 附件 2：库存批量导入标准 Excel 模板；

- 附件 3：接口测试用例（含请求参数与预期响应）。