## 📋 阶段三：前端显示优化方案

### 🎯 **目标分析**

基于 `session_memory.json` 的分析，前端显示存在以下问题：

1. **无关图片显示**：检索到5张图片，但只有1张相关
2. **重复显示**：LLM回答中已包含图片ID，前端又重复显示
3. **来源详情混乱**：显示所有检索结果，包括无关内容

### �� **当前问题详细分析**

#### **问题1：智能显示逻辑缺失**

- **现状**：前端直接显示所有sources中的图片
- **问题**：没有根据LLM回答内容过滤图片
- **影响**：用户看到大量无关图片

#### **问题2：去重显示机制缺失**

- **现状**：LLM回答中已包含图片ID，前端又重复显示
- **问题**：同一张图片被显示两次
- **影响**：用户体验差，界面混乱

#### **问题3：来源详情优化不足**

- **现状**：显示所有检索结果的详情
- **问题**：包含大量无关信息
- **影响**：信息过载，用户难以找到相关信息

### 🛠️ **解决方案设计**

#### **方案1：智能显示逻辑**

##### **1.1 LLM回答内容解析**

```javascript
// 解析LLM回答中的图片ID
function extractImageIdsFromAnswer(answer) {
    const imageIdPattern = /\[IMAGE_ID:([a-f0-9]+)\]/g;
    const matches = answer.match(imageIdPattern);
    return matches ? matches.map(match => match.slice(10, -1)) : [];
}

// 解析LLM回答中的关键词
function extractKeywordsFromAnswer(answer) {
    const keywords = [];
    const importantPhrases = [
        '个股走势', '沪深300', '营业收入', '毛利率', '净利率',
        '图表', '表现', '情况', '数据', '图片'
    ];
  
    importantPhrases.forEach(phrase => {
        if (answer.includes(phrase)) {
            keywords.push(phrase);
        }
    });
  
    return keywords;
}
```

##### **1.2 智能图片过滤**

```javascript
// 根据LLM回答过滤图片
function filterImagesByAnswer(answer, sources) {
    const mentionedImageIds = extractImageIdsFromAnswer(answer);
    const mentionedKeywords = extractKeywordsFromAnswer(answer);
  
    return sources.filter(source => {
        // 检查图片ID匹配
        if (source.metadata?.image_id) {
            if (mentionedImageIds.includes(source.metadata.image_id)) {
                return true;
            }
        }
      
        // 检查内容关键词匹配
        const content = source.content?.toLowerCase() || '';
        return mentionedKeywords.some(keyword => 
            content.includes(keyword.toLowerCase())
        );
    });
}
```

#### **方案2：去重显示机制**

##### **2.1 图片ID去重**

```javascript
// 图片去重逻辑
function deduplicateImages(sources) {
    const seenImageIds = new Set();
    const seenImageTitles = new Set();
  
    return sources.filter(source => {
        const imageId = source.metadata?.image_id;
        const imageTitle = source.metadata?.img_caption?.[0];
      
        if (imageId) {
            if (seenImageIds.has(imageId)) {
                return false;
            }
            seenImageIds.add(imageId);
        }
      
        if (imageTitle) {
            if (seenImageTitles.has(imageTitle)) {
                return false;
            }
            seenImageTitles.add(imageTitle);
        }
      
        return true;
    });
}
```

##### **2.2 内容相似度去重**

```javascript
// 基于内容相似度的去重
function deduplicateBySimilarity(sources, threshold = 0.8) {
    const uniqueSources = [];
  
    for (const source of sources) {
        const isDuplicate = uniqueSources.some(existing => 
            calculateSimilarity(source.content, existing.content) > threshold
        );
      
        if (!isDuplicate) {
            uniqueSources.push(source);
        }
    }
  
    return uniqueSources;
}
```

#### **方案3：来源详情优化**

##### **3.1 智能来源分类**

```javascript
// 来源分类逻辑
function categorizeSources(sources, answer) {
    const mentionedImageIds = extractImageIdsFromAnswer(answer);
  
    return {
        relevant: sources.filter(source => 
            mentionedImageIds.includes(source.metadata?.image_id)
        ),
        related: sources.filter(source => 
            !mentionedImageIds.includes(source.metadata?.image_id) &&
            isContentRelated(source.content, answer)
        ),
        other: sources.filter(source => 
            !mentionedImageIds.includes(source.metadata?.image_id) &&
            !isContentRelated(source.content, answer)
        )
    };
}
```

##### **3.2 分层显示逻辑**

```javascript
// 分层显示来源详情
function displaySourcesByCategory(categorizedSources) {
    const { relevant, related, other } = categorizedSources;
  
    return {
        primary: relevant,      // 主要相关来源
        secondary: related,     // 次要相关来源
        tertiary: other.slice(0, 2)  // 其他来源（限制数量）
    };
}
```

### 🎨 **用户界面优化**

#### **3.1 智能显示组件**

```javascript
// 智能图片显示组件
function SmartImageDisplay({ answer, sources }) {
    const filteredImages = filterImagesByAnswer(answer, sources);
    const deduplicatedImages = deduplicateImages(filteredImages);
  
    return (
        <div className="smart-image-display">
            {deduplicatedImages.length > 0 ? (
                <div className="relevant-images">
                    <h4>相关图片</h4>
                    {deduplicatedImages.map(image => (
                        <ImageCard key={image.metadata.image_id} image={image} />
                    ))}
                </div>
            ) : (
                <div className="no-images">
                    <p>未找到相关图片</p>
                </div>
            )}
        </div>
    );
}
```

#### **3.2 来源详情组件**

```javascript
// 智能来源详情组件
function SmartSourcesDisplay({ answer, sources }) {
    const categorizedSources = categorizeSources(sources, answer);
    const displaySources = displaySourcesByCategory(categorizedSources);
  
    return (
        <div className="smart-sources-display">
            {displaySources.primary.length > 0 && (
                <div className="primary-sources">
                    <h4>主要来源</h4>
                    {displaySources.primary.map(source => (
                        <SourceCard key={source.id} source={source} priority="high" />
                    ))}
                </div>
            )}
          
            {displaySources.secondary.length > 0 && (
                <div className="secondary-sources">
                    <h4>相关来源</h4>
                    {displaySources.secondary.map(source => (
                        <SourceCard key={source.id} source={source} priority="medium" />
                    ))}
                </div>
            )}
        </div>
    );
}
```

### 📈 **实施计划**

#### **阶段3.1：核心逻辑实现（2-3天）**

1. **智能显示逻辑**

   - 实现LLM回答内容解析
   - 实现智能图片过滤
   - 实现关键词匹配
2. **去重显示机制**

   - 实现图片ID去重
   - 实现内容相似度去重
   - 实现标题去重
3. **来源详情优化**

   - 实现来源分类逻辑
   - 实现分层显示
   - 实现智能排序

#### **阶段3.2：用户界面优化（1-2天）**

1. **组件开发**

   - 开发智能图片显示组件
   - 开发智能来源详情组件
   - 开发去重显示组件
2. **样式优化**

   - 优化图片显示样式
   - 优化来源详情样式
   - 优化响应式布局

#### **阶段3.3：测试和优化（1天）**

1. **功能测试**

   - 测试智能过滤功能
   - 测试去重显示功能
   - 测试来源分类功能
2. **性能优化**

   - 优化解析性能
   - 优化渲染性能
   - 优化用户体验

### 🎯 **预期效果**

#### **用户体验提升**

- **无关内容减少**：80-90%
- **重复显示消除**：100%
- **信息清晰度提升**：60-80%

#### **技术指标**

- **响应速度**：提升20-30%
- **内存使用**：减少15-25%
- **代码可维护性**：显著提升

### �� **实施优先级**

#### **优先级1：智能显示逻辑**

- 影响最大，用户感受最明显
- 实现相对简单，风险较低
- 可以快速见效

#### **优先级2：去重显示机制**

- 用户体验提升明显
- 实现复杂度中等
- 与智能显示逻辑配合

#### **优先级3：来源详情优化**

- 信息组织更清晰
- 实现复杂度较高
- 需要更多测试和优化

您觉得这个方案如何？我们是否应该从优先级1开始实施？
