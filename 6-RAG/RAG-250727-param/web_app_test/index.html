<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAGæ™ºèƒ½æ–‡æ¡£é—®ç­”ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #0d1117;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            background: #0d1117;
        }

        .sidebar {
            width: 280px;
            background: #161b22;
            border-right: 1px solid #30363d;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            gap: 12px;
            background: #21262d;
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #f0f6fc;
            margin: 0;
        }

        .sidebar-header .robot-icon {
            font-size: 24px;
        }

        .sidebar-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .session-info {
            background: #21262d;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #30363d;
            margin-bottom: 20px;
        }

        .session-info h4 {
            color: #f0f6fc;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .session-id {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            background: #0d1117;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            word-break: break-all;
            color: #7d8590;
            border: 1px solid #30363d;
        }

        .preset-questions {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .preset-questions h3 {
            color: #f0f6fc;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 500;
        }

        .preset-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .preset-item {
            background: #21262d;
            padding: 12px 16px;
            border-radius: 6px;
            border: 1px solid #30363d;
            color: #e6edf3;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .preset-item:hover {
            background: #30363d;
            border-color: #58a6ff;
        }

        .memory-panel {
            margin-top: auto;
        }

        .memory-panel h3 {
            color: #f0f6fc;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 500;
        }

        .memory-stats {
            background: #21262d;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #30363d;
            margin-bottom: 12px;
        }

        .memory-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .memory-stat-item:last-child {
            margin-bottom: 0;
        }

        .memory-stat-item span:first-child {
            color: #7d8590;
        }

        .memory-stat-item span:last-child {
            color: #e6edf3;
            font-weight: 500;
        }

        .memory-actions {
            display: flex;
            gap: 8px;
        }

        .memory-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: #21262d;
            color: #e6edf3;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .memory-btn:hover {
            background: #30363d;
        }

        .memory-btn.danger {
            border-color: #da3633;
            color: #da3633;
        }

        .memory-btn.danger:hover {
            background: #da3633;
            color: #f0f6fc;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0d1117;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            max-width: 80%;
            padding: 16px 20px;
            border-radius: 12px;
            position: relative;
        }

        .message.user {
            align-self: flex-end;
            background: #58a6ff;
            color: #f0f6fc;
            margin-left: 20%;
        }

        .message.assistant {
            align-self: flex-start;
            background: #21262d;
            color: #e6edf3;
            margin-right: 20%;
            border: 1px solid #30363d;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            opacity: 0.8;
        }

        .message-content {
            line-height: 1.6;
        }

        .message-content p {
            margin-bottom: 12px;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul, .message-content ol {
            margin-bottom: 12px;
            padding-left: 20px;
        }

        .message-content li {
            margin-bottom: 4px;
        }

        .message-content code {
            background: #0d1117;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message-content pre {
            background: #0d1117;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 12px;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .message-content blockquote {
            border-left: 4px solid #58a6ff;
            padding-left: 16px;
            margin: 12px 0;
            color: #7d8590;
        }

        .message-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            margin: 10px 0;
        }
        
        .message-content h1, .message-content h2, .message-content h3, .message-content h4 {
            color: #f0f6fc;
            margin: 16px 0 8px 0;
        }
        
        .message-content h4 {
            color: #58a6ff;
            font-size: 16px;
            font-weight: 600;
        }
        
        .message-content strong {
            color: #f0f6fc;
            font-weight: 600;
        }
        
        .message-content ul {
            margin: 12px 0;
        }
        
        .message-content li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .message-content .image-container {
            margin: 12px 0;
            text-align: center;
        }

        .message-content .image-container img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            border: 1px solid #30363d;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .message-content .image-caption {
            margin-top: 8px;
            font-size: 12px;
            color: #7d8590;
            text-align: center;
        }

        .cost-info {
            margin-top: 12px;
            padding: 12px;
            background: #0d1117;
            border-radius: 6px;
            border: 1px solid #30363d;
        }

        .cost-info-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .cost-info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .cost-info-item strong {
            font-size: 11px;
            color: #7d8590;
            font-weight: 500;
        }

        .cost-info-item span {
            color: #e6edf3;
            font-size: 12px;
        }
        
        .sources-detail {
            margin-top: 10px;
            padding: 8px;
            background: #161b22;
            border-radius: 6px;
            border-left: 3px solid #58a6ff;
            font-size: 11px;
            line-height: 1.4;
            color: #e6edf3;
        }

        .memory-indicator {
            display: inline-block;
            background: #238636;
            color: #f0f6fc;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 8px;
            font-weight: 500;
        }

        .input-area {
            padding: 20px;
            border-top: 1px solid #30363d;
            background: #0d1117;
        }

        .input-group {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .question-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #30363d;
            border-radius: 8px;
            background: #21262d;
            color: #e6edf3;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .question-input:focus {
            border-color: #58a6ff;
        }

        .question-input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .send-btn {
            padding: 12px 24px;
            background: #238636;
            color: #f0f6fc;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .send-btn:hover:not(:disabled) {
            background: #2ea043;
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            color: #7d8590;
            font-style: italic;
        }

        .error {
            color: #da3633;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0d1117;
        }

        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }

        /* ä¾§è¾¹æ æ»šåŠ¨æ¡ */
        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: #161b22;
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 3px;
        }

        .preset-list::-webkit-scrollbar {
            width: 4px;
        }

        .preset-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .preset-list::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 2px;
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }
            
            .message.user {
                margin-left: 10%;
            }
            
            .message.assistant {
                margin-right: 10%;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid #30363d;
            }
            
            .message.user {
                margin-left: 5%;
            }
            
            .message.assistant {
                margin-right: 5%;
            }
            
            .cost-info-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <span class="robot-icon">ğŸ¤–</span>
                <h1>RAGæ™ºèƒ½é—®ç­”</h1>
            </div>
            
            <div class="sidebar-content">
                <div class="session-info">
                    <h4>ğŸ†” å½“å‰ä¼šè¯</h4>
                    <div class="session-id" id="sessionId">æ­£åœ¨åˆ›å»ºä¼šè¯...</div>
                </div>
                
                <div class="preset-questions">
                    <h3>ğŸ’¡ é¢„è®¾é—®é¢˜</h3>
                    <ul class="preset-list" id="presetList">
                        <li class="loading">åŠ è½½ä¸­...</li>
                    </ul>
                </div>
                
                <div class="memory-panel">
                    <h3>ğŸ§  è®°å¿†ç®¡ç†</h3>
                    <div class="memory-stats" id="memoryStats">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                    <div class="memory-actions">
                        <button class="memory-btn" onclick="clearSessionMemory()">æ¸…é™¤ä¼šè¯</button>
                        <button class="memory-btn danger" onclick="clearAllMemory()">æ¸…é™¤å…¨éƒ¨</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-area">
            <div class="chat-messages" id="chatMessages">
                <div class="message assistant">
                    <div class="message-header">
                        <span>ğŸ¤– AIåŠ©æ‰‹</span>
                        <span>æ¬¢è¿ä½¿ç”¨RAGæ™ºèƒ½æ–‡æ¡£é—®ç­”ç³»ç»Ÿï¼</span>
                    </div>
                    <div class="message-content">
                        <p>æˆ‘æ˜¯æ‚¨çš„AIåŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©æ‚¨åŸºäºæ–‡æ¡£å†…å®¹å›ç­”é—®é¢˜ã€‚ç³»ç»Ÿå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
                        <ul>
                            <li><strong>æ™ºèƒ½æ£€ç´¢</strong>ï¼šåŸºäºå‘é‡æ•°æ®åº“å¿«é€Ÿæ‰¾åˆ°ç›¸å…³å†…å®¹</li>
                            <li><strong>å¤šæ¨¡æ€æ”¯æŒ</strong>ï¼šæ”¯æŒæ–‡æœ¬ã€è¡¨æ ¼å’Œå›¾ç‰‡çš„é—®ç­”</li>
                            <li><strong>è®°å¿†åŠŸèƒ½</strong>ï¼šè®°ä½æˆ‘ä»¬çš„å¯¹è¯å†å²ï¼Œæä¾›æ›´è¿è´¯çš„å›ç­”</li>
                            <li><strong>æ¥æºè¿½è¸ª</strong>ï¼šæ˜¾ç¤ºç­”æ¡ˆçš„æ¥æºä¿¡æ¯å’Œé¡µç </li>
                            <li><strong>å¤šè½®å¯¹è¯</strong>ï¼šæ”¯æŒä¸Šä¸‹æ–‡ç†è§£å’Œè¿ç»­å¯¹è¯</li>
                        </ul>
                        <p>è¯·é€‰æ‹©é¢„è®¾é—®é¢˜æˆ–ç›´æ¥è¾“å…¥æ‚¨çš„é—®é¢˜å¼€å§‹å¯¹è¯ï¼</p>
                    </div>
                </div>
            </div>
            
            <div class="input-area">
                <div class="input-group">
                    <input type="text" class="question-input" id="questionInput" 
                           placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." onkeypress="handleKeyPress(event)">
                    <button class="send-btn" id="sendBtn" onclick="askQuestion()">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentUserId = 'default_user';
        let currentSessionId = null;
        const API_BASE = 'http://localhost:5000/api';

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // åˆ›å»ºç”¨æˆ·ä¼šè¯
            await createSession();
            
            // åŠ è½½é¢„è®¾é—®é¢˜
            await loadPresetQuestions();
            
            // åŠ è½½è®°å¿†ç»Ÿè®¡
            await loadMemoryStats();
            
            console.log('åˆå§‹åŒ–å®Œæˆ');
        });

        // åˆ›å»ºç”¨æˆ·ä¼šè¯
        async function createSession() {
            try {
                // ä½¿ç”¨å›ºå®šçš„ç”¨æˆ·IDï¼Œè¿™æ ·è®°å¿†æ•°æ®èƒ½å¤Ÿä¿æŒä¸€è‡´
                currentUserId = 'default_user';
                currentSessionId = currentUserId;
                document.getElementById('sessionId').textContent = currentUserId;
                console.log('ä¼šè¯åˆ›å»ºæˆåŠŸ:', currentUserId);
            } catch (error) {
                console.error('åˆ›å»ºä¼šè¯æ—¶å‘ç”Ÿé”™è¯¯:', error);
            }
        }

        // åŠ è½½é¢„è®¾é—®é¢˜
        async function loadPresetQuestions() {
            try {
                // ä»APIè·å–é¢„è®¾é—®é¢˜
                const response = await fetch(`${API_BASE}/qa/preset-questions`);
                if (response.ok) {
                    const data = await response.json();
                    const questions = data.questions || [];
                    
                    const presetList = document.getElementById('presetList');
                    presetList.innerHTML = '';
                    
                    questions.forEach(question => {
                        const li = document.createElement('li');
                        li.className = 'preset-item';
                        li.textContent = question;
                        li.onclick = () => {
                            document.getElementById('questionInput').value = question;
                            askQuestion();
                        };
                        presetList.appendChild(li);
                    });
                } else {
                    throw new Error('è·å–é¢„è®¾é—®é¢˜å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½é¢„è®¾é—®é¢˜å¤±è´¥:', error);
                // ä½¿ç”¨é»˜è®¤çš„é¢„è®¾é—®é¢˜ä½œä¸ºåå¤‡
                const defaultQuestions = [
                    "æ–‡æ¡£ä¸­æœ‰å“ªäº›ä¸»è¦å†…å®¹ï¼Ÿ",
                    "è¯·æ€»ç»“ä¸€ä¸‹æ–‡æ¡£çš„æ ¸å¿ƒè§‚ç‚¹",
                    "æ–‡æ¡£ä¸­æåˆ°äº†å“ªäº›å…³é”®æ•°æ®ï¼Ÿ",
                    "æœ‰å“ªäº›é‡è¦çš„å›¾è¡¨æˆ–å›¾ç‰‡ï¼Ÿ",
                    "æ–‡æ¡£çš„ç»“æ„æ˜¯æ€æ ·çš„ï¼Ÿ",
                    "è¯·åˆ†ææ–‡æ¡£ä¸­çš„ä¸»è¦ç»“è®º"
                ];
                
                const presetList = document.getElementById('presetList');
                presetList.innerHTML = '';
                
                defaultQuestions.forEach(question => {
                    const li = document.createElement('li');
                    li.className = 'preset-item';
                    li.textContent = question;
                    li.onclick = () => {
                        document.getElementById('questionInput').value = question;
                        askQuestion();
                    };
                    presetList.appendChild(li);
                });
            }
        }

        // åŠ è½½è®°å¿†ç»Ÿè®¡
        async function loadMemoryStats() {
            try {
                const response = await fetch(`${API_BASE}/memory/stats?user_id=${currentUserId}`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('è®°å¿†ç»Ÿè®¡å“åº”:', data); // æ·»åŠ è°ƒè¯•æ—¥å¿—
                    const stats = data.stats;
                    
                    const memoryStats = document.getElementById('memoryStats');
                    memoryStats.innerHTML = `
                        <div class="memory-stat-item">
                            <span>ä¼šè¯è®°å¿†:</span>
                            <span>${stats.session_memory_count || 0}</span>
                        </div>
                        <div class="memory-stat-item">
                            <span>å†å²è®°å¿†:</span>
                            <span>${stats.user_memory_count || 0}</span>
                        </div>
                        <div class="memory-stat-item">
                            <span>æ€»è®°å¿†æ•°:</span>
                            <span>${stats.total_memory_count || 0}</span>
                        </div>
                    `;
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                console.error('åŠ è½½è®°å¿†ç»Ÿè®¡å¤±è´¥:', error);
                document.getElementById('memoryStats').innerHTML = 
                    '<div class="error">åŠ è½½è®°å¿†ç»Ÿè®¡å¤±è´¥</div>';
            }
        }

        // å¤„ç†é”®ç›˜äº‹ä»¶
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                askQuestion();
            }
        }

        // å‘é€é—®é¢˜
        async function askQuestion() {
            const questionInput = document.getElementById('questionInput');
            const sendBtn = document.getElementById('sendBtn');
            const question = questionInput.value.trim();
            
            if (!question) {
                alert('è¯·è¾“å…¥é—®é¢˜');
                return;
            }
            
            // ç¦ç”¨è¾“å…¥å’ŒæŒ‰é’®
            questionInput.disabled = true;
            sendBtn.disabled = true;
            sendBtn.textContent = 'å¤„ç†ä¸­...';
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage('user', question);
            
            try {
                const response = await fetch(`${API_BASE}/qa/ask`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        user_id: currentUserId,
                        use_memory: true,
                        k: 5
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        // æ·»åŠ AIå›ç­”
                        addMessage('assistant', data.answer, {
                            cost: data.cost,
                            sources: data.sources,
                            timestamp: data.timestamp
                        });
                        
                        // æ¸…ç©ºè¾“å…¥æ¡†
                        questionInput.value = '';
                        
                        // æ›´æ–°è®°å¿†ç»Ÿè®¡
                        await loadMemoryStats();
                    } else {
                        throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
                    }
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'è¯·æ±‚å¤±è´¥');
                }
                
            } catch (error) {
                console.error('å‘é€é—®é¢˜æ—¶å‘ç”Ÿé”™è¯¯:', error);
                addMessage('assistant', `æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„é—®é¢˜æ—¶å‘ç”Ÿé”™è¯¯ï¼š${error.message}`, null, true);
            } finally {
                // æ¢å¤è¾“å…¥å’ŒæŒ‰é’®
                questionInput.disabled = false;
                sendBtn.disabled = false;
                sendBtn.textContent = 'å‘é€';
                questionInput.focus();
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addMessage(type, content, metadata = null, isError = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const header = document.createElement('div');
            header.className = 'message-header';
            
            if (type === 'user') {
                header.innerHTML = `
                    <span>ğŸ‘¤ æ‚¨</span>
                    <span>${new Date().toLocaleTimeString()}</span>
                `;
            } else {
                header.innerHTML = `
                    <span>ğŸ¤– AIåŠ©æ‰‹</span>
                    <span>${new Date().toLocaleTimeString()}</span>
                `;
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (isError) {
                contentDiv.innerHTML = `<p style="color: #da3633;">${content}</p>`;
            } else {
                // å¤„ç†å›¾ç‰‡å†…å®¹ - ä¼˜åŒ–ç‰ˆæœ¬
                let processedContent = content;
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«å›¾ç‰‡ä¿¡æ¯
                if (metadata && metadata.sources) {
                    // é«˜æ•ˆæå–å›¾ç‰‡æ•°æ®
                    const imageSources = metadata.sources.filter(source => 
                        source.metadata && source.metadata.chunk_type === 'image'
                    );
                    
                    if (imageSources.length > 0) {
                        // æ£€æŸ¥AIå›ç­”æ˜¯å¦è¡¨ç¤ºæ²¡æœ‰æ‰¾åˆ°ä¿¡æ¯
                        const noInfoFound = content.includes('æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ä¿¡æ¯') || 
                                          content.includes('æ²¡æœ‰æ‰¾åˆ°') || 
                                          content.includes('æœªæ‰¾åˆ°') ||
                                          content.includes('æŠ±æ­‰ï¼Œæ²¡æœ‰æ‰¾åˆ°');
                        
                        if (!noInfoFound) {
                            // æ™ºèƒ½å›¾ç‰‡å»é‡ï¼šåŸºäºå›¾ç‰‡IDçš„å…¨å±€å»é‡
                            const processedImageIds = new Set();
                            const existingImageIds = new Set();
                            
                            // è·å–å½“å‰é¡µé¢å·²æ˜¾ç¤ºçš„å›¾ç‰‡ID
                            document.querySelectorAll('.message-content img').forEach(img => {
                                const src = img.src;
                                const imageId = src.split('/').pop().split('.')[0];
                                existingImageIds.add(imageId);
                            });
                            
                            // å¤„ç†å›¾ç‰‡å¹¶æ·»åŠ åˆ°å†…å®¹ä¸­
                            const imageComponents = [];
                            
                            imageSources.forEach((source, index) => {
                                const metadata = source.metadata;
                                const imageId = metadata.image_id || metadata.image_path.split('/').pop().split('.')[0];
                                
                                // å»é‡æ£€æŸ¥ï¼šæ—¢æ²¡æœ‰åœ¨å½“å‰å›ç­”ä¸­é‡å¤ï¼Œä¹Ÿæ²¡æœ‰åœ¨é¡µé¢ä¸­æ˜¾ç¤ºè¿‡
                                if (!processedImageIds.has(imageId) && !existingImageIds.has(imageId)) {
                                    processedImageIds.add(imageId);
                                    
                                    // æ„å»ºå›¾ç‰‡URL
                                    const imageUrl = buildImageUrl(metadata.image_path);
                                    
                                    // æå–å›¾ç‰‡ä¿¡æ¯
                                    const captionText = (metadata.img_caption || []).join(' ');
                                    const footnoteText = (metadata.img_footnote || []).join(' ');
                                    const chartType = metadata.chart_type || 'ä¿¡æ¯å›¾è¡¨';
                                    const documentName = metadata.document_name || 'æœªçŸ¥æ–‡æ¡£';
                                    const pageNumber = metadata.page_number || 1;
                                    
                                    // åˆ›å»ºå›¾ç‰‡ç»„ä»¶
                                    const imageComponent = createImageComponent({
                                        url: imageUrl,
                                        caption: captionText,
                                        footnote: footnoteText,
                                        type: chartType,
                                        document: documentName,
                                        page: pageNumber,
                                        index: index + 1
                                    });
                                    
                                    imageComponents.push(imageComponent);
                                    
                                    // æ¸…ç†AIå›ç­”ä¸­çš„å›¾ç‰‡IDæ ‡è®°
                                    const imageIdPattern = new RegExp(`\\[IMAGE_ID:${imageId.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\]`, 'g');
                                    processedContent = processedContent.replace(imageIdPattern, '');
                                }
                            });
                            
                            // å°†å›¾ç‰‡ç»„ä»¶æ·»åŠ åˆ°å†…å®¹æœ«å°¾
                            if (imageComponents.length > 0) {
                                processedContent += '\n\n' + imageComponents.join('\n\n');
                            }
                        }
                    }
                }
                
                // console.log(`æœ€ç»ˆprocessedContent:`, processedContent);
                
                // ä½¿ç”¨Marked.jsæ¸²æŸ“Markdown
                contentDiv.innerHTML = marked.parse(processedContent);
            }
            
            messageDiv.appendChild(header);
            messageDiv.appendChild(contentDiv);
            
            // å¦‚æœæœ‰å…ƒæ•°æ®ï¼Œæ·»åŠ æˆæœ¬ä¿¡æ¯å’Œæ¥æºè¯¦æƒ…
            if (metadata && !isError) {
                const costInfo = document.createElement('div');
                costInfo.className = 'cost-info';
                
                // æ„å»ºæ¥æºè¯¦æƒ…
                let sourcesDetail = '';
                if (metadata.sources && metadata.sources.length > 0) {
                    sourcesDetail = '<div class="sources-detail">';
                    sourcesDetail += '<strong>æ¥æºè¯¦æƒ…:</strong><br>';
                    metadata.sources.forEach((source, index) => {
                        const sourceMetadata = source.metadata || {};
                        let docName = sourceMetadata.document_name || 'æœªçŸ¥æ–‡æ¡£';
                        let pageNumber = sourceMetadata.page_number || 'æœªçŸ¥é¡µç ';
                        const chunkType = sourceMetadata.chunk_type || 'text';
                        
                        // å¯¹äºå›¾ç‰‡ç±»å‹ï¼Œæ˜¾ç¤ºå›¾ç‰‡æ ‡é¢˜å’Œè„šæ³¨ä¿¡æ¯
                        if (chunkType === 'image') {
                            const imgCaption = sourceMetadata.img_caption || [];
                            const imgFootnote = sourceMetadata.img_footnote || [];
                            
                            // æ„å»ºå›¾ç‰‡æè¿°
                            let imageDescription = '';
                            if (imgCaption.length > 0) {
                                imageDescription = imgCaption.join(' ');
                            } else if (imgFootnote.length > 0) {
                                imageDescription = imgFootnote.join(' ');
                            } else {
                                imageDescription = 'å›¾ç‰‡';
                            }
                            
                            // å¦‚æœmetadataä¸­æ²¡æœ‰æ–‡æ¡£åç§°ï¼Œå°è¯•ä»å›¾ç‰‡è·¯å¾„æ¨æ–­
                            if (!sourceMetadata.document_name && sourceMetadata.image_path) {
                                const imagePath = sourceMetadata.image_path;
                                // å°è¯•ä»å›¾ç‰‡è·¯å¾„ä¸­æå–æ–‡æ¡£ä¿¡æ¯
                                if (imagePath.includes('md_test\\images\\')) {
                                    // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´æ™ºèƒ½çš„æ–‡æ¡£åç§°æå–é€»è¾‘
                                    // æš‚æ—¶ä½¿ç”¨é»˜è®¤å€¼
                                    if (!docName || docName === 'æœªçŸ¥æ–‡æ¡£') {
                                        docName = 'æ–‡æ¡£å›¾ç‰‡';
                                    }
                                }
                            }
                            
                            // å¦‚æœmetadataä¸­æ²¡æœ‰é¡µç ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å€¼
                            if (!sourceMetadata.page_number) {
                                pageNumber = 'å›¾ç‰‡';
                            }
                            
                            // æ›´æ–°æè¿°ä¸ºå›¾ç‰‡æ ‡é¢˜
                            docName = `${docName} - ${imageDescription}`;
                        }
                        
                        sourcesDetail += `${index + 1}. ${docName} (ç¬¬${pageNumber}é¡µ, ${chunkType})<br>`;
                    });
                    sourcesDetail += '</div>';
                }
                
                costInfo.innerHTML = `
                    <div class="cost-info-row">
                        <div class="cost-info-item">
                            <strong>æˆæœ¬:</strong> 
                            <span>${metadata.cost ? metadata.cost.toFixed(6) + ' å…ƒ' : 'N/A'}</span>
                        </div>
                        <div class="cost-info-item">
                            <strong>æ¥æºæ•°é‡:</strong> 
                            <span>${metadata.sources ? metadata.sources.length : 0}</span>
                        </div>
                        <div class="cost-info-item">
                            <strong>æ—¶é—´:</strong> 
                            <span>${metadata.timestamp ? new Date(metadata.timestamp).toLocaleTimeString() : 'N/A'}</span>
                        </div>
                        <div class="cost-info-item">
                            <strong>ç”¨æˆ·ID:</strong> 
                            <span>${currentUserId}</span>
                        </div>
                    </div>
                    ${sourcesDetail}
                `;
                messageDiv.appendChild(costInfo);
            }
            
            chatMessages.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æ¸…é™¤ä¼šè¯è®°å¿†
        async function clearSessionMemory() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤å½“å‰ä¼šè¯çš„è®°å¿†å—ï¼Ÿ')) {
                try {
                    const response = await fetch(`${API_BASE}/memory/clear`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: currentUserId,
                            memory_type: 'session'
                        })
                    });
                    
                    if (response.ok) {
                        alert('ä¼šè¯è®°å¿†å·²æ¸…é™¤');
                        await loadMemoryStats();
                    } else {
                        throw new Error('æ¸…é™¤å¤±è´¥');
                    }
                } catch (error) {
                    console.error('æ¸…é™¤ä¼šè¯è®°å¿†å¤±è´¥:', error);
                    alert('æ¸…é™¤ä¼šè¯è®°å¿†å¤±è´¥');
                }
            }
        }

        // æ¸…é™¤æ‰€æœ‰è®°å¿†
        async function clearAllMemory() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è®°å¿†å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰ç”¨æˆ·çš„ä¼šè¯è®°å¿†å’Œå†å²è®°å¿†ï¼')) {
                try {
                    const response = await fetch(`${API_BASE}/memory/clear`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: null,  // ä¼ å…¥nullæ¸…é™¤æ‰€æœ‰ç”¨æˆ·çš„è®°å¿†
                            memory_type: 'all'
                        })
                    });
                    
                    if (response.ok) {
                        alert('æ‰€æœ‰è®°å¿†å·²æ¸…é™¤');
                        await loadMemoryStats();
                    } else {
                        throw new Error('æ¸…é™¤å¤±è´¥');
                    }
                } catch (error) {
                    console.error('æ¸…é™¤æ‰€æœ‰è®°å¿†å¤±è´¥:', error);
                    alert('æ¸…é™¤æ‰€æœ‰è®°å¿†å¤±è´¥');
                }
            }
        }

        // æ„å»ºå›¾ç‰‡URLçš„è¾…åŠ©å‡½æ•°
        function buildImageUrl(imagePath) {
            if (!imagePath) return '';
            
            let imageUrl = imagePath;
            
            // å¤„ç†ç›¸å¯¹è·¯å¾„
            if (imagePath.startsWith('./') || imagePath.startsWith('md_test/')) {
                imageUrl = imagePath.replace('./', '/').replace('md_test/', '/md_test/');
                if (!imageUrl.startsWith('/')) {
                    imageUrl = '/' + imageUrl;
                }
            } 
            // å¤„ç†åŒ…å«images/çš„è·¯å¾„
            else if (imagePath.includes('images/')) {
                imageUrl = '/md_test/images/' + imagePath.split('/').pop();
            } 
            // å¤„ç†Windowsè·¯å¾„åˆ†éš”ç¬¦
            else if (imagePath.includes('\\')) {
                const pathParts = imagePath.split('\\');
                const imageFileName = pathParts[pathParts.length - 1];
                imageUrl = '/md_test/images/' + imageFileName;
            }
            
            return imageUrl;
        }

        // åˆ›å»ºå›¾ç‰‡ç»„ä»¶çš„è¾…åŠ©å‡½æ•°
        function createImageComponent(imageData) {
            const { url, caption, footnote, type, document, page, index } = imageData;
            
            // æ„å»ºå›¾ç‰‡ä¿¡æ¯
            let imageInfo = '';
            
            // æ·»åŠ å›¾è¡¨ç±»å‹ï¼ˆå¦‚æœæœ‰ï¼‰
            if (type && type !== 'ä¿¡æ¯å›¾è¡¨') {
                imageInfo += `**å›¾è¡¨ç±»å‹**: ${type}\n\n`;
            }
            
            // æ·»åŠ å›¾ç‰‡æ ‡é¢˜
            if (caption) {
                imageInfo += `**å›¾ç‰‡æ ‡é¢˜**: ${caption}\n\n`;
            }
            
            // æ·»åŠ å›¾ç‰‡
            imageInfo += `![å›¾ç‰‡${index}](${url})\n\n`;
            
            // æ·»åŠ æ¥æºä¿¡æ¯
            if (document && page) {
                imageInfo += `**æ¥æº**: ${document} (ç¬¬${page}é¡µ)\n\n`;
            }
            
            // æ·»åŠ å›¾ç‰‡è„šæ³¨ï¼ˆå¦‚æœæœ‰ï¼‰
            if (footnote) {
                imageInfo += `**å›¾ç‰‡è„šæ³¨**: ${footnote}\n\n`;
            }
            
            return imageInfo;
        }
    </script>
</body>
</html> 