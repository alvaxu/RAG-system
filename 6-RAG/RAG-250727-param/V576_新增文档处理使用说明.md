# 新增文档处理使用说明

## 概述

新增文档处理器（AddDocumentProcessor）是一个专门用于处理新增PDF文档的模块，它能够：

1. **保持原有目录结构**：不改变现有的 `pdf_dir`、`md_dir`、`output_dir`、`images_dir` 等目录
2. **临时处理**：在临时目录中进行PDF转换和图片提取
3. **文件迁移**：处理完成后将所有文件迁移到原有目录结构
4. **配置管理**：使用配置文件管理所有路径，避免硬编码
5. **保持兼容性**：确保metadata记录正确的值，与现有系统完全兼容

## 目录结构

### 新增目录
```
RAG-250727-param/
├── add_pdf/                      # 新增PDF存放目录
│   └── 待处理的PDF文件...
├── temp_processing/              # 临时处理目录
│   ├── temp_markdown/           # 临时Markdown文件
│   ├── temp_json/               # 临时JSON文件
│   ├── temp_zip/                # 临时ZIP文件
│   └── temp_images/             # 临时图片文件
├── pdf/                          # 原有PDF目录（处理后移入）
├── md_test/                      # 原有Markdown目录（处理后移入）
│   ├── 现有MD文件...
│   ├── 新增MD文件...             # 处理后移入
│   ├── 现有JSON文件...
│   ├── 新增JSON文件...           # 处理后移入
│   ├── 现有ZIP文件...
│   ├── 新增ZIP文件...            # 处理后移入
│   └── images/                   # 原有图片目录
│       ├── 现有图片...
│       └── 新增图片...           # 处理后移入
└── vector_db_test/               # 向量数据库（保持不变）
```

## 配置管理

### 新增配置项
在 `config.json` 中添加了以下新的路径配置：

```json
{
  "paths": {
    "add_pdf_dir": "./add_pdf",
    "temp_processing_dir": "./temp_processing",
    "temp_markdown_dir": "./temp_processing/temp_markdown",
    "temp_json_dir": "./temp_processing/temp_json",
    "temp_zip_dir": "./temp_processing/temp_zip",
    "temp_images_dir": "./temp_processing/temp_images"
  }
}
```

### 配置加载
系统会自动从配置文件加载这些路径，并转换为绝对路径。

## 处理流程

### 步骤1：准备PDF文件
将新的PDF文件放入 `add_pdf/` 目录：
```
add_pdf/
├── 中芯国际_季报点评_2024Q3.pdf
├── 华为_年报_2023.pdf
└── 其他PDF文件...
```

### 步骤2：临时处理
在临时目录中进行PDF转换：
```
temp_processing/
├── temp_markdown/
│   ├── 中芯国际_季报点评_2024Q3.md
│   └── 华为_年报_2023.md
├── temp_json/
│   ├── 中芯国际_季报点评_2024Q3_1.json
│   └── 华为_年报_2023_1.json
├── temp_zip/
│   ├── 中芯国际_季报点评_2024Q3.zip
│   └── 华为_年报_2023.zip
└── temp_images/
    ├── 60a552470e2a2e10a7f98a88d9bd8472e62f9e198adab413b9f98bc37931aef7.jpg
    └── 其他图片...
```

### 步骤3：文件迁移
处理完成后，文件迁移到原有目录：
- **PDF文件**：`add_pdf/` → `pdf/`
- **Markdown文件**：`temp_markdown/` → `md_test/`
- **JSON文件**：`temp_json/` → `md_test/`
- **ZIP文件**：`temp_zip/` → `md_test/`
- **图片文件**：`temp_images/` → `md_test/images/`

### 步骤4：向量数据库更新
- 使用标准化的图片路径：`images/图片名`
- 确保metadata记录正确的值
- 保持与现有系统的兼容性

## 使用方法

### 1. 基本使用

```python
from config.settings import Settings
from document_processing.add_document_processor import AddDocumentProcessor

# 加载配置
config = Settings.load_from_file('config.json')

# 创建处理器
processor = AddDocumentProcessor(config)

# 执行完整处理流程
result = processor.process_add_documents()

# 检查结果
if result['success']:
    print("处理成功")
    print(f"处理文件数: {result['statistics']['successful_files']}")
else:
    print("处理失败")
    for error in result['errors']:
        print(f"错误: {error}")
```

### 2. 分步处理

```python
# 步骤1: 处理新增PDF文件
pdf_result = processor.process_new_pdfs()

# 步骤2: 更新向量数据库
if pdf_result['success']:
    processor.update_vector_database(pdf_result['processed_files'])

# 步骤3: 清理临时文件
processor.cleanup_temp_directories()
```

### 3. 测试功能

```python
# 运行测试脚本
python V575_test_add_document_processor.py
```

## 关键特性

### 1. 路径标准化
- 所有图片路径统一为 `images/图片名` 格式
- 确保metadata记录正确的相对路径
- 前端显示逻辑无需修改

### 2. 错误处理
- 处理失败时自动清理临时文件
- 详细的错误日志和状态反馈
- 支持部分成功的情况

### 3. 配置管理
- 所有路径通过配置文件管理
- 支持环境变量和配置文件优先级
- 自动路径标准化

### 4. 向后兼容
- 完全保持现有的业务逻辑
- 不改变现有的目录结构
- 保持现有的图片处理逻辑

## 注意事项

### 1. 文件命名
- PDF文件名应避免特殊字符
- 建议使用有意义的文件名
- 确保文件名不重复

### 2. 存储空间
- 临时目录会占用额外空间
- 处理完成后会自动清理
- 建议定期检查存储空间

### 3. 权限要求
- 确保对临时目录有读写权限
- 确保对原有目录有写入权限
- 确保对向量数据库有读写权限

### 4. 错误处理
- 处理过程中如果出错，会保留临时文件用于调试
- 可以手动清理临时文件
- 建议在处理前备份重要数据

## 故障排除

### 1. 配置问题
```bash
# 检查配置文件
python V575_test_add_document_processor.py
```

### 2. 权限问题
```bash
# 检查目录权限
ls -la add_pdf/
ls -la temp_processing/
```

### 3. 路径问题
```bash
# 检查路径配置
python -c "from config.settings import Settings; config = Settings.load_from_file('config.json'); print(config.add_pdf_dir)"
```

### 4. 清理临时文件
```python
# 手动清理临时文件
processor = AddDocumentProcessor(config)
processor.cleanup_temp_directories()
```

## 更新日志

### V576_新增文档处理使用说明.md
- 创建了完整的使用说明文档
- 详细说明了处理流程和配置管理
- 提供了故障排除指南

### 相关文件
- `config/settings.py` - 配置管理更新
- `document_processing/add_document_processor.py` - 新增文档处理器
- `document_processing/image_extractor.py` - 图片提取器更新
- `document_processing/vector_generator.py` - 向量生成器更新
- `V575_test_add_document_processor.py` - 测试脚本 