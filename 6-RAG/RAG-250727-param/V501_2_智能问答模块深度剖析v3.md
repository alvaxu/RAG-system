# V501_2_æ™ºèƒ½é—®ç­”æ¨¡å—æ·±åº¦å‰–æ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£åŸºäº`enhanced_qa_system.py`åŠå…¶ç›¸å…³å¼•æ“ï¼ˆæºè¿‡æ»¤ã€æ™ºèƒ½è¿‡æ»¤ã€é‡æ’åºï¼‰ï¼Œæ·±å…¥åˆ†æRAGç³»ç»Ÿä¸­æ™ºèƒ½é—®ç­”æ¨¡å—çš„æŠ€æœ¯æ¶æ„ã€å®ç°åŸç†å’Œè°ƒç”¨å…³ç³»ã€‚

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. åˆ†å±‚æ¶æ„

```
UnifiedRAGSystem (V501_unified_main.py)
    â†“ è°ƒç”¨
EnhancedQASystem (enhanced_qa_system.py)
    â†“ è°ƒç”¨
RerankingEngine (reranking_engine.py)
SourceFilterEngine (source_filter_engine.py)
SmartFilterEngine (smart_filter_engine.py)
MemoryManager (memory_manager.py)
    â†“ è°ƒç”¨
LLM (Tongyi, DashScope API)
    â†“
å‘é‡æ•°æ®åº“ (FAISS)
```

### 2. æ ¸å¿ƒç»„ä»¶å…³ç³»å›¾

```mermaid
graph TD
    A[UnifiedRAGSystem] --> B[EnhancedQASystem]
    B --> C1[RerankingEngine]
    B --> C2[SourceFilterEngine]
    B --> C3[SmartFilterEngine]
    B --> C4[MemoryManager]
    B --> D[LLM]
    B --> E[FAISSå‘é‡æ•°æ®åº“]
```

---

## ğŸ“ æ–‡ä»¶åŠŸèƒ½åˆ†æ

### 1. enhanced_qa_system.py - æ™ºèƒ½é—®ç­”ä¸»å¼•æ“

**åŠŸèƒ½æè¿°ï¼š**

- è´Ÿè´£æ•´ä¸ªé—®ç­”æµç¨‹çš„è°ƒåº¦ä¸é›†æˆ
- ç®¡ç†å‘é‡æ£€ç´¢ã€è¿‡æ»¤ã€é‡æ’åºã€LLMè°ƒç”¨ã€è®°å¿†ç­‰
- ç»Ÿä¸€å¯¹å¤–æš´éœ²`answer_question`ã€`answer_with_memory`ç­‰æ¥å£

**å…³é”®æ–¹æ³•ï¼š**

```python
def answer_question(self, question, k=None)
def answer_with_memory(self, user_id, question, k=None)
```

**æŠ€æœ¯å®ç°ï¼š**

- åˆå§‹åŒ–æ—¶åŠ è½½å‘é‡æ•°æ®åº“ã€LLMã€å„ç±»å¼•æ“
- æ”¯æŒå¤šæ¨¡æ€æ£€ç´¢ï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ï¼‰
- å¤šå±‚è¿‡æ»¤ä¸é‡æ’åºï¼Œæå‡ç­”æ¡ˆç›¸å…³æ€§å’Œè´¨é‡
- å¯é€‰è®°å¿†ç®¡ç†ï¼Œæ”¯æŒå¤šè½®å¯¹è¯

---

### 2. reranking_engine.py - é‡æ’åºå¼•æ“

**åŠŸèƒ½æè¿°ï¼š**

- å¯¹å€™é€‰å†…å®¹è¿›è¡Œå¤šç»´åº¦é‡æ’åºï¼ˆå¦‚è¯­ä¹‰åˆ†æ•°ã€å…³é”®è¯åˆ†æ•°ã€æ··åˆç­–ç•¥ç­‰ï¼‰
- ä½¿æœ€ç›¸å…³ã€æœ€ä¼˜è´¨çš„å†…å®¹æ’åœ¨å‰é¢

**å…³é”®æ–¹æ³•ï¼š**

```python
def rerank_results(self, results: List[Dict[str, Any]], question: str) -> List[Dict[str, Any]]
```

**æŠ€æœ¯å®ç°ï¼š**

- æ”¯æŒå¤šç§é‡æ’åºç­–ç•¥ï¼ˆhybrid/semantic/keywordï¼‰
- ç»¼åˆè¯­ä¹‰ã€å…³é”®è¯ã€å†…å®¹è´¨é‡ç­‰å¤šç»´è¯„åˆ†
- åŠ¨æ€è°ƒæ•´æ’åºæƒé‡

---

### 3. source_filter_engine.py - æºè¿‡æ»¤å¼•æ“

**åŠŸèƒ½æè¿°ï¼š**

- å¯¹æ£€ç´¢åˆ°çš„å†…å®¹è¿›è¡Œâ€œæºå¤´â€çº§åˆ«çš„è¿‡æ»¤
- è¿‡æ»¤æ‰ä¸å¯ä¿¡ã€æ— å…³ã€é‡å¤ã€ä½è´¨é‡çš„å†…å®¹

**å…³é”®æ–¹æ³•ï¼š**

```python
def filter_sources(self, results: List[Dict[str, Any]], question: str) -> List[Dict[str, Any]]
```

**æŠ€æœ¯å®ç°ï¼š**

- ç›¸å…³æ€§åˆ†æ•°è®¡ç®—ï¼ˆè¯­ä¹‰ã€å…³é”®è¯ã€è´¨é‡ï¼‰
- æ”¯æŒå¤šæ ·æ€§æ§åˆ¶å’Œé˜ˆå€¼åŠ¨æ€è°ƒæ•´
- ç»“æœæ•°é‡é™åˆ¶

---

### 4. smart_filter_engine.py - æ™ºèƒ½è¿‡æ»¤å¼•æ“

**åŠŸèƒ½æè¿°ï¼š**

- ç”¨æ›´æ™ºèƒ½çš„æ–¹å¼ï¼ˆå¦‚è¯­ä¹‰ç›¸ä¼¼åº¦ã€å…³é”®è¯ã€å†…å®¹ç‰¹å¾ç­‰ï¼‰è¿‡æ»¤å€™é€‰å†…å®¹
- è¿›ä¸€æ­¥æå‡æ£€ç´¢å†…å®¹çš„ç›¸å…³æ€§å’Œè´¨é‡

**å…³é”®æ–¹æ³•ï¼š**

```python
def filter_results(self, results: List[Dict[str, Any]], question: str) -> List[Dict[str, Any]]
```

**æŠ€æœ¯å®ç°ï¼š**

- è¯­ä¹‰ç›¸ä¼¼åº¦è¿‡æ»¤
- å…³é”®è¯åŒ¹é…è¿‡æ»¤
- å†…å®¹ç›¸å…³æ€§è¿‡æ»¤
- å¤šæ ·æ€§æ§åˆ¶

---

### 5. memory_manager.py - è®°å¿†ç®¡ç†å™¨

**åŠŸèƒ½æè¿°ï¼š**

- ä¿å­˜ç”¨æˆ·å¯¹è¯å†å²
- åŸºäºè¯­ä¹‰çš„ç›¸å…³æ€§è®¡ç®—
- æ™ºèƒ½çš„è®°å¿†æ£€ç´¢æœºåˆ¶

**å…³é”®æ–¹æ³•ï¼š**

```python
def get_relevant_memory(self, question: str, user_id: str = "default_user") -> List[Dict[str, Any]]
def add_memory(self, question, answer, user_id)
```

---

## ğŸ”„ è°ƒç”¨æµç¨‹åˆ†æ

### 1. ä¸»è°ƒç”¨é“¾

```python
# UnifiedRAGSystem.ask_question
if use_memory:
    result = self.qa_system.answer_with_memory(user_id, question)
else:
    result = self.qa_system.answer_question(question)
```

### 2. EnhancedQASystemå†…éƒ¨å¤„ç†æµç¨‹

```python
def answer_question(self, question, k=None):
    docs = self._initial_retrieval(question, k)
    docs = self._apply_smart_filtering(question, docs)
    docs = self._apply_reranking(question, docs)
    answer_dict = self._generate_answer(question, docs)
    sources = self._apply_source_filtering(answer_dict['answer'], docs)
    final_answer = self.append_sources_to_answer(answer_dict['answer'], sources)
    return {'answer': final_answer, 'sources': sources, ...}
```

### 3. å¤šæ¨¡æ€æ£€ç´¢ä¸èåˆ

- æ–‡æœ¬ä¸å›¾ç‰‡åˆ†åˆ«æ£€ç´¢ï¼Œç»“æœèåˆä¸å¹³è¡¡
- åŠ¨æ€è¡¥å……ä¸è¶³çš„å†…å®¹ç±»å‹ï¼Œä¿è¯å¤šæ¨¡æ€è¦†ç›–

---

## ğŸ› ï¸ æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. å¤šå±‚è¿‡æ»¤ä¸é‡æ’åº

- **æ™ºèƒ½è¿‡æ»¤**ï¼šè¯­ä¹‰ç›¸ä¼¼åº¦ã€å…³é”®è¯ã€å†…å®¹ç›¸å…³æ€§
- **é‡æ’åº**ï¼šæ··åˆè¯„åˆ†ç®—æ³•ï¼ŒåŠ¨æ€æƒé‡
- **æºè¿‡æ»¤**ï¼šç›¸å…³æ€§é˜ˆå€¼ã€è´¨é‡è¯„ä¼°ã€å¤šæ ·æ€§æ§åˆ¶

### 2. LLMè°ƒç”¨ä¸ç­”æ¡ˆç”Ÿæˆ

- ä¸Šä¸‹æ–‡æ„å»ºä¸promptè®¾è®¡
- LLMç”Ÿæˆç­”æ¡ˆ
- ç­”æ¡ˆåå¤„ç†ä¸å¼•ç”¨æ‹¼æ¥

### 3. è®°å¿†ç®¡ç†ä¸å¤šè½®å¯¹è¯

- ç›¸å…³è®°å¿†æ£€ç´¢ä¸å¢å¼º
- æ–°å¯¹è¯è‡ªåŠ¨å­˜å‚¨
- ç›¸å…³æ€§é˜ˆå€¼ä¼˜åŒ–

---

## âš™ï¸ é…ç½®å‚æ•°è¯¦è§£

### 1. é—®ç­”ç³»ç»Ÿå‚æ•°

```json
{
  "qa_system": {
    "model_name": "qwen-plus-latest",
    "temperature": 0.5,
    "max_tokens": 1500,
    "enable_sources_filtering": true,
    "min_relevance_score": 0.001,
    "enable_keyword_matching": true,
    "enable_image_id_matching": true,
    "enable_similarity_filtering": true
  }
}
```

### 2. è¿‡æ»¤ä¸é‡æ’åºå‚æ•°

```json
{
  "processing": {
    "enable_smart_filtering": true,
    "semantic_similarity_threshold": 0.1,
    "content_relevance_threshold": 0.01,
    "max_filtered_results": 5
  },
  "vector_store": {
    "enable_reranking": true,
    "reranking_method": "hybrid",
    "semantic_weight": 0.7,
    "keyword_weight": 0.3,
    "min_similarity_threshold": 0.001
  }
}
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. æ£€ç´¢ä¸è¿‡æ»¤ä¼˜åŒ–

- å‘é‡æ£€ç´¢é‡‡ç”¨FAISSé«˜æ•ˆç´¢å¼•
- å¤šå±‚è¿‡æ»¤å‡å°‘æ— å…³å†…å®¹
- é˜ˆå€¼ä¸æƒé‡å¯è°ƒï¼Œæ”¯æŒåŠ¨æ€è°ƒä¼˜

### 2. LLMç”Ÿæˆä¼˜åŒ–

- Promptä¼˜åŒ–ä¸ä¸Šä¸‹æ–‡å‹ç¼©
- æ”¯æŒå¼‚æ­¥å¤„ç†ä¸æ¨¡å‹ç¼“å­˜

### 3. è®°å¿†ä¸å¤šè½®å¯¹è¯ä¼˜åŒ–

- ç›¸å…³æ€§é˜ˆå€¼è°ƒä¼˜
- è®°å¿†æ¡æ•°é™åˆ¶ä¸æ’åº

---

## ğŸ” å…³é”®ç‰¹æ€§

1. **å¤šå¼•æ“åä½œ**ï¼šè¿‡æ»¤ã€é‡æ’åºã€è®°å¿†ç­‰å¤šå¼•æ“åä½œ
2. **å¤šæ¨¡æ€æ”¯æŒ**ï¼šæ–‡æœ¬ã€å›¾ç‰‡å†…å®¹çš„æ™ºèƒ½å¤„ç†ä¸èåˆ
3. **é«˜åº¦å¯é…ç½®**ï¼šå‚æ•°åŒ–é…ç½®ï¼Œä¾¿äºè°ƒä¼˜
4. **é”™è¯¯æ¢å¤**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œé™çº§æœºåˆ¶
5. **æ‰©å±•æ€§å¼º**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œä¾¿äºæ‰©å±•å’Œç»´æŠ¤

---

## ğŸ¯ æ€»ç»“

æ™ºèƒ½é—®ç­”æ¨¡å—æ˜¯RAGç³»ç»Ÿçš„æ ¸å¿ƒä¸šåŠ¡å±‚ï¼Œé‡‡ç”¨åˆ†å±‚æ¶æ„å’Œå¤šå¼•æ“åä½œæœºåˆ¶ï¼Œå®ç°äº†ä»ç”¨æˆ·æŸ¥è¯¢åˆ°ç­”æ¡ˆç”Ÿæˆçš„å®Œæ•´æ™ºèƒ½é“¾è·¯ã€‚å…¶å¤šæ¨¡æ€æ£€ç´¢ã€æ™ºèƒ½è¿‡æ»¤ã€é‡æ’åºã€è®°å¿†ç®¡ç†ç­‰æœºåˆ¶ï¼Œæå¤§æå‡äº†é—®ç­”çš„ç›¸å…³æ€§ã€å‡†ç¡®æ€§å’Œç”¨æˆ·ä½“éªŒã€‚æ¨¡å—åŒ–è®¾è®¡å’Œå‚æ•°åŒ–é…ç½®ä¸ºç³»ç»Ÿçš„æ‰©å±•å’Œä¼˜åŒ–æä¾›äº†åšå®åŸºç¡€ã€‚




# äº”ä¸ªæ­¥éª¤å®ç°ç²¾å‡†æ£€ç´¢çš„åŸç†ä¸å®ç°æ–¹æ³•

## æ€»ä½“æµç¨‹

åœ¨å¢å¼ºç‰ˆRAGé—®ç­”ç³»ç»Ÿä¸­ï¼Œ`answer_question` æ–¹æ³•é€šè¿‡äº”ä¸ªå…³é”®æ­¥éª¤ï¼Œé€æ­¥ä¼˜åŒ–æ£€ç´¢ç»“æœï¼Œæå‡é—®ç­”çš„ç›¸å…³æ€§å’Œå‡†ç¡®æ€§ã€‚è¿™äº”æ­¥åˆ†åˆ«æ˜¯ï¼š

1. **åˆå§‹æ£€ç´¢**
2. **é‡æ’åºä¼˜åŒ–**
3. **æ™ºèƒ½è¿‡æ»¤**
4. **ç”Ÿæˆå›ç­”**
5. **æºè¿‡æ»¤ä¼˜åŒ–**

ä¸‹é¢é€æ­¥è¯¦ç»†è¯´æ˜æ¯ä¸€æ­¥çš„åŸç†å’Œå®ç°ã€‚

---

## 1. åˆå§‹æ£€ç´¢

### åŸç†

- é¦–å…ˆæ ¹æ®ç”¨æˆ·é—®é¢˜ï¼ˆquestionï¼‰ï¼Œåœ¨å‘é‡æ•°æ®åº“ä¸­æ£€ç´¢ä¸é—®é¢˜æœ€ç›¸å…³çš„æ–‡æ¡£ç‰‡æ®µã€‚
- é‡‡ç”¨**è¯­ä¹‰ç›¸ä¼¼åº¦æ£€ç´¢**ï¼Œå³å°†é—®é¢˜å‘é‡åŒ–ï¼Œä¸æ‰€æœ‰æ–‡æ¡£ç‰‡æ®µçš„å‘é‡åšç›¸ä¼¼åº¦è®¡ç®—ï¼Œé€‰å‡ºæœ€ç›¸å…³çš„è‹¥å¹²ä¸ªæ–‡æ¡£ã€‚

### å®ç°æ–¹æ³•

- è°ƒç”¨ `self._initial_retrieval(question, k)`ï¼Œå…¶ä¸­ `k` æ˜¯æ£€ç´¢çš„æ–‡æ¡£æ•°é‡ã€‚
- è¯¥æ–¹æ³•ä¼šéå†æ‰€æœ‰æ–‡æ¡£æ¥æºï¼Œç¡®ä¿æ¯ä¸ªæ–‡æ¡£éƒ½èƒ½è¢«å…¬å¹³æ£€ç´¢ï¼ˆé˜²æ­¢åªä»æŸä¸€ä¸ªæ–‡æ¡£ä¸­æ£€ç´¢ï¼‰ã€‚
- å¦‚æœæœ‰å‰©ä½™é…é¢ï¼Œå†å…¨å±€è¡¥å……ç›¸ä¼¼åº¦æœ€é«˜çš„æ–‡æ¡£ï¼Œä¿è¯æ£€ç´¢ç»“æœçš„å¤šæ ·æ€§å’Œè¦†ç›–é¢ã€‚
- ä»£ç ç‰‡æ®µï¼š
  ```python
  initial_docs = self._initial_retrieval(question, k)
  ```

---

## 2. é‡æ’åºä¼˜åŒ–

### åŸç†

- åˆå§‹æ£€ç´¢å¾—åˆ°çš„æ–‡æ¡£è™½ç„¶ç›¸å…³ï¼Œä½†é¡ºåºæœªå¿…æœ€ä¼˜ã€‚
- é€šè¿‡**é‡æ’åºå¼•æ“**ï¼Œå¯¹åˆå§‹æ£€ç´¢ç»“æœå†æ¬¡æ’åºï¼Œä½¿å¾—æœ€ç›¸å…³ã€æœ€æœ‰ç”¨çš„æ–‡æ¡£æ’åœ¨å‰é¢ã€‚

### å®ç°æ–¹æ³•

- è°ƒç”¨ `self._apply_reranking(question, initial_docs)`ã€‚
- è¯¥æ–¹æ³•ä¼šå°†åˆå§‹æ£€ç´¢çš„æ–‡æ¡£ä¼ é€’ç»™é‡æ’åºå¼•æ“ï¼ˆå¦‚åŸºäºè¯­ä¹‰åˆ†æ•°ã€æ··åˆç‰¹å¾ç­‰ï¼‰ï¼Œé‡æ–°è®¡ç®—æ¯ä¸ªæ–‡æ¡£ä¸é—®é¢˜çš„ç›¸å…³æ€§åˆ†æ•°ï¼Œå¹¶æŒ‰åˆ†æ•°æ’åºã€‚
- ä»£ç ç‰‡æ®µï¼š
  ```python
  reranked_docs = self._apply_reranking(question, initial_docs)
  ```

---

## 3. æ™ºèƒ½è¿‡æ»¤

### åŸç†

- æœ‰äº›æ–‡æ¡£è™½ç„¶ç›¸å…³ï¼Œä½†å¯èƒ½æ˜¯å™ªéŸ³æˆ–å†—ä½™ä¿¡æ¯ã€‚
- é€šè¿‡**æ™ºèƒ½è¿‡æ»¤å¼•æ“**ï¼Œè¿›ä¸€æ­¥ç­›é€‰å‡ºæœ€æœ‰ä»·å€¼çš„æ–‡æ¡£ï¼Œå»é™¤æ— å…³æˆ–é‡å¤å†…å®¹ã€‚

### å®ç°æ–¹æ³•

- è°ƒç”¨ `self._apply_smart_filtering(question, reranked_docs)`ã€‚
- æ™ºèƒ½è¿‡æ»¤å¯ä»¥åŸºäºå¤šç§ç‰¹å¾ï¼ˆå¦‚å†…å®¹å»é‡ã€ä¸Šä¸‹æ–‡ç›¸å…³æ€§ã€ç‰¹å®šé¢†åŸŸè§„åˆ™ç­‰ï¼‰è¿›è¡Œç­›é€‰ã€‚
- ä»£ç ç‰‡æ®µï¼š
  ```python
  filtered_docs = self._apply_smart_filtering(question, reranked_docs)
  ```

---

## 4. ç”Ÿæˆå›ç­”

### åŸç†

- åˆ©ç”¨ç»è¿‡å¤šè½®ä¼˜åŒ–åçš„æ–‡æ¡£ç‰‡æ®µï¼Œç»“åˆå¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ï¼Œç”Ÿæˆé’ˆå¯¹ç”¨æˆ·é—®é¢˜çš„ç²¾å‡†å›ç­”ã€‚
- åªç”¨æœ€ç›¸å…³çš„æ–‡æ¡£ä½œä¸ºä¸Šä¸‹æ–‡ï¼Œæå‡å›ç­”çš„é’ˆå¯¹æ€§å’Œå‡†ç¡®æ€§ã€‚

### å®ç°æ–¹æ³•

- è°ƒç”¨ `self._generate_answer(question, filtered_docs)`ã€‚
- è¯¥æ–¹æ³•ä¼šå°†ç­›é€‰åçš„æ–‡æ¡£å’Œé—®é¢˜ä¸€èµ·ä¼ é€’ç»™ LLMï¼Œç”Ÿæˆæœ€ç»ˆçš„è‡ªç„¶è¯­è¨€å›ç­”ã€‚
- ä»£ç ç‰‡æ®µï¼š
  ```python
  answer_result = self._generate_answer(question, filtered_docs)
  ```

---

## 5. æºè¿‡æ»¤ä¼˜åŒ–

### åŸç†

- å›ç­”ç”Ÿæˆåï¼Œè¿›ä¸€æ­¥å¯¹æ–‡æ¡£æºè¿›è¡Œä¼˜åŒ–ï¼Œç¡®ä¿æœ€ç»ˆå¼•ç”¨çš„æ–‡æ¡£æ¥æºæœ€ä¸ºæƒå¨ã€ç›¸å…³ã€‚
- å¯ä»¥å»é™¤ä¸æœ€ç»ˆç­”æ¡ˆæ— å…³çš„æ–‡æ¡£ï¼Œæå‡æº¯æºçš„å‡†ç¡®æ€§ã€‚

### å®ç°æ–¹æ³•

- è°ƒç”¨ `self._apply_source_filtering(answer_result['answer'], filtered_docs)`ã€‚
- è¯¥æ–¹æ³•ä¼šæ ¹æ® LLM ç”Ÿæˆçš„ç­”æ¡ˆå†…å®¹ï¼Œç­›é€‰å‡ºçœŸæ­£ä¸ºç­”æ¡ˆæä¾›æ”¯æ’‘çš„æ–‡æ¡£æºã€‚
- ä»£ç ç‰‡æ®µï¼š
  ```python
  final_sources = self._apply_source_filtering(answer_result['answer'], filtered_docs)
  ```

---

# æ€»ç»“

è¿™äº”æ­¥å±‚å±‚é€’è¿›ï¼Œ**ä»ç²—åˆ°ç²¾**ï¼Œå®ç°äº†é«˜è´¨é‡çš„ç²¾å‡†æ£€ç´¢ï¼š

1. **åˆå§‹æ£€ç´¢**ï¼šä¿è¯å¬å›ç‡å’Œå¤šæ ·æ€§ã€‚
2. **é‡æ’åº**ï¼šæå‡ç›¸å…³æ€§å’Œä¼˜å…ˆçº§ã€‚
3. **æ™ºèƒ½è¿‡æ»¤**ï¼šå»é™¤å†—ä½™å’Œå™ªéŸ³ã€‚
4. **ç”Ÿæˆå›ç­”**ï¼šç”¨æœ€ä¼˜ä¸Šä¸‹æ–‡ç”Ÿæˆé«˜è´¨é‡ç­”æ¡ˆã€‚
5. **æºè¿‡æ»¤**ï¼šç¡®ä¿ç­”æ¡ˆçš„å¯è¿½æº¯æ€§å’Œæƒå¨æ€§ã€‚

æ¯ä¸€æ­¥éƒ½åœ¨ä¸ºæœ€ç»ˆçš„é—®ç­”è´¨é‡æŠŠå…³ï¼Œç¡®ä¿ç”¨æˆ·å¾—åˆ°**å‡†ç¡®ã€æƒå¨ã€å¯è§£é‡Š**çš„ç­”æ¡ˆã€‚

---

# 1. åˆå§‹æ£€ç´¢ï¼š`self._initial_retrieval(question, k)`

### ä½œç”¨
- åœ¨æ‰€æœ‰æ–‡æ¡£ä¸­ï¼Œ**åˆæ­¥å¬å›**ä¸é—®é¢˜æœ€ç›¸å…³çš„æ–‡æ¡£ç‰‡æ®µï¼Œä¸ºåç»­ä¼˜åŒ–æ‰“åŸºç¡€ã€‚

### å…³é”®å‚æ•°
- `question`ï¼šç”¨æˆ·é—®é¢˜ï¼ˆå¯èƒ½åŒ…å«å†å²ä¸Šä¸‹æ–‡ï¼‰ã€‚
- `k`ï¼šéœ€è¦æ£€ç´¢çš„æ–‡æ¡£æ•°é‡ã€‚

### æ ¸å¿ƒé€»è¾‘
- éå†æ‰€æœ‰æ–‡æ¡£æ¥æºï¼ˆå¦‚ä¸åŒæŠ¥å‘Šã€ä¸åŒæ–‡ä»¶ï¼‰ï¼Œä¸ºæ¯ä¸ªæ–‡æ¡£åˆ†é…æ£€ç´¢é…é¢ï¼Œä¿è¯å¬å›çš„å¤šæ ·æ€§ã€‚
- å¯¹æ¯ä¸ªæ–‡æ¡£ï¼Œè°ƒç”¨ `self.vector_store.similarity_search(question, k=base_k_per_doc, filter={"document_name": doc_name})`ï¼Œæ£€ç´¢ä¸é—®é¢˜æœ€ç›¸å…³çš„ç‰‡æ®µã€‚
- å¦‚æœè¿˜æœ‰å‰©ä½™é…é¢ï¼Œå†å…¨å±€æ£€ç´¢è¡¥å……æœ€ç›¸å…³çš„æ–‡æ¡£ï¼Œé¿å…é—æ¼é«˜ç›¸å…³å†…å®¹ã€‚
- æœ€ç»ˆè¿”å›å‰ `k` ä¸ªæœ€ç›¸å…³çš„æ–‡æ¡£ç‰‡æ®µã€‚

### ä»£ç ç‰‡æ®µ
```python
def _initial_retrieval(self, question, k):
    # ...çœç•¥éƒ¨åˆ†...
    for doc_name in doc_names:
        docs = self.vector_store.similarity_search(
            question, 
            k=base_k_per_doc,
            filter={"document_name": doc_name}
        )
        all_docs.extend(docs)
    # è¡¥å……æ£€ç´¢
    if remaining_k > 0:
        all_available_docs = self.vector_store.similarity_search(question, k=k*2)
        # è¿‡æ»¤å»é‡ï¼Œè¡¥è¶³æ•°é‡
    # è¿”å›å‰kä¸ª
    return all_docs[:k]
```

### ä¾èµ–æ–¹æ³•
- `self.vector_store.similarity_search(...)`ï¼šåº•å±‚å‘é‡æ•°æ®åº“çš„ç›¸ä¼¼åº¦æ£€ç´¢æ–¹æ³•ï¼Œè¿”å›ä¸è¾“å…¥é—®é¢˜æœ€ç›¸ä¼¼çš„æ–‡æ¡£ç‰‡æ®µã€‚

---

# 2. é‡æ’åºä¼˜åŒ–ï¼š`self._apply_reranking(question, initial_docs)`

### å¼€å…³

-   "enable_reranking": true,
-  "reranking_method": "semantic"
- reranking å¼€å¯ï¼Œæ–¹æ³•ä¸º semantic,å¯é€‰ä¸‰ç§

### ä½œç”¨

- å¯¹åˆå§‹æ£€ç´¢ç»“æœè¿›è¡Œ**ç›¸å…³æ€§å†æ’åº**ï¼Œæå‡æœ€ä¼˜æ–‡æ¡£çš„ä¼˜å…ˆçº§ã€‚

### å…³é”®å‚æ•°
- `question`ï¼šç”¨æˆ·é—®é¢˜ã€‚
- `initial_docs`ï¼šåˆå§‹æ£€ç´¢å¾—åˆ°çš„æ–‡æ¡£ç‰‡æ®µåˆ—è¡¨ã€‚

### æ ¸å¿ƒé€»è¾‘
- å°†æ¯ä¸ªæ–‡æ¡£ç‰‡æ®µè½¬ä¸ºå­—å…¸æ ¼å¼ï¼ŒåŒ…å«å†…å®¹ã€å…ƒæ•°æ®ã€åˆå§‹åˆ†æ•°ç­‰ã€‚
- è°ƒç”¨ `self.reranking_engine.rerank_results(question, doc_dicts)`ï¼Œå¯¹æ‰€æœ‰æ–‡æ¡£é‡æ–°æ‰“åˆ†æ’åºã€‚
- æŒ‰æ–°åˆ†æ•°æ’åºåï¼Œè½¬å› `Document` å¯¹è±¡åˆ—è¡¨ï¼Œä¾›åç»­å¤„ç†ã€‚



### ä»£ç ç‰‡æ®µ
```python
def _apply_reranking(self, question, documents):
    doc_dicts = [{'content': doc.page_content, 'metadata': doc.metadata, 'score': getattr(doc, 'score', 0.0)} for doc in documents]
    reranked_dicts = self.reranking_engine.rerank_results(question, doc_dicts)
    # è½¬å›Documentå¯¹è±¡
    reranked_docs = [Document(page_content=d['content'], metadata=d['metadata']) for d in reranked_dicts]
    return reranked_docs
```

### ä¾èµ–æ–¹æ³•
- `self.reranking_engine.rerank_results(question, doc_dicts)`ï¼šé‡æ’åºå¼•æ“ï¼Œé€šå¸¸åŸºäºæ›´å¤æ‚çš„è¯­ä¹‰æ¨¡å‹æˆ–æ··åˆç‰¹å¾å¯¹æ–‡æ¡£ç›¸å…³æ€§è¿›è¡Œå†è¯„ä¼°ã€‚

#### 1. æ–¹æ³•å…¥å£

```python
def rerank_results(self, query: str, documents: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    # ...
```

- **query**ï¼šç”¨æˆ·é—®é¢˜
- **documents**ï¼šåˆæ­¥æ£€ç´¢å¾—åˆ°çš„æ–‡æ¡£ç‰‡æ®µï¼ˆæ¯ä¸ªæ˜¯å­—å…¸ï¼Œå«contentã€metadataç­‰ï¼‰

---

#### 2. æ”¯æŒä¸‰ç§é‡æ’åºæ–¹å¼

##### 1ï¼‰è¯­ä¹‰é‡æ’åºï¼ˆsemanticï¼‰

- æ–¹æ³•ï¼š`self._semantic_rerank(query, documents)`

- **åŸç†**ï¼šç”¨ TF-IDF å‘é‡åŒ– query å’Œæ‰€æœ‰æ–‡æ¡£å†…å®¹ï¼Œè®¡ç®— query ä¸æ¯ä¸ªæ–‡æ¡£çš„**ä½™å¼¦ç›¸ä¼¼åº¦**ï¼Œåˆ†æ•°è¶Šé«˜è¶Šç›¸å…³ã€‚

- **æµç¨‹**ï¼š

  1. ç”¨ TF-IDF å‘é‡å™¨å°† query å’Œæ‰€æœ‰æ–‡æ¡£å†…å®¹è½¬ä¸ºå‘é‡ã€‚
  2. è®¡ç®— query å‘é‡ä¸æ¯ä¸ªæ–‡æ¡£å‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦ã€‚
  3. æŠŠç›¸ä¼¼åº¦åˆ†æ•°å†™å…¥æ¯ä¸ªæ–‡æ¡£çš„ `semantic_score` å’Œ `rerank_score` å­—æ®µã€‚
  4. æŒ‰ `rerank_score` é™åºæ’åºï¼Œè¿”å›æ’åºåçš„æ–‡æ¡£åˆ—è¡¨ã€‚

- **æ ¸å¿ƒä»£ç **ï¼š

  ```python
  doc_texts = [doc.get('content', '') for doc in documents]
  all_texts = [query] + doc_texts
  tfidf_matrix = self.tfidf_vectorizer.fit_transform(all_texts)
  similarities = cosine_similarity(query_vector, doc_vectors).flatten()
  for i, doc in enumerate(documents):
      doc['semantic_score'] = float(similarities[i])
      doc['rerank_score'] = doc['semantic_score']
  reranked_docs = sorted(documents, key=lambda x: x['rerank_score'], reverse=True)
  ```

---

##### 2ï¼‰å…³é”®è¯é‡æ’åºï¼ˆkeywordï¼‰

- æ–¹æ³•ï¼š`self._keyword_rerank(query, documents)`

- **åŸç†**ï¼šæå– query çš„å…³é”®è¯ï¼Œç»Ÿè®¡æ¯ä¸ªæ–‡æ¡£å†…å®¹ä¸­å…³é”®è¯çš„å‡ºç°æƒ…å†µï¼Œå‡ºç°è¶Šå¤šåˆ†æ•°è¶Šé«˜ã€‚

- **æµç¨‹**ï¼š

  1. æå– query çš„å…³é”®è¯ï¼ˆå¦‚åˆ†è¯ã€å»åœç”¨è¯ç­‰ï¼‰ã€‚
  2. å¯¹æ¯ä¸ªæ–‡æ¡£ï¼Œè®¡ç®—å…³é”®è¯åœ¨å†…å®¹ä¸­å‡ºç°çš„é¢‘ç‡æˆ–è¦†ç›–åº¦ï¼Œä½œä¸º `keyword_score`ã€‚
  3. æŠŠ `keyword_score` èµ‹å€¼ç»™ `rerank_score` å­—æ®µã€‚
  4. æŒ‰ `rerank_score` é™åºæ’åºï¼Œè¿”å›æ’åºåçš„æ–‡æ¡£åˆ—è¡¨ã€‚

- **æ ¸å¿ƒä»£ç **ï¼š

  ```python
  query_keywords = self._extract_keywords(query)
  for doc in documents:
      keyword_score = self._calculate_keyword_score(query_keywords, doc_content)
      doc['keyword_score'] = keyword_score
      doc['rerank_score'] = keyword_score
  reranked_docs = sorted(documents, key=lambda x: x['rerank_score'], reverse=True)
  ```

---

##### 3ï¼‰æ··åˆé‡æ’åºï¼ˆhybridï¼‰

- æ–¹æ³•ï¼š`self._hybrid_rerank(query, documents)`

- **åŸç†**ï¼šç»“åˆè¯­ä¹‰åˆ†æ•°å’Œå…³é”®è¯åˆ†æ•°ï¼Œç»¼åˆè¯„ä¼°æ–‡æ¡£ä¸ query çš„ç›¸å…³æ€§ã€‚

- **æµç¨‹**ï¼š

  1. åˆ†åˆ«è®¡ç®—è¯­ä¹‰åˆ†æ•°ï¼ˆTF-IDF ä½™å¼¦ç›¸ä¼¼åº¦ï¼‰å’Œå…³é”®è¯åˆ†æ•°ã€‚
  2. æŒ‰ä¸€å®šæƒé‡ï¼ˆå¦‚ 0.7*è¯­ä¹‰åˆ†æ•° + 0.3*å…³é”®è¯åˆ†æ•°ï¼‰åˆæˆæœ€ç»ˆ `rerank_score`ã€‚
  3. æŒ‰ `rerank_score` é™åºæ’åºï¼Œè¿”å›æ’åºåçš„æ–‡æ¡£åˆ—è¡¨ã€‚

- **æ ¸å¿ƒä»£ç **ï¼ˆä¼ªä»£ç ï¼Œå…·ä½“æƒé‡å’Œå®ç°è§å®é™…ä»£ç ï¼‰ï¼š

  ```python
  for doc in documents:
      doc['rerank_score'] = 0.7 * doc['semantic_score'] + 0.3 * doc['keyword_score']
  reranked_docs = sorted(documents, key=lambda x: x['rerank_score'], reverse=True)
  ```

---

#### 3. é€‰æ‹©é‡æ’åºæ–¹å¼

- ç”± `self.reranking_method` å†³å®šï¼Œæ”¯æŒ `'semantic'`ã€`'keyword'`ã€`'hybrid'` ä¸‰ç§ã€‚
- é»˜è®¤æ¨èç”¨ `'hybrid'`ï¼Œå…¼é¡¾è¯­ä¹‰å’Œå…³é”®è¯çš„ä¼˜åŠ¿ã€‚

---

#### 4. å¤±è´¥å…œåº•

- å¦‚æœé‡æ’åºè¿‡ç¨‹ä¸­å‡ºé”™ï¼Œä¼š logger.error å¹¶è¿”å›åŸå§‹æ–‡æ¡£é¡ºåºï¼Œä¸å½±å“ä¸»æµç¨‹å¥å£®æ€§ã€‚

---

# 3. æ™ºèƒ½è¿‡æ»¤ï¼š`self._apply_smart_filtering(question, reranked_docs)`

### å¼€å…³ï¼š "enable_smart_filtering": false  è¡¨æ˜é»˜è®¤æ˜¯å…³çš„ã€‚

### ä½œç”¨

- å¯¹é‡æ’åºåçš„æ–‡æ¡£è¿›è¡Œ**è¿›ä¸€æ­¥ç­›é€‰**ï¼Œå»é™¤å†—ä½™ã€å™ªéŸ³æˆ–ä½è´¨é‡å†…å®¹ã€‚

### å…³é”®å‚æ•°
- `question`ï¼šç”¨æˆ·é—®é¢˜ã€‚
- `reranked_docs`ï¼šé‡æ’åºåçš„æ–‡æ¡£ç‰‡æ®µåˆ—è¡¨ã€‚

### æ ¸å¿ƒé€»è¾‘
- å°†æ–‡æ¡£è½¬ä¸ºå­—å…¸æ ¼å¼ï¼Œä¾¿äºåç»­å¤„ç†ã€‚
- è°ƒç”¨ `self.smart_filter_engine.smart_filter(question, doc_dicts)`ï¼Œæ ¹æ®å¤šç§ç‰¹å¾ï¼ˆå¦‚å†…å®¹å»é‡ã€ä¸Šä¸‹æ–‡ç›¸å…³æ€§ã€é¢†åŸŸè§„åˆ™ç­‰ï¼‰è¿›è¡Œæ™ºèƒ½ç­›é€‰ã€‚
- ç­›é€‰åå†è½¬å› `Document` å¯¹è±¡åˆ—è¡¨ã€‚

### ä»£ç ç‰‡æ®µ
```python
def _apply_smart_filtering(self, question, documents):
    doc_dicts = [{'content': doc.page_content, 'metadata': doc.metadata, 'score': getattr(doc, 'score', 0.0)} for doc in documents]
    filtered_dicts = self.smart_filter_engine.smart_filter(question, doc_dicts)
    filtered_docs = [Document(page_content=d['content'], metadata=d['metadata']) for d in filtered_dicts]
    return filtered_docs
```

### ä¾èµ–æ–¹æ³•
- `self.smart_filter_engine.smart_filter(question, doc_dicts)`ï¼šæ™ºèƒ½è¿‡æ»¤å¼•æ“ï¼Œæ”¯æŒå¤šç§è‡ªå®šä¹‰è¿‡æ»¤ç­–ç•¥ï¼ˆå¦‚å»é‡ã€é¢†åŸŸç‰¹å®šè§„åˆ™ç­‰ï¼‰ã€‚

#### 1. æ–¹æ³•å…¥å£

```python
def smart_filter(self, query: str, documents: List[Dict[str, Any]], llm_answer: str = None, user_context: Dict[str, Any] = None) -> List[Dict[str, Any]]:
    # ...
```

- **query**ï¼šç”¨æˆ·é—®é¢˜
- **documents**ï¼šå¾…è¿‡æ»¤çš„æ–‡æ¡£ç‰‡æ®µï¼ˆå­—å…¸æ ¼å¼ï¼‰
- **llm_answer**ï¼šå¤§æ¨¡å‹ç”Ÿæˆçš„ç­”æ¡ˆï¼ˆå¯é€‰ï¼‰
- **user_context**ï¼šç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆå¯é€‰ï¼‰

---

#### 2. ä¸»è¦å¤„ç†æµç¨‹

##### 1ï¼‰åˆ†æ•°è®¡ç®—

å¯¹æ¯ä¸ªæ–‡æ¡£ï¼Œè®¡ç®—å››ç±»ç›¸å…³æ€§åˆ†æ•°ï¼š

- **å†…å®¹ç›¸å…³æ€§åˆ†æ•°**ï¼ˆcontent_scoreï¼‰ï¼šå…³é”®è¯ã€çŸ­è¯­ã€å®ä½“ç­‰åŒ¹é…åº¦ã€‚
- **è¯­ä¹‰ç›¸ä¼¼åº¦åˆ†æ•°**ï¼ˆsemantic_scoreï¼‰ï¼šquery ä¸æ–‡æ¡£å†…å®¹çš„è¯­ä¹‰ç›¸ä¼¼åº¦ã€‚
- **ä¸Šä¸‹æ–‡ç›¸å…³æ€§åˆ†æ•°**ï¼ˆcontext_scoreï¼‰ï¼šç»“åˆç”¨æˆ·ä¸Šä¸‹æ–‡ã€å†å²å¯¹è¯ç­‰ä¿¡æ¯çš„ç›¸å…³æ€§ã€‚
- **ç”¨æˆ·æ„å›¾åŒ¹é…åˆ†æ•°**ï¼ˆintent_scoreï¼‰ï¼šquery çš„æ„å›¾ä¸æ–‡æ¡£å†…å®¹/LLMç­”æ¡ˆçš„æ„å›¾åŒ¹é…åº¦ã€‚

æ¯ä¸ªåˆ†æ•°çš„è®¡ç®—éƒ½è°ƒç”¨äº†ä¸“é—¨çš„å­æ–¹æ³•ï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚

##### 2ï¼‰ç»¼åˆåˆ†æ•°

- è°ƒç”¨ `_calculate_final_score(content_score, semantic_score, context_score, intent_score)`ï¼Œå°†ä¸Šè¿°åˆ†æ•°åŠ æƒåˆæˆä¸€ä¸ª**æœ€ç»ˆåˆ†æ•°**ï¼ˆfinal_scoreï¼‰ã€‚

##### 3ï¼‰æ’åºä¸è¿‡æ»¤

- æŒ‰ final_score é™åºæ’åºæ‰€æœ‰æ–‡æ¡£ã€‚
- è¿‡æ»¤æ‰åˆ†æ•°ä½äºé˜ˆå€¼ï¼ˆ`self.content_relevance_threshold`ï¼‰çš„æ–‡æ¡£ã€‚
- æœ€å¤šä¿ç•™ `self.max_filtered_results` ä¸ªæ–‡æ¡£ã€‚

---

#### 3. å…³é”®å­æ–¹æ³•è¯´æ˜

##### 1ï¼‰å†…å®¹ç›¸å…³æ€§åˆ†æ•° `_calculate_content_relevance`

- å…³é”®è¯åŒ¹é…ï¼šæå– query å’Œæ–‡æ¡£å†…å®¹çš„å…³é”®è¯ï¼Œè®¡ç®—é‡å åº¦ã€‚
- çŸ­è¯­åŒ¹é…ï¼šæå– query å’Œå†…å®¹çš„çŸ­è¯­ï¼Œè®¡ç®—ç›¸ä¼¼åº¦ã€‚
- å®ä½“åŒ¹é…ï¼šæå–å‘½åå®ä½“ï¼Œè®¡ç®—é‡å åº¦ã€‚
- ç»¼åˆä¸Šè¿°å¾—åˆ†ï¼Œåæ˜  query ä¸æ–‡æ¡£åœ¨â€œå­—é¢â€ä¸Šçš„ç›¸å…³æ€§ã€‚

##### 2ï¼‰è¯­ä¹‰ç›¸ä¼¼åº¦åˆ†æ•° `_calculate_semantic_similarity`

- é€šè¿‡ SequenceMatcher è®¡ç®—ç”¨æˆ·é—®é¢˜å’Œæ–‡æ¡£å†…å®¹ä¹‹é—´çš„ç›¸ä¼¼åº¦åˆ†æ•°ï¼ˆratioï¼‰ï¼Œåæ˜ äºŒè€…çš„æ–‡æœ¬ç›¸ä¼¼æ€§ã€‚
- å¦‚æœç›¸ä¼¼åº¦åˆ†æ•°ä½äºè®¾å®šçš„é˜ˆå€¼ï¼ˆself.semantic_similarity_thresholdï¼‰ï¼Œåˆ™åˆ†æ•°è¢«ç½®ä¸º0ï¼Œè¡¨ç¤ºè¯­ä¹‰ç›¸å…³æ€§ä¸è¶³ã€‚
- æœ€ç»ˆè¿”å›çš„åˆ†æ•°è¶Šé«˜ï¼Œè¯´æ˜è¯¥æ–‡æ¡£å†…å®¹ä¸ç”¨æˆ·é—®é¢˜åœ¨æ–‡æœ¬å±‚é¢è¶Šæ¥è¿‘ï¼Œæ›´æœ‰å¯èƒ½è¢«è®¤ä¸ºæ˜¯ç›¸å…³å†…å®¹ã€‚

##### 3ï¼‰ä¸Šä¸‹æ–‡ç›¸å…³æ€§åˆ†æ•° `_calculate_context_relevance`

- åˆ©ç”¨ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆå¦‚å†å²å¯¹è¯ã€ç”¨æˆ·åå¥½ç­‰ï¼‰ï¼Œåˆ¤æ–­æ–‡æ¡£å†…å®¹ä¸å½“å‰ä¸Šä¸‹æ–‡çš„ç›¸å…³æ€§ã€‚
- ä¾‹å¦‚ï¼Œå¦‚æœç”¨æˆ·ä¹‹å‰ä¸€ç›´å…³æ³¨æŸä¸ªä¸»é¢˜ï¼Œåˆ™ä¸è¯¥ä¸»é¢˜ç›¸å…³çš„æ–‡æ¡£å¾—åˆ†æ›´é«˜ã€‚

##### 4ï¼‰ç”¨æˆ·æ„å›¾åŒ¹é…åˆ†æ•° `_calculate_intent_relevance`

- åˆ†æ query çš„æ„å›¾ã€æ–‡æ¡£å†…å®¹çš„æ„å›¾ã€LLMç­”æ¡ˆçš„æ„å›¾ï¼Œè®¡ç®—å®ƒä»¬ä¹‹é—´çš„åŒ¹é…åº¦ã€‚
- ä¾‹å¦‚ï¼Œç”¨æˆ·é—®â€œæœ€æ–°çš„è´¢æŠ¥â€ï¼Œåˆ™ä¸â€œæ—¶é—´â€ç›¸å…³çš„æ–‡æ¡£å¾—åˆ†æ›´é«˜ã€‚

##### 5ï¼‰ç»¼åˆåˆ†æ•° `_calculate_final_score`

- æŒ‰ä¸€å®šæƒé‡ï¼ˆå¯é…ç½®ï¼‰å°†ä¸Šè¿°å››ç±»åˆ†æ•°åˆæˆæœ€ç»ˆåˆ†æ•°ã€‚
- ä¾‹å¦‚ï¼š`final_score = 0.4*content + 0.3*semantic + 0.2*context + 0.1*intent`ï¼ˆå…·ä½“æƒé‡è§å®é™…å®ç°ï¼‰ã€‚

---

#### 4. ä¼ªä»£ç æµç¨‹

```python
for doc in documents:
    content_score = self._calculate_content_relevance(query, doc)
    semantic_score = self._calculate_semantic_similarity(query, doc)
    context_score = self._calculate_context_relevance(query, doc, user_context)
    intent_score = self._calculate_intent_relevance(query, doc, llm_answer)
    final_score = self._calculate_final_score(content_score, semantic_score, context_score, intent_score)
    doc['smart_filter_scores'] = {...}
    scored_documents.append(doc)

sorted_documents = sorted(scored_documents, key=lambda x: x['smart_filter_scores']['final_score'], reverse=True)
filtered_documents = [doc for doc in sorted_documents if doc['smart_filter_scores']['final_score'] >= threshold]
final_documents = filtered_documents[:max_results]
```

---

#### 5. æ™ºèƒ½è¿‡æ»¤çš„æ„ä¹‰

- **å¤šç»´åº¦ç›¸å…³æ€§è¯„ä¼°**ï¼Œä¸ä»…ä»…ä¾èµ–å…³é”®è¯æˆ–è¯­ä¹‰ï¼Œè¿˜ç»“åˆä¸Šä¸‹æ–‡å’Œæ„å›¾ï¼Œæå¤§æå‡äº†æ£€ç´¢çš„ç²¾å‡†åº¦å’Œç”¨æˆ·ä½“éªŒã€‚
- **å¯æ‰©å±•æ€§å¼º**ï¼Œå¯ä»¥æ ¹æ®å®é™…ä¸šåŠ¡éœ€æ±‚çµæ´»è°ƒæ•´å„åˆ†æ•°çš„è®¡ç®—æ–¹å¼å’Œæƒé‡ã€‚

---

# 4. ç”Ÿæˆå›ç­”ï¼š`self._generate_answer(question, filtered_docs)`

### ä½œç”¨
- åˆ©ç”¨ç­›é€‰åçš„æ–‡æ¡£ç‰‡æ®µï¼Œç»“åˆå¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ï¼Œ**ç”Ÿæˆé’ˆå¯¹ç”¨æˆ·é—®é¢˜çš„è‡ªç„¶è¯­è¨€å›ç­”**ã€‚

### å…³é”®å‚æ•°
- `question`ï¼šç”¨æˆ·é—®é¢˜ã€‚
- `filtered_docs`ï¼šæœ€ç»ˆç­›é€‰å‡ºçš„æ–‡æ¡£ç‰‡æ®µåˆ—è¡¨ã€‚

### æ ¸å¿ƒé€»è¾‘
- å°†æ–‡æ¡£ç‰‡æ®µæ‹¼æ¥ä¸ºä¸Šä¸‹æ–‡å­—ç¬¦ä¸²ã€‚
- è°ƒç”¨ `self.qa_chain.invoke({"input_documents": documents, "question": question})`ï¼Œå°†ä¸Šä¸‹æ–‡å’Œé—®é¢˜ä¸€èµ·ä¼ é€’ç»™ LLMã€‚
- è§£æ LLM è¿”å›çš„ç»“æœï¼Œæå–æœ€ç»ˆå›ç­”æ–‡æœ¬ã€‚
- è®¡ç®—æœ¬æ¬¡é—®ç­”çš„ token æˆæœ¬ã€‚

### ä»£ç ç‰‡æ®µ
```python
def _generate_answer(self, question, documents):
    context = "\n\n".join([doc.page_content for doc in documents])
    response = self.qa_chain.invoke({
        "input_documents": documents,
        "question": question
    })
    # è§£æresponseï¼Œæå–answer
    return {'answer': response, 'cost': cost}
```

### ä¾èµ–æ–¹æ³•
- `self.qa_chain.invoke(...)`ï¼šLangChain çš„é—®ç­”é“¾ï¼Œåº•å±‚è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆå¦‚é€šä¹‰åƒé—®ã€OpenAIç­‰ï¼‰ï¼Œæ ¹æ®ä¸Šä¸‹æ–‡å’Œé—®é¢˜ç”Ÿæˆè‡ªç„¶è¯­è¨€å›ç­”ã€‚

---

# 5. æºè¿‡æ»¤ä¼˜åŒ–ï¼š`self._apply_source_filtering(answer_result['answer'], filtered_docs)`

### å¼€å…³

æºè¿‡æ»¤å¼•æ“æ”¯æŒå¤šç§é…ç½®å‚æ•°ï¼š

- enable_sources_filteringï¼šæ˜¯å¦å¯ç”¨æºè¿‡æ»¤

- min_relevance_scoreï¼šæœ€å°ç›¸å…³æ€§åˆ†æ•°é˜ˆå€¼

- enable_keyword_matchingï¼šæ˜¯å¦å¯ç”¨å…³é”®è¯åŒ¹é…

- enable_image_id_matchingï¼šæ˜¯å¦å¯ç”¨å›¾ç‰‡IDåŒ¹é…

- enable_similarity_filteringï¼šæ˜¯å¦å¯ç”¨ç›¸ä¼¼åº¦è¿‡æ»¤

### ä½œç”¨

- å¯¹æœ€ç»ˆå›ç­”æ¶‰åŠçš„æ–‡æ¡£æºè¿›è¡Œ**è¿›ä¸€æ­¥ç­›é€‰**ï¼Œåªä¿ç•™çœŸæ­£ä¸ºç­”æ¡ˆæä¾›æ”¯æ’‘çš„æ–‡æ¡£ï¼Œæå‡å¯è¿½æº¯æ€§å’Œæƒå¨æ€§ã€‚

### å…³é”®å‚æ•°
- `llm_answer`ï¼šå¤§æ¨¡å‹ç”Ÿæˆçš„æœ€ç»ˆå›ç­”æ–‡æœ¬ã€‚
- `filtered_docs`ï¼šå‚ä¸ç”Ÿæˆå›ç­”çš„æ–‡æ¡£ç‰‡æ®µåˆ—è¡¨ã€‚

### æ ¸å¿ƒé€»è¾‘
- å°†æ–‡æ¡£ç‰‡æ®µè½¬ä¸ºæºæ ¼å¼ï¼ˆåŒ…å«å†…å®¹ã€å…ƒæ•°æ®ã€åˆ†æ•°ç­‰ï¼‰ã€‚
- è°ƒç”¨ `self.source_filter_engine.filter_sources(llm_answer, sources)`ï¼Œæ ¹æ®ç­”æ¡ˆå†…å®¹å’Œæ–‡æ¡£å†…å®¹çš„ç›¸å…³æ€§ï¼Œç­›é€‰å‡ºæœ€æœ‰ä»·å€¼çš„æ–‡æ¡£æºã€‚
- è¿”å›æœ€ç»ˆçš„æ–‡æ¡£æºåˆ—è¡¨ã€‚

### ä»£ç ç‰‡æ®µ
```python
def _apply_source_filtering(self, llm_answer, documents):
    sources = [{'content': doc.page_content, 'metadata': doc.metadata, 'score': getattr(doc, 'score', 0.0)} for doc in documents]
    filtered_sources = self.source_filter_engine.filter_sources(llm_answer, sources)
    return filtered_sources
```

### ä¾èµ–æ–¹æ³•
- `self.source_filter_engine.filter_sources(llm_answer, sources)`ï¼šæºè¿‡æ»¤å¼•æ“ï¼Œé€šå¸¸åŸºäºç­”æ¡ˆä¸æ–‡æ¡£å†…å®¹çš„ç›¸ä¼¼åº¦ã€å¼•ç”¨å…³ç³»ç­‰ï¼Œç­›é€‰å‡ºæœ€ç›¸å…³çš„æ–‡æ¡£æºã€‚

#### 1. æ–¹æ³•æ¦‚è¿°

```python
def _apply_source_filtering(self, llm_answer: str, documents: List[Document]) -> List[Dict[str, Any]]:
```

**ä½œç”¨**ï¼šæ ¹æ®å¤§æ¨¡å‹ç”Ÿæˆçš„ç­”æ¡ˆå†…å®¹ï¼Œå¯¹å‚ä¸ç”Ÿæˆç­”æ¡ˆçš„æ–‡æ¡£æºè¿›è¡Œè¿›ä¸€æ­¥ç­›é€‰ï¼Œç¡®ä¿æœ€ç»ˆå¼•ç”¨çš„æ–‡æ¡£çœŸæ­£ä¸ºç­”æ¡ˆæä¾›äº†æ”¯æ’‘ã€‚

---

#### 2. æ ¸å¿ƒå®ç°é€»è¾‘

##### 2.1 å‰ç½®æ£€æŸ¥

```python
if not self.source_filter_engine or not documents:
    # è½¬æ¢ä¸ºæºæ ¼å¼
    sources = []
    for doc in documents:
        source = {
            'content': doc.page_content,
            'metadata': doc.metadata,
            'score': getattr(doc, 'score', 0.0)
        }
        sources.append(source)
    return sources
```

**æœºåˆ¶**ï¼š
- å¦‚æœæºè¿‡æ»¤å¼•æ“æœªåˆå§‹åŒ–æˆ–æ–‡æ¡£åˆ—è¡¨ä¸ºç©ºï¼Œ**è·³è¿‡æºè¿‡æ»¤**ï¼Œç›´æ¥è¿”å›æ‰€æœ‰æ–‡æ¡£
- å°† `Document` å¯¹è±¡è½¬æ¢ä¸ºå­—å…¸æ ¼å¼ï¼Œä¾¿äºåç»­å¤„ç†
- æ¯ä¸ªæºåŒ…å«ï¼šå†…å®¹ã€å…ƒæ•°æ®ã€ç›¸ä¼¼åº¦åˆ†æ•°

##### 2.2 æ­£å¸¸æºè¿‡æ»¤æµç¨‹

```python
try:
    # è½¬æ¢ä¸ºæºæ ¼å¼
    sources = []
    for doc in documents:
        source = {
            'content': doc.page_content,
            'metadata': doc.metadata,
            'score': getattr(doc, 'score', 0.0)
        }
        sources.append(source)
    
    # æ‰§è¡Œæºè¿‡æ»¤
    filtered_sources = self.source_filter_engine.filter_sources(llm_answer, sources)
    
    return filtered_sources
    
except Exception as e:
    logger.error(f"æºè¿‡æ»¤å¤±è´¥: {e}")
    return sources
```

**æœºåˆ¶**ï¼š
- å°†æ–‡æ¡£è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼
- è°ƒç”¨ `self.source_filter_engine.filter_sources(llm_answer, sources)` è¿›è¡Œæºè¿‡æ»¤
- å¦‚æœè¿‡æ»¤å¤±è´¥ï¼Œè¿”å›åŸå§‹æºåˆ—è¡¨ï¼ˆä¿è¯ç³»ç»Ÿå¥å£®æ€§ï¼‰

---

#### 3. æºè¿‡æ»¤çš„æ ¸å¿ƒæ€æƒ³

##### 3.1 è¾“å…¥å‚æ•°
- **llm_answer**ï¼šå¤§æ¨¡å‹ç”Ÿæˆçš„æœ€ç»ˆç­”æ¡ˆæ–‡æœ¬
- **documents**ï¼šå‚ä¸ç”Ÿæˆç­”æ¡ˆçš„æ–‡æ¡£ç‰‡æ®µåˆ—è¡¨

##### 3.2 è¿‡æ»¤ç›®æ ‡
- æ ¹æ®ç­”æ¡ˆå†…å®¹ï¼Œåˆ¤æ–­å“ªäº›æ–‡æ¡£çœŸæ­£ä¸ºç­”æ¡ˆæä¾›äº†ä¿¡æ¯æ”¯æ’‘
- å»é™¤ä¸ç­”æ¡ˆæ— å…³çš„æ–‡æ¡£æºï¼Œæå‡ç­”æ¡ˆçš„å¯è¿½æº¯æ€§å’Œæƒå¨æ€§

##### 3.3 å®ç°ç­–ç•¥
æºè¿‡æ»¤å¼•æ“ï¼ˆ`self.source_filter_engine`ï¼‰é€šå¸¸ä¼šé‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š

1. **å†…å®¹ç›¸å…³æ€§åˆ†æ**ï¼šè®¡ç®—ç­”æ¡ˆä¸æ¯ä¸ªæ–‡æ¡£å†…å®¹çš„ç›¸ä¼¼åº¦
2. **å…³é”®è¯åŒ¹é…**ï¼šæ£€æŸ¥ç­”æ¡ˆä¸­çš„å…³é”®ä¿¡æ¯æ˜¯å¦æ¥è‡ªç‰¹å®šæ–‡æ¡£
3. **å¼•ç”¨å…³ç³»åˆ†æ**ï¼šåˆ¤æ–­ç­”æ¡ˆæ˜¯å¦å¼•ç”¨äº†æ–‡æ¡£ä¸­çš„å…·ä½“æ•°æ®æˆ–è§‚ç‚¹
4. **é‡è¦æ€§è¯„ä¼°**ï¼šæ ¹æ®æ–‡æ¡£åœ¨ç­”æ¡ˆä¸­çš„è´¡çŒ®åº¦è¿›è¡Œæ’åº

---

#### 4. æ•°æ®æ ¼å¼è½¬æ¢

##### 4.1 è¾“å…¥æ ¼å¼ï¼ˆDocumentå¯¹è±¡ï¼‰
```python
Document(
    page_content="æ–‡æ¡£å†…å®¹...",
    metadata={
        'document_name': 'æ–‡æ¡£åç§°',
        'page_number': é¡µç ,
        'chunk_type': 'chunkç±»å‹',
        # å…¶ä»–å…ƒæ•°æ®...
    }
)
```

##### 4.2 è¾“å‡ºæ ¼å¼ï¼ˆå­—å…¸åˆ—è¡¨ï¼‰
```python
[
    {
        'content': 'æ–‡æ¡£å†…å®¹...',
        'metadata': {
            'document_name': 'æ–‡æ¡£åç§°',
            'page_number': é¡µç ,
            # å…¶ä»–å…ƒæ•°æ®...
        },
        'score': 0.85  # ç›¸ä¼¼åº¦åˆ†æ•°
    },
    # æ›´å¤šæº...
]
```

---

#### 5. é”™è¯¯å¤„ç†æœºåˆ¶

```python
except Exception as e:
    logger.error(f"æºè¿‡æ»¤å¤±è´¥: {e}")
    return sources
```

**æœºåˆ¶**ï¼š
- æ•è·æºè¿‡æ»¤è¿‡ç¨‹ä¸­çš„ä»»ä½•å¼‚å¸¸
- è®°å½•é”™è¯¯æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•
- è¿”å›åŸå§‹æºåˆ—è¡¨ï¼Œç¡®ä¿ç³»ç»Ÿä¸ä¼šå› ä¸ºæºè¿‡æ»¤å¤±è´¥è€Œä¸­æ–­

---

#### 6. åœ¨æ•´ä½“æµç¨‹ä¸­çš„ä½œç”¨

æºè¿‡æ»¤æ˜¯RAGç³»ç»Ÿçš„**æœ€åä¸€é“è´¨é‡å…³å¡**ï¼š

1. **åˆå§‹æ£€ç´¢** â†’ å¬å›ç›¸å…³æ–‡æ¡£
2. **é‡æ’åº** â†’ æå‡æ–‡æ¡£ä¼˜å…ˆçº§
3. **æ™ºèƒ½è¿‡æ»¤** â†’ å»é™¤å†—ä½™å†…å®¹
4. **ç”Ÿæˆå›ç­”** â†’ åŸºäºç­›é€‰åçš„æ–‡æ¡£ç”Ÿæˆç­”æ¡ˆ
5. **æºè¿‡æ»¤** â†’ **ç¡®ä¿ç­”æ¡ˆçš„å¯è¿½æº¯æ€§**

---

#### 7. å®é™…åº”ç”¨åœºæ™¯

- **å­¦æœ¯é—®ç­”**ï¼šç¡®ä¿å¼•ç”¨çš„æ–‡çŒ®çœŸæ­£æ”¯æŒç­”æ¡ˆ
- **å•†ä¸šæŠ¥å‘Š**ï¼šéªŒè¯æ•°æ®æ¥æºçš„å‡†ç¡®æ€§
- **æ³•å¾‹å’¨è¯¢**ï¼šç¡®ä¿å¼•ç”¨çš„æ³•æ¡ä¸é—®é¢˜ç›¸å…³
- **æŠ€æœ¯æ–‡æ¡£**ï¼šä¿è¯æŠ€æœ¯è¯´æ˜çš„æ¥æºå¯é æ€§

---

## æ€»ç»“

æºè¿‡æ»¤æœºåˆ¶é€šè¿‡**ç­”æ¡ˆå¯¼å‘çš„æ–‡æ¡£ç­›é€‰**ï¼Œç¡®ä¿æœ€ç»ˆå‘ˆç°ç»™ç”¨æˆ·çš„æ–‡æ¡£æºçœŸæ­£ä¸ºç­”æ¡ˆæä¾›äº†æ”¯æ’‘ï¼Œæå‡äº†RAGç³»ç»Ÿçš„å¯ä¿¡åº¦å’Œå¯è§£é‡Šæ€§ã€‚å³ä½¿æºè¿‡æ»¤å¤±è´¥ï¼Œç³»ç»Ÿä¹Ÿèƒ½æ­£å¸¸è¿è¡Œï¼Œä½“ç°äº†è‰¯å¥½çš„å®¹é”™è®¾è®¡ã€‚

## è¡¥å……ï¼šfilter_sources çš„å®ç°æœºåˆ¶


## 1. æ–¹æ³•å…¥å£

```python
def filter_sources(self, llm_answer: str, sources: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
```

**ä½œç”¨**ï¼šæ ¹æ®å¤§æ¨¡å‹ç”Ÿæˆçš„ç­”æ¡ˆå†…å®¹ï¼Œå¯¹æ£€ç´¢æºè¿›è¡Œè¿‡æ»¤ï¼Œåªä¿ç•™çœŸæ­£ä¸ºç­”æ¡ˆæä¾›æ”¯æ’‘çš„æ–‡æ¡£æºã€‚

---

## 2. æ ¸å¿ƒå¤„ç†æµç¨‹

### 2.1 å‰ç½®æ£€æŸ¥

```python
if not self.enable_sources_filtering or not sources:
    return sources
```

- å¦‚æœæºè¿‡æ»¤åŠŸèƒ½è¢«ç¦ç”¨æˆ–æºåˆ—è¡¨ä¸ºç©ºï¼Œç›´æ¥è¿”å›åŸå§‹æºåˆ—è¡¨

### 2.2 æºè¿‡æ»¤ä¸»æµç¨‹

```python
filtered_sources = []

for source in sources:
    relevance_score = self._calculate_source_relevance(llm_answer, source)
    source['relevance_score'] = relevance_score
    
    # æ ¹æ®ç›¸å…³æ€§åˆ†æ•°å†³å®šæ˜¯å¦ä¿ç•™
    if relevance_score >= self.min_relevance_score:
        filtered_sources.append(source)
```

**æœºåˆ¶**ï¼š
- éå†æ¯ä¸ªæºï¼Œè®¡ç®—å…¶ä¸LLMç­”æ¡ˆçš„ç›¸å…³æ€§åˆ†æ•°
- å°†ç›¸å…³æ€§åˆ†æ•°æ·»åŠ åˆ°æºçš„å…ƒæ•°æ®ä¸­
- åªä¿ç•™ç›¸å…³æ€§åˆ†æ•°è¾¾åˆ°é˜ˆå€¼ï¼ˆ`self.min_relevance_score`ï¼‰çš„æº

---

## 3. ç›¸å…³æ€§åˆ†æ•°è®¡ç®—

æ ¸å¿ƒæ–¹æ³•æ˜¯ `_calculate_source_relevance`ï¼Œå®ƒç»¼åˆäº†ä¸‰ç§ç›¸å…³æ€§è¯„ä¼°ï¼š

### 3.1 å…³é”®è¯åŒ¹é…åˆ†æ•°

```python
if self.enable_keyword_matching:
    keyword_score = self._calculate_keyword_relevance(llm_answer, source)
    scores.append(keyword_score)
```

**å®ç°**ï¼š
- æå–LLMç­”æ¡ˆå’Œæºå†…å®¹çš„å…³é”®è¯
- è®¡ç®—å…³é”®è¯çš„Jaccardç›¸ä¼¼åº¦ï¼ˆäº¤é›†/å¹¶é›†ï¼‰
- åæ˜ ç­”æ¡ˆä¸æºåœ¨å…³é”®è¯å±‚é¢çš„åŒ¹é…ç¨‹åº¦

### 3.2 å›¾ç‰‡IDåŒ¹é…åˆ†æ•°

```python
if self.enable_image_id_matching:
    image_score = self._calculate_image_relevance(llm_answer, source)
    scores.append(image_score)
```

**å®ç°**ï¼š
- ä»LLMç­”æ¡ˆä¸­æå–å›¾ç‰‡IDï¼ˆå¦‚"å›¾1"ã€"å›¾2"ç­‰ï¼‰
- ä»æºå†…å®¹ä¸­æå–å›¾ç‰‡ID
- è®¡ç®—å›¾ç‰‡IDçš„é‡å åº¦ï¼Œåˆ¤æ–­ç­”æ¡ˆæ˜¯å¦å¼•ç”¨äº†ç‰¹å®šå›¾ç‰‡

### 3.3 ç›¸ä¼¼åº¦è¿‡æ»¤åˆ†æ•°

```python
if self.enable_similarity_filtering:
    similarity_score = self._calculate_similarity_relevance(llm_answer, source)
    scores.append(similarity_score)
```

**å®ç°**ï¼š
- ä½¿ç”¨æ–‡æœ¬ç›¸ä¼¼åº¦ç®—æ³•ï¼ˆå¦‚TF-IDFã€ä½™å¼¦ç›¸ä¼¼åº¦ç­‰ï¼‰
- è®¡ç®—LLMç­”æ¡ˆä¸æºå†…å®¹çš„æ•´ä½“ç›¸ä¼¼åº¦
- åæ˜ ç­”æ¡ˆä¸æºåœ¨è¯­ä¹‰å±‚é¢çš„ç›¸å…³æ€§

### 3.4 ç»¼åˆåˆ†æ•°è®¡ç®—

```python
if not scores:
    return 0.5

# è¿”å›å¹³å‡åˆ†æ•°
return sum(scores) / len(scores)
```

- å°†ä¸‰ç§åˆ†æ•°å–å¹³å‡å€¼ä½œä¸ºæœ€ç»ˆçš„ç›¸å…³æ€§åˆ†æ•°
- å¦‚æœæ²¡æœ‰å¯ç”¨ä»»ä½•è¿‡æ»¤æ–¹æ³•ï¼Œè¿”å›é»˜è®¤åˆ†æ•°0.5

---

## 4. å…·ä½“å®ç°ç»†èŠ‚

### 4.1 å…³é”®è¯åŒ¹é…å®ç°

```python
def _calculate_keyword_relevance(self, llm_answer: str, source: Dict[str, Any]) -> float:
    # æå–å…³é”®è¯
    answer_keywords = self._extract_keywords(llm_answer)
    source_keywords = self._extract_keywords(source.get('content', ''))
    
    # è®¡ç®—Jaccardç›¸ä¼¼åº¦
    answer_keyword_set = set(answer_keywords)
    source_keyword_set = set(source_keywords)
    
    intersection = answer_keyword_set & source_keyword_set
    union = answer_keyword_set | source_keyword_set
    
    return len(intersection) / len(union) if union else 0.0
```

### 4.2 å›¾ç‰‡IDåŒ¹é…å®ç°

```python
def _calculate_image_relevance(self, llm_answer: str, source: Dict[str, Any]) -> float:
    # æå–å›¾ç‰‡ID
    answer_image_ids = self._extract_image_ids(llm_answer)
    source_image_ids = self._extract_image_ids_from_source(source)
    
    # è®¡ç®—é‡å åº¦
    if not answer_image_ids or not source_image_ids:
        return 0.0
    
    intersection = set(answer_image_ids) & set(source_image_ids)
    return len(intersection) / max(len(answer_image_ids), len(source_image_ids))
```

---

## 5. é…ç½®å‚æ•°

æºè¿‡æ»¤å¼•æ“æ”¯æŒå¤šç§é…ç½®å‚æ•°ï¼š

- `enable_sources_filtering`ï¼šæ˜¯å¦å¯ç”¨æºè¿‡æ»¤
- `min_relevance_score`ï¼šæœ€å°ç›¸å…³æ€§åˆ†æ•°é˜ˆå€¼
- `enable_keyword_matching`ï¼šæ˜¯å¦å¯ç”¨å…³é”®è¯åŒ¹é…
- `enable_image_id_matching`ï¼šæ˜¯å¦å¯ç”¨å›¾ç‰‡IDåŒ¹é…
- `enable_similarity_filtering`ï¼šæ˜¯å¦å¯ç”¨ç›¸ä¼¼åº¦è¿‡æ»¤

---

## 6. é”™è¯¯å¤„ç†

```python
except Exception as e:
    logger.error(f"æºè¿‡æ»¤å¤±è´¥: {e}")
    return sources
```

- æ•è·æºè¿‡æ»¤è¿‡ç¨‹ä¸­çš„å¼‚å¸¸
- è®°å½•é”™è¯¯æ—¥å¿—
- è¿”å›åŸå§‹æºåˆ—è¡¨ï¼Œç¡®ä¿ç³»ç»Ÿå¥å£®æ€§

---

## æ€»ç»“

`filter_sources` é€šè¿‡**å¤šç»´åº¦ç›¸å…³æ€§è¯„ä¼°**ï¼ˆå…³é”®è¯ã€å›¾ç‰‡IDã€è¯­ä¹‰ç›¸ä¼¼åº¦ï¼‰ï¼Œç¡®ä¿æœ€ç»ˆè¿”å›çš„æºçœŸæ­£ä¸ºLLMç­”æ¡ˆæä¾›äº†æ”¯æ’‘ï¼Œæå‡äº†RAGç³»ç»Ÿçš„å¯è¿½æº¯æ€§å’Œå¯ä¿¡åº¦ã€‚



---

# æ€»ç»“

æ¯ä¸€æ­¥çš„æ ¸å¿ƒæ–¹æ³•éƒ½æ‰¿æ‹…ç€**ä¿¡æ¯ç­›é€‰ã€ä¼˜åŒ–å’Œæå‡ç›¸å…³æ€§çš„å…³é”®ä½œç”¨**ï¼Œå®ƒä»¬é€šè¿‡å±‚å±‚é€’è¿›çš„æ–¹å¼ï¼Œæœ€ç»ˆå®ç°äº†é«˜è´¨é‡ã€å¯è¿½æº¯çš„ç²¾å‡†é—®ç­”ã€‚

å¦‚éœ€è¿›ä¸€æ­¥æ·±å…¥æŸä¸ªæ–¹æ³•çš„å†…éƒ¨å®ç°ï¼ˆæ¯”å¦‚é‡æ’åºã€æ™ºèƒ½è¿‡æ»¤ã€æºè¿‡æ»¤çš„å…·ä½“ç®—æ³•ï¼‰ï¼Œå¯ä»¥ç»§ç»­æŒ‡å®šï¼Œæˆ‘ä¼šä¸ºä½ è¯¦ç»†å‰–æï¼



