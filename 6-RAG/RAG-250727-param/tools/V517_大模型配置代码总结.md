# RAGç³»ç»Ÿå¤§æ¨¡å‹é…ç½®ä»£ç æ€»ç»“

## ğŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®ä½¿ç”¨äº†ä¸‰ä¸ªä¸»è¦çš„å¤§æ¨¡å‹ï¼Œåˆ†åˆ«ç”¨äºä¸åŒçš„åŠŸèƒ½ã€‚ä»¥ä¸‹æ˜¯é…ç½®è¿™äº›æ¨¡å‹çš„ç¨‹åºæ–‡ä»¶å’Œå…·ä½“ä»£ç ã€‚

---

## ğŸ¤– 1. é€šä¹‰åƒé—® (Qwen-Turbo) - é—®ç­”æ¨¡å‹

### ğŸ“ ä¸»è¦é…ç½®æ–‡ä»¶
- **`core/qa_system.py`** - é—®ç­”ç³»ç»Ÿæ ¸å¿ƒ
- **`config/settings.py`** - æ¨¡å‹é…ç½®

### ğŸ”§ é…ç½®ä»£ç 

#### 1.1 æ¨¡å‹åˆå§‹åŒ– (`core/qa_system.py`)
```python
# å¯¼å…¥æ¨¡å—
from langchain_community.llms import Tongyi

# åˆå§‹åŒ–è¯­è¨€æ¨¡å‹
self.llm = Tongyi(
    model_name="qwen-turbo", 
    dashscope_api_key=api_key
)

# åŠ è½½é—®ç­”é“¾
self.qa_chain = load_qa_chain(
    self.llm, 
    chain_type="stuff",
    prompt=self._create_enhanced_prompt()
)
```

#### 1.2 æ¨¡å‹é…ç½® (`config/settings.py`)
```python
# é—®ç­”ç³»ç»Ÿé…ç½®
model_name: str = 'qwen-turbo'
temperature: float = 0.7
max_tokens: int = 2000
```

#### 1.3 æˆæœ¬è®¡ç®—å™¨ (`core/qa_system.py`)
```python
class TongyiCostCalculator:
    """
    é€šä¹‰åƒé—®æˆæœ¬è®¡ç®—å™¨
    """
    def __init__(self):
        # é€šä¹‰åƒé—®qwen-turboæ¨¡å‹çš„å®šä»·ï¼ˆæ¯1000ä¸ªtokençš„ä»·æ ¼ï¼Œå•ä½ï¼šå…ƒï¼‰
        self.input_price_per_1k_tokens = 0.0005  # è¾“å…¥ä»·æ ¼
        self.output_price_per_1k_tokens = 0.002   # è¾“å‡ºä»·æ ¼
    
    def calculate_cost(self, input_tokens: int, output_tokens: int) -> float:
        """
        è®¡ç®—APIè°ƒç”¨æˆæœ¬
        :param input_tokens: è¾“å…¥tokenæ•°é‡
        :param output_tokens: è¾“å‡ºtokenæ•°é‡
        :return: æˆæœ¬ï¼ˆå…ƒï¼‰
        """
        input_cost = (input_tokens / 1000) * self.input_price_per_1k_tokens
        output_cost = (output_tokens / 1000) * self.output_price_per_1k_tokens
        return input_cost + output_cost
```

---

## ğŸ”¤ 2. æ–‡æœ¬åµŒå…¥æ¨¡å‹ (Text Embedding V1) - æ–‡æœ¬å‘é‡åŒ–

### ğŸ“ ä¸»è¦é…ç½®æ–‡ä»¶
- **`document_processing/vector_generator.py`** - å‘é‡ç”Ÿæˆå™¨
- **`core/vector_store.py`** - å‘é‡å­˜å‚¨
- **`core/qa_system.py`** - åŠ è½½å‡½æ•°

### ğŸ”§ é…ç½®ä»£ç 

#### 2.1 å‘é‡ç”Ÿæˆå™¨ (`document_processing/vector_generator.py`)
```python
# å¯¼å…¥æ¨¡å—
from langchain_community.embeddings import DashScopeEmbeddings

class VectorGenerator:
    def __init__(self, config):
        self.config = config
        self.api_key = self._get_api_key()
        # åˆå§‹åŒ–æ–‡æœ¬åµŒå…¥æ¨¡å‹
        self.embeddings = DashScopeEmbeddings(
            dashscope_api_key=self.api_key, 
            model="text-embedding-v1"
        )
    
    def _get_api_key(self) -> str:
        """
        è·å–DashScope APIå¯†é’¥
        """
        api_key = os.getenv('MY_DASHSCOPE_API_KEY', '')
        if not api_key or api_key == 'ä½ çš„APIKEY':
            logger.warning("æœªæ‰¾åˆ°æœ‰æ•ˆçš„DashScope APIå¯†é’¥")
        return api_key
```

#### 2.2 å‘é‡å­˜å‚¨ (`core/vector_store.py`)
```python
# å¯¼å…¥æ¨¡å—
from langchain_community.embeddings import DashScopeEmbeddings

class VectorStore:
    def __init__(self, api_key: str = None):
        self.api_key = api_key or os.getenv('MY_DASHSCOPE_API_KEY', '')
        # åˆå§‹åŒ–æ–‡æœ¬åµŒå…¥æ¨¡å‹
        self.embeddings = DashScopeEmbeddings(
            dashscope_api_key=self.api_key, 
            model="text-embedding-v1"
        )
```

#### 2.3 åŠ è½½å‡½æ•° (`core/qa_system.py`)
```python
def load_qa_system(vector_db_path: str, api_key: str = "", memory_dir: str = None) -> QASystem:
    """
    åŠ è½½é—®ç­”ç³»ç»Ÿ
    """
    # åˆ›å»ºæ–‡æœ¬åµŒå…¥æ¨¡å‹
    embeddings = DashScopeEmbeddings(
        dashscope_api_key=api_key, 
        model="text-embedding-v1"
    )
    
    # åŠ è½½å‘é‡å­˜å‚¨
    vector_store = FAISS.load_local(
        vector_db_path, 
        embeddings, 
        allow_dangerous_deserialization=True
    )
```

---

## ğŸ–¼ï¸ 3. å¤šæ¨¡æ€åµŒå…¥æ¨¡å‹ (ONE-PEACE V1) - å›¾ç‰‡å‘é‡åŒ–

### ğŸ“ ä¸»è¦é…ç½®æ–‡ä»¶
- **`document_processing/image_processor.py`** - å›¾ç‰‡å¤„ç†å™¨

### ğŸ”§ é…ç½®ä»£ç 

#### 3.1 å›¾ç‰‡å¤„ç†å™¨ (`document_processing/image_processor.py`)
```python
# å¯¼å…¥æ¨¡å—
import dashscope
from dashscope import MultiModalEmbedding

class ImageProcessor:
    def __init__(self, api_key: str):
        """
        åˆå§‹åŒ–å›¾ç‰‡å¤„ç†å™¨
        :param api_key: DashScope APIå¯†é’¥
        """
        dashscope.api_key = api_key
    
    def generate_image_embedding(self, image_path: str = None, image_url: str = None) -> List[float]:
        """
        ç”Ÿæˆå›¾ç‰‡embedding
        """
        # å‡†å¤‡è¾“å…¥æ•°æ®
        if image_path:
            # æœ¬åœ°å›¾ç‰‡è½¬base64
            image_base64 = self.encode_image_to_base64(image_path)
            input_data = [{"image": image_base64}]
        elif image_url:
            # ç½‘ç»œå›¾ç‰‡
            input_data = [{"image": image_url}]
        else:
            raise ValueError("å¿…é¡»æä¾›image_pathæˆ–image_url")
        
        # è°ƒç”¨ONE-PEACEæ¨¡å‹
        result = MultiModalEmbedding.call(
            model=MultiModalEmbedding.Models.multimodal_embedding_one_peace_v1,
            input=input_data,
            auto_truncation=True
        )
        
        if result.status_code == 200:
            return result.output["embedding"]
        else:
            raise Exception(f"ONE-PEACEæ¨¡å‹è°ƒç”¨å¤±è´¥: {result}")
```

---

## âš™ï¸ 4. ç»Ÿä¸€é…ç½®ç®¡ç†

### ğŸ“ é…ç½®æ–‡ä»¶
- **`config/settings.py`** - ç»Ÿä¸€è®¾ç½®ç±»

### ğŸ”§ é…ç½®ä»£ç 

#### 4.1 ç»Ÿä¸€è®¾ç½®ç±» (`config/settings.py`)
```python
@dataclass
class Settings:
    """
    ç»Ÿä¸€è®¾ç½®ç±»ï¼Œç®¡ç†æ‰€æœ‰é…ç½®é¡¹
    """
    # APIé…ç½®
    dashscope_api_key: str = field(
        default_factory=lambda: os.getenv('MY_DASHSCOPE_API_KEY', '')
    )
    
    # é—®ç­”ç³»ç»Ÿé…ç½®
    model_name: str = 'qwen-turbo'
    temperature: float = 0.7
    max_tokens: int = 2000
    
    # å‘é‡å­˜å‚¨é…ç½®
    vector_dimension: int = 1536
    similarity_top_k: int = 5
    
    def to_dict(self) -> Dict[str, Any]:
        """
        è½¬æ¢ä¸ºå­—å…¸
        """
        return {
            'api': {
                'dashscope_api_key': self.dashscope_api_key,
            },
            'qa_system': {
                'model_name': self.model_name,
                'temperature': self.temperature,
                'max_tokens': self.max_tokens
            },
            'vector_store': {
                'vector_dimension': self.vector_dimension,
                'similarity_top_k': self.similarity_top_k
            }
        }
```

---

## ğŸ“Š 5. æ¨¡å‹ä½¿ç”¨åœºæ™¯æ€»ç»“

| æ¨¡å‹ç±»å‹ | æ¨¡å‹åç§° | é…ç½®æ–‡ä»¶ | ä¸»è¦åŠŸèƒ½ | è°ƒç”¨æ–¹å¼ |
|---------|---------|---------|---------|---------|
| **LLM** | `qwen-turbo` | `core/qa_system.py` | é—®ç­”ç”Ÿæˆ | `Tongyi(model_name="qwen-turbo")` |
| **æ–‡æœ¬åµŒå…¥** | `text-embedding-v1` | `document_processing/vector_generator.py` | æ–‡æœ¬å‘é‡åŒ– | `DashScopeEmbeddings(model="text-embedding-v1")` |
| **å¤šæ¨¡æ€åµŒå…¥** | `multimodal_embedding_one_peace_v1` | `document_processing/image_processor.py` | å›¾ç‰‡å‘é‡åŒ– | `MultiModalEmbedding.Models.multimodal_embedding_one_peace_v1` |

---

## ğŸ”„ 6. æ¨¡å‹è°ƒç”¨æµç¨‹

### 6.1 æ–‡æœ¬å¤„ç†æµç¨‹
```
æ–‡æ¡£è¾“å…¥ â†’ æ–‡æœ¬åµŒå…¥æ¨¡å‹ â†’ å‘é‡å­˜å‚¨ â†’ æ£€ç´¢ â†’ é€šä¹‰åƒé—® â†’ ç”Ÿæˆå›ç­”
```

### 6.2 å›¾ç‰‡å¤„ç†æµç¨‹
```
å›¾ç‰‡è¾“å…¥ â†’ å¤šæ¨¡æ€åµŒå…¥æ¨¡å‹ â†’ å‘é‡å­˜å‚¨ â†’ æ£€ç´¢ â†’ é€šä¹‰åƒé—® â†’ ç”Ÿæˆå›ç­”
```

### 6.3 ç»Ÿä¸€å¤„ç†æµç¨‹
```
ç”¨æˆ·é—®é¢˜ â†’ åˆ¤æ–­ç±»å‹ â†’ é€‰æ‹©æ¨¡å‹ â†’ å‘é‡æ£€ç´¢ â†’ é€šä¹‰åƒé—® â†’ ç”Ÿæˆå›ç­”
```

---

## ğŸ’¡ 7. é…ç½®è¦ç‚¹

### 7.1 APIå¯†é’¥ç®¡ç†
- æ‰€æœ‰æ¨¡å‹éƒ½ä½¿ç”¨åŒä¸€ä¸ªDashScope APIå¯†é’¥
- é€šè¿‡ç¯å¢ƒå˜é‡ `MY_DASHSCOPE_API_KEY` ç®¡ç†
- åœ¨ `config/settings.py` ä¸­ç»Ÿä¸€é…ç½®

### 7.2 æ¨¡å‹å‚æ•°
- **qwen-turbo**: temperature=0.7, max_tokens=2000
- **text-embedding-v1**: å‘é‡ç»´åº¦1536
- **multimodal_embedding_one_peace_v1**: æ”¯æŒå›¾ç‰‡å’Œæ–‡æœ¬

### 7.3 é”™è¯¯å¤„ç†
- æ‰€æœ‰æ¨¡å‹è°ƒç”¨éƒ½åŒ…å«é‡è¯•æœºåˆ¶
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•
- ä¼˜é›…çš„å¼‚å¸¸å¤„ç†

---

## ğŸ“ 8. ä½¿ç”¨ç¤ºä¾‹

### 8.1 åˆå§‹åŒ–é—®ç­”ç³»ç»Ÿ
```python
# åŠ è½½é…ç½®
from config.settings import Settings
settings = Settings()

# åˆå§‹åŒ–é—®ç­”ç³»ç»Ÿ
qa_system = QASystem(
    vector_store=vector_store,
    api_key=settings.dashscope_api_key
)
```

### 8.2 å¤„ç†æ–‡æ¡£
```python
# åˆå§‹åŒ–å‘é‡ç”Ÿæˆå™¨
vector_generator = VectorGenerator(config)

# åˆ›å»ºå‘é‡å­˜å‚¨
vector_store = vector_generator.create_vector_store(
    documents=documents,
    save_path="vector_db_test"
)
```

### 8.3 å¤„ç†å›¾ç‰‡
```python
# åˆå§‹åŒ–å›¾ç‰‡å¤„ç†å™¨
image_processor = ImageProcessor(api_key)

# ç”Ÿæˆå›¾ç‰‡å‘é‡
embedding = image_processor.generate_image_embedding(
    image_path="path/to/image.jpg"
)
```

---

*å¤§æ¨¡å‹é…ç½®ä»£ç æ€»ç»“ - ç‰ˆæœ¬ 1.0*
*æœ€åæ›´æ–°: 2024å¹´7æœˆ29æ—¥* 