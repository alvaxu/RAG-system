[toc]
# 数据库准备
## 0. 创建表空间

```sql
客户端: sqlplus sys/0406Move@FREE as sysdba
服务器端： sqlplus / as sysdba
-- 连接到PDB
ALTER SESSION SET CONTAINER=FREEPDB1;

CREATE TABLESPACE testdbspace
DATAFILE '/opt/oracle/oradata/FREE/test01.dbf'
SIZE 100M
AUTOEXTEND ON
NEXT 10M
MAXSIZE UNLIMITED
EXTENT MANAGEMENT LOCAL
SEGMENT SPACE MANAGEMENT AUTO;
```

```sql
SELECT tablespace_name, status, contents 
FROM dba_tablespaces 
WHERE tablespace_name = 'TESTDBSPACE';
```



## 1. 创建用户并指定默认表空间

```sql
CREATE USER dbtest IDENTIFIED BY test
DEFAULT TABLESPACE testdbspace
TEMPORARY TABLESPACE temp
QUOTA UNLIMITED ON testdbspace;
```

请将"密码"替换为您想设置的实际密码。

## 2. 授予基本权限

sql

复制



```sql
-- 授予连接权限
GRANT CREATE SESSION TO dbtest;

-- 授予在表空间上创建表的权限
GRANT CREATE TABLE TO dbtest;

-- 授予创建序列的权限(可选)
GRANT CREATE SEQUENCE TO dbtest;

-- 授予创建视图的权限(可选)
GRANT CREATE VIEW TO dbtest;

-- 授予创建过程的权限(可选)
GRANT CREATE PROCEDURE TO dbtest;
```

## 3. 授予资源权限(可选，适合开发环境)

sql

复制



```sql
-- 授予资源角色(包含CREATE TABLE, CREATE SEQUENCE等权限)
GRANT RESOURCE TO dbtest;
```

## 4. 授予表空间配额(如果之前未设置)

sql

复制



```sql
-- 确保用户在testdbspace表空间上有足够的配额
ALTER USER dbtest QUOTA UNLIMITED ON testdbspace;
```

## 5. 验证用户权限

sql

复制



```sql
-- 检查用户默认表空间
SELECT username, default_tablespace, temporary_tablespace 
FROM dba_users 
WHERE username = 'DBTEST';

-- 检查用户表空间配额
SELECT tablespace_name, bytes/1024/1024 "USED(MB)", max_bytes/1024/1024 "MAX(MB)" 
FROM dba_ts_quotas 
WHERE username = 'DBTEST';

-- 检查用户系统权限
SELECT * FROM dba_sys_privs WHERE grantee = 'DBTEST';

-- 检查用户角色权限
SELECT * FROM dba_role_privs WHERE grantee = 'DBTEST';
```

## 6. dbtest连接数据库，创建对象
连接方式一：服务器端：
```sql
-- 使用dbtest用户登录
connect dbtest/密码
--- 或者重新用sqlplus 登录
sqlplus dbtest/密码
```
连接方式二：客户端，通过配置tnsnames.ora,再通过客户端sqlplus 连接
```sql
sqlplus dbtest/密码@FREEPDB1
```
连接方式三：安装客户端软件如DBeaver，通过它连接数据库

![image-20250428205210411](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20250428205210411.png)



# 创建电商业务表及对象

以下是一个简单的电商业务数据库，包含10个相关表，表之间有合理的关联关系。以下是完整的SQL建表语句和示例数据插入语句。

## 表结构设计

```sql
-- 1. 用户表
CREATE TABLE users (
    user_id NUMBER PRIMARY KEY,
    username VARCHAR2(50) NOT NULL,
    password VARCHAR2(100) NOT NULL,
    email VARCHAR2(100) UNIQUE NOT NULL,
    phone VARCHAR2(20),
    register_date DATE DEFAULT SYSDATE,
    status NUMBER(1) DEFAULT 1
);

-- 2. 用户地址表
CREATE TABLE user_addresses (
    address_id NUMBER PRIMARY KEY,
    user_id NUMBER NOT NULL,
    receiver_name VARCHAR2(50) NOT NULL,
    receiver_phone VARCHAR2(20) NOT NULL,
    province VARCHAR2(50) NOT NULL,
    city VARCHAR2(50) NOT NULL,
    district VARCHAR2(50) NOT NULL,
    detail_address VARCHAR2(200) NOT NULL,
    is_default NUMBER(1) DEFAULT 0,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);

-- 3. 商品分类表
CREATE TABLE product_categories (
    category_id NUMBER PRIMARY KEY,
    category_name VARCHAR2(50) NOT NULL,
    parent_id NUMBER,
    category_level NUMBER(1) NOT NULL,
    sort_order NUMBER DEFAULT 0,
    FOREIGN KEY (parent_id) REFERENCES product_categories(category_id)
);

-- 4. 商品表
CREATE TABLE products (
    product_id NUMBER PRIMARY KEY,
    category_id NUMBER NOT NULL,
    product_name VARCHAR2(100) NOT NULL,
    product_desc VARCHAR2(500),
    price NUMBER(10,2) NOT NULL,
    stock NUMBER NOT NULL,
    sales NUMBER DEFAULT 0,
    create_time DATE DEFAULT SYSDATE,
    update_time DATE DEFAULT SYSDATE,
    status NUMBER(1) DEFAULT 1,
    FOREIGN KEY (category_id) REFERENCES product_categories(category_id)
);

-- 5. 商品图片表
CREATE TABLE product_images (
    image_id NUMBER PRIMARY KEY,
    product_id NUMBER NOT NULL,
    image_url VARCHAR2(200) NOT NULL,
    sort_order NUMBER DEFAULT 0,
    FOREIGN KEY (product_id) REFERENCES products(product_id)
);

-- 6. 购物车表
CREATE TABLE shopping_cart (
    cart_id NUMBER PRIMARY KEY,
    user_id NUMBER NOT NULL,
    product_id NUMBER NOT NULL,
    quantity NUMBER NOT NULL,
    selected NUMBER(1) DEFAULT 1,
    create_time DATE DEFAULT SYSDATE,
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    FOREIGN KEY (product_id) REFERENCES products(product_id)
);

-- 7. 订单表
CREATE TABLE orders (
    order_id NUMBER PRIMARY KEY,
    order_no VARCHAR2(50) UNIQUE NOT NULL,
    user_id NUMBER NOT NULL,
    address_id NUMBER NOT NULL,
    total_amount NUMBER(10,2) NOT NULL,
    payment_amount NUMBER(10,2) NOT NULL,
    freight_amount NUMBER(10,2) DEFAULT 0,
    order_status NUMBER(1) DEFAULT 0,
    payment_time DATE,
    delivery_time DATE,
    receive_time DATE,
    create_time DATE DEFAULT SYSDATE,
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    FOREIGN KEY (address_id) REFERENCES user_addresses(address_id)
);

-- 8. 订单明细表
CREATE TABLE order_items (
    item_id NUMBER PRIMARY KEY,
    order_id NUMBER NOT NULL,
    product_id NUMBER NOT NULL,
    product_name VARCHAR2(100) NOT NULL,
    product_image VARCHAR2(200),
    price NUMBER(10,2) NOT NULL,
    quantity NUMBER NOT NULL,
    total_price NUMBER(10,2) NOT NULL,
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (product_id) REFERENCES products(product_id)
);

-- 9. 支付信息表
CREATE TABLE payment_info (
    payment_id NUMBER PRIMARY KEY,
    order_id NUMBER NOT NULL,
    payment_type NUMBER(1) NOT NULL,
    trade_no VARCHAR2(100),
    payment_amount NUMBER(10,2) NOT NULL,
    payment_status NUMBER(1) DEFAULT 0,
    create_time DATE DEFAULT SYSDATE,
    callback_time DATE,
    FOREIGN KEY (order_id) REFERENCES orders(order_id)
);

-- 10. 评价表
CREATE TABLE product_reviews (
    review_id NUMBER PRIMARY KEY,
    user_id NUMBER NOT NULL,
    product_id NUMBER NOT NULL,
    order_id NUMBER NOT NULL,
    rating NUMBER(1) NOT NULL,
    content VARCHAR2(500),
    review_time DATE DEFAULT SYSDATE,
    is_anonymous NUMBER(1) DEFAULT 0,
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    FOREIGN KEY (product_id) REFERENCES products(product_id),
    FOREIGN KEY (order_id) REFERENCES orders(order_id)
);
```

## 序列创建（用于自增主键,不建议使用）



```sql
-- 1. 用户表序列
CREATE SEQUENCE seq_users_id 
START WITH 1 
INCREMENT BY 1 
NOCACHE 
NOCYCLE;

-- 2. 用户地址表序列
CREATE SEQUENCE seq_addresses_id 
START WITH 1 
INCREMENT BY 1 
NOCACHE 
NOCYCLE;

-- 3. 商品分类表序列
CREATE SEQUENCE seq_categories_id 
START WITH 1 
INCREMENT BY 1 
NOCACHE 
NOCYCLE;

-- 4. 商品表序列
CREATE SEQUENCE seq_products_id 
START WITH 1 
INCREMENT BY 1 
NOCACHE 
NOCYCLE;

-- 5. 商品图片表序列
CREATE SEQUENCE seq_images_id 
START WITH 1 
INCREMENT BY 1 
NOCACHE 
NOCYCLE;

-- 6. 购物车表序列
CREATE SEQUENCE seq_cart_id 
START WITH 1 
INCREMENT BY 1 
NOCACHE 
NOCYCLE;

-- 7. 订单表序列
CREATE SEQUENCE seq_orders_id 
START WITH 1 
INCREMENT BY 1 
NOCACHE 
NOCYCLE;

-- 8. 订单明细表序列
CREATE SEQUENCE seq_items_id 
START WITH 1 
INCREMENT BY 1 
NOCACHE 
NOCYCLE;

-- 9. 支付信息表序列
CREATE SEQUENCE seq_payment_id 
START WITH 1 
INCREMENT BY 1 
NOCACHE 
NOCYCLE;

-- 10. 评价表序列
CREATE SEQUENCE seq_reviews_id 
START WITH 1 
INCREMENT BY 1 
NOCACHE 
NOCYCLE;
```

## 触发器创建脚本（不能用dbeaver执行，报:NEW 要绑定参数，用sqlplus 执行sql脚本）（不建议使用）

```sql
-- 1. 用户表触发器
CREATE OR REPLACE TRIGGER trg_users_id
BEFORE INSERT ON users
FOR EACH ROW
BEGIN
    IF :NEW.user_id IS NULL THEN
        SELECT seq_users_id.NEXTVAL INTO :NEW.user_id FROM dual;
    END IF;
END;
/

-- 2. 用户地址表触发器
CREATE OR REPLACE TRIGGER trg_addresses_id
BEFORE INSERT ON user_addresses
FOR EACH ROW
BEGIN
    IF :NEW.address_id IS NULL THEN
        SELECT seq_addresses_id.NEXTVAL INTO :NEW.address_id FROM dual;
    END IF;
END;
/

-- 3. 商品分类表触发器
CREATE OR REPLACE TRIGGER trg_categories_id
BEFORE INSERT ON product_categories
FOR EACH ROW
BEGIN
    IF :NEW.category_id IS NULL THEN
        SELECT seq_categories_id.NEXTVAL INTO :NEW.category_id FROM dual;
    END IF;
END;
/

-- 4. 商品表触发器
CREATE OR REPLACE TRIGGER trg_products_id
BEFORE INSERT ON products
FOR EACH ROW
BEGIN
    IF :NEW.product_id IS NULL THEN
        SELECT seq_products_id.NEXTVAL INTO :NEW.product_id FROM dual;
    END IF;
END;
/

-- 5. 商品图片表触发器
CREATE OR REPLACE TRIGGER trg_images_id
BEFORE INSERT ON product_images
FOR EACH ROW
BEGIN
    IF :NEW.image_id IS NULL THEN
        SELECT seq_images_id.NEXTVAL INTO :NEW.image_id FROM dual;
    END IF;
END;
/

-- 6. 购物车表触发器
CREATE OR REPLACE TRIGGER trg_cart_id
BEFORE INSERT ON shopping_cart
FOR EACH ROW
BEGIN
    IF :NEW.cart_id IS NULL THEN
        SELECT seq_cart_id.NEXTVAL INTO :NEW.cart_id FROM dual;
    END IF;
END;
/

-- 7. 订单表触发器
CREATE OR REPLACE TRIGGER trg_orders_id
BEFORE INSERT ON orders
FOR EACH ROW
BEGIN
    IF :NEW.order_id IS NULL THEN
        SELECT seq_orders_id.NEXTVAL INTO :NEW.order_id FROM dual;
    END IF;
END;
/

-- 8. 订单明细表触发器
CREATE OR REPLACE TRIGGER trg_items_id
BEFORE INSERT ON order_items
FOR EACH ROW
BEGIN
    IF :NEW.item_id IS NULL THEN
        SELECT seq_items_id.NEXTVAL INTO :NEW.item_id FROM dual;
    END IF;
END;
/

-- 9. 支付信息表触发器
CREATE OR REPLACE TRIGGER trg_payment_id
BEFORE INSERT ON payment_info
FOR EACH ROW
BEGIN
    IF :NEW.payment_id IS NULL THEN
        SELECT seq_payment_id.NEXTVAL INTO :NEW.payment_id FROM dual;
    END IF;
END;
/

-- 10. 评价表触发器
CREATE OR REPLACE TRIGGER trg_reviews_id
BEFORE INSERT ON product_reviews
FOR EACH ROW
BEGIN
    IF :NEW.review_id IS NULL THEN
        SELECT seq_reviews_id.NEXTVAL INTO :NEW.review_id FROM dual;
    END IF;
END;
/
```

## 触发器增强版（包含创建时间自动更新）

如果你想在触发器中同时处理创建时间和更新时间，可以使用以下增强版触发器：

```sql
-- 商品表增强版触发器（示例）
CREATE OR REPLACE TRIGGER trg_products_enhanced
BEFORE INSERT OR UPDATE ON products
FOR EACH ROW
BEGIN
    -- 处理主键ID
    IF :NEW.product_id IS NULL THEN
        SELECT seq_products_id.NEXTVAL INTO :NEW.product_id FROM dual;
    END IF;
    
    -- 处理时间戳
    IF INSERTING THEN
        :NEW.create_time := SYSDATE;
        :NEW.update_time := SYSDATE;
    ELSIF UPDATING THEN
        :NEW.update_time := SYSDATE;
    END IF;
END;
/

-- 订单表增强版触发器
CREATE OR REPLACE TRIGGER trg_orders_enhanced
BEFORE INSERT OR UPDATE ON orders
FOR EACH ROW
BEGIN
    -- 处理主键ID
    IF :NEW.order_id IS NULL THEN
        SELECT seq_orders_id.NEXTVAL INTO :NEW.order_id FROM dual;
    END IF;
    
    -- 处理时间戳
    IF INSERTING THEN
        :NEW.create_time := SYSDATE;
    END IF;
END;
/
```





# 不用触发器和序列的导入

参见insertlarge.sql


## 表关系说明

1. **用户系统**：
   - `users` 表与 `user_addresses` 表是一对多关系
   - `users` 表与 `shopping_cart`、`orders`、`product_reviews` 都是一对多关系

2. **商品系统**：
   - `product_categories` 表是自引用表，表示分类层级
   - `products` 表与 `product_categories` 是多对一关系
   - `products` 表与 `product_images` 是一对多关系

3. **订单系统**：
   - `orders` 表与 `order_items` 是一对多关系
   - `orders` 表与 `payment_info` 是一对一关系
   - `orders` 表与 `product_reviews` 是一对多关系




这个数据库设计涵盖了电商系统的主要业务流程，包括用户管理、商品管理、购物车、订单管理、支付和评价等模块。你可以基于这个数据库进行各种SQL查询练习，如：

- 查询某个用户的所有订单
- 统计各类商品的销量
- 查询高评价商品
- 分析用户购买行为
- 计算销售额统计等



