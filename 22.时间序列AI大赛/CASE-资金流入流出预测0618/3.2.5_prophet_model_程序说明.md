# 3.2.5_prophet_model.py 程序说明书

## 一、程序功能与流程概述
本程序基于Prophet模型对余额宝每日申购与赎回总额进行时间序列建模与预测，支持节假日、调休、周期等多种特征，输出9月预测结果及多种可视化分析。

## 二、特征工程
- **数据聚合**：将原始用户明细表按日期聚合为每日申购/赎回总额。
- **节假日特征**：利用`chinese_calendar`库自动生成2014-03-01至2014-09-30的法定节假日、调休补班日。
- **周期特征**：包括星期（weekday）、月内分段（begin/middle/end）、是否下一个工作日（is_next_workday）等。
- **特征输出**：所有特征均输出为csv，便于复用和分析。

## 三、模型选择与参数
- **模型类型**：Facebook Prophet（适合强周期、强节假日效应的金融时序数据）。
- **参数设置**：
  - yearly_seasonality=False，weekly_seasonality=True，daily_seasonality=False
  - changepoint_prior_scale=0.10（申购）/0.05（赎回）
  - seasonality_prior_scale=10.0（申购）/15.0（赎回）
  - holidays_prior_scale=5.0
  - seasonality_mode='additive'
  - changepoint_range=0.8，n_changepoints=25/20
  - 增加自定义月度季节性（月周期）
- **节假日表**：作为holidays参数传入，提升模型对假期扰动的拟合能力。

## 四、训练与预测流程
- 训练区间：2014-03-01 ~ 2014-08-31
- 预测区间：2014-09-01 ~ 2014-09-30
- 训练流程：分别对申购、赎回序列建模，拟合历史数据。
- 预测流程：对全区间（含9月）生成预测，输出in-sample与未来区间预测。
- 可视化：输出真实值、in-sample预测、9月预测对比图及分解图、残差分析图。

## 五、输入输出文件与格式
- 输入：
  - user_balance_table.csv（原始明细数据）
- 输出：
  - 3.2.5_feature_output/3.2.5_prophet_purchase.csv、3.2.5_prophet_redeem.csv（聚合后序列）
  - 3.2.5_feature_output/3.2.5_prophet_daily_features.csv、3.2.5_prophet_holidays.csv（特征工程结果）
  - 3.2.5_prophet_output/3.2.5_prophet_predict.csv（9月预测结果，竞赛格式）
  - 3.2.5_prophet_output/3.2.5_prophet_purchase_redeem_compare.png（对比图）
  - 3.2.5_prophet_output/3.2.5_prophet_purchase_components.png、3.2.5_prophet_output/3.2.5_prophet_redeem_components.png（分解图）
  - 3.2.5_prophet_output/3.2.5_prophet_purchase_residuals.png、3.2.5_prophet_output/3.2.5_prophet_redeem_residuals.png（残差分析）

## 六、适用场景与局限性
- 适用于有明显周期性、节假日效应的金融时序预测。
- 对突发性、结构性变化（如政策、活动）拟合有限。
- 仅基于全局序列，无法建模用户级异质性。 


以下是对 `3.2.5_prophet_model(122).py` 中特征工程利用情况的详细分析：

---

## 1. 特征工程部分的内容

在本代码中，特征工程主要体现在以下几个方面：

1. **节假日与调休补班日特征**  
   - 通过 `chinese_calendar` 库，生成了 2014-03-01 到 2014-09-30 期间的节假日（`official_holiday`）和调休补班日（`workday_shift`），并保存为 `holiday_df`。
   - 这些日期被用于 Prophet 的 `holidays` 参数，作为模型的假期输入。

2. **是否节假日、是否调休补班日特征**  
   - 在 `daily` 数据中，增加了 `is_holiday` 和 `is_workday_shift` 两个二元特征，分别表示当天是否为节假日、是否为调休补班日。

3. **是否节后首个工作日特征**  
   - 增加了 `is_next_workday` 特征，表示是否为节假日后的第一个工作日。

4. **月内分段特征**  
   - 通过 `month_period` 函数，将每月分为“上旬(begin)”“中旬(middle)”“下旬(end)”，并作为 `month_period` 特征。

5. **星期几特征**  
   - 增加了 `weekday` 特征，表示星期几（0-6）。

---

## 2. 这些特征在 Prophet 建模中的使用情况

### 实际被 Prophet 模型直接利用的特征

- **节假日与调休补班日**  
  通过 `holidays=holidays` 参数，Prophet 会自动将 `holiday_df` 中的节假日和调休补班日作为假期效应建模（即 `official_holiday` 和 `workday_shift` 作为假期变量，影响预测结果）。

- **自定义季节性**  
  代码中通过 `add_seasonality(name='monthly', period=30.5, fourier_order=5)` 显式添加了“月度”季节性，这可以部分捕捉月内分段的周期性变化（但并未直接用 `month_period` 字段）。

### 没有被 Prophet 直接利用的特征

- `is_holiday`、`is_workday_shift`、`is_next_workday`、`month_period`、`weekday` 这些特征虽然被生成并保存到了特征文件（如 `3.2.5_prophet_daily_features.csv`），但**并未作为回归器（regressor）或额外变量**被 Prophet 模型直接引用。  
- Prophet 支持通过 `add_regressor` 方法添加自定义特征，但本代码未使用该功能。

---

## 3. 结论与建议

- **充分利用的特征**：  
  目前，代码中**只充分利用了节假日和调休补班日**（通过 Prophet 的 `holidays` 参数），以及月度季节性（通过 `add_seasonality`）。
- **未被利用的特征**：  
  其他如 `is_holiday`、`is_workday_shift`、`is_next_workday`、`month_period`、`weekday` 等特征，**仅被生成和保存，并未被 Prophet 直接用作建模特征**。
- **如何进一步利用**：  
  如果希望更充分地利用这些特征，可以通过 Prophet 的 `add_regressor` 方法，将这些特征作为外生变量加入模型，从而提升模型对特殊日期、周期性等的拟合能力。

---

### 总结

- **当前代码只利用了节假日/调休补班日特征和月度季节性**，其余特征未被 Prophet 直接用作建模输入。
- **如需更充分利用特征工程成果，建议将相关特征通过 `add_regressor` 加入 Prophet 模型。**

---

如需示例代码或进一步优化建议，请告知！