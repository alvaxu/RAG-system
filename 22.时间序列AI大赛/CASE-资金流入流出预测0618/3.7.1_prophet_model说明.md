# 3.7.1_prophet_model.py 程序说明文档

## 一、程序功能与适用场景

本程序基于Prophet模型对余额宝申购/赎回数据进行时间序列建模与预测，适用于金融类日度流量预测、节假日效应分析等场景。与3.7_prophet_model.py相比，本版本**不考虑年周期性，仅考虑月周期性和周周期性**，并且**节假日与调休全部手工显式指定**，适合对节假日定义有特殊要求、需完全复现的业务。

## 二、输入输出说明

- **输入数据**：`user_balance_table.csv`，包含每日申购、赎回金额。
- **输出目录**：`3.7.1_prophet_output/`、`3.7.1_feature_output/`
- **主要输出文件**：
  - `3.7.1_prophet_predict.csv`：9月预测结果（竞赛格式）
  - `3.7.1_prophet_best_params.txt`：申购/赎回最优参数及RMSE
  - `3.7.1_prophet_purchase_redeem_compare.png`：申购/赎回真实值与预测对比图
  - `3.7.1_prophet_purchase_components.png`、`3.7.1_prophet_redeem_components.png`：分解图
  - `3.7.1_prophet_purchase_residuals.png`、`3.7.1_prophet_redeem_residuals.png`：残差分析图
  - `3.7.1_prophet_daily_features.csv`、`3.7.1_prophet_holidays.csv`：特征与节假日明细

## 三、特征工程细节与意义

1. **基础特征**：
   - `ds`：日期
   - `y`：申购/赎回金额
2. **节假日与调休手工定义**：
   - 明确列出2014年3月1日-10月10日所有法定节假日、连续放假日期、正常周末（周六/周日）为节假日。
   - 明确列出调休补班的周末（如2014年5月4日、9月28日、10月11日、10月12日）为工作日，不算节假日。
   - 生成`official_holiday`和`workday_shift`两类节假日标签，全部显式写入，无需chinese_calendar。
3. **衍生特征**：
   - `is_holiday`：是否法定节假日/周末
   - `is_workday_shift`：是否调休补班
   - `is_next_workday`：假期后首个工作日
   - `weekday`：星期几
   - `month_period`：月初/中/末

**意义**：
- 手工定义节假日和调休，保证节假日逻辑完全可控、可复现。
- 节假日特征帮助模型捕捉假期对资金流的影响。
- `is_next_workday`等衍生特征可辅助分析节后效应。
- 仅保留月季节性和周季节性，突出月内和周内节奏及假期影响。

## 四、Prophet模型参数选择、作用与意义

- **yearly_seasonality=False**：不使用Prophet自带年季节性。
- **weekly_seasonality=True**：保留周内波动。
- **daily_seasonality=False**：不建模日内噪声。
- **add_seasonality('monthly', period=30.5, fourier_order=5)**：手动添加月季节性。
- **自动调参参数**：
  - `changepoint_prior_scale`：趋势变化点灵敏度
  - `seasonality_prior_scale`：季节性强度
  - `holidays_prior_scale`：节假日效应强度
  - `seasonality_mode`：加法/乘法季节性

**最优参数**：
申购最优参数: {'changepoint_prior_scale': 0.01, 'seasonality_prior_scale': 10.0, 'holidays_prior_scale': 20.0, 'seasonality_mode': 'multiplicative'}, 最优验证集RMSE: 56287319.47
赎回最优参数: {'changepoint_prior_scale': 0.01, 'seasonality_prior_scale': 20.0, 'holidays_prior_scale': 1.0, 'seasonality_mode': 'additive'}, 最优验证集RMSE: 60216807.95

## 五、自动调优策略与结果

- 采用网格搜索遍历主参数组合，使用Prophet官方`cross_validation`接口，验证集RMSE最优参数自动选取。
- 输出最优参数、RMSE、分解图、残差图，便于复现和对比。
- 申购/赎回分别独立调优。
- 验证集RMSE：申购 56287319.47，赎回 60216807.95
- 结果与3.2.1_prophet_model yearly_f.py一致，成绩应为：104.3057

## 六、进一步调优与改进建议

- **节假日定义**：可尝试更细致的节假日策略（如只用法定节假日/只用周末/引入节前节后等）。
- **外部变量**：如引入宏观经济、利率、用户行为等外部特征。
- **季节性结构**：可尝试重新引入年季节性，或用自定义周期。
- **模型融合**：与SARIMA、LSTM等模型集成。
- **残差分析**：对残差序列进一步建模，捕捉未解释部分。

## 七、运行注意事项

- 需安装`prophet`等依赖。
- Windows下多进程需用`if __name__ == '__main__':`保护主流程。
- 日志已屏蔽冗余输出，仅保留关键信息。
- 节假日和调休补班日如需调整，直接修改脚本内相关列表即可。

---
如需进一步调优或复现，请参考本说明文档及脚本注释。 