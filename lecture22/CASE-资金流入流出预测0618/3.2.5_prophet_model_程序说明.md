# 3.2.5_prophet_model.py 程序说明书

## 一、程序功能与流程概述
本程序基于Prophet模型对余额宝每日申购与赎回总额进行时间序列建模与预测，支持节假日、调休、周期等多种特征，输出9月预测结果及多种可视化分析。

## 二、特征工程
- **数据聚合**：将原始用户明细表按日期聚合为每日申购/赎回总额。
- **节假日特征**：利用`chinese_calendar`库自动生成2014-03-01至2014-09-30的法定节假日、调休补班日。
- **周期特征**：包括星期（weekday）、月内分段（begin/middle/end）、是否下一个工作日（is_next_workday）等。
- **特征输出**：所有特征均输出为csv，便于复用和分析。

## 三、模型选择与参数
- **模型类型**：Facebook Prophet（适合强周期、强节假日效应的金融时序数据）。
- **参数设置**：
  - yearly_seasonality=False，weekly_seasonality=True，daily_seasonality=False
  - changepoint_prior_scale=0.10（申购）/0.05（赎回）
  - seasonality_prior_scale=10.0（申购）/15.0（赎回）
  - holidays_prior_scale=5.0
  - seasonality_mode='additive'
  - changepoint_range=0.8，n_changepoints=25/20
  - 增加自定义月度季节性（月周期）
- **节假日表**：作为holidays参数传入，提升模型对假期扰动的拟合能力。

## 四、训练与预测流程
- 训练区间：2014-03-01 ~ 2014-08-31
- 预测区间：2014-09-01 ~ 2014-09-30
- 训练流程：分别对申购、赎回序列建模，拟合历史数据。
- 预测流程：对全区间（含9月）生成预测，输出in-sample与未来区间预测。
- 可视化：输出真实值、in-sample预测、9月预测对比图及分解图、残差分析图。

## 五、输入输出文件与格式
- 输入：
  - user_balance_table.csv（原始明细数据）
- 输出：
  - 3.2.5_feature_output/3.2.5_prophet_purchase.csv、3.2.5_prophet_redeem.csv（聚合后序列）
  - 3.2.5_feature_output/3.2.5_prophet_daily_features.csv、3.2.5_prophet_holidays.csv（特征工程结果）
  - 3.2.5_prophet_output/3.2.5_prophet_predict.csv（9月预测结果，竞赛格式）
  - 3.2.5_prophet_output/3.2.5_prophet_purchase_redeem_compare.png（对比图）
  - 3.2.5_prophet_output/3.2.5_prophet_purchase_components.png、3.2.5_prophet_output/3.2.5_prophet_redeem_components.png（分解图）
  - 3.2.5_prophet_output/3.2.5_prophet_purchase_residuals.png、3.2.5_prophet_output/3.2.5_prophet_redeem_residuals.png（残差分析）

## 六、适用场景与局限性
- 适用于有明显周期性、节假日效应的金融时序预测。
- 对突发性、结构性变化（如政策、活动）拟合有限。
- 仅基于全局序列，无法建模用户级异质性。 