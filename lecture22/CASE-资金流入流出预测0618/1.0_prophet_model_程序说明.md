# 1.0 Prophet建模流程与程序说明

---

## 一、1.0_feature_engine.py 说明

### 主要功能
- 读取原始用户申购赎回流水数据（user_balance_table.csv），聚合为每日申购/赎回总额。
- 生成Prophet建模所需的输入格式（ds, y）。
- 自动生成2013-07-01至2014-09-30的中国法定节假日和调休补班日特征。
- 添加周几、月初/中/末等时间特征。
- 新增"是否节假日""是否调休补班日"二值特征。

### 输入
- user_balance_table.csv

### 输出
- 1.0_feature_output/1.0_prophet_purchase.csv（申购序列，ds, y）
- 1.0_feature_output/1.0_prophet_redeem.csv（赎回序列，ds, y）
- 1.0_feature_output/1.0_prophet_holidays.csv（节假日与调休补班日特征）
- 1.0_feature_output/1.0_prophet_daily_features.csv（包含所有时间特征的每日数据）

### 主要流程
1. 数据读取与日期格式转换
2. 按天聚合申购/赎回总额
3. 生成Prophet输入格式
4. 自动识别节假日、调休补班日，生成假日特征表
5. 生成二值特征（是否节假日/调休补班日）、周几、月初/中/末
6. 保存所有特征到csv

### 注意事项
- 节假日和调休补班日特征依赖chinese_calendar库，需提前安装。
- 输出的特征表为后续Prophet建模直接使用。

---

## 二、1.0_prophet_model.py 说明

### 主要功能
- 读取特征工程输出的序列和假日特征。
- 以2014-03-01及以后为训练集，2014-08为验证集，2014-09为预测区间。
- 分别对申购和赎回序列建模，添加节假日、周季节性、月季节性。
- 输出预测结果为竞赛要求格式。
- 输出关键可视化图（趋势、分解、历史对比等）。

### 输入
- 1.0_feature_output/1.0_prophet_purchase.csv
- 1.0_feature_output/1.0_prophet_redeem.csv
- 1.0_feature_output/1.0_prophet_holidays.csv
- 1.0_feature_output/1.0_prophet_daily_features.csv

### 输出
- 1.0_prophet_output/1.0_prophet_predict.csv（无表头，report_date,purchase,redeem）
- 1.0_prophet_output/1.0_prophet_purchase_compare.png（申购历史与预测对比）
- 1.0_prophet_output/1.0_prophet_redeem_compare.png（赎回历史与预测对比）
- 1.0_prophet_output/1.0_prophet_purchase_trend.png、components.png（申购趋势与分解）
- 1.0_prophet_output/1.0_prophet_redeem_trend.png、components.png（赎回趋势与分解）

### 主要流程
1. 读取特征工程输出
2. 训练集、验证集、预测区间划分
3. Prophet建模（添加节假日、周/月季节性）
4. 未来区间预测，输出结果
5. 可视化历史与预测对比、趋势分解

### 注意事项
- Prophet假日特征已区分节假日和调休补班日。
- 预测结果需四舍五入为整数，单位为"分"。
- 输出文件无表头，严格按竞赛格式。

---

## 三、成绩低（42.7750分）的原因分析

### 1. 数据与特征层面
- **历史数据分布与预测区间差异大**：2013年下半年至2014年初资金流动极不稳定，2014年3月后趋于平稳，模型可能未能充分捕捉结构性变化。
- **未引入收益率、利率等外部特征**：仅用时间和假日特征，未考虑收益率、利率等对资金流动的影响。
- **节假日/调休特征未做更细致处理**：如节前/节后效应、长假堆积释放等未显式建模。
- **未分用户群体/未分层建模**：高活跃用户与低活跃用户行为差异大，未做分层。

### 2. Prophet模型层面
- **Prophet对极端异常点敏感**：历史极端高点未做平滑或剔除，影响趋势拟合。
- **参数未充分调优**：changepoint_prior_scale等参数未做系统调参，可能导致过拟合或欠拟合。
- **未引入自定义regressor**：如"是否节假日""是否调休补班日"二值特征未作为regressor显式引入。
- **未做节前/节后N天特征**：资金堆积/释放效应未被模型捕捉。

### 3. 业务层面
- **节假日、调休政策对资金流动影响复杂**，仅靠Prophet假日特征难以完全拟合。
- **预测区间（2014-09）可能有特殊业务活动或外部冲击，模型未能感知。

---

## 四、后续改进建议

1. **引入外部特征**：如余额宝收益率、Shibor利率等，作为regressor输入Prophet。
2. **节前/节后N天特征**：显式建模节前/节后资金流动堆积/释放效应。
3. **异常点处理**：对极端高点做平滑或剔除，提升趋势拟合能力。
4. **参数调优**：系统调参（changepoint_prior_scale、seasonality等），可用交叉验证。
5. **分层建模**：对高活跃用户、低活跃用户分群建模，或对不同资金量区间分段建模。
6. **模型融合**：Prophet与回归、集成模型（如LightGBM）融合，提升鲁棒性。
7. **业务规则特征**：如节假日资金确认/到账规则、节前/节后高峰等，转化为特征输入。

---

> 当前方案为时间序列建模的基础版本，建议结合业务理解和更多特征工程，持续优化模型表现。 