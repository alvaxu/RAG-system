# Prophet时间序列建模整体思路

---

## 1. 数据准备

- 读取user_balance_table.csv，聚合得到每日申购总额（total_purchase_amt）和赎回总额（total_redeem_amt）。
- 日期字段（report_date）需转换为标准日期格式。
- 可选：剔除异常日期或极端异常值（如金额为0或极大值的日期）。
- 目标：构建两个时间序列（申购、赎回），分别建模。

## 2. 特征工程

- Prophet核心输入为两列：
  - ds：日期（datetime类型）
  - y：目标值（如申购总额/赎回总额）
- 可选外部回归特征（添加regressor）：
  - 余额宝收益率（mfd_day_share_interest.csv）：如mfd_daily_yield、mfd_7daily_yield
  - Shibor利率（mfd_bank_shibor.csv）：如Interest_O_N等
  - 节假日、周几、月初/中/末等（Prophet支持内置节假日）
- 特征处理：
  - 对金额型字段可做对数变换（如log1p），缓解极端值影响
  - 缺失值填充（如收益率、利率等外部特征）
  - 外部特征需与主序列按日期对齐

## 3. Prophet建模

- 分别对申购、赎回序列建模（可分别建两个Prophet模型）
- Prophet参数设置：
  - 年、月、周季节性（可根据数据量和周期性调整）
  - 添加节假日（如中国法定节假日，可用Prophet内置或自定义）
  - 添加外部回归特征（regressor）
- 拟合历史数据，检验残差分布和拟合效果

## 4. 参数调优与模型验证

- 可采用滑动窗口/时间序列交叉验证，评估模型在历史区间的预测能力
- 主要调优参数：changepoint_prior_scale、seasonality_prior_scale、holidays_prior_scale等
- 评估指标：与竞赛一致的相对误差、RMSE、MAE等
- 检查模型对节假日、收益率、利率等外部特征的敏感性

## 5. 未来区间预测

- 生成2014-09-01至2014-09-30的未来日期（30天）
- 若使用外部特征，需为未来区间准备相应的特征值（如收益率、利率可用最近值或预测值填充）
- 使用Prophet模型进行未来区间预测，分别输出申购和赎回预测值

## 6. 结果输出与保存

- 预测结果格式：
  - report_date,purchase,redeem（无表头，日期为YYYYMMDD，金额为整数，单位分）
- 将预测结果保存为tc_comp_predict_table或comp_predict_table.csv
- 可视化预测结果与历史趋势对比，辅助分析

## 7. 其他注意事项

- Prophet对异常值较敏感，建议对极端异常点做处理
- 外部特征的引入需检验其有效性，避免引入噪声
- 节假日效应可显著提升模型对特殊日期的拟合能力
- 可多次实验不同特征组合和参数，选取最优方案

---

> 按照上述思路，建议先实现基础Prophet建模流程，再逐步引入外部特征和节假日，最后优化参数与输出格式。 