<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>医院床位使用情况可视化大屏</title>
    <!-- <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script> -->
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #0a1929;
            color: #fff;
        }
        
        .header {
            text-align: center;
            padding: 20px;
            background-color: #0c2135;
            border-bottom: 2px solid #1a365d;
        }
        
        .header h1 {
            margin: 0;
            font-size: 32px;
            color: #4fd0e7;
        }
        
        .container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-gap: 20px;
            padding: 20px;
        }
        
        .card {
            background-color: #0c2135;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid #1a365d;
        }
        
        .metric-card {
            grid-column: span 1;
            text-align: center;
        }
        
        .chart-card {
            grid-column: span 2;
            height: 400px;
        }
        
        .full-width-card {
            grid-column: span 4;
            height: 500px;
        }
        
        .metric-value {
            font-size: 36px;
            font-weight: bold;
            color: #4fd0e7;
            margin: 10px 0;
        }
        
        .metric-label {
            font-size: 16px;
            color: #a0aec0;
        }
        
        .chart-title {
            font-size: 20px;
            margin-bottom: 15px;
            color: #e2e8f0;
            text-align: center;
        }
        
        .chart-container {
            width: 100%;
            height: calc(100% - 40px);
        }
        
        .last-updated {
            text-align: center;
            color: #a0aec0;
            font-size: 14px;
            margin-top: 10px;
        }
        
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .metric-card {
                grid-column: span 1;
            }
            
            .chart-card {
                grid-column: span 1;
            }
            
            .full-width-card {
                grid-column: span 2;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>香港医院病床使用情况实时监控</h1>
        <div id="last-updated" class="last-updated"></div>
    </div>
    <div class="container">
        <!-- 左上角：总体概况及各科室分饼图 -->
        <div class="card metric-card" id="overview">
            <h2>总体概况</h2>
            <div id="total-beds"></div>
            <div id="occupied-beds"></div>
            <div id="available-beds"></div>
            <div id="occupancy-rate"></div>
            <canvas id="pie-chart" width="200" height="200"></canvas>
        </div>

        <!-- 右上角：各医院病床使用率的横向柱状图 -->
        <div class="card chart-card" id="hospitalOccupancy">
            <h2>各医院病床使用率</h2>
            <canvas id="hospital-bar-chart" width="400" height="200"></canvas>
        </div>

        <!-- 左下角：主要科室病床使用率的柱状图 -->
        <div class="card chart-card" id="departmentOccupancy">
            <h2>主要科室病床使用率</h2>
            <canvas id="department-bar-chart" width="400" height="200"></canvas>
        </div>

        <!-- 右下角：医院-科室病床使用率的热力图 -->
        <div class="card full-width-card" id="districtDistribution">
            <h2>医院-科室病床使用率热力图</h2>
            <div id="heatmap-container" class="chart-container"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function fetchData(url, targetId) {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const targetElement = document.getElementById(targetId);
                    if (targetId === 'overview') {
                        displayOverview(data);
                    } else if (targetId === 'hospitalOccupancy') {
                        displayHospitalOccupancy(data);
                    } else if (targetId === 'departmentOccupancy') {
                        displayDepartmentOccupancy(data);
                    } else if (targetId === 'districtDistribution') {
                        displayHeatmap(data);
                    }
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        function displayOverview(data) {
            document.getElementById('total-beds').innerText = `总病床数: ${data.total_beds}`;
            document.getElementById('occupied-beds').innerText = `已用病床: ${data.occupied_beds}`;
            document.getElementById('available-beds').innerText = `空闲病床: ${data.available_beds}`;
            document.getElementById('occupancy-rate').innerText = `总体使用率: ${data.occupancy_rate}%`;

            const ctx = document.getElementById('pie-chart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['眼科', '皮肤科', '耳鼻喉科', '泌尿科', '妇产科'],
                    datasets: [{
                        data: [data.eye_dept, data.skin_dept, data.ent_dept, data.urology_dept, data.obgyn_dept],
                        backgroundColor: ['#3498db', '#2ecc71', '#f1c40f', '#e74c3c', '#9b59b6']
                    }]
                }
            });
        }

        function displayHospitalOccupancy(data) {
            const ctx = document.getElementById('hospital-bar-chart').getContext('2d');
            new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: data.map(item => item.hospital_name),
                    datasets: [{
                        label: '使用率',
                        data: data.map(item => item.occupancy_rate),
                        backgroundColor: '#3498db'
                    }]
                },
                options: {
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function displayDepartmentOccupancy(data) {
            const ctx = document.getElementById('department-bar-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item.department_name),
                    datasets: [{
                        label: '使用率',
                        data: data.map(item => item.occupancy_rate),
                        backgroundColor: '#f1c40f'
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function displayHeatmap(data) {
            const heatmapContainer = document.getElementById('heatmap-container');
            const heatmapChart = echarts.init(heatmapContainer);

            const heatmapData = data.map(item => [
                item.hospital_name,
                item.department_name,
                item.occupancy_rate
            ]);

            heatmapChart.setOption({
                title: {
                    text: '医院-科室病床使用率热力图'
                },
                tooltip: {},
                xAxis: {
                    type: 'category',
                    data: [...new Set(data.map(item => item.department_name))]
                },
                yAxis: {
                    type: 'category',
                    data: [...new Set(data.map(item => item.hospital_name))]
                },
                visualMap: {
                    min: 0,
                    max: 100,
                    calculable: true,
                    orient: 'horizontal',
                    left: 'center',
                    bottom: '0%'
                },
                series: [{
                    name: '使用率',
                    type: 'heatmap',
                    data: heatmapData,
                    label: {
                        show: true
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            });
        }

        // Fetch data from APIs and display in respective cards
        fetchData('/api/overview', 'overview');
        fetchData('/api/hospital_occupancy', 'hospitalOccupancy');
        fetchData('/api/department_occupancy', 'departmentOccupancy');
        fetchData('/api/district_distribution', 'districtDistribution');

        // Update last updated time
        const lastUpdatedElement = document.getElementById('last-updated');
        const now = new Date();
        lastUpdatedElement.innerText = `更新时间: ${now.toISOString()}`;
    </script>
</body>
</html>