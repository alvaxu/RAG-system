<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>香港疫情数据大屏</title>
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Microsoft YaHei', sans-serif; padding: 20px; }
        .dashboard-container { max-width: 1600px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; color: #38bdf8; }
        .header p { color: #94a3b8; font-size: 1.1rem; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .full-width { grid-column: 1 / -1; }
        .card { background-color: #1e293b; border-radius: 10px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card-title { font-size: 1.2rem; margin-bottom: 15px; color: #f1f5f9; display: flex; align-items: center; }
        .card-title i { margin-right: 8px; color: #38bdf8; }
        .core-indicators { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .indicator-item { background-color: #0f172a; border-radius: 8px; padding: 15px; text-align: center; border-left: 4px solid #38bdf8; }
        .indicator-value { font-size: 2rem; font-weight: bold; margin: 10px 0; color: #fff; }
        .indicator-label { color: #94a3b8; font-size: 0.9rem; }
        .chart-container { width: 100%; height: 600px; }
        .third-row { grid-template-columns: 1fr 1fr; }
        .risk-level { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 8px; }
        .risk-low { background-color: #10b981; color: white; }
        .risk-medium { background-color: #f59e0b; color: white; }
        .risk-high { background-color: #ef4444; color: white; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>香港疫情数据可视化大屏</h1>
            <p>数据更新日期: {{ core_indicators.date }}</p>
        </div>

        <!-- 核心指标模块 -->
        <div class="card full-width">
            <div class="card-title"><i>📊</i>核心疫情指标</div>
            <div class="core-indicators">
                <div class="indicator-item">
                    <div class="indicator-label">累计确诊病例</div>
                    <div class="indicator-value">{{ core_indicators.total_cases }}</div>
                    <div class="indicator-trend">较昨日 <span style="color: {{ '#ef4444' if core_indicators.total_change > 0 else '#10b981' if core_indicators.total_change < 0 else '#94a3b8' }}">{{ '↑' if core_indicators.total_change > 0 else '↓' if core_indicators.total_change < 0 else '—' }} {{ core_indicators.total_change|abs }}</span></div>
                </div>
                <div class="indicator-item">
                    <div class="indicator-label">新增确诊病例</div>
                    <div class="indicator-value">{{ core_indicators.new_cases }}</div>
                    <div class="indicator-trend">较昨日 <span style="color: {{ '#ef4444' if core_indicators.new_change > 0 else '#10b981' if core_indicators.new_change < 0 else '#94a3b8' }}">{{ '↑' if core_indicators.new_change > 0 else '↓' if core_indicators.new_change < 0 else '—' }} {{ core_indicators.new_change|abs }}</span></div>
                </div>
                <div class="indicator-item">
                    <div class="indicator-label">治愈率</div>
                    <div class="indicator-value">{{ core_indicators.recovery_rate }}%</div>
                    <div class="indicator-trend">较昨日 <span style="color: {{ '#ef4444' if core_indicators.recovery_rate_change > 0 else '#10b981' if core_indicators.recovery_rate_change < 0 else '#94a3b8' }}">{{ '↑' if core_indicators.recovery_rate_change > 0 else '↓' if core_indicators.recovery_rate_change < 0 else '—' }} {{ core_indicators.recovery_rate_change|abs }}%</span></div>
                </div>
                <div class="indicator-item">
                    <div class="indicator-label">死亡率</div>
                    <div class="indicator-value">{{ core_indicators.death_rate }}%</div>
                    <div class="indicator-trend">较昨日 <span style="color: {{ '#ef4444' if core_indicators.death_rate_change > 0 else '#10b981' if core_indicators.death_rate_change < 0 else '#94a3b8' }}">{{ '↑' if core_indicators.death_rate_change > 0 else '↓' if core_indicators.death_rate_change < 0 else '—' }} {{ core_indicators.death_rate_change|abs }}%</span></div>
                </div>
            </div>
        </div>

        <div class="grid-container">
            <!-- 地理分布模块 -->
            <div class="card">
                <div class="card-title"><i>🗺️</i>香港各区疫情分布</div>
                <div id="geo-chart" class="chart-container"></div>
            </div>

            <!-- 趋势分析模块 -->
            <div class="card">
                <div class="card-title"><i>📈</i>疫情趋势分析</div>
                <div id="trend-chart" class="chart-container"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script>
        // 初始化核心指标图表
        document.addEventListener('DOMContentLoaded', function() {
              // 初始化图表
              function initCharts() {
                  // 检查ECharts是否已加载
                  if (typeof echarts === 'undefined') {
                      setTimeout(initCharts, 100);
                      return;
                  }
                  // 地理分布图表
                  const geoChart = echarts.init(document.getElementById('geo-chart'));
                  // 注册地图数据
                  echarts.registerMap('hongkong', {{ geo_data|tojson if geo_data else '{}' }});
                  const geoOption = {
                      tooltip: {
                          trigger: 'item',
                          formatter: function(params) {
                              return `${params.name}<br/>新增病例: ${params.value}<br/>风险等级: <span class="risk-${params.data.risk_level === '低' ? 'low' : params.data.risk_level === '中' ? 'medium' : 'high'}">${params.data.risk_level}</span>`;
                          }
                      },
                      visualMap: {
                          type: 'continuous',
                          min: 0,
                          max: {{ max_new_cases|default(10) }},
                          left: 'left',
                          top: 'bottom',
                          text: ['高', '低'],
                          calculable: true,
                          inRange: {
                              color: ['#fff1f2', '#ff758f', '#c9184a']
                          }
                      },
                      series: [{
                          name: '新增病例',
                          type: 'map',
                          mapType: 'hongkong',  // 使用已注册的地图名称
                          roam: true,
                          label: {
                              show: true,
                              fontSize: 12
                          },
                          data: {{ district_data|tojson }}
                      }]
                  };
                  geoChart.setOption(geoOption);

                  // 趋势分析图表
                  const trendChart = echarts.init(document.getElementById('trend-chart'));
                  const trendOption = {
                      tooltip: {
                          trigger: 'axis',
                          axisPointer: {
                              type: 'shadow'
                          }
                      },
                      grid: {
                          left: '3%',
                          right: '4%',
                          bottom: '3%',
                          containLabel: true
                      },
                      xAxis: {
                          type: 'category',
                          data: {{ trend_data.dates|tojson }},
                          axisLabel: {
                              rotate: 90,
                              formatter: function(value) {
                                  // 验证日期格式是否符合预期
                                  if (value.length >= 16 && value.includes(' ')) {
                                      return value.substring(0, 16);
                                  }
                                  // 格式异常时返回原始值
                                  return value;
                              }
                          }
                      },
                      yAxis: {
                          type: 'value',
                          name: '新增病例数'
                      },
                      series: [{
                      name: '新增病例',
                      type: 'line',
                      data: {{ trend_data.new_cases|tojson }},
                      smooth: true,
                      itemStyle: {
                          color: '#38bdf8'
                      },
                      lineStyle: {
                          width: 3
                      },
                      markPoint: {
                          data: [
                              {type: 'max', name: '最大值'},
                              {type: 'min', name: '最小值'}
                          ]
                      },
                      // 添加区域填充以增强可视化效果
                      areaStyle: {
                          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                              {offset: 0, color: 'rgba(56, 189, 248, 0.3)'},
                              {offset: 1, color: 'rgba(56, 189, 248, 0.05)'}
                          ])
                      }
                  }]
                  };
                  trendChart.setOption(trendOption);

                  // 响应窗口大小变化
                  window.addEventListener('resize', function() {
                      geoChart.resize();
                      trendChart.resize();
                  });
              }

              // 直接初始化图表（ECharts已在head中加载）
              initCharts();
          });
    </script>
</body>
</html>