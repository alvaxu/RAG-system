<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦™æ¸¯ç–«æƒ…æ•°æ®å¤§å±</title>
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Microsoft YaHei', sans-serif; padding: 20px; }
        .dashboard-container { max-width: 1600px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; color: #38bdf8; }
        .header p { color: #94a3b8; font-size: 1.1rem; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .full-width { grid-column: 1 / -1; }
        .card { background-color: #1e293b; border-radius: 10px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card-title { font-size: 1.2rem; margin-bottom: 15px; color: #f1f5f9; display: flex; align-items: center; }
        .card-title i { margin-right: 8px; color: #38bdf8; }
        .core-indicators { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .indicator-item { background-color: #0f172a; border-radius: 8px; padding: 15px; text-align: center; border-left: 4px solid #38bdf8; }
        .indicator-value { font-size: 2rem; font-weight: bold; margin: 10px 0; color: #fff; }
        .indicator-label { color: #94a3b8; font-size: 0.9rem; }
        .chart-container { width: 100%; height: 600px; }
        .third-row { grid-template-columns: 1fr 1fr; }
        .risk-level { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 8px; }
        .risk-low { background-color: #10b981; color: white; }
        .risk-medium { background-color: #f59e0b; color: white; }
        .risk-high { background-color: #ef4444; color: white; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>é¦™æ¸¯ç–«æƒ…æ•°æ®å¯è§†åŒ–å¤§å±</h1>
            <p>æ•°æ®æ›´æ–°æ—¥æœŸ: {{ core_indicators.date }}</p>
        </div>

        <!-- æ ¸å¿ƒæŒ‡æ ‡æ¨¡å— -->
        <div class="card full-width">
            <div class="card-title"><i>ğŸ“Š</i>æ ¸å¿ƒç–«æƒ…æŒ‡æ ‡</div>
            <div class="core-indicators">
                <div class="indicator-item">
                    <div class="indicator-label">ç´¯è®¡ç¡®è¯Šç—…ä¾‹</div>
                    <div class="indicator-value">{{ core_indicators.total_cases }}</div>
                    <div class="indicator-trend">è¾ƒæ˜¨æ—¥ <span style="color: {{ '#ef4444' if core_indicators.total_change > 0 else '#10b981' if core_indicators.total_change < 0 else '#94a3b8' }}">{{ 'â†‘' if core_indicators.total_change > 0 else 'â†“' if core_indicators.total_change < 0 else 'â€”' }} {{ core_indicators.total_change|abs }}</span></div>
                </div>
                <div class="indicator-item">
                    <div class="indicator-label">æ–°å¢ç¡®è¯Šç—…ä¾‹</div>
                    <div class="indicator-value">{{ core_indicators.new_cases }}</div>
                    <div class="indicator-trend">è¾ƒæ˜¨æ—¥ <span style="color: {{ '#ef4444' if core_indicators.new_change > 0 else '#10b981' if core_indicators.new_change < 0 else '#94a3b8' }}">{{ 'â†‘' if core_indicators.new_change > 0 else 'â†“' if core_indicators.new_change < 0 else 'â€”' }} {{ core_indicators.new_change|abs }}</span></div>
                </div>
                <div class="indicator-item">
                    <div class="indicator-label">æ²»æ„ˆç‡</div>
                    <div class="indicator-value">{{ core_indicators.recovery_rate }}%</div>
                    <div class="indicator-trend">è¾ƒæ˜¨æ—¥ <span style="color: {{ '#ef4444' if core_indicators.recovery_rate_change > 0 else '#10b981' if core_indicators.recovery_rate_change < 0 else '#94a3b8' }}">{{ 'â†‘' if core_indicators.recovery_rate_change > 0 else 'â†“' if core_indicators.recovery_rate_change < 0 else 'â€”' }} {{ core_indicators.recovery_rate_change|abs }}%</span></div>
                </div>
                <div class="indicator-item">
                    <div class="indicator-label">æ­»äº¡ç‡</div>
                    <div class="indicator-value">{{ core_indicators.death_rate }}%</div>
                    <div class="indicator-trend">è¾ƒæ˜¨æ—¥ <span style="color: {{ '#ef4444' if core_indicators.death_rate_change > 0 else '#10b981' if core_indicators.death_rate_change < 0 else '#94a3b8' }}">{{ 'â†‘' if core_indicators.death_rate_change > 0 else 'â†“' if core_indicators.death_rate_change < 0 else 'â€”' }} {{ core_indicators.death_rate_change|abs }}%</span></div>
                </div>
            </div>
        </div>

        <div class="grid-container">
            <!-- åœ°ç†åˆ†å¸ƒæ¨¡å— -->
            <div class="card">
                <div class="card-title"><i>ğŸ—ºï¸</i>é¦™æ¸¯å„åŒºç–«æƒ…åˆ†å¸ƒ</div>
                <div id="geo-chart" class="chart-container"></div>
            </div>

            <!-- è¶‹åŠ¿åˆ†ææ¨¡å— -->
            <div class="card">
                <div class="card-title"><i>ğŸ“ˆ</i>ç–«æƒ…è¶‹åŠ¿åˆ†æ</div>
                <div id="trend-chart" class="chart-container"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script>
        // åˆå§‹åŒ–æ ¸å¿ƒæŒ‡æ ‡å›¾è¡¨
        document.addEventListener('DOMContentLoaded', function() {
              // åˆå§‹åŒ–å›¾è¡¨
              function initCharts() {
                  // æ£€æŸ¥EChartsæ˜¯å¦å·²åŠ è½½
                  if (typeof echarts === 'undefined') {
                      setTimeout(initCharts, 100);
                      return;
                  }
                  // åœ°ç†åˆ†å¸ƒå›¾è¡¨
                  const geoChart = echarts.init(document.getElementById('geo-chart'));
                  // æ³¨å†Œåœ°å›¾æ•°æ®
                  echarts.registerMap('hongkong', {{ geo_data|tojson if geo_data else '{}' }});
                  const geoOption = {
                      tooltip: {
                          trigger: 'item',
                          formatter: function(params) {
                              return `${params.name}<br/>æ–°å¢ç—…ä¾‹: ${params.value}<br/>é£é™©ç­‰çº§: <span class="risk-${params.data.risk_level === 'ä½' ? 'low' : params.data.risk_level === 'ä¸­' ? 'medium' : 'high'}">${params.data.risk_level}</span>`;
                          }
                      },
                      visualMap: {
                          type: 'continuous',
                          min: 0,
                          max: {{ max_new_cases|default(10) }},
                          left: 'left',
                          top: 'bottom',
                          text: ['é«˜', 'ä½'],
                          calculable: true,
                          inRange: {
                              color: ['#fff1f2', '#ff758f', '#c9184a']
                          }
                      },
                      series: [{
                          name: 'æ–°å¢ç—…ä¾‹',
                          type: 'map',
                          mapType: 'hongkong',  // ä½¿ç”¨å·²æ³¨å†Œçš„åœ°å›¾åç§°
                          roam: true,
                          label: {
                              show: true,
                              fontSize: 12
                          },
                          data: {{ district_data|tojson }}
                      }]
                  };
                  geoChart.setOption(geoOption);

                  // è¶‹åŠ¿åˆ†æå›¾è¡¨
                  const trendChart = echarts.init(document.getElementById('trend-chart'));
                  const trendOption = {
                      tooltip: {
                          trigger: 'axis',
                          axisPointer: {
                              type: 'shadow'
                          }
                      },
                      grid: {
                          left: '3%',
                          right: '4%',
                          bottom: '3%',
                          containLabel: true
                      },
                      xAxis: {
                          type: 'category',
                          data: {{ trend_data.dates|tojson }},
                          axisLabel: {
                              rotate: 90,
                              formatter: function(value) {
                                  // éªŒè¯æ—¥æœŸæ ¼å¼æ˜¯å¦ç¬¦åˆé¢„æœŸ
                                  if (value.length >= 16 && value.includes(' ')) {
                                      return value.substring(0, 16);
                                  }
                                  // æ ¼å¼å¼‚å¸¸æ—¶è¿”å›åŸå§‹å€¼
                                  return value;
                              }
                          }
                      },
                      yAxis: {
                          type: 'value',
                          name: 'æ–°å¢ç—…ä¾‹æ•°'
                      },
                      series: [{
                      name: 'æ–°å¢ç—…ä¾‹',
                      type: 'line',
                      data: {{ trend_data.new_cases|tojson }},
                      smooth: true,
                      itemStyle: {
                          color: '#38bdf8'
                      },
                      lineStyle: {
                          width: 3
                      },
                      markPoint: {
                          data: [
                              {type: 'max', name: 'æœ€å¤§å€¼'},
                              {type: 'min', name: 'æœ€å°å€¼'}
                          ]
                      },
                      // æ·»åŠ åŒºåŸŸå¡«å……ä»¥å¢å¼ºå¯è§†åŒ–æ•ˆæœ
                      areaStyle: {
                          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                              {offset: 0, color: 'rgba(56, 189, 248, 0.3)'},
                              {offset: 1, color: 'rgba(56, 189, 248, 0.05)'}
                          ])
                      }
                  }]
                  };
                  trendChart.setOption(trendOption);

                  // å“åº”çª—å£å¤§å°å˜åŒ–
                  window.addEventListener('resize', function() {
                      geoChart.resize();
                      trendChart.resize();
                  });
              }

              // ç›´æ¥åˆå§‹åŒ–å›¾è¡¨ï¼ˆEChartså·²åœ¨headä¸­åŠ è½½ï¼‰
              initCharts();
          });
    </script>
</body>
</html>